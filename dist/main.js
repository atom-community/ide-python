"use strict";

var _main = require("./debugger/main");

const cp = require("child_process");

const {
  shell
} = require("electron");

const {
  AutoLanguageClient
} = require("atom-languageclient");

const {
  detectVirtualEnv,
  detectPipEnv,
  replacePipEnvPathVar,
  sanitizeConfig
} = require("./utils");

// Ref: https://github.com/nteract/hydrogen/blob/master/lib/autocomplete-provider.js#L33
// adapted from http://stackoverflow.com/q/5474008
const PYTHON_REGEX = /(([^\d\W]|[\u00A0-\uFFFF])[\w.\u00A0-\uFFFF]*)|\.$/;

class PythonLanguageClient extends AutoLanguageClient {
  getGrammarScopes() {
    return ["source.python", "python"];
  }

  getLanguageName() {
    return "Python";
  }

  getServerName() {
    return "pyls";
  }

  getRootConfigurationKey() {
    return "ide-python";
  }

  activate() {
    // Remove deprecated option
    atom.config.unset("ide-python.pylsPath");
    super.activate();
    (0, _main.activate)();
  }

  mapConfigurationObject(configuration) {
    return {
      pyls: {
        configurationSources: configuration.pylsConfigurationSources,
        rope: sanitizeConfig(configuration.rope),
        plugins: configuration.pylsPlugins
      }
    };
  }

  async startServerProcess(projectPath) {
    const venvPath = (await detectPipEnv(projectPath)) || (await detectVirtualEnv(projectPath));
    const pylsEnvironment = Object.assign({}, process.env);

    if (venvPath) {
      pylsEnvironment["VIRTUAL_ENV"] = venvPath;
    }

    const python = replacePipEnvPathVar(atom.config.get("ide-python.python"), venvPath);
    const childProcess = cp.spawn(python, ["-m", "pyls"], {
      cwd: projectPath,
      env: pylsEnvironment
    });
    childProcess.on("error", err => {
      const description = err.code == "ENOENT" ? `No Python interpreter found at \`${python}\`.` : `Could not spawn the Python interpreter \`${python}\`.`;
      atom.notifications.addError("`ide-python` could not launch your Python runtime.", {
        dismissable: true,
        description: `${description}<p>If you have Python installed please set "Python Executable" setting correctly. If you do not please install Python.</p>`
      });
    });
    childProcess.on("close", (code, signal) => {
      if (code !== 0 && signal == null) {
        atom.notifications.addError("Unable to start the Python language server.", {
          dismissable: true,
          buttons: [{
            text: "Install Instructions",
            onDidClick: () => atom.workspace.open("atom://config/packages/ide-python")
          }, {
            text: "Download Python",
            onDidClick: () => shell.openExternal("https://www.python.org/downloads/")
          }],
          description: "Make sure to install `pyls` 0.19 or newer by running:\n" + "```\n" + `${python} -m pip install 'python-language-server[all]'\n` + "```"
        });
      }
    });
    return childProcess;
  }

  async getSuggestions(request) {
    if (!PYTHON_REGEX.test(request.prefix)) return null;
    return super.getSuggestions(request);
  }

  deactivate() {
    (0, _main.dispose)();
    return Promise.race([super.deactivate(), this.createTimeoutPromise(2000)]);
  }

  createTimeoutPromise(milliseconds) {
    return new Promise((resolve, reject) => {
      let timeout = setTimeout(() => {
        clearTimeout(timeout);
        this.logger.error(`Server failed to shutdown in ${milliseconds}ms, forcing termination`);
        resolve();
      }, milliseconds);
    });
  }

}

const pythonClient = new PythonLanguageClient();
pythonClient.createDebuggerProvider = _main.createDebuggerProvider; // add the debugger

module.exports = pythonClient;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4uanMiXSwibmFtZXMiOlsiY3AiLCJyZXF1aXJlIiwic2hlbGwiLCJBdXRvTGFuZ3VhZ2VDbGllbnQiLCJkZXRlY3RWaXJ0dWFsRW52IiwiZGV0ZWN0UGlwRW52IiwicmVwbGFjZVBpcEVudlBhdGhWYXIiLCJzYW5pdGl6ZUNvbmZpZyIsIlBZVEhPTl9SRUdFWCIsIlB5dGhvbkxhbmd1YWdlQ2xpZW50IiwiZ2V0R3JhbW1hclNjb3BlcyIsImdldExhbmd1YWdlTmFtZSIsImdldFNlcnZlck5hbWUiLCJnZXRSb290Q29uZmlndXJhdGlvbktleSIsImFjdGl2YXRlIiwiYXRvbSIsImNvbmZpZyIsInVuc2V0IiwibWFwQ29uZmlndXJhdGlvbk9iamVjdCIsImNvbmZpZ3VyYXRpb24iLCJweWxzIiwiY29uZmlndXJhdGlvblNvdXJjZXMiLCJweWxzQ29uZmlndXJhdGlvblNvdXJjZXMiLCJyb3BlIiwicGx1Z2lucyIsInB5bHNQbHVnaW5zIiwic3RhcnRTZXJ2ZXJQcm9jZXNzIiwicHJvamVjdFBhdGgiLCJ2ZW52UGF0aCIsInB5bHNFbnZpcm9ubWVudCIsIk9iamVjdCIsImFzc2lnbiIsInByb2Nlc3MiLCJlbnYiLCJweXRob24iLCJnZXQiLCJjaGlsZFByb2Nlc3MiLCJzcGF3biIsImN3ZCIsIm9uIiwiZXJyIiwiZGVzY3JpcHRpb24iLCJjb2RlIiwibm90aWZpY2F0aW9ucyIsImFkZEVycm9yIiwiZGlzbWlzc2FibGUiLCJzaWduYWwiLCJidXR0b25zIiwidGV4dCIsIm9uRGlkQ2xpY2siLCJ3b3Jrc3BhY2UiLCJvcGVuIiwib3BlbkV4dGVybmFsIiwiZ2V0U3VnZ2VzdGlvbnMiLCJyZXF1ZXN0IiwidGVzdCIsInByZWZpeCIsImRlYWN0aXZhdGUiLCJQcm9taXNlIiwicmFjZSIsImNyZWF0ZVRpbWVvdXRQcm9taXNlIiwibWlsbGlzZWNvbmRzIiwicmVzb2x2ZSIsInJlamVjdCIsInRpbWVvdXQiLCJzZXRUaW1lb3V0IiwiY2xlYXJUaW1lb3V0IiwibG9nZ2VyIiwiZXJyb3IiLCJweXRob25DbGllbnQiLCJjcmVhdGVEZWJ1Z2dlclByb3ZpZGVyIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFVQTs7QUFWQSxNQUFNQSxFQUFFLEdBQUdDLE9BQU8sQ0FBQyxlQUFELENBQWxCOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFZRCxPQUFPLENBQUMsVUFBRCxDQUF6Qjs7QUFDQSxNQUFNO0FBQUVFLEVBQUFBO0FBQUYsSUFBeUJGLE9BQU8sQ0FBQyxxQkFBRCxDQUF0Qzs7QUFDQSxNQUFNO0FBQ0pHLEVBQUFBLGdCQURJO0FBRUpDLEVBQUFBLFlBRkk7QUFHSkMsRUFBQUEsb0JBSEk7QUFJSkMsRUFBQUE7QUFKSSxJQUtGTixPQUFPLENBQUMsU0FBRCxDQUxYOztBQVNBO0FBQ0E7QUFDQSxNQUFNTyxZQUFZLEdBQUcsb0RBQXJCOztBQUVBLE1BQU1DLG9CQUFOLFNBQW1DTixrQkFBbkMsQ0FBc0Q7QUFDcERPLEVBQUFBLGdCQUFnQixHQUFHO0FBQ2pCLFdBQU8sQ0FBQyxlQUFELEVBQWtCLFFBQWxCLENBQVA7QUFDRDs7QUFFREMsRUFBQUEsZUFBZSxHQUFHO0FBQ2hCLFdBQU8sUUFBUDtBQUNEOztBQUVEQyxFQUFBQSxhQUFhLEdBQUc7QUFDZCxXQUFPLE1BQVA7QUFDRDs7QUFFREMsRUFBQUEsdUJBQXVCLEdBQUc7QUFDeEIsV0FBTyxZQUFQO0FBQ0Q7O0FBRURDLEVBQUFBLFFBQVEsR0FBRztBQUNUO0FBQ0FDLElBQUFBLElBQUksQ0FBQ0MsTUFBTCxDQUFZQyxLQUFaLENBQWtCLHFCQUFsQjtBQUNBLFVBQU1ILFFBQU47QUFDQTtBQUNEOztBQUVESSxFQUFBQSxzQkFBc0IsQ0FBQ0MsYUFBRCxFQUFnQjtBQUNwQyxXQUFPO0FBQ0xDLE1BQUFBLElBQUksRUFBRTtBQUNKQyxRQUFBQSxvQkFBb0IsRUFBRUYsYUFBYSxDQUFDRyx3QkFEaEM7QUFFSkMsUUFBQUEsSUFBSSxFQUFFaEIsY0FBYyxDQUFDWSxhQUFhLENBQUNJ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QUQsRUFBZTtBQUNqQyxXQUFPLElBQUlILE9BQUosQ0FBWSxDQUFDSSxPQUFELEVBQVVDLE1BQVYsS0FBcUI7QUFDdEMsVUFBSUMsT0FBTyxHQUFHQyxVQUFVLENBQUMsTUFBTTtBQUM3QkMsUUFBQUEsWUFBWSxDQUFDRixPQUFELENBQVo7QUFDQSxhQUFLRyxNQUFMLENBQVlDLEtBQVosQ0FDRyxnQ0FBK0JQLFlBQWEseUJBRC9DO0FBR0FDLFFBQUFBLE9BQU87QUFDUixPQU51QixFQU1yQkQsWUFOcUIsQ0FBeEI7QUFPRCxLQVJNLENBQVA7QUFTRDs7QUFsSG1EOztBQXFIdEQsTUFBTVEsWUFBWSxHQUFHLElBQUk1RCxvQkFBSixFQUFyQjtBQUNBNEQsWUFBWSxDQUFDQyxzQkFBYixHQUFzQ0EsNEJBQXRDLEMsQ0FBOEQ7O0FBQzlEQyxNQUFNLENBQUNDLE9BQVAsR0FBaUJILFlBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgY3AgPSByZXF1aXJlKFwiY2hpbGRfcHJvY2Vzc1wiKTtcbmNvbnN0IHsgc2hlbGwgfSA9IHJlcXVpcmUoXCJlbGVjdHJvblwiKTtcbmNvbnN0IHsgQXV0b0xhbmd1YWdlQ2xpZW50IH0gPSByZXF1aXJlKFwiYXRvbS1sYW5ndWFnZWNsaWVudFwiKTtcbmNvbnN0IHtcbiAgZGV0ZWN0VmlydHVhbEVudixcbiAgZGV0ZWN0UGlwRW52LFxuICByZXBsYWNlUGlwRW52UGF0aFZhcixcbiAgc2FuaXRpemVDb25maWdcbn0gPSByZXF1aXJlKFwiLi91dGlsc1wiKTtcblxuaW1wb3J0IHsgY3JlYXRlRGVidWdnZXJQcm92aWRlciwgYWN0aXZhdGUgYXMgZGVidWdnZXJBY3RpdmF0ZSwgZGlzcG9zZSBhcyBkZWJ1Z2dlckRpc3Bvc2UgfSBmcm9tIFwiLi9kZWJ1Z2dlci9tYWluXCJcblxuLy8gUmVmOiBodHRwczovL2dpdGh1Yi5jb20vbnRlcmFjdC9oeWRyb2dlbi9ibG9iL21hc3Rlci9saWIvYXV0b2NvbXBsZXRlLXByb3ZpZGVyLmpzI0wzM1xuLy8gYWRhcHRlZCBmcm9tIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xLzU0NzQwMDhcbmNvbnN0IFBZVEhPTl9SRUdFWCA9IC8oKFteXFxkXFxXXXxbXFx1MDBBMC1cXHVGRkZGXSlbXFx3LlxcdTAwQTAtXFx1RkZGRl0qKXxcXC4kLztcblxuY2xhc3MgUHl0aG9uTGFuZ3VhZ2VDbGllbnQgZXh0ZW5kcyBBdXRvTGFuZ3VhZ2VDbGllbnQge1xuICBnZXRHcmFtbWFyU2NvcGVzKCkge1xuICAgIHJldHVybiBbXCJzb3VyY2UucHl0aG9uXCIsIFwicHl0aG9uXCJdO1xuICB9XG5cbiAgZ2V0TGFuZ3VhZ2VOYW1lKCkge1xuICAgIHJldHVybiBcIlB5dGhvblwiO1xuICB9XG5cbiAgZ2V0U2VydmVyTmFtZSgpIHtcbiAgICByZXR1cm4gXCJweWxzXCI7XG4gIH1cblxuICBnZXRSb290Q29uZmlndXJhdGlvbktleSgpIHtcbiAgICByZXR1cm4gXCJpZGUtcHl0aG9uXCI7XG4gIH1cblxuICBhY3RpdmF0ZSgpIHtcbiAgICAvLyBSZW1vdmUgZGVwcmVjYXRlZCBvcHRpb25cbiAgICBhdG9tLmNvbmZpZy51bnNldChcImlkZS1weXRob24ucHlsc1BhdGhcIik7XG4gICAgc3VwZXIuYWN0aXZhdGUoKTtcbiAgICBkZWJ1Z2dlckFjdGl2YXRlKCk7XG4gIH1cblxuICBtYXBDb25maWd1cmF0aW9uT2JqZWN0KGNvbmZpZ3VyYXRpb24pIHtcbiAgICByZXR1cm4ge1xuICAgICAgcHlsczoge1xuICAgICAgICBjb25maWd1cmF0aW9uU291cmNlczogY29uZmlndXJhdGlvbi5weWxzQ29uZmlndXJhdGlvblNvdXJjZXMsXG4gICAgICAgIHJvcGU6IHNhbml0aXplQ29uZmlnKGNvbmZpZ3VyYXRpb24ucm9wZSksXG4gICAgICAgIHBsdWdpbnM6IGNvbmZpZ3VyYXRpb24ucHlsc1BsdWdpbnNcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgc3RhcnRTZXJ2ZXJQcm9jZXNzKHByb2plY3RQYXRoKSB7XG4gICAgY29uc3QgdmVudlBhdGggPVxuICAgICAgKGF3YWl0IGRldGVjdFBpcEVudihwcm9qZWN0UGF0aCkpIHx8XG4gICAgICAoYXdhaXQgZGV0ZWN0VmlydHVhbEVudihwcm9qZWN0UGF0aCkpO1xuICAgIGNvbnN0IHB5bHNFbnZpcm9ubWVudCA9IE9iamVjdC5hc3NpZ24oe30sIHByb2Nlc3MuZW52KTtcbiAgICBpZiAodmVudlBhdGgpIHtcbiAgICAgIHB5bHNFbnZpcm9ubWVudFtcIlZJUlRVQUxfRU5WXCJdID0gdmVudlBhdGg7XG4gICAgfVxuICAgIGNvbnN0IHB5dGhvbiA9IHJlcGxhY2VQaXBFbnZQYXRoVmFyKFxuICAgICAgYXRvbS5jb25maWcuZ2V0KFwiaWRlLXB5dGhvbi5weXRob25cIiksXG4gICAgICB2ZW52UGF0aFxuICAgICk7XG4gICAgY29uc3QgY2hpbGRQcm9jZXNzID0gY3Auc3Bhd24ocHl0aG9uLCBbXCItbVwiLCBcInB5bHNcIl0sIHtcbiAgICAgIGN3ZDogcHJvamVjdFBhdGgsXG4gICAgICBlbnY6IHB5bHNFbnZpcm9ubWVudFxuICAgIH0pO1xuICAgIGNoaWxkUHJvY2Vzcy5vbihcImVycm9yXCIsIGVyciA9PiB7XG4gICAgICBjb25zdCBkZXNjcmlwdGlvbiA9XG4gICAgICAgIGVyci5jb2RlID09IFwiRU5PRU5UXCJcbiAgICAgICAgICA/IGBObyBQeXRob24gaW50ZXJwcmV0ZXIgZm91bmQgYXQgXFxgJHtweXRob259XFxgLmBcbiAgICAgICAgICA6IGBDb3VsZCBub3Qgc3Bhd24gdGhlIFB5dGhvbiBpbnRlcnByZXRlciBcXGAke3B5dGhvbn1cXGAuYDtcbiAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihcbiAgICAgICAgXCJgaWRlLXB5dGhvbmAgY291bGQgbm90IGxhdW5jaCB5b3VyIFB5dGhvbiBydW50aW1lLlwiLFxuICAgICAgICB7XG4gICAgICAgICAgZGlzbWlzc2FibGU6IHRydWUsXG4gICAgICAgICAgZGVzY3JpcHRpb246IGAke2Rlc2NyaXB0aW9ufTxwPklmIHlvdSBoYXZlIFB5dGhvbiBpbnN0YWxsZWQgcGxlYXNlIHNldCBcIlB5dGhvbiBFeGVjdXRhYmxlXCIgc2V0dGluZyBjb3JyZWN0bHkuIElmIHlvdSBkbyBub3QgcGxlYXNlIGluc3RhbGwgUHl0aG9uLjwvcD5gXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBjaGlsZFByb2Nlc3Mub24oXCJjbG9zZVwiLCAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICBpZiAoY29kZSAhPT0gMCAmJiBzaWduYWwgPT0gbnVsbCkge1xuICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoXG4gICAgICAgICAgXCJVbmFibGUgdG8gc3RhcnQgdGhlIFB5dGhvbiBsYW5ndWFnZSBzZXJ2ZXIuXCIsXG4gICAgICAgICAge1xuICAgICAgICAgICAgZGlzbWlzc2FibGU6IHRydWUsXG4gICAgICAgICAgICBidXR0b25zOiBbXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICB0ZXh0OiBcIkluc3RhbGwgSW5zdHJ1Y3Rpb25zXCIsXG4gICAgICAgICAgICAgICAgb25EaWRDbGljazogKCkgPT5cbiAgICAgICAgICAgICAgICAgIGF0b20ud29ya3NwYWNlLm9wZW4oXCJhdG9tOi8vY29uZmlnL3BhY2thZ2VzL2lkZS1weXRob25cIilcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHRleHQ6IFwiRG93bmxvYWQgUHl0aG9uXCIsXG4gICAgICAgICAgICAgICAgb25EaWRDbGljazogKCkgPT5cbiAgICAgICAgICAgICAgICAgIHNoZWxsLm9wZW5FeHRlcm5hbChcImh0dHBzOi8vd3d3LnB5dGhvbi5vcmcvZG93bmxvYWRzL1wiKVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246XG4gICAgICAgICAgICAgIFwiTWFrZSBzdXJlIHRvIGluc3RhbGwgYHB5bHNgIDAuMTkgb3IgbmV3ZXIgYnkgcnVubmluZzpcXG5cIiArXG4gICAgICAgICAgICAgIFwiYGBgXFxuXCIgK1xuICAgICAgICAgICAgICBgJHtweXRob259IC1tIHBpcCBpbnN0YWxsICdweXRob24tbGFuZ3VhZ2Utc2VydmVyW2FsbF0nXFxuYCArXG4gICAgICAgICAgICAgIFwiYGBgXCJcbiAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIGNoaWxkUHJvY2VzcztcbiAgfVxuXG4gIGFzeW5jIGdldFN1Z2dlc3Rpb25zKHJlcXVlc3QpIHtcbiAgICBpZiAoIVBZVEhPTl9SRUdFWC50ZXN0KHJlcXVlc3QucHJlZml4KSkgcmV0dXJuIG51bGw7XG4gICAgcmV0dXJuIHN1cGVyLmdldFN1Z2dlc3Rpb25zKHJlcXVlc3QpO1xuICB9XG5cbiAgZGVhY3RpdmF0ZSgpIHtcbiAgICBkZWJ1Z2dlckRpc3Bvc2UoKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yYWNlKFtzdXBlci5kZWFjdGl2YXRlKCksIHRoaXMuY3JlYXRlVGltZW91dFByb21pc2UoMjAwMCldKTtcbiAgfVxuXG4gIGNyZWF0ZVRpbWVvdXRQcm9taXNlKG1pbGxpc2Vjb25kcykge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBsZXQgdGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XG4gICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICAgIGBTZXJ2ZXIgZmFpbGVkIHRvIHNodXRkb3duIGluICR7bWlsbGlzZWNvbmRzfW1zLCBmb3JjaW5nIHRlcm1pbmF0aW9uYFxuICAgICAgICApO1xuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9LCBtaWxsaXNlY29uZHMpO1xuICAgIH0pO1xuICB9XG59XG5cbmNvbnN0IHB5dGhvbkNsaWVudCA9IG5ldyBQeXRob25MYW5ndWFnZUNsaWVudCgpXG5weXRob25DbGllbnQuY3JlYXRlRGVidWdnZXJQcm92aWRlciA9IGNyZWF0ZURlYnVnZ2VyUHJvdmlkZXI7IC8vIGFkZCB0aGUgZGVidWdnZXJcbm1vZHVsZS5leHBvcnRzID0gcHl0aG9uQ2xpZW50O1xuIl19