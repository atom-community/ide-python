'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const vscode_1 = require("vscode");

const types_1 = require("../common/platform/types");

const async_1 = require("../common/utils/async");

const telemetry_1 = require("../telemetry");

const constants_1 = require("../telemetry/constants");

const proxy = require("./jediProxy");

function flattenSymbolTree(tree, uri, containerName = '') {
  const flattened = [];
  const range = new vscode_1.Range(tree.range.start.line, tree.range.start.character, tree.range.end.line, tree.range.end.character); // For whatever reason, the values of VS Code's SymbolKind enum
  // are off-by-one relative to the LSP:
  //  https://microsoft.github.io/language-server-protocol/specification#document-symbols-request-leftwards_arrow_with_hook

  const kind = tree.kind - 1;
  const info = new vscode_1.SymbolInformation(tree.name, // Type coercion is a bit fuzzy when it comes to enums, so we
  // play it safe by explicitly converting.
  vscode_1.SymbolKind[vscode_1.SymbolKind[kind]], containerName, new vscode_1.Location(uri, range));
  flattened.push(info);

  if (tree.children && tree.children.length > 0) {
    // FYI: Jedi doesn't fully-qualify the container name so we
    // don't bother here either.
    //const fullName = `${containerName}.${tree.name}`;
    for (const child of tree.children) {
      const flattenedChild = flattenSymbolTree(child, uri, tree.name);
      flattened.push(...flattenedChild);
    }
  }

  return flattened;
}
/**
 * Provides Python symbols to VS Code (from the language server).
 *
 * See:
 *   https://code.visualstudio.com/docs/extensionAPI/vscode-api#DocumentSymbolProvider
 */


class LanguageServerSymbolProvider {
  constructor(languageClient) {
    this.languageClient = languageClient;
  }

  provideDocumentSymbols(document, token) {
    return __awaiter(this, void 0, void 0, function* () {
      const uri = document.uri;
      const args = {
        textDocument: {
          uri: uri.toString()
        }
      };
      const raw = yield this.languageClient.sendRequest('textDocument/documentSymbol', args, token);
      const symbols = [];

      for (const tree of raw) {
        const flattened = flattenSymbolTree(tree, uri);
        symbols.push(...flattened);
      }

      return Promise.resolve(symbols);
    });
  }

}

exports.LanguageServerSymbolProvider = LanguageServerSymbolProvider;
/**
 * Provides Python symbols to VS Code (from Jedi).
 *
 * See:
 *   https://code.visualstudio.com/docs/extensionAPI/vscode-api#DocumentSymbolProvider
 */

class JediSymbolProvider {
  constructor(serviceContainer, jediFactory, debounceTimeoutMs = 500) {
    this.jediFactory = jediFactory;
    this.debounceTimeoutMs = debounceTimeoutMs;
    this.debounceRequest = new Map();
    this.fs = serviceContainer.get(types_1.IFileSystem);
  }

  provideDocumentSymbols(document, token) {
    return this.provideDocumentSymbolsThrottled(document, token);
  }

  provideDocumentSymbolsThrottled(document, token) {
    const key = `${document.uri.fsPath}`;

    if (this.debounceRequest.has(key)) {
      const item = this.debounceRequest.get(key);
      clearTimeout(item.timer);
      item.deferred.resolve([]);
    }

    const deferred = async_1.createDeferred();
    const timer = setTimeout(() => {
      if (token.isCancellationRequested) {
        return deferred.resolve([]);
      }

      const filename = document.fileName;
      const cmd = {
        command: proxy.CommandType.Symbols,
        fileName: filename,
        columnIndex: 0,
        lineIndex: 0
      };

      if (document.isDirty) {
        cmd.source = document.getText();
      }

      this.jediFactory.getJediProxyHandler(document.uri).sendCommand(cmd, token).then(data => this.parseData(document, data)).then(items => deferred.resolve(items)).catch(ex => deferred.reject(ex));
    }, this.debounceTimeoutMs);
    token.onCancellationRequested(() => {
      clearTimeout(timer);
      deferred.resolve([]);
      this.debounceRequest.delete(key);
    }); // When a document is not saved on FS, we cannot uniquely identify it, so lets not debounce, but delay the symbol provider.

    if (!document.isUntitled) {
      this.debounceRequest.set(key, {
        timer,
        deferred
      });
    }

    return deferred.promise;
  } // This does not appear to be used anywhere currently...
  // tslint:disable-next-line:no-unused-variable


  provideDocumentSymbolsUnthrottled(document, token) {
    const filename = document.fileName;
    const cmd = {
      command: proxy.CommandType.Symbols,
      fileName: filename,
      columnIndex: 0,
      lineIndex: 0
    };

    if (document.isDirty) {
      cmd.source = document.getText();
    }

    return this.jediFactory.getJediProxyHandler(document.uri).sendCommandNonCancellableCommand(cmd, token).then(data => this.parseData(document, data));
  }

  parseData(document, data) {
    if (data) {
      const symbols = data.definitions.filter(sym => this.fs.arePathsSame(sym.fileName, document.fileName));
      return symbols.map(sym => {
        const symbol = sym.kind;
        const range = new vscode_1.Range(sym.range.startLine, sym.range.startColumn, sym.range.endLine, sym.range.endColumn);
        const uri = vscode_1.Uri.file(sym.fileName);
        const location = new vscode_1.Location(uri, range);
        return new vscode_1.SymbolInformation(sym.text, symbol, sym.container, location);
      });
    }

    return [];
  }

}

__decorate([telemetry_1.captureTelemetry(constants_1.SYMBOL)], JediSymbolProvider.prototype, "provideDocumentSymbols", null);

exports.JediSymbolProvider = JediSymbolProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInN5bWJvbFByb3ZpZGVyLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJleHBvcnRzIiwidnNjb2RlXzEiLCJyZXF1aXJlIiwidHlwZXNfMSIsImFzeW5jXzEiLCJ0ZWxlbWV0cnlfMSIsImNvbnN0YW50c18xIiwicHJveHkiLCJmbGF0dGVuU3ltYm9sVHJlZSIsInRyZWUiLCJ1cmkiLCJjb250YWluZXJOYW1lIiwiZmxhdHRlbmVkIiwicmFuZ2UiLCJSYW5nZSIsInN0YXJ0IiwibGluZSIsImNoYXJhY3RlciIsImVuZCIsImtpbmQiLCJpbmZvIiwiU3ltYm9sSW5mb3JtYXRpb24iLCJuYW1lIiwiU3ltYm9sS2luZCIsIkxvY2F0aW9uIiwicHVzaCIsImNoaWxkcmVuIiwiY2hpbGQiLCJmbGF0dGVuZWRDaGlsZCIsIkxhbmd1YWdlU2VydmVyU3ltYm9sUHJvdmlkZXIiLCJjb25zdHJ1Y3RvciIsImxhbmd1YWdlQ2xpZW50IiwicHJvdmlkZURvY3VtZW50U3ltYm9scyIsImRvY3VtZW50IiwidG9rZW4iLCJhcmdzIiwidGV4dERvY3VtZW50IiwidG9TdHJpbmciLCJyYXciLCJzZW5kUmVxdWVzdCIsInN5bWJvbHMiLCJKZWRpU3ltYm9sUHJvdmlkZXIiLCJzZXJ2aWNlQ29udGFpbmVyIiwiamVkaUZhY3RvcnkiLCJkZWJvdW5jZVRpbWVvdXRNcyIsImRlYm91bmNlUmVxdWVzdCIsIk1hcCIsImZzIiwiZ2V0IiwiSUZpbGVTeXN0ZW0iLCJwcm92aWRlRG9jdW1lbnRTeW1ib2xzVGhyb3R0bGVkIiwiZnNQYXRoIiwiaGFzIiwiaXRlbSIsImNsZWFyVGltZW91dCIsInRpbWVyIiwiZGVmZXJyZWQiLCJjcmVhdGVEZWZlcnJlZCIsInNldFRpbWVvdXQiLCJpc0NhbmNlbGxhdGlvblJlcXVlc3RlZCIsImZpbGVuYW1lIiwiZmlsZU5hbWUiLCJjbWQiLCJjb21tYW5kIiwiQ29tbWFuZFR5cGUiLCJTeW1ib2xzIiwiY29sdW1uSW5kZXgiLCJsaW5lSW5kZXgiLCJpc0RpcnR5Iiwic291cmNlIiwiZ2V0VGV4dCIsImdldEplZGlQcm94eUhhbmRsZXIiLCJzZW5kQ29tbWFuZCIsImRhdGEiLCJwYXJzZURhdGEiLCJpdGVtcyIsImNhdGNoIiwiZXgiLCJvbkNhbmNlbGxhdGlvblJlcXVlc3RlZCIsImRlbGV0ZSIsImlzVW50aXRsZWQiLCJzZXQiLCJwcm9taXNlIiwicHJvdmlkZURvY3VtZW50U3ltYm9sc1VudGhyb3R0bGVkIiwic2VuZENvbW1hbmROb25DYW5jZWxsYWJsZUNvbW1hbmQiLCJkZWZpbml0aW9ucyIsImZpbHRlciIsInN5bSIsImFyZVBhdGhzU2FtZSIsIm1hcCIsInN5bWJvbCIsInN0YXJ0TGluZSIsInN0YXJ0Q29sdW1uIiwiZW5kTGluZSIsImVuZENvbHVtbiIsIlVyaSIsImZpbGUiLCJsb2NhdGlvbiIsInRleHQiLCJjb250YWluZXIiLCJjYXB0dXJlVGVsZW1ldHJ5IiwiU1lNQk9MIiwicHJvdG90eXBlIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEsTUFB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QUFDSDs7QUE1RW9COztBQThFekJuSSxVQUFVLENBQUMsQ0FDUHVDLFdBQVcsQ0FBQytGLGdCQUFaLENBQTZCOUYsV0FBVyxDQUFDK0YsTUFBekMsQ0FETyxDQUFELEVBRVA1RCxrQkFBa0IsQ0FBQzZELFNBRlosRUFFdUIsd0JBRnZCLEVBRWlELElBRmpELENBQVY7O0FBR0F0RyxPQUFPLENBQUN5QyxrQkFBUixHQUE2QkEsa0JBQTdCIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xudmFyIF9fZGVjb3JhdGUgPSAodGhpcyAmJiB0aGlzLl9fZGVjb3JhdGUpIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcbiAgICBlbHNlIGZvciAodmFyIGkgPSBkZWNvcmF0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBpZiAoZCA9IGRlY29yYXRvcnNbaV0pIHIgPSAoYyA8IDMgPyBkKHIpIDogYyA+IDMgPyBkKHRhcmdldCwga2V5LCByKSA6IGQodGFyZ2V0LCBrZXkpKSB8fCByO1xuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XG59O1xudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcbiAgICB9KTtcbn07XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5jb25zdCB2c2NvZGVfMSA9IHJlcXVpcmUoXCJ2c2NvZGVcIik7XG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uL2NvbW1vbi9wbGF0Zm9ybS90eXBlc1wiKTtcbmNvbnN0IGFzeW5jXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL3V0aWxzL2FzeW5jXCIpO1xuY29uc3QgdGVsZW1ldHJ5XzEgPSByZXF1aXJlKFwiLi4vdGVsZW1ldHJ5XCIpO1xuY29uc3QgY29uc3RhbnRzXzEgPSByZXF1aXJlKFwiLi4vdGVsZW1ldHJ5L2NvbnN0YW50c1wiKTtcbmNvbnN0IHByb3h5ID0gcmVxdWlyZShcIi4vamVkaVByb3h5XCIpO1xuZnVuY3Rpb24gZmxhdHRlblN5bWJvbFRyZWUodHJlZSwgdXJpLCBjb250YWluZXJOYW1lID0gJycpIHtcbiAgICBjb25zdCBmbGF0dGVuZWQgPSBbXTtcbiAgICBjb25zdCByYW5nZSA9IG5ldyB2c2NvZGVfMS5SYW5nZSh0cmVlLnJhbmdlLnN0YXJ0LmxpbmUsIHRyZWUucmFuZ2Uuc3RhcnQuY2hhcmFjdGVyLCB0cmVlLnJhbmdlLmVuZC5saW5lLCB0cmVlLnJhbmdlLmVuZC5jaGFyYWN0ZXIpO1xuICAgIC8vIEZvciB3aGF0ZXZlciByZWFzb24sIHRoZSB2YWx1ZXMgb2YgVlMgQ29kZSdzIFN5bWJvbEtpbmQgZW51bVxuICAgIC8vIGFyZSBvZmYtYnktb25lIHJlbGF0aXZlIHRvIHRoZSBMU1A6XG4gICAgLy8gIGh0dHBzOi8vbWljcm9zb2Z0LmdpdGh1Yi5pby9sYW5ndWFnZS1zZXJ2ZXItcHJvdG9jb2wvc3BlY2lmaWNhdGlvbiNkb2N1bWVudC1zeW1ib2xzLXJlcXVlc3QtbGVmdHdhcmRzX2Fycm93X3dpdGhfaG9va1xuICAgIGNvbnN0IGtpbmQgPSB0cmVlLmtpbmQgLSAxO1xuICAgIGNvbnN0IGluZm8gPSBuZXcgdnNjb2RlXzEuU3ltYm9sSW5mb3JtYXRpb24odHJlZS5uYW1lLCBcbiAgICAvLyBUeXBlIGNvZXJjaW9uIGlzIGEgYml0IGZ1enp5IHdoZW4gaXQgY29tZXMgdG8gZW51bXMsIHNvIHdlXG4gICAgLy8gcGxheSBpdCBzYWZlIGJ5IGV4cGxpY2l0bHkgY29udmVydGluZy5cbiAgICB2c2NvZGVfMS5TeW1ib2xLaW5kW3ZzY29kZV8xLlN5bWJvbEtpbmRba2luZF1dLCBjb250YWluZXJOYW1lLCBuZXcgdnNjb2RlXzEuTG9jYXRpb24odXJpLCByYW5nZSkpO1xuICAgIGZsYXR0ZW5lZC5wdXNoKGluZm8pO1xuICAgIGlmICh0cmVlLmNoaWxkcmVuICYmIHRyZWUuY2hpbGRyZW4ubGVuZ3RoID4gMCkge1xuICAgICAgICAvLyBGWUk6IEplZGkgZG9lc24ndCBmdWxseS1xdWFsaWZ5IHRoZSBjb250YWluZXIgbmFtZSBzbyB3ZVxuICAgICAgICAvLyBkb24ndCBib3RoZXIgaGVyZSBlaXRoZXIuXG4gICAgICAgIC8vY29uc3QgZnVsbE5hbWUgPSBgJHtjb250YWluZXJOYW1lfS4ke3RyZWUubmFtZX1gO1xuICAgICAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHRyZWUuY2hpbGRyZW4pIHtcbiAgICAgICAgICAgIGNvbnN0IGZsYXR0ZW5lZENoaWxkID0gZmxhdHRlblN5bWJvbFRyZWUoY2hpbGQsIHVyaSwgdHJlZS5uYW1lKTtcbiAgICAgICAgICAgIGZsYXR0ZW5lZC5wdXNoKC4uLmZsYXR0ZW5lZENoaWxkKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmxhdHRlbmVkO1xufVxuLyoqXG4gKiBQcm92aWRlcyBQeXRob24gc3ltYm9scyB0byBWUyBDb2RlIChmcm9tIHRoZSBsYW5ndWFnZSBzZXJ2ZXIpLlxuICpcbiAqIFNlZTpcbiAqICAgaHR0cHM6Ly9jb2RlLnZpc3VhbHN0dWRpby5jb20vZG9jcy9leHRlbnNpb25BUEkvdnNjb2RlLWFwaSNEb2N1bWVudFN5bWJvbFByb3ZpZGVyXG4gKi9cbmNsYXNzIExhbmd1YWdlU2VydmVyU3ltYm9sUHJvdmlkZXIge1xuICAgIGNvbnN0cnVjdG9yKGxhbmd1YWdlQ2xpZW50KSB7XG4gICAgICAgIHRoaXMubGFuZ3VhZ2VDbGllbnQgPSBsYW5ndWFnZUNsaWVudDtcbiAgICB9XG4gICAgcHJvdmlkZURvY3VtZW50U3ltYm9scyhkb2N1bWVudCwgdG9rZW4pIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IHVyaSA9IGRvY3VtZW50LnVyaTtcbiAgICAgICAgICAgIGNvbnN0IGFyZ3MgPSB7IHRleHREb2N1bWVudDogeyB1cmk6IHVyaS50b1N0cmluZygpIH0gfTtcbiAgICAgICAgICAgIGNvbnN0IHJhdyA9IHlpZWxkIHRoaXMubGFuZ3VhZ2VDbGllbnQuc2VuZFJlcXVlc3QoJ3RleHREb2N1bWVudC9kb2N1bWVudFN5bWJvbCcsIGFyZ3MsIHRva2VuKTtcbiAgICAgICAgICAgIGNvbnN0IHN5bWJvbHMgPSBbXTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgdHJlZSBvZiByYXcpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBmbGF0dGVuZWQgPSBmbGF0dGVuU3ltYm9sVHJlZSh0cmVlLCB1cmkpO1xuICAgICAgICAgICAgICAgIHN5bWJvbHMucHVzaCguLi5mbGF0dGVuZWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShzeW1ib2xzKTtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuZXhwb3J0cy5MYW5ndWFnZVNlcnZlclN5bWJvbFByb3ZpZGVyID0gTGFuZ3VhZ2VTZXJ2ZXJTeW1ib2xQcm92aWRlcjtcbi8qKlxuICogUHJvdmlkZXMgUHl0aG9uIHN5bWJvbHMgdG8gVlMgQ29kZSAoZnJvbSBKZWRpKS5cbiAqXG4gKiBTZWU6XG4gKiAgIGh0dHBzOi8vY29kZS52aXN1YWxzdHVkaW8uY29tL2RvY3MvZXh0ZW5zaW9uQVBJL3ZzY29kZS1hcGkjRG9jdW1lbnRTeW1ib2xQcm92aWRlclxuICovXG5jbGFzcyBKZWRpU3ltYm9sUHJvdmlkZXIge1xuICAgIGNvbnN0cnVjdG9yKHNlcnZpY2VDb250YWluZXIsIGplZGlGYWN0b3J5LCBkZWJvdW5jZVRpbWVvdXRNcyA9IDUwMCkge1xuICAgICAgICB0aGlzLmplZGlGYWN0b3J5ID0gamVkaUZhY3Rvcnk7XG4gICAgICAgIHRoaXMuZGVib3VuY2VUaW1lb3V0TXMgPSBkZWJvdW5jZVRpbWVvdXRNcztcbiAgICAgICAgdGhpcy5kZWJvdW5jZVJlcXVlc3QgPSBuZXcgTWFwKCk7XG4gICAgICAgIHRoaXMuZnMgPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklGaWxlU3lzdGVtKTtcbiAgICB9XG4gICAgcHJvdmlkZURvY3VtZW50U3ltYm9scyhkb2N1bWVudCwgdG9rZW4pIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvdmlkZURvY3VtZW50U3ltYm9sc1Rocm90dGxlZChkb2N1bWVudCwgdG9rZW4pO1xuICAgIH1cbiAgICBwcm92aWRlRG9jdW1lbnRTeW1ib2xzVGhyb3R0bGVkKGRvY3VtZW50LCB0b2tlbikge1xuICAgICAgICBjb25zdCBrZXkgPSBgJHtkb2N1bWVudC51cmkuZnNQYXRofWA7XG4gICAgICAgIGlmICh0aGlzLmRlYm91bmNlUmVxdWVzdC5oYXMoa2V5KSkge1xuICAgICAgICAgICAgY29uc3QgaXRlbSA9IHRoaXMuZGVib3VuY2VSZXF1ZXN0LmdldChrZXkpO1xuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGl0ZW0udGltZXIpO1xuICAgICAgICAgICAgaXRlbS5kZWZlcnJlZC5yZXNvbHZlKFtdKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBkZWZlcnJlZCA9IGFzeW5jXzEuY3JlYXRlRGVmZXJyZWQoKTtcbiAgICAgICAgY29uc3QgdGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIGlmICh0b2tlbi5pc0NhbmNlbGxhdGlvblJlcXVlc3RlZCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBkZWZlcnJlZC5yZXNvbHZlKFtdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGZpbGVuYW1lID0gZG9jdW1lbnQuZmlsZU5hbWU7XG4gICAgICAgICAgICBjb25zdCBjbWQgPSB7XG4gICAgICAgICAgICAgICAgY29tbWFuZDogcHJveHkuQ29tbWFuZFR5cGUuU3ltYm9scyxcbiAgICAgICAgICAgICAgICBmaWxlTmFtZTogZmlsZW5hbWUsXG4gICAgICAgICAgICAgICAgY29sdW1uSW5kZXg6IDAsXG4gICAgICAgICAgICAgICAgbGluZUluZGV4OiAwXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgaWYgKGRvY3VtZW50LmlzRGlydHkpIHtcbiAgICAgICAgICAgICAgICBjbWQuc291cmNlID0gZG9jdW1lbnQuZ2V0VGV4dCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5qZWRpRmFjdG9yeS5nZXRKZWRpUHJveHlIYW5kbGVyKGRvY3VtZW50LnVyaSkuc2VuZENvbW1hbmQoY21kLCB0b2tlbilcbiAgICAgICAgICAgICAgICAudGhlbihkYXRhID0+IHRoaXMucGFyc2VEYXRhKGRvY3VtZW50LCBkYXRhKSlcbiAgICAgICAgICAgICAgICAudGhlbihpdGVtcyA9PiBkZWZlcnJlZC5yZXNvbHZlKGl0ZW1zKSlcbiAgICAgICAgICAgICAgICAuY2F0Y2goZXggPT4gZGVmZXJyZWQucmVqZWN0KGV4KSk7XG4gICAgICAgIH0sIHRoaXMuZGVib3VuY2VUaW1lb3V0TXMpO1xuICAgICAgICB0b2tlbi5vbkNhbmNlbGxhdGlvblJlcXVlc3RlZCgoKSA9PiB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShbXSk7XG4gICAgICAgICAgICB0aGlzLmRlYm91bmNlUmVxdWVzdC5kZWxldGUoa2V5KTtcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIFdoZW4gYSBkb2N1bWVudCBpcyBub3Qgc2F2ZWQgb24gRlMsIHdlIGNhbm5vdCB1bmlxdWVseSBpZGVudGlmeSBpdCwgc28gbGV0cyBub3QgZGVib3VuY2UsIGJ1dCBkZWxheSB0aGUgc3ltYm9sIHByb3ZpZGVyLlxuICAgICAgICBpZiAoIWRvY3VtZW50LmlzVW50aXRsZWQpIHtcbiAgICAgICAgICAgIHRoaXMuZGVib3VuY2VSZXF1ZXN0LnNldChrZXksIHsgdGltZXIsIGRlZmVycmVkIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xuICAgIH1cbiAgICAvLyBUaGlzIGRvZXMgbm90IGFwcGVhciB0byBiZSB1c2VkIGFueXdoZXJlIGN1cnJlbnRseS4uLlxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby11bnVzZWQtdmFyaWFibGVcbiAgICBwcm92aWRlRG9jdW1lbnRTeW1ib2xzVW50aHJvdHRsZWQoZG9jdW1lbnQsIHRva2VuKSB7XG4gICAgICAgIGNvbnN0IGZpbGVuYW1lID0gZG9jdW1lbnQuZmlsZU5hbWU7XG4gICAgICAgIGNvbnN0IGNtZCA9IHtcbiAgICAgICAgICAgIGNvbW1hbmQ6IHByb3h5LkNvbW1hbmRUeXBlLlN5bWJvbHMsXG4gICAgICAgICAgICBmaWxlTmFtZTogZmlsZW5hbWUsXG4gICAgICAgICAgICBjb2x1bW5JbmRleDogMCxcbiAgICAgICAgICAgIGxpbmVJbmRleDogMFxuICAgICAgICB9O1xuICAgICAgICBpZiAoZG9jdW1lbnQuaXNEaXJ0eSkge1xuICAgICAgICAgICAgY21kLnNvdXJjZSA9IGRvY3VtZW50LmdldFRleHQoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5qZWRpRmFjdG9yeS5nZXRKZWRpUHJveHlIYW5kbGVyKGRvY3VtZW50LnVyaSkuc2VuZENvbW1hbmROb25DYW5jZWxsYWJsZUNvbW1hbmQoY21kLCB0b2tlbilcbiAgICAgICAgICAgIC50aGVuKGRhdGEgPT4gdGhpcy5wYXJzZURhdGEoZG9jdW1lbnQsIGRhdGEpKTtcbiAgICB9XG4gICAgcGFyc2VEYXRhKGRvY3VtZW50LCBkYXRhKSB7XG4gICAgICAgIGlmIChkYXRhKSB7XG4gICAgICAgICAgICBjb25zdCBzeW1ib2xzID0gZGF0YS5kZWZpbml0aW9ucy5maWx0ZXIoc3ltID0+IHRoaXMuZnMuYXJlUGF0aHNTYW1lKHN5bS5maWxlTmFtZSwgZG9jdW1lbnQuZmlsZU5hbWUpKTtcbiAgICAgICAgICAgIHJldHVybiBzeW1ib2xzLm1hcChzeW0gPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHN5bWJvbCA9IHN5bS5raW5kO1xuICAgICAgICAgICAgICAgIGNvbnN0IHJhbmdlID0gbmV3IHZzY29kZV8xLlJhbmdlKHN5bS5yYW5nZS5zdGFydExpbmUsIHN5bS5yYW5nZS5zdGFydENvbHVtbiwgc3ltLnJhbmdlLmVuZExpbmUsIHN5bS5yYW5nZS5lbmRDb2x1bW4pO1xuICAgICAgICAgICAgICAgIGNvbnN0IHVyaSA9IHZzY29kZV8xLlVyaS5maWxlKHN5bS5maWxlTmFtZSk7XG4gICAgICAgICAgICAgICAgY29uc3QgbG9jYXRpb24gPSBuZXcgdnNjb2RlXzEuTG9jYXRpb24odXJpLCByYW5nZSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyB2c2NvZGVfMS5TeW1ib2xJbmZvcm1hdGlvbihzeW0udGV4dCwgc3ltYm9sLCBzeW0uY29udGFpbmVyLCBsb2NhdGlvbik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gW107XG4gICAgfVxufVxuX19kZWNvcmF0ZShbXG4gICAgdGVsZW1ldHJ5XzEuY2FwdHVyZVRlbGVtZXRyeShjb25zdGFudHNfMS5TWU1CT0wpXG5dLCBKZWRpU3ltYm9sUHJvdmlkZXIucHJvdG90eXBlLCBcInByb3ZpZGVEb2N1bWVudFN5bWJvbHNcIiwgbnVsbCk7XG5leHBvcnRzLkplZGlTeW1ib2xQcm92aWRlciA9IEplZGlTeW1ib2xQcm92aWRlcjtcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPXN5bWJvbFByb3ZpZGVyLmpzLm1hcCJdfQ==