// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const path = require("path");

const vscode_1 = require("vscode");

const types_1 = require("../common/application/types");

const configSettingMonitor_1 = require("../common/configSettingMonitor");

const constants_1 = require("../common/constants");

require("../common/extensions");

const types_2 = require("../common/platform/types");

const types_3 = require("../common/types");

const contracts_1 = require("../interpreter/contracts");

const types_4 = require("../linters/types");

class LinterProvider {
  constructor(context, serviceContainer) {
    this.context = context;
    this.disposables = [];
    this.fs = serviceContainer.get(types_2.IFileSystem);
    this.engine = serviceContainer.get(types_4.ILintingEngine);
    this.linterManager = serviceContainer.get(types_4.ILinterManager);
    this.interpreterService = serviceContainer.get(contracts_1.IInterpreterService);
    this.documents = serviceContainer.get(types_1.IDocumentManager);
    this.configuration = serviceContainer.get(types_3.IConfigurationService);
    this.disposables.push(this.interpreterService.onDidChangeInterpreter(() => this.engine.lintOpenPythonFiles()));
    this.documents.onDidOpenTextDocument(e => this.onDocumentOpened(e), this.context.subscriptions);
    this.documents.onDidCloseTextDocument(e => this.onDocumentClosed(e), this.context.subscriptions);
    this.documents.onDidSaveTextDocument(e => this.onDocumentSaved(e), this.context.subscriptions);
    this.configMonitor = new configSettingMonitor_1.ConfigSettingMonitor('linting');
    this.configMonitor.on('change', this.lintSettingsChangedHandler.bind(this)); // On workspace reopen we don't get `onDocumentOpened` since it is first opened
    // and then the extension is activated. So schedule linting pass now.

    if (!constants_1.isTestExecution()) {
      setTimeout(() => this.engine.lintOpenPythonFiles().ignoreErrors(), 1200);
    }
  }

  dispose() {
    this.disposables.forEach(d => d.dispose());
    this.configMonitor.dispose();
  }

  isDocumentOpen(uri) {
    return this.documents.textDocuments.some(document => this.fs.arePathsSame(document.uri.fsPath, uri.fsPath));
  }

  lintSettingsChangedHandler(configTarget, wkspaceOrFolder) {
    if (configTarget === vscode_1.ConfigurationTarget.Workspace) {
      this.engine.lintOpenPythonFiles().ignoreErrors();
      return;
    } // Look for python files that belong to the specified workspace folder.


    vscode_1.workspace.textDocuments.forEach(document => __awaiter(this, void 0, void 0, function* () {
      const wkspaceFolder = vscode_1.workspace.getWorkspaceFolder(document.uri);

      if (wkspaceFolder && wkspaceFolder.uri.fsPath === wkspaceOrFolder.fsPath) {
        this.engine.lintDocument(document, 'auto').ignoreErrors();
      }
    }));
  }

  onDocumentOpened(document) {
    this.engine.lintDocument(document, 'auto').ignoreErrors();
  }

  onDocumentSaved(document) {
    const settings = this.configuration.getSettings(document.uri);

    if (document.languageId === 'python' && settings.linting.enabled && settings.linting.lintOnSave) {
      this.engine.lintDocument(document, 'save').ignoreErrors();
      return;
    }

    this.linterManager.getActiveLinters(false, document.uri).then(linters => {
      const fileName = path.basename(document.uri.fsPath).toLowerCase();
      const watchers = linters.filter(info => info.configFileNames.indexOf(fileName) >= 0);

      if (watchers.length > 0) {
        setTimeout(() => this.engine.lintOpenPythonFiles(), 1000);
      }
    }).ignoreErrors();
  }

  onDocumentClosed(document) {
    if (!document || !document.fileName || !document.uri) {
      return;
    } // Check if this document is still open as a duplicate editor.


    if (!this.isDocumentOpen(document.uri)) {
      this.engine.clearDiagnostics(document);
    }
  }

}

exports.LinterProvider = LinterProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpbnRlclByb3ZpZGVyLmpzIl0sIm5hbWVzIjpbIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJwYXRoIiwicmVxdWlyZSIsInZzY29kZV8xIiwidHlwZXNfMSIsImNvbmZpZ1NldHRpbmdNb25pdG9yXzEiLCJjb25zdGFudHNfMSIsInR5cGVzXzIiLCJ0eXBlc18zIiwiY29udHJhY3RzXzEiLCJ0eXBlc180IiwiTGludGVyUHJvdmlkZXIiLCJjb25zdHJ1Y3RvciIsImNvbnRleHQiLCJzZXJ2aWNlQ29udGFpbmVyIiwiZGlzcG9zYWJsZXMiLCJmcyIsImdldCIsIklGaWxlU3lzdGVtIiwiZW5naW5lIiwiSUxpbnRpbmdFbmdpbmUiLCJsaW50ZXJNYW5hZ2VyIiwiSUxpbnRlck1hbmFnZXIiLCJpbnRlcnByZXRlclNlcnZpY2UiLCJJSW50ZXJwcmV0ZXJTZXJ2aWNlIiwiZG9jdW1lbnRzIiwiSURvY3VtZW50TWFuYWdlciIsImNvbmZpZ3VyYXRpb24iLCJJQ29uZmlndXJhdGlvblNlcnZpY2UiLCJwdXNoIiwib25EaWRDaGFuZ2VJbnRlcnByZXRlciIsImxpbnRPcGVuUHl0aG9uRmlsZXMiLCJvbkRpZE9wZW5UZXh0RG9jdW1lbnQiLCJvbkRvY3VtZW50T3BlbmVkIiwic3Vic2NyaXB0aW9ucyIsIm9uRGlkQ2xvc2VUZXh0RG9jdW1lbnQiLCJvbkRvY3VtZW50Q2xvc2VkIiwib25EaWRTYXZlVGV4dERvY3VtZW50Iiwib25Eb2N1bWVudFNhdmVkIiwiY29uZmlnTW9uaXRvciIsIkNvbmZpZ1NldHRpbmdNb25pdG9yIiwib24iLCJsaW50U2V0dGluZ3NDaGFuZ2VkSGFuZGxlciIsImJpbmQiLCJpc1Rlc3RFeGVjdXRpb24iLCJzZXRUaW1lb3V0IiwiaWdub3JlRXJyb3JzIiwiZGlzcG9zZSIsImZvckVhY2giLCJkIiwiaXNEb2N1bWVudE9wZW4iLCJ1cmkiLCJ0ZXh0RG9jdW1lbnRzIiwic29tZSIsImRvY3VtZW50IiwiYXJlUGF0aHNTYW1lIiwiZnNQYXRoIiwiY29uZmlnVGFyZ2V0Iiwid2tzcGFjZU9yRm9sZGVyIiwiQ29uZmlndXJhdGlvblRhcmdldCIsIldvcmtzcGFjZSIsIndvcmtzcGFjZSIsIndrc3BhY2VGb2xkZXIiLCJnZXRXb3Jrc3BhY2VGb2xkZXIiLCJsaW50RG9jdW1lbnQiLCJzZXR0aW5ncyIsImdldFNldHRpbmdzIiwibGFuZ3VhZ2VJZCIsImxpbnRpbmciLCJlbmFibGVkIiwibGludE9uU2F2ZSIsImdldEFjdGl2ZUxpbnRlcnMiLCJsaW50ZXJzIiwiZmlsZU5hbWUiLCJiYXNlbmFtZSIsInRvTG93ZXJDYXNlIiwid2F0Y2hlcnMiLCJmaWx0ZXIiLCJpbmZvIiwiY29uZmlnRmlsZU5hbWVzIiwiaW5kZXhPZiIsImxlbmd0aCIsImNsZWFyRGlhZ25vc3RpY3MiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxTQUFTLEdBQUksVUFBUSxTQUFLQSxTQUFkLElBQTRCLFVBQVVDLE9BQVYsRUFBbUJDLFVBQW5CLEVBQStCQyxDQUEvQixFQUFrQ0MsU0FBbEMsRUFBNkM7QUFDckYsU0FBTyxLQUFLRCxDQUFDLEtBQUtBLENBQUMsR0FBR0UsT0FBVCxDQUFOLEVBQXlCLFVBQVVDLE9BQVYsRUFBbUJDLE1BQW5CLEVBQTJCO0FBQ3ZELGFBQVNDLFNBQVQsQ0FBbUJDLEtBQW5CLEVBQTBCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQ08sSUFBVixDQUFlRixLQUFmLENBQUQsQ0FBSjtBQUE4QixPQUFwQyxDQUFxQyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxD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T0FBTyxDQUFDVyxjQUFSLEdBQXlCQSxjQUF6QiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxuJ3VzZSBzdHJpY3QnO1xudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcbiAgICB9KTtcbn07XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5jb25zdCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XG5jb25zdCB2c2NvZGVfMSA9IHJlcXVpcmUoXCJ2c2NvZGVcIik7XG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uL2NvbW1vbi9hcHBsaWNhdGlvbi90eXBlc1wiKTtcbmNvbnN0IGNvbmZpZ1NldHRpbmdNb25pdG9yXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL2NvbmZpZ1NldHRpbmdNb25pdG9yXCIpO1xuY29uc3QgY29uc3RhbnRzXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL2NvbnN0YW50c1wiKTtcbnJlcXVpcmUoXCIuLi9jb21tb24vZXh0ZW5zaW9uc1wiKTtcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vY29tbW9uL3BsYXRmb3JtL3R5cGVzXCIpO1xuY29uc3QgdHlwZXNfMyA9IHJlcXVpcmUoXCIuLi9jb21tb24vdHlwZXNcIik7XG5jb25zdCBjb250cmFjdHNfMSA9IHJlcXVpcmUoXCIuLi9pbnRlcnByZXRlci9jb250cmFjdHNcIik7XG5jb25zdCB0eXBlc180ID0gcmVxdWlyZShcIi4uL2xpbnRlcnMvdHlwZXNcIik7XG5jbGFzcyBMaW50ZXJQcm92aWRlciB7XG4gICAgY29uc3RydWN0b3IoY29udGV4dCwgc2VydmljZUNvbnRhaW5lcikge1xuICAgICAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0O1xuICAgICAgICB0aGlzLmRpc3Bvc2FibGVzID0gW107XG4gICAgICAgIHRoaXMuZnMgPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18yLklGaWxlU3lzdGVtKTtcbiAgICAgICAgdGhpcy5lbmdpbmUgPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc180LklMaW50aW5nRW5naW5lKTtcbiAgICAgICAgdGhpcy5saW50ZXJNYW5hZ2VyID0gc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfNC5JTGludGVyTWFuYWdlcik7XG4gICAgICAgIHRoaXMuaW50ZXJwcmV0ZXJTZXJ2aWNlID0gc2VydmljZUNvbnRhaW5lci5nZXQoY29udHJhY3RzXzEuSUludGVycHJldGVyU2VydmljZSk7XG4gICAgICAgIHRoaXMuZG9jdW1lbnRzID0gc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JRG9jdW1lbnRNYW5hZ2VyKTtcbiAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uID0gc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMy5JQ29uZmlndXJhdGlvblNlcnZpY2UpO1xuICAgICAgICB0aGlzLmRpc3Bvc2FibGVzLnB1c2godGhpcy5pbnRlcnByZXRlclNlcnZpY2Uub25EaWRDaGFuZ2VJbnRlcnByZXRlcigoKSA9PiB0aGlzLmVuZ2luZS5saW50T3BlblB5dGhvbkZpbGVzKCkpKTtcbiAgICAgICAgdGhpcy5kb2N1bWVudHMub25EaWRPcGVuVGV4dERvY3VtZW50KGUgPT4gdGhpcy5vbkRvY3VtZW50T3BlbmVkKGUpLCB0aGlzLmNvbnRleHQuc3Vic2NyaXB0aW9ucyk7XG4gICAgICAgIHRoaXMuZG9jdW1lbnRzLm9uRGlkQ2xvc2VUZXh0RG9jdW1lbnQoZSA9PiB0aGlzLm9uRG9jdW1lbnRDbG9zZWQoZSksIHRoaXMuY29udGV4dC5zdWJzY3JpcHRpb25zKTtcbiAgICAgICAgdGhpcy5kb2N1bWVudHMub25EaWRTYXZlVGV4dERvY3VtZW50KGUgPT4gdGhpcy5vbkRvY3VtZW50U2F2ZWQoZSksIHRoaXMuY29udGV4dC5zdWJzY3JpcHRpb25zKTtcbiAgICAgICAgdGhpcy5jb25maWdNb25pdG9yID0gbmV3IGNvbmZpZ1NldHRpbmdNb25pdG9yXzEuQ29uZmlnU2V0dGluZ01vbml0b3IoJ2xpbnRpbmcnKTtcbiAgICAgICAgdGhpcy5jb25maWdNb25pdG9yLm9uKCdjaGFuZ2UnLCB0aGlzLmxpbnRTZXR0aW5nc0NoYW5nZWRIYW5kbGVyLmJpbmQodGhpcykpO1xuICAgICAgICAvLyBPbiB3b3Jrc3BhY2UgcmVvcGVuIHdlIGRvbid0IGdldCBgb25Eb2N1bWVudE9wZW5lZGAgc2luY2UgaXQgaXMgZmlyc3Qgb3BlbmVkXG4gICAgICAgIC8vIGFuZCB0aGVuIHRoZSBleHRlbnNpb24gaXMgYWN0aXZhdGVkLiBTbyBzY2hlZHVsZSBsaW50aW5nIHBhc3Mgbm93LlxuICAgICAgICBpZiAoIWNvbnN0YW50c18xLmlzVGVzdEV4ZWN1dGlvbigpKSB7XG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuZW5naW5lLmxpbnRPcGVuUHl0aG9uRmlsZXMoKS5pZ25vcmVFcnJvcnMoKSwgMTIwMCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZGlzcG9zZSgpIHtcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlcy5mb3JFYWNoKGQgPT4gZC5kaXNwb3NlKCkpO1xuICAgICAgICB0aGlzLmNvbmZpZ01vbml0b3IuZGlzcG9zZSgpO1xuICAgIH1cbiAgICBpc0RvY3VtZW50T3Blbih1cmkpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZG9jdW1lbnRzLnRleHREb2N1bWVudHMuc29tZShkb2N1bWVudCA9PiB0aGlzLmZzLmFyZVBhdGhzU2FtZShkb2N1bWVudC51cmkuZnNQYXRoLCB1cmkuZnNQYXRoKSk7XG4gICAgfVxuICAgIGxpbnRTZXR0aW5nc0NoYW5nZWRIYW5kbGVyKGNvbmZpZ1RhcmdldCwgd2tzcGFjZU9yRm9sZGVyKSB7XG4gICAgICAgIGlmIChjb25maWdUYXJnZXQgPT09IHZzY29kZV8xLkNvbmZpZ3VyYXRpb25UYXJnZXQuV29ya3NwYWNlKSB7XG4gICAgICAgICAgICB0aGlzLmVuZ2luZS5saW50T3BlblB5dGhvbkZpbGVzKCkuaWdub3JlRXJyb3JzKCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgLy8gTG9vayBmb3IgcHl0aG9uIGZpbGVzIHRoYXQgYmVsb25nIHRvIHRoZSBzcGVjaWZpZWQgd29ya3NwYWNlIGZvbGRlci5cbiAgICAgICAgdnNjb2RlXzEud29ya3NwYWNlLnRleHREb2N1bWVudHMuZm9yRWFjaCgoZG9jdW1lbnQpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IHdrc3BhY2VGb2xkZXIgPSB2c2NvZGVfMS53b3Jrc3BhY2UuZ2V0V29ya3NwYWNlRm9sZGVyKGRvY3VtZW50LnVyaSk7XG4gICAgICAgICAgICBpZiAod2tzcGFjZUZvbGRlciAmJiB3a3NwYWNlRm9sZGVyLnVyaS5mc1BhdGggPT09IHdrc3BhY2VPckZvbGRlci5mc1BhdGgpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmVuZ2luZS5saW50RG9jdW1lbnQoZG9jdW1lbnQsICdhdXRvJykuaWdub3JlRXJyb3JzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pKTtcbiAgICB9XG4gICAgb25Eb2N1bWVudE9wZW5lZChkb2N1bWVudCkge1xuICAgICAgICB0aGlzLmVuZ2luZS5saW50RG9jdW1lbnQoZG9jdW1lbnQsICdhdXRvJykuaWdub3JlRXJyb3JzKCk7XG4gICAgfVxuICAgIG9uRG9jdW1lbnRTYXZlZChkb2N1bWVudCkge1xuICAgICAgICBjb25zdCBzZXR0aW5ncyA9IHRoaXMuY29uZmlndXJhdGlvbi5nZXRTZXR0aW5ncyhkb2N1bWVudC51cmkpO1xuICAgICAgICBpZiAoZG9jdW1lbnQubGFuZ3VhZ2VJZCA9PT0gJ3B5dGhvbicgJiYgc2V0dGluZ3MubGludGluZy5lbmFibGVkICYmIHNldHRpbmdzLmxpbnRpbmcubGludE9uU2F2ZSkge1xuICAgICAgICAgICAgdGhpcy5lbmdpbmUubGludERvY3VtZW50KGRvY3VtZW50LCAnc2F2ZScpLmlnbm9yZUVycm9ycygpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubGludGVyTWFuYWdlci5nZXRBY3RpdmVMaW50ZXJzKGZhbHNlLCBkb2N1bWVudC51cmkpXG4gICAgICAgICAgICAudGhlbigobGludGVycykgPT4ge1xuICAgICAgICAgICAgY29uc3QgZmlsZU5hbWUgPSBwYXRoLmJhc2VuYW1lKGRvY3VtZW50LnVyaS5mc1BhdGgpLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICBjb25zdCB3YXRjaGVycyA9IGxpbnRlcnMuZmlsdGVyKChpbmZvKSA9PiBpbmZvLmNvbmZpZ0ZpbGVOYW1lcy5pbmRleE9mKGZpbGVOYW1lKSA+PSAwKTtcbiAgICAgICAgICAgIGlmICh3YXRjaGVycy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLmVuZ2luZS5saW50T3BlblB5dGhvbkZpbGVzKCksIDEwMDApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KS5pZ25vcmVFcnJvcnMoKTtcbiAgICB9XG4gICAgb25Eb2N1bWVudENsb3NlZChkb2N1bWVudCkge1xuICAgICAgICBpZiAoIWRvY3VtZW50IHx8ICFkb2N1bWVudC5maWxlTmFtZSB8fCAhZG9jdW1lbnQudXJpKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgLy8gQ2hlY2sgaWYgdGhpcyBkb2N1bWVudCBpcyBzdGlsbCBvcGVuIGFzIGEgZHVwbGljYXRlIGVkaXRvci5cbiAgICAgICAgaWYgKCF0aGlzLmlzRG9jdW1lbnRPcGVuKGRvY3VtZW50LnVyaSkpIHtcbiAgICAgICAgICAgIHRoaXMuZW5naW5lLmNsZWFyRGlhZ25vc3RpY3MoZG9jdW1lbnQpO1xuICAgICAgICB9XG4gICAgfVxufVxuZXhwb3J0cy5MaW50ZXJQcm92aWRlciA9IExpbnRlclByb3ZpZGVyO1xuLy8jIHNvdXJjZU1hcHBpbmdVUkw9bGludGVyUHJvdmlkZXIuanMubWFwIl19