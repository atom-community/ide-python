// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const os_1 = require("os");

const vscode = require("vscode");

const restTextConverter_1 = require("../common/markdown/restTextConverter");

const proxy = require("./jediProxy");

class LanguageItemInfo {
  constructor(tooltip, detail, signature) {
    this.tooltip = tooltip;
    this.detail = detail;
    this.signature = signature;
  }

}

exports.LanguageItemInfo = LanguageItemInfo;

class ItemInfoSource {
  constructor(jediFactory) {
    this.jediFactory = jediFactory;
    this.textConverter = new restTextConverter_1.RestTextConverter();
  }

  getItemInfoFromText(documentUri, fileName, range, sourceText, token) {
    return __awaiter(this, void 0, void 0, function* () {
      const result = yield this.getHoverResultFromTextRange(documentUri, fileName, range, sourceText, token);

      if (!result || !result.items.length) {
        return;
      }

      return this.getItemInfoFromHoverResult(result, '');
    });
  }

  getItemInfoFromDocument(document, position, token) {
    return __awaiter(this, void 0, void 0, function* () {
      const range = document.getWordRangeAtPosition(position);

      if (!range || range.isEmpty) {
        return;
      }

      const result = yield this.getHoverResultFromDocument(document, position, token);

      if (!result || !result.items.length) {
        return;
      }

      const word = document.getText(range);
      return this.getItemInfoFromHoverResult(result, word);
    });
  }

  getHoverResultFromDocument(document, position, token) {
    return __awaiter(this, void 0, void 0, function* () {
      if (position.character <= 0 || document.lineAt(position.line).text.match(/^\s*\/\//)) {
        return;
      }

      const range = document.getWordRangeAtPosition(position);

      if (!range || range.isEmpty) {
        return;
      }

      return this.getHoverResultFromDocumentRange(document, range, token);
    });
  }

  getHoverResultFromDocumentRange(document, range, token) {
    return __awaiter(this, void 0, void 0, function* () {
      const cmd = {
        command: proxy.CommandType.Hover,
        fileName: document.fileName,
        columnIndex: range.end.character,
        lineIndex: range.end.line
      };

      if (document.isDirty) {
        cmd.source = document.getText();
      }

      return this.jediFactory.getJediProxyHandler(document.uri).sendCommand(cmd, token);
    });
  }

  getHoverResultFromTextRange(documentUri, fileName, range, sourceText, token) {
    return __awaiter(this, void 0, void 0, function* () {
      const cmd = {
        command: proxy.CommandType.Hover,
        fileName: fileName,
        columnIndex: range.end.character,
        lineIndex: range.end.line,
        source: sourceText
      };
      return this.jediFactory.getJediProxyHandler(documentUri).sendCommand(cmd, token);
    });
  }

  getItemInfoFromHoverResult(data, currentWord) {
    const infos = [];
    data.items.forEach(item => {
      const signature = this.getSignature(item, currentWord);
      let tooltip = new vscode.MarkdownString();

      if (item.docstring) {
        let lines = item.docstring.split(/\r?\n/); // If the docstring starts with the signature, then remove those lines from the docstring.

        if (lines.length > 0 && item.signature.indexOf(lines[0]) === 0) {
          lines.shift();
          const endIndex = lines.findIndex(line => item.signature.endsWith(line));

          if (endIndex >= 0) {
            lines = lines.filter((line, index) => index > endIndex);
          }
        }

        if (lines.length > 0 && currentWord.length > 0 && item.signature.startsWith(currentWord) && lines[0].startsWith(currentWord) && lines[0].endsWith(')')) {
          lines.shift();
        }

        if (signature.length > 0) {
          tooltip = tooltip.appendMarkdown(['```python', signature, '```', ''].join(os_1.EOL));
        }

        const description = this.textConverter.toMarkdown(lines.join(os_1.EOL));
        tooltip = tooltip.appendMarkdown(description);
        infos.push(new LanguageItemInfo(tooltip, item.description, new vscode.MarkdownString(signature)));
        return;
      }

      if (item.description) {
        if (signature.length > 0) {
          tooltip.appendMarkdown(['```python', signature, '```', ''].join(os_1.EOL));
        }

        const description = this.textConverter.toMarkdown(item.description);
        tooltip.appendMarkdown(description);
        infos.push(new LanguageItemInfo(tooltip, item.description, new vscode.MarkdownString(signature)));
        return;
      }

      if (item.text) {
        // Most probably variable type
        const code = currentWord && currentWord.length > 0 ? `${currentWord}: ${item.text}` : item.text;
        tooltip.appendMarkdown(['```python', code, '```', ''].join(os_1.EOL));
        infos.push(new LanguageItemInfo(tooltip, '', new vscode.MarkdownString()));
      }
    });
    return infos;
  }

  getSignature(item, currentWord) {
    let {
      signature
    } = item;

    switch (item.kind) {
      case vscode.SymbolKind.Constructor:
      case vscode.SymbolKind.Function:
      case vscode.SymbolKind.Method:
        {
          signature = `def ${signature}`;
          break;
        }

      case vscode.SymbolKind.Class:
        {
          signature = `class ${signature}`;
          break;
        }

      case vscode.SymbolKind.Module:
        {
          if (signature.length > 0) {
            signature = `module ${signature}`;
          }

          break;
        }

      default:
        {
          signature = typeof item.text === 'string' && item.text.length > 0 ? item.text : currentWord;
        }
    }

    return signature;
  }

}

exports.ItemInfoSource = ItemInfoSource;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIml0ZW1JbmZvU291cmNlLmpzIl0sIm5hbWVzIjpbIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJvc18xIiwicmVxdWlyZSIsInZzY29kZSIsInJlc3RUZXh0Q29udmVydGVyXzEiLCJwcm94eSIsIkxhbmd1YWdlSXRlbUluZm8iLCJjb25zdHJ1Y3RvciIsInRvb2x0aXAiLCJkZXRhaWwiLCJzaWduYXR1cmUiLCJJdGVtSW5mb1NvdXJjZSIsImplZGlGYWN0b3J5IiwidGV4dENvbnZlcnRlciIsIlJlc3RUZXh0Q29udmVydGVyIiwiZ2V0SXRlbUluZm9Gcm9tVGV4dCIsImRvY3VtZW50VXJpIiwiZmlsZU5hbWUiLCJyYW5nZSIsInNvdXJjZVRleHQiLCJ0b2tlbiIsImdldEhvdmVyUmVzdWx0RnJvbVRleHRSYW5nZSIsIml0ZW1zIiwibGVuZ3RoIiwiZ2V0SXRlbUluZm9Gcm9tSG92ZXJSZXN1bHQiLCJnZXRJdGVtSW5mb0Zyb21Eb2N1bWVudCIsImRvY3VtZW50IiwicG9zaXRpb24iLCJnZXRXb3JkUmFuZ2VBdFBvc2l0aW9uIiwiaXNFbXB0eSIsImdldEhvdmVyUmVzdWx0RnJvbURvY3VtZW50Iiwid29yZCIsImdldFRleHQiLCJjaGFyYWN0ZXIiLCJsaW5lQXQiLCJsaW5lIiwidGV4dCIsIm1hdGNoIiwiZ2V0SG92ZXJSZXN1bHRGcm9tRG9jdW1lbnRSYW5nZSIsImNtZCIsImNvbW1hbmQiLCJDb21tYW5kVHlwZSIsIkhvdmVyIiwiY29sdW1uSW5kZXgiLCJlbmQiLCJsaW5lSW5kZXgiLCJpc0RpcnR5Iiwic291cmNlIiwiZ2V0SmVkaVByb3h5SGFuZGxlciIsInVyaSIsInNlbmRDb21tYW5kIiwiZGF0YSIsImN1cnJlbnRXb3JkIiwiaW5mb3MiLCJmb3JFYWNoIiwiaXRlbSIsImdldFNpZ25hdHVyZSIsIk1hcmtkb3duU3RyaW5nIiwiZG9jc3RyaW5nIiwibGluZXMiLCJzcGxpdCIsImluZGV4T2YiLCJzaGlmdCIsImVuZEluZGV4IiwiZmluZEluZGV4IiwiZW5kc1dpdGgiLCJmaWx0ZXIiLCJpbmRleCIsInN0YXJ0c1dpdGgiLCJhcHBlbmRNYXJrZG93biIsImpvaW4iLCJFT0wiLCJkZXNjcmlwdGlvbiIsInRvTWFya2Rvd24iLCJwdXNoIiwiY29kZSIsImtpbmQiLCJTeW1ib2xLaW5kIiwiQ29uc3RydWN0b3IiLCJGdW5jdGlvbiIsIk1ldGhvZCIsIkNsYXNzIiwiTW9kdWxlIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FBL0IsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3JGLFNBQU8sS0FBS0QsQ0FBQyxLQUFLQSxDQUFDLEdBQUdFLE9BQVQsQ0FBTixFQUF5QixVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUN2RCxhQUFTQyxTQUFULENBQW1CQyxLQUFuQixFQUEwQjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUNPLElBQVYsQ0FBZUYsS0FBZixDQUFELENBQUo7QUFBOEIsT0FBcEMsQ0FBcUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDM0YsYUFBU0MsUUFBVCxDQUFrQkosS0FBbEIsRUFBeUI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDLE9BQUQsQ0FBVCxDQUFtQkssS0FBbkIsQ0FBRCxDQUFKO0FBQWtDLE9BQXhDLENBQXlDLE9BQU9HLENBQVAsRUFBVTtB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QWtCQyxXQUF2QjtBQUNBLFdBQUszRSxNQUFNLENBQUMwRSxVQUFQLENBQWtCRSxRQUF2QjtBQUNBLFdBQUs1RSxNQUFNLENBQUMwRSxVQUFQLENBQWtCRyxNQUF2QjtBQUErQjtBQUMzQnRFLFVBQUFBLFNBQVMsR0FBSSxPQUFNQSxTQUFVLEVBQTdCO0FBQ0E7QUFDSDs7QUFDRCxXQUFLUCxNQUFNLENBQUMwRSxVQUFQLENBQWtCSSxLQUF2QjtBQUE4QjtBQUMxQnZFLFVBQUFBLFNBQVMsR0FBSSxTQUFRQSxTQUFVLEVBQS9CO0FBQ0E7QUFDSDs7QUFDRCxXQUFLUCxNQUFNLENBQUMwRSxVQUFQLENBQWtCSyxNQUF2QjtBQUErQjtBQUMzQixjQUFJeEUsU0FBUyxDQUFDYSxNQUFWLEdBQW1CLENBQXZCLEVBQTBCO0FBQ3RCYixZQUFBQSxTQUFTLEdBQUksVUFBU0EsU0FBVSxFQUFoQztBQUNIOztBQUNEO0FBQ0g7O0FBQ0Q7QUFBUztBQUNMQSxVQUFBQSxTQUFTLEdBQUcsT0FBTzZDLElBQUksQ0FBQ25CLElBQVosS0FBcUIsUUFBckIsSUFBaUNtQixJQUFJLENBQUNuQixJQUFMLENBQVViLE1BQVYsR0FBbUIsQ0FBcEQsR0FBd0RnQyxJQUFJLENBQUNuQixJQUE3RCxHQUFvRWdCLFdBQWhGO0FBQ0g7QUFuQkw7O0FBcUJBLFdBQU8xQyxTQUFQO0FBQ0g7O0FBdklnQjs7QUF5SXJCVixPQUFPLENBQUNXLGNBQVIsR0FBeUJBLGNBQXpCIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXG4ndXNlIHN0cmljdCc7XG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xuICAgIH0pO1xufTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbmNvbnN0IG9zXzEgPSByZXF1aXJlKFwib3NcIik7XG5jb25zdCB2c2NvZGUgPSByZXF1aXJlKFwidnNjb2RlXCIpO1xuY29uc3QgcmVzdFRleHRDb252ZXJ0ZXJfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vbWFya2Rvd24vcmVzdFRleHRDb252ZXJ0ZXJcIik7XG5jb25zdCBwcm94eSA9IHJlcXVpcmUoXCIuL2plZGlQcm94eVwiKTtcbmNsYXNzIExhbmd1YWdlSXRlbUluZm8ge1xuICAgIGNvbnN0cnVjdG9yKHRvb2x0aXAsIGRldGFpbCwgc2lnbmF0dXJlKSB7XG4gICAgICAgIHRoaXMudG9vbHRpcCA9IHRvb2x0aXA7XG4gICAgICAgIHRoaXMuZGV0YWlsID0gZGV0YWlsO1xuICAgICAgICB0aGlzLnNpZ25hdHVyZSA9IHNpZ25hdHVyZTtcbiAgICB9XG59XG5leHBvcnRzLkxhbmd1YWdlSXRlbUluZm8gPSBMYW5ndWFnZUl0ZW1JbmZvO1xuY2xhc3MgSXRlbUluZm9Tb3VyY2Uge1xuICAgIGNvbnN0cnVjdG9yKGplZGlGYWN0b3J5KSB7XG4gICAgICAgIHRoaXMuamVkaUZhY3RvcnkgPSBqZWRpRmFjdG9yeTtcbiAgICAgICAgdGhpcy50ZXh0Q29udmVydGVyID0gbmV3IHJlc3RUZXh0Q29udmVydGVyXzEuUmVzdFRleHRDb252ZXJ0ZXIoKTtcbiAgICB9XG4gICAgZ2V0SXRlbUluZm9Gcm9tVGV4dChkb2N1bWVudFVyaSwgZmlsZU5hbWUsIHJhbmdlLCBzb3VyY2VUZXh0LCB0b2tlbikge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0geWllbGQgdGhpcy5nZXRIb3ZlclJlc3VsdEZyb21UZXh0UmFuZ2UoZG9jdW1lbnRVcmksIGZpbGVOYW1lLCByYW5nZSwgc291cmNlVGV4dCwgdG9rZW4pO1xuICAgICAgICAgICAgaWYgKCFyZXN1bHQgfHwgIXJlc3VsdC5pdGVtcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRJdGVtSW5mb0Zyb21Ib3ZlclJlc3VsdChyZXN1bHQsICcnKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGdldEl0ZW1JbmZvRnJvbURvY3VtZW50KGRvY3VtZW50LCBwb3NpdGlvbiwgdG9rZW4pIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IHJhbmdlID0gZG9jdW1lbnQuZ2V0V29yZFJhbmdlQXRQb3NpdGlvbihwb3NpdGlvbik7XG4gICAgICAgICAgICBpZiAoIXJhbmdlIHx8IHJhbmdlLmlzRW1wdHkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSB5aWVsZCB0aGlzLmdldEhvdmVyUmVzdWx0RnJvbURvY3VtZW50KGRvY3VtZW50LCBwb3NpdGlvbiwgdG9rZW4pO1xuICAgICAgICAgICAgaWYgKCFyZXN1bHQgfHwgIXJlc3VsdC5pdGVtcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCB3b3JkID0gZG9jdW1lbnQuZ2V0VGV4dChyYW5nZSk7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRJdGVtSW5mb0Zyb21Ib3ZlclJlc3VsdChyZXN1bHQsIHdvcmQpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgZ2V0SG92ZXJSZXN1bHRGcm9tRG9jdW1lbnQoZG9jdW1lbnQsIHBvc2l0aW9uLCB0b2tlbikge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgaWYgKHBvc2l0aW9uLmNoYXJhY3RlciA8PSAwIHx8IGRvY3VtZW50LmxpbmVBdChwb3NpdGlvbi5saW5lKS50ZXh0Lm1hdGNoKC9eXFxzKlxcL1xcLy8pKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgcmFuZ2UgPSBkb2N1bWVudC5nZXRXb3JkUmFuZ2VBdFBvc2l0aW9uKHBvc2l0aW9uKTtcbiAgICAgICAgICAgIGlmICghcmFuZ2UgfHwgcmFuZ2UuaXNFbXB0eSkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldEhvdmVyUmVzdWx0RnJvbURvY3VtZW50UmFuZ2UoZG9jdW1lbnQsIHJhbmdlLCB0b2tlbik7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBnZXRIb3ZlclJlc3VsdEZyb21Eb2N1bWVudFJhbmdlKGRvY3VtZW50LCByYW5nZSwgdG9rZW4pIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IGNtZCA9IHtcbiAgICAgICAgICAgICAgICBjb21tYW5kOiBwcm94eS5Db21tYW5kVHlwZS5Ib3ZlcixcbiAgICAgICAgICAgICAgICBmaWxlTmFtZTogZG9jdW1lbnQuZmlsZU5hbWUsXG4gICAgICAgICAgICAgICAgY29sdW1uSW5kZXg6IHJhbmdlLmVuZC5jaGFyYWN0ZXIsXG4gICAgICAgICAgICAgICAgbGluZUluZGV4OiByYW5nZS5lbmQubGluZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGlmIChkb2N1bWVudC5pc0RpcnR5KSB7XG4gICAgICAgICAgICAgICAgY21kLnNvdXJjZSA9IGRvY3VtZW50LmdldFRleHQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0aGlzLmplZGlGYWN0b3J5LmdldEplZGlQcm94eUhhbmRsZXIoZG9jdW1lbnQudXJpKS5zZW5kQ29tbWFuZChjbWQsIHRva2VuKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGdldEhvdmVyUmVzdWx0RnJvbVRleHRSYW5nZShkb2N1bWVudFVyaSwgZmlsZU5hbWUsIHJhbmdlLCBzb3VyY2VUZXh0LCB0b2tlbikge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgY21kID0ge1xuICAgICAgICAgICAgICAgIGNvbW1hbmQ6IHByb3h5LkNvbW1hbmRUeXBlLkhvdmVyLFxuICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBmaWxlTmFtZSxcbiAgICAgICAgICAgICAgICBjb2x1bW5JbmRleDogcmFuZ2UuZW5kLmNoYXJhY3RlcixcbiAgICAgICAgICAgICAgICBsaW5lSW5kZXg6IHJhbmdlLmVuZC5saW5lLFxuICAgICAgICAgICAgICAgIHNvdXJjZTogc291cmNlVGV4dFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmplZGlGYWN0b3J5LmdldEplZGlQcm94eUhhbmRsZXIoZG9jdW1lbnRVcmkpLnNlbmRDb21tYW5kKGNtZCwgdG9rZW4pO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgZ2V0SXRlbUluZm9Gcm9tSG92ZXJSZXN1bHQoZGF0YSwgY3VycmVudFdvcmQpIHtcbiAgICAgICAgY29uc3QgaW5mb3MgPSBbXTtcbiAgICAgICAgZGF0YS5pdGVtcy5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgICAgICAgY29uc3Qgc2lnbmF0dXJlID0gdGhpcy5nZXRTaWduYXR1cmUoaXRlbSwgY3VycmVudFdvcmQpO1xuICAgICAgICAgICAgbGV0IHRvb2x0aXAgPSBuZXcgdnNjb2RlLk1hcmtkb3duU3RyaW5nKCk7XG4gICAgICAgICAgICBpZiAoaXRlbS5kb2NzdHJpbmcpIHtcbiAgICAgICAgICAgICAgICBsZXQgbGluZXMgPSBpdGVtLmRvY3N0cmluZy5zcGxpdCgvXFxyP1xcbi8pO1xuICAgICAgICAgICAgICAgIC8vIElmIHRoZSBkb2NzdHJpbmcgc3RhcnRzIHdpdGggdGhlIHNpZ25hdHVyZSwgdGhlbiByZW1vdmUgdGhvc2UgbGluZXMgZnJvbSB0aGUgZG9jc3RyaW5nLlxuICAgICAgICAgICAgICAgIGlmIChsaW5lcy5sZW5ndGggPiAwICYmIGl0ZW0uc2lnbmF0dXJlLmluZGV4T2YobGluZXNbMF0pID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGxpbmVzLnNoaWZ0KCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVuZEluZGV4ID0gbGluZXMuZmluZEluZGV4KGxpbmUgPT4gaXRlbS5zaWduYXR1cmUuZW5kc1dpdGgobGluZSkpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZW5kSW5kZXggPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGluZXMgPSBsaW5lcy5maWx0ZXIoKGxpbmUsIGluZGV4KSA9PiBpbmRleCA+IGVuZEluZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAobGluZXMubGVuZ3RoID4gMCAmJiBjdXJyZW50V29yZC5sZW5ndGggPiAwICYmIGl0ZW0uc2lnbmF0dXJlLnN0YXJ0c1dpdGgoY3VycmVudFdvcmQpICYmIGxpbmVzWzBdLnN0YXJ0c1dpdGgoY3VycmVudFdvcmQpICYmIGxpbmVzWzBdLmVuZHNXaXRoKCcpJykpIHtcbiAgICAgICAgICAgICAgICAgICAgbGluZXMuc2hpZnQoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHNpZ25hdHVyZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRvb2x0aXAgPSB0b29sdGlwLmFwcGVuZE1hcmtkb3duKFsnYGBgcHl0aG9uJywgc2lnbmF0dXJlLCAnYGBgJywgJyddLmpvaW4ob3NfMS5FT0wpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc3QgZGVzY3JpcHRpb24gPSB0aGlzLnRleHRDb252ZXJ0ZXIudG9NYXJrZG93bihsaW5lcy5qb2luKG9zXzEuRU9MKSk7XG4gICAgICAgICAgICAgICAgdG9vbHRpcCA9IHRvb2x0aXAuYXBwZW5kTWFya2Rvd24oZGVzY3JpcHRpb24pO1xuICAgICAgICAgICAgICAgIGluZm9zLnB1c2gobmV3IExhbmd1YWdlSXRlbUluZm8odG9vbHRpcCwgaXRlbS5kZXNjcmlwdGlvbiwgbmV3IHZzY29kZS5NYXJrZG93blN0cmluZyhzaWduYXR1cmUpKSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGl0ZW0uZGVzY3JpcHRpb24pIHtcbiAgICAgICAgICAgICAgICBpZiAoc2lnbmF0dXJlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdG9vbHRpcC5hcHBlbmRNYXJrZG93bihbJ2BgYHB5dGhvbicsIHNpZ25hdHVyZSwgJ2BgYCcsICcnXS5qb2luKG9zXzEuRU9MKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbnN0IGRlc2NyaXB0aW9uID0gdGhpcy50ZXh0Q29udmVydGVyLnRvTWFya2Rvd24oaXRlbS5kZXNjcmlwdGlvbik7XG4gICAgICAgICAgICAgICAgdG9vbHRpcC5hcHBlbmRNYXJrZG93bihkZXNjcmlwdGlvbik7XG4gICAgICAgICAgICAgICAgaW5mb3MucHVzaChuZXcgTGFuZ3VhZ2VJdGVtSW5mbyh0b29sdGlwLCBpdGVtLmRlc2NyaXB0aW9uLCBuZXcgdnNjb2RlLk1hcmtkb3duU3RyaW5nKHNpZ25hdHVyZSkpKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaXRlbS50ZXh0KSB7IC8vIE1vc3QgcHJvYmFibHkgdmFyaWFibGUgdHlwZVxuICAgICAgICAgICAgICAgIGNvbnN0IGNvZGUgPSBjdXJyZW50V29yZCAmJiBjdXJyZW50V29yZC5sZW5ndGggPiAwXG4gICAgICAgICAgICAgICAgICAgID8gYCR7Y3VycmVudFdvcmR9OiAke2l0ZW0udGV4dH1gXG4gICAgICAgICAgICAgICAgICAgIDogaXRlbS50ZXh0O1xuICAgICAgICAgICAgICAgIHRvb2x0aXAuYXBwZW5kTWFya2Rvd24oWydgYGBweXRob24nLCBjb2RlLCAnYGBgJywgJyddLmpvaW4ob3NfMS5FT0wpKTtcbiAgICAgICAgICAgICAgICBpbmZvcy5wdXNoKG5ldyBMYW5ndWFnZUl0ZW1JbmZvKHRvb2x0aXAsICcnLCBuZXcgdnNjb2RlLk1hcmtkb3duU3RyaW5nKCkpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBpbmZvcztcbiAgICB9XG4gICAgZ2V0U2lnbmF0dXJlKGl0ZW0sIGN1cnJlbnRXb3JkKSB7XG4gICAgICAgIGxldCB7IHNpZ25hdHVyZSB9ID0gaXRlbTtcbiAgICAgICAgc3dpdGNoIChpdGVtLmtpbmQpIHtcbiAgICAgICAgICAgIGNhc2UgdnNjb2RlLlN5bWJvbEtpbmQuQ29uc3RydWN0b3I6XG4gICAgICAgICAgICBjYXNlIHZzY29kZS5TeW1ib2xLaW5kLkZ1bmN0aW9uOlxuICAgICAgICAgICAgY2FzZSB2c2NvZGUuU3ltYm9sS2luZC5NZXRob2Q6IHtcbiAgICAgICAgICAgICAgICBzaWduYXR1cmUgPSBgZGVmICR7c2lnbmF0dXJlfWA7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXNlIHZzY29kZS5TeW1ib2xLaW5kLkNsYXNzOiB7XG4gICAgICAgICAgICAgICAgc2lnbmF0dXJlID0gYGNsYXNzICR7c2lnbmF0dXJlfWA7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXNlIHZzY29kZS5TeW1ib2xLaW5kLk1vZHVsZToge1xuICAgICAgICAgICAgICAgIGlmIChzaWduYXR1cmUubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBzaWduYXR1cmUgPSBgbW9kdWxlICR7c2lnbmF0dXJlfWA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZGVmYXVsdDoge1xuICAgICAgICAgICAgICAgIHNpZ25hdHVyZSA9IHR5cGVvZiBpdGVtLnRleHQgPT09ICdzdHJpbmcnICYmIGl0ZW0udGV4dC5sZW5ndGggPiAwID8gaXRlbS50ZXh0IDogY3VycmVudFdvcmQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHNpZ25hdHVyZTtcbiAgICB9XG59XG5leHBvcnRzLkl0ZW1JbmZvU291cmNlID0gSXRlbUluZm9Tb3VyY2U7XG4vLyMgc291cmNlTWFwcGluZ1VSTD1pdGVtSW5mb1NvdXJjZS5qcy5tYXAiXX0=