'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const os_1 = require("os");

const vscode_1 = require("vscode");

const telemetry_1 = require("../telemetry");

const constants_1 = require("../telemetry/constants");

const proxy = require("./jediProxy");

const providerUtilities_1 = require("./providerUtilities");

const DOCSTRING_PARAM_PATTERNS = ['\\s*:type\\s*PARAMNAME:\\s*([^\\n, ]+)', '\\s*:param\\s*(\\w?)\\s*PARAMNAME:[^\\n]+', '\\s*@type\\s*PARAMNAME:\\s*([^\\n, ]+)' // Epydoc
];
/**
 * Extract the documentation for parameters from a given docstring.
 * @param {string} paramName Name of the parameter
 * @param {string} docString The docstring for the function
 * @returns {string} Docstring for the parameter
 */

function extractParamDocString(paramName, docString) {
  let paramDocString = ''; // In docstring the '*' is escaped with a backslash

  paramName = paramName.replace(new RegExp('\\*', 'g'), '\\\\\\*');
  DOCSTRING_PARAM_PATTERNS.forEach(pattern => {
    if (paramDocString.length > 0) {
      return;
    }

    pattern = pattern.replace('PARAMNAME', paramName);
    const regExp = new RegExp(pattern);
    const matches = regExp.exec(docString);

    if (matches && matches.length > 0) {
      paramDocString = matches[0];

      if (paramDocString.indexOf(':') >= 0) {
        paramDocString = paramDocString.substring(paramDocString.indexOf(':') + 1);
      }

      if (paramDocString.indexOf(':') >= 0) {
        paramDocString = paramDocString.substring(paramDocString.indexOf(':') + 1);
      }
    }
  });
  return paramDocString.trim();
}

class PythonSignatureProvider {
  constructor(jediFactory) {
    this.jediFactory = jediFactory;
  }

  static parseData(data) {
    if (data && Array.isArray(data.definitions) && data.definitions.length > 0) {
      const signature = new vscode_1.SignatureHelp();
      signature.activeSignature = 0;
      data.definitions.forEach(def => {
        signature.activeParameter = def.paramindex; // Don't display the documentation, as vs code doesn't format the documentation.
        // i.e. line feeds are not respected, long content is stripped.
        // Some functions do not come with parameter docs

        let label;
        let documentation;
        const validParamInfo = def.params && def.params.length > 0 && def.docstring && def.docstring.startsWith(`${def.name}(`);

        if (validParamInfo) {
          const docLines = def.docstring.splitLines();
          label = docLines.shift().trim();
          documentation = docLines.join(os_1.EOL).trim();
        } else {
          if (def.params && def.params.length > 0) {
            label = `${def.name}(${def.params.map(p => p.name).join(', ')})`;
            documentation = def.docstring;
          } else {
            label = def.description;
            documentation = def.docstring;
          }
        } // tslint:disable-next-line:no-object-literal-type-assertion


        const sig = {
          label,
          documentation,
          parameters: []
        };

        if (def.params && def.params.length) {
          sig.parameters = def.params.map(arg => {
            if (arg.docstring.length === 0) {
              arg.docstring = extractParamDocString(arg.name, def.docstring);
            } // tslint:disable-next-line:no-object-literal-type-assertion


            return {
              documentation: arg.docstring.length > 0 ? arg.docstring : arg.description,
              label: arg.name.trim()
            };
          });
        }

        signature.signatures.push(sig);
      });
      return signature;
    }

    return new vscode_1.SignatureHelp();
  }

  provideSignatureHelp(document, position, token) {
    // early exit if we're in a string or comment (or in an undefined position)
    if (position.character <= 0 || providerUtilities_1.isPositionInsideStringOrComment(document, position)) {
      return Promise.resolve(new vscode_1.SignatureHelp());
    }

    const cmd = {
      command: proxy.CommandType.Arguments,
      fileName: document.fileName,
      columnIndex: position.character,
      lineIndex: position.line,
      source: document.getText()
    };
    return this.jediFactory.getJediProxyHandler(document.uri).sendCommand(cmd, token).then(data => {
      return data ? PythonSignatureProvider.parseData(data) : new vscode_1.SignatureHelp();
    });
  }

}

__decorate([telemetry_1.captureTelemetry(constants_1.SIGNATURE)], PythonSignatureProvider.prototype, "provideSignatureHelp", null);

exports.PythonSignatureProvider = PythonSignatureProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNpZ25hdHVyZVByb3ZpZGVyLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsIm9zXzEiLCJyZXF1aXJlIiwidnNjb2RlXzEiLCJ0ZWxlbWV0cnlfMSIsImNvbnN0YW50c18xIiwicHJveHkiLCJwcm92aWRlclV0aWxpdGllc18xIiwiRE9DU1RSSU5HX1BBUkFNX1BBVFRFUk5TIiwiZXh0cmFjdFBhcmFtRG9jU3RyaW5nIiwicGFyYW1OYW1lIiwiZG9jU3RyaW5nIiwicGFyYW1Eb2NTdHJpbmciLCJyZXBsYWNlIiwiUmVnRXhwIiwiZm9yRWFjaCIsInBhdHRlcm4iLCJyZWdFeHAiLCJtYXRjaGVzIiwiZXhlYyIsImluZGV4T2YiLCJzdWJzdHJpbmciLCJ0cmltIiwiUHl0aG9uU2lnbmF0dXJlUHJvdmlkZXIiLCJjb25zdHJ1Y3RvciIsImplZGlGYWN0b3J5IiwicGFyc2VEYXRhIiwiZGF0YSIsIkFycmF5IiwiaXNBcnJheSIsImRlZmluaXRpb25zIiwic2lnbmF0dXJlIiwiU2lnbmF0dXJlSGVscCIsImFjdGl2ZVNpZ25hdHVyZSIsImRlZiIsImFjdGl2ZVBhcmFtZXRlciIsInBhcmFtaW5kZXgiLCJsYWJlbCIsImRvY3VtZW50YXRpb24iLCJ2YWxpZFBhcmFtSW5mbyIsInBhcmFtcyIsImRvY3N0cmluZyIsInN0YXJ0c1dpdGgiLCJuYW1lIiwiZG9jTGluZXMiLCJzcGxpdExpbmVzIiwic2hpZnQiLCJqb2luIiwiRU9MIiwibWFwIiwicCIsImRlc2NyaXB0aW9uIiwic2lnIiwicGFyYW1ldGVycyIsImFyZyIsInNpZ25hdHVyZXMiLCJwdXNoIiwicHJvdmlkZVNpZ25hdHVyZUhlbHAiLCJkb2N1bWVudCIsInBvc2l0aW9uIiwidG9rZW4iLCJjaGFyYWN0ZXIiLCJpc1Bvc2l0aW9uSW5zaWRlU3RyaW5nT3JDb21tZW50IiwiUHJvbWlzZSIsInJlc29sdmUiLCJjbWQiLCJjb21tYW5kIiwiQ29tbWFuZFR5cGUiLCJBcmd1bWVudHMiLCJmaWxlTmFtZSIsImNvbHVtbkluZGV4IiwibGluZUluZGV4IiwibGluZSIsInNvdXJjZSIsImdldFRleHQiLCJnZXRKZWRpUHJveHlIYW5kbGVyIiwidXJpIiwic2VuZENvbW1hbmQiLCJ0aGVuIiwiY2FwdHVyZVRlbGVtZXRyeSIsIlNJR05BVFVSRSIsInByb3RvdHlwZSJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBQ0EsSUFBSUEsVUFBVSxHQUFJLFVBQVEsU0FBS0EsVUFBZCxJQUE2QixVQUFVQyxVQUFWLEVBQXNCQyxNQUF0QixFQUE4QkMsR0FBOUIsRUFBbUNDLElBQW5DLEVBQXlDO0FBQ25GLE1BQUlDLENBQUMsR0FBR0MsU0FBUyxDQUFDQyxNQUFsQjtBQUFBLE1BQTBCQyxDQUFDLEdBQUdILENBQUMsR0FBRyxDQUFKLEdBQVFILE1BQVIsR0FBaUJFLElBQUksS0FBSyxJQUFULEdBQWdCQSxJQUFJLEdBQUdLLE1BQU0sQ0FBQ0Msd0JBQVAsQ0FBZ0NSLE1BQWhDLEVBQXdDQyxHQUF4QyxDQUF2QixHQUFzRUMsSUFBckg7QUFBQSxNQUEySE8sQ0FBM0g7QUFDQSxNQUFJLE9BQU9DLE9BQVAsS0FBbUIsUUFBbkIsSUFBK0IsT0FBT0EsT0FBTyxDQUFDQyxRQUFmLEtBQTRCLFVBQS9ELEVBQTJFTCxDQUFDLEdBQUdJLE9BQU8sQ0FBQ0MsUUFBUixDQUFpQlosVUFBakIsRUFBNkJDLE1BQTdCLEVBQXFDQyxHQUFyQyxFQUEwQ0MsSUFBMUMsQ0FBSixDQUEzRSxLQUNLLEtBQUssSUFBSVUsQ0FBQyxHQUFHYixVQUFVLENBQUNNLE1BQVgsR0FBb0IsQ0FBakMsRUFBb0NPLENBQUMsSUFBSSxDQUF6QyxFQUE0Q0EsQ0FBQyxFQUE3QyxF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QUF4QixDQUFrQ0MsSUFBbEMsQ0FBSCxHQUE2QyxJQUFJeEIsUUFBUSxDQUFDNkIsYUFBYixFQUF4RDtBQUNILEtBRk0sQ0FBUDtBQUdIOztBQXZFeUI7O0FBeUU5QmpELFVBQVUsQ0FBQyxDQUNQcUIsV0FBVyxDQUFDMkUsZ0JBQVosQ0FBNkIxRSxXQUFXLENBQUMyRSxTQUF6QyxDQURPLENBQUQsRUFFUHpELHVCQUF1QixDQUFDMEQsU0FGakIsRUFFNEIsc0JBRjVCLEVBRW9ELElBRnBELENBQVY7O0FBR0FsRixPQUFPLENBQUN3Qix1QkFBUixHQUFrQ0EsdUJBQWxDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xudmFyIF9fZGVjb3JhdGUgPSAodGhpcyAmJiB0aGlzLl9fZGVjb3JhdGUpIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcbiAgICBlbHNlIGZvciAodmFyIGkgPSBkZWNvcmF0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBpZiAoZCA9IGRlY29yYXRvcnNbaV0pIHIgPSAoYyA8IDMgPyBkKHIpIDogYyA+IDMgPyBkKHRhcmdldCwga2V5LCByKSA6IGQodGFyZ2V0LCBrZXkpKSB8fCByO1xuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XG59O1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuY29uc3Qgb3NfMSA9IHJlcXVpcmUoXCJvc1wiKTtcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcbmNvbnN0IHRlbGVtZXRyeV8xID0gcmVxdWlyZShcIi4uL3RlbGVtZXRyeVwiKTtcbmNvbnN0IGNvbnN0YW50c18xID0gcmVxdWlyZShcIi4uL3RlbGVtZXRyeS9jb25zdGFudHNcIik7XG5jb25zdCBwcm94eSA9IHJlcXVpcmUoXCIuL2plZGlQcm94eVwiKTtcbmNvbnN0IHByb3ZpZGVyVXRpbGl0aWVzXzEgPSByZXF1aXJlKFwiLi9wcm92aWRlclV0aWxpdGllc1wiKTtcbmNvbnN0IERPQ1NUUklOR19QQVJBTV9QQVRURVJOUyA9IFtcbiAgICAnXFxcXHMqOnR5cGVcXFxccypQQVJBTU5BTUU6XFxcXHMqKFteXFxcXG4sIF0rKScsXG4gICAgJ1xcXFxzKjpwYXJhbVxcXFxzKihcXFxcdz8pXFxcXHMqUEFSQU1OQU1FOlteXFxcXG5dKycsXG4gICAgJ1xcXFxzKkB0eXBlXFxcXHMqUEFSQU1OQU1FOlxcXFxzKihbXlxcXFxuLCBdKyknIC8vIEVweWRvY1xuXTtcbi8qKlxuICogRXh0cmFjdCB0aGUgZG9jdW1lbnRhdGlvbiBmb3IgcGFyYW1ldGVycyBmcm9tIGEgZ2l2ZW4gZG9jc3RyaW5nLlxuICogQHBhcmFtIHtzdHJpbmd9IHBhcmFtTmFtZSBOYW1lIG9mIHRoZSBwYXJhbWV0ZXJcbiAqIEBwYXJhbSB7c3RyaW5nfSBkb2NTdHJpbmcgVGhlIGRvY3N0cmluZyBmb3IgdGhlIGZ1bmN0aW9uXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBEb2NzdHJpbmcgZm9yIHRoZSBwYXJhbWV0ZXJcbiAqL1xuZnVuY3Rpb24gZXh0cmFjdFBhcmFtRG9jU3RyaW5nKHBhcmFtTmFtZSwgZG9jU3RyaW5nKSB7XG4gICAgbGV0IHBhcmFtRG9jU3RyaW5nID0gJyc7XG4gICAgLy8gSW4gZG9jc3RyaW5nIHRoZSAnKicgaXMgZXNjYXBlZCB3aXRoIGEgYmFja3NsYXNoXG4gICAgcGFyYW1OYW1lID0gcGFyYW1OYW1lLnJlcGxhY2UobmV3IFJlZ0V4cCgnXFxcXConLCAnZycpLCAnXFxcXFxcXFxcXFxcKicpO1xuICAgIERPQ1NUUklOR19QQVJBTV9QQVRURVJOUy5mb3JFYWNoKHBhdHRlcm4gPT4ge1xuICAgICAgICBpZiAocGFyYW1Eb2NTdHJpbmcubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHBhdHRlcm4gPSBwYXR0ZXJuLnJlcGxhY2UoJ1BBUkFNTkFNRScsIHBhcmFtTmFtZSk7XG4gICAgICAgIGNvbnN0IHJlZ0V4cCA9IG5ldyBSZWdFeHAocGF0dGVybik7XG4gICAgICAgIGNvbnN0IG1hdGNoZXMgPSByZWdFeHAuZXhlYyhkb2NTdHJpbmcpO1xuICAgICAgICBpZiAobWF0Y2hlcyAmJiBtYXRjaGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHBhcmFtRG9jU3RyaW5nID0gbWF0Y2hlc1swXTtcbiAgICAgICAgICAgIGlmIChwYXJhbURvY1N0cmluZy5pbmRleE9mKCc6JykgPj0gMCkge1xuICAgICAgICAgICAgICAgIHBhcmFtRG9jU3RyaW5nID0gcGFyYW1Eb2NTdHJpbmcuc3Vic3RyaW5nKHBhcmFtRG9jU3RyaW5nLmluZGV4T2YoJzonKSArIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHBhcmFtRG9jU3RyaW5nLmluZGV4T2YoJzonKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgcGFyYW1Eb2NTdHJpbmcgPSBwYXJhbURvY1N0cmluZy5zdWJzdHJpbmcocGFyYW1Eb2NTdHJpbmcuaW5kZXhPZignOicpICsgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gcGFyYW1Eb2NTdHJpbmcudHJpbSgpO1xufVxuY2xhc3MgUHl0aG9uU2lnbmF0dXJlUHJvdmlkZXIge1xuICAgIGNvbnN0cnVjdG9yKGplZGlGYWN0b3J5KSB7XG4gICAgICAgIHRoaXMuamVkaUZhY3RvcnkgPSBqZWRpRmFjdG9yeTtcbiAgICB9XG4gICAgc3RhdGljIHBhcnNlRGF0YShkYXRhKSB7XG4gICAgICAgIGlmIChkYXRhICYmIEFycmF5LmlzQXJyYXkoZGF0YS5kZWZpbml0aW9ucykgJiYgZGF0YS5kZWZpbml0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb25zdCBzaWduYXR1cmUgPSBuZXcgdnNjb2RlXzEuU2lnbmF0dXJlSGVscCgpO1xuICAgICAgICAgICAgc2lnbmF0dXJlLmFjdGl2ZVNpZ25hdHVyZSA9IDA7XG4gICAgICAgICAgICBkYXRhLmRlZmluaXRpb25zLmZvckVhY2goZGVmID0+IHtcbiAgICAgICAgICAgICAgICBzaWduYXR1cmUuYWN0aXZlUGFyYW1ldGVyID0gZGVmLnBhcmFtaW5kZXg7XG4gICAgICAgICAgICAgICAgLy8gRG9uJ3QgZGlzcGxheSB0aGUgZG9jdW1lbnRhdGlvbiwgYXMgdnMgY29kZSBkb2Vzbid0IGZvcm1hdCB0aGUgZG9jdW1lbnRhdGlvbi5cbiAgICAgICAgICAgICAgICAvLyBpLmUuIGxpbmUgZmVlZHMgYXJlIG5vdCByZXNwZWN0ZWQsIGxvbmcgY29udGVudCBpcyBzdHJpcHBlZC5cbiAgICAgICAgICAgICAgICAvLyBTb21lIGZ1bmN0aW9ucyBkbyBub3QgY29tZSB3aXRoIHBhcmFtZXRlciBkb2NzXG4gICAgICAgICAgICAgICAgbGV0IGxhYmVsO1xuICAgICAgICAgICAgICAgIGxldCBkb2N1bWVudGF0aW9uO1xuICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkUGFyYW1JbmZvID0gZGVmLnBhcmFtcyAmJiBkZWYucGFyYW1zLmxlbmd0aCA+IDAgJiYgZGVmLmRvY3N0cmluZyAmJiBkZWYuZG9jc3RyaW5nLnN0YXJ0c1dpdGgoYCR7ZGVmLm5hbWV9KGApO1xuICAgICAgICAgICAgICAgIGlmICh2YWxpZFBhcmFtSW5mbykge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBkb2NMaW5lcyA9IGRlZi5kb2NzdHJpbmcuc3BsaXRMaW5lcygpO1xuICAgICAgICAgICAgICAgICAgICBsYWJlbCA9IGRvY0xpbmVzLnNoaWZ0KCkudHJpbSgpO1xuICAgICAgICAgICAgICAgICAgICBkb2N1bWVudGF0aW9uID0gZG9jTGluZXMuam9pbihvc18xLkVPTCkudHJpbSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRlZi5wYXJhbXMgJiYgZGVmLnBhcmFtcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsYWJlbCA9IGAke2RlZi5uYW1lfSgke2RlZi5wYXJhbXMubWFwKHAgPT4gcC5uYW1lKS5qb2luKCcsICcpfSlgO1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnRhdGlvbiA9IGRlZi5kb2NzdHJpbmc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsYWJlbCA9IGRlZi5kZXNjcmlwdGlvbjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50YXRpb24gPSBkZWYuZG9jc3RyaW5nO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1vYmplY3QtbGl0ZXJhbC10eXBlLWFzc2VydGlvblxuICAgICAgICAgICAgICAgIGNvbnN0IHNpZyA9IHtcbiAgICAgICAgICAgICAgICAgICAgbGFiZWwsXG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50YXRpb24sXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtZXRlcnM6IFtdXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBpZiAoZGVmLnBhcmFtcyAmJiBkZWYucGFyYW1zLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBzaWcucGFyYW1ldGVycyA9IGRlZi5wYXJhbXMubWFwKGFyZyA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXJnLmRvY3N0cmluZy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmcuZG9jc3RyaW5nID0gZXh0cmFjdFBhcmFtRG9jU3RyaW5nKGFyZy5uYW1lLCBkZWYuZG9jc3RyaW5nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1vYmplY3QtbGl0ZXJhbC10eXBlLWFzc2VydGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudGF0aW9uOiBhcmcuZG9jc3RyaW5nLmxlbmd0aCA+IDAgPyBhcmcuZG9jc3RyaW5nIDogYXJnLmRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiBhcmcubmFtZS50cmltKClcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzaWduYXR1cmUuc2lnbmF0dXJlcy5wdXNoKHNpZyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiBzaWduYXR1cmU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5ldyB2c2NvZGVfMS5TaWduYXR1cmVIZWxwKCk7XG4gICAgfVxuICAgIHByb3ZpZGVTaWduYXR1cmVIZWxwKGRvY3VtZW50LCBwb3NpdGlvbiwgdG9rZW4pIHtcbiAgICAgICAgLy8gZWFybHkgZXhpdCBpZiB3ZSdyZSBpbiBhIHN0cmluZyBvciBjb21tZW50IChvciBpbiBhbiB1bmRlZmluZWQgcG9zaXRpb24pXG4gICAgICAgIGlmIChwb3NpdGlvbi5jaGFyYWN0ZXIgPD0gMCB8fFxuICAgICAgICAgICAgcHJvdmlkZXJVdGlsaXRpZXNfMS5pc1Bvc2l0aW9uSW5zaWRlU3RyaW5nT3JDb21tZW50KGRvY3VtZW50LCBwb3NpdGlvbikpIHtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobmV3IHZzY29kZV8xLlNpZ25hdHVyZUhlbHAoKSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY21kID0ge1xuICAgICAgICAgICAgY29tbWFuZDogcHJveHkuQ29tbWFuZFR5cGUuQXJndW1lbnRzLFxuICAgICAgICAgICAgZmlsZU5hbWU6IGRvY3VtZW50LmZpbGVOYW1lLFxuICAgICAgICAgICAgY29sdW1uSW5kZXg6IHBvc2l0aW9uLmNoYXJhY3RlcixcbiAgICAgICAgICAgIGxpbmVJbmRleDogcG9zaXRpb24ubGluZSxcbiAgICAgICAgICAgIHNvdXJjZTogZG9jdW1lbnQuZ2V0VGV4dCgpXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiB0aGlzLmplZGlGYWN0b3J5LmdldEplZGlQcm94eUhhbmRsZXIoZG9jdW1lbnQudXJpKS5zZW5kQ29tbWFuZChjbWQsIHRva2VuKS50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGRhdGEgPyBQeXRob25TaWduYXR1cmVQcm92aWRlci5wYXJzZURhdGEoZGF0YSkgOiBuZXcgdnNjb2RlXzEuU2lnbmF0dXJlSGVscCgpO1xuICAgICAgICB9KTtcbiAgICB9XG59XG5fX2RlY29yYXRlKFtcbiAgICB0ZWxlbWV0cnlfMS5jYXB0dXJlVGVsZW1ldHJ5KGNvbnN0YW50c18xLlNJR05BVFVSRSlcbl0sIFB5dGhvblNpZ25hdHVyZVByb3ZpZGVyLnByb3RvdHlwZSwgXCJwcm92aWRlU2lnbmF0dXJlSGVscFwiLCBudWxsKTtcbmV4cG9ydHMuUHl0aG9uU2lnbmF0dXJlUHJvdmlkZXIgPSBQeXRob25TaWduYXR1cmVQcm92aWRlcjtcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPXNpZ25hdHVyZVByb3ZpZGVyLmpzLm1hcCJdfQ==