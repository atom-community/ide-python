"use strict";

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const vscode_1 = require("vscode");

const types_1 = require("../../common/application/types");

const settings = require("../../common/configSettings");

const constants_1 = require("../../common/constants");

const types_2 = require("../../common/types");

const types_3 = require("../../ioc/types");

const contracts_1 = require("../contracts");

const types_4 = require("./types");

let InterpreterSelector = class InterpreterSelector {
  constructor(serviceContainer) {
    this.serviceContainer = serviceContainer;
    this.disposables = [];
    this.interpreterManager = serviceContainer.get(contracts_1.IInterpreterService);
    this.workspaceService = this.serviceContainer.get(types_1.IWorkspaceService);
    this.applicationShell = this.serviceContainer.get(types_1.IApplicationShell);
    this.documentManager = this.serviceContainer.get(types_1.IDocumentManager);
    this.pathUtils = this.serviceContainer.get(types_2.IPathUtils);
    this.interpreterComparer = this.serviceContainer.get(types_4.IInterpreterComparer);
  }

  dispose() {
    this.disposables.forEach(disposable => disposable.dispose());
  }

  initialize() {
    const commandManager = this.serviceContainer.get(types_1.ICommandManager);
    this.disposables.push(commandManager.registerCommand(constants_1.Commands.Set_Interpreter, this.setInterpreter.bind(this)));
    this.disposables.push(commandManager.registerCommand(constants_1.Commands.Set_ShebangInterpreter, this.setShebangInterpreter.bind(this)));
  }

  getSuggestions(resourceUri) {
    return __awaiter(this, void 0, void 0, function* () {
      const interpreters = yield this.interpreterManager.getInterpreters(resourceUri);
      interpreters.sort(this.interpreterComparer.compare.bind(this.interpreterComparer));
      return Promise.all(interpreters.map(item => this.suggestionToQuickPickItem(item, resourceUri)));
    });
  }

  getWorkspaceToSetPythonPath() {
    return __awaiter(this, void 0, void 0, function* () {
      if (!Array.isArray(this.workspaceService.workspaceFolders) || this.workspaceService.workspaceFolders.length === 0) {
        return undefined;
      }

      if (this.workspaceService.workspaceFolders.length === 1) {
        return {
          folderUri: this.workspaceService.workspaceFolders[0].uri,
          configTarget: vscode_1.ConfigurationTarget.Workspace
        };
      } // Ok we have multiple interpreters, get the user to pick a folder.


      const applicationShell = this.serviceContainer.get(types_1.IApplicationShell);
      const workspaceFolder = yield applicationShell.showWorkspaceFolderPick({
        placeHolder: 'Select a workspace'
      });
      return workspaceFolder ? {
        folderUri: workspaceFolder.uri,
        configTarget: vscode_1.ConfigurationTarget.WorkspaceFolder
      } : undefined;
    });
  }

  suggestionToQuickPickItem(suggestion, workspaceUri) {
    return __awaiter(this, void 0, void 0, function* () {
      const detail = this.pathUtils.getDisplayName(suggestion.path, workspaceUri ? workspaceUri.fsPath : undefined);
      const cachedPrefix = suggestion.cachedEntry ? '(cached) ' : '';
      return {
        // tslint:disable-next-line:no-non-null-assertion
        label: suggestion.displayName,
        detail: `${cachedPrefix}${detail}`,
        path: suggestion.path
      };
    });
  }

  setInterpreter() {
    return __awaiter(this, void 0, void 0, function* () {
      const setInterpreterGlobally = !Array.isArray(this.workspaceService.workspaceFolders) || this.workspaceService.workspaceFolders.length === 0;
      let configTarget = vscode_1.ConfigurationTarget.Global;
      let wkspace;

      if (!setInterpreterGlobally) {
        const targetConfig = yield this.getWorkspaceToSetPythonPath();

        if (!targetConfig) {
          return;
        }

        configTarget = targetConfig.configTarget;
        wkspace = targetConfig.folderUri;
      }

      const suggestions = yield this.getSuggestions(wkspace);
      const currentPythonPath = this.pathUtils.getDisplayName(settings.PythonSettings.getInstance().pythonPath, wkspace ? wkspace.fsPath : undefined);
      const quickPickOptions = {
        matchOnDetail: true,
        matchOnDescription: true,
        placeHolder: `current: ${currentPythonPath}`
      };
      const selection = yield this.applicationShell.showQuickPick(suggestions, quickPickOptions);

      if (selection !== undefined) {
        const pythonPathUpdaterService = this.serviceContainer.get(types_4.IPythonPathUpdaterServiceManager);
        yield pythonPathUpdaterService.updatePythonPath(selection.path, configTarget, 'ui', wkspace);
      }
    });
  }

  setShebangInterpreter() {
    return __awaiter(this, void 0, void 0, function* () {
      const shebangCodeLensProvider = this.serviceContainer.get(contracts_1.IShebangCodeLensProvider);
      const shebang = yield shebangCodeLensProvider.detectShebang(this.documentManager.activeTextEditor.document);

      if (!shebang) {
        return;
      }

      const isGlobalChange = !Array.isArray(this.workspaceService.workspaceFolders) || this.workspaceService.workspaceFolders.length === 0;
      const workspaceFolder = this.workspaceService.getWorkspaceFolder(this.documentManager.activeTextEditor.document.uri);
      const isWorkspaceChange = Array.isArray(this.workspaceService.workspaceFolders) && this.workspaceService.workspaceFolders.length === 1;
      const pythonPathUpdaterService = this.serviceContainer.get(types_4.IPythonPathUpdaterServiceManager);

      if (isGlobalChange) {
        yield pythonPathUpdaterService.updatePythonPath(shebang, vscode_1.ConfigurationTarget.Global, 'shebang');
        return;
      }

      if (isWorkspaceChange || !workspaceFolder) {
        yield pythonPathUpdaterService.updatePythonPath(shebang, vscode_1.ConfigurationTarget.Workspace, 'shebang', this.workspaceService.workspaceFolders[0].uri);
        return;
      }

      yield pythonPathUpdaterService.updatePythonPath(shebang, vscode_1.ConfigurationTarget.WorkspaceFolder, 'shebang', workspaceFolder.uri);
    });
  }

};
InterpreterSelector = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_3.IServiceContainer))], InterpreterSelector);
exports.InterpreterSelector = InterpreterSelector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImludGVycHJldGVyU2VsZWN0b3IuanMiXSwibmFtZXMiOlsiX19kZWNvcmF0ZSIsImRlY29yYXRvcnMiLCJ0YXJnZXQiLCJrZXkiLCJkZXNjIiwiYyIsImFyZ3VtZW50cyIsImxlbmd0aCIsInIiLCJPYmplY3QiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJkIiwiUmVmbGVjdCIsImRlY29yYXRlIiwiaSIsImRlZmluZVByb3BlcnR5IiwiX19wYXJhbSIsInBhcmFtSW5kZXgiLCJkZWNvcmF0b3IiLCJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiZXhwb3J0cyIsImludmVyc2lmeV8xIiwicmVxdWlyZSIsInZzY29kZV8xIiwidHlwZXNfMSIsInNldHRpbmdzIiwiY29uc3RhbnRzXzEiLCJ0eXBlc18yIiwidHlwZXNfMyIsImNvbnRyYWN0c18xIiwidHlwZXNfNCIsIkludGVycHJldGVyU2VsZWN0b3IiLCJjb25zdHJ1Y3RvciIsInNlcnZpY2VDb250YWluZXIiLCJkaXNwb3NhYmxlcyIsImludGVycHJldGVyTWFuYWdlciIsImdldCIsIklJbnRlcnByZXRlclNlcnZpY2UiLCJ3b3Jrc3BhY2VTZXJ2aWNlIiwiSVdvcmtzcGFjZVNlcnZpY2UiLCJhcHBsaWNhdGlvblNoZWxsIiwiSUFwcGxpY2F0aW9uU2hlbGwiLCJkb2N1bWVudE1hbmFnZXIiLCJJRG9jdW1lbnRNYW5hZ2VyIiwicGF0aFV0aWxzIiwiSVBhdGhVdGlscyIsImludGVycHJldGVyQ29tcGFyZXIiLCJJSW50ZXJwcmV0ZXJDb21wYXJlciIsImRpc3Bvc2UiLCJmb3JFYWNoIiwiZGlzcG9zYWJsZSIsImluaXRpYWxpemUiLCJjb21tYW5kTWFuYWdlciIsIklDb21tYW5kTWFuYWdlciIsInB1c2giLCJyZWdpc3RlckNvbW1hbmQiLCJDb21tYW5kcyIsIlNldF9JbnRlcnByZXRlciIsInNldEludGVycHJldGVyIiwiYmluZCIsIlNldF9TaGViYW5nSW50ZXJwcmV0ZXIiLCJzZXRTaGViYW5nSW50ZXJwcmV0ZXIiLCJnZXRTdWdnZXN0aW9ucyIsInJlc291cmNlVXJpIiwiaW50ZXJwcmV0ZXJzIiwiZ2V0SW50ZXJwcmV0ZXJzIiwic29ydCIsImNvbXBhcmUiLCJhbGwiLCJtYXAiLCJpdGVtIiwic3VnZ2VzdGlvblRvUXVpY2tQaWNrSXRlbSIsImdldFdvcmtzcGFjZVRvU2V0UHl0aG9uUGF0aCIsIkFycmF5IiwiaXNBcnJheSIsIndvcmtzcGFjZUZvbGRlcnMiLCJ1bmRlZmluZWQiLCJmb2xkZXJVcmkiLCJ1cmkiLCJjb25maWdUYXJnZXQiLCJDb25maWd1cmF0aW9uVGFyZ2V0IiwiV29ya3NwYWNlIiwid29ya3NwYWNlRm9sZGVyIiwic2hvd1dvcmtzcGFjZUZvbGRlclBpY2siLCJwbGFjZUhvbGRlciIsIldvcmtzcGFjZUZvbGRlciIsInN1Z2dlc3Rpb24iLCJ3b3Jrc3BhY2VVcmkiLCJkZXRhaWwiLCJnZXREaXNwbGF5TmFtZSIsInBhdGgiLCJmc1BhdGgiLCJjYWNoZWRQcmVmaXgiLCJjYWNoZWRFbnRyeSIsImxhYmVsIiwiZGlzcGxheU5hbWUiLCJzZXRJbnRlcnByZXRlckdsb2JhbGx5IiwiR2xvYmFsIiwid2tzcGFjZSIsInRhcmdldENvbmZpZyIsInN1Z2dlc3Rpb25zIiwiY3VycmVudFB5dGhvblBhdGgiLCJQeXRob25TZXR0aW5ncyIsImdldEluc3RhbmNlIiwicHl0aG9uUGF0aCIsInF1aWNrUGlja09wdGlvbnMiLCJtYXRjaE9uRGV0YWlsIiwibWF0Y2hPbkRlc2NyaXB0aW9uIiwic2VsZWN0aW9uIiwic2hvd1F1aWNrUGljayIsInB5dGhvblBhdGhVcGRhdGVyU2VydmljZSIsIklQeXRob25QYXRoVXBkYXRlclNlcnZpY2VNYW5hZ2VyIiwidXBkYXRlUHl0aG9uUGF0aCIsInNoZWJhbmdDb2RlTGVuc1Byb3ZpZGVyIiwiSVNoZWJhbmdDb2RlTGVuc1Byb3ZpZGVyIiwic2hlYmFuZyIsImRldGVjdFNoZWJhbmciLCJhY3RpdmVUZXh0RWRpdG9yIiwiZG9jdW1lbnQiLCJpc0dsb2JhbENoYW5nZSIsImdldFdvcmtzcGFjZUZvbGRlciIsImlzV29ya3NwYWNlQ2hhbmdlIiwiaW5qZWN0YWJsZSIsImluamVjdCIsIklTZXJ2aWNlQ29udGFpbmVyIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEsTUFBMEJDLENBQUMsR0FBR0gsQ0FBQyxHQUFHLENBQUosR0FBUUgsTUFBUixHQUFpQkUsSUFBSSxLQUFLLElBQVQsR0FBZ0JBLElBQUksR0FBR0ssTUFBTSxDQUFDQyx3QkFBUCxDQUFnQ1IsTUFBaEMsRUFBd0NDLEdBQXhDLENBQXZCLEdBQXNFQyxJQUFySDtBQUFBLE1BQTJITyxDQUEzSDtBQUNBLE1BQUksT0FBT0MsT0FBUCxLQUFtQixRQUFuQixJQUErQixPQUFPQSxPQUFPLENBQUNDLFFBQWYsS0FBNEIsVUFBL0QsRUFBMkVMLENBQUMsR0FBR0ksT0FBTyxDQUFDQyxRQUFSLENBQWlCWixVQUFqQixFQUE2QkMsTUFBN0IsRUFBcUNDLEdBQXJDLEVBQTBDQyxJQUExQyxDQUFKLENBQTNFLEtBQ0ssS0FBSyxJQUFJVSxDQUFDLEdBQUdiLFVBQVUsQ0FBQ00sTUFBWCxHQUFvQixDQUFqQyxFQUFvQ08sQ0FBQyxJQUFJLENBQXpDLEVBQTRDQSxDQUFDLEVBQTdDLEVBQWlELElBQUlILENBQUMsR0FBR1YsVUFBVSxDQUFDYSxDQUFELENBQWxCLEVBQXVCTixDQUFDLEdBQUcsQ0FBQ0gsQ0FBQyxHQUFH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NUgsQ0FBTjtBQUNILEtBbkJlLENBQWhCO0FBb0JIOztBQXBHK0MsQ0FBcEQ7QUFzR0EvQyxtQkFBbUIsR0FBR2hELFVBQVUsQ0FBQyxDQUM3QnNDLFdBQVcsQ0FBQ3FHLFVBQVosRUFENkIsRUFFN0IzSCxPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDc0csTUFBWixDQUFtQi9GLE9BQU8sQ0FBQ2dHLGlCQUEzQixDQUFKLENBRnNCLENBQUQsRUFHN0I3RixtQkFINkIsQ0FBaEM7QUFJQVgsT0FBTyxDQUFDVyxtQkFBUixHQUE4QkEsbUJBQTlCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XG4gICAgdmFyIGMgPSBhcmd1bWVudHMubGVuZ3RoLCByID0gYyA8IDMgPyB0YXJnZXQgOiBkZXNjID09PSBudWxsID8gZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpIDogZGVzYywgZDtcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XG4gICAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjtcbn07XG52YXIgX19wYXJhbSA9ICh0aGlzICYmIHRoaXMuX19wYXJhbSkgfHwgZnVuY3Rpb24gKHBhcmFtSW5kZXgsIGRlY29yYXRvcikge1xuICAgIHJldHVybiBmdW5jdGlvbiAodGFyZ2V0LCBrZXkpIHsgZGVjb3JhdG9yKHRhcmdldCwga2V5LCBwYXJhbUluZGV4KTsgfVxufTtcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XG4gICAgfSk7XG59O1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuY29uc3QgaW52ZXJzaWZ5XzEgPSByZXF1aXJlKFwiaW52ZXJzaWZ5XCIpO1xuY29uc3QgdnNjb2RlXzEgPSByZXF1aXJlKFwidnNjb2RlXCIpO1xuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jb21tb24vYXBwbGljYXRpb24vdHlwZXNcIik7XG5jb25zdCBzZXR0aW5ncyA9IHJlcXVpcmUoXCIuLi8uLi9jb21tb24vY29uZmlnU2V0dGluZ3NcIik7XG5jb25zdCBjb25zdGFudHNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jb21tb24vY29uc3RhbnRzXCIpO1xuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi8uLi9jb21tb24vdHlwZXNcIik7XG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4uLy4uL2lvYy90eXBlc1wiKTtcbmNvbnN0IGNvbnRyYWN0c18xID0gcmVxdWlyZShcIi4uL2NvbnRyYWN0c1wiKTtcbmNvbnN0IHR5cGVzXzQgPSByZXF1aXJlKFwiLi90eXBlc1wiKTtcbmxldCBJbnRlcnByZXRlclNlbGVjdG9yID0gY2xhc3MgSW50ZXJwcmV0ZXJTZWxlY3RvciB7XG4gICAgY29uc3RydWN0b3Ioc2VydmljZUNvbnRhaW5lcikge1xuICAgICAgICB0aGlzLnNlcnZpY2VDb250YWluZXIgPSBzZXJ2aWNlQ29udGFpbmVyO1xuICAgICAgICB0aGlzLmRpc3Bvc2FibGVzID0gW107XG4gICAgICAgIHRoaXMuaW50ZXJwcmV0ZXJNYW5hZ2VyID0gc2VydmljZUNvbnRhaW5lci5nZXQoY29udHJhY3RzXzEuSUludGVycHJldGVyU2VydmljZSk7XG4gICAgICAgIHRoaXMud29ya3NwYWNlU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JV29ya3NwYWNlU2VydmljZSk7XG4gICAgICAgIHRoaXMuYXBwbGljYXRpb25TaGVsbCA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JQXBwbGljYXRpb25TaGVsbCk7XG4gICAgICAgIHRoaXMuZG9jdW1lbnRNYW5hZ2VyID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklEb2N1bWVudE1hbmFnZXIpO1xuICAgICAgICB0aGlzLnBhdGhVdGlscyA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMi5JUGF0aFV0aWxzKTtcbiAgICAgICAgdGhpcy5pbnRlcnByZXRlckNvbXBhcmVyID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc180LklJbnRlcnByZXRlckNvbXBhcmVyKTtcbiAgICB9XG4gICAgZGlzcG9zZSgpIHtcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlcy5mb3JFYWNoKGRpc3Bvc2FibGUgPT4gZGlzcG9zYWJsZS5kaXNwb3NlKCkpO1xuICAgIH1cbiAgICBpbml0aWFsaXplKCkge1xuICAgICAgICBjb25zdCBjb21tYW5kTWFuYWdlciA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JQ29tbWFuZE1hbmFnZXIpO1xuICAgICAgICB0aGlzLmRpc3Bvc2FibGVzLnB1c2goY29tbWFuZE1hbmFnZXIucmVnaXN0ZXJDb21tYW5kKGNvbnN0YW50c18xLkNvbW1hbmRzLlNldF9JbnRlcnByZXRlciwgdGhpcy5zZXRJbnRlcnByZXRlci5iaW5kKHRoaXMpKSk7XG4gICAgICAgIHRoaXMuZGlzcG9zYWJsZXMucHVzaChjb21tYW5kTWFuYWdlci5yZWdpc3RlckNvbW1hbmQoY29uc3RhbnRzXzEuQ29tbWFuZHMuU2V0X1NoZWJhbmdJbnRlcnByZXRlciwgdGhpcy5zZXRTaGViYW5nSW50ZXJwcmV0ZXIuYmluZCh0aGlzKSkpO1xuICAgIH1cbiAgICBnZXRTdWdnZXN0aW9ucyhyZXNvdXJjZVVyaSkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgaW50ZXJwcmV0ZXJzID0geWllbGQgdGhpcy5pbnRlcnByZXRlck1hbmFnZXIuZ2V0SW50ZXJwcmV0ZXJzKHJlc291cmNlVXJpKTtcbiAgICAgICAgICAgIGludGVycHJldGVycy5zb3J0KHRoaXMuaW50ZXJwcmV0ZXJDb21wYXJlci5jb21wYXJlLmJpbmQodGhpcy5pbnRlcnByZXRlckNvbXBhcmVyKSk7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoaW50ZXJwcmV0ZXJzLm1hcChpdGVtID0+IHRoaXMuc3VnZ2VzdGlvblRvUXVpY2tQaWNrSXRlbShpdGVtLCByZXNvdXJjZVVyaSkpKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGdldFdvcmtzcGFjZVRvU2V0UHl0aG9uUGF0aCgpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheSh0aGlzLndvcmtzcGFjZVNlcnZpY2Uud29ya3NwYWNlRm9sZGVycykgfHwgdGhpcy53b3Jrc3BhY2VTZXJ2aWNlLndvcmtzcGFjZUZvbGRlcnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh0aGlzLndvcmtzcGFjZVNlcnZpY2Uud29ya3NwYWNlRm9sZGVycy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geyBmb2xkZXJVcmk6IHRoaXMud29ya3NwYWNlU2VydmljZS53b3Jrc3BhY2VGb2xkZXJzWzBdLnVyaSwgY29uZmlnVGFyZ2V0OiB2c2NvZGVfMS5Db25maWd1cmF0aW9uVGFyZ2V0LldvcmtzcGFjZSB9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gT2sgd2UgaGF2ZSBtdWx0aXBsZSBpbnRlcnByZXRlcnMsIGdldCB0aGUgdXNlciB0byBwaWNrIGEgZm9sZGVyLlxuICAgICAgICAgICAgY29uc3QgYXBwbGljYXRpb25TaGVsbCA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JQXBwbGljYXRpb25TaGVsbCk7XG4gICAgICAgICAgICBjb25zdCB3b3Jrc3BhY2VGb2xkZXIgPSB5aWVsZCBhcHBsaWNhdGlvblNoZWxsLnNob3dXb3Jrc3BhY2VGb2xkZXJQaWNrKHsgcGxhY2VIb2xkZXI6ICdTZWxlY3QgYSB3b3Jrc3BhY2UnIH0pO1xuICAgICAgICAgICAgcmV0dXJuIHdvcmtzcGFjZUZvbGRlciA/IHsgZm9sZGVyVXJpOiB3b3Jrc3BhY2VGb2xkZXIudXJpLCBjb25maWdUYXJnZXQ6IHZzY29kZV8xLkNvbmZpZ3VyYXRpb25UYXJnZXQuV29ya3NwYWNlRm9sZGVyIH0gOiB1bmRlZmluZWQ7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBzdWdnZXN0aW9uVG9RdWlja1BpY2tJdGVtKHN1Z2dlc3Rpb24sIHdvcmtzcGFjZVVyaSkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgZGV0YWlsID0gdGhpcy5wYXRoVXRpbHMuZ2V0RGlzcGxheU5hbWUoc3VnZ2VzdGlvbi5wYXRoLCB3b3Jrc3BhY2VVcmkgPyB3b3Jrc3BhY2VVcmkuZnNQYXRoIDogdW5kZWZpbmVkKTtcbiAgICAgICAgICAgIGNvbnN0IGNhY2hlZFByZWZpeCA9IHN1Z2dlc3Rpb24uY2FjaGVkRW50cnkgPyAnKGNhY2hlZCkgJyA6ICcnO1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgICAgICAgICAgICAgbGFiZWw6IHN1Z2dlc3Rpb24uZGlzcGxheU5hbWUsXG4gICAgICAgICAgICAgICAgZGV0YWlsOiBgJHtjYWNoZWRQcmVmaXh9JHtkZXRhaWx9YCxcbiAgICAgICAgICAgICAgICBwYXRoOiBzdWdnZXN0aW9uLnBhdGhcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBzZXRJbnRlcnByZXRlcigpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IHNldEludGVycHJldGVyR2xvYmFsbHkgPSAhQXJyYXkuaXNBcnJheSh0aGlzLndvcmtzcGFjZVNlcnZpY2Uud29ya3NwYWNlRm9sZGVycykgfHwgdGhpcy53b3Jrc3BhY2VTZXJ2aWNlLndvcmtzcGFjZUZvbGRlcnMubGVuZ3RoID09PSAwO1xuICAgICAgICAgICAgbGV0IGNvbmZpZ1RhcmdldCA9IHZzY29kZV8xLkNvbmZpZ3VyYXRpb25UYXJnZXQuR2xvYmFsO1xuICAgICAgICAgICAgbGV0IHdrc3BhY2U7XG4gICAgICAgICAgICBpZiAoIXNldEludGVycHJldGVyR2xvYmFsbHkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRDb25maWcgPSB5aWVsZCB0aGlzLmdldFdvcmtzcGFjZVRvU2V0UHl0aG9uUGF0aCgpO1xuICAgICAgICAgICAgICAgIGlmICghdGFyZ2V0Q29uZmlnKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uZmlnVGFyZ2V0ID0gdGFyZ2V0Q29uZmlnLmNvbmZpZ1RhcmdldDtcbiAgICAgICAgICAgICAgICB3a3NwYWNlID0gdGFyZ2V0Q29uZmlnLmZvbGRlclVyaTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHN1Z2dlc3Rpb25zID0geWllbGQgdGhpcy5nZXRTdWdnZXN0aW9ucyh3a3NwYWNlKTtcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRQeXRob25QYXRoID0gdGhpcy5wYXRoVXRpbHMuZ2V0RGlzcGxheU5hbWUoc2V0dGluZ3MuUHl0aG9uU2V0dGluZ3MuZ2V0SW5zdGFuY2UoKS5weXRob25QYXRoLCB3a3NwYWNlID8gd2tzcGFjZS5mc1BhdGggOiB1bmRlZmluZWQpO1xuICAgICAgICAgICAgY29uc3QgcXVpY2tQaWNrT3B0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICBtYXRjaE9uRGV0YWlsOiB0cnVlLFxuICAgICAgICAgICAgICAgIG1hdGNoT25EZXNjcmlwdGlvbjogdHJ1ZSxcbiAgICAgICAgICAgICAgICBwbGFjZUhvbGRlcjogYGN1cnJlbnQ6ICR7Y3VycmVudFB5dGhvblBhdGh9YFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGlvbiA9IHlpZWxkIHRoaXMuYXBwbGljYXRpb25TaGVsbC5zaG93UXVpY2tQaWNrKHN1Z2dlc3Rpb25zLCBxdWlja1BpY2tPcHRpb25zKTtcbiAgICAgICAgICAgIGlmIChzZWxlY3Rpb24gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHB5dGhvblBhdGhVcGRhdGVyU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfNC5JUHl0aG9uUGF0aFVwZGF0ZXJTZXJ2aWNlTWFuYWdlcik7XG4gICAgICAgICAgICAgICAgeWllbGQgcHl0aG9uUGF0aFVwZGF0ZXJTZXJ2aWNlLnVwZGF0ZVB5dGhvblBhdGgoc2VsZWN0aW9uLnBhdGgsIGNvbmZpZ1RhcmdldCwgJ3VpJywgd2tzcGFjZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBzZXRTaGViYW5nSW50ZXJwcmV0ZXIoKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBzaGViYW5nQ29kZUxlbnNQcm92aWRlciA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQoY29udHJhY3RzXzEuSVNoZWJhbmdDb2RlTGVuc1Byb3ZpZGVyKTtcbiAgICAgICAgICAgIGNvbnN0IHNoZWJhbmcgPSB5aWVsZCBzaGViYW5nQ29kZUxlbnNQcm92aWRlci5kZXRlY3RTaGViYW5nKHRoaXMuZG9jdW1lbnRNYW5hZ2VyLmFjdGl2ZVRleHRFZGl0b3IuZG9jdW1lbnQpO1xuICAgICAgICAgICAgaWYgKCFzaGViYW5nKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgaXNHbG9iYWxDaGFuZ2UgPSAhQXJyYXkuaXNBcnJheSh0aGlzLndvcmtzcGFjZVNlcnZpY2Uud29ya3NwYWNlRm9sZGVycykgfHwgdGhpcy53b3Jrc3BhY2VTZXJ2aWNlLndvcmtzcGFjZUZvbGRlcnMubGVuZ3RoID09PSAwO1xuICAgICAgICAgICAgY29uc3Qgd29ya3NwYWNlRm9sZGVyID0gdGhpcy53b3Jrc3BhY2VTZXJ2aWNlLmdldFdvcmtzcGFjZUZvbGRlcih0aGlzLmRvY3VtZW50TWFuYWdlci5hY3RpdmVUZXh0RWRpdG9yLmRvY3VtZW50LnVyaSk7XG4gICAgICAgICAgICBjb25zdCBpc1dvcmtzcGFjZUNoYW5nZSA9IEFycmF5LmlzQXJyYXkodGhpcy53b3Jrc3BhY2VTZXJ2aWNlLndvcmtzcGFjZUZvbGRlcnMpICYmIHRoaXMud29ya3NwYWNlU2VydmljZS53b3Jrc3BhY2VGb2xkZXJzLmxlbmd0aCA9PT0gMTtcbiAgICAgICAgICAgIGNvbnN0IHB5dGhvblBhdGhVcGRhdGVyU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfNC5JUHl0aG9uUGF0aFVwZGF0ZXJTZXJ2aWNlTWFuYWdlcik7XG4gICAgICAgICAgICBpZiAoaXNHbG9iYWxDaGFuZ2UpIHtcbiAgICAgICAgICAgICAgICB5aWVsZCBweXRob25QYXRoVXBkYXRlclNlcnZpY2UudXBkYXRlUHl0aG9uUGF0aChzaGViYW5nLCB2c2NvZGVfMS5Db25maWd1cmF0aW9uVGFyZ2V0Lkdsb2JhbCwgJ3NoZWJhbmcnKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaXNXb3Jrc3BhY2VDaGFuZ2UgfHwgIXdvcmtzcGFjZUZvbGRlcikge1xuICAgICAgICAgICAgICAgIHlpZWxkIHB5dGhvblBhdGhVcGRhdGVyU2VydmljZS51cGRhdGVQeXRob25QYXRoKHNoZWJhbmcsIHZzY29kZV8xLkNvbmZpZ3VyYXRpb25UYXJnZXQuV29ya3NwYWNlLCAnc2hlYmFuZycsIHRoaXMud29ya3NwYWNlU2VydmljZS53b3Jrc3BhY2VGb2xkZXJzWzBdLnVyaSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgeWllbGQgcHl0aG9uUGF0aFVwZGF0ZXJTZXJ2aWNlLnVwZGF0ZVB5dGhvblBhdGgoc2hlYmFuZywgdnNjb2RlXzEuQ29uZmlndXJhdGlvblRhcmdldC5Xb3Jrc3BhY2VGb2xkZXIsICdzaGViYW5nJywgd29ya3NwYWNlRm9sZGVyLnVyaSk7XG4gICAgICAgIH0pO1xuICAgIH1cbn07XG5JbnRlcnByZXRlclNlbGVjdG9yID0gX19kZWNvcmF0ZShbXG4gICAgaW52ZXJzaWZ5XzEuaW5qZWN0YWJsZSgpLFxuICAgIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzMuSVNlcnZpY2VDb250YWluZXIpKVxuXSwgSW50ZXJwcmV0ZXJTZWxlY3Rvcik7XG5leHBvcnRzLkludGVycHJldGVyU2VsZWN0b3IgPSBJbnRlcnByZXRlclNlbGVjdG9yO1xuLy8jIHNvdXJjZU1hcHBpbmdVUkw9aW50ZXJwcmV0ZXJTZWxlY3Rvci5qcy5tYXAiXX0=