"use strict";

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const path = require("path");

const vscode_1 = require("vscode");

const types_1 = require("../../common/process/types");

const stopWatch_1 = require("../../common/utils/stopWatch");

const types_2 = require("../../ioc/types");

const telemetry_1 = require("../../telemetry");

const constants_1 = require("../../telemetry/constants");

const contracts_1 = require("../contracts");

const types_3 = require("./types");

let PythonPathUpdaterService = class PythonPathUpdaterService {
  constructor(serviceContainer) {
    this.pythonPathSettingsUpdaterFactory = serviceContainer.get(types_3.IPythonPathUpdaterServiceFactory);
    this.interpreterVersionService = serviceContainer.get(contracts_1.IInterpreterVersionService);
    this.executionFactory = serviceContainer.get(types_1.IPythonExecutionFactory);
  }

  updatePythonPath(pythonPath, configTarget, trigger, wkspace) {
    return __awaiter(this, void 0, void 0, function* () {
      const stopWatch = new stopWatch_1.StopWatch();
      const pythonPathUpdater = this.getPythonUpdaterService(configTarget, wkspace);
      let failed = false;

      try {
        yield pythonPathUpdater.updatePythonPath(path.normalize(pythonPath));
      } catch (reason) {
        failed = true; // tslint:disable-next-line:no-unsafe-any prefer-type-cast

        const message = reason && typeof reason.message === 'string' ? reason.message : '';
        vscode_1.window.showErrorMessage(`Failed to set 'pythonPath'. Error: ${message}`);
        console.error(reason);
      } // do not wait for this to complete


      this.sendTelemetry(stopWatch.elapsedTime, failed, trigger, pythonPath).catch(ex => console.error('Python Extension: sendTelemetry', ex));
    });
  }

  sendTelemetry(duration, failed, trigger, pythonPath) {
    return __awaiter(this, void 0, void 0, function* () {
      const telemtryProperties = {
        failed,
        trigger
      };

      if (!failed) {
        const processService = yield this.executionFactory.create({
          pythonPath
        });
        const infoPromise = processService.getInterpreterInformation().catch(() => undefined);
        const pipVersionPromise = this.interpreterVersionService.getPipVersion(pythonPath).then(value => value.length === 0 ? undefined : value).catch(() => '');
        const [info, pipVersion] = yield Promise.all([infoPromise, pipVersionPromise]);

        if (info) {
          telemtryProperties.pythonVersion = info.version_info.join('.');
        }

        if (pipVersion) {
          telemtryProperties.pipVersion = pipVersion;
        }
      }

      telemetry_1.sendTelemetryEvent(constants_1.PYTHON_INTERPRETER, duration, telemtryProperties);
    });
  }

  getPythonUpdaterService(configTarget, wkspace) {
    switch (configTarget) {
      case vscode_1.ConfigurationTarget.Global:
        {
          return this.pythonPathSettingsUpdaterFactory.getGlobalPythonPathConfigurationService();
        }

      case vscode_1.ConfigurationTarget.Workspace:
        {
          if (!wkspace) {
            throw new Error('Workspace Uri not defined');
          } // tslint:disable-next-line:no-non-null-assertion


          return this.pythonPathSettingsUpdaterFactory.getWorkspacePythonPathConfigurationService(wkspace);
        }

      default:
        {
          if (!wkspace) {
            throw new Error('Workspace Uri not defined');
          } // tslint:disable-next-line:no-non-null-assertion


          return this.pythonPathSettingsUpdaterFactory.getWorkspaceFolderPythonPathConfigurationService(wkspace);
        }
    }
  }

};
PythonPathUpdaterService = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_2.IServiceContainer))], PythonPathUpdaterService);
exports.PythonPathUpdaterService = PythonPathUpdaterService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInB5dGhvblBhdGhVcGRhdGVyU2VydmljZS5qcyJdLCJuYW1lcyI6WyJfX2RlY29yYXRlIiwiZGVjb3JhdG9ycyIsInRhcmdldCIsImtleSIsImRlc2MiLCJjIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImQiLCJSZWZsZWN0IiwiZGVjb3JhdGUiLCJpIiwiZGVmaW5lUHJvcGVydHkiLCJfX3BhcmFtIiwicGFyYW1JbmRleCIsImRlY29yYXRvciIsIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJleHBvcnRzIiwiaW52ZXJzaWZ5XzEiLCJyZXF1aXJlIiwicGF0aCIsInZzY29kZV8xIiwidHlwZXNfMSIsInN0b3BXYXRjaF8xIiwidHlwZXNfMiIsInRlbGVtZXRyeV8xIiwiY29uc3RhbnRzXzEiLCJjb250cmFjdHNfMSIsInR5cGVzXzMiLCJQeXRob25QYXRoVXBkYXRlclNlcnZpY2UiLCJjb25zdHJ1Y3RvciIsInNlcnZpY2VDb250YWluZXIiLCJweXRob25QYXRoU2V0dGluZ3NVcGRhdGVyRmFjdG9yeSIsImdldCIsIklQeXRob25QYXRoVXBkYXRlclNlcnZpY2VGYWN0b3J5IiwiaW50ZXJwcmV0ZXJWZXJzaW9uU2VydmljZSIsIklJbnRlcnByZXRlclZlcnNpb25TZXJ2aWNlIiwiZXhlY3V0aW9uRmFjdG9yeSIsIklQeXRob25FeGVjdXRpb25GYWN0b3J5IiwidXBkYXRlUHl0aG9uUGF0aCIsInB5dGhvblBhdGgiLCJjb25maWdUYXJnZXQiLCJ0cmlnZ2VyIiwid2tzcGFjZSIsInN0b3BXYXRjaCIsIlN0b3BXYXRjaCIsInB5dGhvblBhdGhVcGRhdGVyIiwiZ2V0UHl0aG9uVXBkYXRlclNlcnZpY2UiLCJmYWlsZWQiLCJub3JtYWxpemUiLCJyZWFzb24iLCJtZXNzYWdlIiwid2luZG93Iiwic2hvd0Vycm9yTWVzc2FnZSIsImNvbnNvbGUiLCJlcnJvciIsInNlbmRUZWxlbWV0cnkiLCJlbGFwc2VkVGltZSIsImNhdGNoIiwiZXgiLCJkdXJhdGlvbiIsInRlbGVtdHJ5UHJvcGVydGllcyIsInByb2Nlc3NTZXJ2aWNlIiwiY3JlYXRlIiwiaW5mb1Byb21pc2UiLCJnZXRJbnRlcnByZXRlckluZm9ybWF0aW9uIiwidW5kZWZpbmVkIiwicGlwVmVyc2lvblByb21pc2UiLCJnZXRQaXBWZXJzaW9uIiwiaW5mbyIsInBpcFZlcnNpb24iLCJhbGwiLCJweXRob25WZXJzaW9uIiwidmVyc2lvbl9pbmZvIiwiam9pbiIsInNlbmRUZWxlbWV0cnlFdmVudCIsIlBZVEhPTl9JTlRFUlBSRVRFUiIsIkNvbmZpZ3VyYXRpb25UYXJnZXQiLCJHbG9iYWwiLCJnZXRHbG9iYWxQeXRob25QYXRoQ29uZmlndXJhdGlvblNlcnZpY2UiLCJXb3Jrc3BhY2UiLCJFcnJvciIsImdldFdvcmtzcGFjZVB5dGhvblBhdGhDb25maWd1cmF0aW9uU2VydmljZSIsImdldFdvcmtzcGFjZUZvbGRlclB5dGhvblBhdGhDb25maWd1cmF0aW9uU2VydmljZSIsImluamVjdGFibGUiLCJpbmplY3QiLCJJU2VydmljZUNvbnRhaW5lciJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBQ0EsSUFBSUEsVUFBVSxHQUFJLFVBQVEsU0FBS0EsVUFBZCxJQUE2QixVQUFVQyxVQUFWLEVBQXNCQyxNQUF0QixFQUE4QkMsR0FBOUIsRUFBbUNDLElBQW5DLEVBQXlDO0FBQ25GLE1BQUlDLENBQUMsR0FBR0MsU0FBUyxDQUFDQyxNQUFsQjtBQUFBLE1BQTBCQyxDQUFDLEdBQUdILENBQUMsR0FBRyxDQUFKLEdBQVFILE1BQVIsR0FBaUJFLElBQUksS0FBSyxJQUFULEdBQWdCQSxJQUFJLEdBQUdLLE1BQU0sQ0FB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QXpFO0FBQ0gsS0FwQmUsQ0FBaEI7QUFxQkg7O0FBQ0RkLEVBQUFBLHVCQUF1QixDQUFDTixZQUFELEVBQWVFLE9BQWYsRUFBd0I7QUFDM0MsWUFBUUYsWUFBUjtBQUNJLFdBQUtwQixRQUFRLENBQUN3RCxtQkFBVCxDQUE2QkMsTUFBbEM7QUFBMEM7QUFDdEMsaUJBQU8sS0FBSzlDLGdDQUFMLENBQXNDK0MsdUNBQXRDLEVBQVA7QUFDSDs7QUFDRCxXQUFLMUQsUUFBUSxDQUFDd0QsbUJBQVQsQ0FBNkJHLFNBQWxDO0FBQTZDO0FBQ3pDLGNBQUksQ0FBQ3JDLE9BQUwsRUFBYztBQUNWLGtCQUFNLElBQUlzQyxLQUFKLENBQVUsMkJBQVYsQ0FBTjtBQUNILFdBSHdDLENBSXpDOzs7QUFDQSxpQkFBTyxLQUFLakQsZ0NBQUwsQ0FBc0NrRCwwQ0FBdEMsQ0FBaUZ2QyxPQUFqRixDQUFQO0FBQ0g7O0FBQ0Q7QUFBUztBQUNMLGNBQUksQ0FBQ0EsT0FBTCxFQUFjO0FBQ1Ysa0JBQU0sSUFBSXNDLEtBQUosQ0FBVSwyQkFBVixDQUFOO0FBQ0gsV0FISSxDQUlMOzs7QUFDQSxpQkFBTyxLQUFLakQsZ0NBQUwsQ0FBc0NtRCxnREFBdEMsQ0FBdUZ4QyxPQUF2RixDQUFQO0FBQ0g7QUFqQkw7QUFtQkg7O0FBckV5RCxDQUE5RDtBQXVFQWQsd0JBQXdCLEdBQUdqRCxVQUFVLENBQUMsQ0FDbENzQyxXQUFXLENBQUNrRSxVQUFaLEVBRGtDLEVBRWxDeEYsT0FBTyxDQUFDLENBQUQsRUFBSXNCLFdBQVcsQ0FBQ21FLE1BQVosQ0FBbUI3RCxPQUFPLENBQUM4RCxpQkFBM0IsQ0FBSixDQUYyQixDQUFELEVBR2xDekQsd0JBSGtDLENBQXJDO0FBSUFaLE9BQU8sQ0FBQ1ksd0JBQVIsR0FBbUNBLHdCQUFuQyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xudmFyIF9fZGVjb3JhdGUgPSAodGhpcyAmJiB0aGlzLl9fZGVjb3JhdGUpIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcbiAgICBlbHNlIGZvciAodmFyIGkgPSBkZWNvcmF0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBpZiAoZCA9IGRlY29yYXRvcnNbaV0pIHIgPSAoYyA8IDMgPyBkKHIpIDogYyA+IDMgPyBkKHRhcmdldCwga2V5LCByKSA6IGQodGFyZ2V0LCBrZXkpKSB8fCByO1xuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XG59O1xudmFyIF9fcGFyYW0gPSAodGhpcyAmJiB0aGlzLl9fcGFyYW0pIHx8IGZ1bmN0aW9uIChwYXJhbUluZGV4LCBkZWNvcmF0b3IpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7IGRlY29yYXRvcih0YXJnZXQsIGtleSwgcGFyYW1JbmRleCk7IH1cbn07XG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xuICAgIH0pO1xufTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbmNvbnN0IGludmVyc2lmeV8xID0gcmVxdWlyZShcImludmVyc2lmeVwiKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vLi4vY29tbW9uL3Byb2Nlc3MvdHlwZXNcIik7XG5jb25zdCBzdG9wV2F0Y2hfMSA9IHJlcXVpcmUoXCIuLi8uLi9jb21tb24vdXRpbHMvc3RvcFdhdGNoXCIpO1xuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi8uLi9pb2MvdHlwZXNcIik7XG5jb25zdCB0ZWxlbWV0cnlfMSA9IHJlcXVpcmUoXCIuLi8uLi90ZWxlbWV0cnlcIik7XG5jb25zdCBjb25zdGFudHNfMSA9IHJlcXVpcmUoXCIuLi8uLi90ZWxlbWV0cnkvY29uc3RhbnRzXCIpO1xuY29uc3QgY29udHJhY3RzXzEgPSByZXF1aXJlKFwiLi4vY29udHJhY3RzXCIpO1xuY29uc3QgdHlwZXNfMyA9IHJlcXVpcmUoXCIuL3R5cGVzXCIpO1xubGV0IFB5dGhvblBhdGhVcGRhdGVyU2VydmljZSA9IGNsYXNzIFB5dGhvblBhdGhVcGRhdGVyU2VydmljZSB7XG4gICAgY29uc3RydWN0b3Ioc2VydmljZUNvbnRhaW5lcikge1xuICAgICAgICB0aGlzLnB5dGhvblBhdGhTZXR0aW5nc1VwZGF0ZXJGYWN0b3J5ID0gc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMy5JUHl0aG9uUGF0aFVwZGF0ZXJTZXJ2aWNlRmFjdG9yeSk7XG4gICAgICAgIHRoaXMuaW50ZXJwcmV0ZXJWZXJzaW9uU2VydmljZSA9IHNlcnZpY2VDb250YWluZXIuZ2V0KGNvbnRyYWN0c18xLklJbnRlcnByZXRlclZlcnNpb25TZXJ2aWNlKTtcbiAgICAgICAgdGhpcy5leGVjdXRpb25GYWN0b3J5ID0gc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JUHl0aG9uRXhlY3V0aW9uRmFjdG9yeSk7XG4gICAgfVxuICAgIHVwZGF0ZVB5dGhvblBhdGgocHl0aG9uUGF0aCwgY29uZmlnVGFyZ2V0LCB0cmlnZ2VyLCB3a3NwYWNlKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBzdG9wV2F0Y2ggPSBuZXcgc3RvcFdhdGNoXzEuU3RvcFdhdGNoKCk7XG4gICAgICAgICAgICBjb25zdCBweXRob25QYXRoVXBkYXRlciA9IHRoaXMuZ2V0UHl0aG9uVXBkYXRlclNlcnZpY2UoY29uZmlnVGFyZ2V0LCB3a3NwYWNlKTtcbiAgICAgICAgICAgIGxldCBmYWlsZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgeWllbGQgcHl0aG9uUGF0aFVwZGF0ZXIudXBkYXRlUHl0aG9uUGF0aChwYXRoLm5vcm1hbGl6ZShweXRob25QYXRoKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXRjaCAocmVhc29uKSB7XG4gICAgICAgICAgICAgICAgZmFpbGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tdW5zYWZlLWFueSBwcmVmZXItdHlwZS1jYXN0XG4gICAgICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IHJlYXNvbiAmJiB0eXBlb2YgcmVhc29uLm1lc3NhZ2UgPT09ICdzdHJpbmcnID8gcmVhc29uLm1lc3NhZ2UgOiAnJztcbiAgICAgICAgICAgICAgICB2c2NvZGVfMS53aW5kb3cuc2hvd0Vycm9yTWVzc2FnZShgRmFpbGVkIHRvIHNldCAncHl0aG9uUGF0aCcuIEVycm9yOiAke21lc3NhZ2V9YCk7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihyZWFzb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gZG8gbm90IHdhaXQgZm9yIHRoaXMgdG8gY29tcGxldGVcbiAgICAgICAgICAgIHRoaXMuc2VuZFRlbGVtZXRyeShzdG9wV2F0Y2guZWxhcHNlZFRpbWUsIGZhaWxlZCwgdHJpZ2dlciwgcHl0aG9uUGF0aClcbiAgICAgICAgICAgICAgICAuY2F0Y2goZXggPT4gY29uc29sZS5lcnJvcignUHl0aG9uIEV4dGVuc2lvbjogc2VuZFRlbGVtZXRyeScsIGV4KSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBzZW5kVGVsZW1ldHJ5KGR1cmF0aW9uLCBmYWlsZWQsIHRyaWdnZXIsIHB5dGhvblBhdGgpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IHRlbGVtdHJ5UHJvcGVydGllcyA9IHtcbiAgICAgICAgICAgICAgICBmYWlsZWQsIHRyaWdnZXJcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBpZiAoIWZhaWxlZCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHByb2Nlc3NTZXJ2aWNlID0geWllbGQgdGhpcy5leGVjdXRpb25GYWN0b3J5LmNyZWF0ZSh7IHB5dGhvblBhdGggfSk7XG4gICAgICAgICAgICAgICAgY29uc3QgaW5mb1Byb21pc2UgPSBwcm9jZXNzU2VydmljZS5nZXRJbnRlcnByZXRlckluZm9ybWF0aW9uKClcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKCgpID0+IHVuZGVmaW5lZCk7XG4gICAgICAgICAgICAgICAgY29uc3QgcGlwVmVyc2lvblByb21pc2UgPSB0aGlzLmludGVycHJldGVyVmVyc2lvblNlcnZpY2UuZ2V0UGlwVmVyc2lvbihweXRob25QYXRoKVxuICAgICAgICAgICAgICAgICAgICAudGhlbih2YWx1ZSA9PiB2YWx1ZS5sZW5ndGggPT09IDAgPyB1bmRlZmluZWQgOiB2YWx1ZSlcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKCgpID0+ICcnKTtcbiAgICAgICAgICAgICAgICBjb25zdCBbaW5mbywgcGlwVmVyc2lvbl0gPSB5aWVsZCBQcm9taXNlLmFsbChbaW5mb1Byb21pc2UsIHBpcFZlcnNpb25Qcm9taXNlXSk7XG4gICAgICAgICAgICAgICAgaWYgKGluZm8pIHtcbiAgICAgICAgICAgICAgICAgICAgdGVsZW10cnlQcm9wZXJ0aWVzLnB5dGhvblZlcnNpb24gPSBpbmZvLnZlcnNpb25faW5mby5qb2luKCcuJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChwaXBWZXJzaW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHRlbGVtdHJ5UHJvcGVydGllcy5waXBWZXJzaW9uID0gcGlwVmVyc2lvbjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0ZWxlbWV0cnlfMS5zZW5kVGVsZW1ldHJ5RXZlbnQoY29uc3RhbnRzXzEuUFlUSE9OX0lOVEVSUFJFVEVSLCBkdXJhdGlvbiwgdGVsZW10cnlQcm9wZXJ0aWVzKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGdldFB5dGhvblVwZGF0ZXJTZXJ2aWNlKGNvbmZpZ1RhcmdldCwgd2tzcGFjZSkge1xuICAgICAgICBzd2l0Y2ggKGNvbmZpZ1RhcmdldCkge1xuICAgICAgICAgICAgY2FzZSB2c2NvZGVfMS5Db25maWd1cmF0aW9uVGFyZ2V0Lkdsb2JhbDoge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnB5dGhvblBhdGhTZXR0aW5nc1VwZGF0ZXJGYWN0b3J5LmdldEdsb2JhbFB5dGhvblBhdGhDb25maWd1cmF0aW9uU2VydmljZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2FzZSB2c2NvZGVfMS5Db25maWd1cmF0aW9uVGFyZ2V0LldvcmtzcGFjZToge1xuICAgICAgICAgICAgICAgIGlmICghd2tzcGFjZSkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1dvcmtzcGFjZSBVcmkgbm90IGRlZmluZWQnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLW5vbi1udWxsLWFzc2VydGlvblxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnB5dGhvblBhdGhTZXR0aW5nc1VwZGF0ZXJGYWN0b3J5LmdldFdvcmtzcGFjZVB5dGhvblBhdGhDb25maWd1cmF0aW9uU2VydmljZSh3a3NwYWNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRlZmF1bHQ6IHtcbiAgICAgICAgICAgICAgICBpZiAoIXdrc3BhY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdXb3Jrc3BhY2UgVXJpIG5vdCBkZWZpbmVkJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5weXRob25QYXRoU2V0dGluZ3NVcGRhdGVyRmFjdG9yeS5nZXRXb3Jrc3BhY2VGb2xkZXJQeXRob25QYXRoQ29uZmlndXJhdGlvblNlcnZpY2Uod2tzcGFjZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59O1xuUHl0aG9uUGF0aFVwZGF0ZXJTZXJ2aWNlID0gX19kZWNvcmF0ZShbXG4gICAgaW52ZXJzaWZ5XzEuaW5qZWN0YWJsZSgpLFxuICAgIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzIuSVNlcnZpY2VDb250YWluZXIpKVxuXSwgUHl0aG9uUGF0aFVwZGF0ZXJTZXJ2aWNlKTtcbmV4cG9ydHMuUHl0aG9uUGF0aFVwZGF0ZXJTZXJ2aWNlID0gUHl0aG9uUGF0aFVwZGF0ZXJTZXJ2aWNlO1xuLy8jIHNvdXJjZU1hcHBpbmdVUkw9cHl0aG9uUGF0aFVwZGF0ZXJTZXJ2aWNlLmpzLm1hcCJdfQ==