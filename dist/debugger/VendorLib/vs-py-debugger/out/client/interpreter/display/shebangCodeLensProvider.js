"use strict";

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const vscode_1 = require("vscode");

const settings = require("../../common/configSettings");

const types_1 = require("../../common/process/types");

const util_1 = require("../../common/util");

const types_2 = require("../../ioc/types");

let ShebangCodeLensProvider = class ShebangCodeLensProvider {
  constructor(serviceContainer) {
    // tslint:disable-next-line:no-any
    this.onDidChangeCodeLenses = vscode_1.workspace.onDidChangeConfiguration;
    this.processServiceFactory = serviceContainer.get(types_1.IProcessServiceFactory);
  }

  detectShebang(document) {
    return __awaiter(this, void 0, void 0, function* () {
      const firstLine = document.lineAt(0);

      if (firstLine.isEmptyOrWhitespace) {
        return;
      }

      if (!firstLine.text.startsWith('#!')) {
        return;
      }

      const shebang = firstLine.text.substr(2).trim();
      const pythonPath = yield this.getFullyQualifiedPathToInterpreter(shebang, document.uri);
      return typeof pythonPath === 'string' && pythonPath.length > 0 ? pythonPath : undefined;
    });
  }

  provideCodeLenses(document, token) {
    return __awaiter(this, void 0, void 0, function* () {
      const codeLenses = yield this.createShebangCodeLens(document);
      return Promise.resolve(codeLenses);
    });
  }

  getFullyQualifiedPathToInterpreter(pythonPath, resource) {
    return __awaiter(this, void 0, void 0, function* () {
      let cmdFile = pythonPath;
      let args = ['-c', 'import sys;print(sys.executable)'];

      if (pythonPath.indexOf('bin/env ') >= 0 && !util_1.IS_WINDOWS) {
        // In case we have pythonPath as '/usr/bin/env python'.
        const parts = pythonPath.split(' ').map(part => part.trim()).filter(part => part.length > 0);
        cmdFile = parts.shift();
        args = parts.concat(args);
      }

      const processService = yield this.processServiceFactory.create(resource);
      return processService.exec(cmdFile, args).then(output => output.stdout.trim()).catch(() => '');
    });
  }

  createShebangCodeLens(document) {
    return __awaiter(this, void 0, void 0, function* () {
      const shebang = yield this.detectShebang(document);
      const pythonPath = settings.PythonSettings.getInstance(document.uri).pythonPath;
      const resolvedPythonPath = yield this.getFullyQualifiedPathToInterpreter(pythonPath, document.uri);

      if (!shebang || shebang === resolvedPythonPath) {
        return [];
      }

      const firstLine = document.lineAt(0);
      const startOfShebang = new vscode_1.Position(0, 0);
      const endOfShebang = new vscode_1.Position(0, firstLine.text.length - 1);
      const shebangRange = new vscode_1.Range(startOfShebang, endOfShebang);
      const cmd = {
        command: 'python.setShebangInterpreter',
        title: 'Set as interpreter'
      };
      return [new vscode_1.CodeLens(shebangRange, cmd)];
    });
  }

};
ShebangCodeLensProvider = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_2.IServiceContainer))], ShebangCodeLensProvider);
exports.ShebangCodeLensProvider = ShebangCodeLensProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNoZWJhbmdDb2RlTGVuc1Byb3ZpZGVyLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsIl9fcGFyYW0iLCJwYXJhbUluZGV4IiwiZGVjb3JhdG9yIiwiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsImV4cG9ydHMiLCJpbnZlcnNpZnlfMSIsInJlcXVpcmUiLCJ2c2NvZGVfMSIsInNldHRpbmdzIiwidHlwZXNfMSIsInV0aWxfMSIsInR5cGVzXzIiLCJTaGViYW5nQ29kZUxlbnNQcm92aWRlciIsImNvbnN0cnVjdG9yIiwic2VydmljZUNvbnRhaW5lciIsIm9uRGlkQ2hhbmdlQ29kZUxlbnNlcyIsIndvcmtzcGFjZSIsIm9uRGlkQ2hhbmdlQ29uZmlndXJhdGlvbiIsInByb2Nlc3NTZXJ2aWNlRmFjdG9yeSIsImdldCIsIklQcm9jZXNzU2VydmljZUZhY3RvcnkiLCJkZXRlY3RTaGViYW5nIiwiZG9jdW1lbnQiLCJmaXJzdExpbmUiLCJsaW5lQXQiLCJpc0VtcHR5T3JXaGl0ZXNwYWNlIiwidGV4dCIsInN0YXJ0c1dpdGgiLCJzaGViYW5nIiwic3Vic3RyIiwidHJpbSIsInB5dGhvblBhdGgiLCJnZXRGdWxseVF1YWxpZmllZFBhdGhUb0ludGVycHJldGVyIiwidXJpIiwidW5kZWZpbmVkIiwicHJvdmlkZUNvZGVMZW5zZXMiLCJ0b2tlbiIsImNvZGVMZW5zZXMiLCJjcmVhdGVTaGViYW5nQ29kZUxlbnMiLCJyZXNvdXJjZSIsImNtZEZpbGUiLCJhcmdzIiwiaW5kZXhPZiIsIklTX1dJTkRPV1MiLCJwYXJ0cyIsInNwbGl0IiwibWFwIiwicGFydCIsImZpbHRlciIsInNoaWZ0IiwiY29uY2F0IiwicHJvY2Vzc1NlcnZpY2UiLCJjcmVhdGUiLCJleGVjIiwib3V0cHV0Iiwic3Rkb3V0IiwiY2F0Y2giLCJQeXRob25TZXR0aW5ncyIsImdldEluc3RhbmNlIiwicmVzb2x2ZWRQeXRob25QYXRoIiwic3RhcnRPZlNoZWJhbmciLCJQb3NpdGlvbiIsImVuZE9mU2hlYmFuZyIsInNoZWJhbmdSYW5nZSIsIlJhbmdlIiwiY21kIiwiY29tbWFuZCIsInRpdGxlIiwiQ29kZUxlbnMiLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSVNlcnZpY2VDb250YWluZXIiXSwibWFwcGluZ3MiOiJBQUFBOztBQUNBLElBQUlBLFVBQVUsR0FBSSxVQUFRLFNBQUtBLFVBQWQsSUFBNkIsVUFBVUMsVUFBVixFQUFzQkMsTUFBdEIsRUFBOEJDLEdBQTlCLEVBQW1DQyxJQUFuQyxFQUF5QztBQUNuRixNQUFJQyxDQUFDLEdBQUdDLFNBQVMsQ0FBQ0MsTUFBbEI7QUFBQSxNQUEwQkMsQ0FBQyxHQUFHSCxDQUFDLEdBQUcsQ0FBSixHQUFRSCxNQUFSLEdBQWlCRSxJQUFJLEtBQUssSUFBVCxHQUFnQkEsSUFBSSxHQUFHSyxNQUFNLENBQUNDLHdCQUFQLENBQWdDUixNQUFoQyxFQUF3Q0MsR0FBeEMsQ0FBdkIsR0FBc0VDLElBQXJIO0FBQUEsTUFBMkhPLENBQTNIO0FBQ0EsTUFBSSxPQUFPQyxPQUFQLEtBQW1CLFFBQW5CLElBQStCLE9BQU9BLE9BQU8sQ0FBQ0MsUUFBZixLQUE0QixVQUEvRCxFQUEyRUwsQ0FBQyxHQUFHSSxPQUFPLENBQUNDLFFBQVIsQ0FBaUJaLFVBQWpCLEVBQTZCQyxNQUE3QixFQUFxQ0MsR0FBckMsRUFBMENDLElBQTFDLENBQUosQ0FBM0UsS0FDSyxLQUFLLElBQUlV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QW1DRSxZQUFuQyxDQUFyQjtBQUNBLFlBQU1HLEdBQUcsR0FBRztBQUNSQyxRQUFBQSxPQUFPLEVBQUUsOEJBREQ7QUFFUkMsUUFBQUEsS0FBSyxFQUFFO0FBRkMsT0FBWjtBQUlBLGFBQU8sQ0FBRSxJQUFJNUQsUUFBUSxDQUFDNkQsUUFBYixDQUFzQkwsWUFBdEIsRUFBb0NFLEdBQXBDLENBQUYsQ0FBUDtBQUNILEtBaEJlLENBQWhCO0FBaUJIOztBQTVEdUQsQ0FBNUQ7QUE4REFyRCx1QkFBdUIsR0FBRzdDLFVBQVUsQ0FBQyxDQUNqQ3NDLFdBQVcsQ0FBQ2dFLFVBQVosRUFEaUMsRUFFakN0RixPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDaUUsTUFBWixDQUFtQjNELE9BQU8sQ0FBQzRELGlCQUEzQixDQUFKLENBRjBCLENBQUQsRUFHakMzRCx1QkFIaUMsQ0FBcEM7QUFJQVIsT0FBTyxDQUFDUSx1QkFBUixHQUFrQ0EsdUJBQWxDIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XG4gICAgdmFyIGMgPSBhcmd1bWVudHMubGVuZ3RoLCByID0gYyA8IDMgPyB0YXJnZXQgOiBkZXNjID09PSBudWxsID8gZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpIDogZGVzYywgZDtcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XG4gICAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjtcbn07XG52YXIgX19wYXJhbSA9ICh0aGlzICYmIHRoaXMuX19wYXJhbSkgfHwgZnVuY3Rpb24gKHBhcmFtSW5kZXgsIGRlY29yYXRvcikge1xuICAgIHJldHVybiBmdW5jdGlvbiAodGFyZ2V0LCBrZXkpIHsgZGVjb3JhdG9yKHRhcmdldCwga2V5LCBwYXJhbUluZGV4KTsgfVxufTtcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XG4gICAgfSk7XG59O1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuY29uc3QgaW52ZXJzaWZ5XzEgPSByZXF1aXJlKFwiaW52ZXJzaWZ5XCIpO1xuY29uc3QgdnNjb2RlXzEgPSByZXF1aXJlKFwidnNjb2RlXCIpO1xuY29uc3Qgc2V0dGluZ3MgPSByZXF1aXJlKFwiLi4vLi4vY29tbW9uL2NvbmZpZ1NldHRpbmdzXCIpO1xuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jb21tb24vcHJvY2Vzcy90eXBlc1wiKTtcbmNvbnN0IHV0aWxfMSA9IHJlcXVpcmUoXCIuLi8uLi9jb21tb24vdXRpbFwiKTtcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vLi4vaW9jL3R5cGVzXCIpO1xubGV0IFNoZWJhbmdDb2RlTGVuc1Byb3ZpZGVyID0gY2xhc3MgU2hlYmFuZ0NvZGVMZW5zUHJvdmlkZXIge1xuICAgIGNvbnN0cnVjdG9yKHNlcnZpY2VDb250YWluZXIpIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWFueVxuICAgICAgICB0aGlzLm9uRGlkQ2hhbmdlQ29kZUxlbnNlcyA9IHZzY29kZV8xLndvcmtzcGFjZS5vbkRpZENoYW5nZUNvbmZpZ3VyYXRpb247XG4gICAgICAgIHRoaXMucHJvY2Vzc1NlcnZpY2VGYWN0b3J5ID0gc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JUHJvY2Vzc1NlcnZpY2VGYWN0b3J5KTtcbiAgICB9XG4gICAgZGV0ZWN0U2hlYmFuZyhkb2N1bWVudCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgZmlyc3RMaW5lID0gZG9jdW1lbnQubGluZUF0KDApO1xuICAgICAgICAgICAgaWYgKGZpcnN0TGluZS5pc0VtcHR5T3JXaGl0ZXNwYWNlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFmaXJzdExpbmUudGV4dC5zdGFydHNXaXRoKCcjIScpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3Qgc2hlYmFuZyA9IGZpcnN0TGluZS50ZXh0LnN1YnN0cigyKS50cmltKCk7XG4gICAgICAgICAgICBjb25zdCBweXRob25QYXRoID0geWllbGQgdGhpcy5nZXRGdWxseVF1YWxpZmllZFBhdGhUb0ludGVycHJldGVyKHNoZWJhbmcsIGRvY3VtZW50LnVyaSk7XG4gICAgICAgICAgICByZXR1cm4gdHlwZW9mIHB5dGhvblBhdGggPT09ICdzdHJpbmcnICYmIHB5dGhvblBhdGgubGVuZ3RoID4gMCA/IHB5dGhvblBhdGggOiB1bmRlZmluZWQ7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBwcm92aWRlQ29kZUxlbnNlcyhkb2N1bWVudCwgdG9rZW4pIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IGNvZGVMZW5zZXMgPSB5aWVsZCB0aGlzLmNyZWF0ZVNoZWJhbmdDb2RlTGVucyhkb2N1bWVudCk7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGNvZGVMZW5zZXMpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgZ2V0RnVsbHlRdWFsaWZpZWRQYXRoVG9JbnRlcnByZXRlcihweXRob25QYXRoLCByZXNvdXJjZSkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgbGV0IGNtZEZpbGUgPSBweXRob25QYXRoO1xuICAgICAgICAgICAgbGV0IGFyZ3MgPSBbJy1jJywgJ2ltcG9ydCBzeXM7cHJpbnQoc3lzLmV4ZWN1dGFibGUpJ107XG4gICAgICAgICAgICBpZiAocHl0aG9uUGF0aC5pbmRleE9mKCdiaW4vZW52ICcpID49IDAgJiYgIXV0aWxfMS5JU19XSU5ET1dTKSB7XG4gICAgICAgICAgICAgICAgLy8gSW4gY2FzZSB3ZSBoYXZlIHB5dGhvblBhdGggYXMgJy91c3IvYmluL2VudiBweXRob24nLlxuICAgICAgICAgICAgICAgIGNvbnN0IHBhcnRzID0gcHl0aG9uUGF0aC5zcGxpdCgnICcpLm1hcChwYXJ0ID0+IHBhcnQudHJpbSgpKS5maWx0ZXIocGFydCA9PiBwYXJ0Lmxlbmd0aCA+IDApO1xuICAgICAgICAgICAgICAgIGNtZEZpbGUgPSBwYXJ0cy5zaGlmdCgpO1xuICAgICAgICAgICAgICAgIGFyZ3MgPSBwYXJ0cy5jb25jYXQoYXJncyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBwcm9jZXNzU2VydmljZSA9IHlpZWxkIHRoaXMucHJvY2Vzc1NlcnZpY2VGYWN0b3J5LmNyZWF0ZShyZXNvdXJjZSk7XG4gICAgICAgICAgICByZXR1cm4gcHJvY2Vzc1NlcnZpY2UuZXhlYyhjbWRGaWxlLCBhcmdzKVxuICAgICAgICAgICAgICAgIC50aGVuKG91dHB1dCA9PiBvdXRwdXQuc3Rkb3V0LnRyaW0oKSlcbiAgICAgICAgICAgICAgICAuY2F0Y2goKCkgPT4gJycpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgY3JlYXRlU2hlYmFuZ0NvZGVMZW5zKGRvY3VtZW50KSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBzaGViYW5nID0geWllbGQgdGhpcy5kZXRlY3RTaGViYW5nKGRvY3VtZW50KTtcbiAgICAgICAgICAgIGNvbnN0IHB5dGhvblBhdGggPSBzZXR0aW5ncy5QeXRob25TZXR0aW5ncy5nZXRJbnN0YW5jZShkb2N1bWVudC51cmkpLnB5dGhvblBhdGg7XG4gICAgICAgICAgICBjb25zdCByZXNvbHZlZFB5dGhvblBhdGggPSB5aWVsZCB0aGlzLmdldEZ1bGx5UXVhbGlmaWVkUGF0aFRvSW50ZXJwcmV0ZXIocHl0aG9uUGF0aCwgZG9jdW1lbnQudXJpKTtcbiAgICAgICAgICAgIGlmICghc2hlYmFuZyB8fCBzaGViYW5nID09PSByZXNvbHZlZFB5dGhvblBhdGgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gW107XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBmaXJzdExpbmUgPSBkb2N1bWVudC5saW5lQXQoMCk7XG4gICAgICAgICAgICBjb25zdCBzdGFydE9mU2hlYmFuZyA9IG5ldyB2c2NvZGVfMS5Qb3NpdGlvbigwLCAwKTtcbiAgICAgICAgICAgIGNvbnN0IGVuZE9mU2hlYmFuZyA9IG5ldyB2c2NvZGVfMS5Qb3NpdGlvbigwLCBmaXJzdExpbmUudGV4dC5sZW5ndGggLSAxKTtcbiAgICAgICAgICAgIGNvbnN0IHNoZWJhbmdSYW5nZSA9IG5ldyB2c2NvZGVfMS5SYW5nZShzdGFydE9mU2hlYmFuZywgZW5kT2ZTaGViYW5nKTtcbiAgICAgICAgICAgIGNvbnN0IGNtZCA9IHtcbiAgICAgICAgICAgICAgICBjb21tYW5kOiAncHl0aG9uLnNldFNoZWJhbmdJbnRlcnByZXRlcicsXG4gICAgICAgICAgICAgICAgdGl0bGU6ICdTZXQgYXMgaW50ZXJwcmV0ZXInXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcmV0dXJuIFsobmV3IHZzY29kZV8xLkNvZGVMZW5zKHNoZWJhbmdSYW5nZSwgY21kKSldO1xuICAgICAgICB9KTtcbiAgICB9XG59O1xuU2hlYmFuZ0NvZGVMZW5zUHJvdmlkZXIgPSBfX2RlY29yYXRlKFtcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKCksXG4gICAgX19wYXJhbSgwLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMi5JU2VydmljZUNvbnRhaW5lcikpXG5dLCBTaGViYW5nQ29kZUxlbnNQcm92aWRlcik7XG5leHBvcnRzLlNoZWJhbmdDb2RlTGVuc1Byb3ZpZGVyID0gU2hlYmFuZ0NvZGVMZW5zUHJvdmlkZXI7XG4vLyMgc291cmNlTWFwcGluZ1VSTD1zaGViYW5nQ29kZUxlbnNQcm92aWRlci5qcy5tYXAiXX0=