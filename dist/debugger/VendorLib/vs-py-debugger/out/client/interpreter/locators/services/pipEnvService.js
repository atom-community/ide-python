"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const path = require("path");

const vscode_1 = require("vscode");

const types_1 = require("../../../common/application/types");

const types_2 = require("../../../common/platform/types");

const types_3 = require("../../../common/process/types");

const types_4 = require("../../../common/types");

const types_5 = require("../../../ioc/types");

const contracts_1 = require("../../contracts");

const cacheableLocatorService_1 = require("./cacheableLocatorService");

const execName = 'pipenv';
const pipEnvFileNameVariable = 'PIPENV_PIPFILE';
let PipEnvService = class PipEnvService extends cacheableLocatorService_1.CacheableLocatorService {
  constructor(serviceContainer) {
    super('PipEnvService', serviceContainer);
    this.helper = this.serviceContainer.get(contracts_1.IInterpreterHelper);
    this.processServiceFactory = this.serviceContainer.get(types_3.IProcessServiceFactory);
    this.workspace = this.serviceContainer.get(types_1.IWorkspaceService);
    this.fs = this.serviceContainer.get(types_2.IFileSystem);
    this.logger = this.serviceContainer.get(types_4.ILogger);
  } // tslint:disable-next-line:no-empty


  dispose() {}

  isRelatedPipEnvironment(dir, pythonPath) {
    return __awaiter(this, void 0, void 0, function* () {
      // In PipEnv, the name of the cwd is used as a prefix in the virtual env.
      if (pythonPath.indexOf(`${path.sep}${path.basename(dir)}-`) === -1) {
        return false;
      }

      const envName = yield this.getInterpreterPathFromPipenv(dir, true);
      return !!envName;
    });
  }

  getInterpretersImplementation(resource) {
    const pipenvCwd = this.getPipenvWorkingDirectory(resource);

    if (!pipenvCwd) {
      return Promise.resolve([]);
    }

    return this.getInterpreterFromPipenv(pipenvCwd).then(item => item ? [item] : []).catch(() => []);
  }

  getInterpreterFromPipenv(pipenvCwd) {
    return __awaiter(this, void 0, void 0, function* () {
      const interpreterPath = yield this.getInterpreterPathFromPipenv(pipenvCwd);

      if (!interpreterPath) {
        return;
      }

      const details = yield this.helper.getInterpreterInformation(interpreterPath);

      if (!details) {
        return;
      }

      return Object.assign({}, details, {
        path: interpreterPath,
        type: contracts_1.InterpreterType.PipEnv
      });
    });
  }

  getPipenvWorkingDirectory(resource) {
    // The file is not in a workspace. However, workspace may be opened
    // and file is just a random file opened from elsewhere. In this case
    // we still want to provide interpreter associated with the workspace.
    // Otherwise if user tries and formats the file, we may end up using
    // plain pip module installer to bring in the formatter and it is wrong.
    const wsFolder = resource ? this.workspace.getWorkspaceFolder(resource) : undefined;
    return wsFolder ? wsFolder.uri.fsPath : this.workspace.rootPath;
  }

  getInterpreterPathFromPipenv(cwd, ignoreErrors = false) {
    return __awaiter(this, void 0, void 0, function* () {
      // Quick check before actually running pipenv
      if (!(yield this.checkIfPipFileExists(cwd))) {
        return;
      }

      try {
        const pythonPath = yield this.invokePipenv('--py', cwd); // TODO: Why do we need to do this?

        return pythonPath && (yield this.fs.fileExists(pythonPath)) ? pythonPath : undefined; // tslint:disable-next-line:no-empty
      } catch (error) {
        console.error(error);

        if (ignoreErrors) {
          return;
        }

        const errorMessage = error.message || error;
        const appShell = this.serviceContainer.get(types_1.IApplicationShell);
        appShell.showWarningMessage(`Workspace contains pipfile but attempt to run 'pipenv --py' failed with ${errorMessage}. Make sure pipenv is on the PATH.`);
      }
    });
  }

  checkIfPipFileExists(cwd) {
    return __awaiter(this, void 0, void 0, function* () {
      const currentProcess = this.serviceContainer.get(types_4.ICurrentProcess);
      const pipFileName = currentProcess.env[pipEnvFileNameVariable];

      if (typeof pipFileName === 'string' && (yield this.fs.fileExists(path.join(cwd, pipFileName)))) {
        return true;
      }

      if (yield this.fs.fileExists(path.join(cwd, 'Pipfile'))) {
        return true;
      }

      return false;
    });
  }

  invokePipenv(arg, rootPath) {
    return __awaiter(this, void 0, void 0, function* () {
      try {
        const processService = yield this.processServiceFactory.create(vscode_1.Uri.file(rootPath));
        const result = yield processService.exec(execName, [arg], {
          cwd: rootPath
        });

        if (result) {
          const stdout = result.stdout ? result.stdout.trim() : '';
          const stderr = result.stderr ? result.stderr.trim() : '';

          if (stderr.length > 0 && stdout.length === 0) {
            throw new Error(stderr);
          }

          return stdout;
        } // tslint:disable-next-line:no-empty

      } catch (error) {
        const platformService = this.serviceContainer.get(types_2.IPlatformService);
        const currentProc = this.serviceContainer.get(types_4.ICurrentProcess);
        const enviromentVariableValues = {
          LC_ALL: currentProc.env.LC_ALL,
          LANG: currentProc.env.LANG
        };
        enviromentVariableValues[platformService.pathVariableName] = currentProc.env[platformService.pathVariableName];
        this.logger.logWarning('Error in invoking PipEnv', error);
        this.logger.logWarning(`Relevant Environment Variables ${JSON.stringify(enviromentVariableValues, undefined, 4)}`);
        const errorMessage = error.message || error;
        const appShell = this.serviceContainer.get(types_1.IApplicationShell);
        appShell.showWarningMessage(`Workspace contains pipfile but attempt to run 'pipenv --venv' failed with '${errorMessage}'. Make sure pipenv is on the PATH.`);
      }
    });
  }

};
PipEnvService = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_5.IServiceContainer))], PipEnvService);
exports.PipEnvService = PipEnvService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBpcEVudlNlcnZpY2UuanMiXSwibmFtZXMiOlsiX19kZWNvcmF0ZSIsImRlY29yYXRvcnMiLCJ0YXJnZXQiLCJrZXkiLCJkZXNjIiwiYyIsImFyZ3VtZW50cyIsImxlbmd0aCIsInIiLCJPYmplY3QiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJkIiwiUmVmbGVjdCIsImRlY29yYXRlIiwiaSIsImRlZmluZVByb3BlcnR5IiwiX19wYXJhbSIsInBhcmFtSW5kZXgiLCJkZWNvcmF0b3IiLCJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiZXhwb3J0cyIsImludmVyc2lmeV8xIiwicmVxdWlyZSIsInBhdGgiLCJ2c2NvZGVfMSIsInR5cGVzXzEiLCJ0eXBlc18yIiwidHlwZXNfMyIsInR5cGVzXzQiLCJ0eXBlc181IiwiY29udHJhY3RzXzEiLCJjYWNoZWFibGVMb2NhdG9yU2VydmljZV8xIiwiZXhlY05hbWUiLCJwaXBFbnZGaWxlTmFtZVZhcmlhYmxlIiwiUGlwRW52U2VydmljZSIsIkNhY2hlYWJsZUxvY2F0b3JTZXJ2aWNlIiwiY29uc3RydWN0b3IiLCJzZXJ2aWNlQ29udGFpbmVyIiwiaGVscGVyIiwiZ2V0IiwiSUludGVycHJldGVySGVscGVyIiwicHJvY2Vzc1NlcnZpY2VGYWN0b3J5IiwiSVByb2Nlc3NTZXJ2aWNlRmFjdG9yeSIsIndvcmtzcGFjZSIsIklXb3Jrc3BhY2VTZXJ2aWNlIiwiZnMiLCJJRmlsZVN5c3RlbSIsImxvZ2dlciIsIklMb2dnZXIiLCJkaXNwb3NlIiwiaXNSZWxhdGVkUGlwRW52aXJvbm1lbnQiLCJkaXIiLCJweXRob25QYXRoIiwiaW5kZXhPZiIsInNlcCIsImJhc2VuYW1lIiwiZW52TmFtZSIsImdldEludGVycHJldGVyUGF0aEZyb21QaXBlbnYiLCJnZXRJbnRlcnByZXRlcnNJbXBsZW1lbnRhdGlvbiIsInJlc291cmNlIiwicGlwZW52Q3dkIiwiZ2V0UGlwZW52V29ya2luZ0RpcmVjdG9yeSIsImdldEludGVycHJldGVyRnJvbVBpcGVudiIsIml0ZW0iLCJjYXRjaCIsImludGVycHJldGVyUGF0aCIsImRldGFpbHMiLCJnZXRJbnRlcnByZXRlckluZm9ybWF0aW9uIiwiYXNzaWduIiwidHlwZSIsIkludGVycHJldGVyVHlwZSIsIlBpcEVudiIsIndzRm9sZGVyIiwiZ2V0V29ya3NwYWNlRm9sZGVyIiwidW5kZWZpbmVkIiwidXJpIiwiZnNQYXRoIiwicm9vdFBhdGgiLCJjd2QiLCJpZ25vcmVFcnJvcnMiLCJjaGVja0lmUGlwRmlsZUV4aXN0cyIsImludm9rZVBpcGVudiIsImZpbGVFeGlzdHMiLCJlcnJvciIsImNvbnNvbGUiLCJlcnJvck1lc3NhZ2UiLCJtZXNzYWdlIiwiYXBwU2hlbGwiLCJJQXBwbGljYXRpb25TaGVsbCIsInNob3dXYXJuaW5nTWVzc2FnZSIsImN1cnJlbnRQcm9jZXNzIiwiSUN1cnJlbnRQcm9jZXNzIiwicGlwRmlsZU5hbWUiLCJlbnYiLCJqb2luIiwiYXJnIiwicHJvY2Vzc1NlcnZpY2UiLCJjcmVhdGUiLCJVcmkiLCJmaWxlIiwiZXhlYyIsInN0ZG91dCIsInRyaW0iLCJzdGRlcnIiLCJFcnJvciIsInBsYXRmb3JtU2VydmljZSIsIklQbGF0Zm9ybVNlcnZpY2UiLCJjdXJyZW50UHJvYyIsImVudmlyb21lbnRWYXJpYWJsZVZhbHVlcyIsIkxDX0FMTCIsIkxBTkciLCJwYXRoVmFyaWFibGVOYW1lIiwibG9nV2FybmluZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSVNlcnZpY2VDb250YWluZXIiXSwibWFwcGluZ3MiOiJBQUFBLGEsQ0FDQTtBQUNBOztBQUNBLElBQUlBLFVBQVUsR0FBSSxVQUFRLFNBQUtBLFVB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QWlDQyxJQUFJLENBQUNDLFNBQUwsQ0FBZU4sd0JBQWYsRUFBeUNsQyxTQUF6QyxFQUFvRCxDQUFwRCxDQUF1RCxFQUFoSDtBQUNBLGNBQU1XLFlBQVksR0FBR0YsS0FBSyxDQUFDRyxPQUFOLElBQWlCSCxLQUF0QztBQUNBLGNBQU1JLFFBQVEsR0FBRyxLQUFLbEQsZ0JBQUwsQ0FBc0JFLEdBQXRCLENBQTBCZCxPQUFPLENBQUMrRCxpQkFBbEMsQ0FBakI7QUFDQUQsUUFBQUEsUUFBUSxDQUFDRSxrQkFBVCxDQUE2Qiw4RUFBNkVKLFlBQWEscUNBQXZIO0FBQ0g7QUFDSixLQTVCZSxDQUFoQjtBQTZCSDs7QUF0SDZGLENBQWxHO0FBd0hBbkQsYUFBYSxHQUFHbkQsVUFBVSxDQUFDLENBQ3ZCc0MsV0FBVyxDQUFDOEYsVUFBWixFQUR1QixFQUV2QnBILE9BQU8sQ0FBQyxDQUFELEVBQUlzQixXQUFXLENBQUMrRixNQUFaLENBQW1CdkYsT0FBTyxDQUFDd0YsaUJBQTNCLENBQUosQ0FGZ0IsQ0FBRCxFQUd2Qm5GLGFBSHVCLENBQTFCO0FBSUFkLE9BQU8sQ0FBQ2MsYUFBUixHQUF3QkEsYUFBeEIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxudmFyIF9fZGVjb3JhdGUgPSAodGhpcyAmJiB0aGlzLl9fZGVjb3JhdGUpIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcbiAgICBlbHNlIGZvciAodmFyIGkgPSBkZWNvcmF0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBpZiAoZCA9IGRlY29yYXRvcnNbaV0pIHIgPSAoYyA8IDMgPyBkKHIpIDogYyA+IDMgPyBkKHRhcmdldCwga2V5LCByKSA6IGQodGFyZ2V0LCBrZXkpKSB8fCByO1xuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XG59O1xudmFyIF9fcGFyYW0gPSAodGhpcyAmJiB0aGlzLl9fcGFyYW0pIHx8IGZ1bmN0aW9uIChwYXJhbUluZGV4LCBkZWNvcmF0b3IpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7IGRlY29yYXRvcih0YXJnZXQsIGtleSwgcGFyYW1JbmRleCk7IH1cbn07XG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xuICAgIH0pO1xufTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbmNvbnN0IGludmVyc2lmeV8xID0gcmVxdWlyZShcImludmVyc2lmeVwiKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY29tbW9uL2FwcGxpY2F0aW9uL3R5cGVzXCIpO1xuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jb21tb24vcGxhdGZvcm0vdHlwZXNcIik7XG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4uLy4uLy4uL2NvbW1vbi9wcm9jZXNzL3R5cGVzXCIpO1xuY29uc3QgdHlwZXNfNCA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jb21tb24vdHlwZXNcIik7XG5jb25zdCB0eXBlc181ID0gcmVxdWlyZShcIi4uLy4uLy4uL2lvYy90eXBlc1wiKTtcbmNvbnN0IGNvbnRyYWN0c18xID0gcmVxdWlyZShcIi4uLy4uL2NvbnRyYWN0c1wiKTtcbmNvbnN0IGNhY2hlYWJsZUxvY2F0b3JTZXJ2aWNlXzEgPSByZXF1aXJlKFwiLi9jYWNoZWFibGVMb2NhdG9yU2VydmljZVwiKTtcbmNvbnN0IGV4ZWNOYW1lID0gJ3BpcGVudic7XG5jb25zdCBwaXBFbnZGaWxlTmFtZVZhcmlhYmxlID0gJ1BJUEVOVl9QSVBGSUxFJztcbmxldCBQaXBFbnZTZXJ2aWNlID0gY2xhc3MgUGlwRW52U2VydmljZSBleHRlbmRzIGNhY2hlYWJsZUxvY2F0b3JTZXJ2aWNlXzEuQ2FjaGVhYmxlTG9jYXRvclNlcnZpY2Uge1xuICAgIGNvbnN0cnVjdG9yKHNlcnZpY2VDb250YWluZXIpIHtcbiAgICAgICAgc3VwZXIoJ1BpcEVudlNlcnZpY2UnLCBzZXJ2aWNlQ29udGFpbmVyKTtcbiAgICAgICAgdGhpcy5oZWxwZXIgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KGNvbnRyYWN0c18xLklJbnRlcnByZXRlckhlbHBlcik7XG4gICAgICAgIHRoaXMucHJvY2Vzc1NlcnZpY2VGYWN0b3J5ID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18zLklQcm9jZXNzU2VydmljZUZhY3RvcnkpO1xuICAgICAgICB0aGlzLndvcmtzcGFjZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JV29ya3NwYWNlU2VydmljZSk7XG4gICAgICAgIHRoaXMuZnMgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzIuSUZpbGVTeXN0ZW0pO1xuICAgICAgICB0aGlzLmxvZ2dlciA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfNC5JTG9nZ2VyKTtcbiAgICB9XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWVtcHR5XG4gICAgZGlzcG9zZSgpIHsgfVxuICAgIGlzUmVsYXRlZFBpcEVudmlyb25tZW50KGRpciwgcHl0aG9uUGF0aCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgLy8gSW4gUGlwRW52LCB0aGUgbmFtZSBvZiB0aGUgY3dkIGlzIHVzZWQgYXMgYSBwcmVmaXggaW4gdGhlIHZpcnR1YWwgZW52LlxuICAgICAgICAgICAgaWYgKHB5dGhvblBhdGguaW5kZXhPZihgJHtwYXRoLnNlcH0ke3BhdGguYmFzZW5hbWUoZGlyKX0tYCkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgZW52TmFtZSA9IHlpZWxkIHRoaXMuZ2V0SW50ZXJwcmV0ZXJQYXRoRnJvbVBpcGVudihkaXIsIHRydWUpO1xuICAgICAgICAgICAgcmV0dXJuICEhZW52TmFtZTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGdldEludGVycHJldGVyc0ltcGxlbWVudGF0aW9uKHJlc291cmNlKSB7XG4gICAgICAgIGNvbnN0IHBpcGVudkN3ZCA9IHRoaXMuZ2V0UGlwZW52V29ya2luZ0RpcmVjdG9yeShyZXNvdXJjZSk7XG4gICAgICAgIGlmICghcGlwZW52Q3dkKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKFtdKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5nZXRJbnRlcnByZXRlckZyb21QaXBlbnYocGlwZW52Q3dkKVxuICAgICAgICAgICAgLnRoZW4oaXRlbSA9PiBpdGVtID8gW2l0ZW1dIDogW10pXG4gICAgICAgICAgICAuY2F0Y2goKCkgPT4gW10pO1xuICAgIH1cbiAgICBnZXRJbnRlcnByZXRlckZyb21QaXBlbnYocGlwZW52Q3dkKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBpbnRlcnByZXRlclBhdGggPSB5aWVsZCB0aGlzLmdldEludGVycHJldGVyUGF0aEZyb21QaXBlbnYocGlwZW52Q3dkKTtcbiAgICAgICAgICAgIGlmICghaW50ZXJwcmV0ZXJQYXRoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgZGV0YWlscyA9IHlpZWxkIHRoaXMuaGVscGVyLmdldEludGVycHJldGVySW5mb3JtYXRpb24oaW50ZXJwcmV0ZXJQYXRoKTtcbiAgICAgICAgICAgIGlmICghZGV0YWlscykge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBkZXRhaWxzLCB7IHBhdGg6IGludGVycHJldGVyUGF0aCwgdHlwZTogY29udHJhY3RzXzEuSW50ZXJwcmV0ZXJUeXBlLlBpcEVudiB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGdldFBpcGVudldvcmtpbmdEaXJlY3RvcnkocmVzb3VyY2UpIHtcbiAgICAgICAgLy8gVGhlIGZpbGUgaXMgbm90IGluIGEgd29ya3NwYWNlLiBIb3dldmVyLCB3b3Jrc3BhY2UgbWF5IGJlIG9wZW5lZFxuICAgICAgICAvLyBhbmQgZmlsZSBpcyBqdXN0IGEgcmFuZG9tIGZpbGUgb3BlbmVkIGZyb20gZWxzZXdoZXJlLiBJbiB0aGlzIGNhc2VcbiAgICAgICAgLy8gd2Ugc3RpbGwgd2FudCB0byBwcm92aWRlIGludGVycHJldGVyIGFzc29jaWF0ZWQgd2l0aCB0aGUgd29ya3NwYWNlLlxuICAgICAgICAvLyBPdGhlcndpc2UgaWYgdXNlciB0cmllcyBhbmQgZm9ybWF0cyB0aGUgZmlsZSwgd2UgbWF5IGVuZCB1cCB1c2luZ1xuICAgICAgICAvLyBwbGFpbiBwaXAgbW9kdWxlIGluc3RhbGxlciB0byBicmluZyBpbiB0aGUgZm9ybWF0dGVyIGFuZCBpdCBpcyB3cm9uZy5cbiAgICAgICAgY29uc3Qgd3NGb2xkZXIgPSByZXNvdXJjZSA/IHRoaXMud29ya3NwYWNlLmdldFdvcmtzcGFjZUZvbGRlcihyZXNvdXJjZSkgOiB1bmRlZmluZWQ7XG4gICAgICAgIHJldHVybiB3c0ZvbGRlciA/IHdzRm9sZGVyLnVyaS5mc1BhdGggOiB0aGlzLndvcmtzcGFjZS5yb290UGF0aDtcbiAgICB9XG4gICAgZ2V0SW50ZXJwcmV0ZXJQYXRoRnJvbVBpcGVudihjd2QsIGlnbm9yZUVycm9ycyA9IGZhbHNlKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICAvLyBRdWljayBjaGVjayBiZWZvcmUgYWN0dWFsbHkgcnVubmluZyBwaXBlbnZcbiAgICAgICAgICAgIGlmICghKHlpZWxkIHRoaXMuY2hlY2tJZlBpcEZpbGVFeGlzdHMoY3dkKSkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHB5dGhvblBhdGggPSB5aWVsZCB0aGlzLmludm9rZVBpcGVudignLS1weScsIGN3ZCk7XG4gICAgICAgICAgICAgICAgLy8gVE9ETzogV2h5IGRvIHdlIG5lZWQgdG8gZG8gdGhpcz9cbiAgICAgICAgICAgICAgICByZXR1cm4gcHl0aG9uUGF0aCAmJiAoeWllbGQgdGhpcy5mcy5maWxlRXhpc3RzKHB5dGhvblBhdGgpKSA/IHB5dGhvblBhdGggOiB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWVtcHR5XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICBpZiAoaWdub3JlRXJyb3JzKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gZXJyb3IubWVzc2FnZSB8fCBlcnJvcjtcbiAgICAgICAgICAgICAgICBjb25zdCBhcHBTaGVsbCA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JQXBwbGljYXRpb25TaGVsbCk7XG4gICAgICAgICAgICAgICAgYXBwU2hlbGwuc2hvd1dhcm5pbmdNZXNzYWdlKGBXb3Jrc3BhY2UgY29udGFpbnMgcGlwZmlsZSBidXQgYXR0ZW1wdCB0byBydW4gJ3BpcGVudiAtLXB5JyBmYWlsZWQgd2l0aCAke2Vycm9yTWVzc2FnZX0uIE1ha2Ugc3VyZSBwaXBlbnYgaXMgb24gdGhlIFBBVEguYCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBjaGVja0lmUGlwRmlsZUV4aXN0cyhjd2QpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRQcm9jZXNzID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc180LklDdXJyZW50UHJvY2Vzcyk7XG4gICAgICAgICAgICBjb25zdCBwaXBGaWxlTmFtZSA9IGN1cnJlbnRQcm9jZXNzLmVudltwaXBFbnZGaWxlTmFtZVZhcmlhYmxlXTtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcGlwRmlsZU5hbWUgPT09ICdzdHJpbmcnICYmICh5aWVsZCB0aGlzLmZzLmZpbGVFeGlzdHMocGF0aC5qb2luKGN3ZCwgcGlwRmlsZU5hbWUpKSkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh5aWVsZCB0aGlzLmZzLmZpbGVFeGlzdHMocGF0aC5qb2luKGN3ZCwgJ1BpcGZpbGUnKSkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGludm9rZVBpcGVudihhcmcsIHJvb3RQYXRoKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHByb2Nlc3NTZXJ2aWNlID0geWllbGQgdGhpcy5wcm9jZXNzU2VydmljZUZhY3RvcnkuY3JlYXRlKHZzY29kZV8xLlVyaS5maWxlKHJvb3RQYXRoKSk7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0geWllbGQgcHJvY2Vzc1NlcnZpY2UuZXhlYyhleGVjTmFtZSwgW2FyZ10sIHsgY3dkOiByb290UGF0aCB9KTtcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0ZG91dCA9IHJlc3VsdC5zdGRvdXQgPyByZXN1bHQuc3Rkb3V0LnRyaW0oKSA6ICcnO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGRlcnIgPSByZXN1bHQuc3RkZXJyID8gcmVzdWx0LnN0ZGVyci50cmltKCkgOiAnJztcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0ZGVyci5sZW5ndGggPiAwICYmIHN0ZG91dC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihzdGRlcnIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBzdGRvdXQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1lbXB0eVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcGxhdGZvcm1TZXJ2aWNlID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18yLklQbGF0Zm9ybVNlcnZpY2UpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRQcm9jID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc180LklDdXJyZW50UHJvY2Vzcyk7XG4gICAgICAgICAgICAgICAgY29uc3QgZW52aXJvbWVudFZhcmlhYmxlVmFsdWVzID0ge1xuICAgICAgICAgICAgICAgICAgICBMQ19BTEw6IGN1cnJlbnRQcm9jLmVudi5MQ19BTEwsXG4gICAgICAgICAgICAgICAgICAgIExBTkc6IGN1cnJlbnRQcm9jLmVudi5MQU5HXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBlbnZpcm9tZW50VmFyaWFibGVWYWx1ZXNbcGxhdGZvcm1TZXJ2aWNlLnBhdGhWYXJpYWJsZU5hbWVdID0gY3VycmVudFByb2MuZW52W3BsYXRmb3JtU2VydmljZS5wYXRoVmFyaWFibGVOYW1lXTtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ2dlci5sb2dXYXJuaW5nKCdFcnJvciBpbiBpbnZva2luZyBQaXBFbnYnLCBlcnJvcik7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2dnZXIubG9nV2FybmluZyhgUmVsZXZhbnQgRW52aXJvbm1lbnQgVmFyaWFibGVzICR7SlNPTi5zdHJpbmdpZnkoZW52aXJvbWVudFZhcmlhYmxlVmFsdWVzLCB1bmRlZmluZWQsIDQpfWApO1xuICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2UgfHwgZXJyb3I7XG4gICAgICAgICAgICAgICAgY29uc3QgYXBwU2hlbGwgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSUFwcGxpY2F0aW9uU2hlbGwpO1xuICAgICAgICAgICAgICAgIGFwcFNoZWxsLnNob3dXYXJuaW5nTWVzc2FnZShgV29ya3NwYWNlIGNvbnRhaW5zIHBpcGZpbGUgYnV0IGF0dGVtcHQgdG8gcnVuICdwaXBlbnYgLS12ZW52JyBmYWlsZWQgd2l0aCAnJHtlcnJvck1lc3NhZ2V9Jy4gTWFrZSBzdXJlIHBpcGVudiBpcyBvbiB0aGUgUEFUSC5gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufTtcblBpcEVudlNlcnZpY2UgPSBfX2RlY29yYXRlKFtcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKCksXG4gICAgX19wYXJhbSgwLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfNS5JU2VydmljZUNvbnRhaW5lcikpXG5dLCBQaXBFbnZTZXJ2aWNlKTtcbmV4cG9ydHMuUGlwRW52U2VydmljZSA9IFBpcEVudlNlcnZpY2U7XG4vLyMgc291cmNlTWFwcGluZ1VSTD1waXBFbnZTZXJ2aWNlLmpzLm1hcCJdfQ==