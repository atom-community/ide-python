// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const vscode = require("vscode");

const types_1 = require("../common/application/types");

const constants_1 = require("../common/constants");

const types_2 = require("./types");

class LinterCommands {
  constructor(serviceContainer) {
    this.serviceContainer = serviceContainer;
    this.disposables = [];
    this.linterManager = this.serviceContainer.get(types_2.ILinterManager);
    this.appShell = this.serviceContainer.get(types_1.IApplicationShell);
    const commandManager = this.serviceContainer.get(types_1.ICommandManager);
    commandManager.registerCommand(constants_1.Commands.Set_Linter, this.setLinterAsync.bind(this));
    commandManager.registerCommand(constants_1.Commands.Enable_Linter, this.enableLintingAsync.bind(this));
    commandManager.registerCommand(constants_1.Commands.Run_Linter, this.runLinting.bind(this));
  }

  dispose() {
    this.disposables.forEach(disposable => disposable.dispose());
  }

  setLinterAsync() {
    return __awaiter(this, void 0, void 0, function* () {
      const linters = this.linterManager.getAllLinterInfos();
      const suggestions = linters.map(x => x.id).sort();
      const activeLinters = yield this.linterManager.getActiveLinters(true, this.settingsUri);
      let current;

      switch (activeLinters.length) {
        case 0:
          current = 'none';
          break;

        case 1:
          current = activeLinters[0].id;
          break;

        default:
          current = 'multiple selected';
          break;
      }

      const quickPickOptions = {
        matchOnDetail: true,
        matchOnDescription: true,
        placeHolder: `current: ${current}`
      };
      const selection = yield this.appShell.showQuickPick(suggestions, quickPickOptions);

      if (selection !== undefined) {
        const index = linters.findIndex(x => x.id === selection);

        if (activeLinters.length > 1) {
          // tslint:disable-next-line:messages-must-be-localized
          const response = yield this.appShell.showWarningMessage(`Multiple linters are enabled in settings. Replace with '${selection}'?`, 'Yes', 'No');

          if (response !== 'Yes') {
            return;
          }
        }

        yield this.linterManager.setActiveLintersAsync([linters[index].product], this.settingsUri);
      }
    });
  }

  enableLintingAsync() {
    return __awaiter(this, void 0, void 0, function* () {
      const options = ['on', 'off'];
      const current = (yield this.linterManager.isLintingEnabled(true, this.settingsUri)) ? options[0] : options[1];
      const quickPickOptions = {
        matchOnDetail: true,
        matchOnDescription: true,
        placeHolder: `current: ${current}`
      };
      const selection = yield this.appShell.showQuickPick(options, quickPickOptions);

      if (selection !== undefined) {
        const enable = selection === options[0];
        yield this.linterManager.enableLintingAsync(enable, this.settingsUri);
      }
    });
  }

  runLinting() {
    const engine = this.serviceContainer.get(types_2.ILintingEngine);
    return engine.lintOpenPythonFiles();
  }

  get settingsUri() {
    return vscode.window.activeTextEditor ? vscode.window.activeTextEditor.document.uri : undefined;
  }

}

exports.LinterCommands = LinterCommands;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpbnRlckNvbW1hbmRzLmpzIl0sIm5hbWVzIjpbIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2c2NvZGUiLCJyZXF1aXJlIiwidHlwZXNfMSIsImNvbnN0YW50c18xIiwidHlwZXNfMiIsIkxpbnRlckNvbW1hbmRzIiwiY29uc3RydWN0b3IiLCJzZXJ2aWNlQ29udGFpbmVyIiwiZGlzcG9zYWJsZXMiLCJsaW50ZXJNYW5hZ2VyIiwiZ2V0IiwiSUxpbnRlck1hbmFnZXIiLCJhcHBTaGVsbCIsIklBcHBsaWNhdGlvblNoZWxsIiwiY29tbWFuZE1hbmFnZXIiLCJJQ29tbWFuZE1hbmFnZXIiLCJyZWdpc3RlckNvbW1hbmQiLCJDb21tYW5kcyIsIlNldF9MaW50ZXIiLCJzZXRMaW50ZXJBc3luYyIsImJpbmQiLCJFbmFibGVfTGludGVyIiwiZW5hYmxlTGludGluZ0FzeW5jIiwiUnVuX0xpbnRlciIsInJ1bkxpbnRpbmciLCJkaXNwb3NlIiwiZm9yRWFjaCIsImRpc3Bvc2FibGUiLCJsaW50ZXJzIiwiZ2V0QWxsTGludGVySW5mb3MiLCJzdWdnZXN0aW9ucyIsIm1hcCIsIngiLCJpZCIsInNvcnQiLCJhY3RpdmVMaW50ZXJzIiwiZ2V0QWN0aXZlTGludGVycyIsInNldHRpbmdzVXJpIiwiY3VycmVudCIsImxlbmd0aCIsInF1aWNrUGlja09wdGlvbnMiLCJtYXRjaE9uRGV0YWlsIiwibWF0Y2hPbkRlc2NyaXB0aW9uIiwicGxhY2VIb2xkZXIiLCJzZWxlY3Rpb24iLCJzaG93UXVpY2tQaWNrIiwidW5kZWZpbmVkIiwiaW5kZXgiLCJmaW5kSW5kZXgiLCJyZXNwb25zZSIsInNob3dXYXJuaW5nTWVzc2FnZSIsInNldEFjdGl2ZUxpbnRlcnNBc3luYyIsInByb2R1Y3QiLCJvcHRpb25zIiwiaXNMaW50aW5nRW5hYmxlZCIsImVuYWJsZSIsImVuZ2luZSIsIklMaW50aW5nRW5naW5lIiwibGludE9wZW5QeXRob25GaWxlcyIsIndpbmRvdyIsImFjdGl2ZVRleHRFZGl0b3IiLCJkb2N1bWVudCIsInVyaSJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBOztBQUNBLElBQUlBLFNBQVMsR0FBSSxVQUFRLFNBQUtBLFNBQWQsSUFBNEIsVUFBVUMsT0FBVixFQUFtQkMsVUFBbkIsRUFBK0JDLENBQS9CLEVBQWtDQyxTQUFsQyxFQUE2QztBQUNyRixTQUFPLEtBQUtELENBQUMsS0FBS0EsQ0FBQyxHQUFHRSxPQUFULENBQU4sRUFBeUIsVUFBVUMsT0FBVixFQUFtQkMsTUFBbkIsRUFBMkI7QUFDdkQsYUFBU0MsU0FBVCxDQUFtQkMsS0FBbkIsRUFBMEI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDTyxJQUFWLENBQWVGLEtBQWYsQ0FBRCxDQUFKO0FBQThCLE9BQXBDLENBQXFDLE9BQU9HLENBQVAsRUFBVTtBQUFFTCxRQUFBQSxNQUFNLENBQUNLLENBQUQsQ0FBTjtBQUFZO0FBQUU7O0FBQzNGLGFBQVNDLFFBQVQsQ0FBa0JKLEtBQWxCLEVBQXlCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQyxPQUFELENBQVQsQ0FBbUJLLEtBQW5CLENBQUQsQ0FBSjtBQUFrQyxPQUF4QyxDQUF5QyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxDQUFELENBQU47QUFBWTtBQUFFOztBQUM5RixhQUFTRixJQUFULENBQWNJLE1BQWQsRUFBc0I7QUFBRUEsTUFBQUEsTUFBTSxDQUFDQyxJQUFQLEdBQWNULE9BQU8sQ0FBQ1EsTUFBTSxDQUFDTCxLQUFSLENBQXJCLEdBQXNDLElBQUlOLENBQUos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dGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cbid1c2Ugc3RyaWN0JztcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XG4gICAgfSk7XG59O1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuY29uc3QgdnNjb2RlID0gcmVxdWlyZShcInZzY29kZVwiKTtcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL2FwcGxpY2F0aW9uL3R5cGVzXCIpO1xuY29uc3QgY29uc3RhbnRzXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL2NvbnN0YW50c1wiKTtcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi90eXBlc1wiKTtcbmNsYXNzIExpbnRlckNvbW1hbmRzIHtcbiAgICBjb25zdHJ1Y3RvcihzZXJ2aWNlQ29udGFpbmVyKSB7XG4gICAgICAgIHRoaXMuc2VydmljZUNvbnRhaW5lciA9IHNlcnZpY2VDb250YWluZXI7XG4gICAgICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBbXTtcbiAgICAgICAgdGhpcy5saW50ZXJNYW5hZ2VyID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18yLklMaW50ZXJNYW5hZ2VyKTtcbiAgICAgICAgdGhpcy5hcHBTaGVsbCA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JQXBwbGljYXRpb25TaGVsbCk7XG4gICAgICAgIGNvbnN0IGNvbW1hbmRNYW5hZ2VyID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklDb21tYW5kTWFuYWdlcik7XG4gICAgICAgIGNvbW1hbmRNYW5hZ2VyLnJlZ2lzdGVyQ29tbWFuZChjb25zdGFudHNfMS5Db21tYW5kcy5TZXRfTGludGVyLCB0aGlzLnNldExpbnRlckFzeW5jLmJpbmQodGhpcykpO1xuICAgICAgICBjb21tYW5kTWFuYWdlci5yZWdpc3RlckNvbW1hbmQoY29uc3RhbnRzXzEuQ29tbWFuZHMuRW5hYmxlX0xpbnRlciwgdGhpcy5lbmFibGVMaW50aW5nQXN5bmMuYmluZCh0aGlzKSk7XG4gICAgICAgIGNvbW1hbmRNYW5hZ2VyLnJlZ2lzdGVyQ29tbWFuZChjb25zdGFudHNfMS5Db21tYW5kcy5SdW5fTGludGVyLCB0aGlzLnJ1bkxpbnRpbmcuYmluZCh0aGlzKSk7XG4gICAgfVxuICAgIGRpc3Bvc2UoKSB7XG4gICAgICAgIHRoaXMuZGlzcG9zYWJsZXMuZm9yRWFjaChkaXNwb3NhYmxlID0+IGRpc3Bvc2FibGUuZGlzcG9zZSgpKTtcbiAgICB9XG4gICAgc2V0TGludGVyQXN5bmMoKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBsaW50ZXJzID0gdGhpcy5saW50ZXJNYW5hZ2VyLmdldEFsbExpbnRlckluZm9zKCk7XG4gICAgICAgICAgICBjb25zdCBzdWdnZXN0aW9ucyA9IGxpbnRlcnMubWFwKHggPT4geC5pZCkuc29ydCgpO1xuICAgICAgICAgICAgY29uc3QgYWN0aXZlTGludGVycyA9IHlpZWxkIHRoaXMubGludGVyTWFuYWdlci5nZXRBY3RpdmVMaW50ZXJzKHRydWUsIHRoaXMuc2V0dGluZ3NVcmkpO1xuICAgICAgICAgICAgbGV0IGN1cnJlbnQ7XG4gICAgICAgICAgICBzd2l0Y2ggKGFjdGl2ZUxpbnRlcnMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgY2FzZSAwOlxuICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gJ25vbmUnO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlIDE6XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBhY3RpdmVMaW50ZXJzWzBdLmlkO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gJ211bHRpcGxlIHNlbGVjdGVkJztcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBxdWlja1BpY2tPcHRpb25zID0ge1xuICAgICAgICAgICAgICAgIG1hdGNoT25EZXRhaWw6IHRydWUsXG4gICAgICAgICAgICAgICAgbWF0Y2hPbkRlc2NyaXB0aW9uOiB0cnVlLFxuICAgICAgICAgICAgICAgIHBsYWNlSG9sZGVyOiBgY3VycmVudDogJHtjdXJyZW50fWBcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjb25zdCBzZWxlY3Rpb24gPSB5aWVsZCB0aGlzLmFwcFNoZWxsLnNob3dRdWlja1BpY2soc3VnZ2VzdGlvbnMsIHF1aWNrUGlja09wdGlvbnMpO1xuICAgICAgICAgICAgaWYgKHNlbGVjdGlvbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSBsaW50ZXJzLmZpbmRJbmRleCh4ID0+IHguaWQgPT09IHNlbGVjdGlvbik7XG4gICAgICAgICAgICAgICAgaWYgKGFjdGl2ZUxpbnRlcnMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWVzc2FnZXMtbXVzdC1iZS1sb2NhbGl6ZWRcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSB5aWVsZCB0aGlzLmFwcFNoZWxsLnNob3dXYXJuaW5nTWVzc2FnZShgTXVsdGlwbGUgbGludGVycyBhcmUgZW5hYmxlZCBpbiBzZXR0aW5ncy4gUmVwbGFjZSB3aXRoICcke3NlbGVjdGlvbn0nP2AsICdZZXMnLCAnTm8nKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlICE9PSAnWWVzJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMubGludGVyTWFuYWdlci5zZXRBY3RpdmVMaW50ZXJzQXN5bmMoW2xpbnRlcnNbaW5kZXhdLnByb2R1Y3RdLCB0aGlzLnNldHRpbmdzVXJpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGVuYWJsZUxpbnRpbmdBc3luYygpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSBbJ29uJywgJ29mZiddO1xuICAgICAgICAgICAgY29uc3QgY3VycmVudCA9ICh5aWVsZCB0aGlzLmxpbnRlck1hbmFnZXIuaXNMaW50aW5nRW5hYmxlZCh0cnVlLCB0aGlzLnNldHRpbmdzVXJpKSkgPyBvcHRpb25zWzBdIDogb3B0aW9uc1sxXTtcbiAgICAgICAgICAgIGNvbnN0IHF1aWNrUGlja09wdGlvbnMgPSB7XG4gICAgICAgICAgICAgICAgbWF0Y2hPbkRldGFpbDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBtYXRjaE9uRGVzY3JpcHRpb246IHRydWUsXG4gICAgICAgICAgICAgICAgcGxhY2VIb2xkZXI6IGBjdXJyZW50OiAke2N1cnJlbnR9YFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGlvbiA9IHlpZWxkIHRoaXMuYXBwU2hlbGwuc2hvd1F1aWNrUGljayhvcHRpb25zLCBxdWlja1BpY2tPcHRpb25zKTtcbiAgICAgICAgICAgIGlmIChzZWxlY3Rpb24gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGVuYWJsZSA9IHNlbGVjdGlvbiA9PT0gb3B0aW9uc1swXTtcbiAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmxpbnRlck1hbmFnZXIuZW5hYmxlTGludGluZ0FzeW5jKGVuYWJsZSwgdGhpcy5zZXR0aW5nc1VyaSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBydW5MaW50aW5nKCkge1xuICAgICAgICBjb25zdCBlbmdpbmUgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzIuSUxpbnRpbmdFbmdpbmUpO1xuICAgICAgICByZXR1cm4gZW5naW5lLmxpbnRPcGVuUHl0aG9uRmlsZXMoKTtcbiAgICB9XG4gICAgZ2V0IHNldHRpbmdzVXJpKCkge1xuICAgICAgICByZXR1cm4gdnNjb2RlLndpbmRvdy5hY3RpdmVUZXh0RWRpdG9yID8gdnNjb2RlLndpbmRvdy5hY3RpdmVUZXh0RWRpdG9yLmRvY3VtZW50LnVyaSA6IHVuZGVmaW5lZDtcbiAgICB9XG59XG5leHBvcnRzLkxpbnRlckNvbW1hbmRzID0gTGludGVyQ29tbWFuZHM7XG4vLyMgc291cmNlTWFwcGluZ1VSTD1saW50ZXJDb21tYW5kcy5qcy5tYXAiXX0=