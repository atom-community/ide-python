"use strict";

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const path = require("path");

require("../common/extensions");

const types_1 = require("../common/types");

const util_1 = require("./../common/util");

const baseLinter_1 = require("./baseLinter");

const types_2 = require("./types");

class PyDocStyle extends baseLinter_1.BaseLinter {
  constructor(outputChannel, serviceContainer) {
    super(types_1.Product.pydocstyle, outputChannel, serviceContainer);
  }

  runLinter(document, cancellation) {
    return __awaiter(this, void 0, void 0, function* () {
      const messages = yield this.run([document.uri.fsPath], document, cancellation); // All messages in pep8 are treated as warnings for now.

      messages.forEach(msg => {
        msg.severity = types_2.LintMessageSeverity.Warning;
      });
      return messages;
    });
  }

  parseMessages(output, document, token, regEx) {
    return __awaiter(this, void 0, void 0, function* () {
      let outputLines = output.split(/\r?\n/g);
      const baseFileName = path.basename(document.uri.fsPath); // Remember, the first line of the response contains the file name and line number, the next line contains the error message.
      // So we have two lines per message, hence we need to take lines in pairs.

      const maxLines = this.pythonSettings.linting.maxNumberOfProblems * 2; // First line is almost always empty.

      const oldOutputLines = outputLines.filter(line => line.length > 0);
      outputLines = [];

      for (let counter = 0; counter < oldOutputLines.length / 2; counter += 1) {
        outputLines.push(oldOutputLines[2 * counter] + oldOutputLines[2 * counter + 1]);
      }

      return outputLines.filter((value, index) => index < maxLines && value.indexOf(':') >= 0).map(line => {
        // Windows will have a : after the drive letter (e.g. c:\).
        if (util_1.IS_WINDOWS) {
          return line.substring(line.indexOf(`${baseFileName}:`) + baseFileName.length + 1).trim();
        }

        return line.substring(line.indexOf(':') + 1).trim();
      }) // Iterate through the lines (skipping the messages).
      // So, just iterate the response in pairs.
      .map(line => {
        try {
          if (line.trim().length === 0) {
            return;
          }

          const lineNumber = parseInt(line.substring(0, line.indexOf(' ')), 10);
          const part = line.substring(line.indexOf(':') + 1).trim();
          const code = part.substring(0, part.indexOf(':')).trim();
          const message = part.substring(part.indexOf(':') + 1).trim();
          const sourceLine = document.lineAt(lineNumber - 1).text;
          const trmmedSourceLine = sourceLine.trim();
          const sourceStart = sourceLine.indexOf(trmmedSourceLine); // tslint:disable-next-line:no-object-literal-type-assertion

          return {
            code: code,
            message: message,
            column: sourceStart,
            line: lineNumber,
            type: '',
            provider: this.info.id
          };
        } catch (ex) {
          this.logger.logError(`Failed to parse pydocstyle line '${line}'`, ex);
          return;
        }
      }).filter(item => item !== undefined).map(item => item);
    });
  }

}

exports.PyDocStyle = PyDocStyle;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInB5ZG9jc3R5bGUuanMiXSwibmFtZXMiOlsiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInBhdGgiLCJyZXF1aXJlIiwidHlwZXNfMSIsInV0aWxfMSIsImJhc2VMaW50ZXJfMSIsInR5cGVzXzIiLCJQeURvY1N0eWxlIiwiQmFzZUxpbnRlciIsImNvbnN0cnVjdG9yIiwib3V0cHV0Q2hhbm5lbCIsInNlcnZpY2VDb250YWluZXIiLCJQcm9kdWN0IiwicHlkb2NzdHlsZSIsInJ1bkxpbnRlciIsImRvY3VtZW50IiwiY2FuY2VsbGF0aW9uIiwibWVzc2FnZXMiLCJydW4iLCJ1cmkiLCJmc1BhdGgiLCJmb3JFYWNoIiwibXNnIiwic2V2ZXJpdHkiLCJMaW50TWVzc2FnZVNldmVyaXR5IiwiV2FybmluZyIsInBhcnNlTWVzc2FnZXMiLCJvdXRwdXQiLCJ0b2tlbiIsInJlZ0V4Iiwib3V0cHV0TGluZXMiLCJzcGxpdCIsImJhc2VGaWxlTmFtZSIsImJhc2VuYW1lIiwibWF4TGluZXMiLCJweXRob25TZXR0aW5ncyIsImxpbnRpbmciLCJtYXhOdW1iZXJPZlByb2JsZW1zIiwib2xkT3V0cHV0TGluZXMiLCJmaWx0ZXIiLCJsaW5lIiwibGVuZ3RoIiwiY291bnRlciIsInB1c2giLCJpbmRleCIsImluZGV4T2YiLCJtYXAiLCJJU19XSU5ET1dTIiwic3Vic3RyaW5nIiwidHJpbSIsImxpbmVOdW1iZXIiLCJwYXJzZUludCIsInBhcnQiLCJjb2RlIiwibWVzc2FnZSIsInNvdXJjZUxpbmUiLCJsaW5lQXQiLCJ0ZXh0IiwidHJtbWVkU291cmNlTGluZSIsInNvdXJjZVN0YXJ0IiwiY29sdW1uIiwidHlwZSIsInByb3ZpZGVyIiwiaW5mbyIsImlkIiwiZXgiLCJsb2dnZXIiLCJsb2dFcnJvciIsIml0ZW0iLCJ1bmRlZmluZWQiXSwibWFwcGluZ3MiOiJBQUFBOztBQUNBLElBQUlBLFNBQVMsR0FBSSxVQUFRLFNBQUtBLFNBQWQsSUFBNEIsVUFBVUMsT0FBVixFQUFtQkMsVUFBbkIsRUFBK0JDLENBQS9CLEVBQWtDQyxTQUFsQyxFQUE2QztBQUNyRixTQUFPLEtBQUtELENBQUMsS0FBS0EsQ0FBQyxHQUFHRSxPQUFULENBQU4sRUFBeUIsVUFBVUMsT0FBVixFQUFtQkMsTUFBbkIsRUFBMkI7QUFDdkQsYUFBU0MsU0FBVCxDQUFtQkMsS0FBbkIsRUFBMEI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDTyxJQUFWLENBQWVGLEtBQWYsQ0FBRCxDQUFKO0FBQThCLE9BQXBDLENBQXFDLE9BQU9HLENBQVAsRUFBVTtBQUFFTCxRQUFBQSxNQUFNLENBQUNLLENBQUQsQ0FBTjtBQUFZO0FBQUU7O0FBQzNGLGFBQVNDLFFBQVQsQ0FBa0JKLEtBQWxCLEVBQXlCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQyxPQUFELENBQVQsQ0FBbUJLLEtBQW5CLENBQUQsQ0FBSjtBQUFrQyxPQUF4QyxDQUF5QyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxDQUFELENBQU47QUFBWTtBQUFFOztBQUM5RixhQUFTRixJQUFULENBQWNJLE1BQWQsRUFBc0I7QUFBRUEsTUFBQUEsTUFBTSxDQUFDQyxJQUFQLEdBQWNULE9BQU8sQ0FBQ1EsTUFBTSxDQUFDTCxLQUFSLENBQXJCLEdBQXNDLElBQUlOLENBQUosQ0FBTSxVQUFVRyxPQUFWLEVBQW1CO0FBQUVBLFFBQUFBLE9BQU8sQ0FBQ1EsTUFBTSxDQUFDTCxLQUFSLENBQVA7QUFBd0IsT0FBbkQsRUFBcURPLElBQXJELENBQTBEUixTQUExRCxFQUFxRUssUUFB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TCxDQUFlSSxJQUFJLENBQUNQLE9BQUwsQ0FBYSxHQUFiLElBQW9CLENBQW5DLEVBQXNDSSxJQUF0QyxFQUFoQjtBQUNBLGdCQUFNTSxVQUFVLEdBQUd4QyxRQUFRLENBQUN5QyxNQUFULENBQWdCTixVQUFVLEdBQUcsQ0FBN0IsRUFBZ0NPLElBQW5EO0FBQ0EsZ0JBQU1DLGdCQUFnQixHQUFHSCxVQUFVLENBQUNOLElBQVgsRUFBekI7QUFDQSxnQkFBTVUsV0FBVyxHQUFHSixVQUFVLENBQUNWLE9BQVgsQ0FBbUJhLGdCQUFuQixDQUFwQixDQVZBLENBV0E7O0FBQ0EsaUJBQU87QUFDSEwsWUFBQUEsSUFBSSxFQUFFQSxJQURIO0FBRUhDLFlBQUFBLE9BQU8sRUFBRUEsT0FGTjtBQUdITSxZQUFBQSxNQUFNLEVBQUVELFdBSEw7QUFJSG5CLFlBQUFBLElBQUksRUFBRVUsVUFKSDtBQUtIVyxZQUFBQSxJQUFJLEVBQUUsRUFMSDtBQU1IQyxZQUFBQSxRQUFRLEVBQUUsS0FBS0MsSUFBTCxDQUFVQztBQU5qQixXQUFQO0FBUUgsU0FwQkQsQ0FxQkEsT0FBT0MsRUFBUCxFQUFXO0FBQ1AsZUFBS0MsTUFBTCxDQUFZQyxRQUFaLENBQXNCLG9DQUFtQzNCLElBQUssR0FBOUQsRUFBa0V5QixFQUFsRTtBQUNBO0FBQ0g7QUFDSixPQXJDTSxFQXNDRjFCLE1BdENFLENBc0NLNkIsSUFBSSxJQUFJQSxJQUFJLEtBQUtDLFNBdEN0QixFQXVDRnZCLEdBdkNFLENBdUNFc0IsSUFBSSxJQUFJQSxJQXZDVixDQUFQO0FBd0NILEtBcERlLENBQWhCO0FBcURIOztBQXBFNEM7O0FBc0VqRHBFLE9BQU8sQ0FBQ08sVUFBUixHQUFxQkEsVUFBckIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XG4gICAgfSk7XG59O1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xucmVxdWlyZShcIi4uL2NvbW1vbi9leHRlbnNpb25zXCIpO1xuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vdHlwZXNcIik7XG5jb25zdCB1dGlsXzEgPSByZXF1aXJlKFwiLi8uLi9jb21tb24vdXRpbFwiKTtcbmNvbnN0IGJhc2VMaW50ZXJfMSA9IHJlcXVpcmUoXCIuL2Jhc2VMaW50ZXJcIik7XG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4vdHlwZXNcIik7XG5jbGFzcyBQeURvY1N0eWxlIGV4dGVuZHMgYmFzZUxpbnRlcl8xLkJhc2VMaW50ZXIge1xuICAgIGNvbnN0cnVjdG9yKG91dHB1dENoYW5uZWwsIHNlcnZpY2VDb250YWluZXIpIHtcbiAgICAgICAgc3VwZXIodHlwZXNfMS5Qcm9kdWN0LnB5ZG9jc3R5bGUsIG91dHB1dENoYW5uZWwsIHNlcnZpY2VDb250YWluZXIpO1xuICAgIH1cbiAgICBydW5MaW50ZXIoZG9jdW1lbnQsIGNhbmNlbGxhdGlvbikge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZXMgPSB5aWVsZCB0aGlzLnJ1bihbZG9jdW1lbnQudXJpLmZzUGF0aF0sIGRvY3VtZW50LCBjYW5jZWxsYXRpb24pO1xuICAgICAgICAgICAgLy8gQWxsIG1lc3NhZ2VzIGluIHBlcDggYXJlIHRyZWF0ZWQgYXMgd2FybmluZ3MgZm9yIG5vdy5cbiAgICAgICAgICAgIG1lc3NhZ2VzLmZvckVhY2gobXNnID0+IHtcbiAgICAgICAgICAgICAgICBtc2cuc2V2ZXJpdHkgPSB0eXBlc18yLkxpbnRNZXNzYWdlU2V2ZXJpdHkuV2FybmluZztcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2VzO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgcGFyc2VNZXNzYWdlcyhvdXRwdXQsIGRvY3VtZW50LCB0b2tlbiwgcmVnRXgpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGxldCBvdXRwdXRMaW5lcyA9IG91dHB1dC5zcGxpdCgvXFxyP1xcbi9nKTtcbiAgICAgICAgICAgIGNvbnN0IGJhc2VGaWxlTmFtZSA9IHBhdGguYmFzZW5hbWUoZG9jdW1lbnQudXJpLmZzUGF0aCk7XG4gICAgICAgICAgICAvLyBSZW1lbWJlciwgdGhlIGZpcnN0IGxpbmUgb2YgdGhlIHJlc3BvbnNlIGNvbnRhaW5zIHRoZSBmaWxlIG5hbWUgYW5kIGxpbmUgbnVtYmVyLCB0aGUgbmV4dCBsaW5lIGNvbnRhaW5zIHRoZSBlcnJvciBtZXNzYWdlLlxuICAgICAgICAgICAgLy8gU28gd2UgaGF2ZSB0d28gbGluZXMgcGVyIG1lc3NhZ2UsIGhlbmNlIHdlIG5lZWQgdG8gdGFrZSBsaW5lcyBpbiBwYWlycy5cbiAgICAgICAgICAgIGNvbnN0IG1heExpbmVzID0gdGhpcy5weXRob25TZXR0aW5ncy5saW50aW5nLm1heE51bWJlck9mUHJvYmxlbXMgKiAyO1xuICAgICAgICAgICAgLy8gRmlyc3QgbGluZSBpcyBhbG1vc3QgYWx3YXlzIGVtcHR5LlxuICAgICAgICAgICAgY29uc3Qgb2xkT3V0cHV0TGluZXMgPSBvdXRwdXRMaW5lcy5maWx0ZXIobGluZSA9PiBsaW5lLmxlbmd0aCA+IDApO1xuICAgICAgICAgICAgb3V0cHV0TGluZXMgPSBbXTtcbiAgICAgICAgICAgIGZvciAobGV0IGNvdW50ZXIgPSAwOyBjb3VudGVyIDwgb2xkT3V0cHV0TGluZXMubGVuZ3RoIC8gMjsgY291bnRlciArPSAxKSB7XG4gICAgICAgICAgICAgICAgb3V0cHV0TGluZXMucHVzaChvbGRPdXRwdXRMaW5lc1syICogY291bnRlcl0gKyBvbGRPdXRwdXRMaW5lc1soMiAqIGNvdW50ZXIpICsgMV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG91dHB1dExpbmVzXG4gICAgICAgICAgICAgICAgLmZpbHRlcigodmFsdWUsIGluZGV4KSA9PiBpbmRleCA8IG1heExpbmVzICYmIHZhbHVlLmluZGV4T2YoJzonKSA+PSAwKVxuICAgICAgICAgICAgICAgIC5tYXAobGluZSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gV2luZG93cyB3aWxsIGhhdmUgYSA6IGFmdGVyIHRoZSBkcml2ZSBsZXR0ZXIgKGUuZy4gYzpcXCkuXG4gICAgICAgICAgICAgICAgaWYgKHV0aWxfMS5JU19XSU5ET1dTKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBsaW5lLnN1YnN0cmluZyhsaW5lLmluZGV4T2YoYCR7YmFzZUZpbGVOYW1lfTpgKSArIGJhc2VGaWxlTmFtZS5sZW5ndGggKyAxKS50cmltKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBsaW5lLnN1YnN0cmluZyhsaW5lLmluZGV4T2YoJzonKSArIDEpLnRyaW0oKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLy8gSXRlcmF0ZSB0aHJvdWdoIHRoZSBsaW5lcyAoc2tpcHBpbmcgdGhlIG1lc3NhZ2VzKS5cbiAgICAgICAgICAgICAgICAvLyBTbywganVzdCBpdGVyYXRlIHRoZSByZXNwb25zZSBpbiBwYWlycy5cbiAgICAgICAgICAgICAgICAubWFwKGxpbmUgPT4ge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChsaW5lLnRyaW0oKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBjb25zdCBsaW5lTnVtYmVyID0gcGFyc2VJbnQobGluZS5zdWJzdHJpbmcoMCwgbGluZS5pbmRleE9mKCcgJykpLCAxMCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhcnQgPSBsaW5lLnN1YnN0cmluZyhsaW5lLmluZGV4T2YoJzonKSArIDEpLnRyaW0oKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29kZSA9IHBhcnQuc3Vic3RyaW5nKDAsIHBhcnQuaW5kZXhPZignOicpKS50cmltKCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBwYXJ0LnN1YnN0cmluZyhwYXJ0LmluZGV4T2YoJzonKSArIDEpLnRyaW0oKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc291cmNlTGluZSA9IGRvY3VtZW50LmxpbmVBdChsaW5lTnVtYmVyIC0gMSkudGV4dDtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJtbWVkU291cmNlTGluZSA9IHNvdXJjZUxpbmUudHJpbSgpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBzb3VyY2VTdGFydCA9IHNvdXJjZUxpbmUuaW5kZXhPZih0cm1tZWRTb3VyY2VMaW5lKTtcbiAgICAgICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLW9iamVjdC1saXRlcmFsLXR5cGUtYXNzZXJ0aW9uXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb2RlOiBjb2RlLFxuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbjogc291cmNlU3RhcnQsXG4gICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBsaW5lTnVtYmVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJycsXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlcjogdGhpcy5pbmZvLmlkXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNhdGNoIChleCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ2dlci5sb2dFcnJvcihgRmFpbGVkIHRvIHBhcnNlIHB5ZG9jc3R5bGUgbGluZSAnJHtsaW5lfSdgLCBleCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5maWx0ZXIoaXRlbSA9PiBpdGVtICE9PSB1bmRlZmluZWQpXG4gICAgICAgICAgICAgICAgLm1hcChpdGVtID0+IGl0ZW0pO1xuICAgICAgICB9KTtcbiAgICB9XG59XG5leHBvcnRzLlB5RG9jU3R5bGUgPSBQeURvY1N0eWxlO1xuLy8jIHNvdXJjZU1hcHBpbmdVUkw9cHlkb2NzdHlsZS5qcy5tYXAiXX0=