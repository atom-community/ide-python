// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const path = require("path");

const types_1 = require("../common/application/types");

require("../common/extensions");

const types_2 = require("../common/process/types");

const types_3 = require("../common/types");

const errorHandler_1 = require("./errorHandlers/errorHandler");

const types_4 = require("./types"); // tslint:disable-next-line:no-require-imports no-var-requires


const namedRegexp = require('named-js-regexp'); // Allow negative column numbers (https://github.com/PyCQA/pylint/issues/1822)


const REGEX = '(?<line>\\d+),(?<column>-?\\d+),(?<type>\\w+),(?<code>\\w\\d+):(?<message>.*)\\r?(\\n|$)';

function matchNamedRegEx(data, regex) {
  const compiledRegexp = namedRegexp(regex, 'g');
  const rawMatch = compiledRegexp.exec(data);

  if (rawMatch !== null) {
    return rawMatch.groups();
  }

  return undefined;
}

exports.matchNamedRegEx = matchNamedRegEx;

function parseLine(line, regex, linterID, colOffset = 0) {
  const match = matchNamedRegEx(line, regex);

  if (!match) {
    return;
  } // tslint:disable-next-line:no-any


  match.line = Number(match.line); // tslint:disable-next-line:no-any

  match.column = Number(match.column);
  return {
    code: match.code,
    message: match.message,
    column: isNaN(match.column) || match.column <= 0 ? 0 : match.column - colOffset,
    line: match.line,
    type: match.type,
    provider: linterID
  };
}

exports.parseLine = parseLine;

class BaseLinter {
  constructor(product, outputChannel, serviceContainer, columnOffset = 0) {
    this.outputChannel = outputChannel;
    this.serviceContainer = serviceContainer;
    this.columnOffset = columnOffset;
    this._info = serviceContainer.get(types_4.ILinterManager).getLinterInfo(product);
    this.errorHandler = new errorHandler_1.ErrorHandler(this.info.product, outputChannel, serviceContainer);
    this.configService = serviceContainer.get(types_3.IConfigurationService);
    this.workspace = serviceContainer.get(types_1.IWorkspaceService);
  }

  get pythonSettings() {
    return this._pythonSettings;
  }

  get info() {
    return this._info;
  }

  lint(document, cancellation) {
    return __awaiter(this, void 0, void 0, function* () {
      this._pythonSettings = this.configService.getSettings(document.uri);
      return this.runLinter(document, cancellation);
    });
  }

  getWorkspaceRootPath(document) {
    const workspaceFolder = this.workspace.getWorkspaceFolder(document.uri);
    const workspaceRootPath = workspaceFolder && typeof workspaceFolder.uri.fsPath === 'string' ? workspaceFolder.uri.fsPath : undefined;
    return typeof workspaceRootPath === 'string' ? workspaceRootPath : path.dirname(document.uri.fsPath);
  }

  get logger() {
    return this.serviceContainer.get(types_3.ILogger);
  } // tslint:disable-next-line:no-any


  parseMessagesSeverity(error, categorySeverity) {
    if (categorySeverity[error]) {
      const severityName = categorySeverity[error];

      switch (severityName) {
        case 'Error':
          return types_4.LintMessageSeverity.Error;

        case 'Hint':
          return types_4.LintMessageSeverity.Hint;

        case 'Information':
          return types_4.LintMessageSeverity.Information;

        case 'Warning':
          return types_4.LintMessageSeverity.Warning;

        default:
          {
            if (types_4.LintMessageSeverity[severityName]) {
              // tslint:disable-next-line:no-any
              return types_4.LintMessageSeverity[severityName];
            }
          }
      }
    }

    return types_4.LintMessageSeverity.Information;
  }

  run(args, document, cancellation, regEx = REGEX) {
    return __awaiter(this, void 0, void 0, function* () {
      if (!this.info.isEnabled(document.uri)) {
        return [];
      }

      const executionInfo = this.info.getExecutionInfo(args, document.uri);
      const cwd = this.getWorkspaceRootPath(document);
      const pythonToolsExecutionService = this.serviceContainer.get(types_2.IPythonToolExecutionService);

      try {
        const result = yield pythonToolsExecutionService.exec(executionInfo, {
          cwd,
          token: cancellation,
          mergeStdOutErr: false
        }, document.uri);
        this.displayLinterResultHeader(result.stdout);
        return yield this.parseMessages(result.stdout, document, cancellation, regEx);
      } catch (error) {
        this.handleError(error, document.uri, executionInfo);
        return [];
      }
    });
  }

  parseMessages(output, document, token, regEx) {
    return __awaiter(this, void 0, void 0, function* () {
      const outputLines = output.splitLines({
        removeEmptyEntries: false,
        trim: false
      });
      return this.parseLines(outputLines, regEx);
    });
  }

  handleError(error, resource, execInfo) {
    this.errorHandler.handleError(error, resource, execInfo).catch(this.logger.logError.bind(this, 'Error in errorHandler.handleError'));
  }

  parseLine(line, regEx) {
    return parseLine(line, regEx, this.info.id, this.columnOffset);
  }

  parseLines(outputLines, regEx) {
    const messages = [];

    for (const line of outputLines) {
      try {
        const msg = this.parseLine(line, regEx);

        if (msg) {
          messages.push(msg);

          if (messages.length >= this.pythonSettings.linting.maxNumberOfProblems) {
            break;
          }
        }
      } catch (ex) {
        this.logger.logError(`Linter '${this.info.id}' failed to parse the line '${line}.`, ex);
      }
    }

    return messages;
  }

  displayLinterResultHeader(data) {
    this.outputChannel.append(`${'#'.repeat(10)}Linting Output - ${this.info.id}${'#'.repeat(10)}\n`);
    this.outputChannel.append(data);
  }

}

exports.BaseLinter = BaseLinter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJhc2VMaW50ZXIuanMiXSwibmFtZXMiOlsiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInBhdGgiLCJyZXF1aXJlIiwidHlwZXNfMSIsInR5cGVzXzIiLCJ0eXBlc18zIiwiZXJyb3JIYW5kbGVyXzEiLCJ0eXBlc180IiwibmFtZWRSZWdleHAiLCJSRUdFWCIsIm1hdGNoTmFtZWRSZWdFeCIsImRhdGEiLCJyZWdleCIsImNvbXBpbGVkUmVnZXhwIiwicmF3TWF0Y2giLCJleGVjIiwiZ3JvdXBzIiwidW5kZWZpbmVkIiwicGFyc2VMaW5lIiwibGluZSIsImxpbnRlcklEIiwiY29sT2Zmc2V0IiwibWF0Y2giLCJOdW1iZXIiLCJjb2x1bW4iLCJjb2RlIiwibWVzc2FnZSIsImlzTmFOIiwidHlwZSIsInByb3ZpZGVyIiwiQmFzZUxpbnRlciIsImNvbnN0cnVjdG9yIiwicHJvZHVjdCIsIm91dHB1dENoYW5uZWwiLCJzZXJ2aWNlQ29udGFpbmVyIiwiY29sdW1uT2Zmc2V0IiwiX2luZm8iLCJnZXQiLCJJTGludGVyTWFuYWdlciIsImdldExpbnRlckluZm8iLCJlcnJvckhhbmRsZXIiLCJFcnJvckhhbmRsZXIiLCJpbmZvIiwiY29uZmlnU2VydmljZSIsIklDb25maWd1cmF0aW9uU2VydmljZSIsIndvcmtzcGFjZSIsIklXb3Jrc3BhY2VTZXJ2aWNlIiwicHl0aG9uU2V0dGluZ3MiLCJfcHl0aG9uU2V0dGluZ3MiLCJsaW50IiwiZG9jdW1lbnQiLCJjYW5jZWxsYXRpb24iLCJnZXRTZXR0aW5ncyIsInVyaSIsInJ1bkxpbnRlciIsImdldFdvcmtzcGFjZVJvb3RQYXRoIiwid29ya3NwYWNlRm9sZGVyIiwiZ2V0V29ya3NwYWNlRm9sZGVyIiwid29ya3NwYWNlUm9vdFBhdGgiLCJmc1BhdGgiLCJkaXJuYW1lIiwibG9nZ2VyIiwiSUxvZ2dlciIsInBhcnNlTWVzc2FnZXNTZXZlcml0eSIsImVycm9yIiwiY2F0ZWdvcnlTZXZlcml0eSIsInNldmVyaXR5TmFtZSIsIkxpbnRNZXNzYWdlU2V2ZXJpdHkiLCJFcnJvciIsIkhpbnQiLCJJbmZvcm1hdGlvbiIsIldhcm5pbmciLCJydW4iLCJhcmdzIiwicmVnRXgiLCJpc0VuYWJsZWQiLCJleGVjdXRpb25JbmZvIiwiZ2V0RXhlY3V0aW9uSW5mbyIsImN3ZCIsInB5dGhvblRvb2xzRXhlY3V0aW9uU2VydmljZSIsIklQeXRob25Ub29sRXhlY3V0aW9uU2VydmljZSIsInRva2VuIiwibWVyZ2VTdGRPdXRFcnIiLCJkaXNwbGF5TGludGVyUmVzdWx0SGVhZGVyIiwic3Rkb3V0IiwicGFyc2VNZXNzYWdlcyIsImhhbmRsZUVycm9yIiwib3V0cHV0Iiwib3V0cHV0TGluZXMiLCJzcGxpdExpbmVzIiwicmVtb3ZlRW1wdHlFbnRyaWVzIiwidHJpbSIsInBhcnNlTGluZXMiLCJyZXNvdXJjZSIsImV4ZWNJbmZvIiwiY2F0Y2giLCJsb2dFcnJvciIsImJpbmQiLCJpZCIsIm1lc3NhZ2VzIiwibXNnIiwicHVzaCIsImxlbmd0aCIsImxpbnRpbmciLCJtYXhOdW1iZXJPZlByb2JsZW1zIiwiZXgiLCJhcHBlbmQiLCJyZXBlYXQiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxTQUFTLEdBQUksVUFBUSxTQUFLQSxTQUFkLElBQTRCLFVBQVVDLE9BQVYsRUFBbUJDLFVBQW5CLEVBQStCQyxDQUEvQixFQUFrQ0MsU0FBbEMsRUFBNkM7QUFDckYsU0FBTyxLQUFLRCxDQUFDLEtBQUtBLENBQUMsR0FBR0UsT0FBVCxDQUFOLEVBQXlCLFVBQVVDLE9BQVYsRUFBbUJDLE1BQW5CLEVBQTJCO0FBQ3ZELGFBQVNDLFNBQVQsQ0FBbUJDLEtBQW5CLEVBQTBCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQ08sSUFBVixDQUFlRixLQUFmLENBQUQsQ0FBSjtBQUE4QixPQUFwQyxDQUFxQyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxDQUFELENBQU47QUFBWTtBQUFFOztBQUMzRixhQUFTQyxRQUFULENBQWtCSixLQUFsQixFQUF5QjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUMsT0FBRCxDQUFULENBQW1CSyxLQUFuQixDQUFELENBQUo7QUFBa0MsT0FBeEMsQ0FBeUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDOUYsYUFBU0YsSUFBVCxDQUFjSSxNQUFkLEVBQXNCO0FBQUVBLE1BQUFBLE1BQU0sQ0FBQ0MsSUFBUCxHQUFjVCxPQUFPLENBQUNRLE1BQU0sQ0FBQ0wsS0FBUixDQUFyQixHQUFzQyxJQUFJTixDQUFKLENBQU0sVUFBVUcsT0FBVixFQUFtQjtBQUFFQSxRQUFBQSxPQUFPLENBQUNRLE1BQU0sQ0FBQ0wsS0FBUixDQUFQO0FBQXdCLE9BQW5ELEVBQXFETyxJQUFyRCxDQUEwRFIsU0FBMUQsRUFBcUVLLFFBQXJFLENBQXRDO0FBQXVIOztBQUMvSUgsSUFBQUEsSUFBSSxDQUFDLENBQUNOLFNBQVMsR0FBR0EsU0FBUyxDQUFDYSxLQUFWLENBQWdCaEIsT0FBaEIsRUFBeUJDLFVBQVUsSUFBSSxFQUF2QyxDQUFiLEVBQXlEUyxJQUF6RCxFQUFELENBQUo7QUFDSCxHQUxNLENBQVA7QUFNSCxDQVBEOztBQVFBTyxNQUFNLENBQUNDLGNBQVAsQ0FBc0JDLE9BQXRCLEVBQStCLFlBQS9CLEVBQTZDO0FBQUVYLEVBQUFBLEtBQUssRUFBRTtBQUFULENBQTdDOztBQUNBLE1BQU1ZLElBQUksR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTUMsT0FBTyxHQUFHRCxPQUFPLENBQUMsNkJBQUQsQ0FBdkI7O0FBQ0FBLE9BQU8sQ0FBQyxzQkFBRCxDQUFQOztBQUNBLE1BQU1FLE9BQU8sR0FBR0YsT0FBTyxDQUFDLHlCQUFELENBQXZCOztBQUNBLE1BQU1HLE9BQU8sR0FBR0gsT0FBTyxDQUFDLGlCQUFELENBQXZCOztBQUNBLE1BQU1JLGNBQWMsR0FBR0osT0FBTyxDQUFDLDhCQUFELENBQTlCOztBQUNBLE1BQU1LLE9BQU8sR0FBR0wsT0FBTyxDQUFDLFNBQUQsQ0FBdkIsQyxDQUNBOzs7QUFDQSxNQUFNTSxXQUFXLEdBQUdOLE9BQU8sQ0FBQyxpQkFBRCxDQUEzQixDLENBQ0E7OztBQUNBLE1BQU1PLEtBQUssR0FBRywwRkFBZDs7QUFDQSxTQUFTQyxlQUFULENBQXlCQyxJQUF6QixFQUErQkMsS0FBL0IsRUFBc0M7QUFDbEMsUUFBTUMsY0FBYyxHQUFHTCxXQUFXLENBQUNJLEtBQUQsRUFBUSxHQUFSLENBQWxDO0FBQ0EsUUFBTUUsUUFBUSxHQUFHRCxjQUFjLENBQUNFLElBQWYsQ0FBb0JKLElBQXBCLENBQWpCOztBQUNBLE1BQUlHLFFBQVEsS0FBSyxJQUFqQixFQUF1QjtBQUNuQixXQUFPQSxRQUFRLENBQUNFLE1BQVQsRUFBUDtBQUNIOztBQUNELFNBQU9DLFNBQVA7QUFDSDs7QUFDRGpCLE9BQU8sQ0FBQ1UsZUFBUixHQUEwQkEsZUFBMUI7O0FBQ0EsU0FBU1EsU0FBVCxDQUFtQkMsSUFBbkIsRUFBeUJQLEtBQXpCLEVBQWdDUSxRQUFoQyxFQUEwQ0MsU0FBUyxHQUFHLENBQXRELEVBQXlEO0FBQ3JELFFBQU1DLEtBQUssR0FBR1osZUFBZSxDQUFDUyxJQUFELEVBQU9QLEtBQVAsQ0FBN0I7O0FBQ0EsTUFBSSxDQUFDVSxLQUFMLEVBQVk7QUFDUjtBQUNILEdBSm9ELENBS3JEOzs7QUFDQUEsRUFBQUEsS0FBSyxDQUFDSCxJQUFOLEdBQWFJLE1BQU0sQ0FBQ0QsS0FBSyxDQUFDSCxJQUFQLENBQW5CLENBTnFELENBT3JEOztBQUNBRyxFQUFBQSxLQUFLLENBQUNFLE1BQU4sR0FBZUQsTUFBTSxDQUFDRCxLQUFLLENBQUNFLE1BQVAsQ0FBckI7QUFDQSxTQUFPO0FBQ0hDLElBQUFBLElBQUksRUFBRUgsS0FBSyxDQUFDRyxJQURUO0FBRUhDLElBQUFBLE9BQU8sRUFBRUosS0FBSyxDQUFDSSxPQUZaO0FBR0hGLElBQUFBLE1BQU0sRUFBRUcsS0FBSyxDQUFDTCxLQUFLLENBQUNFLE1BQVAsQ0FBTCxJQUF1QkYsS0FBSyxDQUFDRSxNQUFOLElBQWdCLENBQXZDLEdBQTJDLENBQTNDLEdBQStDRixLQUFLLENBQUNFLE1BQU4sR0FBZUgsU0FIbkU7QUFJSEYsSUFBQUEsSUFBSSxFQUFFRyxLQUFLLENBQUNILElBSlQ7QUFLSFMsSUFBQUEsSUFBSSxFQUFFTixLQUFLLENBQUNNLElBTFQ7QUFNSEMsSUFBQUEsUUFBUSxFQUFFVDtBQU5QLEdBQVA7QUFRSDs7QUFDRHBCLE9BQU8sQ0FBQ2tCLFNBQVIsR0FBb0JBLFNBQXBCOztBQUNBLE1BQU1ZLFVBQU4sQ0FBaUI7QUFDYkMsRUFBQUEsV0FBVyxDQUFDQyxPQUFELEVBQVVDLGFBQVYsRUFBeUJDLGdCQUF6QixFQUEyQ0MsWUFBWSxHQUFHLENBQTFELEVBQTZEO0FBQ3BFLFNBQUtGLGFBQUwsR0FBcUJBLGFBQXJCO0FBQ0EsU0FBS0MsZ0JBQUwsR0FBd0JBLGdCQUF4QjtBQUNBLFNBQUtDLFlBQUwsR0FBb0JBLFlBQXBCO0FBQ0EsU0FBS0MsS0FBTCxHQUFhRixnQkFBZ0IsQ0FBQ0csR0FBakIsQ0FBcUI5QixPQUFPLENBQUMrQixjQUE3QixFQUE2Q0MsYUFBN0MsQ0FBMkRQLE9BQTNELENBQWI7QUFDQSxTQUFLUSxZQUFMLEdBQW9CLElBQUlsQyxjQUFjLENBQUNtQyxZQUFuQixDQUFnQyxLQUFLQyxJQUFMLENBQVVWLE9BQTFDLEVBQW1EQyxhQUFuRCxFQUFrRUMsZ0JBQWxFLENBQXBCO0FBQ0EsU0FBS1MsYUFBTCxHQUFxQlQsZ0JBQWdCLENBQUNHLEdBQWpCLENBQXFCaEMsT0FBTyxDQUFDdUMscUJBQTdCLENBQXJCO0FBQ0EsU0FBS0MsU0FBTCxHQUFpQlgsZ0JBQWdCLENBQUNHLEdBQWpCLENBQXFCbEMsT0FBTyxDQUFDMkMsaUJBQTdCLENBQWpCO0FBQ0g7O0FBQ2lCLE1BQWRDLGNBQWMsR0FBRztBQUNqQixXQUFPLEtBQUtDLGVBQVo7QUFDSDs7QUFDTyxNQUFKTixJQUFJLEdBQUc7QUFDUCxXQUFPLEtBQUtOLEtBQVo7QUFDSDs7QUFDRGEsRUFBQUEsSUFBSSxDQUFDQyxRQUFELEVBQVdDLFlBQVgsRUFBeUI7QUFDekIsV0FBT3ZFLFNBQVMsQ0FBQyxJQUFELEVBQU8sS0FBSyxDQUFaLEVBQWUsS0FBSyxDQUFwQixFQUF1QixhQUFhO0FBQ2hELFdBQUtvRSxlQUFMLEdBQXVCLEtBQUtMLGFBQUwsQ0FBbUJTLFdBQW5CLENBQStCRixRQUFRLENBQUNHLEdBQXhDLENBQXZCO0FBQ0EsYUFBTyxLQUFLQyxTQUFMLENBQWVKLFFBQWYsRUFBeUJDLFlBQXpCLENBQVA7QUFDSCxLQUhlLENBQWhCO0FBSUg7O0FBQ0RJLEVBQUFBLG9CQUFvQixDQUFDTCxRQUFELEVBQVc7QUFDM0IsVUFBTU0sZUFBZSxHQUFHLEtBQUtYLFNBQUwsQ0FBZVksa0JBQWYsQ0FBa0NQLFFBQVEsQ0FBQ0csR0FBM0MsQ0FBeEI7QUFDQSxVQUFNSyxpQkFBaUIsR0FBSUYsZUFBZSxJQUFJLE9BQU9BLGVBQWUsQ0FBQ0gsR0FBaEIsQ0FBb0JNLE1BQTNCLEtBQXNDLFFBQTFELEdBQXNFSCxlQUFlLENBQUNILEdBQWhCLENBQW9CTSxNQUExRixHQUFtRzFDLFNBQTdIO0FBQ0EsV0FBTyxPQUFPeUMsaUJBQVAsS0FBNkIsUUFBN0IsR0FBd0NBLGlCQUF4QyxHQUE0RHpELElBQUksQ0FBQzJELE9BQUwsQ0FBYVYsUUFBUSxDQUFDRyxHQUFULENBQWFNLE1BQTFCLENBQW5FO0FBQ0g7O0FBQ1MsTUFBTkUsTUFBTSxHQUFHO0FBQ1QsV0FBTyxLQUFLM0IsZ0JBQUwsQ0FBc0JHLEdBQXRCLENBQTBCaEMsT0FBTyxDQUFDeUQsT0FBbEMsQ0FBUDtBQUNILEdBN0JZLENBOEJiOzs7QUFDQUMsRUFBQUEscUJBQXFCLENBQUNDLEtBQUQsRUFBUUMsZ0JBQVIsRUFBMEI7QUFDM0MsUUFBSUEsZ0JBQWdCLENBQUNELEtBQUQsQ0FBcEIsRUFBNkI7QUFDekIsWUFBTUUsWUFBWSxHQUFHRCxnQkFBZ0IsQ0FBQ0QsS0FBRCxDQUFyQzs7QUFDQSxjQUFRRSxZQUFSO0FBQ0ksYUFBSyxPQUFMO0FBQ0ksaUJBQU8zRCxPQUFPLENBQUM0RCxtQkFBUixDQUE0QkMsS0FBbkM7O0FBQ0osYUFBSyxNQUFMO0FBQ0ksaUJBQU83RCxPQUFPLENBQUM0RCxtQkFBUixDQUE0QkUsSUFBbkM7O0FBQ0osYUFBSyxhQUFMO0FBQ0ksaUJBQU85RCxPQUFPLENBQUM0RCxtQkFBUixDQUE0QkcsV0FBbkM7O0FBQ0osYUFBSyxTQUFMO0FBQ0ksaUJBQU8vRCxPQUFPLENBQUM0RCxtQkFBUixDQUE0QkksT0FBbkM7O0FBQ0o7QUFBUztBQUNMLGdCQUFJaEUsT0FBTyxDQUFDNEQsbUJBQVIsQ0FBNEJELFlBQTVCLENBQUosRUFBK0M7QUFDM0M7QUFDQSxxQkFBTzNELE9BQU8sQ0FBQzRELG1CQUFSLENBQTRCRCxZQUE1QixDQUFQO0FBQ0g7QUFDSjtBQWRMO0FBZ0JIOztBQUNELFdBQU8zRCxPQUFPLENBQUM0RCxtQkFBUixDQUE0QkcsV0FBbkM7QUFDSDs7QUFDREUsRUFBQUEsR0FBRyxDQUFDQyxJQUFELEVBQU92QixRQUFQLEVBQWlCQyxZQUFqQixFQUErQnVCLEtBQUssR0FBR2pFLEtBQXZDLEVBQThDO0FBQzdDLFdBQU83QixTQUFTLENBQUMsSUFBRCxFQUFPLEtBQUssQ0FBWixFQUFlLEtBQUssQ0FBcEIsRUFBdUIsYUFBYTtBQUNoRCxVQUFJLENBQUMsS0FBSzhELElBQUwsQ0FBVWlDLFNBQVYsQ0FBb0J6QixRQUFRLENBQUNHLEdBQTdCLENBQUwsRUFBd0M7QUFDcEMsZUFBTyxFQUFQO0FBQ0g7O0FBQ0QsWUFBTXVCLGFBQWEsR0FBRyxLQUFLbEMsSUFBTCxDQUFVbUMsZ0JBQVYsQ0FBMkJKLElBQTNCLEVBQWlDdkIsUUFBUSxDQUFDRyxHQUExQyxDQUF0QjtBQUNBLFlBQU15QixHQUFHLEdBQUcsS0FBS3ZCLG9CQUFMLENBQTBCTCxRQUExQixDQUFaO0FBQ0EsWUFBTTZCLDJCQUEyQixHQUFHLEtBQUs3QyxnQkFBTCxDQUFzQkcsR0FBdEIsQ0FBMEJqQyxPQUFPLENBQUM0RSwyQkFBbEMsQ0FBcEM7O0FBQ0EsVUFBSTtBQUNBLGNBQU10RixNQUFNLEdBQUcsTUFBTXFGLDJCQUEyQixDQUFDaEUsSUFBNUIsQ0FBaUM2RCxhQUFqQyxFQUFnRDtBQUFFRSxVQUFBQSxHQUFGO0FBQU9HLFVBQUFBLEtBQUssRUFBRTlCLFlBQWQ7QUFBNEIrQixVQUFBQSxjQUFjLEVBQUU7QUFBNUMsU0FBaEQsRUFBcUdoQyxRQUFRLENBQUNHLEdBQTlHLENBQXJCO0FBQ0EsYUFBSzhCLHlCQUFMLENBQStCekYsTUFBTSxDQUFDMEYsTUFBdEM7QUFDQSxlQUFPLE1BQU0sS0FBS0MsYUFBTCxDQUFtQjNGLE1BQU0sQ0FBQzBGLE1BQTFCLEVBQWtDbEMsUUFBbEMsRUFBNENDLFlBQTVDLEVBQTBEdUIsS0FBMUQsQ0FBYjtBQUNILE9BSkQsQ0FLQSxPQUFPVixLQUFQLEVBQWM7QUFDVixhQUFLc0IsV0FBTCxDQUFpQnRCLEtBQWpCLEVBQXdCZCxRQUFRLENBQUNHLEdBQWpDLEVBQXNDdUIsYUFBdEM7QUFDQSxlQUFPLEVBQVA7QUFDSDtBQUNKLEtBaEJlLENBQWhCO0FBaUJIOztBQUNEUyxFQUFBQSxhQUFhLENBQUNFLE1BQUQsRUFBU3JDLFFBQVQsRUFBbUIrQixLQUFuQixFQUEwQlAsS0FBMUIsRUFBaUM7QUFDMUMsV0FBTzlGLFNBQVMsQ0FBQyxJQUFELEVBQU8sS0FBSyxDQUFaLEVBQWUsS0FBSyxDQUFwQixFQUF1QixhQUFhO0FBQ2hELFlBQU00RyxXQUFXLEdBQUdELE1BQU0sQ0FBQ0UsVUFBUCxDQUFrQjtBQUFFQyxRQUFBQSxrQkFBa0IsRUFBRSxLQUF0QjtBQUE2QkMsUUFBQUEsSUFBSSxFQUFFO0FBQW5DLE9BQWxCLENBQXBCO0FBQ0EsYUFBTyxLQUFLQyxVQUFMLENBQWdCSixXQUFoQixFQUE2QmQsS0FBN0IsQ0FBUDtBQUNILEtBSGUsQ0FBaEI7QUFJSDs7QUFDRFksRUFBQUEsV0FBVyxDQUFDdEIsS0FBRCxFQUFRNkIsUUFBUixFQUFrQkMsUUFBbEIsRUFBNEI7QUFDbkMsU0FBS3RELFlBQUwsQ0FBa0I4QyxXQUFsQixDQUE4QnRCLEtBQTlCLEVBQXFDNkIsUUFBckMsRUFBK0NDLFFBQS9DLEVBQ0tDLEtBREwsQ0FDVyxLQUFLbEMsTUFBTCxDQUFZbUMsUUFBWixDQUFxQkMsSUFBckIsQ0FBMEIsSUFBMUIsRUFBZ0MsbUNBQWhDLENBRFg7QUFFSDs7QUFDRC9FLEVBQUFBLFNBQVMsQ0FBQ0MsSUFBRCxFQUFPdUQsS0FBUCxFQUFjO0FBQ25CLFdBQU94RCxTQUFTLENBQUNDLElBQUQsRUFBT3VELEtBQVAsRUFBYyxLQUFLaEMsSUFBTCxDQUFVd0QsRUFBeEIsRUFBNEIsS0FBSy9ELFlBQWpDLENBQWhCO0FBQ0g7O0FBQ0R5RCxFQUFBQSxVQUFVLENBQUNKLFdBQUQsRUFBY2QsS0FBZCxFQUFxQjtBQUMzQixVQUFNeUIsUUFBUSxHQUFHLEVBQWpCOztBQUNBLFNBQUssTUFBTWhGLElBQVgsSUFBbUJxRSxXQUFuQixFQUFnQztBQUM1QixVQUFJO0FBQ0EsY0FBTVksR0FBRyxHQUFHLEtBQUtsRixTQUFMLENBQWVDLElBQWYsRUFBcUJ1RCxLQUFyQixDQUFaOztBQUNBLFlBQUkwQixHQUFKLEVBQVM7QUFDTEQsVUFBQUEsUUFBUSxDQUFDRSxJQUFULENBQWNELEdBQWQ7O0FBQ0EsY0FBSUQsUUFBUSxDQUFDRyxNQUFULElBQW1CLEtBQUt2RCxjQUFMLENBQW9Cd0QsT0FBcEIsQ0FBNEJDLG1CQUFuRCxFQUF3RTtBQUNwRTtBQUNIO0FBQ0o7QUFDSixPQVJELENBU0EsT0FBT0MsRUFBUCxFQUFXO0FBQ1AsYUFBSzVDLE1BQUwsQ0FBWW1DLFFBQVosQ0FBc0IsV0FBVSxLQUFLdEQsSUFBTCxDQUFVd0QsRUFBRywrQkFBOEIvRSxJQUFLLEdBQWhGLEVBQW9Gc0YsRUFBcEY7QUFDSDtBQUNKOztBQUNELFdBQU9OLFFBQVA7QUFDSDs7QUFDRGhCLEVBQUFBLHlCQUF5QixDQUFDeEUsSUFBRCxFQUFPO0FBQzVCLFNBQUtzQixhQUFMLENBQW1CeUUsTUFBbkIsQ0FBMkIsR0FBRSxJQUFJQyxNQUFKLENBQVcsRUFBWCxDQUFlLG9CQUFtQixLQUFLakUsSUFBTCxDQUFVd0QsRUFBRyxHQUFFLElBQUlTLE1BQUosQ0FBVyxFQUFYLENBQWUsSUFBN0Y7QUFDQSxTQUFLMUUsYUFBTCxDQUFtQnlFLE1BQW5CLENBQTBCL0YsSUFBMUI7QUFDSDs7QUExR1k7O0FBNEdqQlgsT0FBTyxDQUFDOEIsVUFBUixHQUFxQkEsVUFBckIiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cbid1c2Ugc3RyaWN0JztcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XG4gICAgfSk7XG59O1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vYXBwbGljYXRpb24vdHlwZXNcIik7XG5yZXF1aXJlKFwiLi4vY29tbW9uL2V4dGVuc2lvbnNcIik7XG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uL2NvbW1vbi9wcm9jZXNzL3R5cGVzXCIpO1xuY29uc3QgdHlwZXNfMyA9IHJlcXVpcmUoXCIuLi9jb21tb24vdHlwZXNcIik7XG5jb25zdCBlcnJvckhhbmRsZXJfMSA9IHJlcXVpcmUoXCIuL2Vycm9ySGFuZGxlcnMvZXJyb3JIYW5kbGVyXCIpO1xuY29uc3QgdHlwZXNfNCA9IHJlcXVpcmUoXCIuL3R5cGVzXCIpO1xuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXJlcXVpcmUtaW1wb3J0cyBuby12YXItcmVxdWlyZXNcbmNvbnN0IG5hbWVkUmVnZXhwID0gcmVxdWlyZSgnbmFtZWQtanMtcmVnZXhwJyk7XG4vLyBBbGxvdyBuZWdhdGl2ZSBjb2x1bW4gbnVtYmVycyAoaHR0cHM6Ly9naXRodWIuY29tL1B5Q1FBL3B5bGludC9pc3N1ZXMvMTgyMilcbmNvbnN0IFJFR0VYID0gJyg/PGxpbmU+XFxcXGQrKSwoPzxjb2x1bW4+LT9cXFxcZCspLCg/PHR5cGU+XFxcXHcrKSwoPzxjb2RlPlxcXFx3XFxcXGQrKTooPzxtZXNzYWdlPi4qKVxcXFxyPyhcXFxcbnwkKSc7XG5mdW5jdGlvbiBtYXRjaE5hbWVkUmVnRXgoZGF0YSwgcmVnZXgpIHtcbiAgICBjb25zdCBjb21waWxlZFJlZ2V4cCA9IG5hbWVkUmVnZXhwKHJlZ2V4LCAnZycpO1xuICAgIGNvbnN0IHJhd01hdGNoID0gY29tcGlsZWRSZWdleHAuZXhlYyhkYXRhKTtcbiAgICBpZiAocmF3TWF0Y2ggIT09IG51bGwpIHtcbiAgICAgICAgcmV0dXJuIHJhd01hdGNoLmdyb3VwcygpO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufVxuZXhwb3J0cy5tYXRjaE5hbWVkUmVnRXggPSBtYXRjaE5hbWVkUmVnRXg7XG5mdW5jdGlvbiBwYXJzZUxpbmUobGluZSwgcmVnZXgsIGxpbnRlcklELCBjb2xPZmZzZXQgPSAwKSB7XG4gICAgY29uc3QgbWF0Y2ggPSBtYXRjaE5hbWVkUmVnRXgobGluZSwgcmVnZXgpO1xuICAgIGlmICghbWF0Y2gpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55XG4gICAgbWF0Y2gubGluZSA9IE51bWJlcihtYXRjaC5saW5lKTtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55XG4gICAgbWF0Y2guY29sdW1uID0gTnVtYmVyKG1hdGNoLmNvbHVtbik7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgY29kZTogbWF0Y2guY29kZSxcbiAgICAgICAgbWVzc2FnZTogbWF0Y2gubWVzc2FnZSxcbiAgICAgICAgY29sdW1uOiBpc05hTihtYXRjaC5jb2x1bW4pIHx8IG1hdGNoLmNvbHVtbiA8PSAwID8gMCA6IG1hdGNoLmNvbHVtbiAtIGNvbE9mZnNldCxcbiAgICAgICAgbGluZTogbWF0Y2gubGluZSxcbiAgICAgICAgdHlwZTogbWF0Y2gudHlwZSxcbiAgICAgICAgcHJvdmlkZXI6IGxpbnRlcklEXG4gICAgfTtcbn1cbmV4cG9ydHMucGFyc2VMaW5lID0gcGFyc2VMaW5lO1xuY2xhc3MgQmFzZUxpbnRlciB7XG4gICAgY29uc3RydWN0b3IocHJvZHVjdCwgb3V0cHV0Q2hhbm5lbCwgc2VydmljZUNvbnRhaW5lciwgY29sdW1uT2Zmc2V0ID0gMCkge1xuICAgICAgICB0aGlzLm91dHB1dENoYW5uZWwgPSBvdXRwdXRDaGFubmVsO1xuICAgICAgICB0aGlzLnNlcnZpY2VDb250YWluZXIgPSBzZXJ2aWNlQ29udGFpbmVyO1xuICAgICAgICB0aGlzLmNvbHVtbk9mZnNldCA9IGNvbHVtbk9mZnNldDtcbiAgICAgICAgdGhpcy5faW5mbyA9IHNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzQuSUxpbnRlck1hbmFnZXIpLmdldExpbnRlckluZm8ocHJvZHVjdCk7XG4gICAgICAgIHRoaXMuZXJyb3JIYW5kbGVyID0gbmV3IGVycm9ySGFuZGxlcl8xLkVycm9ySGFuZGxlcih0aGlzLmluZm8ucHJvZHVjdCwgb3V0cHV0Q2hhbm5lbCwgc2VydmljZUNvbnRhaW5lcik7XG4gICAgICAgIHRoaXMuY29uZmlnU2VydmljZSA9IHNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzMuSUNvbmZpZ3VyYXRpb25TZXJ2aWNlKTtcbiAgICAgICAgdGhpcy53b3Jrc3BhY2UgPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklXb3Jrc3BhY2VTZXJ2aWNlKTtcbiAgICB9XG4gICAgZ2V0IHB5dGhvblNldHRpbmdzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fcHl0aG9uU2V0dGluZ3M7XG4gICAgfVxuICAgIGdldCBpbmZvKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5faW5mbztcbiAgICB9XG4gICAgbGludChkb2N1bWVudCwgY2FuY2VsbGF0aW9uKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICB0aGlzLl9weXRob25TZXR0aW5ncyA9IHRoaXMuY29uZmlnU2VydmljZS5nZXRTZXR0aW5ncyhkb2N1bWVudC51cmkpO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMucnVuTGludGVyKGRvY3VtZW50LCBjYW5jZWxsYXRpb24pO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgZ2V0V29ya3NwYWNlUm9vdFBhdGgoZG9jdW1lbnQpIHtcbiAgICAgICAgY29uc3Qgd29ya3NwYWNlRm9sZGVyID0gdGhpcy53b3Jrc3BhY2UuZ2V0V29ya3NwYWNlRm9sZGVyKGRvY3VtZW50LnVyaSk7XG4gICAgICAgIGNvbnN0IHdvcmtzcGFjZVJvb3RQYXRoID0gKHdvcmtzcGFjZUZvbGRlciAmJiB0eXBlb2Ygd29ya3NwYWNlRm9sZGVyLnVyaS5mc1BhdGggPT09ICdzdHJpbmcnKSA/IHdvcmtzcGFjZUZvbGRlci51cmkuZnNQYXRoIDogdW5kZWZpbmVkO1xuICAgICAgICByZXR1cm4gdHlwZW9mIHdvcmtzcGFjZVJvb3RQYXRoID09PSAnc3RyaW5nJyA/IHdvcmtzcGFjZVJvb3RQYXRoIDogcGF0aC5kaXJuYW1lKGRvY3VtZW50LnVyaS5mc1BhdGgpO1xuICAgIH1cbiAgICBnZXQgbG9nZ2VyKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18zLklMb2dnZXIpO1xuICAgIH1cbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55XG4gICAgcGFyc2VNZXNzYWdlc1NldmVyaXR5KGVycm9yLCBjYXRlZ29yeVNldmVyaXR5KSB7XG4gICAgICAgIGlmIChjYXRlZ29yeVNldmVyaXR5W2Vycm9yXSkge1xuICAgICAgICAgICAgY29uc3Qgc2V2ZXJpdHlOYW1lID0gY2F0ZWdvcnlTZXZlcml0eVtlcnJvcl07XG4gICAgICAgICAgICBzd2l0Y2ggKHNldmVyaXR5TmFtZSkge1xuICAgICAgICAgICAgICAgIGNhc2UgJ0Vycm9yJzpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHR5cGVzXzQuTGludE1lc3NhZ2VTZXZlcml0eS5FcnJvcjtcbiAgICAgICAgICAgICAgICBjYXNlICdIaW50JzpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHR5cGVzXzQuTGludE1lc3NhZ2VTZXZlcml0eS5IaW50O1xuICAgICAgICAgICAgICAgIGNhc2UgJ0luZm9ybWF0aW9uJzpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHR5cGVzXzQuTGludE1lc3NhZ2VTZXZlcml0eS5JbmZvcm1hdGlvbjtcbiAgICAgICAgICAgICAgICBjYXNlICdXYXJuaW5nJzpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHR5cGVzXzQuTGludE1lc3NhZ2VTZXZlcml0eS5XYXJuaW5nO1xuICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVzXzQuTGludE1lc3NhZ2VTZXZlcml0eVtzZXZlcml0eU5hbWVdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHlwZXNfNC5MaW50TWVzc2FnZVNldmVyaXR5W3NldmVyaXR5TmFtZV07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHR5cGVzXzQuTGludE1lc3NhZ2VTZXZlcml0eS5JbmZvcm1hdGlvbjtcbiAgICB9XG4gICAgcnVuKGFyZ3MsIGRvY3VtZW50LCBjYW5jZWxsYXRpb24sIHJlZ0V4ID0gUkVHRVgpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5pbmZvLmlzRW5hYmxlZChkb2N1bWVudC51cmkpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgZXhlY3V0aW9uSW5mbyA9IHRoaXMuaW5mby5nZXRFeGVjdXRpb25JbmZvKGFyZ3MsIGRvY3VtZW50LnVyaSk7XG4gICAgICAgICAgICBjb25zdCBjd2QgPSB0aGlzLmdldFdvcmtzcGFjZVJvb3RQYXRoKGRvY3VtZW50KTtcbiAgICAgICAgICAgIGNvbnN0IHB5dGhvblRvb2xzRXhlY3V0aW9uU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMi5JUHl0aG9uVG9vbEV4ZWN1dGlvblNlcnZpY2UpO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSB5aWVsZCBweXRob25Ub29sc0V4ZWN1dGlvblNlcnZpY2UuZXhlYyhleGVjdXRpb25JbmZvLCB7IGN3ZCwgdG9rZW46IGNhbmNlbGxhdGlvbiwgbWVyZ2VTdGRPdXRFcnI6IGZhbHNlIH0sIGRvY3VtZW50LnVyaSk7XG4gICAgICAgICAgICAgICAgdGhpcy5kaXNwbGF5TGludGVyUmVzdWx0SGVhZGVyKHJlc3VsdC5zdGRvdXQpO1xuICAgICAgICAgICAgICAgIHJldHVybiB5aWVsZCB0aGlzLnBhcnNlTWVzc2FnZXMocmVzdWx0LnN0ZG91dCwgZG9jdW1lbnQsIGNhbmNlbGxhdGlvbiwgcmVnRXgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVFcnJvcihlcnJvciwgZG9jdW1lbnQudXJpLCBleGVjdXRpb25JbmZvKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gW107XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBwYXJzZU1lc3NhZ2VzKG91dHB1dCwgZG9jdW1lbnQsIHRva2VuLCByZWdFeCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3Qgb3V0cHV0TGluZXMgPSBvdXRwdXQuc3BsaXRMaW5lcyh7IHJlbW92ZUVtcHR5RW50cmllczogZmFsc2UsIHRyaW06IGZhbHNlIH0pO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMucGFyc2VMaW5lcyhvdXRwdXRMaW5lcywgcmVnRXgpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgaGFuZGxlRXJyb3IoZXJyb3IsIHJlc291cmNlLCBleGVjSW5mbykge1xuICAgICAgICB0aGlzLmVycm9ySGFuZGxlci5oYW5kbGVFcnJvcihlcnJvciwgcmVzb3VyY2UsIGV4ZWNJbmZvKVxuICAgICAgICAgICAgLmNhdGNoKHRoaXMubG9nZ2VyLmxvZ0Vycm9yLmJpbmQodGhpcywgJ0Vycm9yIGluIGVycm9ySGFuZGxlci5oYW5kbGVFcnJvcicpKTtcbiAgICB9XG4gICAgcGFyc2VMaW5lKGxpbmUsIHJlZ0V4KSB7XG4gICAgICAgIHJldHVybiBwYXJzZUxpbmUobGluZSwgcmVnRXgsIHRoaXMuaW5mby5pZCwgdGhpcy5jb2x1bW5PZmZzZXQpO1xuICAgIH1cbiAgICBwYXJzZUxpbmVzKG91dHB1dExpbmVzLCByZWdFeCkge1xuICAgICAgICBjb25zdCBtZXNzYWdlcyA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IGxpbmUgb2Ygb3V0cHV0TGluZXMpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbXNnID0gdGhpcy5wYXJzZUxpbmUobGluZSwgcmVnRXgpO1xuICAgICAgICAgICAgICAgIGlmIChtc2cpIHtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZXMucHVzaChtc2cpO1xuICAgICAgICAgICAgICAgICAgICBpZiAobWVzc2FnZXMubGVuZ3RoID49IHRoaXMucHl0aG9uU2V0dGluZ3MubGludGluZy5tYXhOdW1iZXJPZlByb2JsZW1zKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChleCkge1xuICAgICAgICAgICAgICAgIHRoaXMubG9nZ2VyLmxvZ0Vycm9yKGBMaW50ZXIgJyR7dGhpcy5pbmZvLmlkfScgZmFpbGVkIHRvIHBhcnNlIHRoZSBsaW5lICcke2xpbmV9LmAsIGV4KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbWVzc2FnZXM7XG4gICAgfVxuICAgIGRpc3BsYXlMaW50ZXJSZXN1bHRIZWFkZXIoZGF0YSkge1xuICAgICAgICB0aGlzLm91dHB1dENoYW5uZWwuYXBwZW5kKGAkeycjJy5yZXBlYXQoMTApfUxpbnRpbmcgT3V0cHV0IC0gJHt0aGlzLmluZm8uaWR9JHsnIycucmVwZWF0KDEwKX1cXG5gKTtcbiAgICAgICAgdGhpcy5vdXRwdXRDaGFubmVsLmFwcGVuZChkYXRhKTtcbiAgICB9XG59XG5leHBvcnRzLkJhc2VMaW50ZXIgPSBCYXNlTGludGVyO1xuLy8jIHNvdXJjZU1hcHBpbmdVUkw9YmFzZUxpbnRlci5qcy5tYXAiXX0=