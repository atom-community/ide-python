// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const minimatch_1 = require("minimatch");

const path = require("path");

const vscode = require("vscode");

const types_1 = require("../common/application/types");

const constants_1 = require("../common/constants");

const types_2 = require("../common/platform/types");

const types_3 = require("../common/types");

const stopWatch_1 = require("../common/utils/stopWatch");

const types_4 = require("../ioc/types");

const provider_1 = require("../jupyter/provider");

const telemetry_1 = require("../telemetry");

const constants_2 = require("../telemetry/constants");

const types_5 = require("./types");

const PYTHON = {
  language: 'python'
};
const lintSeverityToVSSeverity = new Map();
lintSeverityToVSSeverity.set(types_5.LintMessageSeverity.Error, vscode.DiagnosticSeverity.Error);
lintSeverityToVSSeverity.set(types_5.LintMessageSeverity.Hint, vscode.DiagnosticSeverity.Hint);
lintSeverityToVSSeverity.set(types_5.LintMessageSeverity.Information, vscode.DiagnosticSeverity.Information);
lintSeverityToVSSeverity.set(types_5.LintMessageSeverity.Warning, vscode.DiagnosticSeverity.Warning);
let LintingEngine = class LintingEngine {
  constructor(serviceContainer) {
    this.serviceContainer = serviceContainer;
    this.pendingLintings = new Map();

    this.documentHasJupyterCodeCells = (a, b) => Promise.resolve(false);

    this.documents = serviceContainer.get(types_1.IDocumentManager);
    this.workspace = serviceContainer.get(types_1.IWorkspaceService);
    this.configurationService = serviceContainer.get(types_3.IConfigurationService);
    this.outputChannel = serviceContainer.get(types_3.IOutputChannel, constants_1.STANDARD_OUTPUT_CHANNEL);
    this.linterManager = serviceContainer.get(types_5.ILinterManager);
    this.fileSystem = serviceContainer.get(types_2.IFileSystem);
    this.diagnosticCollection = vscode.languages.createDiagnosticCollection('python');
  }

  get diagnostics() {
    return this.diagnosticCollection;
  }

  clearDiagnostics(document) {
    if (this.diagnosticCollection.has(document.uri)) {
      this.diagnosticCollection.delete(document.uri);
    }
  }

  lintOpenPythonFiles() {
    return __awaiter(this, void 0, void 0, function* () {
      this.diagnosticCollection.clear();
      const promises = this.documents.textDocuments.map(document => __awaiter(this, void 0, void 0, function* () {
        return this.lintDocument(document, 'auto');
      }));
      yield Promise.all(promises);
      return this.diagnosticCollection;
    });
  }

  lintDocument(document, trigger) {
    return __awaiter(this, void 0, void 0, function* () {
      this.diagnosticCollection.set(document.uri, []); // Check if we need to lint this document

      if (!(yield this.shouldLintDocument(document))) {
        return;
      }

      if (this.pendingLintings.has(document.uri.fsPath)) {
        this.pendingLintings.get(document.uri.fsPath).cancel();
        this.pendingLintings.delete(document.uri.fsPath);
      }

      const cancelToken = new vscode.CancellationTokenSource();
      cancelToken.token.onCancellationRequested(() => {
        if (this.pendingLintings.has(document.uri.fsPath)) {
          this.pendingLintings.delete(document.uri.fsPath);
        }
      });
      this.pendingLintings.set(document.uri.fsPath, cancelToken);
      const activeLinters = yield this.linterManager.getActiveLinters(false, document.uri);
      const promises = activeLinters.map(info => __awaiter(this, void 0, void 0, function* () {
        const stopWatch = new stopWatch_1.StopWatch();
        const linter = yield this.linterManager.createLinter(info.product, this.outputChannel, this.serviceContainer, document.uri);
        const promise = linter.lint(document, cancelToken.token);
        this.sendLinterRunTelemetry(info, document.uri, promise, stopWatch, trigger);
        return promise;
      }));
      const hasJupyterCodeCells = yield this.documentHasJupyterCodeCells(document, cancelToken.token); // linters will resolve asynchronously - keep a track of all
      // diagnostics reported as them come in.

      let diagnostics = [];
      const settings = this.configurationService.getSettings(document.uri);

      for (const p of promises) {
        const msgs = yield p;

        if (cancelToken.token.isCancellationRequested) {
          break;
        }

        if (this.isDocumentOpen(document.uri)) {
          // Build the message and suffix the message with the name of the linter used.
          for (const m of msgs) {
            // Ignore magic commands from jupyter.
            if (hasJupyterCodeCells && document.lineAt(m.line - 1).text.trim().startsWith('%') && (m.code === constants_1.LinterErrors.pylint.InvalidSyntax || m.code === constants_1.LinterErrors.prospector.InvalidSyntax || m.code === constants_1.LinterErrors.flake8.InvalidSyntax)) {
              continue;
            }

            diagnostics.push(this.createDiagnostics(m, document));
          } // Limit the number of messages to the max value.


          diagnostics = diagnostics.filter((value, index) => index <= settings.linting.maxNumberOfProblems);
        }
      } // Set all diagnostics found in this pass, as this method always clears existing diagnostics.


      this.diagnosticCollection.set(document.uri, diagnostics);
    });
  } // tslint:disable-next-line:no-any


  linkJupyterExtension(jupyter) {
    return __awaiter(this, void 0, void 0, function* () {
      if (!jupyter) {
        return;
      }

      if (!jupyter.isActive) {
        yield jupyter.activate();
      } // tslint:disable-next-line:no-unsafe-any


      jupyter.exports.registerLanguageProvider(PYTHON.language, new provider_1.JupyterProvider()); // tslint:disable-next-line:no-unsafe-any

      this.documentHasJupyterCodeCells = jupyter.exports.hasCodeCells;
    });
  }

  sendLinterRunTelemetry(info, resource, promise, stopWatch, trigger) {
    const linterExecutablePathName = info.pathName(resource);
    const properties = {
      tool: info.id,
      hasCustomArgs: info.linterArgs(resource).length > 0,
      trigger,
      executableSpecified: linterExecutablePathName.length > 0
    };
    telemetry_1.sendTelemetryWhenDone(constants_2.LINTING, promise, stopWatch, properties);
  }

  isDocumentOpen(uri) {
    return this.documents.textDocuments.some(document => document.uri.fsPath === uri.fsPath);
  }

  createDiagnostics(message, document) {
    const position = new vscode.Position(message.line - 1, message.column);
    const range = new vscode.Range(position, position);
    const severity = lintSeverityToVSSeverity.get(message.severity);
    const diagnostic = new vscode.Diagnostic(range, message.message, severity);
    diagnostic.code = message.code;
    diagnostic.source = message.provider;
    return diagnostic;
  }

  shouldLintDocument(document) {
    return __awaiter(this, void 0, void 0, function* () {
      if (!(yield this.linterManager.isLintingEnabled(false, document.uri))) {
        this.diagnosticCollection.set(document.uri, []);
        return false;
      }

      if (document.languageId !== PYTHON.language) {
        return false;
      }

      const workspaceFolder = this.workspace.getWorkspaceFolder(document.uri);
      const workspaceRootPath = workspaceFolder && typeof workspaceFolder.uri.fsPath === 'string' ? workspaceFolder.uri.fsPath : undefined;
      const relativeFileName = typeof workspaceRootPath === 'string' ? path.relative(workspaceRootPath, document.fileName) : document.fileName;
      const settings = this.configurationService.getSettings(document.uri);
      const ignoreMinmatches = settings.linting.ignorePatterns.map(pattern => new minimatch_1.Minimatch(pattern));

      if (ignoreMinmatches.some(matcher => matcher.match(document.fileName) || matcher.match(relativeFileName))) {
        return false;
      }

      if (document.uri.scheme !== 'file' || !document.uri.fsPath) {
        return false;
      }

      return this.fileSystem.fileExists(document.uri.fsPath);
    });
  }

};
LintingEngine = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_4.IServiceContainer))], LintingEngine);
exports.LintingEngine = LintingEngine;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpbnRpbmdFbmdpbmUuanMiXSwibmFtZXMiOlsiX19kZWNvcmF0ZSIsImRlY29yYXRvcnMiLCJ0YXJnZXQiLCJrZXkiLCJkZXNjIiwiYyIsImFyZ3VtZW50cyIsImxlbmd0aCIsInIiLCJPYmplY3QiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJkIiwiUmVmbGVjdCIsImRlY29yYXRlIiwiaSIsImRlZmluZVByb3BlcnR5IiwiX19wYXJhbSIsInBhcmFtSW5kZXgiLCJkZWNvcmF0b3IiLCJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiZXhwb3J0cyIsImludmVyc2lmeV8xIiwicmVxdWlyZSIsIm1pbmltYXRjaF8xIiwicGF0aCIsInZzY29kZSIsInR5cGVzXzEiLCJjb25zdGFudHNfMSIsInR5cGVzXzIiLCJ0eXBlc18zIiwic3RvcFdhdGNoXzEiLCJ0eXBlc180IiwicHJvdmlkZXJfMSIsInRlbGVtZXRyeV8xIiwiY29uc3RhbnRzXzIiLCJ0eXBlc181IiwiUFlUSE9OIiwibGFuZ3VhZ2UiLCJsaW50U2V2ZXJpdHlUb1ZTU2V2ZXJpdHkiLCJNYXAiLCJzZXQiLCJMaW50TWVzc2FnZVNldmVyaXR5IiwiRXJyb3IiLCJEaWFnbm9zdGljU2V2ZXJpdHkiLCJIaW50IiwiSW5mb3JtYXRpb24iLCJXYXJuaW5nIiwiTGludGluZ0VuZ2luZSIsImNvbnN0cnVjdG9yIiwic2VydmljZUNvbnRhaW5lciIsInBlbmRpbmdMaW50aW5ncyIsImRvY3VtZW50SGFzSnVweXRlckNvZGVDZWxscyIsImEiLCJiIiwiZG9jdW1lbnRzIiwiZ2V0IiwiSURvY3VtZW50TWFuYWdlciIsIndvcmtzcGFjZSIsIklXb3Jrc3BhY2VTZXJ2aWNlIiwiY29uZmlndXJhdGlvblNlcnZpY2UiLCJJQ29uZmlndXJhdGlvblNlcnZpY2UiLCJvdXRwdXRDaGFubmVsIiwiSU91dHB1dENoYW5uZWwiLCJTVEFOREFSRF9PVVRQVVRfQ0hBTk5FTCIsImxpbnRlck1hbmFnZXIiLCJJTGludGVyTWFuYWdlciIsImZpbGVTeXN0ZW0iLCJJRmlsZVN5c3RlbSIsImRpYWdub3N0aWNDb2xsZWN0aW9uIiwibGFuZ3VhZ2VzIiwiY3JlYXRlRGlhZ25vc3RpY0NvbGxlY3Rpb24iLCJkaWFnbm9zdGljcyIsImNsZWFyRGlhZ25vc3RpY3MiLCJkb2N1bWVudCIsImhhcyIsInVyaSIsImRlbGV0ZSIsImxpbnRPcGVuUHl0aG9uRmlsZXMiLCJjbGVhciIsInByb21pc2VzIiwidGV4dERvY3VtZW50cyIsIm1hcCIsImxpbnREb2N1bWVudCIsImFsbCIsInRyaWdnZXIiLCJzaG91bGRMaW50RG9jdW1lbnQiLCJmc1BhdGgiLCJjYW5jZWwiLCJjYW5jZWxUb2tlbiIsIkNhbmNlbGxhdGlvblRva2VuU291cmNlIiwidG9rZW4iLCJvbkNhbmNlbGxhdGlvblJlcXVlc3RlZCIsImFjdGl2ZUxpbnRlcnMiLCJnZXRBY3RpdmVMaW50ZXJzIiwiaW5mbyIsInN0b3BXYXRjaCIsIlN0b3BXYXRjaCIsImxpbnRlciIsImNyZWF0ZUxpbnRlciIsInByb2R1Y3QiLCJwcm9taXNlIiwibGludCIsInNlbmRMaW50ZXJSdW5UZWxlbWV0cnkiLCJoYXNKdXB5dGVyQ29kZUNlbGxzIiwic2V0dGluZ3MiLCJnZXRTZXR0aW5ncyIsInAiLCJtc2dzIiwiaXNDYW5jZWxsYXRpb25SZXF1ZXN0ZWQiLCJpc0RvY3VtZW50T3BlbiIsIm0iLCJsaW5lQXQiLCJsaW5lIiwidGV4dCIsInRyaW0iLCJzdGFydHNXaXRoIiwiY29kZSIsIkxpbnRlckVycm9ycyIsInB5bGludCIsIkludmFsaWRTeW50YXgiLCJwcm9zcGVjdG9yIiwiZmxha2U4IiwicHVzaCIsImNyZWF0ZURpYWdub3N0aWNzIiwiZmlsdGVyIiwiaW5kZXgiLCJsaW50aW5nIiwibWF4TnVtYmVyT2ZQcm9ibGVtcyIsImxpbmtKdXB5dGVyRXh0ZW5zaW9uIiwianVweXRlciIsImlzQWN0aXZlIiwiYWN0aXZhdGUiLCJyZWdpc3Rlckxhbmd1YWdlUHJvdmlkZXIiLCJKdXB5dGVyUHJvdmlkZXIiLCJoYXNDb2RlQ2VsbHMiLCJyZXNvdXJjZSIsImxpbnRlckV4ZWN1dGFibGVQYXRoTmFtZSIsInBhdGhOYW1lIiwicHJvcGVydGllcyIsInRvb2wiLCJpZCIsImhhc0N1c3RvbUFyZ3MiLCJsaW50ZXJBcmdzIiwiZXhlY3V0YWJsZVNwZWNpZmllZCIsInNlbmRUZWxlbWV0cnlXaGVuRG9uZSIsIkxJTlRJTkciLCJzb21lIiwibWVzc2FnZSIsInBvc2l0aW9uIiwiUG9zaXRpb24iLCJjb2x1bW4iLCJyYW5nZSIsIlJhbmdlIiwic2V2ZXJpdHkiLCJkaWFnbm9zdGljIiwiRGlhZ25vc3RpYyIsInNvdXJjZSIsInByb3ZpZGVyIiwiaXNMaW50aW5nRW5hYmxlZCIsImxhbmd1YWdlSWQiLCJ3b3Jrc3BhY2VGb2xkZXIiLCJnZXRXb3Jrc3BhY2VGb2xkZXIiLCJ3b3Jrc3BhY2VSb290UGF0aCIsInVuZGVmaW5lZCIsInJlbGF0aXZlRmlsZU5hbWUiLCJyZWxhdGl2ZSIsImZpbGVOYW1lIiwiaWdub3JlTWlubWF0Y2hlcyIsImlnbm9yZVBhdHRlcm5zIiwicGF0dGVybiIsIk1pbmltYXRjaCIsIm1hdGNoZXIiLCJtYXRjaCIsInNjaGVtZSIsImZpbGVFeGlzdHMiLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSVNlcnZpY2VDb250YWluZXIiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEsTUFBMEJD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USxDQUFDNkYsUUFBdkIsS0FBb0NLLE9BQU8sQ0FBQ0MsS0FBUixDQUFjUixnQkFBZCxDQUFyRSxDQUFKLEVBQTJHO0FBQ3ZHLGVBQU8sS0FBUDtBQUNIOztBQUNELFVBQUkzRixRQUFRLENBQUNFLEdBQVQsQ0FBYWtHLE1BQWIsS0FBd0IsTUFBeEIsSUFBa0MsQ0FBQ3BHLFFBQVEsQ0FBQ0UsR0FBVCxDQUFhVyxNQUFwRCxFQUE0RDtBQUN4RCxlQUFPLEtBQVA7QUFDSDs7QUFDRCxhQUFPLEtBQUtwQixVQUFMLENBQWdCNEcsVUFBaEIsQ0FBMkJyRyxRQUFRLENBQUNFLEdBQVQsQ0FBYVcsTUFBeEMsQ0FBUDtBQUNILEtBcEJlLENBQWhCO0FBcUJIOztBQWpKbUMsQ0FBeEM7QUFtSkF2QyxhQUFhLEdBQUdoRSxVQUFVLENBQUMsQ0FDdkJzQyxXQUFXLENBQUMwSixVQUFaLEVBRHVCLEVBRXZCaEwsT0FBTyxDQUFDLENBQUQsRUFBSXNCLFdBQVcsQ0FBQzJKLE1BQVosQ0FBbUJqSixPQUFPLENBQUNrSixpQkFBM0IsQ0FBSixDQUZnQixDQUFELEVBR3ZCbEksYUFIdUIsQ0FBMUI7QUFJQTNCLE9BQU8sQ0FBQzJCLGFBQVIsR0FBd0JBLGFBQXhCIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXG4ndXNlIHN0cmljdCc7XG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XG4gICAgdmFyIGMgPSBhcmd1bWVudHMubGVuZ3RoLCByID0gYyA8IDMgPyB0YXJnZXQgOiBkZXNjID09PSBudWxsID8gZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpIDogZGVzYywgZDtcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XG4gICAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjtcbn07XG52YXIgX19wYXJhbSA9ICh0aGlzICYmIHRoaXMuX19wYXJhbSkgfHwgZnVuY3Rpb24gKHBhcmFtSW5kZXgsIGRlY29yYXRvcikge1xuICAgIHJldHVybiBmdW5jdGlvbiAodGFyZ2V0LCBrZXkpIHsgZGVjb3JhdG9yKHRhcmdldCwga2V5LCBwYXJhbUluZGV4KTsgfVxufTtcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XG4gICAgfSk7XG59O1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuY29uc3QgaW52ZXJzaWZ5XzEgPSByZXF1aXJlKFwiaW52ZXJzaWZ5XCIpO1xuY29uc3QgbWluaW1hdGNoXzEgPSByZXF1aXJlKFwibWluaW1hdGNoXCIpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xuY29uc3QgdnNjb2RlID0gcmVxdWlyZShcInZzY29kZVwiKTtcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL2FwcGxpY2F0aW9uL3R5cGVzXCIpO1xuY29uc3QgY29uc3RhbnRzXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL2NvbnN0YW50c1wiKTtcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vY29tbW9uL3BsYXRmb3JtL3R5cGVzXCIpO1xuY29uc3QgdHlwZXNfMyA9IHJlcXVpcmUoXCIuLi9jb21tb24vdHlwZXNcIik7XG5jb25zdCBzdG9wV2F0Y2hfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vdXRpbHMvc3RvcFdhdGNoXCIpO1xuY29uc3QgdHlwZXNfNCA9IHJlcXVpcmUoXCIuLi9pb2MvdHlwZXNcIik7XG5jb25zdCBwcm92aWRlcl8xID0gcmVxdWlyZShcIi4uL2p1cHl0ZXIvcHJvdmlkZXJcIik7XG5jb25zdCB0ZWxlbWV0cnlfMSA9IHJlcXVpcmUoXCIuLi90ZWxlbWV0cnlcIik7XG5jb25zdCBjb25zdGFudHNfMiA9IHJlcXVpcmUoXCIuLi90ZWxlbWV0cnkvY29uc3RhbnRzXCIpO1xuY29uc3QgdHlwZXNfNSA9IHJlcXVpcmUoXCIuL3R5cGVzXCIpO1xuY29uc3QgUFlUSE9OID0geyBsYW5ndWFnZTogJ3B5dGhvbicgfTtcbmNvbnN0IGxpbnRTZXZlcml0eVRvVlNTZXZlcml0eSA9IG5ldyBNYXAoKTtcbmxpbnRTZXZlcml0eVRvVlNTZXZlcml0eS5zZXQodHlwZXNfNS5MaW50TWVzc2FnZVNldmVyaXR5LkVycm9yLCB2c2NvZGUuRGlhZ25vc3RpY1NldmVyaXR5LkVycm9yKTtcbmxpbnRTZXZlcml0eVRvVlNTZXZlcml0eS5zZXQodHlwZXNfNS5MaW50TWVzc2FnZVNldmVyaXR5LkhpbnQsIHZzY29kZS5EaWFnbm9zdGljU2V2ZXJpdHkuSGludCk7XG5saW50U2V2ZXJpdHlUb1ZTU2V2ZXJpdHkuc2V0KHR5cGVzXzUuTGludE1lc3NhZ2VTZXZlcml0eS5JbmZvcm1hdGlvbiwgdnNjb2RlLkRpYWdub3N0aWNTZXZlcml0eS5JbmZvcm1hdGlvbik7XG5saW50U2V2ZXJpdHlUb1ZTU2V2ZXJpdHkuc2V0KHR5cGVzXzUuTGludE1lc3NhZ2VTZXZlcml0eS5XYXJuaW5nLCB2c2NvZGUuRGlhZ25vc3RpY1NldmVyaXR5Lldhcm5pbmcpO1xubGV0IExpbnRpbmdFbmdpbmUgPSBjbGFzcyBMaW50aW5nRW5naW5lIHtcbiAgICBjb25zdHJ1Y3RvcihzZXJ2aWNlQ29udGFpbmVyKSB7XG4gICAgICAgIHRoaXMuc2VydmljZUNvbnRhaW5lciA9IHNlcnZpY2VDb250YWluZXI7XG4gICAgICAgIHRoaXMucGVuZGluZ0xpbnRpbmdzID0gbmV3IE1hcCgpO1xuICAgICAgICB0aGlzLmRvY3VtZW50SGFzSnVweXRlckNvZGVDZWxscyA9IChhLCBiKSA9PiBQcm9taXNlLnJlc29sdmUoZmFsc2UpO1xuICAgICAgICB0aGlzLmRvY3VtZW50cyA9IHNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSURvY3VtZW50TWFuYWdlcik7XG4gICAgICAgIHRoaXMud29ya3NwYWNlID0gc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JV29ya3NwYWNlU2VydmljZSk7XG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvblNlcnZpY2UgPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18zLklDb25maWd1cmF0aW9uU2VydmljZSk7XG4gICAgICAgIHRoaXMub3V0cHV0Q2hhbm5lbCA9IHNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzMuSU91dHB1dENoYW5uZWwsIGNvbnN0YW50c18xLlNUQU5EQVJEX09VVFBVVF9DSEFOTkVMKTtcbiAgICAgICAgdGhpcy5saW50ZXJNYW5hZ2VyID0gc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfNS5JTGludGVyTWFuYWdlcik7XG4gICAgICAgIHRoaXMuZmlsZVN5c3RlbSA9IHNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzIuSUZpbGVTeXN0ZW0pO1xuICAgICAgICB0aGlzLmRpYWdub3N0aWNDb2xsZWN0aW9uID0gdnNjb2RlLmxhbmd1YWdlcy5jcmVhdGVEaWFnbm9zdGljQ29sbGVjdGlvbigncHl0aG9uJyk7XG4gICAgfVxuICAgIGdldCBkaWFnbm9zdGljcygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGlhZ25vc3RpY0NvbGxlY3Rpb247XG4gICAgfVxuICAgIGNsZWFyRGlhZ25vc3RpY3MoZG9jdW1lbnQpIHtcbiAgICAgICAgaWYgKHRoaXMuZGlhZ25vc3RpY0NvbGxlY3Rpb24uaGFzKGRvY3VtZW50LnVyaSkpIHtcbiAgICAgICAgICAgIHRoaXMuZGlhZ25vc3RpY0NvbGxlY3Rpb24uZGVsZXRlKGRvY3VtZW50LnVyaSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgbGludE9wZW5QeXRob25GaWxlcygpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIHRoaXMuZGlhZ25vc3RpY0NvbGxlY3Rpb24uY2xlYXIoKTtcbiAgICAgICAgICAgIGNvbnN0IHByb21pc2VzID0gdGhpcy5kb2N1bWVudHMudGV4dERvY3VtZW50cy5tYXAoKGRvY3VtZW50KSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7IHJldHVybiB0aGlzLmxpbnREb2N1bWVudChkb2N1bWVudCwgJ2F1dG8nKTsgfSkpO1xuICAgICAgICAgICAgeWllbGQgUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGlhZ25vc3RpY0NvbGxlY3Rpb247XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBsaW50RG9jdW1lbnQoZG9jdW1lbnQsIHRyaWdnZXIpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIHRoaXMuZGlhZ25vc3RpY0NvbGxlY3Rpb24uc2V0KGRvY3VtZW50LnVyaSwgW10pO1xuICAgICAgICAgICAgLy8gQ2hlY2sgaWYgd2UgbmVlZCB0byBsaW50IHRoaXMgZG9jdW1lbnRcbiAgICAgICAgICAgIGlmICghKHlpZWxkIHRoaXMuc2hvdWxkTGludERvY3VtZW50KGRvY3VtZW50KSkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodGhpcy5wZW5kaW5nTGludGluZ3MuaGFzKGRvY3VtZW50LnVyaS5mc1BhdGgpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wZW5kaW5nTGludGluZ3MuZ2V0KGRvY3VtZW50LnVyaS5mc1BhdGgpLmNhbmNlbCgpO1xuICAgICAgICAgICAgICAgIHRoaXMucGVuZGluZ0xpbnRpbmdzLmRlbGV0ZShkb2N1bWVudC51cmkuZnNQYXRoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGNhbmNlbFRva2VuID0gbmV3IHZzY29kZS5DYW5jZWxsYXRpb25Ub2tlblNvdXJjZSgpO1xuICAgICAgICAgICAgY2FuY2VsVG9rZW4udG9rZW4ub25DYW5jZWxsYXRpb25SZXF1ZXN0ZWQoKCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnBlbmRpbmdMaW50aW5ncy5oYXMoZG9jdW1lbnQudXJpLmZzUGF0aCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wZW5kaW5nTGludGluZ3MuZGVsZXRlKGRvY3VtZW50LnVyaS5mc1BhdGgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGhpcy5wZW5kaW5nTGludGluZ3Muc2V0KGRvY3VtZW50LnVyaS5mc1BhdGgsIGNhbmNlbFRva2VuKTtcbiAgICAgICAgICAgIGNvbnN0IGFjdGl2ZUxpbnRlcnMgPSB5aWVsZCB0aGlzLmxpbnRlck1hbmFnZXIuZ2V0QWN0aXZlTGludGVycyhmYWxzZSwgZG9jdW1lbnQudXJpKTtcbiAgICAgICAgICAgIGNvbnN0IHByb21pc2VzID0gYWN0aXZlTGludGVyc1xuICAgICAgICAgICAgICAgIC5tYXAoKGluZm8pID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBzdG9wV2F0Y2ggPSBuZXcgc3RvcFdhdGNoXzEuU3RvcFdhdGNoKCk7XG4gICAgICAgICAgICAgICAgY29uc3QgbGludGVyID0geWllbGQgdGhpcy5saW50ZXJNYW5hZ2VyLmNyZWF0ZUxpbnRlcihpbmZvLnByb2R1Y3QsIHRoaXMub3V0cHV0Q2hhbm5lbCwgdGhpcy5zZXJ2aWNlQ29udGFpbmVyLCBkb2N1bWVudC51cmkpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHByb21pc2UgPSBsaW50ZXIubGludChkb2N1bWVudCwgY2FuY2VsVG9rZW4udG9rZW4pO1xuICAgICAgICAgICAgICAgIHRoaXMuc2VuZExpbnRlclJ1blRlbGVtZXRyeShpbmZvLCBkb2N1bWVudC51cmksIHByb21pc2UsIHN0b3BXYXRjaCwgdHJpZ2dlcik7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7XG4gICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICBjb25zdCBoYXNKdXB5dGVyQ29kZUNlbGxzID0geWllbGQgdGhpcy5kb2N1bWVudEhhc0p1cHl0ZXJDb2RlQ2VsbHMoZG9jdW1lbnQsIGNhbmNlbFRva2VuLnRva2VuKTtcbiAgICAgICAgICAgIC8vIGxpbnRlcnMgd2lsbCByZXNvbHZlIGFzeW5jaHJvbm91c2x5IC0ga2VlcCBhIHRyYWNrIG9mIGFsbFxuICAgICAgICAgICAgLy8gZGlhZ25vc3RpY3MgcmVwb3J0ZWQgYXMgdGhlbSBjb21lIGluLlxuICAgICAgICAgICAgbGV0IGRpYWdub3N0aWNzID0gW107XG4gICAgICAgICAgICBjb25zdCBzZXR0aW5ncyA9IHRoaXMuY29uZmlndXJhdGlvblNlcnZpY2UuZ2V0U2V0dGluZ3MoZG9jdW1lbnQudXJpKTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgcCBvZiBwcm9taXNlcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1zZ3MgPSB5aWVsZCBwO1xuICAgICAgICAgICAgICAgIGlmIChjYW5jZWxUb2tlbi50b2tlbi5pc0NhbmNlbGxhdGlvblJlcXVlc3RlZCkge1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNEb2N1bWVudE9wZW4oZG9jdW1lbnQudXJpKSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBCdWlsZCB0aGUgbWVzc2FnZSBhbmQgc3VmZml4IHRoZSBtZXNzYWdlIHdpdGggdGhlIG5hbWUgb2YgdGhlIGxpbnRlciB1c2VkLlxuICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IG0gb2YgbXNncykge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWdub3JlIG1hZ2ljIGNvbW1hbmRzIGZyb20ganVweXRlci5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoYXNKdXB5dGVyQ29kZUNlbGxzICYmIGRvY3VtZW50LmxpbmVBdChtLmxpbmUgLSAxKS50ZXh0LnRyaW0oKS5zdGFydHNXaXRoKCclJykgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAobS5jb2RlID09PSBjb25zdGFudHNfMS5MaW50ZXJFcnJvcnMucHlsaW50LkludmFsaWRTeW50YXggfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5jb2RlID09PSBjb25zdGFudHNfMS5MaW50ZXJFcnJvcnMucHJvc3BlY3Rvci5JbnZhbGlkU3ludGF4IHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0uY29kZSA9PT0gY29uc3RhbnRzXzEuTGludGVyRXJyb3JzLmZsYWtlOC5JbnZhbGlkU3ludGF4KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZGlhZ25vc3RpY3MucHVzaCh0aGlzLmNyZWF0ZURpYWdub3N0aWNzKG0sIGRvY3VtZW50KSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgLy8gTGltaXQgdGhlIG51bWJlciBvZiBtZXNzYWdlcyB0byB0aGUgbWF4IHZhbHVlLlxuICAgICAgICAgICAgICAgICAgICBkaWFnbm9zdGljcyA9IGRpYWdub3N0aWNzLmZpbHRlcigodmFsdWUsIGluZGV4KSA9PiBpbmRleCA8PSBzZXR0aW5ncy5saW50aW5nLm1heE51bWJlck9mUHJvYmxlbXMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIFNldCBhbGwgZGlhZ25vc3RpY3MgZm91bmQgaW4gdGhpcyBwYXNzLCBhcyB0aGlzIG1ldGhvZCBhbHdheXMgY2xlYXJzIGV4aXN0aW5nIGRpYWdub3N0aWNzLlxuICAgICAgICAgICAgdGhpcy5kaWFnbm9zdGljQ29sbGVjdGlvbi5zZXQoZG9jdW1lbnQudXJpLCBkaWFnbm9zdGljcyk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55XG4gICAgbGlua0p1cHl0ZXJFeHRlbnNpb24oanVweXRlcikge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgaWYgKCFqdXB5dGVyKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFqdXB5dGVyLmlzQWN0aXZlKSB7XG4gICAgICAgICAgICAgICAgeWllbGQganVweXRlci5hY3RpdmF0ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXVuc2FmZS1hbnlcbiAgICAgICAgICAgIGp1cHl0ZXIuZXhwb3J0cy5yZWdpc3Rlckxhbmd1YWdlUHJvdmlkZXIoUFlUSE9OLmxhbmd1YWdlLCBuZXcgcHJvdmlkZXJfMS5KdXB5dGVyUHJvdmlkZXIoKSk7XG4gICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tdW5zYWZlLWFueVxuICAgICAgICAgICAgdGhpcy5kb2N1bWVudEhhc0p1cHl0ZXJDb2RlQ2VsbHMgPSBqdXB5dGVyLmV4cG9ydHMuaGFzQ29kZUNlbGxzO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgc2VuZExpbnRlclJ1blRlbGVtZXRyeShpbmZvLCByZXNvdXJjZSwgcHJvbWlzZSwgc3RvcFdhdGNoLCB0cmlnZ2VyKSB7XG4gICAgICAgIGNvbnN0IGxpbnRlckV4ZWN1dGFibGVQYXRoTmFtZSA9IGluZm8ucGF0aE5hbWUocmVzb3VyY2UpO1xuICAgICAgICBjb25zdCBwcm9wZXJ0aWVzID0ge1xuICAgICAgICAgICAgdG9vbDogaW5mby5pZCxcbiAgICAgICAgICAgIGhhc0N1c3RvbUFyZ3M6IGluZm8ubGludGVyQXJncyhyZXNvdXJjZSkubGVuZ3RoID4gMCxcbiAgICAgICAgICAgIHRyaWdnZXIsXG4gICAgICAgICAgICBleGVjdXRhYmxlU3BlY2lmaWVkOiBsaW50ZXJFeGVjdXRhYmxlUGF0aE5hbWUubGVuZ3RoID4gMFxuICAgICAgICB9O1xuICAgICAgICB0ZWxlbWV0cnlfMS5zZW5kVGVsZW1ldHJ5V2hlbkRvbmUoY29uc3RhbnRzXzIuTElOVElORywgcHJvbWlzZSwgc3RvcFdhdGNoLCBwcm9wZXJ0aWVzKTtcbiAgICB9XG4gICAgaXNEb2N1bWVudE9wZW4odXJpKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmRvY3VtZW50cy50ZXh0RG9jdW1lbnRzLnNvbWUoZG9jdW1lbnQgPT4gZG9jdW1lbnQudXJpLmZzUGF0aCA9PT0gdXJpLmZzUGF0aCk7XG4gICAgfVxuICAgIGNyZWF0ZURpYWdub3N0aWNzKG1lc3NhZ2UsIGRvY3VtZW50KSB7XG4gICAgICAgIGNvbnN0IHBvc2l0aW9uID0gbmV3IHZzY29kZS5Qb3NpdGlvbihtZXNzYWdlLmxpbmUgLSAxLCBtZXNzYWdlLmNvbHVtbik7XG4gICAgICAgIGNvbnN0IHJhbmdlID0gbmV3IHZzY29kZS5SYW5nZShwb3NpdGlvbiwgcG9zaXRpb24pO1xuICAgICAgICBjb25zdCBzZXZlcml0eSA9IGxpbnRTZXZlcml0eVRvVlNTZXZlcml0eS5nZXQobWVzc2FnZS5zZXZlcml0eSk7XG4gICAgICAgIGNvbnN0IGRpYWdub3N0aWMgPSBuZXcgdnNjb2RlLkRpYWdub3N0aWMocmFuZ2UsIG1lc3NhZ2UubWVzc2FnZSwgc2V2ZXJpdHkpO1xuICAgICAgICBkaWFnbm9zdGljLmNvZGUgPSBtZXNzYWdlLmNvZGU7XG4gICAgICAgIGRpYWdub3N0aWMuc291cmNlID0gbWVzc2FnZS5wcm92aWRlcjtcbiAgICAgICAgcmV0dXJuIGRpYWdub3N0aWM7XG4gICAgfVxuICAgIHNob3VsZExpbnREb2N1bWVudChkb2N1bWVudCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgaWYgKCEoeWllbGQgdGhpcy5saW50ZXJNYW5hZ2VyLmlzTGludGluZ0VuYWJsZWQoZmFsc2UsIGRvY3VtZW50LnVyaSkpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kaWFnbm9zdGljQ29sbGVjdGlvbi5zZXQoZG9jdW1lbnQudXJpLCBbXSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGRvY3VtZW50Lmxhbmd1YWdlSWQgIT09IFBZVEhPTi5sYW5ndWFnZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHdvcmtzcGFjZUZvbGRlciA9IHRoaXMud29ya3NwYWNlLmdldFdvcmtzcGFjZUZvbGRlcihkb2N1bWVudC51cmkpO1xuICAgICAgICAgICAgY29uc3Qgd29ya3NwYWNlUm9vdFBhdGggPSAod29ya3NwYWNlRm9sZGVyICYmIHR5cGVvZiB3b3Jrc3BhY2VGb2xkZXIudXJpLmZzUGF0aCA9PT0gJ3N0cmluZycpID8gd29ya3NwYWNlRm9sZGVyLnVyaS5mc1BhdGggOiB1bmRlZmluZWQ7XG4gICAgICAgICAgICBjb25zdCByZWxhdGl2ZUZpbGVOYW1lID0gdHlwZW9mIHdvcmtzcGFjZVJvb3RQYXRoID09PSAnc3RyaW5nJyA/IHBhdGgucmVsYXRpdmUod29ya3NwYWNlUm9vdFBhdGgsIGRvY3VtZW50LmZpbGVOYW1lKSA6IGRvY3VtZW50LmZpbGVOYW1lO1xuICAgICAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSB0aGlzLmNvbmZpZ3VyYXRpb25TZXJ2aWNlLmdldFNldHRpbmdzKGRvY3VtZW50LnVyaSk7XG4gICAgICAgICAgICBjb25zdCBpZ25vcmVNaW5tYXRjaGVzID0gc2V0dGluZ3MubGludGluZy5pZ25vcmVQYXR0ZXJucy5tYXAocGF0dGVybiA9PiBuZXcgbWluaW1hdGNoXzEuTWluaW1hdGNoKHBhdHRlcm4pKTtcbiAgICAgICAgICAgIGlmIChpZ25vcmVNaW5tYXRjaGVzLnNvbWUobWF0Y2hlciA9PiBtYXRjaGVyLm1hdGNoKGRvY3VtZW50LmZpbGVOYW1lKSB8fCBtYXRjaGVyLm1hdGNoKHJlbGF0aXZlRmlsZU5hbWUpKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChkb2N1bWVudC51cmkuc2NoZW1lICE9PSAnZmlsZScgfHwgIWRvY3VtZW50LnVyaS5mc1BhdGgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5maWxlU3lzdGVtLmZpbGVFeGlzdHMoZG9jdW1lbnQudXJpLmZzUGF0aCk7XG4gICAgICAgIH0pO1xuICAgIH1cbn07XG5MaW50aW5nRW5naW5lID0gX19kZWNvcmF0ZShbXG4gICAgaW52ZXJzaWZ5XzEuaW5qZWN0YWJsZSgpLFxuICAgIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzQuSVNlcnZpY2VDb250YWluZXIpKVxuXSwgTGludGluZ0VuZ2luZSk7XG5leHBvcnRzLkxpbnRpbmdFbmdpbmUgPSBMaW50aW5nRW5naW5lO1xuLy8jIHNvdXJjZU1hcHBpbmdVUkw9bGludGluZ0VuZ2luZS5qcy5tYXAiXX0=