// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const types_1 = require("../common/application/types");

const logger_1 = require("../common/logger");

const types_2 = require("../common/types");

let AvailableLinterActivator = class AvailableLinterActivator {
  constructor(appShell, installer, workspaceConfig, configService) {
    this.appShell = appShell;
    this.installer = installer;
    this.workspaceConfig = workspaceConfig;
    this.configService = configService;
  }
  /**
   * Check if it is possible to enable an otherwise-unconfigured linter in
   * the current workspace, and if so ask the user if they want that linter
   * configured explicitly.
   *
   * @param linterInfo The linter to check installation status.
   * @param resource Context for the operation (required when in multi-root workspaces).
   *
   * @returns true if configuration was updated in any way, false otherwise.
   */


  promptIfLinterAvailable(linterInfo, resource) {
    return __awaiter(this, void 0, void 0, function* () {
      // Has the feature been enabled yet?
      if (!this.isFeatureEnabled) {
        return false;
      } // Has the linter in question has been configured explicitly? If so, no need to continue.


      if (!this.isLinterUsingDefaultConfiguration(linterInfo, resource)) {
        return false;
      } // Is the linter available in the current workspace?


      if (yield this.isLinterAvailable(linterInfo.product, resource)) {
        // great, it is - ask the user if they'd like to enable it.
        return this.promptToConfigureAvailableLinter(linterInfo);
      }

      return false;
    });
  }
  /**
   * Raise a dialog asking the user if they would like to explicitly configure a
   * linter or not in their current workspace.
   *
   * @param linterInfo The linter to ask the user to enable or not.
   *
   * @returns true if the user requested a configuration change, false otherwise.
   */


  promptToConfigureAvailableLinter(linterInfo) {
    return __awaiter(this, void 0, void 0, function* () {
      const optButtons = [{
        title: `Enable ${linterInfo.id}`,
        enabled: true
      }, {
        title: `Disable ${linterInfo.id}`,
        enabled: false
      }]; // tslint:disable-next-line:messages-must-be-localized

      const pick = yield this.appShell.showInformationMessage(`Linter ${linterInfo.id} is available but not enabled.`, ...optButtons);

      if (pick) {
        yield linterInfo.enableAsync(pick.enabled);
        return true;
      }

      return false;
    });
  }
  /**
   * Check if the linter itself is available in the workspace's Python environment or
   * not.
   *
   * @param linterProduct Linter to check in the current workspace environment.
   * @param resource Context information for workspace.
   */


  isLinterAvailable(linterProduct, resource) {
    return __awaiter(this, void 0, void 0, function* () {
      return this.installer.isInstalled(linterProduct, resource).catch(reason => {
        // report and continue, assume the linter is unavailable.
        logger_1.traceError(`[WARNING]: Failed to discover if linter ${linterProduct} is installed.`, reason);
        return false;
      });
    });
  }
  /**
   * Check if the given linter has been configured by the user in this workspace or not.
   *
   * @param linterInfo Linter to check for configuration status.
   * @param resource Context information.
   *
   * @returns true if the linter has not been configured at the user, workspace, or workspace-folder scope. false otherwise.
   */


  isLinterUsingDefaultConfiguration(linterInfo, resource) {
    const ws = this.workspaceConfig.getConfiguration('python.linting', resource);
    const pe = ws.inspect(linterInfo.enabledSettingName);
    return pe.globalValue === undefined && pe.workspaceValue === undefined && pe.workspaceFolderValue === undefined;
  }
  /**
   * Check if this feature is enabled yet.
   *
   * This is a feature of the vscode-python extension that will become enabled once the
   * Python Language Server becomes the default, replacing Jedi as the default. Testing
   * the global default setting for `"python.jediEnabled": false` enables it.
   *
   * @returns true if the global default for python.jediEnabled is false.
   */


  get isFeatureEnabled() {
    return !this.configService.getSettings().jediEnabled;
  }

};
AvailableLinterActivator = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_1.IApplicationShell)), __param(1, inversify_1.inject(types_2.IInstaller)), __param(2, inversify_1.inject(types_1.IWorkspaceService)), __param(3, inversify_1.inject(types_2.IConfigurationService))], AvailableLinterActivator);
exports.AvailableLinterActivator = AvailableLinterActivator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpbnRlckF2YWlsYWJpbGl0eS5qcyJdLCJuYW1lcyI6WyJfX2RlY29yYXRlIiwiZGVjb3JhdG9ycyIsInRhcmdldCIsImtleSIsImRlc2MiLCJjIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImQiLCJSZWZsZWN0IiwiZGVjb3JhdGUiLCJpIiwiZGVmaW5lUHJvcGVydHkiLCJfX3BhcmFtIiwicGFyYW1JbmRleCIsImRlY29yYXRvciIsIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJleHBvcnRzIiwiaW52ZXJzaWZ5XzEiLCJyZXF1aXJlIiwidHlwZXNfMSIsImxvZ2dlcl8xIiwidHlwZXNfMiIsIkF2YWlsYWJsZUxpbnRlckFjdGl2YXRvciIsImNvbnN0cnVjdG9yIiwiYXBwU2hlbGwiLCJpbnN0YWxsZXIiLCJ3b3Jrc3BhY2VDb25maWciLCJjb25maWdTZXJ2aWNlIiwicHJvbXB0SWZMaW50ZXJBdmFpbGFibGUiLCJsaW50ZXJJbmZvIiwicmVzb3VyY2UiLCJpc0ZlYXR1cmVFbmFibGVkIiwiaXNMaW50ZXJVc2luZ0RlZmF1bHRDb25maWd1cmF0aW9uIiwiaXNMaW50ZXJBdmFpbGFibGUiLCJwcm9kdWN0IiwicHJvbXB0VG9Db25maWd1cmVBdmFpbGFibGVMaW50ZXIiLCJvcHRCdXR0b25zIiwidGl0bGUiLCJpZCIsImVuYWJsZWQiLCJwaWNrIiwic2hvd0luZm9ybWF0aW9uTWVzc2FnZSIsImVuYWJsZUFzeW5jIiwibGludGVyUHJvZHVjdCIsImlzSW5zdGFsbGVkIiwiY2F0Y2giLCJyZWFzb24iLCJ0cmFjZUVycm9yIiwid3MiLCJnZXRDb25maWd1cmF0aW9uIiwicGUiLCJpbnNwZWN0IiwiZW5hYmxlZFNldHRpbmdOYW1lIiwiZ2xvYmFsVmFsdWUiLCJ1bmRlZmluZWQiLCJ3b3Jrc3BhY2VWYWx1ZSIsIndvcmtzcGFjZUZvbGRlclZhbHVlIiwiZ2V0U2V0dGluZ3MiLCJqZWRpRW5hYmxlZCIsImluamVjdGFibGUiLCJpbmplY3QiLCJJQXBwbGljYXRpb25TaGVsbCIsIklJbnN0YWxsZXIiLCJJV29ya3NwYWNlU2VydmljZSIsIklDb25maWd1cmF0aW9uU2VydmljZSJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBOztBQUNBLElBQUlBLFVBQVUsR0FBSSxVQUFRLFNBQUtBLFVBQWQsSUFBNkIsVUFBVUMsVUFBVixFQUFzQkMsTUFBdEIsRUFBOEJDLEdBQTlCLEVBQW1DQyxJQUFuQyxFQUF5QztBQUNuRixNQUFJQyxDQUFDLEdBQUdDLFNBQVMsQ0FBQ0MsTUFBbEI7QUFBQSxNQUEwQkMsQ0FBQyxHQUFHSCxDQUFDLEdBQUcsQ0FBSixHQUFRSCxNQUFSLEdBQWlCRSxJQUFJLEtBQUssSUFBVCxHQUFnQkEsSUFBSSxHQUFHSyxNQUFNLENBQUNDLHdCQUFQLENBQWdDUixNQUFoQyxFQUF3Q0MsR0FBeEMsQ0FBdkIsR0FBc0VDLElBQXJIO0FBQUEsTUFBMkhPLENBQTNIO0FBQ0EsTUFBSSxPQUFPQyxPQUFQLEtBQW1CLFFBQW5CLElBQStCLE9BQU9BLE9BQU8sQ0FBQ0MsUUFBZixLQUE0QixVQUEvRCxFQUEyRUwsQ0FBQyxHQUFHSSxPQUFPLENBQUNDLFFBQVIsQ0FBaUJaLFVBQWpCLEVBQTZCQyxNQUE3QixFQUFxQ0MsR0FBckMsRUFBMENDLElBQTFDLENBQUosQ0FBM0UsS0FDSyxLQUFLLElBQUlVLENBQUMsR0FBR2IsVUFBVSxDQUFDTSxNQUFYLEdBQW9CLENBQWpDLEVBQW9DTyxDQUFDLElBQUksQ0FBekMsRUFBNENBLENBQUMsRUFBN0MsRUFBaUQsSUFBSUgsQ0FBQyxHQUFHVixVQUFVLENBQUNhLENBQUQsQ0FBbEIsRUFBdUJOLENBQUMs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LFFBQXhELENBQVg7QUFDQSxVQUFNb0IsRUFBRSxHQUFHRixFQUFFLENBQUNHLE9BQUgsQ0FBV3RCLFVBQVUsQ0FBQ3VCLGtCQUF0QixDQUFYO0FBQ0EsV0FBUUYsRUFBRSxDQUFDRyxXQUFILEtBQW1CQyxTQUFuQixJQUFnQ0osRUFBRSxDQUFDSyxjQUFILEtBQXNCRCxTQUF0RCxJQUFtRUosRUFBRSxDQUFDTSxvQkFBSCxLQUE0QkYsU0FBdkc7QUFDSDtBQUNEO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FBQ3dCLE1BQWhCdkIsZ0JBQWdCLEdBQUc7QUFDbkIsV0FBTyxDQUFDLEtBQUtKLGFBQUwsQ0FBbUI4QixXQUFuQixHQUFpQ0MsV0FBekM7QUFDSDs7QUF6R3lELENBQTlEO0FBMkdBcEMsd0JBQXdCLEdBQUczQyxVQUFVLENBQUMsQ0FDbENzQyxXQUFXLENBQUMwQyxVQUFaLEVBRGtDLEVBRWxDaEUsT0FBTyxDQUFDLENBQUQsRUFBSXNCLFdBQVcsQ0FBQzJDLE1BQVosQ0FBbUJ6QyxPQUFPLENBQUMwQyxpQkFBM0IsQ0FBSixDQUYyQixFQUdsQ2xFLE9BQU8sQ0FBQyxDQUFELEVBQUlzQixXQUFXLENBQUMyQyxNQUFaLENBQW1CdkMsT0FBTyxDQUFDeUMsVUFBM0IsQ0FBSixDQUgyQixFQUlsQ25FLE9BQU8sQ0FBQyxDQUFELEVBQUlzQixXQUFXLENBQUMyQyxNQUFaLENBQW1CekMsT0FBTyxDQUFDNEMsaUJBQTNCLENBQUosQ0FKMkIsRUFLbENwRSxPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDMkMsTUFBWixDQUFtQnZDLE9BQU8sQ0FBQzJDLHFCQUEzQixDQUFKLENBTDJCLENBQUQsRUFNbEMxQyx3QkFOa0MsQ0FBckM7QUFPQU4sT0FBTyxDQUFDTSx3QkFBUixHQUFtQ0Esd0JBQW5DIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXG4ndXNlIHN0cmljdCc7XG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XG4gICAgdmFyIGMgPSBhcmd1bWVudHMubGVuZ3RoLCByID0gYyA8IDMgPyB0YXJnZXQgOiBkZXNjID09PSBudWxsID8gZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpIDogZGVzYywgZDtcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XG4gICAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjtcbn07XG52YXIgX19wYXJhbSA9ICh0aGlzICYmIHRoaXMuX19wYXJhbSkgfHwgZnVuY3Rpb24gKHBhcmFtSW5kZXgsIGRlY29yYXRvcikge1xuICAgIHJldHVybiBmdW5jdGlvbiAodGFyZ2V0LCBrZXkpIHsgZGVjb3JhdG9yKHRhcmdldCwga2V5LCBwYXJhbUluZGV4KTsgfVxufTtcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XG4gICAgfSk7XG59O1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuY29uc3QgaW52ZXJzaWZ5XzEgPSByZXF1aXJlKFwiaW52ZXJzaWZ5XCIpO1xuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vYXBwbGljYXRpb24vdHlwZXNcIik7XG5jb25zdCBsb2dnZXJfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vbG9nZ2VyXCIpO1xuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi9jb21tb24vdHlwZXNcIik7XG5sZXQgQXZhaWxhYmxlTGludGVyQWN0aXZhdG9yID0gY2xhc3MgQXZhaWxhYmxlTGludGVyQWN0aXZhdG9yIHtcbiAgICBjb25zdHJ1Y3RvcihhcHBTaGVsbCwgaW5zdGFsbGVyLCB3b3Jrc3BhY2VDb25maWcsIGNvbmZpZ1NlcnZpY2UpIHtcbiAgICAgICAgdGhpcy5hcHBTaGVsbCA9IGFwcFNoZWxsO1xuICAgICAgICB0aGlzLmluc3RhbGxlciA9IGluc3RhbGxlcjtcbiAgICAgICAgdGhpcy53b3Jrc3BhY2VDb25maWcgPSB3b3Jrc3BhY2VDb25maWc7XG4gICAgICAgIHRoaXMuY29uZmlnU2VydmljZSA9IGNvbmZpZ1NlcnZpY2U7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIENoZWNrIGlmIGl0IGlzIHBvc3NpYmxlIHRvIGVuYWJsZSBhbiBvdGhlcndpc2UtdW5jb25maWd1cmVkIGxpbnRlciBpblxuICAgICAqIHRoZSBjdXJyZW50IHdvcmtzcGFjZSwgYW5kIGlmIHNvIGFzayB0aGUgdXNlciBpZiB0aGV5IHdhbnQgdGhhdCBsaW50ZXJcbiAgICAgKiBjb25maWd1cmVkIGV4cGxpY2l0bHkuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gbGludGVySW5mbyBUaGUgbGludGVyIHRvIGNoZWNrIGluc3RhbGxhdGlvbiBzdGF0dXMuXG4gICAgICogQHBhcmFtIHJlc291cmNlIENvbnRleHQgZm9yIHRoZSBvcGVyYXRpb24gKHJlcXVpcmVkIHdoZW4gaW4gbXVsdGktcm9vdCB3b3Jrc3BhY2VzKS5cbiAgICAgKlxuICAgICAqIEByZXR1cm5zIHRydWUgaWYgY29uZmlndXJhdGlvbiB3YXMgdXBkYXRlZCBpbiBhbnkgd2F5LCBmYWxzZSBvdGhlcndpc2UuXG4gICAgICovXG4gICAgcHJvbXB0SWZMaW50ZXJBdmFpbGFibGUobGludGVySW5mbywgcmVzb3VyY2UpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIC8vIEhhcyB0aGUgZmVhdHVyZSBiZWVuIGVuYWJsZWQgeWV0P1xuICAgICAgICAgICAgaWYgKCF0aGlzLmlzRmVhdHVyZUVuYWJsZWQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBIYXMgdGhlIGxpbnRlciBpbiBxdWVzdGlvbiBoYXMgYmVlbiBjb25maWd1cmVkIGV4cGxpY2l0bHk/IElmIHNvLCBubyBuZWVkIHRvIGNvbnRpbnVlLlxuICAgICAgICAgICAgaWYgKCF0aGlzLmlzTGludGVyVXNpbmdEZWZhdWx0Q29uZmlndXJhdGlvbihsaW50ZXJJbmZvLCByZXNvdXJjZSkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBJcyB0aGUgbGludGVyIGF2YWlsYWJsZSBpbiB0aGUgY3VycmVudCB3b3Jrc3BhY2U/XG4gICAgICAgICAgICBpZiAoeWllbGQgdGhpcy5pc0xpbnRlckF2YWlsYWJsZShsaW50ZXJJbmZvLnByb2R1Y3QsIHJlc291cmNlKSkge1xuICAgICAgICAgICAgICAgIC8vIGdyZWF0LCBpdCBpcyAtIGFzayB0aGUgdXNlciBpZiB0aGV5J2QgbGlrZSB0byBlbmFibGUgaXQuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucHJvbXB0VG9Db25maWd1cmVBdmFpbGFibGVMaW50ZXIobGludGVySW5mbyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBSYWlzZSBhIGRpYWxvZyBhc2tpbmcgdGhlIHVzZXIgaWYgdGhleSB3b3VsZCBsaWtlIHRvIGV4cGxpY2l0bHkgY29uZmlndXJlIGFcbiAgICAgKiBsaW50ZXIgb3Igbm90IGluIHRoZWlyIGN1cnJlbnQgd29ya3NwYWNlLlxuICAgICAqXG4gICAgICogQHBhcmFtIGxpbnRlckluZm8gVGhlIGxpbnRlciB0byBhc2sgdGhlIHVzZXIgdG8gZW5hYmxlIG9yIG5vdC5cbiAgICAgKlxuICAgICAqIEByZXR1cm5zIHRydWUgaWYgdGhlIHVzZXIgcmVxdWVzdGVkIGEgY29uZmlndXJhdGlvbiBjaGFuZ2UsIGZhbHNlIG90aGVyd2lzZS5cbiAgICAgKi9cbiAgICBwcm9tcHRUb0NvbmZpZ3VyZUF2YWlsYWJsZUxpbnRlcihsaW50ZXJJbmZvKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBvcHRCdXR0b25zID0gW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IGBFbmFibGUgJHtsaW50ZXJJbmZvLmlkfWAsXG4gICAgICAgICAgICAgICAgICAgIGVuYWJsZWQ6IHRydWVcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IGBEaXNhYmxlICR7bGludGVySW5mby5pZH1gLFxuICAgICAgICAgICAgICAgICAgICBlbmFibGVkOiBmYWxzZVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF07XG4gICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWVzc2FnZXMtbXVzdC1iZS1sb2NhbGl6ZWRcbiAgICAgICAgICAgIGNvbnN0IHBpY2sgPSB5aWVsZCB0aGlzLmFwcFNoZWxsLnNob3dJbmZvcm1hdGlvbk1lc3NhZ2UoYExpbnRlciAke2xpbnRlckluZm8uaWR9IGlzIGF2YWlsYWJsZSBidXQgbm90IGVuYWJsZWQuYCwgLi4ub3B0QnV0dG9ucyk7XG4gICAgICAgICAgICBpZiAocGljaykge1xuICAgICAgICAgICAgICAgIHlpZWxkIGxpbnRlckluZm8uZW5hYmxlQXN5bmMocGljay5lbmFibGVkKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIENoZWNrIGlmIHRoZSBsaW50ZXIgaXRzZWxmIGlzIGF2YWlsYWJsZSBpbiB0aGUgd29ya3NwYWNlJ3MgUHl0aG9uIGVudmlyb25tZW50IG9yXG4gICAgICogbm90LlxuICAgICAqXG4gICAgICogQHBhcmFtIGxpbnRlclByb2R1Y3QgTGludGVyIHRvIGNoZWNrIGluIHRoZSBjdXJyZW50IHdvcmtzcGFjZSBlbnZpcm9ubWVudC5cbiAgICAgKiBAcGFyYW0gcmVzb3VyY2UgQ29udGV4dCBpbmZvcm1hdGlvbiBmb3Igd29ya3NwYWNlLlxuICAgICAqL1xuICAgIGlzTGludGVyQXZhaWxhYmxlKGxpbnRlclByb2R1Y3QsIHJlc291cmNlKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5pbnN0YWxsZXIuaXNJbnN0YWxsZWQobGludGVyUHJvZHVjdCwgcmVzb3VyY2UpXG4gICAgICAgICAgICAgICAgLmNhdGNoKChyZWFzb24pID0+IHtcbiAgICAgICAgICAgICAgICAvLyByZXBvcnQgYW5kIGNvbnRpbnVlLCBhc3N1bWUgdGhlIGxpbnRlciBpcyB1bmF2YWlsYWJsZS5cbiAgICAgICAgICAgICAgICBsb2dnZXJfMS50cmFjZUVycm9yKGBbV0FSTklOR106IEZhaWxlZCB0byBkaXNjb3ZlciBpZiBsaW50ZXIgJHtsaW50ZXJQcm9kdWN0fSBpcyBpbnN0YWxsZWQuYCwgcmVhc29uKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIENoZWNrIGlmIHRoZSBnaXZlbiBsaW50ZXIgaGFzIGJlZW4gY29uZmlndXJlZCBieSB0aGUgdXNlciBpbiB0aGlzIHdvcmtzcGFjZSBvciBub3QuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gbGludGVySW5mbyBMaW50ZXIgdG8gY2hlY2sgZm9yIGNvbmZpZ3VyYXRpb24gc3RhdHVzLlxuICAgICAqIEBwYXJhbSByZXNvdXJjZSBDb250ZXh0IGluZm9ybWF0aW9uLlxuICAgICAqXG4gICAgICogQHJldHVybnMgdHJ1ZSBpZiB0aGUgbGludGVyIGhhcyBub3QgYmVlbiBjb25maWd1cmVkIGF0IHRoZSB1c2VyLCB3b3Jrc3BhY2UsIG9yIHdvcmtzcGFjZS1mb2xkZXIgc2NvcGUuIGZhbHNlIG90aGVyd2lzZS5cbiAgICAgKi9cbiAgICBpc0xpbnRlclVzaW5nRGVmYXVsdENvbmZpZ3VyYXRpb24obGludGVySW5mbywgcmVzb3VyY2UpIHtcbiAgICAgICAgY29uc3Qgd3MgPSB0aGlzLndvcmtzcGFjZUNvbmZpZy5nZXRDb25maWd1cmF0aW9uKCdweXRob24ubGludGluZycsIHJlc291cmNlKTtcbiAgICAgICAgY29uc3QgcGUgPSB3cy5pbnNwZWN0KGxpbnRlckluZm8uZW5hYmxlZFNldHRpbmdOYW1lKTtcbiAgICAgICAgcmV0dXJuIChwZS5nbG9iYWxWYWx1ZSA9PT0gdW5kZWZpbmVkICYmIHBlLndvcmtzcGFjZVZhbHVlID09PSB1bmRlZmluZWQgJiYgcGUud29ya3NwYWNlRm9sZGVyVmFsdWUgPT09IHVuZGVmaW5lZCk7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIENoZWNrIGlmIHRoaXMgZmVhdHVyZSBpcyBlbmFibGVkIHlldC5cbiAgICAgKlxuICAgICAqIFRoaXMgaXMgYSBmZWF0dXJlIG9mIHRoZSB2c2NvZGUtcHl0aG9uIGV4dGVuc2lvbiB0aGF0IHdpbGwgYmVjb21lIGVuYWJsZWQgb25jZSB0aGVcbiAgICAgKiBQeXRob24gTGFuZ3VhZ2UgU2VydmVyIGJlY29tZXMgdGhlIGRlZmF1bHQsIHJlcGxhY2luZyBKZWRpIGFzIHRoZSBkZWZhdWx0LiBUZXN0aW5nXG4gICAgICogdGhlIGdsb2JhbCBkZWZhdWx0IHNldHRpbmcgZm9yIGBcInB5dGhvbi5qZWRpRW5hYmxlZFwiOiBmYWxzZWAgZW5hYmxlcyBpdC5cbiAgICAgKlxuICAgICAqIEByZXR1cm5zIHRydWUgaWYgdGhlIGdsb2JhbCBkZWZhdWx0IGZvciBweXRob24uamVkaUVuYWJsZWQgaXMgZmFsc2UuXG4gICAgICovXG4gICAgZ2V0IGlzRmVhdHVyZUVuYWJsZWQoKSB7XG4gICAgICAgIHJldHVybiAhdGhpcy5jb25maWdTZXJ2aWNlLmdldFNldHRpbmdzKCkuamVkaUVuYWJsZWQ7XG4gICAgfVxufTtcbkF2YWlsYWJsZUxpbnRlckFjdGl2YXRvciA9IF9fZGVjb3JhdGUoW1xuICAgIGludmVyc2lmeV8xLmluamVjdGFibGUoKSxcbiAgICBfX3BhcmFtKDAsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18xLklBcHBsaWNhdGlvblNoZWxsKSksXG4gICAgX19wYXJhbSgxLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMi5JSW5zdGFsbGVyKSksXG4gICAgX19wYXJhbSgyLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMS5JV29ya3NwYWNlU2VydmljZSkpLFxuICAgIF9fcGFyYW0oMywgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzIuSUNvbmZpZ3VyYXRpb25TZXJ2aWNlKSlcbl0sIEF2YWlsYWJsZUxpbnRlckFjdGl2YXRvcik7XG5leHBvcnRzLkF2YWlsYWJsZUxpbnRlckFjdGl2YXRvciA9IEF2YWlsYWJsZUxpbnRlckFjdGl2YXRvcjtcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWxpbnRlckF2YWlsYWJpbGl0eS5qcy5tYXAiXX0=