"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const path = require("path");

const types_1 = require("../common/types");

class LinterInfo {
  constructor(product, id, configService, configFileNames = []) {
    this.configService = configService;
    this._product = product;
    this._id = id;
    this._configFileNames = configFileNames;
  }

  get id() {
    return this._id;
  }

  get product() {
    return this._product;
  }

  get pathSettingName() {
    return `${this.id}Path`;
  }

  get argsSettingName() {
    return `${this.id}Args`;
  }

  get enabledSettingName() {
    return `${this.id}Enabled`;
  }

  get configFileNames() {
    return this._configFileNames;
  }

  enableAsync(enabled, resource) {
    return __awaiter(this, void 0, void 0, function* () {
      return this.configService.updateSetting(`linting.${this.enabledSettingName}`, enabled, resource);
    });
  }

  isEnabled(resource) {
    const settings = this.configService.getSettings(resource);
    return settings.linting[this.enabledSettingName];
  }

  pathName(resource) {
    const settings = this.configService.getSettings(resource);
    return settings.linting[this.pathSettingName];
  }

  linterArgs(resource) {
    const settings = this.configService.getSettings(resource);
    const args = settings.linting[this.argsSettingName];
    return Array.isArray(args) ? args : [];
  }

  getExecutionInfo(customArgs, resource) {
    const execPath = this.pathName(resource);
    const args = this.linterArgs(resource).concat(customArgs);
    let moduleName; // If path information is not available, then treat it as a module,

    if (path.basename(execPath) === execPath) {
      moduleName = execPath;
    }

    return {
      execPath,
      moduleName,
      args,
      product: this.product
    };
  }

}

exports.LinterInfo = LinterInfo;

class PylintLinterInfo extends LinterInfo {
  constructor(configService, workspaceService, configFileNames = []) {
    super(types_1.Product.pylint, 'pylint', configService, configFileNames);
    this.workspaceService = workspaceService;
  }

  isEnabled(resource) {
    const enabled = super.isEnabled(resource);

    if (!enabled || this.configService.getSettings(resource).jediEnabled) {
      return enabled;
    } // If we're using new LS, then by default Pylint is disabled (unless the user provides a value).


    const inspection = this.workspaceService.getConfiguration('python.linting', resource).inspect('pylintEnabled');

    if (!inspection || inspection.globalValue === undefined && inspection.workspaceFolderValue === undefined || inspection.workspaceValue === undefined) {
      return false;
    }

    return enabled;
  }

}

exports.PylintLinterInfo = PylintLinterInfo;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpbnRlckluZm8uanMiXSwibmFtZXMiOlsiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInBhdGgiLCJyZXF1aXJlIiwidHlwZXNfMSIsIkxpbnRlckluZm8iLCJjb25zdHJ1Y3RvciIsInByb2R1Y3QiLCJpZCIsImNvbmZpZ1NlcnZpY2UiLCJjb25maWdGaWxlTmFtZXMiLCJfcHJvZHVjdCIsIl9pZCIsIl9jb25maWdGaWxlTmFtZXMiLCJwYXRoU2V0dGluZ05hbWUiLCJhcmdzU2V0dGluZ05hbWUiLCJlbmFibGVkU2V0dGluZ05hbWUiLCJlbmFibGVBc3luYyIsImVuYWJsZWQiLCJyZXNvdXJjZSIsInVwZGF0ZVNldHRpbmciLCJpc0VuYWJsZWQiLCJzZXR0aW5ncyIsImdldFNldHRpbmdzIiwibGludGluZyIsInBhdGhOYW1lIiwibGludGVyQXJncyIsImFyZ3MiLCJBcnJheSIsImlzQXJyYXkiLCJnZXRFeGVjdXRpb25JbmZvIiwiY3VzdG9tQXJncyIsImV4ZWNQYXRoIiwiY29uY2F0IiwibW9kdWxlTmFtZSIsImJhc2VuYW1lIiwiUHlsaW50TGludGVySW5mbyIsIndvcmtzcGFjZVNlcnZpY2UiLCJQcm9kdWN0IiwicHlsaW50IiwiamVkaUVuYWJsZWQiLCJpbnNwZWN0aW9uIiwiZ2V0Q29uZmlndXJhdGlvbiIsImluc3BlY3QiLCJnbG9iYWxWYWx1ZSIsInVuZGVmaW5lZCIsIndvcmtzcGFjZUZvbGRlclZhbHVlIiwid29ya3NwYWNlVmFsdWUiXSwibWFwcGluZ3MiOiJBQUFBLGEsQ0FDQTtBQUNBOztBQUNBLElBQUlBLFNBQVMsR0FBSSxVQUFR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QUFDSDs7QUFoQnFDOztBQWtCMUNqQixPQUFPLENBQUNtQyxnQkFBUixHQUEyQkEsZ0JBQTNCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG4vLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XG4gICAgfSk7XG59O1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vdHlwZXNcIik7XG5jbGFzcyBMaW50ZXJJbmZvIHtcbiAgICBjb25zdHJ1Y3Rvcihwcm9kdWN0LCBpZCwgY29uZmlnU2VydmljZSwgY29uZmlnRmlsZU5hbWVzID0gW10pIHtcbiAgICAgICAgdGhpcy5jb25maWdTZXJ2aWNlID0gY29uZmlnU2VydmljZTtcbiAgICAgICAgdGhpcy5fcHJvZHVjdCA9IHByb2R1Y3Q7XG4gICAgICAgIHRoaXMuX2lkID0gaWQ7XG4gICAgICAgIHRoaXMuX2NvbmZpZ0ZpbGVOYW1lcyA9IGNvbmZpZ0ZpbGVOYW1lcztcbiAgICB9XG4gICAgZ2V0IGlkKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5faWQ7XG4gICAgfVxuICAgIGdldCBwcm9kdWN0KCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fcHJvZHVjdDtcbiAgICB9XG4gICAgZ2V0IHBhdGhTZXR0aW5nTmFtZSgpIHtcbiAgICAgICAgcmV0dXJuIGAke3RoaXMuaWR9UGF0aGA7XG4gICAgfVxuICAgIGdldCBhcmdzU2V0dGluZ05hbWUoKSB7XG4gICAgICAgIHJldHVybiBgJHt0aGlzLmlkfUFyZ3NgO1xuICAgIH1cbiAgICBnZXQgZW5hYmxlZFNldHRpbmdOYW1lKCkge1xuICAgICAgICByZXR1cm4gYCR7dGhpcy5pZH1FbmFibGVkYDtcbiAgICB9XG4gICAgZ2V0IGNvbmZpZ0ZpbGVOYW1lcygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NvbmZpZ0ZpbGVOYW1lcztcbiAgICB9XG4gICAgZW5hYmxlQXN5bmMoZW5hYmxlZCwgcmVzb3VyY2UpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbmZpZ1NlcnZpY2UudXBkYXRlU2V0dGluZyhgbGludGluZy4ke3RoaXMuZW5hYmxlZFNldHRpbmdOYW1lfWAsIGVuYWJsZWQsIHJlc291cmNlKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGlzRW5hYmxlZChyZXNvdXJjZSkge1xuICAgICAgICBjb25zdCBzZXR0aW5ncyA9IHRoaXMuY29uZmlnU2VydmljZS5nZXRTZXR0aW5ncyhyZXNvdXJjZSk7XG4gICAgICAgIHJldHVybiBzZXR0aW5ncy5saW50aW5nW3RoaXMuZW5hYmxlZFNldHRpbmdOYW1lXTtcbiAgICB9XG4gICAgcGF0aE5hbWUocmVzb3VyY2UpIHtcbiAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0U2V0dGluZ3MocmVzb3VyY2UpO1xuICAgICAgICByZXR1cm4gc2V0dGluZ3MubGludGluZ1t0aGlzLnBhdGhTZXR0aW5nTmFtZV07XG4gICAgfVxuICAgIGxpbnRlckFyZ3MocmVzb3VyY2UpIHtcbiAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0U2V0dGluZ3MocmVzb3VyY2UpO1xuICAgICAgICBjb25zdCBhcmdzID0gc2V0dGluZ3MubGludGluZ1t0aGlzLmFyZ3NTZXR0aW5nTmFtZV07XG4gICAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KGFyZ3MpID8gYXJncyA6IFtdO1xuICAgIH1cbiAgICBnZXRFeGVjdXRpb25JbmZvKGN1c3RvbUFyZ3MsIHJlc291cmNlKSB7XG4gICAgICAgIGNvbnN0IGV4ZWNQYXRoID0gdGhpcy5wYXRoTmFtZShyZXNvdXJjZSk7XG4gICAgICAgIGNvbnN0IGFyZ3MgPSB0aGlzLmxpbnRlckFyZ3MocmVzb3VyY2UpLmNvbmNhdChjdXN0b21BcmdzKTtcbiAgICAgICAgbGV0IG1vZHVsZU5hbWU7XG4gICAgICAgIC8vIElmIHBhdGggaW5mb3JtYXRpb24gaXMgbm90IGF2YWlsYWJsZSwgdGhlbiB0cmVhdCBpdCBhcyBhIG1vZHVsZSxcbiAgICAgICAgaWYgKHBhdGguYmFzZW5hbWUoZXhlY1BhdGgpID09PSBleGVjUGF0aCkge1xuICAgICAgICAgICAgbW9kdWxlTmFtZSA9IGV4ZWNQYXRoO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7IGV4ZWNQYXRoLCBtb2R1bGVOYW1lLCBhcmdzLCBwcm9kdWN0OiB0aGlzLnByb2R1Y3QgfTtcbiAgICB9XG59XG5leHBvcnRzLkxpbnRlckluZm8gPSBMaW50ZXJJbmZvO1xuY2xhc3MgUHlsaW50TGludGVySW5mbyBleHRlbmRzIExpbnRlckluZm8ge1xuICAgIGNvbnN0cnVjdG9yKGNvbmZpZ1NlcnZpY2UsIHdvcmtzcGFjZVNlcnZpY2UsIGNvbmZpZ0ZpbGVOYW1lcyA9IFtdKSB7XG4gICAgICAgIHN1cGVyKHR5cGVzXzEuUHJvZHVjdC5weWxpbnQsICdweWxpbnQnLCBjb25maWdTZXJ2aWNlLCBjb25maWdGaWxlTmFtZXMpO1xuICAgICAgICB0aGlzLndvcmtzcGFjZVNlcnZpY2UgPSB3b3Jrc3BhY2VTZXJ2aWNlO1xuICAgIH1cbiAgICBpc0VuYWJsZWQocmVzb3VyY2UpIHtcbiAgICAgICAgY29uc3QgZW5hYmxlZCA9IHN1cGVyLmlzRW5hYmxlZChyZXNvdXJjZSk7XG4gICAgICAgIGlmICghZW5hYmxlZCB8fCB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0U2V0dGluZ3MocmVzb3VyY2UpLmplZGlFbmFibGVkKSB7XG4gICAgICAgICAgICByZXR1cm4gZW5hYmxlZDtcbiAgICAgICAgfVxuICAgICAgICAvLyBJZiB3ZSdyZSB1c2luZyBuZXcgTFMsIHRoZW4gYnkgZGVmYXVsdCBQeWxpbnQgaXMgZGlzYWJsZWQgKHVubGVzcyB0aGUgdXNlciBwcm92aWRlcyBhIHZhbHVlKS5cbiAgICAgICAgY29uc3QgaW5zcGVjdGlvbiA9IHRoaXMud29ya3NwYWNlU2VydmljZS5nZXRDb25maWd1cmF0aW9uKCdweXRob24ubGludGluZycsIHJlc291cmNlKS5pbnNwZWN0KCdweWxpbnRFbmFibGVkJyk7XG4gICAgICAgIGlmICghaW5zcGVjdGlvbiB8fCBpbnNwZWN0aW9uLmdsb2JhbFZhbHVlID09PSB1bmRlZmluZWQgJiYgaW5zcGVjdGlvbi53b3Jrc3BhY2VGb2xkZXJWYWx1ZSA9PT0gdW5kZWZpbmVkIHx8IGluc3BlY3Rpb24ud29ya3NwYWNlVmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBlbmFibGVkO1xuICAgIH1cbn1cbmV4cG9ydHMuUHlsaW50TGludGVySW5mbyA9IFB5bGludExpbnRlckluZm87XG4vLyMgc291cmNlTWFwcGluZ1VSTD1saW50ZXJJbmZvLmpzLm1hcCJdfQ==