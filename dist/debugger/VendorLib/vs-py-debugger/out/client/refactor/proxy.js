"use strict"; // tslint:disable:no-any no-empty member-ordering prefer-const prefer-template no-var-self

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const path = require("path");

const vscode_1 = require("vscode");

require("../common/extensions");

const types_1 = require("../common/process/types");

const util_1 = require("../common/util");

const async_1 = require("../common/utils/async");

const text_1 = require("../common/utils/text");

class RefactorProxy extends vscode_1.Disposable {
  constructor(extensionDir, pythonSettings, workspaceRoot, serviceContainer) {
    super(() => {});
    this.pythonSettings = pythonSettings;
    this.workspaceRoot = workspaceRoot;
    this.serviceContainer = serviceContainer;
    this._previousOutData = '';
    this._previousStdErrData = '';
    this._startedSuccessfully = false;
    this._extensionDir = extensionDir;
  }

  dispose() {
    try {
      this._process.kill();
    } catch (ex) {}

    this._process = undefined;
  }

  getOffsetAt(document, position) {
    if (!util_1.IS_WINDOWS) {
      return document.offsetAt(position);
    } // get line count
    // Rope always uses LF, instead of CRLF on windows, funny isn't it
    // So for each line, reduce one characer (for CR)
    // But Not all Windows users use CRLF


    const offset = document.offsetAt(position);
    const winEols = text_1.getWindowsLineEndingCount(document, offset);
    return offset - winEols;
  }

  rename(document, name, filePath, range, options) {
    if (!options) {
      options = vscode_1.window.activeTextEditor.options;
    }

    const command = {
      lookup: 'rename',
      file: filePath,
      start: this.getOffsetAt(document, range.start).toString(),
      id: '1',
      name: name,
      indent_size: options.tabSize
    };
    return this.sendCommand(JSON.stringify(command));
  }

  extractVariable(document, name, filePath, range, options) {
    if (!options) {
      options = vscode_1.window.activeTextEditor.options;
    }

    const command = {
      lookup: 'extract_variable',
      file: filePath,
      start: this.getOffsetAt(document, range.start).toString(),
      end: this.getOffsetAt(document, range.end).toString(),
      id: '1',
      name: name,
      indent_size: options.tabSize
    };
    return this.sendCommand(JSON.stringify(command));
  }

  extractMethod(document, name, filePath, range, options) {
    if (!options) {
      options = vscode_1.window.activeTextEditor.options;
    } // Ensure last line is an empty line


    if (!document.lineAt(document.lineCount - 1).isEmptyOrWhitespace && range.start.line === document.lineCount - 1) {
      return Promise.reject('Missing blank line at the end of document (PEP8).');
    }

    const command = {
      lookup: 'extract_method',
      file: filePath,
      start: this.getOffsetAt(document, range.start).toString(),
      end: this.getOffsetAt(document, range.end).toString(),
      id: '1',
      name: name,
      indent_size: options.tabSize
    };
    return this.sendCommand(JSON.stringify(command));
  }

  sendCommand(command, telemetryEvent) {
    return this.initialize(this.pythonSettings.pythonPath).then(() => {
      // tslint:disable-next-line:promise-must-complete
      return new Promise((resolve, reject) => {
        this._commandResolve = resolve;
        this._commandReject = reject;

        this._process.stdin.write(command + '\n');
      });
    });
  }

  initialize(pythonPath) {
    return __awaiter(this, void 0, void 0, function* () {
      const pythonProc = yield this.serviceContainer.get(types_1.IPythonExecutionFactory).create({
        resource: vscode_1.Uri.file(this.workspaceRoot)
      });
      this.initialized = async_1.createDeferred();
      const args = ['refactor.py', this.workspaceRoot];
      const cwd = path.join(this._extensionDir, 'pythonFiles');
      const result = pythonProc.execObservable(args, {
        cwd
      });
      this._process = result.proc;
      result.out.subscribe(output => {
        if (output.source === 'stdout') {
          if (!this._startedSuccessfully && output.out.startsWith('STARTED')) {
            this._startedSuccessfully = true;
            return this.initialized.resolve();
          }

          this.onData(output.out);
        } else {
          this.handleStdError(output.out);
        }
      }, error => this.handleError(error));
      return this.initialized.promise;
    });
  }

  handleStdError(data) {
    // Possible there was an exception in parsing the data returned
    // So append the data then parse it
    let dataStr = this._previousStdErrData = this._previousStdErrData + data + '';
    let errorResponse;

    try {
      errorResponse = dataStr.split(/\r?\n/g).filter(line => line.length > 0).map(resp => JSON.parse(resp));
      this._previousStdErrData = '';
    } catch (ex) {
      console.error(ex); // Possible we've only received part of the data, hence don't clear previousData

      return;
    }

    if (typeof errorResponse[0].message !== 'string' || errorResponse[0].message.length === 0) {
      errorResponse[0].message = errorResponse[0].traceback.splitLines().pop();
    }

    let errorMessage = errorResponse[0].message + '\n' + errorResponse[0].traceback;

    if (this._startedSuccessfully) {
      this._commandReject(`Refactor failed. ${errorMessage}`);
    } else {
      if (typeof errorResponse[0].type === 'string' && errorResponse[0].type === 'ModuleNotFoundError') {
        this.initialized.reject('Not installed');
        return;
      }

      this.initialized.reject(`Refactor failed. ${errorMessage}`);
    }
  }

  handleError(error) {
    if (this._startedSuccessfully) {
      return this._commandReject(error);
    }

    this.initialized.reject(error);
  }

  onData(data) {
    if (!this._commandResolve) {
      return;
    } // Possible there was an exception in parsing the data returned
    // So append the data then parse it


    let dataStr = this._previousOutData = this._previousOutData + data + '';
    let response;

    try {
      response = dataStr.split(/\r?\n/g).filter(line => line.length > 0).map(resp => JSON.parse(resp));
      this._previousOutData = '';
    } catch (ex) {
      // Possible we've only received part of the data, hence don't clear previousData
      return;
    }

    this.dispose();

    this._commandResolve(response[0]);

    this._commandResolve = undefined;
  }

}

exports.RefactorProxy = RefactorProxy;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByb3h5LmpzIl0sIm5hbWVzIjpbIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJwYXRoIiwicmVxdWlyZSIsInZzY29kZV8xIiwidHlwZXNfMSIsInV0aWxfMSIsImFzeW5jXzEiLCJ0ZXh0XzEiLCJSZWZhY3RvclByb3h5IiwiRGlzcG9zYWJsZSIsImNvbnN0cnVjdG9yIiwiZXh0ZW5zaW9uRGlyIiwicHl0aG9uU2V0dGluZ3MiLCJ3b3Jrc3BhY2VSb290Iiwic2VydmljZUNvbnRhaW5lciIsIl9wcmV2aW91c091dERhdGEiLCJfcHJldmlvdXNTdGRFcnJEYXRhIiwiX3N0YXJ0ZWRTdWNjZXNzZnVsbHkiLCJfZXh0ZW5zaW9uRGlyIiwiZGlzcG9zZSIsIl9wcm9jZXNzIiwia2lsbCIsImV4IiwidW5kZWZpbmVkIiwiZ2V0T2Zmc2V0QXQiLCJkb2N1bWVudCIsInBvc2l0aW9uIiwiSVNfV0lORE9XUyIsIm9mZnNldEF0Iiwib2Zmc2V0Iiwid2luRW9scyIsImdldFdpbmRvd3NMaW5lRW5kaW5nQ291bnQiLCJyZW5hbWUiLCJuYW1lIiwiZmlsZVBhdGgiLCJyYW5nZSIsIm9wdGlvbnMiLCJ3aW5kb3ciLCJhY3RpdmVUZXh0RWRpdG9yIiwiY29tbWFuZCIsImxvb2t1cCIsImZpbGUiLCJzdGFydCIsInRvU3RyaW5nIiwiaWQiLCJpbmRlbnRfc2l6ZSIsInRhYlNpemUiLCJzZW5kQ29tbWFuZCIsIkpTT04iLCJzdHJpbmdpZnkiLCJleHRyYWN0VmFyaWFibGUiLCJlbmQiLCJleHRyYWN0TWV0aG9kIiwibGluZUF0IiwibGluZUNvdW50IiwiaXNFbXB0eU9yV2hpdGVzcGFjZSIsImxpbmUiLCJ0ZWxlbWV0cnlFdmVudCIsImluaXRpYWxpemUiLCJweXRob25QYXRoIiwiX2NvbW1hbmRSZXNvbHZlIiwiX2NvbW1hbmRSZWplY3QiLCJzdGRpbiIsIndyaXRlIiwicHl0aG9uUHJvYyIsImdldCIsIklQeXRob25FeGVjdXRpb25GYWN0b3J5IiwiY3JlYXRlIiwicmVzb3VyY2UiLCJVcmkiLCJpbml0aWFsaXplZCIsImNyZWF0ZURlZmVycmVkIiwiYXJncyIsImN3ZCIsImpvaW4iLCJleGVjT2JzZXJ2YWJsZSIsInByb2MiLCJvdXQiLCJzdWJzY3JpYmUiLCJvdXRwdXQiLCJzb3VyY2UiLCJzdGFydHNXaXRoIiwib25EYXRhIiwiaGFuZGxlU3RkRXJyb3IiLCJlcnJvciIsImhhbmRsZUVycm9yIiwicHJvbWlzZSIsImRhdGEiLCJkYXRhU3RyIiwiZXJyb3JSZXNwb25zZSIsInNwbGl0IiwiZmlsdGVyIiwibGVuZ3RoIiwibWFwIiwicmVzcCIsInBhcnNlIiwiY29uc29sZSIsIm1lc3NhZ2UiLCJ0cmFjZWJhY2siLCJzcGxpdExpbmVzIiwicG9wIiwiZXJyb3JNZXNzYWdlIiwidHlwZSIsInJlc3BvbnNlIl0sIm1hcHBpbmdzIjoiQUFBQSxhLENBQ0E7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FBL0IsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3JGLFNBQU8sS0FBS0QsQ0FBQyxLQUFLQSxDQUFDLEdBQUdFLE9BQVQsQ0FBTixFQUF5QixVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUN2RCxhQUFTQyxTQUFULENBQW1CQyxLQUFuQixFQUEwQjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUNPLElBQVYsQ0FBZUYsS0FBZixDQUFELENBQUo7QUFBOEIsT0FBcEMsQ0FBcUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FB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eSBuby1lbXB0eSBtZW1iZXItb3JkZXJpbmcgcHJlZmVyLWNvbnN0IHByZWZlci10ZW1wbGF0ZSBuby12YXItc2VsZlxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcbiAgICB9KTtcbn07XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5jb25zdCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XG5jb25zdCB2c2NvZGVfMSA9IHJlcXVpcmUoXCJ2c2NvZGVcIik7XG5yZXF1aXJlKFwiLi4vY29tbW9uL2V4dGVuc2lvbnNcIik7XG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uL2NvbW1vbi9wcm9jZXNzL3R5cGVzXCIpO1xuY29uc3QgdXRpbF8xID0gcmVxdWlyZShcIi4uL2NvbW1vbi91dGlsXCIpO1xuY29uc3QgYXN5bmNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vdXRpbHMvYXN5bmNcIik7XG5jb25zdCB0ZXh0XzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL3V0aWxzL3RleHRcIik7XG5jbGFzcyBSZWZhY3RvclByb3h5IGV4dGVuZHMgdnNjb2RlXzEuRGlzcG9zYWJsZSB7XG4gICAgY29uc3RydWN0b3IoZXh0ZW5zaW9uRGlyLCBweXRob25TZXR0aW5ncywgd29ya3NwYWNlUm9vdCwgc2VydmljZUNvbnRhaW5lcikge1xuICAgICAgICBzdXBlcigoKSA9PiB7IH0pO1xuICAgICAgICB0aGlzLnB5dGhvblNldHRpbmdzID0gcHl0aG9uU2V0dGluZ3M7XG4gICAgICAgIHRoaXMud29ya3NwYWNlUm9vdCA9IHdvcmtzcGFjZVJvb3Q7XG4gICAgICAgIHRoaXMuc2VydmljZUNvbnRhaW5lciA9IHNlcnZpY2VDb250YWluZXI7XG4gICAgICAgIHRoaXMuX3ByZXZpb3VzT3V0RGF0YSA9ICcnO1xuICAgICAgICB0aGlzLl9wcmV2aW91c1N0ZEVyckRhdGEgPSAnJztcbiAgICAgICAgdGhpcy5fc3RhcnRlZFN1Y2Nlc3NmdWxseSA9IGZhbHNlO1xuICAgICAgICB0aGlzLl9leHRlbnNpb25EaXIgPSBleHRlbnNpb25EaXI7XG4gICAgfVxuICAgIGRpc3Bvc2UoKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLl9wcm9jZXNzLmtpbGwoKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXgpIHtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9wcm9jZXNzID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBnZXRPZmZzZXRBdChkb2N1bWVudCwgcG9zaXRpb24pIHtcbiAgICAgICAgaWYgKCF1dGlsXzEuSVNfV0lORE9XUykge1xuICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50Lm9mZnNldEF0KHBvc2l0aW9uKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBnZXQgbGluZSBjb3VudFxuICAgICAgICAvLyBSb3BlIGFsd2F5cyB1c2VzIExGLCBpbnN0ZWFkIG9mIENSTEYgb24gd2luZG93cywgZnVubnkgaXNuJ3QgaXRcbiAgICAgICAgLy8gU28gZm9yIGVhY2ggbGluZSwgcmVkdWNlIG9uZSBjaGFyYWNlciAoZm9yIENSKVxuICAgICAgICAvLyBCdXQgTm90IGFsbCBXaW5kb3dzIHVzZXJzIHVzZSBDUkxGXG4gICAgICAgIGNvbnN0IG9mZnNldCA9IGRvY3VtZW50Lm9mZnNldEF0KHBvc2l0aW9uKTtcbiAgICAgICAgY29uc3Qgd2luRW9scyA9IHRleHRfMS5nZXRXaW5kb3dzTGluZUVuZGluZ0NvdW50KGRvY3VtZW50LCBvZmZzZXQpO1xuICAgICAgICByZXR1cm4gb2Zmc2V0IC0gd2luRW9scztcbiAgICB9XG4gICAgcmVuYW1lKGRvY3VtZW50LCBuYW1lLCBmaWxlUGF0aCwgcmFuZ2UsIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKCFvcHRpb25zKSB7XG4gICAgICAgICAgICBvcHRpb25zID0gdnNjb2RlXzEud2luZG93LmFjdGl2ZVRleHRFZGl0b3Iub3B0aW9ucztcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBjb21tYW5kID0ge1xuICAgICAgICAgICAgbG9va3VwOiAncmVuYW1lJyxcbiAgICAgICAgICAgIGZpbGU6IGZpbGVQYXRoLFxuICAgICAgICAgICAgc3RhcnQ6IHRoaXMuZ2V0T2Zmc2V0QXQoZG9jdW1lbnQsIHJhbmdlLnN0YXJ0KS50b1N0cmluZygpLFxuICAgICAgICAgICAgaWQ6ICcxJyxcbiAgICAgICAgICAgIG5hbWU6IG5hbWUsXG4gICAgICAgICAgICBpbmRlbnRfc2l6ZTogb3B0aW9ucy50YWJTaXplXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiB0aGlzLnNlbmRDb21tYW5kKEpTT04uc3RyaW5naWZ5KGNvbW1hbmQpKTtcbiAgICB9XG4gICAgZXh0cmFjdFZhcmlhYmxlKGRvY3VtZW50LCBuYW1lLCBmaWxlUGF0aCwgcmFuZ2UsIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKCFvcHRpb25zKSB7XG4gICAgICAgICAgICBvcHRpb25zID0gdnNjb2RlXzEud2luZG93LmFjdGl2ZVRleHRFZGl0b3Iub3B0aW9ucztcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBjb21tYW5kID0ge1xuICAgICAgICAgICAgbG9va3VwOiAnZXh0cmFjdF92YXJpYWJsZScsXG4gICAgICAgICAgICBmaWxlOiBmaWxlUGF0aCxcbiAgICAgICAgICAgIHN0YXJ0OiB0aGlzLmdldE9mZnNldEF0KGRvY3VtZW50LCByYW5nZS5zdGFydCkudG9TdHJpbmcoKSxcbiAgICAgICAgICAgIGVuZDogdGhpcy5nZXRPZmZzZXRBdChkb2N1bWVudCwgcmFuZ2UuZW5kKS50b1N0cmluZygpLFxuICAgICAgICAgICAgaWQ6ICcxJyxcbiAgICAgICAgICAgIG5hbWU6IG5hbWUsXG4gICAgICAgICAgICBpbmRlbnRfc2l6ZTogb3B0aW9ucy50YWJTaXplXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiB0aGlzLnNlbmRDb21tYW5kKEpTT04uc3RyaW5naWZ5KGNvbW1hbmQpKTtcbiAgICB9XG4gICAgZXh0cmFjdE1ldGhvZChkb2N1bWVudCwgbmFtZSwgZmlsZVBhdGgsIHJhbmdlLCBvcHRpb25zKSB7XG4gICAgICAgIGlmICghb3B0aW9ucykge1xuICAgICAgICAgICAgb3B0aW9ucyA9IHZzY29kZV8xLndpbmRvdy5hY3RpdmVUZXh0RWRpdG9yLm9wdGlvbnM7XG4gICAgICAgIH1cbiAgICAgICAgLy8gRW5zdXJlIGxhc3QgbGluZSBpcyBhbiBlbXB0eSBsaW5lXG4gICAgICAgIGlmICghZG9jdW1lbnQubGluZUF0KGRvY3VtZW50LmxpbmVDb3VudCAtIDEpLmlzRW1wdHlPcldoaXRlc3BhY2UgJiYgcmFuZ2Uuc3RhcnQubGluZSA9PT0gZG9jdW1lbnQubGluZUNvdW50IC0gMSkge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCdNaXNzaW5nIGJsYW5rIGxpbmUgYXQgdGhlIGVuZCBvZiBkb2N1bWVudCAoUEVQOCkuJyk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY29tbWFuZCA9IHtcbiAgICAgICAgICAgIGxvb2t1cDogJ2V4dHJhY3RfbWV0aG9kJyxcbiAgICAgICAgICAgIGZpbGU6IGZpbGVQYXRoLFxuICAgICAgICAgICAgc3RhcnQ6IHRoaXMuZ2V0T2Zmc2V0QXQoZG9jdW1lbnQsIHJhbmdlLnN0YXJ0KS50b1N0cmluZygpLFxuICAgICAgICAgICAgZW5kOiB0aGlzLmdldE9mZnNldEF0KGRvY3VtZW50LCByYW5nZS5lbmQpLnRvU3RyaW5nKCksXG4gICAgICAgICAgICBpZDogJzEnLFxuICAgICAgICAgICAgbmFtZTogbmFtZSxcbiAgICAgICAgICAgIGluZGVudF9zaXplOiBvcHRpb25zLnRhYlNpemVcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VuZENvbW1hbmQoSlNPTi5zdHJpbmdpZnkoY29tbWFuZCkpO1xuICAgIH1cbiAgICBzZW5kQ29tbWFuZChjb21tYW5kLCB0ZWxlbWV0cnlFdmVudCkge1xuICAgICAgICByZXR1cm4gdGhpcy5pbml0aWFsaXplKHRoaXMucHl0aG9uU2V0dGluZ3MucHl0aG9uUGF0aCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6cHJvbWlzZS1tdXN0LWNvbXBsZXRlXG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuX2NvbW1hbmRSZXNvbHZlID0gcmVzb2x2ZTtcbiAgICAgICAgICAgICAgICB0aGlzLl9jb21tYW5kUmVqZWN0ID0gcmVqZWN0O1xuICAgICAgICAgICAgICAgIHRoaXMuX3Byb2Nlc3Muc3RkaW4ud3JpdGUoY29tbWFuZCArICdcXG4nKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgaW5pdGlhbGl6ZShweXRob25QYXRoKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBweXRob25Qcm9jID0geWllbGQgdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklQeXRob25FeGVjdXRpb25GYWN0b3J5KS5jcmVhdGUoeyByZXNvdXJjZTogdnNjb2RlXzEuVXJpLmZpbGUodGhpcy53b3Jrc3BhY2VSb290KSB9KTtcbiAgICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSBhc3luY18xLmNyZWF0ZURlZmVycmVkKCk7XG4gICAgICAgICAgICBjb25zdCBhcmdzID0gWydyZWZhY3Rvci5weScsIHRoaXMud29ya3NwYWNlUm9vdF07XG4gICAgICAgICAgICBjb25zdCBjd2QgPSBwYXRoLmpvaW4odGhpcy5fZXh0ZW5zaW9uRGlyLCAncHl0aG9uRmlsZXMnKTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHB5dGhvblByb2MuZXhlY09ic2VydmFibGUoYXJncywgeyBjd2QgfSk7XG4gICAgICAgICAgICB0aGlzLl9wcm9jZXNzID0gcmVzdWx0LnByb2M7XG4gICAgICAgICAgICByZXN1bHQub3V0LnN1YnNjcmliZShvdXRwdXQgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChvdXRwdXQuc291cmNlID09PSAnc3Rkb3V0Jykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX3N0YXJ0ZWRTdWNjZXNzZnVsbHkgJiYgb3V0cHV0Lm91dC5zdGFydHNXaXRoKCdTVEFSVEVEJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3N0YXJ0ZWRTdWNjZXNzZnVsbHkgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5pdGlhbGl6ZWQucmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRoaXMub25EYXRhKG91dHB1dC5vdXQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVTdGRFcnJvcihvdXRwdXQub3V0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LCBlcnJvciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycm9yKSk7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5pbml0aWFsaXplZC5wcm9taXNlO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgaGFuZGxlU3RkRXJyb3IoZGF0YSkge1xuICAgICAgICAvLyBQb3NzaWJsZSB0aGVyZSB3YXMgYW4gZXhjZXB0aW9uIGluIHBhcnNpbmcgdGhlIGRhdGEgcmV0dXJuZWRcbiAgICAgICAgLy8gU28gYXBwZW5kIHRoZSBkYXRhIHRoZW4gcGFyc2UgaXRcbiAgICAgICAgbGV0IGRhdGFTdHIgPSB0aGlzLl9wcmV2aW91c1N0ZEVyckRhdGEgPSB0aGlzLl9wcmV2aW91c1N0ZEVyckRhdGEgKyBkYXRhICsgJyc7XG4gICAgICAgIGxldCBlcnJvclJlc3BvbnNlO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgZXJyb3JSZXNwb25zZSA9IGRhdGFTdHIuc3BsaXQoL1xccj9cXG4vZykuZmlsdGVyKGxpbmUgPT4gbGluZS5sZW5ndGggPiAwKS5tYXAocmVzcCA9PiBKU09OLnBhcnNlKHJlc3ApKTtcbiAgICAgICAgICAgIHRoaXMuX3ByZXZpb3VzU3RkRXJyRGF0YSA9ICcnO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChleCkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihleCk7XG4gICAgICAgICAgICAvLyBQb3NzaWJsZSB3ZSd2ZSBvbmx5IHJlY2VpdmVkIHBhcnQgb2YgdGhlIGRhdGEsIGhlbmNlIGRvbid0IGNsZWFyIHByZXZpb3VzRGF0YVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0eXBlb2YgZXJyb3JSZXNwb25zZVswXS5tZXNzYWdlICE9PSAnc3RyaW5nJyB8fCBlcnJvclJlc3BvbnNlWzBdLm1lc3NhZ2UubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICBlcnJvclJlc3BvbnNlWzBdLm1lc3NhZ2UgPSBlcnJvclJlc3BvbnNlWzBdLnRyYWNlYmFjay5zcGxpdExpbmVzKCkucG9wKCk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGVycm9yTWVzc2FnZSA9IGVycm9yUmVzcG9uc2VbMF0ubWVzc2FnZSArICdcXG4nICsgZXJyb3JSZXNwb25zZVswXS50cmFjZWJhY2s7XG4gICAgICAgIGlmICh0aGlzLl9zdGFydGVkU3VjY2Vzc2Z1bGx5KSB7XG4gICAgICAgICAgICB0aGlzLl9jb21tYW5kUmVqZWN0KGBSZWZhY3RvciBmYWlsZWQuICR7ZXJyb3JNZXNzYWdlfWApO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBlcnJvclJlc3BvbnNlWzBdLnR5cGUgPT09ICdzdHJpbmcnICYmIGVycm9yUmVzcG9uc2VbMF0udHlwZSA9PT0gJ01vZHVsZU5vdEZvdW5kRXJyb3InKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5pbml0aWFsaXplZC5yZWplY3QoJ05vdCBpbnN0YWxsZWQnKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmluaXRpYWxpemVkLnJlamVjdChgUmVmYWN0b3IgZmFpbGVkLiAke2Vycm9yTWVzc2FnZX1gKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBoYW5kbGVFcnJvcihlcnJvcikge1xuICAgICAgICBpZiAodGhpcy5fc3RhcnRlZFN1Y2Nlc3NmdWxseSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NvbW1hbmRSZWplY3QoZXJyb3IpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZWQucmVqZWN0KGVycm9yKTtcbiAgICB9XG4gICAgb25EYXRhKGRhdGEpIHtcbiAgICAgICAgaWYgKCF0aGlzLl9jb21tYW5kUmVzb2x2ZSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIC8vIFBvc3NpYmxlIHRoZXJlIHdhcyBhbiBleGNlcHRpb24gaW4gcGFyc2luZyB0aGUgZGF0YSByZXR1cm5lZFxuICAgICAgICAvLyBTbyBhcHBlbmQgdGhlIGRhdGEgdGhlbiBwYXJzZSBpdFxuICAgICAgICBsZXQgZGF0YVN0ciA9IHRoaXMuX3ByZXZpb3VzT3V0RGF0YSA9IHRoaXMuX3ByZXZpb3VzT3V0RGF0YSArIGRhdGEgKyAnJztcbiAgICAgICAgbGV0IHJlc3BvbnNlO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgcmVzcG9uc2UgPSBkYXRhU3RyLnNwbGl0KC9cXHI/XFxuL2cpLmZpbHRlcihsaW5lID0+IGxpbmUubGVuZ3RoID4gMCkubWFwKHJlc3AgPT4gSlNPTi5wYXJzZShyZXNwKSk7XG4gICAgICAgICAgICB0aGlzLl9wcmV2aW91c091dERhdGEgPSAnJztcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXgpIHtcbiAgICAgICAgICAgIC8vIFBvc3NpYmxlIHdlJ3ZlIG9ubHkgcmVjZWl2ZWQgcGFydCBvZiB0aGUgZGF0YSwgaGVuY2UgZG9uJ3QgY2xlYXIgcHJldmlvdXNEYXRhXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kaXNwb3NlKCk7XG4gICAgICAgIHRoaXMuX2NvbW1hbmRSZXNvbHZlKHJlc3BvbnNlWzBdKTtcbiAgICAgICAgdGhpcy5fY29tbWFuZFJlc29sdmUgPSB1bmRlZmluZWQ7XG4gICAgfVxufVxuZXhwb3J0cy5SZWZhY3RvclByb3h5ID0gUmVmYWN0b3JQcm94eTtcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPXByb3h5LmpzLm1hcCJdfQ==