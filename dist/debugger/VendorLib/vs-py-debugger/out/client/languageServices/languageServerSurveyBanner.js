// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const types_1 = require("../activation/types");

const types_2 = require("../common/application/types");

require("../common/extensions");

const types_3 = require("../common/types");

const localize = require("../common/utils/localize");

const random_1 = require("../common/utils/random"); // persistent state names, exported to make use of in testing


var LSSurveyStateKeys;

(function (LSSurveyStateKeys) {
  LSSurveyStateKeys["ShowBanner"] = "ShowLSSurveyBanner";
  LSSurveyStateKeys["ShowAttemptCounter"] = "LSSurveyShowAttempt";
  LSSurveyStateKeys["ShowAfterCompletionCount"] = "LSSurveyShowCount";
})(LSSurveyStateKeys = exports.LSSurveyStateKeys || (exports.LSSurveyStateKeys = {}));

var LSSurveyLabelIndex;

(function (LSSurveyLabelIndex) {
  LSSurveyLabelIndex[LSSurveyLabelIndex["Yes"] = 0] = "Yes";
  LSSurveyLabelIndex[LSSurveyLabelIndex["No"] = 1] = "No";
})(LSSurveyLabelIndex || (LSSurveyLabelIndex = {}));
/*
This class represents a popup that will ask our users for some feedback after
a specific event occurs N times.
*/


let LanguageServerSurveyBanner = class LanguageServerSurveyBanner {
  constructor(appShell, persistentState, browserService, lsService, showAfterMinimumEventsCount = 100, showBeforeMaximumEventsCount = 500) {
    this.appShell = appShell;
    this.persistentState = persistentState;
    this.browserService = browserService;
    this.lsService = lsService;
    this.disabledInCurrentSession = false;
    this.isInitialized = false;
    this.bannerMessage = localize.LanguageServiceSurveyBanner.bannerMessage();
    this.bannerLabels = [localize.LanguageServiceSurveyBanner.bannerLabelYes(), localize.LanguageServiceSurveyBanner.bannerLabelNo()];
    this.minCompletionsBeforeShow = showAfterMinimumEventsCount;
    this.maxCompletionsBeforeShow = showBeforeMaximumEventsCount;
    this.initialize();
  }

  initialize() {
    if (this.isInitialized) {
      return;
    }

    this.isInitialized = true;

    if (this.minCompletionsBeforeShow >= this.maxCompletionsBeforeShow) {
      this.disable().ignoreErrors();
    }
  }

  get optionLabels() {
    return this.bannerLabels;
  }

  get shownCount() {
    return this.getPythonLSLaunchCounter();
  }

  get enabled() {
    return this.persistentState.createGlobalPersistentState(LSSurveyStateKeys.ShowBanner, true).value;
  }

  showBanner() {
    return __awaiter(this, void 0, void 0, function* () {
      if (!this.enabled || this.disabledInCurrentSession) {
        return;
      }

      const launchCounter = yield this.incrementPythonLanguageServiceLaunchCounter();
      const show = yield this.shouldShowBanner(launchCounter);

      if (!show) {
        return;
      }

      const response = yield this.appShell.showInformationMessage(this.bannerMessage, ...this.bannerLabels);

      switch (response) {
        case this.bannerLabels[LSSurveyLabelIndex.Yes]:
          {
            yield this.launchSurvey();
            yield this.disable();
            break;
          }

        case this.bannerLabels[LSSurveyLabelIndex.No]:
          {
            yield this.disable();
            break;
          }

        default:
          {
            // Disable for the current session.
            this.disabledInCurrentSession = true;
          }
      }
    });
  }

  shouldShowBanner(launchCounter) {
    return __awaiter(this, void 0, void 0, function* () {
      if (!this.enabled || this.disabledInCurrentSession) {
        return false;
      }

      if (!launchCounter) {
        launchCounter = yield this.getPythonLSLaunchCounter();
      }

      const threshold = yield this.getPythonLSLaunchThresholdCounter();
      return launchCounter >= threshold;
    });
  }

  disable() {
    return __awaiter(this, void 0, void 0, function* () {
      yield this.persistentState.createGlobalPersistentState(LSSurveyStateKeys.ShowBanner, false).updateValue(false);
    });
  }

  launchSurvey() {
    return __awaiter(this, void 0, void 0, function* () {
      const launchCounter = yield this.getPythonLSLaunchCounter();
      let lsVersion = yield this.getPythonLSVersion();
      lsVersion = encodeURIComponent(lsVersion);
      this.browserService.launch(`https://www.research.net/r/LJZV9BZ?n=${launchCounter}&v=${lsVersion}`);
    });
  }

  incrementPythonLanguageServiceLaunchCounter() {
    return __awaiter(this, void 0, void 0, function* () {
      const state = this.persistentState.createGlobalPersistentState(LSSurveyStateKeys.ShowAttemptCounter, 0);
      yield state.updateValue(state.value + 1);
      return state.value;
    });
  }

  getPythonLSVersion(fallback = 'unknown') {
    return __awaiter(this, void 0, void 0, function* () {
      const langServiceLatestFolder = yield this.lsService.getCurrentLanguageServerDirectory();
      return langServiceLatestFolder ? langServiceLatestFolder.version.raw : fallback;
    });
  }

  getPythonLSLaunchCounter() {
    return __awaiter(this, void 0, void 0, function* () {
      const state = this.persistentState.createGlobalPersistentState(LSSurveyStateKeys.ShowAttemptCounter, 0);
      return state.value;
    });
  }

  getPythonLSLaunchThresholdCounter() {
    return __awaiter(this, void 0, void 0, function* () {
      const state = this.persistentState.createGlobalPersistentState(LSSurveyStateKeys.ShowAfterCompletionCount, undefined);

      if (state.value === undefined) {
        yield state.updateValue(random_1.getRandomBetween(this.minCompletionsBeforeShow, this.maxCompletionsBeforeShow));
      }

      return state.value;
    });
  }

};
LanguageServerSurveyBanner = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_2.IApplicationShell)), __param(1, inversify_1.inject(types_3.IPersistentStateFactory)), __param(2, inversify_1.inject(types_3.IBrowserService)), __param(3, inversify_1.inject(types_1.ILanguageServerFolderService))], LanguageServerSurveyBanner);
exports.LanguageServerSurveyBanner = LanguageServerSurveyBanner;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxhbmd1YWdlU2VydmVyU3VydmV5QmFubmVyLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsIl9fcGFyYW0iLCJwYXJhbUluZGV4IiwiZGVjb3JhdG9yIiwiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsImV4cG9ydHMiLCJpbnZlcnNpZnlfMSIsInJlcXVpcmUiLCJ0eXBlc18xIiwidHlwZXNfMiIsInR5cGVzXzMiLCJsb2NhbGl6ZSIsInJhbmRvbV8xIiwiTFNTdXJ2ZXlTdGF0ZUtleXMiLCJMU1N1cnZleUxhYmVsSW5kZXgiLCJMYW5ndWFnZVNlcnZlclN1cnZleUJhbm5lciIsImNvbnN0cnVjdG9yIiwiYXBwU2hlbGwiLCJwZXJzaXN0ZW50U3RhdGUiLCJicm93c2VyU2VydmljZSIsImxzU2VydmljZSIsInNob3dBZnRlck1pbmltdW1FdmVudHNDb3VudCIsInNob3dCZWZvcmVNYXhpbXVtRXZlbnRzQ291bnQiLCJkaXNhYmxlZEluQ3VycmVudFNlc3Npb24iLCJpc0luaXRpYWxpemVkIiwiYmFubmVyTWVzc2FnZSIsIkxhbmd1YWdlU2VydmljZVN1cnZleUJhbm5lciIsImJhbm5lckxhYmVscyIsImJhbm5lckxhYmVsWWVzIiwiYmFubmVyTGFiZWxObyIsIm1pbkNvbXBsZXRpb25zQmVmb3JlU2hvdyIsIm1heENvbXBsZXRpb25zQmVmb3JlU2hvdyIsImluaXRpYWxpemUiLCJkaXNhYmxlIiwiaWdub3JlRXJyb3JzIiwib3B0aW9uTGFiZWxzIiwic2hvd25Db3VudCIsImdldFB5dGhvbkxTTGF1bmNoQ291bnRlciIsImVuYWJsZWQiLCJjcmVhdGVHbG9iYWxQZXJzaXN0ZW50U3RhdGUiLCJTaG93QmFubmVyIiwic2hvd0Jhbm5lciIsImxhdW5jaENvdW50ZXIiLCJpbmNyZW1lbnRQeXRob25MYW5ndWFnZVNlcnZpY2VMYXVuY2hDb3VudGVyIiwic2hvdyIsInNob3VsZFNob3dCYW5uZXIiLCJyZXNwb25zZSIsInNob3dJbmZvcm1hdGlvbk1lc3NhZ2UiLCJZZXMiLCJsYXVuY2hTdXJ2ZXkiLCJObyIsInRocmVzaG9sZCIsImdldFB5dGhvbkxTTGF1bmNoVGhyZXNob2xkQ291bnRlciIsInVwZGF0ZVZhbHVlIiwibHNWZXJzaW9uIiwiZ2V0UHl0aG9uTFNWZXJzaW9uIiwiZW5jb2RlVVJJQ29tcG9uZW50IiwibGF1bmNoIiwic3RhdGUiLCJTaG93QXR0ZW1wdENvdW50ZXIiLCJmYWxsYmFjayIsImxhbmdTZXJ2aWNlTGF0ZXN0Rm9sZGVyIiwiZ2V0Q3VycmVudExhbmd1YWdlU2VydmVyRGlyZWN0b3J5IiwidmVyc2lvbiIsInJhdyIsIlNob3dBZnRlckNvbXBsZXRpb25Db3VudCIsInVuZGVmaW5lZCIsImdldFJhbmRvbUJldHdlZW4iLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSUFwcGxpY2F0aW9uU2hlbGwiLCJJUGVyc2lzdGVudFN0YXRlRmFjdG9yeSIsIklCcm93c2VyU2VydmljZSIsIklMYW5ndWFnZVNlcnZlckZvbGRlclNlcnZpY2UiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEs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Y2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cbid1c2Ugc3RyaWN0JztcbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xuICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xufTtcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQsIGtleSkgeyBkZWNvcmF0b3IodGFyZ2V0LCBrZXksIHBhcmFtSW5kZXgpOyB9XG59O1xudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcbiAgICB9KTtcbn07XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5jb25zdCBpbnZlcnNpZnlfMSA9IHJlcXVpcmUoXCJpbnZlcnNpZnlcIik7XG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uL2FjdGl2YXRpb24vdHlwZXNcIik7XG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uL2NvbW1vbi9hcHBsaWNhdGlvbi90eXBlc1wiKTtcbnJlcXVpcmUoXCIuLi9jb21tb24vZXh0ZW5zaW9uc1wiKTtcbmNvbnN0IHR5cGVzXzMgPSByZXF1aXJlKFwiLi4vY29tbW9uL3R5cGVzXCIpO1xuY29uc3QgbG9jYWxpemUgPSByZXF1aXJlKFwiLi4vY29tbW9uL3V0aWxzL2xvY2FsaXplXCIpO1xuY29uc3QgcmFuZG9tXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL3V0aWxzL3JhbmRvbVwiKTtcbi8vIHBlcnNpc3RlbnQgc3RhdGUgbmFtZXMsIGV4cG9ydGVkIHRvIG1ha2UgdXNlIG9mIGluIHRlc3RpbmdcbnZhciBMU1N1cnZleVN0YXRlS2V5cztcbihmdW5jdGlvbiAoTFNTdXJ2ZXlTdGF0ZUtleXMpIHtcbiAgICBMU1N1cnZleVN0YXRlS2V5c1tcIlNob3dCYW5uZXJcIl0gPSBcIlNob3dMU1N1cnZleUJhbm5lclwiO1xuICAgIExTU3VydmV5U3RhdGVLZXlzW1wiU2hvd0F0dGVtcHRDb3VudGVyXCJdID0gXCJMU1N1cnZleVNob3dBdHRlbXB0XCI7XG4gICAgTFNTdXJ2ZXlTdGF0ZUtleXNbXCJTaG93QWZ0ZXJDb21wbGV0aW9uQ291bnRcIl0gPSBcIkxTU3VydmV5U2hvd0NvdW50XCI7XG59KShMU1N1cnZleVN0YXRlS2V5cyA9IGV4cG9ydHMuTFNTdXJ2ZXlTdGF0ZUtleXMgfHwgKGV4cG9ydHMuTFNTdXJ2ZXlTdGF0ZUtleXMgPSB7fSkpO1xudmFyIExTU3VydmV5TGFiZWxJbmRleDtcbihmdW5jdGlvbiAoTFNTdXJ2ZXlMYWJlbEluZGV4KSB7XG4gICAgTFNTdXJ2ZXlMYWJlbEluZGV4W0xTU3VydmV5TGFiZWxJbmRleFtcIlllc1wiXSA9IDBdID0gXCJZZXNcIjtcbiAgICBMU1N1cnZleUxhYmVsSW5kZXhbTFNTdXJ2ZXlMYWJlbEluZGV4W1wiTm9cIl0gPSAxXSA9IFwiTm9cIjtcbn0pKExTU3VydmV5TGFiZWxJbmRleCB8fCAoTFNTdXJ2ZXlMYWJlbEluZGV4ID0ge30pKTtcbi8qXG5UaGlzIGNsYXNzIHJlcHJlc2VudHMgYSBwb3B1cCB0aGF0IHdpbGwgYXNrIG91ciB1c2VycyBmb3Igc29tZSBmZWVkYmFjayBhZnRlclxuYSBzcGVjaWZpYyBldmVudCBvY2N1cnMgTiB0aW1lcy5cbiovXG5sZXQgTGFuZ3VhZ2VTZXJ2ZXJTdXJ2ZXlCYW5uZXIgPSBjbGFzcyBMYW5ndWFnZVNlcnZlclN1cnZleUJhbm5lciB7XG4gICAgY29uc3RydWN0b3IoYXBwU2hlbGwsIHBlcnNpc3RlbnRTdGF0ZSwgYnJvd3NlclNlcnZpY2UsIGxzU2VydmljZSwgc2hvd0FmdGVyTWluaW11bUV2ZW50c0NvdW50ID0gMTAwLCBzaG93QmVmb3JlTWF4aW11bUV2ZW50c0NvdW50ID0gNTAwKSB7XG4gICAgICAgIHRoaXMuYXBwU2hlbGwgPSBhcHBTaGVsbDtcbiAgICAgICAgdGhpcy5wZXJzaXN0ZW50U3RhdGUgPSBwZXJzaXN0ZW50U3RhdGU7XG4gICAgICAgIHRoaXMuYnJvd3NlclNlcnZpY2UgPSBicm93c2VyU2VydmljZTtcbiAgICAgICAgdGhpcy5sc1NlcnZpY2UgPSBsc1NlcnZpY2U7XG4gICAgICAgIHRoaXMuZGlzYWJsZWRJbkN1cnJlbnRTZXNzaW9uID0gZmFsc2U7XG4gICAgICAgIHRoaXMuaXNJbml0aWFsaXplZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmJhbm5lck1lc3NhZ2UgPSBsb2NhbGl6ZS5MYW5ndWFnZVNlcnZpY2VTdXJ2ZXlCYW5uZXIuYmFubmVyTWVzc2FnZSgpO1xuICAgICAgICB0aGlzLmJhbm5lckxhYmVscyA9IFtsb2NhbGl6ZS5MYW5ndWFnZVNlcnZpY2VTdXJ2ZXlCYW5uZXIuYmFubmVyTGFiZWxZZXMoKSwgbG9jYWxpemUuTGFuZ3VhZ2VTZXJ2aWNlU3VydmV5QmFubmVyLmJhbm5lckxhYmVsTm8oKV07XG4gICAgICAgIHRoaXMubWluQ29tcGxldGlvbnNCZWZvcmVTaG93ID0gc2hvd0FmdGVyTWluaW11bUV2ZW50c0NvdW50O1xuICAgICAgICB0aGlzLm1heENvbXBsZXRpb25zQmVmb3JlU2hvdyA9IHNob3dCZWZvcmVNYXhpbXVtRXZlbnRzQ291bnQ7XG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpO1xuICAgIH1cbiAgICBpbml0aWFsaXplKCkge1xuICAgICAgICBpZiAodGhpcy5pc0luaXRpYWxpemVkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5pc0luaXRpYWxpemVkID0gdHJ1ZTtcbiAgICAgICAgaWYgKHRoaXMubWluQ29tcGxldGlvbnNCZWZvcmVTaG93ID49IHRoaXMubWF4Q29tcGxldGlvbnNCZWZvcmVTaG93KSB7XG4gICAgICAgICAgICB0aGlzLmRpc2FibGUoKS5pZ25vcmVFcnJvcnMoKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBnZXQgb3B0aW9uTGFiZWxzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5iYW5uZXJMYWJlbHM7XG4gICAgfVxuICAgIGdldCBzaG93bkNvdW50KCkge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRQeXRob25MU0xhdW5jaENvdW50ZXIoKTtcbiAgICB9XG4gICAgZ2V0IGVuYWJsZWQoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnBlcnNpc3RlbnRTdGF0ZS5jcmVhdGVHbG9iYWxQZXJzaXN0ZW50U3RhdGUoTFNTdXJ2ZXlTdGF0ZUtleXMuU2hvd0Jhbm5lciwgdHJ1ZSkudmFsdWU7XG4gICAgfVxuICAgIHNob3dCYW5uZXIoKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZCB8fCB0aGlzLmRpc2FibGVkSW5DdXJyZW50U2Vzc2lvbikge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGxhdW5jaENvdW50ZXIgPSB5aWVsZCB0aGlzLmluY3JlbWVudFB5dGhvbkxhbmd1YWdlU2VydmljZUxhdW5jaENvdW50ZXIoKTtcbiAgICAgICAgICAgIGNvbnN0IHNob3cgPSB5aWVsZCB0aGlzLnNob3VsZFNob3dCYW5uZXIobGF1bmNoQ291bnRlcik7XG4gICAgICAgICAgICBpZiAoIXNob3cpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IHlpZWxkIHRoaXMuYXBwU2hlbGwuc2hvd0luZm9ybWF0aW9uTWVzc2FnZSh0aGlzLmJhbm5lck1lc3NhZ2UsIC4uLnRoaXMuYmFubmVyTGFiZWxzKTtcbiAgICAgICAgICAgIHN3aXRjaCAocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICBjYXNlIHRoaXMuYmFubmVyTGFiZWxzW0xTU3VydmV5TGFiZWxJbmRleC5ZZXNdOlxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmxhdW5jaFN1cnZleSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy5kaXNhYmxlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNhc2UgdGhpcy5iYW5uZXJMYWJlbHNbTFNTdXJ2ZXlMYWJlbEluZGV4Lk5vXToge1xuICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmRpc2FibGUoKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHtcbiAgICAgICAgICAgICAgICAgICAgLy8gRGlzYWJsZSBmb3IgdGhlIGN1cnJlbnQgc2Vzc2lvbi5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kaXNhYmxlZEluQ3VycmVudFNlc3Npb24gPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHNob3VsZFNob3dCYW5uZXIobGF1bmNoQ291bnRlcikge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWQgfHwgdGhpcy5kaXNhYmxlZEluQ3VycmVudFNlc3Npb24pIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIWxhdW5jaENvdW50ZXIpIHtcbiAgICAgICAgICAgICAgICBsYXVuY2hDb3VudGVyID0geWllbGQgdGhpcy5nZXRQeXRob25MU0xhdW5jaENvdW50ZXIoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHRocmVzaG9sZCA9IHlpZWxkIHRoaXMuZ2V0UHl0aG9uTFNMYXVuY2hUaHJlc2hvbGRDb3VudGVyKCk7XG4gICAgICAgICAgICByZXR1cm4gbGF1bmNoQ291bnRlciA+PSB0aHJlc2hvbGQ7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBkaXNhYmxlKCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgeWllbGQgdGhpcy5wZXJzaXN0ZW50U3RhdGUuY3JlYXRlR2xvYmFsUGVyc2lzdGVudFN0YXRlKExTU3VydmV5U3RhdGVLZXlzLlNob3dCYW5uZXIsIGZhbHNlKS51cGRhdGVWYWx1ZShmYWxzZSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBsYXVuY2hTdXJ2ZXkoKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBsYXVuY2hDb3VudGVyID0geWllbGQgdGhpcy5nZXRQeXRob25MU0xhdW5jaENvdW50ZXIoKTtcbiAgICAgICAgICAgIGxldCBsc1ZlcnNpb24gPSB5aWVsZCB0aGlzLmdldFB5dGhvbkxTVmVyc2lvbigpO1xuICAgICAgICAgICAgbHNWZXJzaW9uID0gZW5jb2RlVVJJQ29tcG9uZW50KGxzVmVyc2lvbik7XG4gICAgICAgICAgICB0aGlzLmJyb3dzZXJTZXJ2aWNlLmxhdW5jaChgaHR0cHM6Ly93d3cucmVzZWFyY2gubmV0L3IvTEpaVjlCWj9uPSR7bGF1bmNoQ291bnRlcn0mdj0ke2xzVmVyc2lvbn1gKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGluY3JlbWVudFB5dGhvbkxhbmd1YWdlU2VydmljZUxhdW5jaENvdW50ZXIoKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBzdGF0ZSA9IHRoaXMucGVyc2lzdGVudFN0YXRlLmNyZWF0ZUdsb2JhbFBlcnNpc3RlbnRTdGF0ZShMU1N1cnZleVN0YXRlS2V5cy5TaG93QXR0ZW1wdENvdW50ZXIsIDApO1xuICAgICAgICAgICAgeWllbGQgc3RhdGUudXBkYXRlVmFsdWUoc3RhdGUudmFsdWUgKyAxKTtcbiAgICAgICAgICAgIHJldHVybiBzdGF0ZS52YWx1ZTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGdldFB5dGhvbkxTVmVyc2lvbihmYWxsYmFjayA9ICd1bmtub3duJykge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgbGFuZ1NlcnZpY2VMYXRlc3RGb2xkZXIgPSB5aWVsZCB0aGlzLmxzU2VydmljZS5nZXRDdXJyZW50TGFuZ3VhZ2VTZXJ2ZXJEaXJlY3RvcnkoKTtcbiAgICAgICAgICAgIHJldHVybiBsYW5nU2VydmljZUxhdGVzdEZvbGRlciA/IGxhbmdTZXJ2aWNlTGF0ZXN0Rm9sZGVyLnZlcnNpb24ucmF3IDogZmFsbGJhY2s7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBnZXRQeXRob25MU0xhdW5jaENvdW50ZXIoKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBzdGF0ZSA9IHRoaXMucGVyc2lzdGVudFN0YXRlLmNyZWF0ZUdsb2JhbFBlcnNpc3RlbnRTdGF0ZShMU1N1cnZleVN0YXRlS2V5cy5TaG93QXR0ZW1wdENvdW50ZXIsIDApO1xuICAgICAgICAgICAgcmV0dXJuIHN0YXRlLnZhbHVlO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgZ2V0UHl0aG9uTFNMYXVuY2hUaHJlc2hvbGRDb3VudGVyKCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3Qgc3RhdGUgPSB0aGlzLnBlcnNpc3RlbnRTdGF0ZS5jcmVhdGVHbG9iYWxQZXJzaXN0ZW50U3RhdGUoTFNTdXJ2ZXlTdGF0ZUtleXMuU2hvd0FmdGVyQ29tcGxldGlvbkNvdW50LCB1bmRlZmluZWQpO1xuICAgICAgICAgICAgaWYgKHN0YXRlLnZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICB5aWVsZCBzdGF0ZS51cGRhdGVWYWx1ZShyYW5kb21fMS5nZXRSYW5kb21CZXR3ZWVuKHRoaXMubWluQ29tcGxldGlvbnNCZWZvcmVTaG93LCB0aGlzLm1heENvbXBsZXRpb25zQmVmb3JlU2hvdykpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHN0YXRlLnZhbHVlO1xuICAgICAgICB9KTtcbiAgICB9XG59O1xuTGFuZ3VhZ2VTZXJ2ZXJTdXJ2ZXlCYW5uZXIgPSBfX2RlY29yYXRlKFtcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKCksXG4gICAgX19wYXJhbSgwLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMi5JQXBwbGljYXRpb25TaGVsbCkpLFxuICAgIF9fcGFyYW0oMSwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzMuSVBlcnNpc3RlbnRTdGF0ZUZhY3RvcnkpKSxcbiAgICBfX3BhcmFtKDIsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18zLklCcm93c2VyU2VydmljZSkpLFxuICAgIF9fcGFyYW0oMywgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzEuSUxhbmd1YWdlU2VydmVyRm9sZGVyU2VydmljZSkpXG5dLCBMYW5ndWFnZVNlcnZlclN1cnZleUJhbm5lcik7XG5leHBvcnRzLkxhbmd1YWdlU2VydmVyU3VydmV5QmFubmVyID0gTGFuZ3VhZ2VTZXJ2ZXJTdXJ2ZXlCYW5uZXI7XG4vLyMgc291cmNlTWFwcGluZ1VSTD1sYW5ndWFnZVNlcnZlclN1cnZleUJhbm5lci5qcy5tYXAiXX0=