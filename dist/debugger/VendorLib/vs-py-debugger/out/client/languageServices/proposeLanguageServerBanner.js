// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const vscode_1 = require("vscode");

const types_1 = require("../common/application/types");

require("../common/extensions");

const types_2 = require("../common/types");

const random_1 = require("../common/utils/random"); // persistent state names, exported to make use of in testing


var ProposeLSStateKeys;

(function (ProposeLSStateKeys) {
  ProposeLSStateKeys["ShowBanner"] = "ProposeLSBanner";
})(ProposeLSStateKeys = exports.ProposeLSStateKeys || (exports.ProposeLSStateKeys = {}));

var ProposeLSLabelIndex;

(function (ProposeLSLabelIndex) {
  ProposeLSLabelIndex[ProposeLSLabelIndex["Yes"] = 0] = "Yes";
  ProposeLSLabelIndex[ProposeLSLabelIndex["No"] = 1] = "No";
  ProposeLSLabelIndex[ProposeLSLabelIndex["Later"] = 2] = "Later";
})(ProposeLSLabelIndex || (ProposeLSLabelIndex = {}));
/*
This class represents a popup that propose that the user try out a new
feature of the extension, and optionally enable that new feature if they
choose to do so. It is meant to be shown only to a subset of our users,
and will show as soon as it is instructed to do so, if a random sample
function enables the popup for this user.
*/


let ProposeLanguageServerBanner = class ProposeLanguageServerBanner {
  constructor(appShell, persistentState, configuration, sampleSizePerOneHundredUsers = 10) {
    this.appShell = appShell;
    this.persistentState = persistentState;
    this.configuration = configuration;
    this.disabledInCurrentSession = false;
    this.bannerMessage = 'Try out Preview of our new Python Language Server to get richer and faster IntelliSense completions, and syntax errors as you type.';
    this.bannerLabels = ['Try it now', 'No thanks', 'Remind me Later'];
    this.sampleSizePerHundred = sampleSizePerOneHundredUsers;
    this.initialize();
  }

  initialize() {
    if (this.initialized) {
      return;
    }

    this.initialized = true; // Don't even bother adding handlers if banner has been turned off.

    if (!this.enabled) {
      return;
    } // we only want 10% of folks that use Jedi to see this survey.


    const randomSample = random_1.getRandomBetween(0, 100);

    if (randomSample >= this.sampleSizePerHundred) {
      this.disable().ignoreErrors();
      return;
    }
  }

  get shownCount() {
    return Promise.resolve(-1); // we don't count this popup banner!
  }

  get optionLabels() {
    return this.bannerLabels;
  }

  get enabled() {
    return this.persistentState.createGlobalPersistentState(ProposeLSStateKeys.ShowBanner, true).value;
  }

  showBanner() {
    return __awaiter(this, void 0, void 0, function* () {
      if (!this.enabled) {
        return;
      }

      const show = yield this.shouldShowBanner();

      if (!show) {
        return;
      }

      const response = yield this.appShell.showInformationMessage(this.bannerMessage, ...this.bannerLabels);

      switch (response) {
        case this.bannerLabels[ProposeLSLabelIndex.Yes]:
          {
            yield this.enableNewLanguageServer();
            yield this.disable();
            break;
          }

        case this.bannerLabels[ProposeLSLabelIndex.No]:
          {
            yield this.disable();
            break;
          }

        case this.bannerLabels[ProposeLSLabelIndex.Later]:
          {
            this.disabledInCurrentSession = true;
            break;
          }

        default:
          {
            // Disable for the current session.
            this.disabledInCurrentSession = true;
          }
      }
    });
  }

  shouldShowBanner() {
    return __awaiter(this, void 0, void 0, function* () {
      return Promise.resolve(this.enabled && !this.disabledInCurrentSession);
    });
  }

  disable() {
    return __awaiter(this, void 0, void 0, function* () {
      yield this.persistentState.createGlobalPersistentState(ProposeLSStateKeys.ShowBanner, false).updateValue(false);
    });
  }

  enableNewLanguageServer() {
    return __awaiter(this, void 0, void 0, function* () {
      yield this.configuration.updateSetting('jediEnabled', false, undefined, vscode_1.ConfigurationTarget.Global);
    });
  }

};
ProposeLanguageServerBanner = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_1.IApplicationShell)), __param(1, inversify_1.inject(types_2.IPersistentStateFactory)), __param(2, inversify_1.inject(types_2.IConfigurationService))], ProposeLanguageServerBanner);
exports.ProposeLanguageServerBanner = ProposeLanguageServerBanner;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByb3Bvc2VMYW5ndWFnZVNlcnZlckJhbm5lci5qcyJdLCJuYW1lcyI6WyJfX2RlY29yYXRlIiwiZGVjb3JhdG9ycyIsInRhcmdldCIsImtleSIsImRlc2MiLCJjIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImQiLCJSZWZsZWN0IiwiZGVjb3JhdGUiLCJpIiwiZGVmaW5lUHJvcGVydHkiLCJfX3BhcmFtIiwicGFyYW1JbmRleCIsImRlY29yYXRvciIsIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJleHBvcnRzIiwiaW52ZXJzaWZ5XzEiLCJyZXF1aXJlIiwidnNjb2RlXzEiLCJ0eXBlc18xIiwidHlwZXNfMiIsInJhbmRvbV8xIiwiUHJvcG9zZUxTU3RhdGVLZXlzIiwiUHJvcG9zZUxTTGFiZWxJbmRleCIsIlByb3Bvc2VMYW5ndWFnZVNlcnZlckJhbm5lciIsImNvbnN0cnVjdG9yIiwiYXBwU2hlbGwiLCJwZXJzaXN0ZW50U3RhdGUiLCJjb25maWd1cmF0aW9uIiwic2FtcGxlU2l6ZVBlck9uZUh1bmRyZWRVc2VycyIsImRpc2FibGVkSW5DdXJyZW50U2Vzc2lvbiIsImJhbm5lck1lc3NhZ2UiLCJiYW5uZXJMYWJlbHMiLCJzYW1wbGVTaXplUGVySHVuZHJlZCIsImluaXRpYWxpemUiLCJpbml0aWFsaXplZCIsImVuYWJsZWQiLCJyYW5kb21TYW1wbGUiLCJnZXRSYW5kb21CZXR3ZWVuIiwiZGlzYWJsZSIsImlnbm9yZUVycm9ycyIsInNob3duQ291bnQiLCJvcHRpb25MYWJlbHMiLCJjcmVhdGVHbG9iYWxQZXJzaXN0ZW50U3RhdGUiLCJTaG93QmFubmVyIiwic2hvd0Jhbm5lciIsInNob3ciLCJzaG91bGRTaG93QmFubmVyIiwicmVzcG9uc2UiLCJzaG93SW5mb3JtYXRpb25NZXNzYWdlIiwiWWVzIiwiZW5hYmxlTmV3TGFuZ3VhZ2VTZXJ2ZXIiLCJObyIsIkxhdGVyIiwidXBkYXRlVmFsdWUiLCJ1cGRhdGVTZXR0aW5nIiwidW5kZWZpbmVkIiwiQ29uZmlndXJhdGlvblRhcmdldCIsIkdsb2JhbCIsImluamVjdGFibGUiLCJpbmplY3QiLCJJQXBwbGljYXRpb25TaGVsbCIsIklQZXJzaXN0ZW50U3RhdGVGYWN0b3J5IiwiSUNvbmZpZ3VyYXRpb25TZXJ2aWNlIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsVUFBVSxHQUFJLFVBQVEsU0FBS0EsVUFBZCxJQUE2QixVQUFVQyxVQUFWLEVBQXNCQyxNQUF0QixFQUE4QkMsR0FBOUIsRUFBbUNDLElBQW5DLEVBQXlDO0FBQ25GLE1BQUlDLENBQUMsR0FBR0MsU0FBUyxDQUFDQyxNQUFsQjtBQUFBLE1BQTBCQyxDQUFDLEdBQUdILENBQUMsR0FBRyxDQUFKLEdBQVFILE1BQVIsR0FBaUJFLElBQUksS0FBSyxJQUFULEdBQWdCQSxJQUFJLEdBQUdLLE1BQU0sQ0FBQ0Msd0JBQVAsQ0FBZ0NSLE1BQWhDLEVBQXdDQyxHQUF4QyxDQUF2QixHQUFzRUMsSUFBckg7QUFBQSxNQUEySE8sQ0FBM0g7QUFDQSxNQUFJLE9BQU9DLE9BQVAsS0FBbUIsUUFBbkIsSUFBK0IsT0FBT0EsT0FBTyxDQUFDQyxRQUFmLEtBQTRCLFVBQS9ELEVBQTJFTCxDQUFDLEdBQUdJLE9BQU8sQ0FBQ0MsUUFBUixDQUFpQlosVUFBakIsRUFBNkJDLE1BQTdCLEVBQXFDQyxHQUFyQyxFQUEwQ0MsSUFBMUMsQ0FBSixDQUEzRSxLQUNLLEtBQUssSUFBSVUsQ0FBQyxHQUFHYixVQUFVLENBQUNNLE1BQVgsR0FBb0IsQ0FBakMsRUFBb0NPLENBQUMsSUFBSSxDQUF6QyxFQUE0Q0EsQ0FBQyxFQUE3QyxFQUFp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Q0FBaEI7QUFHSDs7QUFDREgsRUFBQUEsdUJBQXVCLEdBQUc7QUFDdEIsV0FBT3RELFNBQVMsQ0FBQyxJQUFELEVBQU8sS0FBSyxDQUFaLEVBQWUsS0FBSyxDQUFwQixFQUF1QixhQUFhO0FBQ2hELFlBQU0sS0FBSytCLGFBQUwsQ0FBbUIyQixhQUFuQixDQUFpQyxhQUFqQyxFQUFnRCxLQUFoRCxFQUF1REMsU0FBdkQsRUFBa0V0QyxRQUFRLENBQUN1QyxtQkFBVCxDQUE2QkMsTUFBL0YsQ0FBTjtBQUNILEtBRmUsQ0FBaEI7QUFHSDs7QUFqRitELENBQXBFO0FBbUZBbEMsMkJBQTJCLEdBQUc5QyxVQUFVLENBQUMsQ0FDckNzQyxXQUFXLENBQUMyQyxVQUFaLEVBRHFDLEVBRXJDakUsT0FBTyxDQUFDLENBQUQsRUFBSXNCLFdBQVcsQ0FBQzRDLE1BQVosQ0FBbUJ6QyxPQUFPLENBQUMwQyxpQkFBM0IsQ0FBSixDQUY4QixFQUdyQ25FLE9BQU8sQ0FBQyxDQUFELEVBQUlzQixXQUFXLENBQUM0QyxNQUFaLENBQW1CeEMsT0FBTyxDQUFDMEMsdUJBQTNCLENBQUosQ0FIOEIsRUFJckNwRSxPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDNEMsTUFBWixDQUFtQnhDLE9BQU8sQ0FBQzJDLHFCQUEzQixDQUFKLENBSjhCLENBQUQsRUFLckN2QywyQkFMcUMsQ0FBeEM7QUFNQVQsT0FBTyxDQUFDUywyQkFBUixHQUFzQ0EsMkJBQXRDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXG4ndXNlIHN0cmljdCc7XG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XG4gICAgdmFyIGMgPSBhcmd1bWVudHMubGVuZ3RoLCByID0gYyA8IDMgPyB0YXJnZXQgOiBkZXNjID09PSBudWxsID8gZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpIDogZGVzYywgZDtcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XG4gICAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjtcbn07XG52YXIgX19wYXJhbSA9ICh0aGlzICYmIHRoaXMuX19wYXJhbSkgfHwgZnVuY3Rpb24gKHBhcmFtSW5kZXgsIGRlY29yYXRvcikge1xuICAgIHJldHVybiBmdW5jdGlvbiAodGFyZ2V0LCBrZXkpIHsgZGVjb3JhdG9yKHRhcmdldCwga2V5LCBwYXJhbUluZGV4KTsgfVxufTtcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XG4gICAgfSk7XG59O1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuY29uc3QgaW52ZXJzaWZ5XzEgPSByZXF1aXJlKFwiaW52ZXJzaWZ5XCIpO1xuY29uc3QgdnNjb2RlXzEgPSByZXF1aXJlKFwidnNjb2RlXCIpO1xuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vYXBwbGljYXRpb24vdHlwZXNcIik7XG5yZXF1aXJlKFwiLi4vY29tbW9uL2V4dGVuc2lvbnNcIik7XG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uL2NvbW1vbi90eXBlc1wiKTtcbmNvbnN0IHJhbmRvbV8xID0gcmVxdWlyZShcIi4uL2NvbW1vbi91dGlscy9yYW5kb21cIik7XG4vLyBwZXJzaXN0ZW50IHN0YXRlIG5hbWVzLCBleHBvcnRlZCB0byBtYWtlIHVzZSBvZiBpbiB0ZXN0aW5nXG52YXIgUHJvcG9zZUxTU3RhdGVLZXlzO1xuKGZ1bmN0aW9uIChQcm9wb3NlTFNTdGF0ZUtleXMpIHtcbiAgICBQcm9wb3NlTFNTdGF0ZUtleXNbXCJTaG93QmFubmVyXCJdID0gXCJQcm9wb3NlTFNCYW5uZXJcIjtcbn0pKFByb3Bvc2VMU1N0YXRlS2V5cyA9IGV4cG9ydHMuUHJvcG9zZUxTU3RhdGVLZXlzIHx8IChleHBvcnRzLlByb3Bvc2VMU1N0YXRlS2V5cyA9IHt9KSk7XG52YXIgUHJvcG9zZUxTTGFiZWxJbmRleDtcbihmdW5jdGlvbiAoUHJvcG9zZUxTTGFiZWxJbmRleCkge1xuICAgIFByb3Bvc2VMU0xhYmVsSW5kZXhbUHJvcG9zZUxTTGFiZWxJbmRleFtcIlllc1wiXSA9IDBdID0gXCJZZXNcIjtcbiAgICBQcm9wb3NlTFNMYWJlbEluZGV4W1Byb3Bvc2VMU0xhYmVsSW5kZXhbXCJOb1wiXSA9IDFdID0gXCJOb1wiO1xuICAgIFByb3Bvc2VMU0xhYmVsSW5kZXhbUHJvcG9zZUxTTGFiZWxJbmRleFtcIkxhdGVyXCJdID0gMl0gPSBcIkxhdGVyXCI7XG59KShQcm9wb3NlTFNMYWJlbEluZGV4IHx8IChQcm9wb3NlTFNMYWJlbEluZGV4ID0ge30pKTtcbi8qXG5UaGlzIGNsYXNzIHJlcHJlc2VudHMgYSBwb3B1cCB0aGF0IHByb3Bvc2UgdGhhdCB0aGUgdXNlciB0cnkgb3V0IGEgbmV3XG5mZWF0dXJlIG9mIHRoZSBleHRlbnNpb24sIGFuZCBvcHRpb25hbGx5IGVuYWJsZSB0aGF0IG5ldyBmZWF0dXJlIGlmIHRoZXlcbmNob29zZSB0byBkbyBzby4gSXQgaXMgbWVhbnQgdG8gYmUgc2hvd24gb25seSB0byBhIHN1YnNldCBvZiBvdXIgdXNlcnMsXG5hbmQgd2lsbCBzaG93IGFzIHNvb24gYXMgaXQgaXMgaW5zdHJ1Y3RlZCB0byBkbyBzbywgaWYgYSByYW5kb20gc2FtcGxlXG5mdW5jdGlvbiBlbmFibGVzIHRoZSBwb3B1cCBmb3IgdGhpcyB1c2VyLlxuKi9cbmxldCBQcm9wb3NlTGFuZ3VhZ2VTZXJ2ZXJCYW5uZXIgPSBjbGFzcyBQcm9wb3NlTGFuZ3VhZ2VTZXJ2ZXJCYW5uZXIge1xuICAgIGNvbnN0cnVjdG9yKGFwcFNoZWxsLCBwZXJzaXN0ZW50U3RhdGUsIGNvbmZpZ3VyYXRpb24sIHNhbXBsZVNpemVQZXJPbmVIdW5kcmVkVXNlcnMgPSAxMCkge1xuICAgICAgICB0aGlzLmFwcFNoZWxsID0gYXBwU2hlbGw7XG4gICAgICAgIHRoaXMucGVyc2lzdGVudFN0YXRlID0gcGVyc2lzdGVudFN0YXRlO1xuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24gPSBjb25maWd1cmF0aW9uO1xuICAgICAgICB0aGlzLmRpc2FibGVkSW5DdXJyZW50U2Vzc2lvbiA9IGZhbHNlO1xuICAgICAgICB0aGlzLmJhbm5lck1lc3NhZ2UgPSAnVHJ5IG91dCBQcmV2aWV3IG9mIG91ciBuZXcgUHl0aG9uIExhbmd1YWdlIFNlcnZlciB0byBnZXQgcmljaGVyIGFuZCBmYXN0ZXIgSW50ZWxsaVNlbnNlIGNvbXBsZXRpb25zLCBhbmQgc3ludGF4IGVycm9ycyBhcyB5b3UgdHlwZS4nO1xuICAgICAgICB0aGlzLmJhbm5lckxhYmVscyA9IFsnVHJ5IGl0IG5vdycsICdObyB0aGFua3MnLCAnUmVtaW5kIG1lIExhdGVyJ107XG4gICAgICAgIHRoaXMuc2FtcGxlU2l6ZVBlckh1bmRyZWQgPSBzYW1wbGVTaXplUGVyT25lSHVuZHJlZFVzZXJzO1xuICAgICAgICB0aGlzLmluaXRpYWxpemUoKTtcbiAgICB9XG4gICAgaW5pdGlhbGl6ZSgpIHtcbiAgICAgICAgaWYgKHRoaXMuaW5pdGlhbGl6ZWQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmluaXRpYWxpemVkID0gdHJ1ZTtcbiAgICAgICAgLy8gRG9uJ3QgZXZlbiBib3RoZXIgYWRkaW5nIGhhbmRsZXJzIGlmIGJhbm5lciBoYXMgYmVlbiB0dXJuZWQgb2ZmLlxuICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIC8vIHdlIG9ubHkgd2FudCAxMCUgb2YgZm9sa3MgdGhhdCB1c2UgSmVkaSB0byBzZWUgdGhpcyBzdXJ2ZXkuXG4gICAgICAgIGNvbnN0IHJhbmRvbVNhbXBsZSA9IHJhbmRvbV8xLmdldFJhbmRvbUJldHdlZW4oMCwgMTAwKTtcbiAgICAgICAgaWYgKHJhbmRvbVNhbXBsZSA+PSB0aGlzLnNhbXBsZVNpemVQZXJIdW5kcmVkKSB7XG4gICAgICAgICAgICB0aGlzLmRpc2FibGUoKS5pZ25vcmVFcnJvcnMoKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgIH1cbiAgICBnZXQgc2hvd25Db3VudCgpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgtMSk7IC8vIHdlIGRvbid0IGNvdW50IHRoaXMgcG9wdXAgYmFubmVyIVxuICAgIH1cbiAgICBnZXQgb3B0aW9uTGFiZWxzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5iYW5uZXJMYWJlbHM7XG4gICAgfVxuICAgIGdldCBlbmFibGVkKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5wZXJzaXN0ZW50U3RhdGUuY3JlYXRlR2xvYmFsUGVyc2lzdGVudFN0YXRlKFByb3Bvc2VMU1N0YXRlS2V5cy5TaG93QmFubmVyLCB0cnVlKS52YWx1ZTtcbiAgICB9XG4gICAgc2hvd0Jhbm5lcigpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5lbmFibGVkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3Qgc2hvdyA9IHlpZWxkIHRoaXMuc2hvdWxkU2hvd0Jhbm5lcigpO1xuICAgICAgICAgICAgaWYgKCFzaG93KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSB5aWVsZCB0aGlzLmFwcFNoZWxsLnNob3dJbmZvcm1hdGlvbk1lc3NhZ2UodGhpcy5iYW5uZXJNZXNzYWdlLCAuLi50aGlzLmJhbm5lckxhYmVscyk7XG4gICAgICAgICAgICBzd2l0Y2ggKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgY2FzZSB0aGlzLmJhbm5lckxhYmVsc1tQcm9wb3NlTFNMYWJlbEluZGV4Llllc106IHtcbiAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy5lbmFibGVOZXdMYW5ndWFnZVNlcnZlcigpO1xuICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmRpc2FibGUoKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNhc2UgdGhpcy5iYW5uZXJMYWJlbHNbUHJvcG9zZUxTTGFiZWxJbmRleC5Ob106IHtcbiAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy5kaXNhYmxlKCk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjYXNlIHRoaXMuYmFubmVyTGFiZWxzW1Byb3Bvc2VMU0xhYmVsSW5kZXguTGF0ZXJdOiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGlzYWJsZWRJbkN1cnJlbnRTZXNzaW9uID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHtcbiAgICAgICAgICAgICAgICAgICAgLy8gRGlzYWJsZSBmb3IgdGhlIGN1cnJlbnQgc2Vzc2lvbi5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kaXNhYmxlZEluQ3VycmVudFNlc3Npb24gPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHNob3VsZFNob3dCYW5uZXIoKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMuZW5hYmxlZCAmJiAhdGhpcy5kaXNhYmxlZEluQ3VycmVudFNlc3Npb24pO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgZGlzYWJsZSgpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIHlpZWxkIHRoaXMucGVyc2lzdGVudFN0YXRlLmNyZWF0ZUdsb2JhbFBlcnNpc3RlbnRTdGF0ZShQcm9wb3NlTFNTdGF0ZUtleXMuU2hvd0Jhbm5lciwgZmFsc2UpLnVwZGF0ZVZhbHVlKGZhbHNlKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGVuYWJsZU5ld0xhbmd1YWdlU2VydmVyKCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgeWllbGQgdGhpcy5jb25maWd1cmF0aW9uLnVwZGF0ZVNldHRpbmcoJ2plZGlFbmFibGVkJywgZmFsc2UsIHVuZGVmaW5lZCwgdnNjb2RlXzEuQ29uZmlndXJhdGlvblRhcmdldC5HbG9iYWwpO1xuICAgICAgICB9KTtcbiAgICB9XG59O1xuUHJvcG9zZUxhbmd1YWdlU2VydmVyQmFubmVyID0gX19kZWNvcmF0ZShbXG4gICAgaW52ZXJzaWZ5XzEuaW5qZWN0YWJsZSgpLFxuICAgIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzEuSUFwcGxpY2F0aW9uU2hlbGwpKSxcbiAgICBfX3BhcmFtKDEsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18yLklQZXJzaXN0ZW50U3RhdGVGYWN0b3J5KSksXG4gICAgX19wYXJhbSgyLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMi5JQ29uZmlndXJhdGlvblNlcnZpY2UpKVxuXSwgUHJvcG9zZUxhbmd1YWdlU2VydmVyQmFubmVyKTtcbmV4cG9ydHMuUHJvcG9zZUxhbmd1YWdlU2VydmVyQmFubmVyID0gUHJvcG9zZUxhbmd1YWdlU2VydmVyQmFubmVyO1xuLy8jIHNvdXJjZU1hcHBpbmdVUkw9cHJvcG9zZUxhbmd1YWdlU2VydmVyQmFubmVyLmpzLm1hcCJdfQ==