// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const fs = require("fs-extra");

const inversify_1 = require("inversify");

const types_1 = require("../common/platform/types");

const types_2 = require("../common/process/types");

const types_3 = require("../common/types");

const async_1 = require("../common/utils/async");

const localize = require("../common/utils/localize");

const contracts_1 = require("../interpreter/contracts");

const types_4 = require("./types");

let JupyterImporter = class JupyterImporter {
  constructor(executionFactory, fileSystem, disposableRegistry, interpreterService, jupyterExecution) {
    this.executionFactory = executionFactory;
    this.fileSystem = fileSystem;
    this.disposableRegistry = disposableRegistry;
    this.interpreterService = interpreterService;
    this.jupyterExecution = jupyterExecution;
    this.isDisposed = false; // Template that changes markdown cells to have # %% [markdown] in the comments

    this.nbconvertTemplate = // tslint:disable-next-line:no-multiline-string
    `{%- extends 'null.tpl' -%}
{% block codecell %}
#%%
{{ super() }}
{% endblock codecell %}
{% block in_prompt %}{% endblock in_prompt %}
{% block input %}{{ cell.source | ipython2python }}{% endblock input %}
{% block markdowncell scoped %}#%% [markdown]
{{ cell.source | comment_lines }}
{% endblock markdowncell %}`;

    this.importFromFile = file => __awaiter(this, void 0, void 0, function* () {
      const template = yield this.templatePromise; // Use the jupyter nbconvert functionality to turn the notebook into a python file

      if (yield this.jupyterExecution.isImportSupported()) {
        const result = yield this.jupyterExecution.execModule(['nbconvert', file, '--to', 'python', '--stdout', '--template', template], {
          throwOnStdErr: false,
          encoding: 'utf8'
        });

        if (result.stdout.trim().length === 0) {
          throw result.stderr;
        }

        return result.stdout;
      }

      throw new Error(localize.DataScience.jupyterNbConvertNotSupported());
    });

    this.dispose = () => {
      this.isDisposed = true;
      this.settingsChangedDiposable.dispose();
    };

    this.createTemplateFile = () => __awaiter(this, void 0, void 0, function* () {
      // Create a temp file on disk
      const file = yield this.fileSystem.createTemporaryFile('.tpl'); // Write our template into it

      yield fs.appendFile(file.filePath, this.nbconvertTemplate); // Save this file into our disposables so the temp file goes away

      this.disposableRegistry.push(file); // Now we should have a template that will convert

      return file.filePath;
    });

    this.onSettingsChanged = () => {
      // Recreate our promise for our execution service whenever the settings change
      this.createExecutionServicePromise();
    };

    this.createExecutionServicePromise = () => {
      // Create a deferred promise that resolves when we have an execution service
      this.pythonExecutionService = async_1.createDeferred();
      this.executionFactory.create({}).then(p => {
        if (this.pythonExecutionService) {
          this.pythonExecutionService.resolve(p);
        }
      }).catch(err => {
        if (this.pythonExecutionService) {
          this.pythonExecutionService.reject(err);
        }
      });
    };

    this.settingsChangedDiposable = this.interpreterService.onDidChangeInterpreter(this.onSettingsChanged);
    this.templatePromise = this.createTemplateFile();
    this.createExecutionServicePromise();
  }

};
JupyterImporter = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_2.IPythonExecutionFactory)), __param(1, inversify_1.inject(types_1.IFileSystem)), __param(2, inversify_1.inject(types_3.IDisposableRegistry)), __param(3, inversify_1.inject(contracts_1.IInterpreterService)), __param(4, inversify_1.inject(types_4.IJupyterExecution))], JupyterImporter);
exports.JupyterImporter = JupyterImporter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImp1cHl0ZXJJbXBvcnRlci5qcyJdLCJuYW1lcyI6WyJfX2RlY29yYXRlIiwiZGVjb3JhdG9ycyIsInRhcmdldCIsImtleSIsImRlc2MiLCJjIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImQiLCJSZWZsZWN0IiwiZGVjb3JhdGUiLCJpIiwiZGVmaW5lUHJvcGVydHkiLCJfX3BhcmFtIiwicGFyYW1JbmRleCIsImRlY29yYXRvciIsIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJleHBvcnRzIiwiZnMiLCJyZXF1aXJlIiwiaW52ZXJzaWZ5XzEiLCJ0eXBlc18xIiwidHlwZXNfMiIsInR5cGVzXzMiLCJhc3luY18xIiwibG9jYWxpemUiLCJjb250cmFjdHNfMSIsInR5cGVzXzQiLCJKdXB5dGVySW1wb3J0ZXIiLCJjb25zdHJ1Y3RvciIsImV4ZWN1dGlvbkZhY3RvcnkiLCJmaWxlU3lzdGVtIiwiZGlzcG9zYWJsZVJlZ2lzdHJ5IiwiaW50ZXJwcmV0ZXJTZXJ2aWNlIiwianVweXRlckV4ZWN1dGlvbiIsImlzRGlzcG9zZWQiLCJuYmNvbnZlcnRUZW1wbGF0ZSIsImltcG9ydEZyb21GaWxlIiwiZmlsZSIsInRlbXBsYXRlIiwidGVtcGxhdGVQcm9taXNlIiwiaXNJbXBvcnRTdXBwb3J0ZWQiLCJleGVjTW9kdWxlIiwidGhyb3dPblN0ZEVyciIsImVuY29kaW5nIiwic3Rkb3V0IiwidHJpbSIsInN0ZGVyciIsIkVycm9yIiwiRGF0YVNjaWVuY2UiLCJqdXB5dGVyTmJDb252ZXJ0Tm90U3VwcG9ydGVkIiwiZGlzcG9zZSIsInNldHRpbmdzQ2hhbmdlZERpcG9zYWJsZSIsImNyZWF0ZVRlbXBsYXRlRmlsZSIsImNyZWF0ZVRlbXBvcmFyeUZpbGUiLCJhcHBlbmRGaWxlIiwiZmlsZVBhdGgiLCJwdXNoIiwib25TZXR0aW5nc0NoYW5nZWQiLCJjcmVhdGVFeGVjdXRpb25TZXJ2aWNlUHJvbWlzZSIsInB5dGhvbkV4ZWN1dGlvblNlcnZpY2UiLCJjcmVhdGVEZWZlcnJlZCIsImNyZWF0ZSIsInAiLCJjYXRjaCIsImVyciIsIm9uRGlkQ2hhbmdlSW50ZXJwcmV0ZXIiLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSVB5dGhvbkV4ZWN1dGlvbkZhY3RvcnkiLCJJRmlsZVN5c3RlbSIsIklEaXNwb3NhYmxlUmVnaXN0cnkiLCJJSW50ZXJwcmV0ZXJTZXJ2aWNlIiwiSUp1cHl0ZXJFeGVjdXRpb24iXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEsTUFBMEJDLENBQUMsR0FBR0gsQ0FBQyxHQUFHLENBQUosR0FBUUgsTUFBUixHQUFpQkUsSUFBSSxLQUFLLElBQVQsR0FBZ0JBLElBQUksR0FBR0ssTUFBTSxDQUFDQyx3QkFBUCxDQUFnQ1IsTUFBaEMsRUFBd0NDLEdBQXhDLENBQXZCLEdBQXNFQyxJQUFySDtBQUFBLE1BQTJITyxDQUEzSDtBQUNBLE1BQUksT0FBT0MsT0FBUCxLQUFtQixRQUFuQixJQUErQixPQUFPQSxPQUFPLENBQUNDLFFBQWYsS0FBNEIsVUFBL0QsRUFBMkVMLENBQUMsR0FBR0ksT0FBTyxDQUFDQyxRQUFSLENBQWlCWixVQUFqQixFQUE2QkMsTUFBN0IsRUFBcUNDLEdBQXJDLEVBQTBDQyxJQUExQyxDQUFKLENBQTNFLEtBQ0ssS0FBSyxJQUFJVSxDQUFDLEdBQUdiLFVBQVUsQ0FBQ00s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QUQsRUFBSXdCLFdBQVcsQ0FBQ2dELE1BQVosQ0FBbUIxQyxXQUFXLENBQUM4QyxtQkFBL0IsQ0FBSixDQUxrQixFQU16QjVFLE9BQU8sQ0FBQyxDQUFELEVBQUl3QixXQUFXLENBQUNnRCxNQUFaLENBQW1CekMsT0FBTyxDQUFDOEMsaUJBQTNCLENBQUosQ0FOa0IsQ0FBRCxFQU96QjdDLGVBUHlCLENBQTVCO0FBUUFYLE9BQU8sQ0FBQ1csZUFBUixHQUEwQkEsZUFBMUIiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cbid1c2Ugc3RyaWN0JztcbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xuICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xufTtcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQsIGtleSkgeyBkZWNvcmF0b3IodGFyZ2V0LCBrZXksIHBhcmFtSW5kZXgpOyB9XG59O1xudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcbiAgICB9KTtcbn07XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5jb25zdCBmcyA9IHJlcXVpcmUoXCJmcy1leHRyYVwiKTtcbmNvbnN0IGludmVyc2lmeV8xID0gcmVxdWlyZShcImludmVyc2lmeVwiKTtcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL3BsYXRmb3JtL3R5cGVzXCIpO1xuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi9jb21tb24vcHJvY2Vzcy90eXBlc1wiKTtcbmNvbnN0IHR5cGVzXzMgPSByZXF1aXJlKFwiLi4vY29tbW9uL3R5cGVzXCIpO1xuY29uc3QgYXN5bmNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vdXRpbHMvYXN5bmNcIik7XG5jb25zdCBsb2NhbGl6ZSA9IHJlcXVpcmUoXCIuLi9jb21tb24vdXRpbHMvbG9jYWxpemVcIik7XG5jb25zdCBjb250cmFjdHNfMSA9IHJlcXVpcmUoXCIuLi9pbnRlcnByZXRlci9jb250cmFjdHNcIik7XG5jb25zdCB0eXBlc180ID0gcmVxdWlyZShcIi4vdHlwZXNcIik7XG5sZXQgSnVweXRlckltcG9ydGVyID0gY2xhc3MgSnVweXRlckltcG9ydGVyIHtcbiAgICBjb25zdHJ1Y3RvcihleGVjdXRpb25GYWN0b3J5LCBmaWxlU3lzdGVtLCBkaXNwb3NhYmxlUmVnaXN0cnksIGludGVycHJldGVyU2VydmljZSwganVweXRlckV4ZWN1dGlvbikge1xuICAgICAgICB0aGlzLmV4ZWN1dGlvbkZhY3RvcnkgPSBleGVjdXRpb25GYWN0b3J5O1xuICAgICAgICB0aGlzLmZpbGVTeXN0ZW0gPSBmaWxlU3lzdGVtO1xuICAgICAgICB0aGlzLmRpc3Bvc2FibGVSZWdpc3RyeSA9IGRpc3Bvc2FibGVSZWdpc3RyeTtcbiAgICAgICAgdGhpcy5pbnRlcnByZXRlclNlcnZpY2UgPSBpbnRlcnByZXRlclNlcnZpY2U7XG4gICAgICAgIHRoaXMuanVweXRlckV4ZWN1dGlvbiA9IGp1cHl0ZXJFeGVjdXRpb247XG4gICAgICAgIHRoaXMuaXNEaXNwb3NlZCA9IGZhbHNlO1xuICAgICAgICAvLyBUZW1wbGF0ZSB0aGF0IGNoYW5nZXMgbWFya2Rvd24gY2VsbHMgdG8gaGF2ZSAjICUlIFttYXJrZG93bl0gaW4gdGhlIGNvbW1lbnRzXG4gICAgICAgIHRoaXMubmJjb252ZXJ0VGVtcGxhdGUgPSBcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLW11bHRpbGluZS1zdHJpbmdcbiAgICAgICAgYHslLSBleHRlbmRzICdudWxsLnRwbCcgLSV9XG57JSBibG9jayBjb2RlY2VsbCAlfVxuIyUlXG57eyBzdXBlcigpIH19XG57JSBlbmRibG9jayBjb2RlY2VsbCAlfVxueyUgYmxvY2sgaW5fcHJvbXB0ICV9eyUgZW5kYmxvY2sgaW5fcHJvbXB0ICV9XG57JSBibG9jayBpbnB1dCAlfXt7IGNlbGwuc291cmNlIHwgaXB5dGhvbjJweXRob24gfX17JSBlbmRibG9jayBpbnB1dCAlfVxueyUgYmxvY2sgbWFya2Rvd25jZWxsIHNjb3BlZCAlfSMlJSBbbWFya2Rvd25dXG57eyBjZWxsLnNvdXJjZSB8IGNvbW1lbnRfbGluZXMgfX1cbnslIGVuZGJsb2NrIG1hcmtkb3duY2VsbCAlfWA7XG4gICAgICAgIHRoaXMuaW1wb3J0RnJvbUZpbGUgPSAoZmlsZSkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB5aWVsZCB0aGlzLnRlbXBsYXRlUHJvbWlzZTtcbiAgICAgICAgICAgIC8vIFVzZSB0aGUganVweXRlciBuYmNvbnZlcnQgZnVuY3Rpb25hbGl0eSB0byB0dXJuIHRoZSBub3RlYm9vayBpbnRvIGEgcHl0aG9uIGZpbGVcbiAgICAgICAgICAgIGlmICh5aWVsZCB0aGlzLmp1cHl0ZXJFeGVjdXRpb24uaXNJbXBvcnRTdXBwb3J0ZWQoKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHlpZWxkIHRoaXMuanVweXRlckV4ZWN1dGlvbi5leGVjTW9kdWxlKFsnbmJjb252ZXJ0JywgZmlsZSwgJy0tdG8nLCAncHl0aG9uJywgJy0tc3Rkb3V0JywgJy0tdGVtcGxhdGUnLCB0ZW1wbGF0ZV0sIHsgdGhyb3dPblN0ZEVycjogZmFsc2UsIGVuY29kaW5nOiAndXRmOCcgfSk7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdC5zdGRvdXQudHJpbSgpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyByZXN1bHQuc3RkZXJyO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0LnN0ZG91dDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihsb2NhbGl6ZS5EYXRhU2NpZW5jZS5qdXB5dGVyTmJDb252ZXJ0Tm90U3VwcG9ydGVkKCkpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5kaXNwb3NlID0gKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5pc0Rpc3Bvc2VkID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuc2V0dGluZ3NDaGFuZ2VkRGlwb3NhYmxlLmRpc3Bvc2UoKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5jcmVhdGVUZW1wbGF0ZUZpbGUgPSAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICAvLyBDcmVhdGUgYSB0ZW1wIGZpbGUgb24gZGlza1xuICAgICAgICAgICAgY29uc3QgZmlsZSA9IHlpZWxkIHRoaXMuZmlsZVN5c3RlbS5jcmVhdGVUZW1wb3JhcnlGaWxlKCcudHBsJyk7XG4gICAgICAgICAgICAvLyBXcml0ZSBvdXIgdGVtcGxhdGUgaW50byBpdFxuICAgICAgICAgICAgeWllbGQgZnMuYXBwZW5kRmlsZShmaWxlLmZpbGVQYXRoLCB0aGlzLm5iY29udmVydFRlbXBsYXRlKTtcbiAgICAgICAgICAgIC8vIFNhdmUgdGhpcyBmaWxlIGludG8gb3VyIGRpc3Bvc2FibGVzIHNvIHRoZSB0ZW1wIGZpbGUgZ29lcyBhd2F5XG4gICAgICAgICAgICB0aGlzLmRpc3Bvc2FibGVSZWdpc3RyeS5wdXNoKGZpbGUpO1xuICAgICAgICAgICAgLy8gTm93IHdlIHNob3VsZCBoYXZlIGEgdGVtcGxhdGUgdGhhdCB3aWxsIGNvbnZlcnRcbiAgICAgICAgICAgIHJldHVybiBmaWxlLmZpbGVQYXRoO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5vblNldHRpbmdzQ2hhbmdlZCA9ICgpID0+IHtcbiAgICAgICAgICAgIC8vIFJlY3JlYXRlIG91ciBwcm9taXNlIGZvciBvdXIgZXhlY3V0aW9uIHNlcnZpY2Ugd2hlbmV2ZXIgdGhlIHNldHRpbmdzIGNoYW5nZVxuICAgICAgICAgICAgdGhpcy5jcmVhdGVFeGVjdXRpb25TZXJ2aWNlUHJvbWlzZSgpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLmNyZWF0ZUV4ZWN1dGlvblNlcnZpY2VQcm9taXNlID0gKCkgPT4ge1xuICAgICAgICAgICAgLy8gQ3JlYXRlIGEgZGVmZXJyZWQgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHdoZW4gd2UgaGF2ZSBhbiBleGVjdXRpb24gc2VydmljZVxuICAgICAgICAgICAgdGhpcy5weXRob25FeGVjdXRpb25TZXJ2aWNlID0gYXN5bmNfMS5jcmVhdGVEZWZlcnJlZCgpO1xuICAgICAgICAgICAgdGhpcy5leGVjdXRpb25GYWN0b3J5XG4gICAgICAgICAgICAgICAgLmNyZWF0ZSh7fSlcbiAgICAgICAgICAgICAgICAudGhlbigocCkgPT4geyBpZiAodGhpcy5weXRob25FeGVjdXRpb25TZXJ2aWNlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5weXRob25FeGVjdXRpb25TZXJ2aWNlLnJlc29sdmUocCk7XG4gICAgICAgICAgICB9IH0pXG4gICAgICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB7IGlmICh0aGlzLnB5dGhvbkV4ZWN1dGlvblNlcnZpY2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnB5dGhvbkV4ZWN1dGlvblNlcnZpY2UucmVqZWN0KGVycik7XG4gICAgICAgICAgICB9IH0pO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLnNldHRpbmdzQ2hhbmdlZERpcG9zYWJsZSA9IHRoaXMuaW50ZXJwcmV0ZXJTZXJ2aWNlLm9uRGlkQ2hhbmdlSW50ZXJwcmV0ZXIodGhpcy5vblNldHRpbmdzQ2hhbmdlZCk7XG4gICAgICAgIHRoaXMudGVtcGxhdGVQcm9taXNlID0gdGhpcy5jcmVhdGVUZW1wbGF0ZUZpbGUoKTtcbiAgICAgICAgdGhpcy5jcmVhdGVFeGVjdXRpb25TZXJ2aWNlUHJvbWlzZSgpO1xuICAgIH1cbn07XG5KdXB5dGVySW1wb3J0ZXIgPSBfX2RlY29yYXRlKFtcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKCksXG4gICAgX19wYXJhbSgwLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMi5JUHl0aG9uRXhlY3V0aW9uRmFjdG9yeSkpLFxuICAgIF9fcGFyYW0oMSwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzEuSUZpbGVTeXN0ZW0pKSxcbiAgICBfX3BhcmFtKDIsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18zLklEaXNwb3NhYmxlUmVnaXN0cnkpKSxcbiAgICBfX3BhcmFtKDMsIGludmVyc2lmeV8xLmluamVjdChjb250cmFjdHNfMS5JSW50ZXJwcmV0ZXJTZXJ2aWNlKSksXG4gICAgX19wYXJhbSg0LCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfNC5JSnVweXRlckV4ZWN1dGlvbikpXG5dLCBKdXB5dGVySW1wb3J0ZXIpO1xuZXhwb3J0cy5KdXB5dGVySW1wb3J0ZXIgPSBKdXB5dGVySW1wb3J0ZXI7XG4vLyMgc291cmNlTWFwcGluZ1VSTD1qdXB5dGVySW1wb3J0ZXIuanMubWFwIl19