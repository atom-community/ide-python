// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const types_1 = require("../common/application/types");

require("../common/extensions");

const types_2 = require("../common/types");

const localize = require("../common/utils/localize");

var DSSurveyStateKeys;

(function (DSSurveyStateKeys) {
  DSSurveyStateKeys["ShowBanner"] = "ShowDSSurveyBanner";
  DSSurveyStateKeys["ShowAttemptCounter"] = "DSSurveyShowAttempt";
})(DSSurveyStateKeys = exports.DSSurveyStateKeys || (exports.DSSurveyStateKeys = {}));

var DSSurveyLabelIndex;

(function (DSSurveyLabelIndex) {
  DSSurveyLabelIndex[DSSurveyLabelIndex["Yes"] = 0] = "Yes";
  DSSurveyLabelIndex[DSSurveyLabelIndex["No"] = 1] = "No";
})(DSSurveyLabelIndex || (DSSurveyLabelIndex = {}));

let DataScienceSurveyBanner = class DataScienceSurveyBanner {
  constructor(appShell, persistentState, browserService, commandThreshold = 500, surveyLink = 'https://aka.ms/pyaisurvey') {
    this.appShell = appShell;
    this.persistentState = persistentState;
    this.browserService = browserService;
    this.disabledInCurrentSession = false;
    this.isInitialized = false;
    this.bannerMessage = localize.DataScienceSurveyBanner.bannerMessage();
    this.bannerLabels = [localize.DataScienceSurveyBanner.bannerLabelYes(), localize.DataScienceSurveyBanner.bannerLabelNo()];
    this.commandThreshold = commandThreshold;
    this.surveyLink = surveyLink;
    this.initialize();
  }

  initialize() {
    if (this.isInitialized) {
      return;
    }

    this.isInitialized = true;
  }

  get optionLabels() {
    return this.bannerLabels;
  }

  get shownCount() {
    return this.getPythonDSCommandCounter();
  }

  get enabled() {
    return this.persistentState.createGlobalPersistentState(DSSurveyStateKeys.ShowBanner, true).value;
  }

  showBanner() {
    return __awaiter(this, void 0, void 0, function* () {
      if (!this.enabled || this.disabledInCurrentSession) {
        return;
      }

      const launchCounter = yield this.incrementPythonDataScienceCommandCounter();
      const show = yield this.shouldShowBanner(launchCounter);

      if (!show) {
        return;
      }

      const response = yield this.appShell.showInformationMessage(this.bannerMessage, ...this.bannerLabels);

      switch (response) {
        case this.bannerLabels[DSSurveyLabelIndex.Yes]:
          {
            yield this.launchSurvey();
            yield this.disable();
            break;
          }

        case this.bannerLabels[DSSurveyLabelIndex.No]:
          {
            yield this.disable();
            break;
          }

        default:
          {
            // Disable for the current session.
            this.disabledInCurrentSession = true;
          }
      }
    });
  }

  shouldShowBanner(launchCounter) {
    return __awaiter(this, void 0, void 0, function* () {
      if (!this.enabled || this.disabledInCurrentSession) {
        return false;
      }

      if (!launchCounter) {
        launchCounter = yield this.getPythonDSCommandCounter();
      }

      return launchCounter >= this.commandThreshold;
    });
  }

  disable() {
    return __awaiter(this, void 0, void 0, function* () {
      yield this.persistentState.createGlobalPersistentState(DSSurveyStateKeys.ShowBanner, false).updateValue(false);
    });
  }

  launchSurvey() {
    return __awaiter(this, void 0, void 0, function* () {
      this.browserService.launch(this.surveyLink);
    });
  }

  getPythonDSCommandCounter() {
    return __awaiter(this, void 0, void 0, function* () {
      const state = this.persistentState.createGlobalPersistentState(DSSurveyStateKeys.ShowAttemptCounter, 0);
      return state.value;
    });
  }

  incrementPythonDataScienceCommandCounter() {
    return __awaiter(this, void 0, void 0, function* () {
      const state = this.persistentState.createGlobalPersistentState(DSSurveyStateKeys.ShowAttemptCounter, 0);
      yield state.updateValue(state.value + 1);
      return state.value;
    });
  }

};
DataScienceSurveyBanner = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_1.IApplicationShell)), __param(1, inversify_1.inject(types_2.IPersistentStateFactory)), __param(2, inversify_1.inject(types_2.IBrowserService))], DataScienceSurveyBanner);
exports.DataScienceSurveyBanner = DataScienceSurveyBanner;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRhdGFTY2llbmNlU3VydmV5QmFubmVyLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsIl9fcGFyYW0iLCJwYXJhbUluZGV4IiwiZGVjb3JhdG9yIiwiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsImV4cG9ydHMiLCJpbnZlcnNpZnlfMSIsInJlcXVpcmUiLCJ0eXBlc18xIiwidHlwZXNfMiIsImxvY2FsaXplIiwiRFNTdXJ2ZXlTdGF0ZUtleXMiLCJEU1N1cnZleUxhYmVsSW5kZXgiLCJEYXRhU2NpZW5jZVN1cnZleUJhbm5lciIsImNvbnN0cnVjdG9yIiwiYXBwU2hlbGwiLCJwZXJzaXN0ZW50U3RhdGUiLCJicm93c2VyU2VydmljZSIsImNvbW1hbmRUaHJlc2hvbGQiLCJzdXJ2ZXlMaW5rIiwiZGlzYWJsZWRJbkN1cnJlbnRTZXNzaW9uIiwiaXNJbml0aWFsaXplZCIsImJhbm5lck1lc3NhZ2UiLCJiYW5uZXJMYWJlbHMiLCJiYW5uZXJMYWJlbFllcyIsImJhbm5lckxhYmVsTm8iLCJpbml0aWFsaXplIiwib3B0aW9uTGFiZWxzIiwic2hvd25Db3VudCIsImdldFB5dGhvbkRTQ29tbWFuZENvdW50ZXIiLCJlbmFibGVkIiwiY3JlYXRlR2xvYmFsUGVyc2lzdGVudFN0YXRlIiwiU2hvd0Jhbm5lciIsInNob3dCYW5uZXIiLCJsYXVuY2hDb3VudGVyIiwiaW5jcmVtZW50UHl0aG9uRGF0YVNjaWVuY2VDb21tYW5kQ291bnRlciIsInNob3ciLCJzaG91bGRTaG93QmFubmVyIiwicmVzcG9uc2UiLCJzaG93SW5mb3JtYXRpb25NZXNzYWdlIiwiWWVzIiwibGF1bmNoU3VydmV5IiwiZGlzYWJsZSIsIk5vIiwidXBkYXRlVmFsdWUiLCJsYXVuY2giLCJzdGF0ZSIsIlNob3dBdHRlbXB0Q291bnRlciIsImluamVjdGFibGUiLCJpbmplY3QiLCJJQXBwbGljYXRpb25TaGVsbCIsIklQZXJzaXN0ZW50U3RhdGVGYWN0b3J5IiwiSUJyb3dzZXJTZXJ2aWNlIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsVUFBVSxHQUFJLFVBQVEsU0FBS0EsVUFBZCxJQUE2QixVQUFVQyxVQUFWLEVBQXNCQyxNQUF0QixFQUE4QkMsR0FBOUIsRUFBbUNDLElBQW5DLEVBQXlDO0FBQ25GLE1BQUlDLENBQUMsR0FBR0MsU0FBUyxDQUFDQyxNQUFsQjtBQUFBLE1BQTBCQyxDQUFDLEdBQUdILENBQUMsR0FBRyxDQUFKLEdBQVFILE1BQVIsR0FBaUJFLElBQUksS0FBSyxJQUFULEdBQWdCQSxJQUFJLEdBQUdLLE1BQU0sQ0FBQ0Msd0JBQVAsQ0FBZ0NSLE1BQWhDLEVBQXdDQyxHQUF4QyxDQUF2QixHQUFzRUMsSUFBckg7QUFBQSxNQUEySE8sQ0FBM0g7QUFDQSxNQUFJLE9BQU9DLE9BQVAsS0FBbUIsUUFBbkIsSUFBK0IsT0FBT0EsT0FBTyxDQUFDQyxRQUFmLEtBQTRCLFVBQS9ELEVBQTJFTCxDQUFDLEdBQUdJLE9BQU8sQ0FBQ0MsUUFBUixDQUFpQlosVUFBakIsRUFBNkJDLE1BQTdCLEVBQXFDQyxHQUFyQyxFQUEwQ0MsSUFBMUMsQ0FBSixDQUEzRSxLQUNLLEtBQUssSUFBSVUsQ0FBQyxHQUFHYixVQUFVLENBQUNNLE1BQVgsR0FBb0IsQ0FBakMsRUFBb0NPLENBQUMsSUFBSSxDQUF6QyxFQUE0Q0EsQ0FBQyxFQUE3QyxFQUFpRCxJQUFJSCxDQUFDLEdB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LE9BQU8sQ0FBQzJDLGVBQTNCLENBQUosQ0FKMEIsQ0FBRCxFQUtqQ3ZDLHVCQUxpQyxDQUFwQztBQU1BUixPQUFPLENBQUNRLHVCQUFSLEdBQWtDQSx1QkFBbEMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cbid1c2Ugc3RyaWN0JztcbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xuICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xufTtcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQsIGtleSkgeyBkZWNvcmF0b3IodGFyZ2V0LCBrZXksIHBhcmFtSW5kZXgpOyB9XG59O1xudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcbiAgICB9KTtcbn07XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5jb25zdCBpbnZlcnNpZnlfMSA9IHJlcXVpcmUoXCJpbnZlcnNpZnlcIik7XG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uL2NvbW1vbi9hcHBsaWNhdGlvbi90eXBlc1wiKTtcbnJlcXVpcmUoXCIuLi9jb21tb24vZXh0ZW5zaW9uc1wiKTtcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vY29tbW9uL3R5cGVzXCIpO1xuY29uc3QgbG9jYWxpemUgPSByZXF1aXJlKFwiLi4vY29tbW9uL3V0aWxzL2xvY2FsaXplXCIpO1xudmFyIERTU3VydmV5U3RhdGVLZXlzO1xuKGZ1bmN0aW9uIChEU1N1cnZleVN0YXRlS2V5cykge1xuICAgIERTU3VydmV5U3RhdGVLZXlzW1wiU2hvd0Jhbm5lclwiXSA9IFwiU2hvd0RTU3VydmV5QmFubmVyXCI7XG4gICAgRFNTdXJ2ZXlTdGF0ZUtleXNbXCJTaG93QXR0ZW1wdENvdW50ZXJcIl0gPSBcIkRTU3VydmV5U2hvd0F0dGVtcHRcIjtcbn0pKERTU3VydmV5U3RhdGVLZXlzID0gZXhwb3J0cy5EU1N1cnZleVN0YXRlS2V5cyB8fCAoZXhwb3J0cy5EU1N1cnZleVN0YXRlS2V5cyA9IHt9KSk7XG52YXIgRFNTdXJ2ZXlMYWJlbEluZGV4O1xuKGZ1bmN0aW9uIChEU1N1cnZleUxhYmVsSW5kZXgpIHtcbiAgICBEU1N1cnZleUxhYmVsSW5kZXhbRFNTdXJ2ZXlMYWJlbEluZGV4W1wiWWVzXCJdID0gMF0gPSBcIlllc1wiO1xuICAgIERTU3VydmV5TGFiZWxJbmRleFtEU1N1cnZleUxhYmVsSW5kZXhbXCJOb1wiXSA9IDFdID0gXCJOb1wiO1xufSkoRFNTdXJ2ZXlMYWJlbEluZGV4IHx8IChEU1N1cnZleUxhYmVsSW5kZXggPSB7fSkpO1xubGV0IERhdGFTY2llbmNlU3VydmV5QmFubmVyID0gY2xhc3MgRGF0YVNjaWVuY2VTdXJ2ZXlCYW5uZXIge1xuICAgIGNvbnN0cnVjdG9yKGFwcFNoZWxsLCBwZXJzaXN0ZW50U3RhdGUsIGJyb3dzZXJTZXJ2aWNlLCBjb21tYW5kVGhyZXNob2xkID0gNTAwLCBzdXJ2ZXlMaW5rID0gJ2h0dHBzOi8vYWthLm1zL3B5YWlzdXJ2ZXknKSB7XG4gICAgICAgIHRoaXMuYXBwU2hlbGwgPSBhcHBTaGVsbDtcbiAgICAgICAgdGhpcy5wZXJzaXN0ZW50U3RhdGUgPSBwZXJzaXN0ZW50U3RhdGU7XG4gICAgICAgIHRoaXMuYnJvd3NlclNlcnZpY2UgPSBicm93c2VyU2VydmljZTtcbiAgICAgICAgdGhpcy5kaXNhYmxlZEluQ3VycmVudFNlc3Npb24gPSBmYWxzZTtcbiAgICAgICAgdGhpcy5pc0luaXRpYWxpemVkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuYmFubmVyTWVzc2FnZSA9IGxvY2FsaXplLkRhdGFTY2llbmNlU3VydmV5QmFubmVyLmJhbm5lck1lc3NhZ2UoKTtcbiAgICAgICAgdGhpcy5iYW5uZXJMYWJlbHMgPSBbbG9jYWxpemUuRGF0YVNjaWVuY2VTdXJ2ZXlCYW5uZXIuYmFubmVyTGFiZWxZZXMoKSwgbG9jYWxpemUuRGF0YVNjaWVuY2VTdXJ2ZXlCYW5uZXIuYmFubmVyTGFiZWxObygpXTtcbiAgICAgICAgdGhpcy5jb21tYW5kVGhyZXNob2xkID0gY29tbWFuZFRocmVzaG9sZDtcbiAgICAgICAgdGhpcy5zdXJ2ZXlMaW5rID0gc3VydmV5TGluaztcbiAgICAgICAgdGhpcy5pbml0aWFsaXplKCk7XG4gICAgfVxuICAgIGluaXRpYWxpemUoKSB7XG4gICAgICAgIGlmICh0aGlzLmlzSW5pdGlhbGl6ZWQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmlzSW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgIH1cbiAgICBnZXQgb3B0aW9uTGFiZWxzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5iYW5uZXJMYWJlbHM7XG4gICAgfVxuICAgIGdldCBzaG93bkNvdW50KCkge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRQeXRob25EU0NvbW1hbmRDb3VudGVyKCk7XG4gICAgfVxuICAgIGdldCBlbmFibGVkKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5wZXJzaXN0ZW50U3RhdGUuY3JlYXRlR2xvYmFsUGVyc2lzdGVudFN0YXRlKERTU3VydmV5U3RhdGVLZXlzLlNob3dCYW5uZXIsIHRydWUpLnZhbHVlO1xuICAgIH1cbiAgICBzaG93QmFubmVyKCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWQgfHwgdGhpcy5kaXNhYmxlZEluQ3VycmVudFNlc3Npb24pIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBsYXVuY2hDb3VudGVyID0geWllbGQgdGhpcy5pbmNyZW1lbnRQeXRob25EYXRhU2NpZW5jZUNvbW1hbmRDb3VudGVyKCk7XG4gICAgICAgICAgICBjb25zdCBzaG93ID0geWllbGQgdGhpcy5zaG91bGRTaG93QmFubmVyKGxhdW5jaENvdW50ZXIpO1xuICAgICAgICAgICAgaWYgKCFzaG93KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSB5aWVsZCB0aGlzLmFwcFNoZWxsLnNob3dJbmZvcm1hdGlvbk1lc3NhZ2UodGhpcy5iYW5uZXJNZXNzYWdlLCAuLi50aGlzLmJhbm5lckxhYmVscyk7XG4gICAgICAgICAgICBzd2l0Y2ggKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgY2FzZSB0aGlzLmJhbm5lckxhYmVsc1tEU1N1cnZleUxhYmVsSW5kZXguWWVzXTpcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy5sYXVuY2hTdXJ2ZXkoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMuZGlzYWJsZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjYXNlIHRoaXMuYmFubmVyTGFiZWxzW0RTU3VydmV5TGFiZWxJbmRleC5Ob106IHtcbiAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy5kaXNhYmxlKCk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBkZWZhdWx0OiB7XG4gICAgICAgICAgICAgICAgICAgIC8vIERpc2FibGUgZm9yIHRoZSBjdXJyZW50IHNlc3Npb24uXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGlzYWJsZWRJbkN1cnJlbnRTZXNzaW9uID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBzaG91bGRTaG93QmFubmVyKGxhdW5jaENvdW50ZXIpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5lbmFibGVkIHx8IHRoaXMuZGlzYWJsZWRJbkN1cnJlbnRTZXNzaW9uKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFsYXVuY2hDb3VudGVyKSB7XG4gICAgICAgICAgICAgICAgbGF1bmNoQ291bnRlciA9IHlpZWxkIHRoaXMuZ2V0UHl0aG9uRFNDb21tYW5kQ291bnRlcigpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGxhdW5jaENvdW50ZXIgPj0gdGhpcy5jb21tYW5kVGhyZXNob2xkO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgZGlzYWJsZSgpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIHlpZWxkIHRoaXMucGVyc2lzdGVudFN0YXRlLmNyZWF0ZUdsb2JhbFBlcnNpc3RlbnRTdGF0ZShEU1N1cnZleVN0YXRlS2V5cy5TaG93QmFubmVyLCBmYWxzZSkudXBkYXRlVmFsdWUoZmFsc2UpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgbGF1bmNoU3VydmV5KCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgdGhpcy5icm93c2VyU2VydmljZS5sYXVuY2godGhpcy5zdXJ2ZXlMaW5rKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGdldFB5dGhvbkRTQ29tbWFuZENvdW50ZXIoKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBzdGF0ZSA9IHRoaXMucGVyc2lzdGVudFN0YXRlLmNyZWF0ZUdsb2JhbFBlcnNpc3RlbnRTdGF0ZShEU1N1cnZleVN0YXRlS2V5cy5TaG93QXR0ZW1wdENvdW50ZXIsIDApO1xuICAgICAgICAgICAgcmV0dXJuIHN0YXRlLnZhbHVlO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgaW5jcmVtZW50UHl0aG9uRGF0YVNjaWVuY2VDb21tYW5kQ291bnRlcigpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IHN0YXRlID0gdGhpcy5wZXJzaXN0ZW50U3RhdGUuY3JlYXRlR2xvYmFsUGVyc2lzdGVudFN0YXRlKERTU3VydmV5U3RhdGVLZXlzLlNob3dBdHRlbXB0Q291bnRlciwgMCk7XG4gICAgICAgICAgICB5aWVsZCBzdGF0ZS51cGRhdGVWYWx1ZShzdGF0ZS52YWx1ZSArIDEpO1xuICAgICAgICAgICAgcmV0dXJuIHN0YXRlLnZhbHVlO1xuICAgICAgICB9KTtcbiAgICB9XG59O1xuRGF0YVNjaWVuY2VTdXJ2ZXlCYW5uZXIgPSBfX2RlY29yYXRlKFtcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKCksXG4gICAgX19wYXJhbSgwLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMS5JQXBwbGljYXRpb25TaGVsbCkpLFxuICAgIF9fcGFyYW0oMSwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzIuSVBlcnNpc3RlbnRTdGF0ZUZhY3RvcnkpKSxcbiAgICBfX3BhcmFtKDIsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18yLklCcm93c2VyU2VydmljZSkpXG5dLCBEYXRhU2NpZW5jZVN1cnZleUJhbm5lcik7XG5leHBvcnRzLkRhdGFTY2llbmNlU3VydmV5QmFubmVyID0gRGF0YVNjaWVuY2VTdXJ2ZXlCYW5uZXI7XG4vLyMgc291cmNlTWFwcGluZ1VSTD1kYXRhU2NpZW5jZVN1cnZleUJhbm5lci5qcy5tYXAiXX0=