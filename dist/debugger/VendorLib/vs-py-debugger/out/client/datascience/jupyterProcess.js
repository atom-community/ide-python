"use strict";

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});
var JupyterProcess_1; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

'use strict';

const inversify_1 = require("inversify");

const tk = require("tree-kill");

const url_1 = require("url");

const types_1 = require("../common/process/types");

const types_2 = require("../common/types");

const async_1 = require("../common/utils/async");

const types_3 = require("./types"); // This class communicates with an instance of jupyter that's running in the background


let JupyterProcess = JupyterProcess_1 = class JupyterProcess {
  constructor(executionFactory, jupyterExecution, logger) {
    this.executionFactory = executionFactory;
    this.jupyterExecution = jupyterExecution;
    this.logger = logger;
    this.isDisposed = false;

    this.start = notebookdir => __awaiter(this, void 0, void 0, function* () {
      // Compute args based on if inside a workspace or not
      const args = ['notebook', '--no-browser', `--notebook-dir=${notebookdir}`]; // Setup our start promise

      this.startPromise = async_1.createDeferred(); // Use the IPythonExecutionService to find Jupyter

      this.startObservable = yield this.jupyterExecution.execModuleObservable(args, {
        throwOnStdErr: false,
        encoding: 'utf8'
      }); // Listen on stderr for its connection information

      this.startObservable.out.subscribe(output => {
        if (output.source === 'stderr') {
          this.extractConnectionInformation(output.out);
        } else {
          this.output(output.out);
        }
      });
    });

    this.shutdown = () => __awaiter(this, void 0, void 0, function* () {
      if (this.startObservable && this.startObservable.proc) {
        if (!this.startObservable.proc.killed) {
          tk(this.startObservable.proc.pid);
        }

        this.startObservable = undefined;
      }
    });

    this.spawn = notebookFile => __awaiter(this, void 0, void 0, function* () {
      // Compute args for the file
      const args = ['notebook', `--NotebookApp.file_to_run=${notebookFile}`]; // Use the IPythonExecutionService to find Jupyter

      return this.jupyterExecution.execModule(args, {
        throwOnStdErr: true,
        encoding: 'utf8'
      });
    });
  }

  waitForPythonVersionString() {
    return __awaiter(this, void 0, void 0, function* () {
      const pythonService = yield this.executionFactory.create({});
      const info = yield pythonService.getInterpreterInformation();
      return info ? info.version : '3';
    });
  }

  waitForPythonVersion() {
    return __awaiter(this, void 0, void 0, function* () {
      const pythonService = yield this.executionFactory.create({});
      const info = yield pythonService.getInterpreterInformation();
      return info ? info.version_info : undefined;
    });
  }

  waitForPythonPath() {
    return __awaiter(this, void 0, void 0, function* () {
      const pythonService = yield this.executionFactory.create({});
      const info = yield pythonService.getInterpreterInformation();
      return info ? info.path : undefined;
    });
  } // Returns the information necessary to talk to this instance


  waitForConnectionInformation() {
    if (this.startPromise) {
      return this.startPromise.promise;
    }

    return Promise.resolve({
      baseUrl: '',
      token: ''
    });
  }

  dispose() {
    if (!this.isDisposed) {
      this.isDisposed = true;
      this.shutdown().ignoreErrors();
    }
  } // tslint:disable-next-line:no-any


  output(data) {
    if (this.logger) {
      this.logger.logInformation(data.toString('utf8'));
    }
  } // tslint:disable-next-line:no-any


  extractConnectionInformation(data) {
    this.output(data); // Look for a Jupyter Notebook url in the string received.

    const urlMatch = JupyterProcess_1.urlPattern.exec(data);

    if (urlMatch && this.startPromise) {
      const url = new url_1.URL(urlMatch[0]);
      this.startPromise.resolve({
        baseUrl: `${url.protocol}//${url.host}/`,
        token: `${url.searchParams.get('token')}`
      });
    } // Do we need to worry about this not working? Timeout?
    // Look for 'Forbidden' in the result


    const forbiddenMatch = JupyterProcess_1.forbiddenPattern.exec(data);

    if (forbiddenMatch && this.startPromise && !this.startPromise.resolved) {
      this.startPromise.reject(new Error(data.toString('utf8')));
    }
  }

};
JupyterProcess.urlPattern = /http:\/\/localhost:[0-9]+\/\?token=[a-z0-9]+/g;
JupyterProcess.forbiddenPattern = /Forbidden/g;
JupyterProcess = JupyterProcess_1 = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_1.IPythonExecutionFactory)), __param(1, inversify_1.inject(types_3.IJupyterExecution)), __param(2, inversify_1.inject(types_2.ILogger))], JupyterProcess);
exports.JupyterProcess = JupyterProcess;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImp1cHl0ZXJQcm9jZXNzLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsIl9fcGFyYW0iLCJwYXJhbUluZGV4IiwiZGVjb3JhdG9yIiwiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsImV4cG9ydHMiLCJKdXB5dGVyUHJvY2Vzc18xIiwiaW52ZXJzaWZ5XzEiLCJyZXF1aXJlIiwidGsiLCJ1cmxfMSIsInR5cGVzXzEiLCJ0eXBlc18yIiwiYXN5bmNfMSIsInR5cGVzXzMiLCJKdXB5dGVyUHJvY2VzcyIsImNvbnN0cnVjdG9yIiwiZXhlY3V0aW9uRmFjdG9yeSIsImp1cHl0ZXJFeGVjdXRpb24iLCJsb2dnZXIiLCJpc0Rpc3Bvc2VkIiwic3RhcnQiLCJub3RlYm9va2RpciIsImFyZ3MiLCJzdGFydFByb21pc2UiLCJjcmVhdGVEZWZlcnJlZCIsInN0YXJ0T2JzZXJ2YWJsZSIsImV4ZWNNb2R1bGVPYnNlcnZhYmxlIiwidGhyb3dPblN0ZEVyciIsImVuY29kaW5nIiwib3V0Iiwic3Vic2NyaWJlIiwib3V0cHV0Iiwic291cmNlIiwiZXh0cmFjdENvbm5lY3Rpb25JbmZvcm1hdGlvbiIsInNodXRkb3duIiwicHJvYyIsImtpbGxlZCIsInBpZCIsInVuZGVmaW5lZCIsInNwYXduIiwibm90ZWJvb2tGaWxlIiwiZXhlY01vZHVsZSIsIndhaXRGb3JQeXRob25WZXJzaW9uU3RyaW5nIiwicHl0aG9uU2VydmljZSIsImNyZWF0ZSIsImluZm8iLCJnZXRJbnRlcnByZXRlckluZm9ybWF0aW9uIiwidmVyc2lvbiIsIndhaXRGb3JQeXRob25WZXJzaW9uIiwidmVyc2lvbl9pbmZvIiwid2FpdEZvclB5dGhvblBhdGgiLCJwYXRoIiwid2FpdEZvckNvbm5lY3Rpb25JbmZvcm1hdGlvbiIsInByb21pc2UiLCJiYXNlVXJsIiwidG9rZW4iLCJkaXNwb3NlIiwiaWdub3JlRXJyb3JzIiwiZGF0YSIsImxvZ0luZm9ybWF0aW9uIiwidG9TdHJpbmciLCJ1cmxNYXRjaCIsInVybFBhdHRlcm4iLCJleGVjIiwidXJsIiwiVVJMIiwicHJvdG9jb2wiLCJob3N0Iiwic2VhcmNoUGFyYW1zIiwiZ2V0IiwiZm9yYmlkZGVuTWF0Y2giLCJmb3JiaWRkZW5QYXR0ZXJuIiwicmVzb2x2ZWQiLCJFcnJvciIsImluamVjdGFibGUiLCJpbmplY3QiLCJJUHl0aG9uRXhlY3V0aW9uRmFjdG9yeSIsIklKdXB5dGVyRXhlY3V0aW9uIiwiSUxvZ2dlciJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBQ0EsSUFBSUEsVUFBVSxHQUFJLFVBQVEsU0FBS0EsVUFBZCxJQUE2QixVQUFVQyxVQUFWLEVBQXNCQyxNQUF0QixFQUE4QkMsR0FBOUIsRUFBbUNDLElBQW5DLEVBQXlDO0FBQ25GLE1BQUlDLENBQUMsR0FBR0MsU0FBUyxDQUFDQyxNQUFsQjtBQUFBLE1BQTBCQyxDQUFDLEdBQUdILENBQUMsR0FBRyxDQUFKLEdBQVFILE1BQVIsR0FBaUJFLElBQUksS0FBSyxJQUFULEdBQWdCQSxJQUFJLEdBQUdLLE1BQU0sQ0FBQ0Msd0JBQVAsQ0FBZ0NSLE1BQWhDLEVBQXdDQyxHQUF4QyxDQUF2QixHQUFzRUMsSUFBckg7QUFBQSxNQUEySE8sQ0FBM0g7QUFDQSxNQUFJLE9BQU9DLE9BQVAsS0FBbUIsUUFBbkIsSUFBK0IsT0FBT0EsT0FBTyxDQUFDQyxRQUFmLEtBQTRCLFVBQS9ELEVBQTJFTCxDQUFDLEdBQUdJLE9B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PSAodGhpcyAmJiB0aGlzLl9fZGVjb3JhdGUpIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcbiAgICBlbHNlIGZvciAodmFyIGkgPSBkZWNvcmF0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBpZiAoZCA9IGRlY29yYXRvcnNbaV0pIHIgPSAoYyA8IDMgPyBkKHIpIDogYyA+IDMgPyBkKHRhcmdldCwga2V5LCByKSA6IGQodGFyZ2V0LCBrZXkpKSB8fCByO1xuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XG59O1xudmFyIF9fcGFyYW0gPSAodGhpcyAmJiB0aGlzLl9fcGFyYW0pIHx8IGZ1bmN0aW9uIChwYXJhbUluZGV4LCBkZWNvcmF0b3IpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7IGRlY29yYXRvcih0YXJnZXQsIGtleSwgcGFyYW1JbmRleCk7IH1cbn07XG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xuICAgIH0pO1xufTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbnZhciBKdXB5dGVyUHJvY2Vzc18xO1xuLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXG4ndXNlIHN0cmljdCc7XG5jb25zdCBpbnZlcnNpZnlfMSA9IHJlcXVpcmUoXCJpbnZlcnNpZnlcIik7XG5jb25zdCB0ayA9IHJlcXVpcmUoXCJ0cmVlLWtpbGxcIik7XG5jb25zdCB1cmxfMSA9IHJlcXVpcmUoXCJ1cmxcIik7XG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uL2NvbW1vbi9wcm9jZXNzL3R5cGVzXCIpO1xuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi9jb21tb24vdHlwZXNcIik7XG5jb25zdCBhc3luY18xID0gcmVxdWlyZShcIi4uL2NvbW1vbi91dGlscy9hc3luY1wiKTtcbmNvbnN0IHR5cGVzXzMgPSByZXF1aXJlKFwiLi90eXBlc1wiKTtcbi8vIFRoaXMgY2xhc3MgY29tbXVuaWNhdGVzIHdpdGggYW4gaW5zdGFuY2Ugb2YganVweXRlciB0aGF0J3MgcnVubmluZyBpbiB0aGUgYmFja2dyb3VuZFxubGV0IEp1cHl0ZXJQcm9jZXNzID0gSnVweXRlclByb2Nlc3NfMSA9IGNsYXNzIEp1cHl0ZXJQcm9jZXNzIHtcbiAgICBjb25zdHJ1Y3RvcihleGVjdXRpb25GYWN0b3J5LCBqdXB5dGVyRXhlY3V0aW9uLCBsb2dnZXIpIHtcbiAgICAgICAgdGhpcy5leGVjdXRpb25GYWN0b3J5ID0gZXhlY3V0aW9uRmFjdG9yeTtcbiAgICAgICAgdGhpcy5qdXB5dGVyRXhlY3V0aW9uID0ganVweXRlckV4ZWN1dGlvbjtcbiAgICAgICAgdGhpcy5sb2dnZXIgPSBsb2dnZXI7XG4gICAgICAgIHRoaXMuaXNEaXNwb3NlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLnN0YXJ0ID0gKG5vdGVib29rZGlyKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICAvLyBDb21wdXRlIGFyZ3MgYmFzZWQgb24gaWYgaW5zaWRlIGEgd29ya3NwYWNlIG9yIG5vdFxuICAgICAgICAgICAgY29uc3QgYXJncyA9IFsnbm90ZWJvb2snLCAnLS1uby1icm93c2VyJywgYC0tbm90ZWJvb2stZGlyPSR7bm90ZWJvb2tkaXJ9YF07XG4gICAgICAgICAgICAvLyBTZXR1cCBvdXIgc3RhcnQgcHJvbWlzZVxuICAgICAgICAgICAgdGhpcy5zdGFydFByb21pc2UgPSBhc3luY18xLmNyZWF0ZURlZmVycmVkKCk7XG4gICAgICAgICAgICAvLyBVc2UgdGhlIElQeXRob25FeGVjdXRpb25TZXJ2aWNlIHRvIGZpbmQgSnVweXRlclxuICAgICAgICAgICAgdGhpcy5zdGFydE9ic2VydmFibGUgPSB5aWVsZCB0aGlzLmp1cHl0ZXJFeGVjdXRpb24uZXhlY01vZHVsZU9ic2VydmFibGUoYXJncywgeyB0aHJvd09uU3RkRXJyOiBmYWxzZSwgZW5jb2Rpbmc6ICd1dGY4JyB9KTtcbiAgICAgICAgICAgIC8vIExpc3RlbiBvbiBzdGRlcnIgZm9yIGl0cyBjb25uZWN0aW9uIGluZm9ybWF0aW9uXG4gICAgICAgICAgICB0aGlzLnN0YXJ0T2JzZXJ2YWJsZS5vdXQuc3Vic2NyaWJlKChvdXRwdXQpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAob3V0cHV0LnNvdXJjZSA9PT0gJ3N0ZGVycicpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5leHRyYWN0Q29ubmVjdGlvbkluZm9ybWF0aW9uKG91dHB1dC5vdXQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vdXRwdXQob3V0cHV0Lm91dCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnNodXRkb3duID0gKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgaWYgKHRoaXMuc3RhcnRPYnNlcnZhYmxlICYmIHRoaXMuc3RhcnRPYnNlcnZhYmxlLnByb2MpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuc3RhcnRPYnNlcnZhYmxlLnByb2Mua2lsbGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHRrKHRoaXMuc3RhcnRPYnNlcnZhYmxlLnByb2MucGlkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5zdGFydE9ic2VydmFibGUgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnNwYXduID0gKG5vdGVib29rRmlsZSkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgLy8gQ29tcHV0ZSBhcmdzIGZvciB0aGUgZmlsZVxuICAgICAgICAgICAgY29uc3QgYXJncyA9IFsnbm90ZWJvb2snLCBgLS1Ob3RlYm9va0FwcC5maWxlX3RvX3J1bj0ke25vdGVib29rRmlsZX1gXTtcbiAgICAgICAgICAgIC8vIFVzZSB0aGUgSVB5dGhvbkV4ZWN1dGlvblNlcnZpY2UgdG8gZmluZCBKdXB5dGVyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5qdXB5dGVyRXhlY3V0aW9uLmV4ZWNNb2R1bGUoYXJncywgeyB0aHJvd09uU3RkRXJyOiB0cnVlLCBlbmNvZGluZzogJ3V0ZjgnIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgd2FpdEZvclB5dGhvblZlcnNpb25TdHJpbmcoKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBweXRob25TZXJ2aWNlID0geWllbGQgdGhpcy5leGVjdXRpb25GYWN0b3J5LmNyZWF0ZSh7fSk7XG4gICAgICAgICAgICBjb25zdCBpbmZvID0geWllbGQgcHl0aG9uU2VydmljZS5nZXRJbnRlcnByZXRlckluZm9ybWF0aW9uKCk7XG4gICAgICAgICAgICByZXR1cm4gaW5mbyA/IGluZm8udmVyc2lvbiA6ICczJztcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHdhaXRGb3JQeXRob25WZXJzaW9uKCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgcHl0aG9uU2VydmljZSA9IHlpZWxkIHRoaXMuZXhlY3V0aW9uRmFjdG9yeS5jcmVhdGUoe30pO1xuICAgICAgICAgICAgY29uc3QgaW5mbyA9IHlpZWxkIHB5dGhvblNlcnZpY2UuZ2V0SW50ZXJwcmV0ZXJJbmZvcm1hdGlvbigpO1xuICAgICAgICAgICAgcmV0dXJuIGluZm8gPyBpbmZvLnZlcnNpb25faW5mbyA6IHVuZGVmaW5lZDtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHdhaXRGb3JQeXRob25QYXRoKCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgcHl0aG9uU2VydmljZSA9IHlpZWxkIHRoaXMuZXhlY3V0aW9uRmFjdG9yeS5jcmVhdGUoe30pO1xuICAgICAgICAgICAgY29uc3QgaW5mbyA9IHlpZWxkIHB5dGhvblNlcnZpY2UuZ2V0SW50ZXJwcmV0ZXJJbmZvcm1hdGlvbigpO1xuICAgICAgICAgICAgcmV0dXJuIGluZm8gPyBpbmZvLnBhdGggOiB1bmRlZmluZWQ7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICAvLyBSZXR1cm5zIHRoZSBpbmZvcm1hdGlvbiBuZWNlc3NhcnkgdG8gdGFsayB0byB0aGlzIGluc3RhbmNlXG4gICAgd2FpdEZvckNvbm5lY3Rpb25JbmZvcm1hdGlvbigpIHtcbiAgICAgICAgaWYgKHRoaXMuc3RhcnRQcm9taXNlKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zdGFydFByb21pc2UucHJvbWlzZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHsgYmFzZVVybDogJycsIHRva2VuOiAnJyB9KTtcbiAgICB9XG4gICAgZGlzcG9zZSgpIHtcbiAgICAgICAgaWYgKCF0aGlzLmlzRGlzcG9zZWQpIHtcbiAgICAgICAgICAgIHRoaXMuaXNEaXNwb3NlZCA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLnNodXRkb3duKCkuaWdub3JlRXJyb3JzKCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWFueVxuICAgIG91dHB1dChkYXRhKSB7XG4gICAgICAgIGlmICh0aGlzLmxvZ2dlcikge1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIubG9nSW5mb3JtYXRpb24oZGF0YS50b1N0cmluZygndXRmOCcpKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55XG4gICAgZXh0cmFjdENvbm5lY3Rpb25JbmZvcm1hdGlvbihkYXRhKSB7XG4gICAgICAgIHRoaXMub3V0cHV0KGRhdGEpO1xuICAgICAgICAvLyBMb29rIGZvciBhIEp1cHl0ZXIgTm90ZWJvb2sgdXJsIGluIHRoZSBzdHJpbmcgcmVjZWl2ZWQuXG4gICAgICAgIGNvbnN0IHVybE1hdGNoID0gSnVweXRlclByb2Nlc3NfMS51cmxQYXR0ZXJuLmV4ZWMoZGF0YSk7XG4gICAgICAgIGlmICh1cmxNYXRjaCAmJiB0aGlzLnN0YXJ0UHJvbWlzZSkge1xuICAgICAgICAgICAgY29uc3QgdXJsID0gbmV3IHVybF8xLlVSTCh1cmxNYXRjaFswXSk7XG4gICAgICAgICAgICB0aGlzLnN0YXJ0UHJvbWlzZS5yZXNvbHZlKHsgYmFzZVVybDogYCR7dXJsLnByb3RvY29sfS8vJHt1cmwuaG9zdH0vYCwgdG9rZW46IGAke3VybC5zZWFyY2hQYXJhbXMuZ2V0KCd0b2tlbicpfWAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gRG8gd2UgbmVlZCB0byB3b3JyeSBhYm91dCB0aGlzIG5vdCB3b3JraW5nPyBUaW1lb3V0P1xuICAgICAgICAvLyBMb29rIGZvciAnRm9yYmlkZGVuJyBpbiB0aGUgcmVzdWx0XG4gICAgICAgIGNvbnN0IGZvcmJpZGRlbk1hdGNoID0gSnVweXRlclByb2Nlc3NfMS5mb3JiaWRkZW5QYXR0ZXJuLmV4ZWMoZGF0YSk7XG4gICAgICAgIGlmIChmb3JiaWRkZW5NYXRjaCAmJiB0aGlzLnN0YXJ0UHJvbWlzZSAmJiAhdGhpcy5zdGFydFByb21pc2UucmVzb2x2ZWQpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhcnRQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoZGF0YS50b1N0cmluZygndXRmOCcpKSk7XG4gICAgICAgIH1cbiAgICB9XG59O1xuSnVweXRlclByb2Nlc3MudXJsUGF0dGVybiA9IC9odHRwOlxcL1xcL2xvY2FsaG9zdDpbMC05XStcXC9cXD90b2tlbj1bYS16MC05XSsvZztcbkp1cHl0ZXJQcm9jZXNzLmZvcmJpZGRlblBhdHRlcm4gPSAvRm9yYmlkZGVuL2c7XG5KdXB5dGVyUHJvY2VzcyA9IEp1cHl0ZXJQcm9jZXNzXzEgPSBfX2RlY29yYXRlKFtcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKCksXG4gICAgX19wYXJhbSgwLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMS5JUHl0aG9uRXhlY3V0aW9uRmFjdG9yeSkpLFxuICAgIF9fcGFyYW0oMSwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzMuSUp1cHl0ZXJFeGVjdXRpb24pKSxcbiAgICBfX3BhcmFtKDIsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18yLklMb2dnZXIpKVxuXSwgSnVweXRlclByb2Nlc3MpO1xuZXhwb3J0cy5KdXB5dGVyUHJvY2VzcyA9IEp1cHl0ZXJQcm9jZXNzO1xuLy8jIHNvdXJjZU1hcHBpbmdVUkw9anVweXRlclByb2Nlc3MuanMubWFwIl19