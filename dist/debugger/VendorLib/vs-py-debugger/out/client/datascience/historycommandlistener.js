// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

require("../common/extensions");

const inversify_1 = require("inversify");

const vscode_1 = require("vscode");

const types_1 = require("../common/application/types");

const types_2 = require("../common/types");

const localize = require("../common/utils/localize");

const telemetry_1 = require("../telemetry");

const constants_1 = require("../unittests/common/constants");

const constants_2 = require("./constants");

const types_3 = require("./types");

let HistoryCommandListener = class HistoryCommandListener {
  constructor(disposableRegistry, historyProvider, jupyterImporter, documentManager, applicationShell, logger, configuration, statusProvider) {
    this.disposableRegistry = disposableRegistry;
    this.historyProvider = historyProvider;
    this.jupyterImporter = jupyterImporter;
    this.documentManager = documentManager;
    this.applicationShell = applicationShell;
    this.logger = logger;
    this.configuration = configuration;
    this.statusProvider = statusProvider;

    this.canImportFromOpenedFile = () => {
      const settings = this.configuration.getSettings();
      return settings && (!settings.datascience || settings.datascience.allowImportFromNotebook);
    };

    this.disableImportOnOpenedFile = () => {
      const settings = this.configuration.getSettings();

      if (settings && settings.datascience) {
        settings.datascience.allowImportFromNotebook = false;
      }
    };

    this.onOpenedDocument = document => __awaiter(this, void 0, void 0, function* () {
      if (document.fileName.endsWith('.ipynb') && this.canImportFromOpenedFile()) {
        const yes = localize.DataScience.notebookCheckForImportYes();
        const no = localize.DataScience.notebookCheckForImportNo();
        const dontAskAgain = localize.DataScience.notebookCheckForImportDontAskAgain();
        const answer = yield this.applicationShell.showInformationMessage(localize.DataScience.notebookCheckForImportTitle(), yes, no, dontAskAgain);

        try {
          if (answer === yes) {
            yield this.importNotebookOnFile(document.fileName);
          } else if (answer === dontAskAgain) {
            this.disableImportOnOpenedFile();
          }
        } catch (err) {
          this.applicationShell.showErrorMessage(err);
        }
      }
    });

    this.setImportStatus = file => {
      const formatString = localize.DataScience.importingFormat();
      const message = formatString.format(file);
      return this.statusProvider.set(message, null);
    };

    this.viewDocument = contents => __awaiter(this, void 0, void 0, function* () {
      const doc = yield this.documentManager.openTextDocument({
        language: 'python',
        content: contents
      });
      const editor = yield this.documentManager.showTextDocument(doc, vscode_1.ViewColumn.One); // Edit the document so that it is dirty (add a space at the end)

      editor.edit(editBuilder => {
        editBuilder.insert(new vscode_1.Position(editor.document.lineCount, 0), '\n');
      });
    }); // Listen to document open commands. We want to ask the user if they want to import.


    const disposable = this.documentManager.onDidOpenTextDocument(this.onOpenedDocument);
    this.disposableRegistry.push(disposable);
  }

  register(commandManager) {
    let disposable = commandManager.registerCommand(constants_2.Commands.ShowHistoryPane, () => this.showHistoryPane());
    this.disposableRegistry.push(disposable);
    disposable = commandManager.registerCommand(constants_2.Commands.ImportNotebook, (file, cmdSource = constants_1.CommandSource.commandPalette) => __awaiter(this, void 0, void 0, function* () {
      try {
        if (file) {
          yield this.importNotebookOnFile(file.fsPath);
        } else {
          yield this.importNotebook();
        }
      } catch (err) {
        if (err.message) {
          this.logger.logError(err.message);
          this.applicationShell.showErrorMessage(err.message);
        } else {
          this.logger.logError(err.toString());
          this.applicationShell.showErrorMessage(err.toString());
        }
      }
    }));
    this.disposableRegistry.push(disposable);
  }

  showHistoryPane() {
    const active = this.historyProvider.active;
    return active.show();
  }

  importNotebook() {
    return __awaiter(this, void 0, void 0, function* () {
      const filtersKey = localize.DataScience.importDialogFilter();
      const filtersObject = {};
      filtersObject[filtersKey] = ['ipynb'];
      const uris = yield this.applicationShell.showOpenDialog({
        openLabel: localize.DataScience.importDialogTitle(),
        filters: filtersObject
      });

      if (uris && uris.length > 0) {
        const status = this.setImportStatus(uris[0].fsPath);

        try {
          const contents = yield this.jupyterImporter.importFromFile(uris[0].fsPath);
          yield this.viewDocument(contents);
        } catch (err) {
          throw err;
        } finally {
          status.dispose();
        }
      }
    });
  }

  importNotebookOnFile(file) {
    return __awaiter(this, void 0, void 0, function* () {
      if (file && file.length > 0) {
        const status = this.setImportStatus(file);

        try {
          const contents = yield this.jupyterImporter.importFromFile(file);
          yield this.viewDocument(contents);
        } catch (err) {
          throw err;
        } finally {
          status.dispose();
        }
      }
    });
  }

};

__decorate([telemetry_1.captureTelemetry(constants_2.Telemetry.ShowHistoryPane, {}, false)], HistoryCommandListener.prototype, "showHistoryPane", null);

__decorate([telemetry_1.captureTelemetry(constants_2.Telemetry.ImportNotebook, {
  scope: 'command'
}, false)], HistoryCommandListener.prototype, "importNotebook", null);

__decorate([telemetry_1.captureTelemetry(constants_2.Telemetry.ImportNotebook, {
  scope: 'file'
}, false)], HistoryCommandListener.prototype, "importNotebookOnFile", null);

HistoryCommandListener = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_2.IDisposableRegistry)), __param(1, inversify_1.inject(types_3.IHistoryProvider)), __param(2, inversify_1.inject(types_3.INotebookImporter)), __param(3, inversify_1.inject(types_1.IDocumentManager)), __param(4, inversify_1.inject(types_1.IApplicationShell)), __param(5, inversify_1.inject(types_2.ILogger)), __param(6, inversify_1.inject(types_2.IConfigurationService)), __param(7, inversify_1.inject(types_3.IStatusProvider))], HistoryCommandListener);
exports.HistoryCommandListener = HistoryCommandListener;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhpc3Rvcnljb21tYW5kbGlzdGVuZXIuanMiXSwibmFtZXMiOlsiX19kZWNvcmF0ZSIsImRlY29yYXRvcnMiLCJ0YXJnZXQiLCJrZXkiLCJkZXNjIiwiYyIsImFyZ3VtZW50cyIsImxlbmd0aCIsInIiLCJPYmplY3QiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJkIiwiUmVmbGVjdCIsImRlY29yYXRlIiwiaSIsImRlZmluZVByb3BlcnR5IiwiX19wYXJhbSIsInBhcmFtSW5kZXgiLCJkZWNvcmF0b3IiLCJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiZXhwb3J0cyIsInJlcXVpcmUiLCJpbnZlcnNpZnlfMSIsInZzY29kZV8xIiwidHlwZXNfMSIsInR5cGVzXzIiLCJsb2NhbGl6ZSIsInRlbGVtZXRyeV8xIiwiY29uc3RhbnRzXzEiLCJjb25zdGFudHNfMiIsInR5cGVzXzMiLCJIaXN0b3J5Q29tbWFuZExpc3RlbmVyIiwiY29uc3RydWN0b3IiLCJkaXNwb3NhYmxlUmVnaXN0cnkiLCJoaXN0b3J5UHJvdmlkZXIiLCJqdXB5dGVySW1wb3J0ZXIiLCJkb2N1bWVudE1hbmFnZXIiLCJhcHBsaWNhdGlvblNoZWxsIiwibG9nZ2VyIiwiY29uZmlndXJhdGlvbiIsInN0YXR1c1Byb3ZpZGVyIiwiY2FuSW1wb3J0RnJvbU9wZW5lZEZpbGUiLCJzZXR0aW5ncyIsImdldFNldHRpbmdzIiwiZGF0YXNjaWVuY2UiLCJhbGxvd0ltcG9ydEZyb21Ob3RlYm9vayIsImRpc2FibGVJbXBvcnRPbk9wZW5lZEZpbGUiLCJvbk9wZW5lZERvY3VtZW50IiwiZG9jdW1lbnQiLCJmaWxlTmFtZSIsImVuZHNXaXRoIiwieWVzIiwiRGF0YVNjaWVuY2UiLCJub3RlYm9va0NoZWNrRm9ySW1wb3J0WWVzIiwibm8iLCJub3RlYm9va0NoZWNrRm9ySW1wb3J0Tm8iLCJkb250QXNrQWdhaW4iLCJub3RlYm9va0NoZWNrRm9ySW1wb3J0RG9udEFza0FnYWluIiwiYW5zd2VyIiwic2hvd0luZm9ybWF0aW9uTWVzc2FnZSIsIm5vdGVib29rQ2hlY2tGb3JJbXBvcnRUaXRsZSIsImltcG9ydE5vdGVib29rT25GaWxlIiwiZXJyIiwic2hvd0Vycm9yTWVzc2FnZSIsInNldEltcG9ydFN0YXR1cyIsImZpbGUiLCJmb3JtYXRTdHJpbmciLCJpbXBvcnRpbmdGb3JtYXQiLCJtZXNzYWdlIiwiZm9ybWF0Iiwic2V0Iiwidmlld0RvY3VtZW50IiwiY29udGVudHMiLCJkb2MiLCJvcGVuVGV4dERvY3VtZW50IiwibGFuZ3VhZ2UiLCJjb250ZW50IiwiZWRpdG9yIiwic2hvd1RleHREb2N1bWVudCIsIlZpZXdDb2x1bW4iLCJPbmUiLCJlZGl0IiwiZWRpdEJ1aWxkZXIiLCJpbnNlcnQiLCJQb3NpdGlvbiIsImxpbmVDb3VudCIsImRpc3Bvc2FibGUiLCJvbkRpZE9wZW5UZXh0RG9jdW1lbnQiLCJwdXNoIiwicmVnaXN0ZXIiLCJjb21tYW5kTWFuYWdlciIsInJlZ2lzdGVyQ29tbWFuZCIsIkNvbW1hbmRzIiwiU2hvd0hpc3RvcnlQYW5lIiwic2hvd0hpc3RvcnlQYW5lIiwiSW1wb3J0Tm90ZWJvb2siLCJjbWRTb3VyY2UiLCJDb21tYW5kU291cmNlIiwiY29tbWFuZFBhbGV0dGUiLCJmc1BhdGgiLCJpbXBvcnROb3RlYm9vayIsImxvZ0Vycm9yIiwidG9TdHJpbmciLCJhY3RpdmUiLCJzaG93IiwiZmlsdGVyc0tleSIsImltcG9ydERpYWxvZ0ZpbHRlciIsImZpbHRlcnNPYmplY3QiLCJ1cmlzIiwic2hvd09wZW5EaWFsb2ciLCJvcGVuTGFiZWwiLCJpbXBvcnREaWFsb2dUaXRsZSIsImZpbHRlcnMiLCJzdGF0dXMiLCJpbXBvcnRGcm9tRmlsZSIsImRpc3Bvc2UiLCJjYXB0dXJlVGVsZW1ldHJ5IiwiVGVsZW1ldHJ5IiwicHJvdG90eXBlIiwic2NvcGUiLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSURpc3Bvc2FibGVSZWdpc3RyeSIsIklIaXN0b3J5UHJvdmlkZXIiLCJJTm90ZWJvb2tJbXBvcnRlciIsIklEb2N1bWVudE1hbmFnZXIiLCJJQXBwbGljYXRpb25TaGVsbCIsIklMb2dnZXIiLCJJQ29uZmlndXJhdGlvblNlcnZpY2UiLCJJU3RhdHVzUHJvdmlkZXIiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEsTUFBMEJDLENBQUMsR0FBR0gsQ0FBQyxHQUFHLENBQUosR0FBUUgsTUFBUixHQUFpQkUsSUFBSSxLQUFLLElBQVQsR0FBZ0JBLElBQUksR0FBR0ssTUFBTSxDQUFDQyx3QkFBUCxDQUFnQ1IsTUFBaEMsRUFBd0NDLEdBQXhDLENBQXZCLEdBQXNFQyxJQUFySDtBQUFBLE1BQTJITyxDQUEzSDtBQUNBLE1BQUksT0FBT0MsT0FBUCxLQUFtQixRQUFuQixJQUErQixPQUFPQSxPQUFPLENBQUNDLFFBQWYsS0FBNEIsVUFBL0QsRUFBMkVMLENBQUMsR0FBR0ksT0FBTyxDQUFDQyxRQUFSLENBQWlCWixVQUFqQixFQUE2QkMsTUFBN0IsRUFBcUNDLEdBQXJDLEVBQTBDQyxJQUExQyxDQUFKLENBQTNFLEtBQ0ssS0FBSyxJQUFJVSxDQUFDLEdBQUdiLFVBQVUsQ0FBQ00sTUFBWCxHQUFvQixDQUFqQyxFQUFvQ08sQ0FBQyxJQUFJLENBQXpDLEVBQTRDQSxDQUFDLEVBQTdDLEVBQWlELElBQUlILENBQUMsR0FBR1YsVUFBVSxDQUFDYSxDQUFELENBQWxCLEVBQXVCTixDQUFDLEdBQUcsQ0FBQ0gs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TyxDQUFDVyxzQkFBUixHQUFpQ0Esc0JBQWpDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXG4ndXNlIHN0cmljdCc7XG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XG4gICAgdmFyIGMgPSBhcmd1bWVudHMubGVuZ3RoLCByID0gYyA8IDMgPyB0YXJnZXQgOiBkZXNjID09PSBudWxsID8gZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpIDogZGVzYywgZDtcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XG4gICAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjtcbn07XG52YXIgX19wYXJhbSA9ICh0aGlzICYmIHRoaXMuX19wYXJhbSkgfHwgZnVuY3Rpb24gKHBhcmFtSW5kZXgsIGRlY29yYXRvcikge1xuICAgIHJldHVybiBmdW5jdGlvbiAodGFyZ2V0LCBrZXkpIHsgZGVjb3JhdG9yKHRhcmdldCwga2V5LCBwYXJhbUluZGV4KTsgfVxufTtcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XG4gICAgfSk7XG59O1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xucmVxdWlyZShcIi4uL2NvbW1vbi9leHRlbnNpb25zXCIpO1xuY29uc3QgaW52ZXJzaWZ5XzEgPSByZXF1aXJlKFwiaW52ZXJzaWZ5XCIpO1xuY29uc3QgdnNjb2RlXzEgPSByZXF1aXJlKFwidnNjb2RlXCIpO1xuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vYXBwbGljYXRpb24vdHlwZXNcIik7XG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uL2NvbW1vbi90eXBlc1wiKTtcbmNvbnN0IGxvY2FsaXplID0gcmVxdWlyZShcIi4uL2NvbW1vbi91dGlscy9sb2NhbGl6ZVwiKTtcbmNvbnN0IHRlbGVtZXRyeV8xID0gcmVxdWlyZShcIi4uL3RlbGVtZXRyeVwiKTtcbmNvbnN0IGNvbnN0YW50c18xID0gcmVxdWlyZShcIi4uL3VuaXR0ZXN0cy9jb21tb24vY29uc3RhbnRzXCIpO1xuY29uc3QgY29uc3RhbnRzXzIgPSByZXF1aXJlKFwiLi9jb25zdGFudHNcIik7XG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4vdHlwZXNcIik7XG5sZXQgSGlzdG9yeUNvbW1hbmRMaXN0ZW5lciA9IGNsYXNzIEhpc3RvcnlDb21tYW5kTGlzdGVuZXIge1xuICAgIGNvbnN0cnVjdG9yKGRpc3Bvc2FibGVSZWdpc3RyeSwgaGlzdG9yeVByb3ZpZGVyLCBqdXB5dGVySW1wb3J0ZXIsIGRvY3VtZW50TWFuYWdlciwgYXBwbGljYXRpb25TaGVsbCwgbG9nZ2VyLCBjb25maWd1cmF0aW9uLCBzdGF0dXNQcm92aWRlcikge1xuICAgICAgICB0aGlzLmRpc3Bvc2FibGVSZWdpc3RyeSA9IGRpc3Bvc2FibGVSZWdpc3RyeTtcbiAgICAgICAgdGhpcy5oaXN0b3J5UHJvdmlkZXIgPSBoaXN0b3J5UHJvdmlkZXI7XG4gICAgICAgIHRoaXMuanVweXRlckltcG9ydGVyID0ganVweXRlckltcG9ydGVyO1xuICAgICAgICB0aGlzLmRvY3VtZW50TWFuYWdlciA9IGRvY3VtZW50TWFuYWdlcjtcbiAgICAgICAgdGhpcy5hcHBsaWNhdGlvblNoZWxsID0gYXBwbGljYXRpb25TaGVsbDtcbiAgICAgICAgdGhpcy5sb2dnZXIgPSBsb2dnZXI7XG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbiA9IGNvbmZpZ3VyYXRpb247XG4gICAgICAgIHRoaXMuc3RhdHVzUHJvdmlkZXIgPSBzdGF0dXNQcm92aWRlcjtcbiAgICAgICAgdGhpcy5jYW5JbXBvcnRGcm9tT3BlbmVkRmlsZSA9ICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHNldHRpbmdzID0gdGhpcy5jb25maWd1cmF0aW9uLmdldFNldHRpbmdzKCk7XG4gICAgICAgICAgICByZXR1cm4gc2V0dGluZ3MgJiYgKCFzZXR0aW5ncy5kYXRhc2NpZW5jZSB8fCBzZXR0aW5ncy5kYXRhc2NpZW5jZS5hbGxvd0ltcG9ydEZyb21Ob3RlYm9vayk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuZGlzYWJsZUltcG9ydE9uT3BlbmVkRmlsZSA9ICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHNldHRpbmdzID0gdGhpcy5jb25maWd1cmF0aW9uLmdldFNldHRpbmdzKCk7XG4gICAgICAgICAgICBpZiAoc2V0dGluZ3MgJiYgc2V0dGluZ3MuZGF0YXNjaWVuY2UpIHtcbiAgICAgICAgICAgICAgICBzZXR0aW5ncy5kYXRhc2NpZW5jZS5hbGxvd0ltcG9ydEZyb21Ob3RlYm9vayA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLm9uT3BlbmVkRG9jdW1lbnQgPSAoZG9jdW1lbnQpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGlmIChkb2N1bWVudC5maWxlTmFtZS5lbmRzV2l0aCgnLmlweW5iJykgJiYgdGhpcy5jYW5JbXBvcnRGcm9tT3BlbmVkRmlsZSgpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgeWVzID0gbG9jYWxpemUuRGF0YVNjaWVuY2Uubm90ZWJvb2tDaGVja0ZvckltcG9ydFllcygpO1xuICAgICAgICAgICAgICAgIGNvbnN0IG5vID0gbG9jYWxpemUuRGF0YVNjaWVuY2Uubm90ZWJvb2tDaGVja0ZvckltcG9ydE5vKCk7XG4gICAgICAgICAgICAgICAgY29uc3QgZG9udEFza0FnYWluID0gbG9jYWxpemUuRGF0YVNjaWVuY2Uubm90ZWJvb2tDaGVja0ZvckltcG9ydERvbnRBc2tBZ2FpbigpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGFuc3dlciA9IHlpZWxkIHRoaXMuYXBwbGljYXRpb25TaGVsbC5zaG93SW5mb3JtYXRpb25NZXNzYWdlKGxvY2FsaXplLkRhdGFTY2llbmNlLm5vdGVib29rQ2hlY2tGb3JJbXBvcnRUaXRsZSgpLCB5ZXMsIG5vLCBkb250QXNrQWdhaW4pO1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhbnN3ZXIgPT09IHllcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy5pbXBvcnROb3RlYm9va09uRmlsZShkb2N1bWVudC5maWxlTmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYW5zd2VyID09PSBkb250QXNrQWdhaW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGlzYWJsZUltcG9ydE9uT3BlbmVkRmlsZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBsaWNhdGlvblNoZWxsLnNob3dFcnJvck1lc3NhZ2UoZXJyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnNldEltcG9ydFN0YXR1cyA9IChmaWxlKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBmb3JtYXRTdHJpbmcgPSBsb2NhbGl6ZS5EYXRhU2NpZW5jZS5pbXBvcnRpbmdGb3JtYXQoKTtcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBmb3JtYXRTdHJpbmcuZm9ybWF0KGZpbGUpO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RhdHVzUHJvdmlkZXIuc2V0KG1lc3NhZ2UsIG51bGwpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLnZpZXdEb2N1bWVudCA9IChjb250ZW50cykgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgZG9jID0geWllbGQgdGhpcy5kb2N1bWVudE1hbmFnZXIub3BlblRleHREb2N1bWVudCh7IGxhbmd1YWdlOiAncHl0aG9uJywgY29udGVudDogY29udGVudHMgfSk7XG4gICAgICAgICAgICBjb25zdCBlZGl0b3IgPSB5aWVsZCB0aGlzLmRvY3VtZW50TWFuYWdlci5zaG93VGV4dERvY3VtZW50KGRvYywgdnNjb2RlXzEuVmlld0NvbHVtbi5PbmUpO1xuICAgICAgICAgICAgLy8gRWRpdCB0aGUgZG9jdW1lbnQgc28gdGhhdCBpdCBpcyBkaXJ0eSAoYWRkIGEgc3BhY2UgYXQgdGhlIGVuZClcbiAgICAgICAgICAgIGVkaXRvci5lZGl0KChlZGl0QnVpbGRlcikgPT4ge1xuICAgICAgICAgICAgICAgIGVkaXRCdWlsZGVyLmluc2VydChuZXcgdnNjb2RlXzEuUG9zaXRpb24oZWRpdG9yLmRvY3VtZW50LmxpbmVDb3VudCwgMCksICdcXG4nKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgLy8gTGlzdGVuIHRvIGRvY3VtZW50IG9wZW4gY29tbWFuZHMuIFdlIHdhbnQgdG8gYXNrIHRoZSB1c2VyIGlmIHRoZXkgd2FudCB0byBpbXBvcnQuXG4gICAgICAgIGNvbnN0IGRpc3Bvc2FibGUgPSB0aGlzLmRvY3VtZW50TWFuYWdlci5vbkRpZE9wZW5UZXh0RG9jdW1lbnQodGhpcy5vbk9wZW5lZERvY3VtZW50KTtcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlUmVnaXN0cnkucHVzaChkaXNwb3NhYmxlKTtcbiAgICB9XG4gICAgcmVnaXN0ZXIoY29tbWFuZE1hbmFnZXIpIHtcbiAgICAgICAgbGV0IGRpc3Bvc2FibGUgPSBjb21tYW5kTWFuYWdlci5yZWdpc3RlckNvbW1hbmQoY29uc3RhbnRzXzIuQ29tbWFuZHMuU2hvd0hpc3RvcnlQYW5lLCAoKSA9PiB0aGlzLnNob3dIaXN0b3J5UGFuZSgpKTtcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlUmVnaXN0cnkucHVzaChkaXNwb3NhYmxlKTtcbiAgICAgICAgZGlzcG9zYWJsZSA9IGNvbW1hbmRNYW5hZ2VyLnJlZ2lzdGVyQ29tbWFuZChjb25zdGFudHNfMi5Db21tYW5kcy5JbXBvcnROb3RlYm9vaywgKGZpbGUsIGNtZFNvdXJjZSA9IGNvbnN0YW50c18xLkNvbW1hbmRTb3VyY2UuY29tbWFuZFBhbGV0dGUpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgaWYgKGZpbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy5pbXBvcnROb3RlYm9va09uRmlsZShmaWxlLmZzUGF0aCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmltcG9ydE5vdGVib29rKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICAgIGlmIChlcnIubWVzc2FnZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ2dlci5sb2dFcnJvcihlcnIubWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbGljYXRpb25TaGVsbC5zaG93RXJyb3JNZXNzYWdlKGVyci5tZXNzYWdlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nZ2VyLmxvZ0Vycm9yKGVyci50b1N0cmluZygpKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBsaWNhdGlvblNoZWxsLnNob3dFcnJvck1lc3NhZ2UoZXJyLnRvU3RyaW5nKCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSkpO1xuICAgICAgICB0aGlzLmRpc3Bvc2FibGVSZWdpc3RyeS5wdXNoKGRpc3Bvc2FibGUpO1xuICAgIH1cbiAgICBzaG93SGlzdG9yeVBhbmUoKSB7XG4gICAgICAgIGNvbnN0IGFjdGl2ZSA9IHRoaXMuaGlzdG9yeVByb3ZpZGVyLmFjdGl2ZTtcbiAgICAgICAgcmV0dXJuIGFjdGl2ZS5zaG93KCk7XG4gICAgfVxuICAgIGltcG9ydE5vdGVib29rKCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgZmlsdGVyc0tleSA9IGxvY2FsaXplLkRhdGFTY2llbmNlLmltcG9ydERpYWxvZ0ZpbHRlcigpO1xuICAgICAgICAgICAgY29uc3QgZmlsdGVyc09iamVjdCA9IHt9O1xuICAgICAgICAgICAgZmlsdGVyc09iamVjdFtmaWx0ZXJzS2V5XSA9IFsnaXB5bmInXTtcbiAgICAgICAgICAgIGNvbnN0IHVyaXMgPSB5aWVsZCB0aGlzLmFwcGxpY2F0aW9uU2hlbGwuc2hvd09wZW5EaWFsb2coe1xuICAgICAgICAgICAgICAgIG9wZW5MYWJlbDogbG9jYWxpemUuRGF0YVNjaWVuY2UuaW1wb3J0RGlhbG9nVGl0bGUoKSxcbiAgICAgICAgICAgICAgICBmaWx0ZXJzOiBmaWx0ZXJzT2JqZWN0XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGlmICh1cmlzICYmIHVyaXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHN0YXR1cyA9IHRoaXMuc2V0SW1wb3J0U3RhdHVzKHVyaXNbMF0uZnNQYXRoKTtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjb250ZW50cyA9IHlpZWxkIHRoaXMuanVweXRlckltcG9ydGVyLmltcG9ydEZyb21GaWxlKHVyaXNbMF0uZnNQYXRoKTtcbiAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy52aWV3RG9jdW1lbnQoY29udGVudHMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZmluYWxseSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXR1cy5kaXNwb3NlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgaW1wb3J0Tm90ZWJvb2tPbkZpbGUoZmlsZSkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgaWYgKGZpbGUgJiYgZmlsZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc3RhdHVzID0gdGhpcy5zZXRJbXBvcnRTdGF0dXMoZmlsZSk7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udGVudHMgPSB5aWVsZCB0aGlzLmp1cHl0ZXJJbXBvcnRlci5pbXBvcnRGcm9tRmlsZShmaWxlKTtcbiAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy52aWV3RG9jdW1lbnQoY29udGVudHMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZmluYWxseSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXR1cy5kaXNwb3NlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG59O1xuX19kZWNvcmF0ZShbXG4gICAgdGVsZW1ldHJ5XzEuY2FwdHVyZVRlbGVtZXRyeShjb25zdGFudHNfMi5UZWxlbWV0cnkuU2hvd0hpc3RvcnlQYW5lLCB7fSwgZmFsc2UpXG5dLCBIaXN0b3J5Q29tbWFuZExpc3RlbmVyLnByb3RvdHlwZSwgXCJzaG93SGlzdG9yeVBhbmVcIiwgbnVsbCk7XG5fX2RlY29yYXRlKFtcbiAgICB0ZWxlbWV0cnlfMS5jYXB0dXJlVGVsZW1ldHJ5KGNvbnN0YW50c18yLlRlbGVtZXRyeS5JbXBvcnROb3RlYm9vaywgeyBzY29wZTogJ2NvbW1hbmQnIH0sIGZhbHNlKVxuXSwgSGlzdG9yeUNvbW1hbmRMaXN0ZW5lci5wcm90b3R5cGUsIFwiaW1wb3J0Tm90ZWJvb2tcIiwgbnVsbCk7XG5fX2RlY29yYXRlKFtcbiAgICB0ZWxlbWV0cnlfMS5jYXB0dXJlVGVsZW1ldHJ5KGNvbnN0YW50c18yLlRlbGVtZXRyeS5JbXBvcnROb3RlYm9vaywgeyBzY29wZTogJ2ZpbGUnIH0sIGZhbHNlKVxuXSwgSGlzdG9yeUNvbW1hbmRMaXN0ZW5lci5wcm90b3R5cGUsIFwiaW1wb3J0Tm90ZWJvb2tPbkZpbGVcIiwgbnVsbCk7XG5IaXN0b3J5Q29tbWFuZExpc3RlbmVyID0gX19kZWNvcmF0ZShbXG4gICAgaW52ZXJzaWZ5XzEuaW5qZWN0YWJsZSgpLFxuICAgIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzIuSURpc3Bvc2FibGVSZWdpc3RyeSkpLFxuICAgIF9fcGFyYW0oMSwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzMuSUhpc3RvcnlQcm92aWRlcikpLFxuICAgIF9fcGFyYW0oMiwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzMuSU5vdGVib29rSW1wb3J0ZXIpKSxcbiAgICBfX3BhcmFtKDMsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18xLklEb2N1bWVudE1hbmFnZXIpKSxcbiAgICBfX3BhcmFtKDQsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18xLklBcHBsaWNhdGlvblNoZWxsKSksXG4gICAgX19wYXJhbSg1LCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMi5JTG9nZ2VyKSksXG4gICAgX19wYXJhbSg2LCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMi5JQ29uZmlndXJhdGlvblNlcnZpY2UpKSxcbiAgICBfX3BhcmFtKDcsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18zLklTdGF0dXNQcm92aWRlcikpXG5dLCBIaXN0b3J5Q29tbWFuZExpc3RlbmVyKTtcbmV4cG9ydHMuSGlzdG9yeUNvbW1hbmRMaXN0ZW5lciA9IEhpc3RvcnlDb21tYW5kTGlzdGVuZXI7XG4vLyMgc291cmNlTWFwcGluZ1VSTD1oaXN0b3J5Y29tbWFuZGxpc3RlbmVyLmpzLm1hcCJdfQ==