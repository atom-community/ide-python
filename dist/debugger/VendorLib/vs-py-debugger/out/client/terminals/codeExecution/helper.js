"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const path = require("path");

const vscode_1 = require("vscode");

const types_1 = require("../../common/application/types");

const constants_1 = require("../../common/constants");

require("../../common/extensions");

const types_2 = require("../../common/process/types");

const types_3 = require("../../common/types");

const types_4 = require("../../ioc/types");

let CodeExecutionHelper = class CodeExecutionHelper {
  constructor(serviceContainer) {
    this.documentManager = serviceContainer.get(types_1.IDocumentManager);
    this.applicationShell = serviceContainer.get(types_1.IApplicationShell);
    this.processServiceFactory = serviceContainer.get(types_2.IProcessServiceFactory);
    this.configurationService = serviceContainer.get(types_3.IConfigurationService);
  }

  normalizeLines(code, resource) {
    return __awaiter(this, void 0, void 0, function* () {
      try {
        if (code.trim().length === 0) {
          return '';
        }

        const pythonPath = this.configurationService.getSettings(resource).pythonPath;
        const args = [path.join(constants_1.EXTENSION_ROOT_DIR, 'pythonFiles', 'normalizeForInterpreter.py'), code];
        const processService = yield this.processServiceFactory.create(resource);
        const proc = yield processService.exec(pythonPath, args, {
          throwOnStdErr: true
        });
        return proc.stdout;
      } catch (ex) {
        console.error(ex, 'Python: Failed to normalize code for execution in terminal');
        return code;
      }
    });
  }

  getFileToExecute() {
    return __awaiter(this, void 0, void 0, function* () {
      const activeEditor = this.documentManager.activeTextEditor;

      if (!activeEditor) {
        this.applicationShell.showErrorMessage('No open file to run in terminal');
        return;
      }

      if (activeEditor.document.isUntitled) {
        this.applicationShell.showErrorMessage('The active file needs to be saved before it can be run');
        return;
      }

      if (activeEditor.document.languageId !== constants_1.PYTHON_LANGUAGE) {
        this.applicationShell.showErrorMessage('The active file is not a Python source file');
        return;
      }

      if (activeEditor.document.isDirty) {
        yield activeEditor.document.save();
      }

      return activeEditor.document.uri;
    });
  }

  getSelectedTextToExecute(textEditor) {
    return __awaiter(this, void 0, void 0, function* () {
      if (!textEditor) {
        return;
      }

      const selection = textEditor.selection;
      let code;

      if (selection.isEmpty) {
        code = textEditor.document.lineAt(selection.start.line).text;
      } else {
        const textRange = new vscode_1.Range(selection.start, selection.end);
        code = textEditor.document.getText(textRange);
      }

      return code;
    });
  }

  saveFileIfDirty(file) {
    return __awaiter(this, void 0, void 0, function* () {
      const docs = this.documentManager.textDocuments.filter(d => d.uri.path === file.path);

      if (docs.length === 1 && docs[0].isDirty) {
        yield docs[0].save();
      }
    });
  }

};
CodeExecutionHelper = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_4.IServiceContainer))], CodeExecutionHelper);
exports.CodeExecutionHelper = CodeExecutionHelper;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhlbHBlci5qcyJdLCJuYW1lcyI6WyJfX2RlY29yYXRlIiwiZGVjb3JhdG9ycyIsInRhcmdldCIsImtleSIsImRlc2MiLCJjIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImQiLCJSZWZsZWN0IiwiZGVjb3JhdGUiLCJpIiwiZGVmaW5lUHJvcGVydHkiLCJfX3BhcmFtIiwicGFyYW1JbmRleCIsImRlY29yYXRvciIsIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJleHBvcnRzIiwiaW52ZXJzaWZ5XzEiLCJyZXF1aXJlIiwicGF0aCIsInZzY29kZV8xIiwidHlwZXNfMSIsImNvbnN0YW50c18xIiwidHlwZXNfMiIsInR5cGVzXzMiLCJ0eXBlc180IiwiQ29kZUV4ZWN1dGlvbkhlbHBlciIsImNvbnN0cnVjdG9yIiwic2VydmljZUNvbnRhaW5lciIsImRvY3VtZW50TWFuYWdlciIsImdldCIsIklEb2N1bWVudE1hbmFnZXIiLCJhcHBsaWNhdGlvblNoZWxsIiwiSUFwcGxpY2F0aW9uU2hlbGwiLCJwcm9jZXNzU2VydmljZUZhY3RvcnkiLCJJUHJvY2Vzc1NlcnZpY2VGYWN0b3J5IiwiY29uZmlndXJhdGlvblNlcnZpY2UiLCJJQ29uZmlndXJhdGlvblNlcnZpY2UiLCJub3JtYWxpemVMaW5lcyIsImNvZGUiLCJyZXNvdXJjZSIsInRyaW0iLCJweXRob25QYXRoIiwiZ2V0U2V0dGluZ3MiLCJhcmdzIiwiam9pbiIsIkVYVEVOU0lPTl9ST09UX0RJUiIsInByb2Nlc3NTZXJ2aWNlIiwiY3JlYXRlIiwicHJvYyIsImV4ZWMiLCJ0aHJvd09uU3RkRXJyIiwic3Rkb3V0IiwiZXgiLCJjb25zb2xlIiwiZXJyb3IiLCJnZXRGaWxlVG9FeGVjdXRlIiwiYWN0aXZlRWRpdG9yIiwiYWN0aXZlVGV4dEVkaXRvciIsInNob3dFcnJvck1lc3NhZ2UiLCJkb2N1bWVudCIsImlzVW50aXRsZWQiLCJsYW5ndWFnZUlkIiwiUFlUSE9OX0xBTkdVQUdFIiwiaXNEaXJ0eSIsInNhdmUiLCJ1cmkiLCJnZXRTZWxlY3RlZFRleHRUb0V4ZWN1dGUiLCJ0ZXh0RWRpdG9yIiwic2VsZWN0aW9uIiwiaXNFbXB0eSIsImxpbmVBdCIsInN0YXJ0IiwibGluZSIsInRleHQiLCJ0ZXh0UmFuZ2UiLCJSYW5nZSIsImVuZCIsImdldFRleHQiLCJzYXZlRmlsZUlmRGlydHkiLCJmaWxlIiwiZG9jcyIsInRleHREb2N1bWVudHMiLCJmaWx0ZXIiLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSVNlcnZpY2VDb250YWluZXIiXSwibWFwcGluZ3MiOiJBQUFBLGEsQ0FDQTtBQUNBOztBQUNBLElBQUlBLFVBQVUsR0FBSSxVQUFRLFNBQUtBLFVBQWQsSUFBNkIsVUFBVUMsVUFBVixFQUFzQkMsTUFBdEIsRUFBOEJDLEdBQTlCLEVBQW1DQyxJQUFuQyxFQUF5QztBQUNuRixNQUFJQyxDQUFDLEdBQUdDLFNBQVMsQ0FBQ0MsTUFBbEI7QUFBQSxNQUEwQkMsQ0FBQyxHQUFHSCxDQUFDLEdBQUcsQ0FBSixHQUFRSCxNQUFSLEdBQWlCRSxJQUFJLEtBQUssSUFBVCxHQUFnQkEsSUFBSSxHQUFHSyxNQUFNLENBQUNDLHdCQUFQLENBQWdDUixNQUFoQyxFQUF3Q0MsR0FBeEMsQ0FBdkIsR0FBc0VDLElBQXJIO0FBQUEsTUFBMkhPLENBQTNIO0FBQ0EsTUFBSSxPQUFPQyxPQUFQLEtBQW1CLFFBQW5CLElBQStCLE9BQU9BLE9BQU8sQ0FBQ0MsUUFBZixLQUE0QixVQUEvRCxFQUEyRUwsQ0FBQyxHQUFHSSxPQUFPLENBQUNDLFFBQVIsQ0FBaUJaLFVBQWpCLEVBQTZCQyxNQUE3QixFQUFxQ0MsR0FBckMsRUFBMEND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cEIsRUFBdUIsYUFBYTtBQUNoRCxZQUFNbUYsSUFBSSxHQUFHLEtBQUtwRCxlQUFMLENBQXFCcUQsYUFBckIsQ0FBbUNDLE1BQW5DLENBQTBDN0YsQ0FBQyxJQUFJQSxDQUFDLENBQUM0RSxHQUFGLENBQU0vQyxJQUFOLEtBQWU2RCxJQUFJLENBQUM3RCxJQUFuRSxDQUFiOztBQUNBLFVBQUk4RCxJQUFJLENBQUMvRixNQUFMLEtBQWdCLENBQWhCLElBQXFCK0YsSUFBSSxDQUFDLENBQUQsQ0FBSixDQUFRakIsT0FBakMsRUFBMEM7QUFDdEMsY0FBTWlCLElBQUksQ0FBQyxDQUFELENBQUosQ0FBUWhCLElBQVIsRUFBTjtBQUNIO0FBQ0osS0FMZSxDQUFoQjtBQU1IOztBQXRFK0MsQ0FBcEQ7QUF3RUF2QyxtQkFBbUIsR0FBRy9DLFVBQVUsQ0FBQyxDQUM3QnNDLFdBQVcsQ0FBQ21FLFVBQVosRUFENkIsRUFFN0J6RixPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDb0UsTUFBWixDQUFtQjVELE9BQU8sQ0FBQzZELGlCQUEzQixDQUFKLENBRnNCLENBQUQsRUFHN0I1RCxtQkFINkIsQ0FBaEM7QUFJQVYsT0FBTyxDQUFDVSxtQkFBUixHQUE4QkEsbUJBQTlCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG4vLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xuICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xufTtcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQsIGtleSkgeyBkZWNvcmF0b3IodGFyZ2V0LCBrZXksIHBhcmFtSW5kZXgpOyB9XG59O1xudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcbiAgICB9KTtcbn07XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5jb25zdCBpbnZlcnNpZnlfMSA9IHJlcXVpcmUoXCJpbnZlcnNpZnlcIik7XG5jb25zdCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XG5jb25zdCB2c2NvZGVfMSA9IHJlcXVpcmUoXCJ2c2NvZGVcIik7XG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uLy4uL2NvbW1vbi9hcHBsaWNhdGlvbi90eXBlc1wiKTtcbmNvbnN0IGNvbnN0YW50c18xID0gcmVxdWlyZShcIi4uLy4uL2NvbW1vbi9jb25zdGFudHNcIik7XG5yZXF1aXJlKFwiLi4vLi4vY29tbW9uL2V4dGVuc2lvbnNcIik7XG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uLy4uL2NvbW1vbi9wcm9jZXNzL3R5cGVzXCIpO1xuY29uc3QgdHlwZXNfMyA9IHJlcXVpcmUoXCIuLi8uLi9jb21tb24vdHlwZXNcIik7XG5jb25zdCB0eXBlc180ID0gcmVxdWlyZShcIi4uLy4uL2lvYy90eXBlc1wiKTtcbmxldCBDb2RlRXhlY3V0aW9uSGVscGVyID0gY2xhc3MgQ29kZUV4ZWN1dGlvbkhlbHBlciB7XG4gICAgY29uc3RydWN0b3Ioc2VydmljZUNvbnRhaW5lcikge1xuICAgICAgICB0aGlzLmRvY3VtZW50TWFuYWdlciA9IHNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSURvY3VtZW50TWFuYWdlcik7XG4gICAgICAgIHRoaXMuYXBwbGljYXRpb25TaGVsbCA9IHNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSUFwcGxpY2F0aW9uU2hlbGwpO1xuICAgICAgICB0aGlzLnByb2Nlc3NTZXJ2aWNlRmFjdG9yeSA9IHNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzIuSVByb2Nlc3NTZXJ2aWNlRmFjdG9yeSk7XG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvblNlcnZpY2UgPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18zLklDb25maWd1cmF0aW9uU2VydmljZSk7XG4gICAgfVxuICAgIG5vcm1hbGl6ZUxpbmVzKGNvZGUsIHJlc291cmNlKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGlmIChjb2RlLnRyaW0oKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb25zdCBweXRob25QYXRoID0gdGhpcy5jb25maWd1cmF0aW9uU2VydmljZS5nZXRTZXR0aW5ncyhyZXNvdXJjZSkucHl0aG9uUGF0aDtcbiAgICAgICAgICAgICAgICBjb25zdCBhcmdzID0gW3BhdGguam9pbihjb25zdGFudHNfMS5FWFRFTlNJT05fUk9PVF9ESVIsICdweXRob25GaWxlcycsICdub3JtYWxpemVGb3JJbnRlcnByZXRlci5weScpLCBjb2RlXTtcbiAgICAgICAgICAgICAgICBjb25zdCBwcm9jZXNzU2VydmljZSA9IHlpZWxkIHRoaXMucHJvY2Vzc1NlcnZpY2VGYWN0b3J5LmNyZWF0ZShyZXNvdXJjZSk7XG4gICAgICAgICAgICAgICAgY29uc3QgcHJvYyA9IHlpZWxkIHByb2Nlc3NTZXJ2aWNlLmV4ZWMocHl0aG9uUGF0aCwgYXJncywgeyB0aHJvd09uU3RkRXJyOiB0cnVlIH0pO1xuICAgICAgICAgICAgICAgIHJldHVybiBwcm9jLnN0ZG91dDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChleCkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXgsICdQeXRob246IEZhaWxlZCB0byBub3JtYWxpemUgY29kZSBmb3IgZXhlY3V0aW9uIGluIHRlcm1pbmFsJyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvZGU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBnZXRGaWxlVG9FeGVjdXRlKCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgYWN0aXZlRWRpdG9yID0gdGhpcy5kb2N1bWVudE1hbmFnZXIuYWN0aXZlVGV4dEVkaXRvcjtcbiAgICAgICAgICAgIGlmICghYWN0aXZlRWRpdG9yKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcHBsaWNhdGlvblNoZWxsLnNob3dFcnJvck1lc3NhZ2UoJ05vIG9wZW4gZmlsZSB0byBydW4gaW4gdGVybWluYWwnKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYWN0aXZlRWRpdG9yLmRvY3VtZW50LmlzVW50aXRsZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFwcGxpY2F0aW9uU2hlbGwuc2hvd0Vycm9yTWVzc2FnZSgnVGhlIGFjdGl2ZSBmaWxlIG5lZWRzIHRvIGJlIHNhdmVkIGJlZm9yZSBpdCBjYW4gYmUgcnVuJyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGFjdGl2ZUVkaXRvci5kb2N1bWVudC5sYW5ndWFnZUlkICE9PSBjb25zdGFudHNfMS5QWVRIT05fTEFOR1VBR0UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFwcGxpY2F0aW9uU2hlbGwuc2hvd0Vycm9yTWVzc2FnZSgnVGhlIGFjdGl2ZSBmaWxlIGlzIG5vdCBhIFB5dGhvbiBzb3VyY2UgZmlsZScpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChhY3RpdmVFZGl0b3IuZG9jdW1lbnQuaXNEaXJ0eSkge1xuICAgICAgICAgICAgICAgIHlpZWxkIGFjdGl2ZUVkaXRvci5kb2N1bWVudC5zYXZlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gYWN0aXZlRWRpdG9yLmRvY3VtZW50LnVyaTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGdldFNlbGVjdGVkVGV4dFRvRXhlY3V0ZSh0ZXh0RWRpdG9yKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBpZiAoIXRleHRFZGl0b3IpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBzZWxlY3Rpb24gPSB0ZXh0RWRpdG9yLnNlbGVjdGlvbjtcbiAgICAgICAgICAgIGxldCBjb2RlO1xuICAgICAgICAgICAgaWYgKHNlbGVjdGlvbi5pc0VtcHR5KSB7XG4gICAgICAgICAgICAgICAgY29kZSA9IHRleHRFZGl0b3IuZG9jdW1lbnQubGluZUF0KHNlbGVjdGlvbi5zdGFydC5saW5lKS50ZXh0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdGV4dFJhbmdlID0gbmV3IHZzY29kZV8xLlJhbmdlKHNlbGVjdGlvbi5zdGFydCwgc2VsZWN0aW9uLmVuZCk7XG4gICAgICAgICAgICAgICAgY29kZSA9IHRleHRFZGl0b3IuZG9jdW1lbnQuZ2V0VGV4dCh0ZXh0UmFuZ2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGNvZGU7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBzYXZlRmlsZUlmRGlydHkoZmlsZSkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgZG9jcyA9IHRoaXMuZG9jdW1lbnRNYW5hZ2VyLnRleHREb2N1bWVudHMuZmlsdGVyKGQgPT4gZC51cmkucGF0aCA9PT0gZmlsZS5wYXRoKTtcbiAgICAgICAgICAgIGlmIChkb2NzLmxlbmd0aCA9PT0gMSAmJiBkb2NzWzBdLmlzRGlydHkpIHtcbiAgICAgICAgICAgICAgICB5aWVsZCBkb2NzWzBdLnNhdmUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufTtcbkNvZGVFeGVjdXRpb25IZWxwZXIgPSBfX2RlY29yYXRlKFtcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKCksXG4gICAgX19wYXJhbSgwLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfNC5JU2VydmljZUNvbnRhaW5lcikpXG5dLCBDb2RlRXhlY3V0aW9uSGVscGVyKTtcbmV4cG9ydHMuQ29kZUV4ZWN1dGlvbkhlbHBlciA9IENvZGVFeGVjdXRpb25IZWxwZXI7XG4vLyMgc291cmNlTWFwcGluZ1VSTD1oZWxwZXIuanMubWFwIl19