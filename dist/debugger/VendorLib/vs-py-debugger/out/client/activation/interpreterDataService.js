"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const crypto_1 = require("crypto");

const fs = require("fs");

const path = require("path");

const types_1 = require("../common/application/types");

require("../common/extensions");

const types_2 = require("../common/platform/types");

const types_3 = require("../common/process/types");

const async_1 = require("../common/utils/async");

const DataVersion = 1;

class InterpreterData {
  constructor(dataVersion, // tslint:disable-next-line:no-shadowed-variable
  path, version, searchPaths, hash) {
    this.dataVersion = dataVersion;
    this.path = path;
    this.version = version;
    this.searchPaths = searchPaths;
    this.hash = hash;
  }

}

exports.InterpreterData = InterpreterData;

class InterpreterDataService {
  constructor(context, serviceContainer) {
    this.context = context;
    this.serviceContainer = serviceContainer;
  }

  getInterpreterData(resource) {
    return __awaiter(this, void 0, void 0, function* () {
      const executionFactory = this.serviceContainer.get(types_3.IPythonExecutionFactory);
      const execService = yield executionFactory.create({
        resource
      });
      const interpreterPath = yield execService.getExecutablePath();

      if (interpreterPath.length === 0) {
        return;
      }

      const cacheKey = `InterpreterData-${interpreterPath}`;
      let interpreterData = this.context.globalState.get(cacheKey);
      let interpreterChanged = false;

      if (interpreterData) {
        // Check if interpreter executable changed
        if (interpreterData.dataVersion !== DataVersion) {
          interpreterChanged = true;
        } else {
          const currentHash = yield this.getInterpreterHash(interpreterPath);
          interpreterChanged = currentHash !== interpreterData.hash;
        }
      }

      if (interpreterChanged || !interpreterData) {
        interpreterData = yield this.getInterpreterDataFromPython(execService, interpreterPath);
        this.context.globalState.update(interpreterPath, interpreterData);
      } else {
        // Make sure we verify that search paths did not change. This must be done
        // completely async so we don't delay Python language server startup.
        this.verifySearchPaths(interpreterData.searchPaths, interpreterPath, execService);
      }

      return interpreterData;
    });
  }

  getInterpreterHash(interpreterPath) {
    const platform = this.serviceContainer.get(types_2.IPlatformService);
    const pythonExecutable = path.join(path.dirname(interpreterPath), platform.isWindows ? 'python.exe' : 'python'); // Hash mod time and creation time

    const deferred = async_1.createDeferred();
    fs.lstat(pythonExecutable, (err, stats) => {
      if (err) {
        deferred.resolve('');
      } else {
        const actual = crypto_1.createHash('sha512').update(`${stats.ctime}-${stats.mtime}`).digest('hex');
        deferred.resolve(actual);
      }
    });
    return deferred.promise;
  }

  getInterpreterDataFromPython(execService, interpreterPath) {
    return __awaiter(this, void 0, void 0, function* () {
      const result = yield execService.exec(['-c', 'import sys; print(sys.version_info)'], {}); // sys.version_info(major=3, minor=6, micro=6, releaselevel='final', serial=0)

      if (!result.stdout) {
        throw Error('Unable to determine Python interpreter version and system prefix.');
      }

      const output = result.stdout.splitLines({
        removeEmptyEntries: true,
        trim: true
      });

      if (!output || output.length < 1) {
        throw Error('Unable to parse version and and system prefix from the Python interpreter output.');
      }

      const majorMatches = output[0].match(/major=(\d*?),/);
      const minorMatches = output[0].match(/minor=(\d*?),/);

      if (!majorMatches || majorMatches.length < 2 || !minorMatches || minorMatches.length < 2) {
        throw Error('Unable to parse interpreter version.');
      }

      const hash = yield this.getInterpreterHash(interpreterPath);
      const searchPaths = yield this.getSearchPaths(execService);
      return new InterpreterData(DataVersion, interpreterPath, `${majorMatches[1]}.${minorMatches[1]}`, searchPaths, hash);
    });
  }

  getSearchPaths(execService) {
    return __awaiter(this, void 0, void 0, function* () {
      const result = yield execService.exec(['-c', 'import sys; import os; print(sys.path + os.getenv("PYTHONPATH", "").split(os.pathsep));'], {});

      if (!result.stdout) {
        throw Error('Unable to determine Python interpreter search paths.');
      } // tslint:disable-next-line:no-unnecessary-local-variable


      const paths = result.stdout.split(',').filter(p => this.isValidPath(p)).map(p => this.pathCleanup(p));
      return paths.join(';'); // PTVS uses ; on all platforms
    });
  }

  pathCleanup(s) {
    s = s.trim();

    if (s[0] === '\'') {
      s = s.substr(1);
    }

    if (s[s.length - 1] === ']') {
      s = s.substr(0, s.length - 1);
    }

    if (s[s.length - 1] === '\'') {
      s = s.substr(0, s.length - 1);
    }

    return s;
  }

  isValidPath(s) {
    return s.length > 0 && s[0] !== '[';
  }

  verifySearchPaths(currentPaths, interpreterPath, execService) {
    this.getSearchPaths(execService).then(paths => __awaiter(this, void 0, void 0, function* () {
      if (paths !== currentPaths) {
        this.context.globalState.update(interpreterPath, undefined);
        const appShell = this.serviceContainer.get(types_1.IApplicationShell);
        yield appShell.showWarningMessage('Search paths have changed for this Python interpreter. Please reload the extension to ensure that the IntelliSense works correctly.');
      }
    })).ignoreErrors();
  }

}

exports.InterpreterDataService = InterpreterDataService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImludGVycHJldGVyRGF0YVNlcnZpY2UuanMiXSwibmFtZXMiOlsiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsImNyeXB0b18xIiwicmVxdWlyZSIsImZzIiwicGF0aCIsInR5cGVzXzEiLCJ0eXBlc18yIiwidHlwZXNfMyIsImFzeW5jXzEiLCJEYXRhVmVyc2lvbiIsIkludGVycHJldGVyRGF0YSIsImNvbnN0cnVjdG9yIiwiZGF0YVZlcnNpb24iLCJ2ZXJzaW9uIiwic2VhcmNoUGF0aHMiLCJoYXNoIiwiSW50ZXJwcmV0ZXJEYXRhU2VydmljZSIsImNvbnRleHQiLCJzZXJ2aWNlQ29udGFpbmVyIiwiZ2V0SW50ZXJwcmV0ZXJEYXRhIiwicmVzb3VyY2UiLCJleGVjdXRpb25GYWN0b3J5IiwiZ2V0IiwiSVB5dGhvbkV4ZWN1dGlvbkZhY3RvcnkiLCJleGVjU2VydmljZSIsImNyZWF0ZSIsImludGVycHJldGVyUGF0aCIsImdldEV4ZWN1dGFibGVQYXRoIiwibGVuZ3RoIiwiY2FjaGVLZXkiLCJpbnRlcnByZXRlckRhdGEiLCJnbG9iYWxTdGF0ZSIsImludGVycHJldGVyQ2hhbmdlZCIsImN1cnJlbnRIYXNoIiwiZ2V0SW50ZXJwcmV0ZXJIYXNoIiwiZ2V0SW50ZXJwcmV0ZXJEYXRhRnJvbVB5dGhvbiIsInVwZGF0ZSIsInZlcmlmeVNlYXJjaFBhdGhzIiwicGxhdGZvcm0iLCJJUGxhdGZvcm1TZXJ2aWNlIiwicHl0aG9uRXhlY3V0YWJsZSIsImpvaW4iLCJkaXJuYW1lIiwiaXNXaW5kb3dzIiwiZGVmZXJyZWQiLCJjcmVhdGVEZWZlcnJlZCIsImxzdGF0IiwiZXJyIiwic3RhdHMiLCJhY3R1YWwiLCJjcmVhdGVIYXNoIiwiY3RpbWUiLCJtdGltZSIsImRpZ2VzdCIsInByb21pc2UiLCJleGVjIiwic3Rkb3V0IiwiRXJyb3IiLCJvdXRwdXQiLCJzcGxpdExpbmVzIiwicmVtb3ZlRW1wdHlFbnRyaWVzIiwidHJpbSIsIm1ham9yTWF0Y2hlcyIsIm1hdGNoIiwibWlub3JNYXRjaGVzIiwiZ2V0U2VhcmNoUGF0aHMiLCJwYXRocyIsInNwbGl0IiwiZmlsdGVyIiwicCIsImlzVmFsaWRQYXRoIiwibWFwIiwicGF0aENsZWFudXAiLCJzIiwic3Vic3RyIiwiY3VycmVudFBhdGhzIiwidW5kZWZpbmVkIiwiYXBwU2hlbGwiLCJJQXBwbGljYXRpb25TaGVsbCIsInNob3dXYXJuaW5nTWVzc2FnZSIsImlnbm9yZUVycm9ycyJdLCJtYXBwaW5ncyI6IkFBQUEsYSxDQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FBL0IsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3JGLFNBQU8sS0FBS0QsQ0FBQyxLQUFLQSxDQUFDLEdBQUdFLE9BQVQsQ0FBTixFQUF5QixVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUN2RCxhQUFTQyxTQUFULENBQW1CQyxLQUFuQixFQUEwQjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUNPLElBQVYsQ0FBZUYsS0FBZixDQUFELENBQUo7QUFBOEIsT0FBcEMsQ0FBcUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDM0YsYUFBU0MsUUFBVCxDQUFrQkosS0FBbEIsRUFBeUI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDLE9BQUQsQ0FBVCxDQUFtQkssS0FBbkIsQ0FBRCxDQUFKO0FBQWtDLE9BQXhDLENBQXlD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QUk7QUFDWCxXQUFPQSxDQUFDLENBQUM3QyxNQUFGLEdBQVcsQ0FBWCxJQUFnQjZDLENBQUMsQ0FBQyxDQUFELENBQUQsS0FBUyxHQUFoQztBQUNIOztBQUNEcEMsRUFBQUEsaUJBQWlCLENBQUNzQyxZQUFELEVBQWVqRCxlQUFmLEVBQWdDRixXQUFoQyxFQUE2QztBQUMxRCxTQUFLeUMsY0FBTCxDQUFvQnpDLFdBQXBCLEVBQ0s1QixJQURMLENBQ1dzRSxLQUFELElBQVd0RixTQUFTLENBQUMsSUFBRCxFQUFPLEtBQUssQ0FBWixFQUFlLEtBQUssQ0FBcEIsRUFBdUIsYUFBYTtBQUM5RCxVQUFJc0YsS0FBSyxLQUFLUyxZQUFkLEVBQTRCO0FBQ3hCLGFBQUsxRCxPQUFMLENBQWFjLFdBQWIsQ0FBeUJLLE1BQXpCLENBQWdDVixlQUFoQyxFQUFpRGtELFNBQWpEO0FBQ0EsY0FBTUMsUUFBUSxHQUFHLEtBQUszRCxnQkFBTCxDQUFzQkksR0FBdEIsQ0FBMEJqQixPQUFPLENBQUN5RSxpQkFBbEMsQ0FBakI7QUFDQSxjQUFNRCxRQUFRLENBQUNFLGtCQUFULENBQTRCLHFJQUE1QixDQUFOO0FBQ0g7QUFDSixLQU42QixDQUQ5QixFQU9JQyxZQVBKO0FBUUg7O0FBakh3Qjs7QUFtSDdCaEYsT0FBTyxDQUFDZ0Isc0JBQVIsR0FBaUNBLHNCQUFqQyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xuICAgIH0pO1xufTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbmNvbnN0IGNyeXB0b18xID0gcmVxdWlyZShcImNyeXB0b1wiKTtcbmNvbnN0IGZzID0gcmVxdWlyZShcImZzXCIpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vYXBwbGljYXRpb24vdHlwZXNcIik7XG5yZXF1aXJlKFwiLi4vY29tbW9uL2V4dGVuc2lvbnNcIik7XG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uL2NvbW1vbi9wbGF0Zm9ybS90eXBlc1wiKTtcbmNvbnN0IHR5cGVzXzMgPSByZXF1aXJlKFwiLi4vY29tbW9uL3Byb2Nlc3MvdHlwZXNcIik7XG5jb25zdCBhc3luY18xID0gcmVxdWlyZShcIi4uL2NvbW1vbi91dGlscy9hc3luY1wiKTtcbmNvbnN0IERhdGFWZXJzaW9uID0gMTtcbmNsYXNzIEludGVycHJldGVyRGF0YSB7XG4gICAgY29uc3RydWN0b3IoZGF0YVZlcnNpb24sIFxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1zaGFkb3dlZC12YXJpYWJsZVxuICAgIHBhdGgsIHZlcnNpb24sIHNlYXJjaFBhdGhzLCBoYXNoKSB7XG4gICAgICAgIHRoaXMuZGF0YVZlcnNpb24gPSBkYXRhVmVyc2lvbjtcbiAgICAgICAgdGhpcy5wYXRoID0gcGF0aDtcbiAgICAgICAgdGhpcy52ZXJzaW9uID0gdmVyc2lvbjtcbiAgICAgICAgdGhpcy5zZWFyY2hQYXRocyA9IHNlYXJjaFBhdGhzO1xuICAgICAgICB0aGlzLmhhc2ggPSBoYXNoO1xuICAgIH1cbn1cbmV4cG9ydHMuSW50ZXJwcmV0ZXJEYXRhID0gSW50ZXJwcmV0ZXJEYXRhO1xuY2xhc3MgSW50ZXJwcmV0ZXJEYXRhU2VydmljZSB7XG4gICAgY29uc3RydWN0b3IoY29udGV4dCwgc2VydmljZUNvbnRhaW5lcikge1xuICAgICAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0O1xuICAgICAgICB0aGlzLnNlcnZpY2VDb250YWluZXIgPSBzZXJ2aWNlQ29udGFpbmVyO1xuICAgIH1cbiAgICBnZXRJbnRlcnByZXRlckRhdGEocmVzb3VyY2UpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IGV4ZWN1dGlvbkZhY3RvcnkgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzMuSVB5dGhvbkV4ZWN1dGlvbkZhY3RvcnkpO1xuICAgICAgICAgICAgY29uc3QgZXhlY1NlcnZpY2UgPSB5aWVsZCBleGVjdXRpb25GYWN0b3J5LmNyZWF0ZSh7IHJlc291cmNlIH0pO1xuICAgICAgICAgICAgY29uc3QgaW50ZXJwcmV0ZXJQYXRoID0geWllbGQgZXhlY1NlcnZpY2UuZ2V0RXhlY3V0YWJsZVBhdGgoKTtcbiAgICAgICAgICAgIGlmIChpbnRlcnByZXRlclBhdGgubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgY2FjaGVLZXkgPSBgSW50ZXJwcmV0ZXJEYXRhLSR7aW50ZXJwcmV0ZXJQYXRofWA7XG4gICAgICAgICAgICBsZXQgaW50ZXJwcmV0ZXJEYXRhID0gdGhpcy5jb250ZXh0Lmdsb2JhbFN0YXRlLmdldChjYWNoZUtleSk7XG4gICAgICAgICAgICBsZXQgaW50ZXJwcmV0ZXJDaGFuZ2VkID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAoaW50ZXJwcmV0ZXJEYXRhKSB7XG4gICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgaW50ZXJwcmV0ZXIgZXhlY3V0YWJsZSBjaGFuZ2VkXG4gICAgICAgICAgICAgICAgaWYgKGludGVycHJldGVyRGF0YS5kYXRhVmVyc2lvbiAhPT0gRGF0YVZlcnNpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJwcmV0ZXJDaGFuZ2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRIYXNoID0geWllbGQgdGhpcy5nZXRJbnRlcnByZXRlckhhc2goaW50ZXJwcmV0ZXJQYXRoKTtcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJwcmV0ZXJDaGFuZ2VkID0gY3VycmVudEhhc2ggIT09IGludGVycHJldGVyRGF0YS5oYXNoO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChpbnRlcnByZXRlckNoYW5nZWQgfHwgIWludGVycHJldGVyRGF0YSkge1xuICAgICAgICAgICAgICAgIGludGVycHJldGVyRGF0YSA9IHlpZWxkIHRoaXMuZ2V0SW50ZXJwcmV0ZXJEYXRhRnJvbVB5dGhvbihleGVjU2VydmljZSwgaW50ZXJwcmV0ZXJQYXRoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuZ2xvYmFsU3RhdGUudXBkYXRlKGludGVycHJldGVyUGF0aCwgaW50ZXJwcmV0ZXJEYXRhKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB3ZSB2ZXJpZnkgdGhhdCBzZWFyY2ggcGF0aHMgZGlkIG5vdCBjaGFuZ2UuIFRoaXMgbXVzdCBiZSBkb25lXG4gICAgICAgICAgICAgICAgLy8gY29tcGxldGVseSBhc3luYyBzbyB3ZSBkb24ndCBkZWxheSBQeXRob24gbGFuZ3VhZ2Ugc2VydmVyIHN0YXJ0dXAuXG4gICAgICAgICAgICAgICAgdGhpcy52ZXJpZnlTZWFyY2hQYXRocyhpbnRlcnByZXRlckRhdGEuc2VhcmNoUGF0aHMsIGludGVycHJldGVyUGF0aCwgZXhlY1NlcnZpY2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGludGVycHJldGVyRGF0YTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGdldEludGVycHJldGVySGFzaChpbnRlcnByZXRlclBhdGgpIHtcbiAgICAgICAgY29uc3QgcGxhdGZvcm0gPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzIuSVBsYXRmb3JtU2VydmljZSk7XG4gICAgICAgIGNvbnN0IHB5dGhvbkV4ZWN1dGFibGUgPSBwYXRoLmpvaW4ocGF0aC5kaXJuYW1lKGludGVycHJldGVyUGF0aCksIHBsYXRmb3JtLmlzV2luZG93cyA/ICdweXRob24uZXhlJyA6ICdweXRob24nKTtcbiAgICAgICAgLy8gSGFzaCBtb2QgdGltZSBhbmQgY3JlYXRpb24gdGltZVxuICAgICAgICBjb25zdCBkZWZlcnJlZCA9IGFzeW5jXzEuY3JlYXRlRGVmZXJyZWQoKTtcbiAgICAgICAgZnMubHN0YXQocHl0aG9uRXhlY3V0YWJsZSwgKGVyciwgc3RhdHMpID0+IHtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKCcnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IGFjdHVhbCA9IGNyeXB0b18xLmNyZWF0ZUhhc2goJ3NoYTUxMicpLnVwZGF0ZShgJHtzdGF0cy5jdGltZX0tJHtzdGF0cy5tdGltZX1gKS5kaWdlc3QoJ2hleCcpO1xuICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoYWN0dWFsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xuICAgIH1cbiAgICBnZXRJbnRlcnByZXRlckRhdGFGcm9tUHl0aG9uKGV4ZWNTZXJ2aWNlLCBpbnRlcnByZXRlclBhdGgpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHlpZWxkIGV4ZWNTZXJ2aWNlLmV4ZWMoWyctYycsICdpbXBvcnQgc3lzOyBwcmludChzeXMudmVyc2lvbl9pbmZvKSddLCB7fSk7XG4gICAgICAgICAgICAvLyBzeXMudmVyc2lvbl9pbmZvKG1ham9yPTMsIG1pbm9yPTYsIG1pY3JvPTYsIHJlbGVhc2VsZXZlbD0nZmluYWwnLCBzZXJpYWw9MClcbiAgICAgICAgICAgIGlmICghcmVzdWx0LnN0ZG91dCkge1xuICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdVbmFibGUgdG8gZGV0ZXJtaW5lIFB5dGhvbiBpbnRlcnByZXRlciB2ZXJzaW9uIGFuZCBzeXN0ZW0gcHJlZml4LicpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3Qgb3V0cHV0ID0gcmVzdWx0LnN0ZG91dC5zcGxpdExpbmVzKHsgcmVtb3ZlRW1wdHlFbnRyaWVzOiB0cnVlLCB0cmltOiB0cnVlIH0pO1xuICAgICAgICAgICAgaWYgKCFvdXRwdXQgfHwgb3V0cHV0Lmxlbmd0aCA8IDEpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignVW5hYmxlIHRvIHBhcnNlIHZlcnNpb24gYW5kIGFuZCBzeXN0ZW0gcHJlZml4IGZyb20gdGhlIFB5dGhvbiBpbnRlcnByZXRlciBvdXRwdXQuJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBtYWpvck1hdGNoZXMgPSBvdXRwdXRbMF0ubWF0Y2goL21ham9yPShcXGQqPyksLyk7XG4gICAgICAgICAgICBjb25zdCBtaW5vck1hdGNoZXMgPSBvdXRwdXRbMF0ubWF0Y2goL21pbm9yPShcXGQqPyksLyk7XG4gICAgICAgICAgICBpZiAoIW1ham9yTWF0Y2hlcyB8fCBtYWpvck1hdGNoZXMubGVuZ3RoIDwgMiB8fCAhbWlub3JNYXRjaGVzIHx8IG1pbm9yTWF0Y2hlcy5sZW5ndGggPCAyKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ1VuYWJsZSB0byBwYXJzZSBpbnRlcnByZXRlciB2ZXJzaW9uLicpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgaGFzaCA9IHlpZWxkIHRoaXMuZ2V0SW50ZXJwcmV0ZXJIYXNoKGludGVycHJldGVyUGF0aCk7XG4gICAgICAgICAgICBjb25zdCBzZWFyY2hQYXRocyA9IHlpZWxkIHRoaXMuZ2V0U2VhcmNoUGF0aHMoZXhlY1NlcnZpY2UpO1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBJbnRlcnByZXRlckRhdGEoRGF0YVZlcnNpb24sIGludGVycHJldGVyUGF0aCwgYCR7bWFqb3JNYXRjaGVzWzFdfS4ke21pbm9yTWF0Y2hlc1sxXX1gLCBzZWFyY2hQYXRocywgaGFzaCk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBnZXRTZWFyY2hQYXRocyhleGVjU2VydmljZSkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0geWllbGQgZXhlY1NlcnZpY2UuZXhlYyhbJy1jJywgJ2ltcG9ydCBzeXM7IGltcG9ydCBvczsgcHJpbnQoc3lzLnBhdGggKyBvcy5nZXRlbnYoXCJQWVRIT05QQVRIXCIsIFwiXCIpLnNwbGl0KG9zLnBhdGhzZXApKTsnXSwge30pO1xuICAgICAgICAgICAgaWYgKCFyZXN1bHQuc3Rkb3V0KSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ1VuYWJsZSB0byBkZXRlcm1pbmUgUHl0aG9uIGludGVycHJldGVyIHNlYXJjaCBwYXRocy4nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby11bm5lY2Vzc2FyeS1sb2NhbC12YXJpYWJsZVxuICAgICAgICAgICAgY29uc3QgcGF0aHMgPSByZXN1bHQuc3Rkb3V0LnNwbGl0KCcsJylcbiAgICAgICAgICAgICAgICAuZmlsdGVyKHAgPT4gdGhpcy5pc1ZhbGlkUGF0aChwKSlcbiAgICAgICAgICAgICAgICAubWFwKHAgPT4gdGhpcy5wYXRoQ2xlYW51cChwKSk7XG4gICAgICAgICAgICByZXR1cm4gcGF0aHMuam9pbignOycpOyAvLyBQVFZTIHVzZXMgOyBvbiBhbGwgcGxhdGZvcm1zXG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBwYXRoQ2xlYW51cChzKSB7XG4gICAgICAgIHMgPSBzLnRyaW0oKTtcbiAgICAgICAgaWYgKHNbMF0gPT09ICdcXCcnKSB7XG4gICAgICAgICAgICBzID0gcy5zdWJzdHIoMSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHNbcy5sZW5ndGggLSAxXSA9PT0gJ10nKSB7XG4gICAgICAgICAgICBzID0gcy5zdWJzdHIoMCwgcy5sZW5ndGggLSAxKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc1tzLmxlbmd0aCAtIDFdID09PSAnXFwnJykge1xuICAgICAgICAgICAgcyA9IHMuc3Vic3RyKDAsIHMubGVuZ3RoIC0gMSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHM7XG4gICAgfVxuICAgIGlzVmFsaWRQYXRoKHMpIHtcbiAgICAgICAgcmV0dXJuIHMubGVuZ3RoID4gMCAmJiBzWzBdICE9PSAnWyc7XG4gICAgfVxuICAgIHZlcmlmeVNlYXJjaFBhdGhzKGN1cnJlbnRQYXRocywgaW50ZXJwcmV0ZXJQYXRoLCBleGVjU2VydmljZSkge1xuICAgICAgICB0aGlzLmdldFNlYXJjaFBhdGhzKGV4ZWNTZXJ2aWNlKVxuICAgICAgICAgICAgLnRoZW4oKHBhdGhzKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBpZiAocGF0aHMgIT09IGN1cnJlbnRQYXRocykge1xuICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5nbG9iYWxTdGF0ZS51cGRhdGUoaW50ZXJwcmV0ZXJQYXRoLCB1bmRlZmluZWQpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGFwcFNoZWxsID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklBcHBsaWNhdGlvblNoZWxsKTtcbiAgICAgICAgICAgICAgICB5aWVsZCBhcHBTaGVsbC5zaG93V2FybmluZ01lc3NhZ2UoJ1NlYXJjaCBwYXRocyBoYXZlIGNoYW5nZWQgZm9yIHRoaXMgUHl0aG9uIGludGVycHJldGVyLiBQbGVhc2UgcmVsb2FkIHRoZSBleHRlbnNpb24gdG8gZW5zdXJlIHRoYXQgdGhlIEludGVsbGlTZW5zZSB3b3JrcyBjb3JyZWN0bHkuJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pKS5pZ25vcmVFcnJvcnMoKTtcbiAgICB9XG59XG5leHBvcnRzLkludGVycHJldGVyRGF0YVNlcnZpY2UgPSBJbnRlcnByZXRlckRhdGFTZXJ2aWNlO1xuLy8jIHNvdXJjZU1hcHBpbmdVUkw9aW50ZXJwcmV0ZXJEYXRhU2VydmljZS5qcy5tYXAiXX0=