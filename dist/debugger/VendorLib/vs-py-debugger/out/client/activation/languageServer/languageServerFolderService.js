// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const path = require("path");

const semver = require("semver");

const constants_1 = require("../../common/constants");

const logger_1 = require("../../common/logger");

const types_1 = require("../../common/platform/types");

const types_2 = require("../../common/types");

const types_3 = require("../../ioc/types");

const types_4 = require("../types");

const languageServerFolder = 'languageServer';
let LanguageServerFolderService = class LanguageServerFolderService {
  constructor(serviceContainer) {
    this.serviceContainer = serviceContainer;
  }

  getLanguageServerFolderName() {
    return __awaiter(this, void 0, void 0, function* () {
      const currentFolder = yield this.getCurrentLanguageServerDirectory();
      let serverVersion;
      const shouldLookForNewVersion = yield this.shouldLookForNewLanguageServer(currentFolder);

      if (currentFolder && !shouldLookForNewVersion) {
        return path.basename(currentFolder.path);
      }

      serverVersion = yield this.getLatestLanguageServerVersion().catch(ex => undefined);

      if (currentFolder && (!serverVersion || serverVersion.version.compare(currentFolder.version) <= 0)) {
        return path.basename(currentFolder.path);
      }

      return `${languageServerFolder}.${serverVersion.version.raw}`;
    });
  }

  getLatestLanguageServerVersion() {
    const lsPackageService = this.serviceContainer.get(types_4.ILanguageServerPackageService);
    return lsPackageService.getLatestNugetPackageVersion();
  }

  shouldLookForNewLanguageServer(currentFolder) {
    return __awaiter(this, void 0, void 0, function* () {
      const configService = this.serviceContainer.get(types_2.IConfigurationService);
      const autoUpdateLanguageServer = configService.getSettings().autoUpdateLanguageServer;
      const downloadLanguageServer = configService.getSettings().downloadLanguageServer;

      if (currentFolder && (!autoUpdateLanguageServer || !downloadLanguageServer)) {
        return false;
      }

      const downloadChannel = this.getDownloadChannel();
      const rule = this.serviceContainer.get(types_4.IDownloadChannelRule, downloadChannel);
      return rule.shouldLookForNewLanguageServer(currentFolder);
    });
  }

  getCurrentLanguageServerDirectory() {
    return __awaiter(this, void 0, void 0, function* () {
      const configService = this.serviceContainer.get(types_2.IConfigurationService);

      if (!configService.getSettings().downloadLanguageServer) {
        return {
          path: languageServerFolder,
          version: new semver.SemVer('0.0.0')
        };
      }

      const dirs = yield this.getExistingLanguageServerDirectories();

      if (dirs.length === 0) {
        return;
      }

      dirs.sort((a, b) => a.version.compare(b.version));
      return dirs[dirs.length - 1];
    });
  }

  getExistingLanguageServerDirectories() {
    return __awaiter(this, void 0, void 0, function* () {
      const fs = this.serviceContainer.get(types_1.IFileSystem);
      const subDirs = yield fs.getSubDirectories(constants_1.EXTENSION_ROOT_DIR);
      return subDirs.filter(dir => path.basename(dir).startsWith(languageServerFolder)).map(dir => {
        return {
          path: dir,
          version: this.getFolderVersion(path.basename(dir))
        };
      });
    });
  }

  getFolderVersion(dirName) {
    const suffix = dirName.substring(languageServerFolder.length + 1);
    return suffix.length === 0 ? new semver.SemVer('0.0.0') : semver.parse(suffix, true) || new semver.SemVer('0.0.0');
  }

  getDownloadChannel() {
    const lsPackageService = this.serviceContainer.get(types_4.ILanguageServerPackageService);
    return lsPackageService.getLanguageServerDownloadChannel();
  }

};

__decorate([logger_1.traceVerbose('Get language server folder name')], LanguageServerFolderService.prototype, "getLanguageServerFolderName", null);

__decorate([logger_1.traceVerbose('Get latest version of Language Server')], LanguageServerFolderService.prototype, "getLatestLanguageServerVersion", null);

LanguageServerFolderService = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_3.IServiceContainer))], LanguageServerFolderService);
exports.LanguageServerFolderService = LanguageServerFolderService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxhbmd1YWdlU2VydmVyRm9sZGVyU2VydmljZS5qcyJdLCJuYW1lcyI6WyJfX2RlY29yYXRlIiwiZGVjb3JhdG9ycyIsInRhcmdldCIsImtleSIsImRlc2MiLCJjIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImQiLCJSZWZsZWN0IiwiZGVjb3JhdGUiLCJpIiwiZGVmaW5lUHJvcGVydHkiLCJfX3BhcmFtIiwicGFyYW1JbmRleCIsImRlY29yYXRvciIsIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJleHBvcnRzIiwiaW52ZXJzaWZ5XzEiLCJyZXF1aXJlIiwicGF0aCIsInNlbXZlciIsImNvbnN0YW50c18xIiwibG9nZ2VyXzEiLCJ0eXBlc18xIiwidHlwZXNfMiIsInR5cGVzXzMiLCJ0eXBlc180IiwibGFuZ3VhZ2VTZXJ2ZXJGb2xkZXIiLCJMYW5ndWFnZVNlcnZlckZvbGRlclNlcnZpY2UiLCJjb25zdHJ1Y3RvciIsInNlcnZpY2VDb250YWluZXIiLCJnZXRMYW5ndWFnZVNlcnZlckZvbGRlck5hbWUiLCJjdXJyZW50Rm9sZGVyIiwiZ2V0Q3VycmVudExhbmd1YWdlU2VydmVyRGlyZWN0b3J5Iiwic2VydmVyVmVyc2lvbiIsInNob3VsZExvb2tGb3JOZXdWZXJzaW9uIiwic2hvdWxkTG9va0Zvck5ld0xhbmd1YWdlU2VydmVyIiwiYmFzZW5hbWUiLCJnZXRMYXRlc3RMYW5ndWFnZVNlcnZlclZlcnNpb24iLCJjYXRjaCIsImV4IiwidW5kZWZpbmVkIiwidmVyc2lvbiIsImNvbXBhcmUiLCJyYXciLCJsc1BhY2thZ2VTZXJ2aWNlIiwiZ2V0IiwiSUxhbmd1YWdlU2VydmVyUGFja2FnZVNlcnZpY2UiLCJnZXRMYXRlc3ROdWdldFBhY2thZ2VWZXJzaW9uIiwiY29uZmlnU2VydmljZSIsIklDb25maWd1cmF0aW9uU2VydmljZSIsImF1dG9VcGRhdGVMYW5ndWFnZVNlcnZlciIsImdldFNldHRpbmdzIiwiZG93bmxvYWRMYW5ndWFnZVNlcnZlciIsImRvd25sb2FkQ2hhbm5lbCIsImdldERvd25sb2FkQ2hhbm5lbCIsInJ1bGUiLCJJRG93bmxvYWRDaGFubmVsUnVsZSIsIlNlbVZlciIsImRpcnMiLCJnZXRFeGlzdGluZ0xhbmd1YWdlU2VydmVyRGlyZWN0b3JpZXMiLCJzb3J0IiwiYSIsImIiLCJmcyIsIklGaWxlU3lzdGVtIiwic3ViRGlycyIsImdldFN1YkRpcmVjdG9yaWVzIiwiRVhURU5TSU9OX1JPT1RfRElSIiwiZmlsdGVyIiwiZGlyIiwic3RhcnRzV2l0aCIsIm1hcCIsImdldEZvbGRlclZlcnNpb24iLCJkaXJOYW1lIiwic3VmZml4Iiwic3Vic3RyaW5nIiwicGFyc2UiLCJnZXRMYW5ndWFnZVNlcnZlckRvd25sb2FkQ2hhbm5lbCIsInRyYWNlVmVyYm9zZSIsInByb3RvdHlwZSIsImluamVjdGFibGUiLCJpbmplY3QiLCJJU2VydmljZUNvbnRhaW5lciJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBOztBQUNBLElBQUlBLFVBQVUsR0FBSSxVQUFRLFNBQUtBLFVBQWQsSUFBNkIsVUFBVUMsVUFBVixFQUFzQkMsTUFBdEIsRUFBOEJDLEdBQTlCLEVBQW1DQyxJQUFuQyxFQUF5QztBQUNuRixNQUFJQyxDQUFDLEdBQUdDLFNBQVMsQ0FBQ0MsTUFBbEI7QUFBQSxNQUEwQkMsQ0FBQyxHQUFHSCxDQUFDLEdBQUcsQ0FBSixHQUFRSCxNQUFSLEdBQWlCRSxJQUFJLEtBQUssSUFBVCxHQUFnQkEsSUFBSSxHQUFHSyxNQUFNLENBQUNDLHdCQUFQLENBQWdDUixNQUFoQyxFQUF3Q0MsR0FBeEMsQ0FBdkIsR0FBc0VDLElBQXJIO0FBQUEsTUFB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c0JnQixHQUF0QixDQUEwQnBCLE9BQU8sQ0FBQ3FCLDZCQUFsQyxDQUF6QjtBQUNBLFdBQU9GLGdCQUFnQixDQUFDaUMsZ0NBQWpCLEVBQVA7QUFDSDs7QUFuRStELENBQXBFOztBQXFFQW5HLFVBQVUsQ0FBQyxDQUNQMkMsUUFBUSxDQUFDeUQsWUFBVCxDQUFzQixpQ0FBdEIsQ0FETyxDQUFELEVBRVBuRCwyQkFBMkIsQ0FBQ29ELFNBRnJCLEVBRWdDLDZCQUZoQyxFQUUrRCxJQUYvRCxDQUFWOztBQUdBckcsVUFBVSxDQUFDLENBQ1AyQyxRQUFRLENBQUN5RCxZQUFULENBQXNCLHVDQUF0QixDQURPLENBQUQsRUFFUG5ELDJCQUEyQixDQUFDb0QsU0FGckIsRUFFZ0MsZ0NBRmhDLEVBRWtFLElBRmxFLENBQVY7O0FBR0FwRCwyQkFBMkIsR0FBR2pELFVBQVUsQ0FBQyxDQUNyQ3NDLFdBQVcsQ0FBQ2dFLFVBQVosRUFEcUMsRUFFckN0RixPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDaUUsTUFBWixDQUFtQnpELE9BQU8sQ0FBQzBELGlCQUEzQixDQUFKLENBRjhCLENBQUQsRUFHckN2RCwyQkFIcUMsQ0FBeEM7QUFJQVosT0FBTyxDQUFDWSwyQkFBUixHQUFzQ0EsMkJBQXRDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXG4ndXNlIHN0cmljdCc7XG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XG4gICAgdmFyIGMgPSBhcmd1bWVudHMubGVuZ3RoLCByID0gYyA8IDMgPyB0YXJnZXQgOiBkZXNjID09PSBudWxsID8gZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpIDogZGVzYywgZDtcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XG4gICAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjtcbn07XG52YXIgX19wYXJhbSA9ICh0aGlzICYmIHRoaXMuX19wYXJhbSkgfHwgZnVuY3Rpb24gKHBhcmFtSW5kZXgsIGRlY29yYXRvcikge1xuICAgIHJldHVybiBmdW5jdGlvbiAodGFyZ2V0LCBrZXkpIHsgZGVjb3JhdG9yKHRhcmdldCwga2V5LCBwYXJhbUluZGV4KTsgfVxufTtcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XG4gICAgfSk7XG59O1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuY29uc3QgaW52ZXJzaWZ5XzEgPSByZXF1aXJlKFwiaW52ZXJzaWZ5XCIpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xuY29uc3Qgc2VtdmVyID0gcmVxdWlyZShcInNlbXZlclwiKTtcbmNvbnN0IGNvbnN0YW50c18xID0gcmVxdWlyZShcIi4uLy4uL2NvbW1vbi9jb25zdGFudHNcIik7XG5jb25zdCBsb2dnZXJfMSA9IHJlcXVpcmUoXCIuLi8uLi9jb21tb24vbG9nZ2VyXCIpO1xuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jb21tb24vcGxhdGZvcm0vdHlwZXNcIik7XG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uLy4uL2NvbW1vbi90eXBlc1wiKTtcbmNvbnN0IHR5cGVzXzMgPSByZXF1aXJlKFwiLi4vLi4vaW9jL3R5cGVzXCIpO1xuY29uc3QgdHlwZXNfNCA9IHJlcXVpcmUoXCIuLi90eXBlc1wiKTtcbmNvbnN0IGxhbmd1YWdlU2VydmVyRm9sZGVyID0gJ2xhbmd1YWdlU2VydmVyJztcbmxldCBMYW5ndWFnZVNlcnZlckZvbGRlclNlcnZpY2UgPSBjbGFzcyBMYW5ndWFnZVNlcnZlckZvbGRlclNlcnZpY2Uge1xuICAgIGNvbnN0cnVjdG9yKHNlcnZpY2VDb250YWluZXIpIHtcbiAgICAgICAgdGhpcy5zZXJ2aWNlQ29udGFpbmVyID0gc2VydmljZUNvbnRhaW5lcjtcbiAgICB9XG4gICAgZ2V0TGFuZ3VhZ2VTZXJ2ZXJGb2xkZXJOYW1lKCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgY3VycmVudEZvbGRlciA9IHlpZWxkIHRoaXMuZ2V0Q3VycmVudExhbmd1YWdlU2VydmVyRGlyZWN0b3J5KCk7XG4gICAgICAgICAgICBsZXQgc2VydmVyVmVyc2lvbjtcbiAgICAgICAgICAgIGNvbnN0IHNob3VsZExvb2tGb3JOZXdWZXJzaW9uID0geWllbGQgdGhpcy5zaG91bGRMb29rRm9yTmV3TGFuZ3VhZ2VTZXJ2ZXIoY3VycmVudEZvbGRlcik7XG4gICAgICAgICAgICBpZiAoY3VycmVudEZvbGRlciAmJiAhc2hvdWxkTG9va0Zvck5ld1ZlcnNpb24pIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcGF0aC5iYXNlbmFtZShjdXJyZW50Rm9sZGVyLnBhdGgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc2VydmVyVmVyc2lvbiA9IHlpZWxkIHRoaXMuZ2V0TGF0ZXN0TGFuZ3VhZ2VTZXJ2ZXJWZXJzaW9uKClcbiAgICAgICAgICAgICAgICAuY2F0Y2goZXggPT4gdW5kZWZpbmVkKTtcbiAgICAgICAgICAgIGlmIChjdXJyZW50Rm9sZGVyICYmICghc2VydmVyVmVyc2lvbiB8fCBzZXJ2ZXJWZXJzaW9uLnZlcnNpb24uY29tcGFyZShjdXJyZW50Rm9sZGVyLnZlcnNpb24pIDw9IDApKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHBhdGguYmFzZW5hbWUoY3VycmVudEZvbGRlci5wYXRoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBgJHtsYW5ndWFnZVNlcnZlckZvbGRlcn0uJHtzZXJ2ZXJWZXJzaW9uLnZlcnNpb24ucmF3fWA7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBnZXRMYXRlc3RMYW5ndWFnZVNlcnZlclZlcnNpb24oKSB7XG4gICAgICAgIGNvbnN0IGxzUGFja2FnZVNlcnZpY2UgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzQuSUxhbmd1YWdlU2VydmVyUGFja2FnZVNlcnZpY2UpO1xuICAgICAgICByZXR1cm4gbHNQYWNrYWdlU2VydmljZS5nZXRMYXRlc3ROdWdldFBhY2thZ2VWZXJzaW9uKCk7XG4gICAgfVxuICAgIHNob3VsZExvb2tGb3JOZXdMYW5ndWFnZVNlcnZlcihjdXJyZW50Rm9sZGVyKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBjb25maWdTZXJ2aWNlID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18yLklDb25maWd1cmF0aW9uU2VydmljZSk7XG4gICAgICAgICAgICBjb25zdCBhdXRvVXBkYXRlTGFuZ3VhZ2VTZXJ2ZXIgPSBjb25maWdTZXJ2aWNlLmdldFNldHRpbmdzKCkuYXV0b1VwZGF0ZUxhbmd1YWdlU2VydmVyO1xuICAgICAgICAgICAgY29uc3QgZG93bmxvYWRMYW5ndWFnZVNlcnZlciA9IGNvbmZpZ1NlcnZpY2UuZ2V0U2V0dGluZ3MoKS5kb3dubG9hZExhbmd1YWdlU2VydmVyO1xuICAgICAgICAgICAgaWYgKGN1cnJlbnRGb2xkZXIgJiYgKCFhdXRvVXBkYXRlTGFuZ3VhZ2VTZXJ2ZXIgfHwgIWRvd25sb2FkTGFuZ3VhZ2VTZXJ2ZXIpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgZG93bmxvYWRDaGFubmVsID0gdGhpcy5nZXREb3dubG9hZENoYW5uZWwoKTtcbiAgICAgICAgICAgIGNvbnN0IHJ1bGUgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzQuSURvd25sb2FkQ2hhbm5lbFJ1bGUsIGRvd25sb2FkQ2hhbm5lbCk7XG4gICAgICAgICAgICByZXR1cm4gcnVsZS5zaG91bGRMb29rRm9yTmV3TGFuZ3VhZ2VTZXJ2ZXIoY3VycmVudEZvbGRlcik7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBnZXRDdXJyZW50TGFuZ3VhZ2VTZXJ2ZXJEaXJlY3RvcnkoKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBjb25maWdTZXJ2aWNlID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18yLklDb25maWd1cmF0aW9uU2VydmljZSk7XG4gICAgICAgICAgICBpZiAoIWNvbmZpZ1NlcnZpY2UuZ2V0U2V0dGluZ3MoKS5kb3dubG9hZExhbmd1YWdlU2VydmVyKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgcGF0aDogbGFuZ3VhZ2VTZXJ2ZXJGb2xkZXIsIHZlcnNpb246IG5ldyBzZW12ZXIuU2VtVmVyKCcwLjAuMCcpIH07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBkaXJzID0geWllbGQgdGhpcy5nZXRFeGlzdGluZ0xhbmd1YWdlU2VydmVyRGlyZWN0b3JpZXMoKTtcbiAgICAgICAgICAgIGlmIChkaXJzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRpcnMuc29ydCgoYSwgYikgPT4gYS52ZXJzaW9uLmNvbXBhcmUoYi52ZXJzaW9uKSk7XG4gICAgICAgICAgICByZXR1cm4gZGlyc1tkaXJzLmxlbmd0aCAtIDFdO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgZ2V0RXhpc3RpbmdMYW5ndWFnZVNlcnZlckRpcmVjdG9yaWVzKCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgZnMgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSUZpbGVTeXN0ZW0pO1xuICAgICAgICAgICAgY29uc3Qgc3ViRGlycyA9IHlpZWxkIGZzLmdldFN1YkRpcmVjdG9yaWVzKGNvbnN0YW50c18xLkVYVEVOU0lPTl9ST09UX0RJUik7XG4gICAgICAgICAgICByZXR1cm4gc3ViRGlyc1xuICAgICAgICAgICAgICAgIC5maWx0ZXIoZGlyID0+IHBhdGguYmFzZW5hbWUoZGlyKS5zdGFydHNXaXRoKGxhbmd1YWdlU2VydmVyRm9sZGVyKSlcbiAgICAgICAgICAgICAgICAubWFwKGRpciA9PiB7IHJldHVybiB7IHBhdGg6IGRpciwgdmVyc2lvbjogdGhpcy5nZXRGb2xkZXJWZXJzaW9uKHBhdGguYmFzZW5hbWUoZGlyKSkgfTsgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBnZXRGb2xkZXJWZXJzaW9uKGRpck5hbWUpIHtcbiAgICAgICAgY29uc3Qgc3VmZml4ID0gZGlyTmFtZS5zdWJzdHJpbmcobGFuZ3VhZ2VTZXJ2ZXJGb2xkZXIubGVuZ3RoICsgMSk7XG4gICAgICAgIHJldHVybiBzdWZmaXgubGVuZ3RoID09PSAwID8gbmV3IHNlbXZlci5TZW1WZXIoJzAuMC4wJykgOiAoc2VtdmVyLnBhcnNlKHN1ZmZpeCwgdHJ1ZSkgfHwgbmV3IHNlbXZlci5TZW1WZXIoJzAuMC4wJykpO1xuICAgIH1cbiAgICBnZXREb3dubG9hZENoYW5uZWwoKSB7XG4gICAgICAgIGNvbnN0IGxzUGFja2FnZVNlcnZpY2UgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzQuSUxhbmd1YWdlU2VydmVyUGFja2FnZVNlcnZpY2UpO1xuICAgICAgICByZXR1cm4gbHNQYWNrYWdlU2VydmljZS5nZXRMYW5ndWFnZVNlcnZlckRvd25sb2FkQ2hhbm5lbCgpO1xuICAgIH1cbn07XG5fX2RlY29yYXRlKFtcbiAgICBsb2dnZXJfMS50cmFjZVZlcmJvc2UoJ0dldCBsYW5ndWFnZSBzZXJ2ZXIgZm9sZGVyIG5hbWUnKVxuXSwgTGFuZ3VhZ2VTZXJ2ZXJGb2xkZXJTZXJ2aWNlLnByb3RvdHlwZSwgXCJnZXRMYW5ndWFnZVNlcnZlckZvbGRlck5hbWVcIiwgbnVsbCk7XG5fX2RlY29yYXRlKFtcbiAgICBsb2dnZXJfMS50cmFjZVZlcmJvc2UoJ0dldCBsYXRlc3QgdmVyc2lvbiBvZiBMYW5ndWFnZSBTZXJ2ZXInKVxuXSwgTGFuZ3VhZ2VTZXJ2ZXJGb2xkZXJTZXJ2aWNlLnByb3RvdHlwZSwgXCJnZXRMYXRlc3RMYW5ndWFnZVNlcnZlclZlcnNpb25cIiwgbnVsbCk7XG5MYW5ndWFnZVNlcnZlckZvbGRlclNlcnZpY2UgPSBfX2RlY29yYXRlKFtcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKCksXG4gICAgX19wYXJhbSgwLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMy5JU2VydmljZUNvbnRhaW5lcikpXG5dLCBMYW5ndWFnZVNlcnZlckZvbGRlclNlcnZpY2UpO1xuZXhwb3J0cy5MYW5ndWFnZVNlcnZlckZvbGRlclNlcnZpY2UgPSBMYW5ndWFnZVNlcnZlckZvbGRlclNlcnZpY2U7XG4vLyMgc291cmNlTWFwcGluZ1VSTD1sYW5ndWFnZVNlcnZlckZvbGRlclNlcnZpY2UuanMubWFwIl19