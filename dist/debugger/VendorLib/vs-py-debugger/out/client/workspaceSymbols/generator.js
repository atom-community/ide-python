"use strict";

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const fs = require("fs");

const path = require("path");

const vscode_1 = require("vscode");

const configSettings_1 = require("../common/configSettings");

const telemetry_1 = require("../telemetry");

const constants_1 = require("../telemetry/constants");

class Generator {
  constructor(workspaceFolder, output, processServiceFactory) {
    this.workspaceFolder = workspaceFolder;
    this.output = output;
    this.processServiceFactory = processServiceFactory;
    this.disposables = [];
    this.optionsFile = path.join(__dirname, '..', '..', '..', 'resources', 'ctagOptions');
    this.pythonSettings = configSettings_1.PythonSettings.getInstance(workspaceFolder);
  }

  get tagFilePath() {
    return this.pythonSettings.workspaceSymbols.tagFilePath;
  }

  get enabled() {
    return this.pythonSettings.workspaceSymbols.enabled;
  }

  dispose() {
    this.disposables.forEach(d => d.dispose());
  }

  generateWorkspaceTags() {
    return __awaiter(this, void 0, void 0, function* () {
      if (!this.pythonSettings.workspaceSymbols.enabled) {
        return;
      }

      return this.generateTags({
        directory: this.workspaceFolder.fsPath
      });
    });
  }

  buildCmdArgs() {
    const exclusions = this.pythonSettings.workspaceSymbols.exclusionPatterns;
    const excludes = exclusions.length === 0 ? [] : exclusions.map(pattern => `--exclude=${pattern}`);
    return [`--options=${this.optionsFile}`, '--languages=Python'].concat(excludes);
  }

  generateTags(source) {
    const tagFile = path.normalize(this.pythonSettings.workspaceSymbols.tagFilePath);
    const cmd = this.pythonSettings.workspaceSymbols.ctagsPath;
    const args = this.buildCmdArgs();
    let outputFile = tagFile;

    if (source.file && source.file.length > 0) {
      source.directory = path.dirname(source.file);
    }

    if (path.dirname(outputFile) === source.directory) {
      outputFile = path.basename(outputFile);
    }

    const outputDir = path.dirname(outputFile);

    if (!fs.existsSync(outputDir)) {
      fs.mkdirSync(outputDir);
    }

    args.push('-o', outputFile, '.');
    this.output.appendLine(`${'-'.repeat(10)}Generating Tags${'-'.repeat(10)}`);
    this.output.appendLine(`${cmd} ${args.join(' ')}`);
    const promise = new Promise((resolve, reject) => __awaiter(this, void 0, void 0, function* () {
      const processService = yield this.processServiceFactory.create();
      const result = processService.execObservable(cmd, args, {
        cwd: source.directory
      });
      let errorMsg = '';
      result.out.subscribe(output => {
        if (output.source === 'stderr') {
          errorMsg += output.out;
        }

        this.output.append(output.out);
      }, reject, () => {
        if (errorMsg.length > 0) {
          reject(new Error(errorMsg));
        } else {
          resolve();
        }
      });
    }));
    vscode_1.window.setStatusBarMessage('Generating Tags', promise);
    return promise;
  }

}

__decorate([telemetry_1.captureTelemetry(constants_1.WORKSPACE_SYMBOLS_BUILD)], Generator.prototype, "generateTags", null);

exports.Generator = Generator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdlbmVyYXRvci5qcyJdLCJuYW1lcyI6WyJfX2RlY29yYXRlIiwiZGVjb3JhdG9ycyIsInRhcmdldCIsImtleSIsImRlc2MiLCJjIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImQiLCJSZWZsZWN0IiwiZGVjb3JhdGUiLCJpIiwiZGVmaW5lUHJvcGVydHkiLCJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiZXhwb3J0cyIsImZzIiwicmVxdWlyZSIsInBhdGgiLCJ2c2NvZGVfMSIsImNvbmZpZ1NldHRpbmdzXzEiLCJ0ZWxlbWV0cnlfMSIsImNvbnN0YW50c18xIiwiR2VuZXJhdG9yIiwiY29uc3RydWN0b3IiLCJ3b3Jrc3BhY2VGb2xkZXIiLCJvdXRwdXQiLCJwcm9jZXNzU2VydmljZUZhY3RvcnkiLCJkaXNwb3NhYmxlcyIsIm9wdGlvbnNGaWxlIiwiam9pbiIsIl9fZGlybmFtZSIsInB5dGhvblNldHRpbmdzIiwiUHl0aG9uU2V0dGluZ3MiLCJnZXRJbnN0YW5jZSIsInRhZ0ZpbGVQYXRoIiwid29ya3NwYWNlU3ltYm9scyIsImVuYWJsZWQiLCJkaXNwb3NlIiwiZm9yRWFjaCIsImdlbmVyYXRlV29ya3NwYWNlVGFncyIsImdlbmVyYXRlVGFncyIsImRpcmVjdG9yeSIsImZzUGF0aCIsImJ1aWxkQ21kQXJncyIsImV4Y2x1c2lvbnMiLCJleGNsdXNpb25QYXR0ZXJucyIsImV4Y2x1ZGVzIiwibWFwIiwicGF0dGVybiIsImNvbmNhdCIsInNvdXJjZSIsInRhZ0ZpbGUiLCJub3JtYWxpemUiLCJjbWQiLCJjdGFnc1BhdGgiLCJhcmdzIiwib3V0cHV0RmlsZSIsImZpbGUiLCJkaXJuYW1lIiwiYmFzZW5hbWUiLCJvdXRwdXREaXIiLCJleGlzdHNTeW5jIiwibWtkaXJTeW5jIiwicHVzaCIsImFwcGVuZExpbmUiLCJyZXBlYXQiLCJwcm9taXNlIiwicHJvY2Vzc1NlcnZpY2UiLCJjcmVhdGUiLCJleGVjT2JzZXJ2YWJsZSIsImN3ZCIsImVycm9yTXNnIiwib3V0Iiwic3Vic2NyaWJlIiwiYXBwZW5kIiwiRXJyb3IiLCJ3aW5kb3ciLCJzZXRTdGF0dXNCYXJNZXNzYWdlIiwiY2FwdHVyZVRlbGVtZXRyeSIsIldPUktTUEFDRV9TWU1CT0xTX0JVSUxEIiwicHJvdG90eXBlIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEsTUFBMEJDLENBQUMsR0FBR0gsQ0FBQyxHQUFHLENBQUosR0FBUUgsTUFBUixHQUFpQkUsSUFBSSxLQUFLLElBQVQsR0FBZ0JBLElBQUksR0FBR0ssTUFBTSxDQUFDQyx3QkFBUCxDQUFnQ1IsTUFBaEMsRUFBd0NDLEdBQXhDLENBQXZCLEdBQXNFQyxJQUFySDtBQUFBLE1BQTJITyxDQUEzSDtBQUNBLE1BQUksT0FBT0MsT0FBUCxLQUFtQixRQUFuQixJQUErQixPQUFPQSxPQUFPLENBQUNDLFFBQWYsS0FBNEIsVUFBL0QsRUFBMkVMLENBQUMsR0FBR0ksT0FBTyxDQUFDQyxRQUFSLENBQWlCWixVQUFqQixFQUE2QkMsTUFBN0IsRUFBcUNDLEdBQXJDLEVBQTBDQyxJQUExQyxDQUFKLENBQTNFLEtBQ0ssS0FBSyxJQUFJVSxDQUFDLEdBQUdiLFVBQVUsQ0FBQ00sTUFBWCxHQUFvQixDQUFqQyxFQUFvQ08sQ0FBQyxJQUFJLENBQXpDLEVBQTRDQSxDQUFDLEVBQTdDLEVBQWlELElBQUlILENB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QUFJd0UsS0FBSixDQUFVSixRQUFWLENBQUQsQ0FBTjtBQUNILFNBRkQsTUFHSztBQUNEckUsVUFBQUEsT0FBTztBQUNWO0FBQ0osT0FaRDtBQWFILEtBakJ5RCxDQUExQyxDQUFoQjtBQWtCQWdCLElBQUFBLFFBQVEsQ0FBQzBELE1BQVQsQ0FBZ0JDLG1CQUFoQixDQUFvQyxpQkFBcEMsRUFBdURYLE9BQXZEO0FBQ0EsV0FBT0EsT0FBUDtBQUNIOztBQXJFVzs7QUF1RWhCdEYsVUFBVSxDQUFDLENBQ1B3QyxXQUFXLENBQUMwRCxnQkFBWixDQUE2QnpELFdBQVcsQ0FBQzBELHVCQUF6QyxDQURPLENBQUQsRUFFUHpELFNBQVMsQ0FBQzBELFNBRkgsRUFFYyxjQUZkLEVBRThCLElBRjlCLENBQVY7O0FBR0FsRSxPQUFPLENBQUNRLFNBQVIsR0FBb0JBLFNBQXBCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XG4gICAgdmFyIGMgPSBhcmd1bWVudHMubGVuZ3RoLCByID0gYyA8IDMgPyB0YXJnZXQgOiBkZXNjID09PSBudWxsID8gZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpIDogZGVzYywgZDtcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XG4gICAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjtcbn07XG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xuICAgIH0pO1xufTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbmNvbnN0IGZzID0gcmVxdWlyZShcImZzXCIpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xuY29uc3QgdnNjb2RlXzEgPSByZXF1aXJlKFwidnNjb2RlXCIpO1xuY29uc3QgY29uZmlnU2V0dGluZ3NfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vY29uZmlnU2V0dGluZ3NcIik7XG5jb25zdCB0ZWxlbWV0cnlfMSA9IHJlcXVpcmUoXCIuLi90ZWxlbWV0cnlcIik7XG5jb25zdCBjb25zdGFudHNfMSA9IHJlcXVpcmUoXCIuLi90ZWxlbWV0cnkvY29uc3RhbnRzXCIpO1xuY2xhc3MgR2VuZXJhdG9yIHtcbiAgICBjb25zdHJ1Y3Rvcih3b3Jrc3BhY2VGb2xkZXIsIG91dHB1dCwgcHJvY2Vzc1NlcnZpY2VGYWN0b3J5KSB7XG4gICAgICAgIHRoaXMud29ya3NwYWNlRm9sZGVyID0gd29ya3NwYWNlRm9sZGVyO1xuICAgICAgICB0aGlzLm91dHB1dCA9IG91dHB1dDtcbiAgICAgICAgdGhpcy5wcm9jZXNzU2VydmljZUZhY3RvcnkgPSBwcm9jZXNzU2VydmljZUZhY3Rvcnk7XG4gICAgICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBbXTtcbiAgICAgICAgdGhpcy5vcHRpb25zRmlsZSA9IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLicsICcuLicsICcuLicsICdyZXNvdXJjZXMnLCAnY3RhZ09wdGlvbnMnKTtcbiAgICAgICAgdGhpcy5weXRob25TZXR0aW5ncyA9IGNvbmZpZ1NldHRpbmdzXzEuUHl0aG9uU2V0dGluZ3MuZ2V0SW5zdGFuY2Uod29ya3NwYWNlRm9sZGVyKTtcbiAgICB9XG4gICAgZ2V0IHRhZ0ZpbGVQYXRoKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5weXRob25TZXR0aW5ncy53b3Jrc3BhY2VTeW1ib2xzLnRhZ0ZpbGVQYXRoO1xuICAgIH1cbiAgICBnZXQgZW5hYmxlZCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHl0aG9uU2V0dGluZ3Mud29ya3NwYWNlU3ltYm9scy5lbmFibGVkO1xuICAgIH1cbiAgICBkaXNwb3NlKCkge1xuICAgICAgICB0aGlzLmRpc3Bvc2FibGVzLmZvckVhY2goZCA9PiBkLmRpc3Bvc2UoKSk7XG4gICAgfVxuICAgIGdlbmVyYXRlV29ya3NwYWNlVGFncygpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5weXRob25TZXR0aW5ncy53b3Jrc3BhY2VTeW1ib2xzLmVuYWJsZWQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZW5lcmF0ZVRhZ3MoeyBkaXJlY3Rvcnk6IHRoaXMud29ya3NwYWNlRm9sZGVyLmZzUGF0aCB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGJ1aWxkQ21kQXJncygpIHtcbiAgICAgICAgY29uc3QgZXhjbHVzaW9ucyA9IHRoaXMucHl0aG9uU2V0dGluZ3Mud29ya3NwYWNlU3ltYm9scy5leGNsdXNpb25QYXR0ZXJucztcbiAgICAgICAgY29uc3QgZXhjbHVkZXMgPSBleGNsdXNpb25zLmxlbmd0aCA9PT0gMCA/IFtdIDogZXhjbHVzaW9ucy5tYXAocGF0dGVybiA9PiBgLS1leGNsdWRlPSR7cGF0dGVybn1gKTtcbiAgICAgICAgcmV0dXJuIFtgLS1vcHRpb25zPSR7dGhpcy5vcHRpb25zRmlsZX1gLCAnLS1sYW5ndWFnZXM9UHl0aG9uJ10uY29uY2F0KGV4Y2x1ZGVzKTtcbiAgICB9XG4gICAgZ2VuZXJhdGVUYWdzKHNvdXJjZSkge1xuICAgICAgICBjb25zdCB0YWdGaWxlID0gcGF0aC5ub3JtYWxpemUodGhpcy5weXRob25TZXR0aW5ncy53b3Jrc3BhY2VTeW1ib2xzLnRhZ0ZpbGVQYXRoKTtcbiAgICAgICAgY29uc3QgY21kID0gdGhpcy5weXRob25TZXR0aW5ncy53b3Jrc3BhY2VTeW1ib2xzLmN0YWdzUGF0aDtcbiAgICAgICAgY29uc3QgYXJncyA9IHRoaXMuYnVpbGRDbWRBcmdzKCk7XG4gICAgICAgIGxldCBvdXRwdXRGaWxlID0gdGFnRmlsZTtcbiAgICAgICAgaWYgKHNvdXJjZS5maWxlICYmIHNvdXJjZS5maWxlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHNvdXJjZS5kaXJlY3RvcnkgPSBwYXRoLmRpcm5hbWUoc291cmNlLmZpbGUpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwYXRoLmRpcm5hbWUob3V0cHV0RmlsZSkgPT09IHNvdXJjZS5kaXJlY3RvcnkpIHtcbiAgICAgICAgICAgIG91dHB1dEZpbGUgPSBwYXRoLmJhc2VuYW1lKG91dHB1dEZpbGUpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IG91dHB1dERpciA9IHBhdGguZGlybmFtZShvdXRwdXRGaWxlKTtcbiAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKG91dHB1dERpcikpIHtcbiAgICAgICAgICAgIGZzLm1rZGlyU3luYyhvdXRwdXREaXIpO1xuICAgICAgICB9XG4gICAgICAgIGFyZ3MucHVzaCgnLW8nLCBvdXRwdXRGaWxlLCAnLicpO1xuICAgICAgICB0aGlzLm91dHB1dC5hcHBlbmRMaW5lKGAkeyctJy5yZXBlYXQoMTApfUdlbmVyYXRpbmcgVGFncyR7Jy0nLnJlcGVhdCgxMCl9YCk7XG4gICAgICAgIHRoaXMub3V0cHV0LmFwcGVuZExpbmUoYCR7Y21kfSAke2FyZ3Muam9pbignICcpfWApO1xuICAgICAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgcHJvY2Vzc1NlcnZpY2UgPSB5aWVsZCB0aGlzLnByb2Nlc3NTZXJ2aWNlRmFjdG9yeS5jcmVhdGUoKTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHByb2Nlc3NTZXJ2aWNlLmV4ZWNPYnNlcnZhYmxlKGNtZCwgYXJncywgeyBjd2Q6IHNvdXJjZS5kaXJlY3RvcnkgfSk7XG4gICAgICAgICAgICBsZXQgZXJyb3JNc2cgPSAnJztcbiAgICAgICAgICAgIHJlc3VsdC5vdXQuc3Vic2NyaWJlKG91dHB1dCA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKG91dHB1dC5zb3VyY2UgPT09ICdzdGRlcnInKSB7XG4gICAgICAgICAgICAgICAgICAgIGVycm9yTXNnICs9IG91dHB1dC5vdXQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMub3V0cHV0LmFwcGVuZChvdXRwdXQub3V0KTtcbiAgICAgICAgICAgIH0sIHJlamVjdCwgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnJvck1zZy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoZXJyb3JNc2cpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSkpO1xuICAgICAgICB2c2NvZGVfMS53aW5kb3cuc2V0U3RhdHVzQmFyTWVzc2FnZSgnR2VuZXJhdGluZyBUYWdzJywgcHJvbWlzZSk7XG4gICAgICAgIHJldHVybiBwcm9taXNlO1xuICAgIH1cbn1cbl9fZGVjb3JhdGUoW1xuICAgIHRlbGVtZXRyeV8xLmNhcHR1cmVUZWxlbWV0cnkoY29uc3RhbnRzXzEuV09SS1NQQUNFX1NZTUJPTFNfQlVJTEQpXG5dLCBHZW5lcmF0b3IucHJvdG90eXBlLCBcImdlbmVyYXRlVGFnc1wiLCBudWxsKTtcbmV4cG9ydHMuR2VuZXJhdG9yID0gR2VuZXJhdG9yO1xuLy8jIHNvdXJjZU1hcHBpbmdVUkw9Z2VuZXJhdG9yLmpzLm1hcCJdfQ==