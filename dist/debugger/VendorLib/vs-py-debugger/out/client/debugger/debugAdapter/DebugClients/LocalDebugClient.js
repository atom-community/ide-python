"use strict";

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const child_process_1 = require("child_process");

const path = require("path");

const vscode_debugadapter_1 = require("vscode-debugadapter");

const open_1 = require("../../../common/open");

const pathUtils_1 = require("../../../common/platform/pathUtils");

const currentProcess_1 = require("../../../common/process/currentProcess");

const misc_1 = require("../../../common/utils/misc");

const environment_1 = require("../../../common/variables/environment");

const types_1 = require("../../types");

const Utils_1 = require("../Common/Utils");

const LocalDebugServerV2_1 = require("../DebugServers/LocalDebugServerV2");

const DebugClient_1 = require("./DebugClient");

const helper_1 = require("./helper");

const VALID_DEBUG_OPTIONS = ['RedirectOutput', 'DebugStdLib', 'StopOnEntry', 'ShowReturnValue', 'BreakOnSystemExitZero', 'DjangoDebugging', 'Django'];
var DebugServerStatus;

(function (DebugServerStatus) {
  DebugServerStatus[DebugServerStatus["Unknown"] = 1] = "Unknown";
  DebugServerStatus[DebugServerStatus["Running"] = 2] = "Running";
  DebugServerStatus[DebugServerStatus["NotRunning"] = 3] = "NotRunning";
})(DebugServerStatus || (DebugServerStatus = {}));

class LocalDebugClient extends DebugClient_1.DebugClient {
  constructor(args, debugSession, canLaunchTerminal, launcherScriptProvider) {
    super(args, debugSession);
    this.canLaunchTerminal = canLaunchTerminal;
    this.launcherScriptProvider = launcherScriptProvider;
  }

  get debugServerStatus() {
    if (this.debugServer && this.debugServer.IsRunning) {
      return DebugServerStatus.Running;
    }

    if (this.debugServer && !this.debugServer.IsRunning) {
      return DebugServerStatus.NotRunning;
    }

    return DebugServerStatus.Unknown;
  }

  CreateDebugServer(serviceContainer) {
    this.debugServer = new LocalDebugServerV2_1.LocalDebugServerV2(this.debugSession, this.args, serviceContainer);
    return this.debugServer;
  }

  get DebugType() {
    return DebugClient_1.DebugType.Local;
  }

  Stop() {
    if (this.debugServer) {
      this.debugServer.Stop();
      this.debugServer = undefined;
    }

    if (this.pyProc) {
      this.pyProc.kill();
      this.pyProc = undefined;
    }
  } // tslint:disable-next-line:no-any


  displayError(error) {
    const errorMsg = typeof error === 'string' ? error : error.message && error.message.length > 0 ? error.message : '';

    if (errorMsg.length > 0) {
      this.debugSession.sendEvent(new vscode_debugadapter_1.OutputEvent(errorMsg, 'stderr'));
    }
  } // tslint:disable-next-line:max-func-body-length member-ordering no-any


  LaunchApplicationToDebug(dbgServer) {
    return __awaiter(this, void 0, void 0, function* () {
      const pathUtils = new pathUtils_1.PathUtils(Utils_1.IS_WINDOWS);
      const currentProcess = new currentProcess_1.CurrentProcess();
      const environmentVariablesService = new environment_1.EnvironmentVariablesService(pathUtils);
      const helper = new helper_1.DebugClientHelper(environmentVariablesService, pathUtils, currentProcess);
      const environmentVariables = yield helper.getEnvironmentVariables(this.args); // tslint:disable-next-line:max-func-body-length cyclomatic-complexity no-any

      return new Promise((resolve, reject) => {
        const fileDir = this.args && this.args.program ? path.dirname(this.args.program) : '';
        let processCwd = fileDir;

        if (typeof this.args.cwd === 'string' && this.args.cwd.length > 0 && this.args.cwd !== 'null') {
          processCwd = this.args.cwd;
        }

        let pythonPath = 'python';

        if (typeof this.args.pythonPath === 'string' && this.args.pythonPath.trim().length > 0) {
          pythonPath = this.args.pythonPath;
        }

        const args = this.buildLaunchArguments(processCwd, dbgServer.port);

        switch (this.args.console) {
          case 'externalTerminal':
          case 'integratedTerminal':
            {
              const isSudo = Array.isArray(this.args.debugOptions) && this.args.debugOptions.some(opt => opt === 'Sudo');
              this.launchExternalTerminal(isSudo, processCwd, pythonPath, args, environmentVariables).then(resolve).catch(reject);
              break;
            }

          default:
            {
              this.pyProc = child_process_1.spawn(pythonPath, args, {
                cwd: processCwd,
                env: environmentVariables
              });
              this.handleProcessOutput(this.pyProc, reject); // Here we wait for the application to connect to the socket server.
              // Only once connected do we know that the application has successfully launched.

              this.debugServer.DebugClientConnected.then(resolve).catch(ex => console.error('Python Extension: debugServer.DebugClientConnected', ex));
            }
        }
      });
    });
  } // tslint:disable-next-line:member-ordering


  handleProcessOutput(proc, failedToLaunch) {
    proc.on('error', error => {
      // If debug server has started, then don't display errors.
      // The debug adapter will get this info from the debugger (e.g. ptvsd lib).
      const status = this.debugServerStatus;

      if (status === DebugServerStatus.Running) {
        return;
      }

      if (status === DebugServerStatus.NotRunning && typeof error === 'object' && error !== null) {
        return failedToLaunch(error);
      } // This could happen when the debugger didn't launch at all, e.g. python doesn't exist.


      this.displayError(error);
    });
    proc.stderr.setEncoding('utf8');
    proc.stderr.on('data', misc_1.noop);
    proc.stdout.on('data', d => {
      // This is necessary so we read the stdout of the python process,
      // Else it just keep building up (related to issue #203 and #52).
      // tslint:disable-next-line:prefer-const no-unused-variable
      let x = 0;
    });
  }

  buildLaunchArguments(cwd, debugPort) {
    return [...this.buildDebugArguments(cwd, debugPort), ...this.buildStandardArguments()];
  } // tslint:disable-next-line:member-ordering


  buildDebugArguments(cwd, debugPort) {
    const ptVSToolsFilePath = this.launcherScriptProvider.getLauncherFilePath();
    const vsDebugOptions = [types_1.DebugOptions.RedirectOutput];

    if (Array.isArray(this.args.debugOptions)) {
      this.args.debugOptions.filter(opt => VALID_DEBUG_OPTIONS.indexOf(opt) >= 0).forEach(item => vsDebugOptions.push(item));
    }

    const djangoIndex = vsDebugOptions.indexOf(types_1.DebugOptions.Django); // PTVSD expects the string `DjangoDebugging`

    if (djangoIndex >= 0) {
      vsDebugOptions[djangoIndex] = 'DjangoDebugging';
    }

    return [ptVSToolsFilePath, cwd, debugPort.toString(), '34806ad9-833a-4524-8cd6-18ca4aa74f14', vsDebugOptions.join(',')];
  } // tslint:disable-next-line:member-ordering


  buildStandardArguments() {
    const programArgs = Array.isArray(this.args.args) && this.args.args.length > 0 ? this.args.args : [];

    if (typeof this.args.module === 'string' && this.args.module.length > 0) {
      return ['-m', this.args.module, ...programArgs];
    }

    if (this.args.program && this.args.program.length > 0) {
      return [this.args.program, ...programArgs];
    }

    return programArgs;
  }

  launchExternalTerminal(sudo, cwd, pythonPath, args, env) {
    return new Promise((resolve, reject) => {
      if (this.canLaunchTerminal) {
        const command = sudo ? 'sudo' : pythonPath;
        const commandArgs = sudo ? [pythonPath].concat(args) : args;
        const isExternalTerminal = this.args.console === 'externalTerminal';
        const consoleKind = isExternalTerminal ? 'external' : 'integrated';
        const termArgs = {
          kind: consoleKind,
          title: 'Python Debug Console',
          cwd,
          args: [command].concat(commandArgs),
          env
        };
        this.debugSession.runInTerminalRequest(termArgs, 5000, response => {
          if (response.success) {
            resolve();
          } else {
            reject(response);
          }
        });
      } else {
        open_1.open({
          wait: false,
          app: [pythonPath].concat(args),
          cwd,
          env,
          sudo: sudo
        }).then(proc => {
          this.pyProc = proc;
          resolve();
        }, error => {
          if (this.debugServerStatus === DebugServerStatus.Running) {
            return;
          }

          reject(error);
        });
      }
    });
  }

}

exports.LocalDebugClient = LocalDebugClient;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkxvY2FsRGVidWdDbGllbnQuanMiXSwibmFtZXMiOlsiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsImNoaWxkX3Byb2Nlc3NfMSIsInJlcXVpcmUiLCJwYXRoIiwidnNjb2RlX2RlYnVnYWRhcHRlcl8xIiwib3Blbl8xIiwicGF0aFV0aWxzXzEiLCJjdXJyZW50UHJvY2Vzc18xIiwibWlzY18xIiwiZW52aXJvbm1lbnRfMSIsInR5cGVzXzEiLCJVdGlsc18xIiwiTG9jYWxEZWJ1Z1NlcnZlclYyXzEiLCJEZWJ1Z0NsaWVudF8xIiwiaGVscGVyXzEiLCJWQUxJRF9ERUJVR19PUFRJT05TIiwiRGVidWdTZXJ2ZXJTdGF0dXMiLCJMb2NhbERlYnVnQ2xpZW50IiwiRGVidWdDbGllbnQiLCJjb25zdHJ1Y3RvciIsImFyZ3MiLCJkZWJ1Z1Nlc3Npb24iLCJjYW5MYXVuY2hUZXJtaW5hbCIsImxhdW5jaGVyU2NyaXB0UHJvdmlkZXIiLCJkZWJ1Z1NlcnZlclN0YXR1cyIsImRlYnVnU2VydmVyIiwiSXNSdW5uaW5nIiwiUnVubmluZyIsIk5vdFJ1bm5pbmciLCJVbmtub3duIiwiQ3JlYXRlRGVidWdTZXJ2ZXIiLCJzZXJ2aWNlQ29udGFpbmVyIiwiTG9jYWxEZWJ1Z1NlcnZlclYyIiwiRGVidWdUeXBlIiwiTG9jYWwiLCJTdG9wIiwidW5kZWZpbmVkIiwicHlQcm9jIiwia2lsbCIsImRpc3BsYXlFcnJvciIsImVycm9yIiwiZXJyb3JNc2ciLCJtZXNzYWdlIiwibGVuZ3RoIiwic2VuZEV2ZW50IiwiT3V0cHV0RXZlbnQiLCJMYXVuY2hBcHBsaWNhdGlvblRvRGVidWciLCJkYmdTZXJ2ZXIiLCJwYXRoVXRpbHMiLCJQYXRoVXRpbHMiLCJJU19XSU5ET1dTIiwiY3VycmVudFByb2Nlc3MiLCJDdXJyZW50UHJvY2VzcyIsImVudmlyb25tZW50VmFyaWFibGVzU2VydmljZSIsIkVudmlyb25tZW50VmFyaWFibGVzU2VydmljZSIsImhlbHBlciIsIkRlYnVnQ2xpZW50SGVscGVyIiwiZW52aXJvbm1lbnRWYXJpYWJsZXMiLCJnZXRFbnZpcm9ubWVudFZhcmlhYmxlcyIsImZpbGVEaXIiLCJwcm9ncmFtIiwiZGlybmFtZSIsInByb2Nlc3NDd2QiLCJjd2QiLCJweXRob25QYXRoIiwidHJpbSIsImJ1aWxkTGF1bmNoQXJndW1lbnRzIiwicG9ydCIsImNvbnNvbGUiLCJpc1N1ZG8iLCJBcnJheSIsImlzQXJyYXkiLCJkZWJ1Z09wdGlvbnMiLCJzb21lIiwib3B0IiwibGF1bmNoRXh0ZXJuYWxUZXJtaW5hbCIsImNhdGNoIiwic3Bhd24iLCJlbnYiLCJoYW5kbGVQcm9jZXNzT3V0cHV0IiwiRGVidWdDbGllbnRDb25uZWN0ZWQiLCJleCIsInByb2MiLCJmYWlsZWRUb0xhdW5jaCIsIm9uIiwic3RhdHVzIiwic3RkZXJyIiwic2V0RW5jb2RpbmciLCJub29wIiwic3Rkb3V0IiwiZCIsIngiLCJkZWJ1Z1BvcnQiLCJidWlsZERlYnVnQXJndW1lbnRzIiwiYnVpbGRTdGFuZGFyZEFyZ3VtZW50cyIsInB0VlNUb29sc0ZpbGVQYXRoIiwiZ2V0TGF1bmNoZXJGaWxlUGF0aCIsInZzRGVidWdPcHRpb25zIiwiRGVidWdPcHRpb25zIiwiUmVkaXJlY3RPdXRwdXQiLCJmaWx0ZXIiLCJpbmRleE9mIiwiZm9yRWFjaCIsIml0ZW0iLCJwdXNoIiwiZGphbmdvSW5kZXgiLCJEamFuZ28iLCJ0b1N0cmluZyIsImpvaW4iLCJwcm9ncmFtQXJncyIsIm1vZHVsZSIsInN1ZG8iLCJjb21tYW5kIiwiY29tbWFuZEFyZ3MiLCJjb25jYXQiLCJpc0V4dGVybmFsVGVybWluYWwiLCJjb25zb2xlS2luZCIsInRlcm1BcmdzIiwia2luZCIsInRpdGxlIiwicnVuSW5UZXJtaW5hbFJlcXVlc3QiLCJyZXNwb25zZSIsInN1Y2Nlc3MiLCJvcGVuIiwid2FpdCIsImFwcCJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FBL0IsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3JGLFNBQU8sS0FBS0QsQ0FBQyxLQUFLQSxDQUFDLEdBQUdFLE9BQVQsQ0FBTixFQUF5QixVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUN2RCxhQUFTQyxTQUFULENBQW1CQyxLQUFuQixFQUEwQjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUNPLElBQVYsQ0FBZUYsS0FBZixDQUFELENBQUo7QUFBOEIsT0FBcEMsQ0FBcUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDM0YsYUFBU0MsUUFBVCxDQUFrQkosS0FBbEIsRUFBeUI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDLE9BQUQsQ0FBVCxDQUFtQkssS0FBbkIsQ0FBRCxDQUFKO0FBQWtDLE9BQXhDLENBQXlDLE9BQU9HLENBQVAsRUFBVTtBQUFFTCxRQUFBQSxNQUFNLENBQUNLLENBQUQsQ0FBTjtBQUFZO0FBQUU7O0FBQzlGLGFBQVNGLElBQVQsQ0FBY0ksTUFBZCxFQUFzQjtBQUFFQSxNQUFBQSxNQUFNLENBQUNDLElBQVAsR0FBY1QsT0FBTyxDQUFDUSxNQUFNLENBQUNMLEtBQVIsQ0FBckIsR0FBc0MsSUFBSU4sQ0FBSixDQUFNLFVBQVVHLE9BQVYsRUFBbUI7QUFBRUEsUUFBQUEsT0FBTyxDQUFDUSxNQUFNLENBQUNMLEtBQVIsQ0FBUDtBQUF3QixPQUFuRCxFQUFxRE8sSUFBckQsQ0FBMERSLFNBQTFELEVBQXFFSyxR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X2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XG4gICAgfSk7XG59O1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuY29uc3QgY2hpbGRfcHJvY2Vzc18xID0gcmVxdWlyZShcImNoaWxkX3Byb2Nlc3NcIik7XG5jb25zdCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XG5jb25zdCB2c2NvZGVfZGVidWdhZGFwdGVyXzEgPSByZXF1aXJlKFwidnNjb2RlLWRlYnVnYWRhcHRlclwiKTtcbmNvbnN0IG9wZW5fMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jb21tb24vb3BlblwiKTtcbmNvbnN0IHBhdGhVdGlsc18xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NvbW1vbi9wbGF0Zm9ybS9wYXRoVXRpbHNcIik7XG5jb25zdCBjdXJyZW50UHJvY2Vzc18xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NvbW1vbi9wcm9jZXNzL2N1cnJlbnRQcm9jZXNzXCIpO1xuY29uc3QgbWlzY18xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NvbW1vbi91dGlscy9taXNjXCIpO1xuY29uc3QgZW52aXJvbm1lbnRfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jb21tb24vdmFyaWFibGVzL2Vudmlyb25tZW50XCIpO1xuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi8uLi90eXBlc1wiKTtcbmNvbnN0IFV0aWxzXzEgPSByZXF1aXJlKFwiLi4vQ29tbW9uL1V0aWxzXCIpO1xuY29uc3QgTG9jYWxEZWJ1Z1NlcnZlclYyXzEgPSByZXF1aXJlKFwiLi4vRGVidWdTZXJ2ZXJzL0xvY2FsRGVidWdTZXJ2ZXJWMlwiKTtcbmNvbnN0IERlYnVnQ2xpZW50XzEgPSByZXF1aXJlKFwiLi9EZWJ1Z0NsaWVudFwiKTtcbmNvbnN0IGhlbHBlcl8xID0gcmVxdWlyZShcIi4vaGVscGVyXCIpO1xuY29uc3QgVkFMSURfREVCVUdfT1BUSU9OUyA9IFtcbiAgICAnUmVkaXJlY3RPdXRwdXQnLFxuICAgICdEZWJ1Z1N0ZExpYicsXG4gICAgJ1N0b3BPbkVudHJ5JyxcbiAgICAnU2hvd1JldHVyblZhbHVlJyxcbiAgICAnQnJlYWtPblN5c3RlbUV4aXRaZXJvJyxcbiAgICAnRGphbmdvRGVidWdnaW5nJyxcbiAgICAnRGphbmdvJ1xuXTtcbnZhciBEZWJ1Z1NlcnZlclN0YXR1cztcbihmdW5jdGlvbiAoRGVidWdTZXJ2ZXJTdGF0dXMpIHtcbiAgICBEZWJ1Z1NlcnZlclN0YXR1c1tEZWJ1Z1NlcnZlclN0YXR1c1tcIlVua25vd25cIl0gPSAxXSA9IFwiVW5rbm93blwiO1xuICAgIERlYnVnU2VydmVyU3RhdHVzW0RlYnVnU2VydmVyU3RhdHVzW1wiUnVubmluZ1wiXSA9IDJdID0gXCJSdW5uaW5nXCI7XG4gICAgRGVidWdTZXJ2ZXJTdGF0dXNbRGVidWdTZXJ2ZXJTdGF0dXNbXCJOb3RSdW5uaW5nXCJdID0gM10gPSBcIk5vdFJ1bm5pbmdcIjtcbn0pKERlYnVnU2VydmVyU3RhdHVzIHx8IChEZWJ1Z1NlcnZlclN0YXR1cyA9IHt9KSk7XG5jbGFzcyBMb2NhbERlYnVnQ2xpZW50IGV4dGVuZHMgRGVidWdDbGllbnRfMS5EZWJ1Z0NsaWVudCB7XG4gICAgY29uc3RydWN0b3IoYXJncywgZGVidWdTZXNzaW9uLCBjYW5MYXVuY2hUZXJtaW5hbCwgbGF1bmNoZXJTY3JpcHRQcm92aWRlcikge1xuICAgICAgICBzdXBlcihhcmdzLCBkZWJ1Z1Nlc3Npb24pO1xuICAgICAgICB0aGlzLmNhbkxhdW5jaFRlcm1pbmFsID0gY2FuTGF1bmNoVGVybWluYWw7XG4gICAgICAgIHRoaXMubGF1bmNoZXJTY3JpcHRQcm92aWRlciA9IGxhdW5jaGVyU2NyaXB0UHJvdmlkZXI7XG4gICAgfVxuICAgIGdldCBkZWJ1Z1NlcnZlclN0YXR1cygpIHtcbiAgICAgICAgaWYgKHRoaXMuZGVidWdTZXJ2ZXIgJiYgdGhpcy5kZWJ1Z1NlcnZlci5Jc1J1bm5pbmcpIHtcbiAgICAgICAgICAgIHJldHVybiBEZWJ1Z1NlcnZlclN0YXR1cy5SdW5uaW5nO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmRlYnVnU2VydmVyICYmICF0aGlzLmRlYnVnU2VydmVyLklzUnVubmluZykge1xuICAgICAgICAgICAgcmV0dXJuIERlYnVnU2VydmVyU3RhdHVzLk5vdFJ1bm5pbmc7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIERlYnVnU2VydmVyU3RhdHVzLlVua25vd247XG4gICAgfVxuICAgIENyZWF0ZURlYnVnU2VydmVyKHNlcnZpY2VDb250YWluZXIpIHtcbiAgICAgICAgdGhpcy5kZWJ1Z1NlcnZlciA9IG5ldyBMb2NhbERlYnVnU2VydmVyVjJfMS5Mb2NhbERlYnVnU2VydmVyVjIodGhpcy5kZWJ1Z1Nlc3Npb24sIHRoaXMuYXJncywgc2VydmljZUNvbnRhaW5lcik7XG4gICAgICAgIHJldHVybiB0aGlzLmRlYnVnU2VydmVyO1xuICAgIH1cbiAgICBnZXQgRGVidWdUeXBlKCkge1xuICAgICAgICByZXR1cm4gRGVidWdDbGllbnRfMS5EZWJ1Z1R5cGUuTG9jYWw7XG4gICAgfVxuICAgIFN0b3AoKSB7XG4gICAgICAgIGlmICh0aGlzLmRlYnVnU2VydmVyKSB7XG4gICAgICAgICAgICB0aGlzLmRlYnVnU2VydmVyLlN0b3AoKTtcbiAgICAgICAgICAgIHRoaXMuZGVidWdTZXJ2ZXIgPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMucHlQcm9jKSB7XG4gICAgICAgICAgICB0aGlzLnB5UHJvYy5raWxsKCk7XG4gICAgICAgICAgICB0aGlzLnB5UHJvYyA9IHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgIH1cbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55XG4gICAgZGlzcGxheUVycm9yKGVycm9yKSB7XG4gICAgICAgIGNvbnN0IGVycm9yTXNnID0gdHlwZW9mIGVycm9yID09PSAnc3RyaW5nJyA/IGVycm9yIDogKChlcnJvci5tZXNzYWdlICYmIGVycm9yLm1lc3NhZ2UubGVuZ3RoID4gMCkgPyBlcnJvci5tZXNzYWdlIDogJycpO1xuICAgICAgICBpZiAoZXJyb3JNc2cubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdGhpcy5kZWJ1Z1Nlc3Npb24uc2VuZEV2ZW50KG5ldyB2c2NvZGVfZGVidWdhZGFwdGVyXzEuT3V0cHV0RXZlbnQoZXJyb3JNc2csICdzdGRlcnInKSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1mdW5jLWJvZHktbGVuZ3RoIG1lbWJlci1vcmRlcmluZyBuby1hbnlcbiAgICBMYXVuY2hBcHBsaWNhdGlvblRvRGVidWcoZGJnU2VydmVyKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBwYXRoVXRpbHMgPSBuZXcgcGF0aFV0aWxzXzEuUGF0aFV0aWxzKFV0aWxzXzEuSVNfV0lORE9XUyk7XG4gICAgICAgICAgICBjb25zdCBjdXJyZW50UHJvY2VzcyA9IG5ldyBjdXJyZW50UHJvY2Vzc18xLkN1cnJlbnRQcm9jZXNzKCk7XG4gICAgICAgICAgICBjb25zdCBlbnZpcm9ubWVudFZhcmlhYmxlc1NlcnZpY2UgPSBuZXcgZW52aXJvbm1lbnRfMS5FbnZpcm9ubWVudFZhcmlhYmxlc1NlcnZpY2UocGF0aFV0aWxzKTtcbiAgICAgICAgICAgIGNvbnN0IGhlbHBlciA9IG5ldyBoZWxwZXJfMS5EZWJ1Z0NsaWVudEhlbHBlcihlbnZpcm9ubWVudFZhcmlhYmxlc1NlcnZpY2UsIHBhdGhVdGlscywgY3VycmVudFByb2Nlc3MpO1xuICAgICAgICAgICAgY29uc3QgZW52aXJvbm1lbnRWYXJpYWJsZXMgPSB5aWVsZCBoZWxwZXIuZ2V0RW52aXJvbm1lbnRWYXJpYWJsZXModGhpcy5hcmdzKTtcbiAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtZnVuYy1ib2R5LWxlbmd0aCBjeWNsb21hdGljLWNvbXBsZXhpdHkgbm8tYW55XG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGZpbGVEaXIgPSB0aGlzLmFyZ3MgJiYgdGhpcy5hcmdzLnByb2dyYW0gPyBwYXRoLmRpcm5hbWUodGhpcy5hcmdzLnByb2dyYW0pIDogJyc7XG4gICAgICAgICAgICAgICAgbGV0IHByb2Nlc3NDd2QgPSBmaWxlRGlyO1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5hcmdzLmN3ZCA9PT0gJ3N0cmluZycgJiYgdGhpcy5hcmdzLmN3ZC5sZW5ndGggPiAwICYmIHRoaXMuYXJncy5jd2QgIT09ICdudWxsJykge1xuICAgICAgICAgICAgICAgICAgICBwcm9jZXNzQ3dkID0gdGhpcy5hcmdzLmN3ZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbGV0IHB5dGhvblBhdGggPSAncHl0aG9uJztcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuYXJncy5weXRob25QYXRoID09PSAnc3RyaW5nJyAmJiB0aGlzLmFyZ3MucHl0aG9uUGF0aC50cmltKCkubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBweXRob25QYXRoID0gdGhpcy5hcmdzLnB5dGhvblBhdGg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbnN0IGFyZ3MgPSB0aGlzLmJ1aWxkTGF1bmNoQXJndW1lbnRzKHByb2Nlc3NDd2QsIGRiZ1NlcnZlci5wb3J0KTtcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKHRoaXMuYXJncy5jb25zb2xlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2V4dGVybmFsVGVybWluYWwnOlxuICAgICAgICAgICAgICAgICAgICBjYXNlICdpbnRlZ3JhdGVkVGVybWluYWwnOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1N1ZG8gPSBBcnJheS5pc0FycmF5KHRoaXMuYXJncy5kZWJ1Z09wdGlvbnMpICYmIHRoaXMuYXJncy5kZWJ1Z09wdGlvbnMuc29tZShvcHQgPT4gb3B0ID09PSAnU3VkbycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXVuY2hFeHRlcm5hbFRlcm1pbmFsKGlzU3VkbywgcHJvY2Vzc0N3ZCwgcHl0aG9uUGF0aCwgYXJncywgZW52aXJvbm1lbnRWYXJpYWJsZXMpLnRoZW4ocmVzb2x2ZSkuY2F0Y2gocmVqZWN0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHlQcm9jID0gY2hpbGRfcHJvY2Vzc18xLnNwYXduKHB5dGhvblBhdGgsIGFyZ3MsIHsgY3dkOiBwcm9jZXNzQ3dkLCBlbnY6IGVudmlyb25tZW50VmFyaWFibGVzIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVQcm9jZXNzT3V0cHV0KHRoaXMucHlQcm9jLCByZWplY3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gSGVyZSB3ZSB3YWl0IGZvciB0aGUgYXBwbGljYXRpb24gdG8gY29ubmVjdCB0byB0aGUgc29ja2V0IHNlcnZlci5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgb25jZSBjb25uZWN0ZWQgZG8gd2Uga25vdyB0aGF0IHRoZSBhcHBsaWNhdGlvbiBoYXMgc3VjY2Vzc2Z1bGx5IGxhdW5jaGVkLlxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWJ1Z1NlcnZlci5EZWJ1Z0NsaWVudENvbm5lY3RlZFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKHJlc29sdmUpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGV4ID0+IGNvbnNvbGUuZXJyb3IoJ1B5dGhvbiBFeHRlbnNpb246IGRlYnVnU2VydmVyLkRlYnVnQ2xpZW50Q29ubmVjdGVkJywgZXgpKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1lbWJlci1vcmRlcmluZ1xuICAgIGhhbmRsZVByb2Nlc3NPdXRwdXQocHJvYywgZmFpbGVkVG9MYXVuY2gpIHtcbiAgICAgICAgcHJvYy5vbignZXJyb3InLCBlcnJvciA9PiB7XG4gICAgICAgICAgICAvLyBJZiBkZWJ1ZyBzZXJ2ZXIgaGFzIHN0YXJ0ZWQsIHRoZW4gZG9uJ3QgZGlzcGxheSBlcnJvcnMuXG4gICAgICAgICAgICAvLyBUaGUgZGVidWcgYWRhcHRlciB3aWxsIGdldCB0aGlzIGluZm8gZnJvbSB0aGUgZGVidWdnZXIgKGUuZy4gcHR2c2QgbGliKS5cbiAgICAgICAgICAgIGNvbnN0IHN0YXR1cyA9IHRoaXMuZGVidWdTZXJ2ZXJTdGF0dXM7XG4gICAgICAgICAgICBpZiAoc3RhdHVzID09PSBEZWJ1Z1NlcnZlclN0YXR1cy5SdW5uaW5nKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHN0YXR1cyA9PT0gRGVidWdTZXJ2ZXJTdGF0dXMuTm90UnVubmluZyAmJiB0eXBlb2YgKGVycm9yKSA9PT0gJ29iamVjdCcgJiYgZXJyb3IgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFpbGVkVG9MYXVuY2goZXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gVGhpcyBjb3VsZCBoYXBwZW4gd2hlbiB0aGUgZGVidWdnZXIgZGlkbid0IGxhdW5jaCBhdCBhbGwsIGUuZy4gcHl0aG9uIGRvZXNuJ3QgZXhpc3QuXG4gICAgICAgICAgICB0aGlzLmRpc3BsYXlFcnJvcihlcnJvcik7XG4gICAgICAgIH0pO1xuICAgICAgICBwcm9jLnN0ZGVyci5zZXRFbmNvZGluZygndXRmOCcpO1xuICAgICAgICBwcm9jLnN0ZGVyci5vbignZGF0YScsIG1pc2NfMS5ub29wKTtcbiAgICAgICAgcHJvYy5zdGRvdXQub24oJ2RhdGEnLCBkID0+IHtcbiAgICAgICAgICAgIC8vIFRoaXMgaXMgbmVjZXNzYXJ5IHNvIHdlIHJlYWQgdGhlIHN0ZG91dCBvZiB0aGUgcHl0aG9uIHByb2Nlc3MsXG4gICAgICAgICAgICAvLyBFbHNlIGl0IGp1c3Qga2VlcCBidWlsZGluZyB1cCAocmVsYXRlZCB0byBpc3N1ZSAjMjAzIGFuZCAjNTIpLlxuICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnByZWZlci1jb25zdCBuby11bnVzZWQtdmFyaWFibGVcbiAgICAgICAgICAgIGxldCB4ID0gMDtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGJ1aWxkTGF1bmNoQXJndW1lbnRzKGN3ZCwgZGVidWdQb3J0KSB7XG4gICAgICAgIHJldHVybiBbLi4udGhpcy5idWlsZERlYnVnQXJndW1lbnRzKGN3ZCwgZGVidWdQb3J0KSwgLi4udGhpcy5idWlsZFN0YW5kYXJkQXJndW1lbnRzKCldO1xuICAgIH1cbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWVtYmVyLW9yZGVyaW5nXG4gICAgYnVpbGREZWJ1Z0FyZ3VtZW50cyhjd2QsIGRlYnVnUG9ydCkge1xuICAgICAgICBjb25zdCBwdFZTVG9vbHNGaWxlUGF0aCA9IHRoaXMubGF1bmNoZXJTY3JpcHRQcm92aWRlci5nZXRMYXVuY2hlckZpbGVQYXRoKCk7XG4gICAgICAgIGNvbnN0IHZzRGVidWdPcHRpb25zID0gW3R5cGVzXzEuRGVidWdPcHRpb25zLlJlZGlyZWN0T3V0cHV0XTtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy5hcmdzLmRlYnVnT3B0aW9ucykpIHtcbiAgICAgICAgICAgIHRoaXMuYXJncy5kZWJ1Z09wdGlvbnMuZmlsdGVyKG9wdCA9PiBWQUxJRF9ERUJVR19PUFRJT05TLmluZGV4T2Yob3B0KSA+PSAwKVxuICAgICAgICAgICAgICAgIC5mb3JFYWNoKGl0ZW0gPT4gdnNEZWJ1Z09wdGlvbnMucHVzaChpdGVtKSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZGphbmdvSW5kZXggPSB2c0RlYnVnT3B0aW9ucy5pbmRleE9mKHR5cGVzXzEuRGVidWdPcHRpb25zLkRqYW5nbyk7XG4gICAgICAgIC8vIFBUVlNEIGV4cGVjdHMgdGhlIHN0cmluZyBgRGphbmdvRGVidWdnaW5nYFxuICAgICAgICBpZiAoZGphbmdvSW5kZXggPj0gMCkge1xuICAgICAgICAgICAgdnNEZWJ1Z09wdGlvbnNbZGphbmdvSW5kZXhdID0gJ0RqYW5nb0RlYnVnZ2luZyc7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFtwdFZTVG9vbHNGaWxlUGF0aCwgY3dkLCBkZWJ1Z1BvcnQudG9TdHJpbmcoKSwgJzM0ODA2YWQ5LTgzM2EtNDUyNC04Y2Q2LTE4Y2E0YWE3NGYxNCcsIHZzRGVidWdPcHRpb25zLmpvaW4oJywnKV07XG4gICAgfVxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptZW1iZXItb3JkZXJpbmdcbiAgICBidWlsZFN0YW5kYXJkQXJndW1lbnRzKCkge1xuICAgICAgICBjb25zdCBwcm9ncmFtQXJncyA9IEFycmF5LmlzQXJyYXkodGhpcy5hcmdzLmFyZ3MpICYmIHRoaXMuYXJncy5hcmdzLmxlbmd0aCA+IDAgPyB0aGlzLmFyZ3MuYXJncyA6IFtdO1xuICAgICAgICBpZiAodHlwZW9mIHRoaXMuYXJncy5tb2R1bGUgPT09ICdzdHJpbmcnICYmIHRoaXMuYXJncy5tb2R1bGUubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcmV0dXJuIFsnLW0nLCB0aGlzLmFyZ3MubW9kdWxlLCAuLi5wcm9ncmFtQXJnc107XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuYXJncy5wcm9ncmFtICYmIHRoaXMuYXJncy5wcm9ncmFtLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHJldHVybiBbdGhpcy5hcmdzLnByb2dyYW0sIC4uLnByb2dyYW1BcmdzXTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcHJvZ3JhbUFyZ3M7XG4gICAgfVxuICAgIGxhdW5jaEV4dGVybmFsVGVybWluYWwoc3VkbywgY3dkLCBweXRob25QYXRoLCBhcmdzLCBlbnYpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLmNhbkxhdW5jaFRlcm1pbmFsKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY29tbWFuZCA9IHN1ZG8gPyAnc3VkbycgOiBweXRob25QYXRoO1xuICAgICAgICAgICAgICAgIGNvbnN0IGNvbW1hbmRBcmdzID0gc3VkbyA/IFtweXRob25QYXRoXS5jb25jYXQoYXJncykgOiBhcmdzO1xuICAgICAgICAgICAgICAgIGNvbnN0IGlzRXh0ZXJuYWxUZXJtaW5hbCA9IHRoaXMuYXJncy5jb25zb2xlID09PSAnZXh0ZXJuYWxUZXJtaW5hbCc7XG4gICAgICAgICAgICAgICAgY29uc3QgY29uc29sZUtpbmQgPSBpc0V4dGVybmFsVGVybWluYWwgPyAnZXh0ZXJuYWwnIDogJ2ludGVncmF0ZWQnO1xuICAgICAgICAgICAgICAgIGNvbnN0IHRlcm1BcmdzID0ge1xuICAgICAgICAgICAgICAgICAgICBraW5kOiBjb25zb2xlS2luZCxcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6ICdQeXRob24gRGVidWcgQ29uc29sZScsXG4gICAgICAgICAgICAgICAgICAgIGN3ZCxcbiAgICAgICAgICAgICAgICAgICAgYXJnczogW2NvbW1hbmRdLmNvbmNhdChjb21tYW5kQXJncyksXG4gICAgICAgICAgICAgICAgICAgIGVudlxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgdGhpcy5kZWJ1Z1Nlc3Npb24ucnVuSW5UZXJtaW5hbFJlcXVlc3QodGVybUFyZ3MsIDUwMDAsIChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2Uuc3VjY2Vzcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KHJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgb3Blbl8xLm9wZW4oeyB3YWl0OiBmYWxzZSwgYXBwOiBbcHl0aG9uUGF0aF0uY29uY2F0KGFyZ3MpLCBjd2QsIGVudiwgc3Vkbzogc3VkbyB9KS50aGVuKHByb2MgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnB5UHJvYyA9IHByb2M7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRlYnVnU2VydmVyU3RhdHVzID09PSBEZWJ1Z1NlcnZlclN0YXR1cy5SdW5uaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufVxuZXhwb3J0cy5Mb2NhbERlYnVnQ2xpZW50ID0gTG9jYWxEZWJ1Z0NsaWVudDtcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPUxvY2FsRGVidWdDbGllbnQuanMubWFwIl19