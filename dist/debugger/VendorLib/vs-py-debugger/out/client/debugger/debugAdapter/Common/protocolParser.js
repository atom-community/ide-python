"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

Object.defineProperty(exports, "__esModule", {
  value: true
}); // tslint:disable:no-constant-condition no-typeof-undefined

const events_1 = require("events");

const inversify_1 = require("inversify");

const PROTOCOL_START_INDENTIFIER = '\r\n\r\n';
/**
 * Parsers the debugger Protocol messages and raises the following events:
 * 1. 'data', message (for all protocol messages)
 * 1. 'event_<event name>', message (for all protocol events)
 * 1. 'request_<command name>', message (for all protocol requests)
 * 1. 'response_<command name>', message (for all protocol responses)
 * 1. '<type>', message (for all protocol messages that are not events, requests nor responses)
 * @export
 * @class ProtocolParser
 * @extends {EventEmitter}
 * @implements {IProtocolParser}
 */

let ProtocolParser = class ProtocolParser extends events_1.EventEmitter {
  constructor() {
    super();
    this.rawData = new Buffer(0);
    this.contentLength = -1;
    this.disposed = false;

    this.dataCallbackHandler = data => {
      this.handleData(data);
    };
  }

  dispose() {
    if (this.stream) {
      this.stream.removeListener('data', this.dataCallbackHandler);
      this.stream = undefined;
    }
  }

  connect(stream) {
    this.stream = stream;
    stream.addListener('data', this.dataCallbackHandler);
  }

  dispatch(body) {
    const message = JSON.parse(body);

    switch (message.type) {
      case 'event':
        {
          const event = message;

          if (typeof event.event === 'string') {
            this.emit(`${message.type}_${event.event}`, event);
            break;
          }
        }

      case 'request':
        {
          const request = message;

          if (typeof request.command === 'string') {
            this.emit(`${message.type}_${request.command}`, request);
            break;
          }
        }

      case 'response':
        {
          const reponse = message;

          if (typeof reponse.command === 'string') {
            this.emit(`${message.type}_${reponse.command}`, reponse);
            break;
          }
        }

      default:
        {
          this.emit(`${message.type}`, message);
        }
    }

    this.emit('data', message);
  }

  handleData(data) {
    if (this.disposed) {
      return;
    }

    this.rawData = Buffer.concat([this.rawData, data]);

    while (true) {
      if (this.contentLength >= 0) {
        if (this.rawData.length >= this.contentLength) {
          const message = this.rawData.toString('utf8', 0, this.contentLength);
          this.rawData = this.rawData.slice(this.contentLength);
          this.contentLength = -1;

          if (message.length > 0) {
            this.dispatch(message);
          } // there may be more complete messages to process.


          continue;
        }
      } else {
        const idx = this.rawData.indexOf(PROTOCOL_START_INDENTIFIER);

        if (idx !== -1) {
          const header = this.rawData.toString('utf8', 0, idx);
          const lines = header.split('\r\n');

          for (const line of lines) {
            const pair = line.split(/: +/);

            if (pair[0] === 'Content-Length') {
              this.contentLength = +pair[1];
            }
          }

          this.rawData = this.rawData.slice(idx + PROTOCOL_START_INDENTIFIER.length);
          continue;
        }
      }

      break;
    }
  }

};
ProtocolParser = __decorate([inversify_1.injectable()], ProtocolParser);
exports.ProtocolParser = ProtocolParser;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByb3RvY29sUGFyc2VyLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsImV2ZW50c18xIiwicmVxdWlyZSIsImludmVyc2lmeV8xIiwiUFJPVE9DT0xfU1RBUlRfSU5ERU5USUZJRVIiLCJQcm90b2NvbFBhcnNlciIsIkV2ZW50RW1pdHRlciIsImNvbnN0cnVjdG9yIiwicmF3RGF0YSIsIkJ1ZmZlciIsImNvbnRlbnRMZW5ndGgiLCJkaXNwb3NlZCIsImRhdGFDYWxsYmFja0hhbmRsZXIiLCJkYXRhIiwiaGFuZGxlRGF0YSIsImRpc3Bvc2UiLCJzdHJlYW0iLCJyZW1vdmVMaXN0ZW5lciIsInVuZGVmaW5lZCIsImNvbm5lY3QiLCJhZGRMaXN0ZW5lciIsImRpc3BhdGNoIiwiYm9keSIsIm1lc3NhZ2UiLCJKU09OIiwicGFyc2UiLCJ0eXBlIiwiZXZlbnQiLCJlbWl0IiwicmVxdWVzdCIsImNvbW1hbmQiLCJyZXBvbnNlIiwiY29uY2F0IiwidG9TdHJpbmciLCJzbGljZSIsImlkeCIsImluZGV4T2YiLCJoZWFkZXIiLCJsaW5lcyIsInNwbGl0IiwibGluZSIsInBhaXIiLCJpbmplY3RhYmxlIl0sIm1hcHBpbmdzIjoiQUFBQSxhLENBQ0E7QUFDQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEsTUFBMEJDLENBQUMsR0FBR0gsQ0FBQyxHQUFHLENBQUos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QXJGbUUsQ0FBeEU7QUF1RkFlLGNBQWMsR0FBR3RCLFVBQVUsQ0FBQyxDQUN4Qm9CLFdBQVcsQ0FBQ3VDLFVBQVosRUFEd0IsQ0FBRCxFQUV4QnJDLGNBRndCLENBQTNCO0FBR0FOLE9BQU8sQ0FBQ00sY0FBUixHQUF5QkEsY0FBekIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxudmFyIF9fZGVjb3JhdGUgPSAodGhpcyAmJiB0aGlzLl9fZGVjb3JhdGUpIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcbiAgICBlbHNlIGZvciAodmFyIGkgPSBkZWNvcmF0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBpZiAoZCA9IGRlY29yYXRvcnNbaV0pIHIgPSAoYyA8IDMgPyBkKHIpIDogYyA+IDMgPyBkKHRhcmdldCwga2V5LCByKSA6IGQodGFyZ2V0LCBrZXkpKSB8fCByO1xuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XG59O1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuLy8gdHNsaW50OmRpc2FibGU6bm8tY29uc3RhbnQtY29uZGl0aW9uIG5vLXR5cGVvZi11bmRlZmluZWRcbmNvbnN0IGV2ZW50c18xID0gcmVxdWlyZShcImV2ZW50c1wiKTtcbmNvbnN0IGludmVyc2lmeV8xID0gcmVxdWlyZShcImludmVyc2lmeVwiKTtcbmNvbnN0IFBST1RPQ09MX1NUQVJUX0lOREVOVElGSUVSID0gJ1xcclxcblxcclxcbic7XG4vKipcbiAqIFBhcnNlcnMgdGhlIGRlYnVnZ2VyIFByb3RvY29sIG1lc3NhZ2VzIGFuZCByYWlzZXMgdGhlIGZvbGxvd2luZyBldmVudHM6XG4gKiAxLiAnZGF0YScsIG1lc3NhZ2UgKGZvciBhbGwgcHJvdG9jb2wgbWVzc2FnZXMpXG4gKiAxLiAnZXZlbnRfPGV2ZW50IG5hbWU+JywgbWVzc2FnZSAoZm9yIGFsbCBwcm90b2NvbCBldmVudHMpXG4gKiAxLiAncmVxdWVzdF88Y29tbWFuZCBuYW1lPicsIG1lc3NhZ2UgKGZvciBhbGwgcHJvdG9jb2wgcmVxdWVzdHMpXG4gKiAxLiAncmVzcG9uc2VfPGNvbW1hbmQgbmFtZT4nLCBtZXNzYWdlIChmb3IgYWxsIHByb3RvY29sIHJlc3BvbnNlcylcbiAqIDEuICc8dHlwZT4nLCBtZXNzYWdlIChmb3IgYWxsIHByb3RvY29sIG1lc3NhZ2VzIHRoYXQgYXJlIG5vdCBldmVudHMsIHJlcXVlc3RzIG5vciByZXNwb25zZXMpXG4gKiBAZXhwb3J0XG4gKiBAY2xhc3MgUHJvdG9jb2xQYXJzZXJcbiAqIEBleHRlbmRzIHtFdmVudEVtaXR0ZXJ9XG4gKiBAaW1wbGVtZW50cyB7SVByb3RvY29sUGFyc2VyfVxuICovXG5sZXQgUHJvdG9jb2xQYXJzZXIgPSBjbGFzcyBQcm90b2NvbFBhcnNlciBleHRlbmRzIGV2ZW50c18xLkV2ZW50RW1pdHRlciB7XG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMucmF3RGF0YSA9IG5ldyBCdWZmZXIoMCk7XG4gICAgICAgIHRoaXMuY29udGVudExlbmd0aCA9IC0xO1xuICAgICAgICB0aGlzLmRpc3Bvc2VkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuZGF0YUNhbGxiYWNrSGFuZGxlciA9IChkYXRhKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmhhbmRsZURhdGEoZGF0YSk7XG4gICAgICAgIH07XG4gICAgfVxuICAgIGRpc3Bvc2UoKSB7XG4gICAgICAgIGlmICh0aGlzLnN0cmVhbSkge1xuICAgICAgICAgICAgdGhpcy5zdHJlYW0ucmVtb3ZlTGlzdGVuZXIoJ2RhdGEnLCB0aGlzLmRhdGFDYWxsYmFja0hhbmRsZXIpO1xuICAgICAgICAgICAgdGhpcy5zdHJlYW0gPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICB9XG4gICAgY29ubmVjdChzdHJlYW0pIHtcbiAgICAgICAgdGhpcy5zdHJlYW0gPSBzdHJlYW07XG4gICAgICAgIHN0cmVhbS5hZGRMaXN0ZW5lcignZGF0YScsIHRoaXMuZGF0YUNhbGxiYWNrSGFuZGxlcik7XG4gICAgfVxuICAgIGRpc3BhdGNoKGJvZHkpIHtcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9IEpTT04ucGFyc2UoYm9keSk7XG4gICAgICAgIHN3aXRjaCAobWVzc2FnZS50eXBlKSB7XG4gICAgICAgICAgICBjYXNlICdldmVudCc6IHtcbiAgICAgICAgICAgICAgICBjb25zdCBldmVudCA9IG1lc3NhZ2U7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBldmVudC5ldmVudCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbWl0KGAke21lc3NhZ2UudHlwZX1fJHtldmVudC5ldmVudH1gLCBldmVudCk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhc2UgJ3JlcXVlc3QnOiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVxdWVzdCA9IG1lc3NhZ2U7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXF1ZXN0LmNvbW1hbmQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdChgJHttZXNzYWdlLnR5cGV9XyR7cmVxdWVzdC5jb21tYW5kfWAsIHJlcXVlc3QpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXNlICdyZXNwb25zZSc6IHtcbiAgICAgICAgICAgICAgICBjb25zdCByZXBvbnNlID0gbWVzc2FnZTtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHJlcG9uc2UuY29tbWFuZCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbWl0KGAke21lc3NhZ2UudHlwZX1fJHtyZXBvbnNlLmNvbW1hbmR9YCwgcmVwb25zZSk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRlZmF1bHQ6IHtcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoYCR7bWVzc2FnZS50eXBlfWAsIG1lc3NhZ2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuZW1pdCgnZGF0YScsIG1lc3NhZ2UpO1xuICAgIH1cbiAgICBoYW5kbGVEYXRhKGRhdGEpIHtcbiAgICAgICAgaWYgKHRoaXMuZGlzcG9zZWQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnJhd0RhdGEgPSBCdWZmZXIuY29uY2F0KFt0aGlzLnJhd0RhdGEsIGRhdGFdKTtcbiAgICAgICAgd2hpbGUgKHRydWUpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmNvbnRlbnRMZW5ndGggPj0gMCkge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnJhd0RhdGEubGVuZ3RoID49IHRoaXMuY29udGVudExlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gdGhpcy5yYXdEYXRhLnRvU3RyaW5nKCd1dGY4JywgMCwgdGhpcy5jb250ZW50TGVuZ3RoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yYXdEYXRhID0gdGhpcy5yYXdEYXRhLnNsaWNlKHRoaXMuY29udGVudExlbmd0aCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29udGVudExlbmd0aCA9IC0xO1xuICAgICAgICAgICAgICAgICAgICBpZiAobWVzc2FnZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc3BhdGNoKG1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIC8vIHRoZXJlIG1heSBiZSBtb3JlIGNvbXBsZXRlIG1lc3NhZ2VzIHRvIHByb2Nlc3MuXG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IGlkeCA9IHRoaXMucmF3RGF0YS5pbmRleE9mKFBST1RPQ09MX1NUQVJUX0lOREVOVElGSUVSKTtcbiAgICAgICAgICAgICAgICBpZiAoaWR4ICE9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBoZWFkZXIgPSB0aGlzLnJhd0RhdGEudG9TdHJpbmcoJ3V0ZjgnLCAwLCBpZHgpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBsaW5lcyA9IGhlYWRlci5zcGxpdCgnXFxyXFxuJyk7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgbGluZSBvZiBsaW5lcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFpciA9IGxpbmUuc3BsaXQoLzogKy8pO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhaXJbMF0gPT09ICdDb250ZW50LUxlbmd0aCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRlbnRMZW5ndGggPSArcGFpclsxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJhd0RhdGEgPSB0aGlzLnJhd0RhdGEuc2xpY2UoaWR4ICsgUFJPVE9DT0xfU1RBUlRfSU5ERU5USUZJRVIubGVuZ3RoKTtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG59O1xuUHJvdG9jb2xQYXJzZXIgPSBfX2RlY29yYXRlKFtcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKClcbl0sIFByb3RvY29sUGFyc2VyKTtcbmV4cG9ydHMuUHJvdG9jb2xQYXJzZXIgPSBQcm90b2NvbFBhcnNlcjtcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPXByb3RvY29sUGFyc2VyLmpzLm1hcCJdfQ==