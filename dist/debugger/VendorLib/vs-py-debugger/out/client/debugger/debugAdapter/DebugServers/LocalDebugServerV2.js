// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const types_1 = require("../../../common/types");

const async_1 = require("../../../common/utils/async");

const BaseDebugServer_1 = require("./BaseDebugServer");

class LocalDebugServerV2 extends BaseDebugServer_1.BaseDebugServer {
  constructor(debugSession, args, serviceContainer) {
    super(debugSession);
    this.args = args;
    this.serviceContainer = serviceContainer;
    this.clientSocket = async_1.createDeferred();
  }

  Stop() {
    if (this.socketServer) {
      try {
        this.socketServer.dispose(); // tslint:disable-next-line:no-empty
      } catch (_a) {}

      this.socketServer = undefined;
    }
  }

  Start() {
    return __awaiter(this, void 0, void 0, function* () {
      const host = typeof this.args.host === 'string' && this.args.host.trim().length > 0 ? this.args.host.trim() : 'localhost';
      const socketServer = this.socketServer = this.serviceContainer.get(types_1.ISocketServer);
      const port = yield socketServer.Start({
        port: this.args.port,
        host
      });
      socketServer.client.then(socket => {
        // This is required to prevent the launcher from aborting if the PTVSD process spits out any errors in stderr stream.
        this.isRunning = true;
        this.debugClientConnected.resolve(true);
        this.clientSocket.resolve(socket);
      }).catch(ex => {
        this.debugClientConnected.reject(ex);
        this.clientSocket.reject(ex);
      });
      return {
        port,
        host
      };
    });
  }

}

exports.LocalDebugServerV2 = LocalDebugServerV2;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkxvY2FsRGVidWdTZXJ2ZXJWMi5qcyJdLCJuYW1lcyI6WyJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidHlwZXNfMSIsInJlcXVpcmUiLCJhc3luY18xIiwiQmFzZURlYnVnU2VydmVyXzEiLCJMb2NhbERlYnVnU2VydmVyVjIiLCJCYXNlRGVidWdTZXJ2ZXIiLCJjb25zdHJ1Y3RvciIsImRlYnVnU2Vzc2lvbiIsImFyZ3MiLCJzZXJ2aWNlQ29udGFpbmVyIiwiY2xpZW50U29ja2V0IiwiY3JlYXRlRGVmZXJyZWQiLCJTdG9wIiwic29ja2V0U2VydmVyIiwiZGlzcG9zZSIsIl9hIiwidW5kZWZpbmVkIiwiU3RhcnQiLCJob3N0IiwidHJpbSIsImxlbmd0aCIsImdldCIsIklTb2NrZXRTZXJ2ZXIiLCJwb3J0IiwiY2xpZW50Iiwic29ja2V0IiwiaXNSdW5uaW5nIiwiZGVidWdDbGllbnRDb25uZWN0ZWQiLCJjYXRjaCIsImV4Il0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FBL0IsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3JGLFNBQU8sS0FBS0QsQ0FBQyxLQUFLQSxDQUFDLEdBQUdFLE9BQVQsQ0FBTixFQUF5QixVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUN2RCxhQUFTQyxTQUFULENBQW1CQyxLQUFuQixFQUEwQjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUNPLElB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QUF4QixPQUFuQixDQUFuQjtBQUNBTCxNQUFBQSxZQUFZLENBQUNXLE1BQWIsQ0FBb0I3QixJQUFwQixDQUF5QjhCLE1BQU0sSUFBSTtBQUMvQjtBQUNBLGFBQUtDLFNBQUwsR0FBaUIsSUFBakI7QUFDQSxhQUFLQyxvQkFBTCxDQUEwQjFDLE9BQTFCLENBQWtDLElBQWxDO0FBQ0EsYUFBS3lCLFlBQUwsQ0FBa0J6QixPQUFsQixDQUEwQndDLE1BQTFCO0FBQ0gsT0FMRCxFQUtHRyxLQUxILENBS1NDLEVBQUUsSUFBSTtBQUNYLGFBQUtGLG9CQUFMLENBQTBCekMsTUFBMUIsQ0FBaUMyQyxFQUFqQztBQUNBLGFBQUtuQixZQUFMLENBQWtCeEIsTUFBbEIsQ0FBeUIyQyxFQUF6QjtBQUNILE9BUkQ7QUFTQSxhQUFPO0FBQUVOLFFBQUFBLElBQUY7QUFBUUwsUUFBQUE7QUFBUixPQUFQO0FBQ0gsS0FkZSxDQUFoQjtBQWVIOztBQWpDOEQ7O0FBbUNuRW5CLE9BQU8sQ0FBQ0ssa0JBQVIsR0FBNkJBLGtCQUE3QiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxuJ3VzZSBzdHJpY3QnO1xudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcbiAgICB9KTtcbn07XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NvbW1vbi90eXBlc1wiKTtcbmNvbnN0IGFzeW5jXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY29tbW9uL3V0aWxzL2FzeW5jXCIpO1xuY29uc3QgQmFzZURlYnVnU2VydmVyXzEgPSByZXF1aXJlKFwiLi9CYXNlRGVidWdTZXJ2ZXJcIik7XG5jbGFzcyBMb2NhbERlYnVnU2VydmVyVjIgZXh0ZW5kcyBCYXNlRGVidWdTZXJ2ZXJfMS5CYXNlRGVidWdTZXJ2ZXIge1xuICAgIGNvbnN0cnVjdG9yKGRlYnVnU2Vzc2lvbiwgYXJncywgc2VydmljZUNvbnRhaW5lcikge1xuICAgICAgICBzdXBlcihkZWJ1Z1Nlc3Npb24pO1xuICAgICAgICB0aGlzLmFyZ3MgPSBhcmdzO1xuICAgICAgICB0aGlzLnNlcnZpY2VDb250YWluZXIgPSBzZXJ2aWNlQ29udGFpbmVyO1xuICAgICAgICB0aGlzLmNsaWVudFNvY2tldCA9IGFzeW5jXzEuY3JlYXRlRGVmZXJyZWQoKTtcbiAgICB9XG4gICAgU3RvcCgpIHtcbiAgICAgICAgaWYgKHRoaXMuc29ja2V0U2VydmVyKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHRoaXMuc29ja2V0U2VydmVyLmRpc3Bvc2UoKTtcbiAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZW1wdHlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChfYSkgeyB9XG4gICAgICAgICAgICB0aGlzLnNvY2tldFNlcnZlciA9IHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgIH1cbiAgICBTdGFydCgpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IGhvc3QgPSB0eXBlb2YgdGhpcy5hcmdzLmhvc3QgPT09ICdzdHJpbmcnICYmIHRoaXMuYXJncy5ob3N0LnRyaW0oKS5sZW5ndGggPiAwID8gdGhpcy5hcmdzLmhvc3QudHJpbSgpIDogJ2xvY2FsaG9zdCc7XG4gICAgICAgICAgICBjb25zdCBzb2NrZXRTZXJ2ZXIgPSB0aGlzLnNvY2tldFNlcnZlciA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JU29ja2V0U2VydmVyKTtcbiAgICAgICAgICAgIGNvbnN0IHBvcnQgPSB5aWVsZCBzb2NrZXRTZXJ2ZXIuU3RhcnQoeyBwb3J0OiB0aGlzLmFyZ3MucG9ydCwgaG9zdCB9KTtcbiAgICAgICAgICAgIHNvY2tldFNlcnZlci5jbGllbnQudGhlbihzb2NrZXQgPT4ge1xuICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgcmVxdWlyZWQgdG8gcHJldmVudCB0aGUgbGF1bmNoZXIgZnJvbSBhYm9ydGluZyBpZiB0aGUgUFRWU0QgcHJvY2VzcyBzcGl0cyBvdXQgYW55IGVycm9ycyBpbiBzdGRlcnIgc3RyZWFtLlxuICAgICAgICAgICAgICAgIHRoaXMuaXNSdW5uaW5nID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB0aGlzLmRlYnVnQ2xpZW50Q29ubmVjdGVkLnJlc29sdmUodHJ1ZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5jbGllbnRTb2NrZXQucmVzb2x2ZShzb2NrZXQpO1xuICAgICAgICAgICAgfSkuY2F0Y2goZXggPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZGVidWdDbGllbnRDb25uZWN0ZWQucmVqZWN0KGV4KTtcbiAgICAgICAgICAgICAgICB0aGlzLmNsaWVudFNvY2tldC5yZWplY3QoZXgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4geyBwb3J0LCBob3N0IH07XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbmV4cG9ydHMuTG9jYWxEZWJ1Z1NlcnZlclYyID0gTG9jYWxEZWJ1Z1NlcnZlclYyO1xuLy8jIHNvdXJjZU1hcHBpbmdVUkw9TG9jYWxEZWJ1Z1NlcnZlclYyLmpzLm1hcCJdfQ==