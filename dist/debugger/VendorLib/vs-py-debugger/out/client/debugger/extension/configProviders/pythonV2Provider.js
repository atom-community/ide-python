// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const types_1 = require("../../../common/platform/types");

const types_2 = require("../../../ioc/types");

const telemetry_1 = require("../../../telemetry");

const constants_1 = require("../../../telemetry/constants");

const types_3 = require("../../types");

const baseProvider_1 = require("./baseProvider");

const types_4 = require("./types");

let PythonV2DebugConfigurationProvider = class PythonV2DebugConfigurationProvider extends baseProvider_1.BaseConfigurationProvider {
  constructor(serviceContainer) {
    super('python', serviceContainer);
  }

  provideLaunchDefaults(workspaceFolder, debugConfiguration) {
    const _super = name => super[name];

    return __awaiter(this, void 0, void 0, function* () {
      yield _super("provideLaunchDefaults").call(this, workspaceFolder, debugConfiguration);
      const debugOptions = debugConfiguration.debugOptions;

      if (debugConfiguration.debugStdLib) {
        this.debugOption(debugOptions, types_3.DebugOptions.DebugStdLib);
      }

      if (debugConfiguration.stopOnEntry) {
        this.debugOption(debugOptions, types_3.DebugOptions.StopOnEntry);
      }

      if (debugConfiguration.showReturnValue) {
        this.debugOption(debugOptions, types_3.DebugOptions.ShowReturnValue);
      }

      if (debugConfiguration.django) {
        this.debugOption(debugOptions, types_3.DebugOptions.Django);
      }

      if (debugConfiguration.jinja) {
        this.debugOption(debugOptions, types_3.DebugOptions.Jinja);
      }

      if (debugConfiguration.redirectOutput || debugConfiguration.redirectOutput === undefined) {
        this.debugOption(debugOptions, types_3.DebugOptions.RedirectOutput);
      }

      if (debugConfiguration.sudo) {
        this.debugOption(debugOptions, types_3.DebugOptions.Sudo);
      }

      if (debugConfiguration.subProcess === true) {
        this.debugOption(debugOptions, types_3.DebugOptions.SubProcess);
      }

      if (this.serviceContainer.get(types_1.IPlatformService).isWindows) {
        this.debugOption(debugOptions, types_3.DebugOptions.FixFilePathCase);
      }

      const isFlask = this.isDebuggingFlask(debugConfiguration);

      if ((debugConfiguration.pyramid || isFlask) && debugOptions.indexOf(types_3.DebugOptions.Jinja) === -1 && debugConfiguration.jinja !== false) {
        this.debugOption(debugOptions, types_3.DebugOptions.Jinja);
      }

      if (debugConfiguration.pyramid) {
        const utils = this.serviceContainer.get(types_4.IConfigurationProviderUtils);
        debugConfiguration.program = yield utils.getPyramidStartupScriptFilePath(workspaceFolder);
      }

      this.sendTelemetry('launch', debugConfiguration);
    });
  } // tslint:disable-next-line:cyclomatic-complexity


  provideAttachDefaults(workspaceFolder, debugConfiguration) {
    const _super = name => super[name];

    return __awaiter(this, void 0, void 0, function* () {
      yield _super("provideAttachDefaults").call(this, workspaceFolder, debugConfiguration);
      const debugOptions = debugConfiguration.debugOptions;

      if (debugConfiguration.debugStdLib) {
        this.debugOption(debugOptions, types_3.DebugOptions.DebugStdLib);
      }

      if (debugConfiguration.django) {
        this.debugOption(debugOptions, types_3.DebugOptions.Django);
      }

      if (debugConfiguration.jinja) {
        this.debugOption(debugOptions, types_3.DebugOptions.Jinja);
      }

      if (debugConfiguration.subProcess === true) {
        this.debugOption(debugOptions, types_3.DebugOptions.SubProcess);
      }

      if (debugConfiguration.pyramid && debugOptions.indexOf(types_3.DebugOptions.Jinja) === -1 && debugConfiguration.jinja !== false) {
        this.debugOption(debugOptions, types_3.DebugOptions.Jinja);
      }

      if (debugConfiguration.redirectOutput || debugConfiguration.redirectOutput === undefined) {
        this.debugOption(debugOptions, types_3.DebugOptions.RedirectOutput);
      } // We'll need paths to be fixed only in the case where local and remote hosts are the same
      // I.e. only if hostName === 'localhost' or '127.0.0.1' or ''


      const isLocalHost = this.isLocalHost(debugConfiguration.host);

      if (this.serviceContainer.get(types_1.IPlatformService).isWindows && isLocalHost) {
        this.debugOption(debugOptions, types_3.DebugOptions.FixFilePathCase);
      }

      if (this.serviceContainer.get(types_1.IPlatformService).isWindows) {
        this.debugOption(debugOptions, types_3.DebugOptions.WindowsClient);
      } else {
        this.debugOption(debugOptions, types_3.DebugOptions.UnixClient);
      }

      if (!debugConfiguration.pathMappings) {
        debugConfiguration.pathMappings = [];
      } // This is for backwards compatibility.


      if (debugConfiguration.localRoot && debugConfiguration.remoteRoot) {
        debugConfiguration.pathMappings.push({
          localRoot: debugConfiguration.localRoot,
          remoteRoot: debugConfiguration.remoteRoot
        });
      } // If attaching to local host, then always map local root and remote roots.


      if (workspaceFolder && debugConfiguration.host && debugConfiguration.pathMappings.length === 0 && ['LOCALHOST', '127.0.0.1', '::1'].indexOf(debugConfiguration.host.toUpperCase()) >= 0) {
        debugConfiguration.pathMappings.push({
          localRoot: workspaceFolder.fsPath,
          remoteRoot: workspaceFolder.fsPath
        });
      }

      this.sendTelemetry('attach', debugConfiguration);
    });
  }

  debugOption(debugOptions, debugOption) {
    if (debugOptions.indexOf(debugOption) >= 0) {
      return;
    }

    debugOptions.push(debugOption);
  }

  isLocalHost(hostName) {
    const LocalHosts = ['localhost', '127.0.0.1', '::1'];
    return hostName && LocalHosts.indexOf(hostName.toLowerCase()) >= 0 ? true : false;
  }

  isDebuggingFlask(debugConfiguration) {
    return debugConfiguration.module && debugConfiguration.module.toUpperCase() === 'FLASK' ? true : false;
  }

  sendTelemetry(trigger, debugConfiguration) {
    const telemetryProps = {
      trigger,
      console: debugConfiguration.console,
      hasEnvVars: typeof debugConfiguration.env === 'object' && Object.keys(debugConfiguration.env).length > 0,
      django: !!debugConfiguration.django,
      flask: this.isDebuggingFlask(debugConfiguration),
      hasArgs: Array.isArray(debugConfiguration.args) && debugConfiguration.args.length > 0,
      isLocalhost: this.isLocalHost(debugConfiguration.host),
      isModule: typeof debugConfiguration.module === 'string' && debugConfiguration.module.length > 0,
      isSudo: !!debugConfiguration.sudo,
      jinja: !!debugConfiguration.jinja,
      pyramid: !!debugConfiguration.pyramid,
      stopOnEntry: !!debugConfiguration.stopOnEntry,
      showReturnValue: !!debugConfiguration.showReturnValue,
      subProcess: !!debugConfiguration.subProcess
    };
    telemetry_1.sendTelemetryEvent(constants_1.DEBUGGER, undefined, telemetryProps);
  }

};
PythonV2DebugConfigurationProvider = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_2.IServiceContainer))], PythonV2DebugConfigurationProvider);
exports.PythonV2DebugConfigurationProvider = PythonV2DebugConfigurationProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInB5dGhvblYyUHJvdmlkZXIuanMiXSwibmFtZXMiOlsiX19kZWNvcmF0ZSIsImRlY29yYXRvcnMiLCJ0YXJnZXQiLCJrZXkiLCJkZXNjIiwiYyIsImFyZ3VtZW50cyIsImxlbmd0aCIsInIiLCJPYmplY3QiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJkIiwiUmVmbGVjdCIsImRlY29yYXRlIiwiaSIsImRlZmluZVByb3BlcnR5IiwiX19wYXJhbSIsInBhcmFtSW5kZXgiLCJkZWNvcmF0b3IiLCJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiZXhwb3J0cyIsImludmVyc2lmeV8xIiwicmVxdWlyZSIsInR5cGVzXzEiLCJ0eXBlc18yIiwidGVsZW1ldHJ5XzEiLCJjb25zdGFudHNfMSIsInR5cGVzXzMiLCJiYXNlUHJvdmlkZXJfMSIsInR5cGVzXzQiLCJQeXRob25WMkRlYnVnQ29uZmlndXJhdGlvblByb3ZpZGVyIiwiQmFzZUNvbmZpZ3VyYXRpb25Qcm92aWRlciIsImNvbnN0cnVjdG9yIiwic2VydmljZUNvbnRhaW5lciIsInByb3ZpZGVMYXVuY2hEZWZhdWx0cyIsIndvcmtzcGFjZUZvbGRlciIsImRlYnVnQ29uZmlndXJhdGlvbiIsIl9zdXBlciIsIm5hbWUiLCJjYWxsIiwiZGVidWdPcHRpb25zIiwiZGVidWdTdGRMaWIiLCJkZWJ1Z09wdGlvbiIsIkRlYnVnT3B0aW9ucyIsIkRlYnVnU3RkTGliIiwic3RvcE9uRW50cnkiLCJTdG9wT25FbnRyeSIsInNob3dSZXR1cm5WYWx1ZSIsIlNob3dSZXR1cm5WYWx1ZSIsImRqYW5nbyIsIkRqYW5nbyIsImppbmphIiwiSmluamEiLCJyZWRpcmVjdE91dHB1dCIsInVuZGVmaW5lZCIsIlJlZGlyZWN0T3V0cHV0Iiwic3VkbyIsIlN1ZG8iLCJzdWJQcm9jZXNzIiwiU3ViUHJvY2VzcyIsImdldCIsIklQbGF0Zm9ybVNlcnZpY2UiLCJpc1dpbmRvd3MiLCJGaXhGaWxlUGF0aENhc2UiLCJpc0ZsYXNrIiwiaXNEZWJ1Z2dpbmdGbGFzayIsInB5cmFtaWQiLCJpbmRleE9mIiwidXRpbHMiLCJJQ29uZmlndXJhdGlvblByb3ZpZGVyVXRpbHMiLCJwcm9ncmFtIiwiZ2V0UHlyYW1pZFN0YXJ0dXBTY3JpcHRGaWxlUGF0aCIsInNlbmRUZWxlbWV0cnkiLCJwcm92aWRlQXR0YWNoRGVmYXVsdHMiLCJpc0xvY2FsSG9zdCIsImhvc3QiLCJXaW5kb3dzQ2xpZW50IiwiVW5peENsaWVudCIsInBhdGhNYXBwaW5ncyIsImxvY2FsUm9vdCIsInJlbW90ZVJvb3QiLCJwdXNoIiwidG9VcHBlckNhc2UiLCJmc1BhdGgiLCJob3N0TmFtZSIsIkxvY2FsSG9zdHMiLCJ0b0xvd2VyQ2FzZSIsIm1vZHVsZSIsInRyaWdnZXIiLCJ0ZWxlbWV0cnlQcm9wcyIsImNvbnNvbGUiLCJoYXNFbnZWYXJzIiwiZW52Iiwia2V5cyIsImZsYXNrIiwiaGFzQXJncyIsIkFycmF5IiwiaXNBcnJheSIsImFyZ3MiLCJpc0xvY2FsaG9zdCIsImlzTW9kdWxlIiwiaXNTdWRvIiwic2VuZFRlbGVtZXRyeUV2ZW50IiwiREVCVUdHRVIiLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSVNlcnZpY2VDb250YWluZXIiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEsTUFBMEJDLENBQUMsR0FBR0gsQ0FBQyxHQUFHLENBQUosR0FBUUgsTUFBUixHQUFpQkUs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LEVBQUUsQ0FBQyxDQUFDakUsa0JBQWtCLENBQUNvQixJQVRWO0FBVW5CTCxNQUFBQSxLQUFLLEVBQUUsQ0FBQyxDQUFDZixrQkFBa0IsQ0FBQ2UsS0FWVDtBQVduQmUsTUFBQUEsT0FBTyxFQUFFLENBQUMsQ0FBQzlCLGtCQUFrQixDQUFDOEIsT0FYWDtBQVluQnJCLE1BQUFBLFdBQVcsRUFBRSxDQUFDLENBQUNULGtCQUFrQixDQUFDUyxXQVpmO0FBYW5CRSxNQUFBQSxlQUFlLEVBQUUsQ0FBQyxDQUFDWCxrQkFBa0IsQ0FBQ1csZUFibkI7QUFjbkJXLE1BQUFBLFVBQVUsRUFBRSxDQUFDLENBQUN0QixrQkFBa0IsQ0FBQ3NCO0FBZGQsS0FBdkI7QUFnQkFqQyxJQUFBQSxXQUFXLENBQUM2RSxrQkFBWixDQUErQjVFLFdBQVcsQ0FBQzZFLFFBQTNDLEVBQXFEakQsU0FBckQsRUFBZ0VtQyxjQUFoRTtBQUNIOztBQTVJOEgsQ0FBbkk7QUE4SUEzRCxrQ0FBa0MsR0FBRy9DLFVBQVUsQ0FBQyxDQUM1Q3NDLFdBQVcsQ0FBQ21GLFVBQVosRUFENEMsRUFFNUN6RyxPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDb0YsTUFBWixDQUFtQmpGLE9BQU8sQ0FBQ2tGLGlCQUEzQixDQUFKLENBRnFDLENBQUQsRUFHNUM1RSxrQ0FINEMsQ0FBL0M7QUFJQVYsT0FBTyxDQUFDVSxrQ0FBUixHQUE2Q0Esa0NBQTdDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXG4ndXNlIHN0cmljdCc7XG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XG4gICAgdmFyIGMgPSBhcmd1bWVudHMubGVuZ3RoLCByID0gYyA8IDMgPyB0YXJnZXQgOiBkZXNjID09PSBudWxsID8gZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpIDogZGVzYywgZDtcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XG4gICAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjtcbn07XG52YXIgX19wYXJhbSA9ICh0aGlzICYmIHRoaXMuX19wYXJhbSkgfHwgZnVuY3Rpb24gKHBhcmFtSW5kZXgsIGRlY29yYXRvcikge1xuICAgIHJldHVybiBmdW5jdGlvbiAodGFyZ2V0LCBrZXkpIHsgZGVjb3JhdG9yKHRhcmdldCwga2V5LCBwYXJhbUluZGV4KTsgfVxufTtcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XG4gICAgfSk7XG59O1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuY29uc3QgaW52ZXJzaWZ5XzEgPSByZXF1aXJlKFwiaW52ZXJzaWZ5XCIpO1xuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jb21tb24vcGxhdGZvcm0vdHlwZXNcIik7XG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uLy4uLy4uL2lvYy90eXBlc1wiKTtcbmNvbnN0IHRlbGVtZXRyeV8xID0gcmVxdWlyZShcIi4uLy4uLy4uL3RlbGVtZXRyeVwiKTtcbmNvbnN0IGNvbnN0YW50c18xID0gcmVxdWlyZShcIi4uLy4uLy4uL3RlbGVtZXRyeS9jb25zdGFudHNcIik7XG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4uLy4uL3R5cGVzXCIpO1xuY29uc3QgYmFzZVByb3ZpZGVyXzEgPSByZXF1aXJlKFwiLi9iYXNlUHJvdmlkZXJcIik7XG5jb25zdCB0eXBlc180ID0gcmVxdWlyZShcIi4vdHlwZXNcIik7XG5sZXQgUHl0aG9uVjJEZWJ1Z0NvbmZpZ3VyYXRpb25Qcm92aWRlciA9IGNsYXNzIFB5dGhvblYyRGVidWdDb25maWd1cmF0aW9uUHJvdmlkZXIgZXh0ZW5kcyBiYXNlUHJvdmlkZXJfMS5CYXNlQ29uZmlndXJhdGlvblByb3ZpZGVyIHtcbiAgICBjb25zdHJ1Y3RvcihzZXJ2aWNlQ29udGFpbmVyKSB7XG4gICAgICAgIHN1cGVyKCdweXRob24nLCBzZXJ2aWNlQ29udGFpbmVyKTtcbiAgICB9XG4gICAgcHJvdmlkZUxhdW5jaERlZmF1bHRzKHdvcmtzcGFjZUZvbGRlciwgZGVidWdDb25maWd1cmF0aW9uKSB7XG4gICAgICAgIGNvbnN0IF9zdXBlciA9IG5hbWUgPT4gc3VwZXJbbmFtZV07XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICB5aWVsZCBfc3VwZXIoXCJwcm92aWRlTGF1bmNoRGVmYXVsdHNcIikuY2FsbCh0aGlzLCB3b3Jrc3BhY2VGb2xkZXIsIGRlYnVnQ29uZmlndXJhdGlvbik7XG4gICAgICAgICAgICBjb25zdCBkZWJ1Z09wdGlvbnMgPSBkZWJ1Z0NvbmZpZ3VyYXRpb24uZGVidWdPcHRpb25zO1xuICAgICAgICAgICAgaWYgKGRlYnVnQ29uZmlndXJhdGlvbi5kZWJ1Z1N0ZExpYikge1xuICAgICAgICAgICAgICAgIHRoaXMuZGVidWdPcHRpb24oZGVidWdPcHRpb25zLCB0eXBlc18zLkRlYnVnT3B0aW9ucy5EZWJ1Z1N0ZExpYik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZGVidWdDb25maWd1cmF0aW9uLnN0b3BPbkVudHJ5KSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kZWJ1Z09wdGlvbihkZWJ1Z09wdGlvbnMsIHR5cGVzXzMuRGVidWdPcHRpb25zLlN0b3BPbkVudHJ5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChkZWJ1Z0NvbmZpZ3VyYXRpb24uc2hvd1JldHVyblZhbHVlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kZWJ1Z09wdGlvbihkZWJ1Z09wdGlvbnMsIHR5cGVzXzMuRGVidWdPcHRpb25zLlNob3dSZXR1cm5WYWx1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZGVidWdDb25maWd1cmF0aW9uLmRqYW5nbykge1xuICAgICAgICAgICAgICAgIHRoaXMuZGVidWdPcHRpb24oZGVidWdPcHRpb25zLCB0eXBlc18zLkRlYnVnT3B0aW9ucy5EamFuZ28pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGRlYnVnQ29uZmlndXJhdGlvbi5qaW5qYSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZGVidWdPcHRpb24oZGVidWdPcHRpb25zLCB0eXBlc18zLkRlYnVnT3B0aW9ucy5KaW5qYSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZGVidWdDb25maWd1cmF0aW9uLnJlZGlyZWN0T3V0cHV0IHx8IGRlYnVnQ29uZmlndXJhdGlvbi5yZWRpcmVjdE91dHB1dCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kZWJ1Z09wdGlvbihkZWJ1Z09wdGlvbnMsIHR5cGVzXzMuRGVidWdPcHRpb25zLlJlZGlyZWN0T3V0cHV0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChkZWJ1Z0NvbmZpZ3VyYXRpb24uc3Vkbykge1xuICAgICAgICAgICAgICAgIHRoaXMuZGVidWdPcHRpb24oZGVidWdPcHRpb25zLCB0eXBlc18zLkRlYnVnT3B0aW9ucy5TdWRvKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChkZWJ1Z0NvbmZpZ3VyYXRpb24uc3ViUHJvY2VzcyA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZGVidWdPcHRpb24oZGVidWdPcHRpb25zLCB0eXBlc18zLkRlYnVnT3B0aW9ucy5TdWJQcm9jZXNzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSVBsYXRmb3JtU2VydmljZSkuaXNXaW5kb3dzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kZWJ1Z09wdGlvbihkZWJ1Z09wdGlvbnMsIHR5cGVzXzMuRGVidWdPcHRpb25zLkZpeEZpbGVQYXRoQ2FzZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBpc0ZsYXNrID0gdGhpcy5pc0RlYnVnZ2luZ0ZsYXNrKGRlYnVnQ29uZmlndXJhdGlvbik7XG4gICAgICAgICAgICBpZiAoKGRlYnVnQ29uZmlndXJhdGlvbi5weXJhbWlkIHx8IGlzRmxhc2spXG4gICAgICAgICAgICAgICAgJiYgZGVidWdPcHRpb25zLmluZGV4T2YodHlwZXNfMy5EZWJ1Z09wdGlvbnMuSmluamEpID09PSAtMVxuICAgICAgICAgICAgICAgICYmIGRlYnVnQ29uZmlndXJhdGlvbi5qaW5qYSAhPT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmRlYnVnT3B0aW9uKGRlYnVnT3B0aW9ucywgdHlwZXNfMy5EZWJ1Z09wdGlvbnMuSmluamEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGRlYnVnQ29uZmlndXJhdGlvbi5weXJhbWlkKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdXRpbHMgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzQuSUNvbmZpZ3VyYXRpb25Qcm92aWRlclV0aWxzKTtcbiAgICAgICAgICAgICAgICBkZWJ1Z0NvbmZpZ3VyYXRpb24ucHJvZ3JhbSA9ICh5aWVsZCB1dGlscy5nZXRQeXJhbWlkU3RhcnR1cFNjcmlwdEZpbGVQYXRoKHdvcmtzcGFjZUZvbGRlcikpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5zZW5kVGVsZW1ldHJ5KCdsYXVuY2gnLCBkZWJ1Z0NvbmZpZ3VyYXRpb24pO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmN5Y2xvbWF0aWMtY29tcGxleGl0eVxuICAgIHByb3ZpZGVBdHRhY2hEZWZhdWx0cyh3b3Jrc3BhY2VGb2xkZXIsIGRlYnVnQ29uZmlndXJhdGlvbikge1xuICAgICAgICBjb25zdCBfc3VwZXIgPSBuYW1lID0+IHN1cGVyW25hbWVdO1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgeWllbGQgX3N1cGVyKFwicHJvdmlkZUF0dGFjaERlZmF1bHRzXCIpLmNhbGwodGhpcywgd29ya3NwYWNlRm9sZGVyLCBkZWJ1Z0NvbmZpZ3VyYXRpb24pO1xuICAgICAgICAgICAgY29uc3QgZGVidWdPcHRpb25zID0gZGVidWdDb25maWd1cmF0aW9uLmRlYnVnT3B0aW9ucztcbiAgICAgICAgICAgIGlmIChkZWJ1Z0NvbmZpZ3VyYXRpb24uZGVidWdTdGRMaWIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmRlYnVnT3B0aW9uKGRlYnVnT3B0aW9ucywgdHlwZXNfMy5EZWJ1Z09wdGlvbnMuRGVidWdTdGRMaWIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGRlYnVnQ29uZmlndXJhdGlvbi5kamFuZ28pIHtcbiAgICAgICAgICAgICAgICB0aGlzLmRlYnVnT3B0aW9uKGRlYnVnT3B0aW9ucywgdHlwZXNfMy5EZWJ1Z09wdGlvbnMuRGphbmdvKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChkZWJ1Z0NvbmZpZ3VyYXRpb24uamluamEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmRlYnVnT3B0aW9uKGRlYnVnT3B0aW9ucywgdHlwZXNfMy5EZWJ1Z09wdGlvbnMuSmluamEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGRlYnVnQ29uZmlndXJhdGlvbi5zdWJQcm9jZXNzID09PSB0cnVlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kZWJ1Z09wdGlvbihkZWJ1Z09wdGlvbnMsIHR5cGVzXzMuRGVidWdPcHRpb25zLlN1YlByb2Nlc3MpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGRlYnVnQ29uZmlndXJhdGlvbi5weXJhbWlkXG4gICAgICAgICAgICAgICAgJiYgZGVidWdPcHRpb25zLmluZGV4T2YodHlwZXNfMy5EZWJ1Z09wdGlvbnMuSmluamEpID09PSAtMVxuICAgICAgICAgICAgICAgICYmIGRlYnVnQ29uZmlndXJhdGlvbi5qaW5qYSAhPT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmRlYnVnT3B0aW9uKGRlYnVnT3B0aW9ucywgdHlwZXNfMy5EZWJ1Z09wdGlvbnMuSmluamEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGRlYnVnQ29uZmlndXJhdGlvbi5yZWRpcmVjdE91dHB1dCB8fCBkZWJ1Z0NvbmZpZ3VyYXRpb24ucmVkaXJlY3RPdXRwdXQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuZGVidWdPcHRpb24oZGVidWdPcHRpb25zLCB0eXBlc18zLkRlYnVnT3B0aW9ucy5SZWRpcmVjdE91dHB1dCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBXZSdsbCBuZWVkIHBhdGhzIHRvIGJlIGZpeGVkIG9ubHkgaW4gdGhlIGNhc2Ugd2hlcmUgbG9jYWwgYW5kIHJlbW90ZSBob3N0cyBhcmUgdGhlIHNhbWVcbiAgICAgICAgICAgIC8vIEkuZS4gb25seSBpZiBob3N0TmFtZSA9PT0gJ2xvY2FsaG9zdCcgb3IgJzEyNy4wLjAuMScgb3IgJydcbiAgICAgICAgICAgIGNvbnN0IGlzTG9jYWxIb3N0ID0gdGhpcy5pc0xvY2FsSG9zdChkZWJ1Z0NvbmZpZ3VyYXRpb24uaG9zdCk7XG4gICAgICAgICAgICBpZiAodGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklQbGF0Zm9ybVNlcnZpY2UpLmlzV2luZG93cyAmJiBpc0xvY2FsSG9zdCkge1xuICAgICAgICAgICAgICAgIHRoaXMuZGVidWdPcHRpb24oZGVidWdPcHRpb25zLCB0eXBlc18zLkRlYnVnT3B0aW9ucy5GaXhGaWxlUGF0aENhc2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JUGxhdGZvcm1TZXJ2aWNlKS5pc1dpbmRvd3MpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmRlYnVnT3B0aW9uKGRlYnVnT3B0aW9ucywgdHlwZXNfMy5EZWJ1Z09wdGlvbnMuV2luZG93c0NsaWVudCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmRlYnVnT3B0aW9uKGRlYnVnT3B0aW9ucywgdHlwZXNfMy5EZWJ1Z09wdGlvbnMuVW5peENsaWVudCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIWRlYnVnQ29uZmlndXJhdGlvbi5wYXRoTWFwcGluZ3MpIHtcbiAgICAgICAgICAgICAgICBkZWJ1Z0NvbmZpZ3VyYXRpb24ucGF0aE1hcHBpbmdzID0gW107XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBUaGlzIGlzIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS5cbiAgICAgICAgICAgIGlmIChkZWJ1Z0NvbmZpZ3VyYXRpb24ubG9jYWxSb290ICYmIGRlYnVnQ29uZmlndXJhdGlvbi5yZW1vdGVSb290KSB7XG4gICAgICAgICAgICAgICAgZGVidWdDb25maWd1cmF0aW9uLnBhdGhNYXBwaW5ncy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgbG9jYWxSb290OiBkZWJ1Z0NvbmZpZ3VyYXRpb24ubG9jYWxSb290LFxuICAgICAgICAgICAgICAgICAgICByZW1vdGVSb290OiBkZWJ1Z0NvbmZpZ3VyYXRpb24ucmVtb3RlUm9vdFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gSWYgYXR0YWNoaW5nIHRvIGxvY2FsIGhvc3QsIHRoZW4gYWx3YXlzIG1hcCBsb2NhbCByb290IGFuZCByZW1vdGUgcm9vdHMuXG4gICAgICAgICAgICBpZiAod29ya3NwYWNlRm9sZGVyICYmIGRlYnVnQ29uZmlndXJhdGlvbi5ob3N0ICYmXG4gICAgICAgICAgICAgICAgZGVidWdDb25maWd1cmF0aW9uLnBhdGhNYXBwaW5ncy5sZW5ndGggPT09IDAgJiZcbiAgICAgICAgICAgICAgICBbJ0xPQ0FMSE9TVCcsICcxMjcuMC4wLjEnLCAnOjoxJ10uaW5kZXhPZihkZWJ1Z0NvbmZpZ3VyYXRpb24uaG9zdC50b1VwcGVyQ2FzZSgpKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgZGVidWdDb25maWd1cmF0aW9uLnBhdGhNYXBwaW5ncy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgbG9jYWxSb290OiB3b3Jrc3BhY2VGb2xkZXIuZnNQYXRoLFxuICAgICAgICAgICAgICAgICAgICByZW1vdGVSb290OiB3b3Jrc3BhY2VGb2xkZXIuZnNQYXRoXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnNlbmRUZWxlbWV0cnkoJ2F0dGFjaCcsIGRlYnVnQ29uZmlndXJhdGlvbik7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBkZWJ1Z09wdGlvbihkZWJ1Z09wdGlvbnMsIGRlYnVnT3B0aW9uKSB7XG4gICAgICAgIGlmIChkZWJ1Z09wdGlvbnMuaW5kZXhPZihkZWJ1Z09wdGlvbikgPj0gMCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGRlYnVnT3B0aW9ucy5wdXNoKGRlYnVnT3B0aW9uKTtcbiAgICB9XG4gICAgaXNMb2NhbEhvc3QoaG9zdE5hbWUpIHtcbiAgICAgICAgY29uc3QgTG9jYWxIb3N0cyA9IFsnbG9jYWxob3N0JywgJzEyNy4wLjAuMScsICc6OjEnXTtcbiAgICAgICAgcmV0dXJuIChob3N0TmFtZSAmJiBMb2NhbEhvc3RzLmluZGV4T2YoaG9zdE5hbWUudG9Mb3dlckNhc2UoKSkgPj0gMCkgPyB0cnVlIDogZmFsc2U7XG4gICAgfVxuICAgIGlzRGVidWdnaW5nRmxhc2soZGVidWdDb25maWd1cmF0aW9uKSB7XG4gICAgICAgIHJldHVybiAoZGVidWdDb25maWd1cmF0aW9uLm1vZHVsZSAmJiBkZWJ1Z0NvbmZpZ3VyYXRpb24ubW9kdWxlLnRvVXBwZXJDYXNlKCkgPT09ICdGTEFTSycpID8gdHJ1ZSA6IGZhbHNlO1xuICAgIH1cbiAgICBzZW5kVGVsZW1ldHJ5KHRyaWdnZXIsIGRlYnVnQ29uZmlndXJhdGlvbikge1xuICAgICAgICBjb25zdCB0ZWxlbWV0cnlQcm9wcyA9IHtcbiAgICAgICAgICAgIHRyaWdnZXIsXG4gICAgICAgICAgICBjb25zb2xlOiBkZWJ1Z0NvbmZpZ3VyYXRpb24uY29uc29sZSxcbiAgICAgICAgICAgIGhhc0VudlZhcnM6IHR5cGVvZiBkZWJ1Z0NvbmZpZ3VyYXRpb24uZW52ID09PSAnb2JqZWN0JyAmJiBPYmplY3Qua2V5cyhkZWJ1Z0NvbmZpZ3VyYXRpb24uZW52KS5sZW5ndGggPiAwLFxuICAgICAgICAgICAgZGphbmdvOiAhIWRlYnVnQ29uZmlndXJhdGlvbi5kamFuZ28sXG4gICAgICAgICAgICBmbGFzazogdGhpcy5pc0RlYnVnZ2luZ0ZsYXNrKGRlYnVnQ29uZmlndXJhdGlvbiksXG4gICAgICAgICAgICBoYXNBcmdzOiBBcnJheS5pc0FycmF5KGRlYnVnQ29uZmlndXJhdGlvbi5hcmdzKSAmJiBkZWJ1Z0NvbmZpZ3VyYXRpb24uYXJncy5sZW5ndGggPiAwLFxuICAgICAgICAgICAgaXNMb2NhbGhvc3Q6IHRoaXMuaXNMb2NhbEhvc3QoZGVidWdDb25maWd1cmF0aW9uLmhvc3QpLFxuICAgICAgICAgICAgaXNNb2R1bGU6IHR5cGVvZiBkZWJ1Z0NvbmZpZ3VyYXRpb24ubW9kdWxlID09PSAnc3RyaW5nJyAmJiBkZWJ1Z0NvbmZpZ3VyYXRpb24ubW9kdWxlLmxlbmd0aCA+IDAsXG4gICAgICAgICAgICBpc1N1ZG86ICEhZGVidWdDb25maWd1cmF0aW9uLnN1ZG8sXG4gICAgICAgICAgICBqaW5qYTogISFkZWJ1Z0NvbmZpZ3VyYXRpb24uamluamEsXG4gICAgICAgICAgICBweXJhbWlkOiAhIWRlYnVnQ29uZmlndXJhdGlvbi5weXJhbWlkLFxuICAgICAgICAgICAgc3RvcE9uRW50cnk6ICEhZGVidWdDb25maWd1cmF0aW9uLnN0b3BPbkVudHJ5LFxuICAgICAgICAgICAgc2hvd1JldHVyblZhbHVlOiAhIWRlYnVnQ29uZmlndXJhdGlvbi5zaG93UmV0dXJuVmFsdWUsXG4gICAgICAgICAgICBzdWJQcm9jZXNzOiAhIWRlYnVnQ29uZmlndXJhdGlvbi5zdWJQcm9jZXNzXG4gICAgICAgIH07XG4gICAgICAgIHRlbGVtZXRyeV8xLnNlbmRUZWxlbWV0cnlFdmVudChjb25zdGFudHNfMS5ERUJVR0dFUiwgdW5kZWZpbmVkLCB0ZWxlbWV0cnlQcm9wcyk7XG4gICAgfVxufTtcblB5dGhvblYyRGVidWdDb25maWd1cmF0aW9uUHJvdmlkZXIgPSBfX2RlY29yYXRlKFtcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKCksXG4gICAgX19wYXJhbSgwLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMi5JU2VydmljZUNvbnRhaW5lcikpXG5dLCBQeXRob25WMkRlYnVnQ29uZmlndXJhdGlvblByb3ZpZGVyKTtcbmV4cG9ydHMuUHl0aG9uVjJEZWJ1Z0NvbmZpZ3VyYXRpb25Qcm92aWRlciA9IFB5dGhvblYyRGVidWdDb25maWd1cmF0aW9uUHJvdmlkZXI7XG4vLyMgc291cmNlTWFwcGluZ1VSTD1weXRob25WMlByb3ZpZGVyLmpzLm1hcCJdfQ==