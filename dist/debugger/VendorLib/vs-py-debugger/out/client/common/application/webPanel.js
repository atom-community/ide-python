// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

require("../../common/extensions");

const fs = require("fs-extra");

const path = require("path");

const vscode_1 = require("vscode");

const localize = require("../../common/utils/localize");

const types_1 = require("../types");

class WebPanel {
  constructor(serviceContainer, listener, title, mainScriptPath, embeddedCss) {
    this.disposableRegistry = serviceContainer.get(types_1.IDisposableRegistry);
    this.listener = listener;
    this.rootPath = path.dirname(mainScriptPath);
    this.panel = vscode_1.window.createWebviewPanel(title.toLowerCase().replace(' ', ''), title, {
      viewColumn: vscode_1.ViewColumn.Two,
      preserveFocus: true
    }, {
      enableScripts: true,
      retainContextWhenHidden: true,
      localResourceRoots: [vscode_1.Uri.file(this.rootPath)]
    });
    this.loadPromise = this.load(mainScriptPath, embeddedCss);
  }

  show() {
    return __awaiter(this, void 0, void 0, function* () {
      yield this.loadPromise;

      if (this.panel) {
        this.panel.reveal(vscode_1.ViewColumn.Two, true);
      }
    });
  }

  isVisible() {
    return this.panel ? this.panel.visible : false;
  }

  postMessage(message) {
    if (this.panel && this.panel.webview) {
      this.panel.webview.postMessage(message);
    }
  }

  load(mainScriptPath, embeddedCss) {
    return __awaiter(this, void 0, void 0, function* () {
      if (this.panel) {
        if (yield fs.pathExists(mainScriptPath)) {
          // Call our special function that sticks this script inside of an html page
          // and translates all of the paths to vscode-resource URIs
          this.panel.webview.html = this.generateReactHtml(mainScriptPath, embeddedCss); // Reset when the current panel is closed

          this.disposableRegistry.push(this.panel.onDidDispose(() => {
            this.panel = undefined;
            this.listener.dispose();
          }));
          this.disposableRegistry.push(this.panel.webview.onDidReceiveMessage(message => {
            // Pass the message onto our listener
            this.listener.onMessage(message.type, message.payload);
          }));
        } else {
          // Indicate that we can't load the file path
          const badPanelString = localize.DataScience.badWebPanelFormatString();
          this.panel.webview.html = badPanelString.format(mainScriptPath);
        }
      }
    });
  }

  generateReactHtml(mainScriptPath, embeddedCss) {
    const uriBasePath = vscode_1.Uri.file(`${path.dirname(mainScriptPath)}/`);
    const uriPath = vscode_1.Uri.file(mainScriptPath);
    const uriBase = uriBasePath.with({
      scheme: 'vscode-resource'
    });
    const uri = uriPath.with({
      scheme: 'vscode-resource'
    });
    const locDatabase = JSON.stringify(localize.getCollection());
    const style = embeddedCss ? embeddedCss : '';
    return `<!doctype html>
        <html lang="en">
            <head>
                <meta charset="utf-8">
                <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
                <meta name="theme-color" content="#000000">
                <title>React App</title>
                <base href="${uriBase}"/>
                <style type="text/css">
                ${style}
                </style>
            </head>
            <body>
                <noscript>You need to enable JavaScript to run this app.</noscript>
                <div id="root"></div>
                <script type="text/javascript">
                    function resolvePath(relativePath) {
                        if (relativePath && relativePath[0] == '.' && relativePath[1] != '.') {
                            return "${uriBase}" + relativePath.substring(1);
                        }

                        return "${uriBase}" + relativePath;
                    }
                    function getLocStrings() {
                        return ${locDatabase};
                    }
                </script>
            <script type="text/javascript" src="${uri}"></script></body>
        </html>`;
  }

}

exports.WebPanel = WebPanel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYlBhbmVsLmpzIl0sIm5hbWVzIjpbIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJyZXF1aXJlIiwiZnMiLCJwYXRoIiwidnNjb2RlXzEiLCJsb2NhbGl6ZSIsInR5cGVzXzEiLCJXZWJQYW5lbCIsImNvbnN0cnVjdG9yIiwic2VydmljZUNvbnRhaW5lciIsImxpc3RlbmVyIiwidGl0bGUiLCJtYWluU2NyaXB0UGF0aCIsImVtYmVkZGVkQ3NzIiwiZGlzcG9zYWJsZVJlZ2lzdHJ5IiwiZ2V0IiwiSURpc3Bvc2FibGVSZWdpc3RyeSIsInJvb3RQYXRoIiwiZGlybmFtZSIsInBhbmVsIiwid2luZG93IiwiY3JlYXRlV2Vidmlld1BhbmVsIiwidG9Mb3dlckNhc2UiLCJyZXBsYWNlIiwidmlld0NvbHVtbiIsIlZpZXdDb2x1bW4iLCJUd28iLCJwcmVzZXJ2ZUZvY3VzIiwiZW5hYmxlU2NyaXB0cyIsInJldGFpbkNvbnRleHRXaGVuSGlkZGVuIiwibG9jYWxSZXNvdXJjZVJvb3RzIiwiVXJpIiwiZmlsZSIsImxvYWRQcm9taXNlIiwibG9hZCIsInNob3ciLCJyZXZlYWwiLCJpc1Zpc2libGUiLCJ2aXNpYmxlIiwicG9zdE1lc3NhZ2UiLCJtZXNzYWdlIiwid2VidmlldyIsInBhdGhFeGlzdHMiLCJodG1sIiwiZ2VuZXJhdGVSZWFjdEh0bWwiLCJwdXNoIiwib25EaWREaXNwb3NlIiwidW5kZWZpbmVkIiwiZGlzcG9zZSIsIm9uRGlkUmVjZWl2ZU1lc3NhZ2UiLCJvbk1lc3NhZ2UiLCJ0eXBlIiwicGF5bG9hZCIsImJhZFBhbmVsU3RyaW5nIiwiRGF0YVNjaWVuY2UiLCJiYWRXZWJQYW5lbEZvcm1hdFN0cmluZyIsImZvcm1hdCIsInVyaUJhc2VQYXRoIiwidXJpUGF0aCIsInVyaUJhc2UiLCJ3aXRoIiwic2NoZW1lIiwidXJpIiwibG9jRGF0YWJhc2UiLCJKU09OIiwic3RyaW5naWZ5IiwiZ2V0Q29sbGVjdGlvbiIsInN0eWxlIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FBL0IsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3JGLFNBQU8sS0FBS0QsQ0FBQyxLQUFLQSxDQUFDLEdBQUdFLE9BQVQsQ0FBTixFQUF5QixVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUN2RCxhQUFTQyxTQUFULENBQW1CQyxLQUFuQixFQUEwQjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUNPLElBQVYsQ0FBZUYsS0FBZixDQUFELENBQUo7QUFBOEIsT0FBcEMsQ0FBcUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDM0YsYUFBU0MsUUFBVCxDQUFrQkosS0FBbEIsRUFBeUI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDLE9BQUQsQ0FBVCxDQUFtQkssS0FBbkIsQ0FBRCxDQUFKO0FBQWtDLE9BQXhDLENBQXlDLE9BQU9HLENBQVAsRUFBVTtBQUFFTCxRQUFBQSxNQUFNLENBQUNLLENBQUQsQ0FBTjtBQUFZO0FBQUU7O0FBQzlGLGFBQVNGLElBQVQsQ0FBY0ksTUFBZCxFQUFzQjtBQUFFQSxNQUFBQSxNQUFNLENBQUNDLElBQVAsR0FBY1QsT0FBTyxDQUFDUSxNQUFNLENBQUNMLEtBQVIsQ0FBckIsR0FBc0MsSUFBSU4sQ0FBSixDQUFNLFVBQVVHLE9BQVYsRUFBbUI7QUFBRUEsUUFBQUEsT0FBTyxD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QWlCQyxXQUFqQixFQUE4QjtBQUMzQyxVQUFNNEMsV0FBVyxHQUFHckQsUUFBUSxDQUFDMkIsR0FBVCxDQUFhQyxJQUFiLENBQW1CLEdBQUU3QixJQUFJLENBQUNlLE9BQUwsQ0FBYU4sY0FBYixDQUE2QixHQUFsRCxDQUFwQjtBQUNBLFVBQU04QyxPQUFPLEdBQUd0RCxRQUFRLENBQUMyQixHQUFULENBQWFDLElBQWIsQ0FBa0JwQixjQUFsQixDQUFoQjtBQUNBLFVBQU0rQyxPQUFPLEdBQUdGLFdBQVcsQ0FBQ0csSUFBWixDQUFpQjtBQUFFQyxNQUFBQSxNQUFNLEVBQUU7QUFBVixLQUFqQixDQUFoQjtBQUNBLFVBQU1DLEdBQUcsR0FBR0osT0FBTyxDQUFDRSxJQUFSLENBQWE7QUFBRUMsTUFBQUEsTUFBTSxFQUFFO0FBQVYsS0FBYixDQUFaO0FBQ0EsVUFBTUUsV0FBVyxHQUFHQyxJQUFJLENBQUNDLFNBQUwsQ0FBZTVELFFBQVEsQ0FBQzZELGFBQVQsRUFBZixDQUFwQjtBQUNBLFVBQU1DLEtBQUssR0FBR3RELFdBQVcsR0FBR0EsV0FBSCxHQUFpQixFQUExQztBQUNBLFdBQVE7QUFDaEI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsOEJBQThCOEMsT0FBUTtBQUN0QztBQUNBLGtCQUFrQlEsS0FBTTtBQUN4QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esc0NBQXNDUixPQUFRO0FBQzlDO0FBQ0E7QUFDQSxrQ0FBa0NBLE9BQVE7QUFDMUM7QUFDQTtBQUNBLGlDQUFpQ0ksV0FBWTtBQUM3QztBQUNBO0FBQ0Esa0RBQWtERCxHQUFJO0FBQ3RELGdCQTVCUTtBQTZCSDs7QUF6RlU7O0FBMkZmOUQsT0FBTyxDQUFDTyxRQUFSLEdBQW1CQSxRQUFuQiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxuJ3VzZSBzdHJpY3QnO1xudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcbiAgICB9KTtcbn07XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5yZXF1aXJlKFwiLi4vLi4vY29tbW9uL2V4dGVuc2lvbnNcIik7XG5jb25zdCBmcyA9IHJlcXVpcmUoXCJmcy1leHRyYVwiKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcbmNvbnN0IGxvY2FsaXplID0gcmVxdWlyZShcIi4uLy4uL2NvbW1vbi91dGlscy9sb2NhbGl6ZVwiKTtcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vdHlwZXNcIik7XG5jbGFzcyBXZWJQYW5lbCB7XG4gICAgY29uc3RydWN0b3Ioc2VydmljZUNvbnRhaW5lciwgbGlzdGVuZXIsIHRpdGxlLCBtYWluU2NyaXB0UGF0aCwgZW1iZWRkZWRDc3MpIHtcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlUmVnaXN0cnkgPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklEaXNwb3NhYmxlUmVnaXN0cnkpO1xuICAgICAgICB0aGlzLmxpc3RlbmVyID0gbGlzdGVuZXI7XG4gICAgICAgIHRoaXMucm9vdFBhdGggPSBwYXRoLmRpcm5hbWUobWFpblNjcmlwdFBhdGgpO1xuICAgICAgICB0aGlzLnBhbmVsID0gdnNjb2RlXzEud2luZG93LmNyZWF0ZVdlYnZpZXdQYW5lbCh0aXRsZS50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoJyAnLCAnJyksIHRpdGxlLCB7IHZpZXdDb2x1bW46IHZzY29kZV8xLlZpZXdDb2x1bW4uVHdvLCBwcmVzZXJ2ZUZvY3VzOiB0cnVlIH0sIHtcbiAgICAgICAgICAgIGVuYWJsZVNjcmlwdHM6IHRydWUsXG4gICAgICAgICAgICByZXRhaW5Db250ZXh0V2hlbkhpZGRlbjogdHJ1ZSxcbiAgICAgICAgICAgIGxvY2FsUmVzb3VyY2VSb290czogW3ZzY29kZV8xLlVyaS5maWxlKHRoaXMucm9vdFBhdGgpXVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5sb2FkUHJvbWlzZSA9IHRoaXMubG9hZChtYWluU2NyaXB0UGF0aCwgZW1iZWRkZWRDc3MpO1xuICAgIH1cbiAgICBzaG93KCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgeWllbGQgdGhpcy5sb2FkUHJvbWlzZTtcbiAgICAgICAgICAgIGlmICh0aGlzLnBhbmVsKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wYW5lbC5yZXZlYWwodnNjb2RlXzEuVmlld0NvbHVtbi5Ud28sIHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgaXNWaXNpYmxlKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5wYW5lbCA/IHRoaXMucGFuZWwudmlzaWJsZSA6IGZhbHNlO1xuICAgIH1cbiAgICBwb3N0TWVzc2FnZShtZXNzYWdlKSB7XG4gICAgICAgIGlmICh0aGlzLnBhbmVsICYmIHRoaXMucGFuZWwud2Vidmlldykge1xuICAgICAgICAgICAgdGhpcy5wYW5lbC53ZWJ2aWV3LnBvc3RNZXNzYWdlKG1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGxvYWQobWFpblNjcmlwdFBhdGgsIGVtYmVkZGVkQ3NzKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5wYW5lbCkge1xuICAgICAgICAgICAgICAgIGlmICh5aWVsZCBmcy5wYXRoRXhpc3RzKG1haW5TY3JpcHRQYXRoKSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBDYWxsIG91ciBzcGVjaWFsIGZ1bmN0aW9uIHRoYXQgc3RpY2tzIHRoaXMgc2NyaXB0IGluc2lkZSBvZiBhbiBodG1sIHBhZ2VcbiAgICAgICAgICAgICAgICAgICAgLy8gYW5kIHRyYW5zbGF0ZXMgYWxsIG9mIHRoZSBwYXRocyB0byB2c2NvZGUtcmVzb3VyY2UgVVJJc1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnBhbmVsLndlYnZpZXcuaHRtbCA9IHRoaXMuZ2VuZXJhdGVSZWFjdEh0bWwobWFpblNjcmlwdFBhdGgsIGVtYmVkZGVkQ3NzKTtcbiAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgd2hlbiB0aGUgY3VycmVudCBwYW5lbCBpcyBjbG9zZWRcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kaXNwb3NhYmxlUmVnaXN0cnkucHVzaCh0aGlzLnBhbmVsLm9uRGlkRGlzcG9zZSgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhbmVsID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5saXN0ZW5lci5kaXNwb3NlKCk7XG4gICAgICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kaXNwb3NhYmxlUmVnaXN0cnkucHVzaCh0aGlzLnBhbmVsLndlYnZpZXcub25EaWRSZWNlaXZlTWVzc2FnZShtZXNzYWdlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFBhc3MgdGhlIG1lc3NhZ2Ugb250byBvdXIgbGlzdGVuZXJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdGVuZXIub25NZXNzYWdlKG1lc3NhZ2UudHlwZSwgbWVzc2FnZS5wYXlsb2FkKTtcbiAgICAgICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gSW5kaWNhdGUgdGhhdCB3ZSBjYW4ndCBsb2FkIHRoZSBmaWxlIHBhdGhcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFkUGFuZWxTdHJpbmcgPSBsb2NhbGl6ZS5EYXRhU2NpZW5jZS5iYWRXZWJQYW5lbEZvcm1hdFN0cmluZygpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnBhbmVsLndlYnZpZXcuaHRtbCA9IGJhZFBhbmVsU3RyaW5nLmZvcm1hdChtYWluU2NyaXB0UGF0aCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgZ2VuZXJhdGVSZWFjdEh0bWwobWFpblNjcmlwdFBhdGgsIGVtYmVkZGVkQ3NzKSB7XG4gICAgICAgIGNvbnN0IHVyaUJhc2VQYXRoID0gdnNjb2RlXzEuVXJpLmZpbGUoYCR7cGF0aC5kaXJuYW1lKG1haW5TY3JpcHRQYXRoKX0vYCk7XG4gICAgICAgIGNvbnN0IHVyaVBhdGggPSB2c2NvZGVfMS5VcmkuZmlsZShtYWluU2NyaXB0UGF0aCk7XG4gICAgICAgIGNvbnN0IHVyaUJhc2UgPSB1cmlCYXNlUGF0aC53aXRoKHsgc2NoZW1lOiAndnNjb2RlLXJlc291cmNlJyB9KTtcbiAgICAgICAgY29uc3QgdXJpID0gdXJpUGF0aC53aXRoKHsgc2NoZW1lOiAndnNjb2RlLXJlc291cmNlJyB9KTtcbiAgICAgICAgY29uc3QgbG9jRGF0YWJhc2UgPSBKU09OLnN0cmluZ2lmeShsb2NhbGl6ZS5nZXRDb2xsZWN0aW9uKCkpO1xuICAgICAgICBjb25zdCBzdHlsZSA9IGVtYmVkZGVkQ3NzID8gZW1iZWRkZWRDc3MgOiAnJztcbiAgICAgICAgcmV0dXJuIGA8IWRvY3R5cGUgaHRtbD5cbiAgICAgICAgPGh0bWwgbGFuZz1cImVuXCI+XG4gICAgICAgICAgICA8aGVhZD5cbiAgICAgICAgICAgICAgICA8bWV0YSBjaGFyc2V0PVwidXRmLThcIj5cbiAgICAgICAgICAgICAgICA8bWV0YSBuYW1lPVwidmlld3BvcnRcIiBjb250ZW50PVwid2lkdGg9ZGV2aWNlLXdpZHRoLGluaXRpYWwtc2NhbGU9MSxzaHJpbmstdG8tZml0PW5vXCI+XG4gICAgICAgICAgICAgICAgPG1ldGEgbmFtZT1cInRoZW1lLWNvbG9yXCIgY29udGVudD1cIiMwMDAwMDBcIj5cbiAgICAgICAgICAgICAgICA8dGl0bGU+UmVhY3QgQXBwPC90aXRsZT5cbiAgICAgICAgICAgICAgICA8YmFzZSBocmVmPVwiJHt1cmlCYXNlfVwiLz5cbiAgICAgICAgICAgICAgICA8c3R5bGUgdHlwZT1cInRleHQvY3NzXCI+XG4gICAgICAgICAgICAgICAgJHtzdHlsZX1cbiAgICAgICAgICAgICAgICA8L3N0eWxlPlxuICAgICAgICAgICAgPC9oZWFkPlxuICAgICAgICAgICAgPGJvZHk+XG4gICAgICAgICAgICAgICAgPG5vc2NyaXB0PllvdSBuZWVkIHRvIGVuYWJsZSBKYXZhU2NyaXB0IHRvIHJ1biB0aGlzIGFwcC48L25vc2NyaXB0PlxuICAgICAgICAgICAgICAgIDxkaXYgaWQ9XCJyb290XCI+PC9kaXY+XG4gICAgICAgICAgICAgICAgPHNjcmlwdCB0eXBlPVwidGV4dC9qYXZhc2NyaXB0XCI+XG4gICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHJlc29sdmVQYXRoKHJlbGF0aXZlUGF0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlbGF0aXZlUGF0aCAmJiByZWxhdGl2ZVBhdGhbMF0gPT0gJy4nICYmIHJlbGF0aXZlUGF0aFsxXSAhPSAnLicpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gXCIke3VyaUJhc2V9XCIgKyByZWxhdGl2ZVBhdGguc3Vic3RyaW5nKDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gXCIke3VyaUJhc2V9XCIgKyByZWxhdGl2ZVBhdGg7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0TG9jU3RyaW5ncygpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAke2xvY0RhdGFiYXNlfTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIDwvc2NyaXB0PlxuICAgICAgICAgICAgPHNjcmlwdCB0eXBlPVwidGV4dC9qYXZhc2NyaXB0XCIgc3JjPVwiJHt1cml9XCI+PC9zY3JpcHQ+PC9ib2R5PlxuICAgICAgICA8L2h0bWw+YDtcbiAgICB9XG59XG5leHBvcnRzLldlYlBhbmVsID0gV2ViUGFuZWw7XG4vLyMgc291cmNlTWFwcGluZ1VSTD13ZWJQYW5lbC5qcy5tYXAiXX0=