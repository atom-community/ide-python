"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const contracts_1 = require("../../interpreter/contracts");

const types_1 = require("../../ioc/types");

const types_2 = require("../application/types");

require("../extensions");

const types_3 = require("../platform/types");

const types_4 = require("../types");

const condaActivationProvider_1 = require("./environmentActivationProviders/condaActivationProvider");

const types_5 = require("./types"); // Types of shells can be found here:
// 1. https://wiki.ubuntu.com/ChangingShells


const IS_GITBASH = /(gitbash.exe$)/i;
const IS_BASH = /(bash.exe$|bash$)/i;
const IS_WSL = /(wsl.exe$)/i;
const IS_ZSH = /(zsh$)/i;
const IS_KSH = /(ksh$)/i;
const IS_COMMAND = /cmd.exe$/i;
const IS_POWERSHELL = /(powershell.exe$|powershell$)/i;
const IS_POWERSHELL_CORE = /(pwsh.exe$|pwsh$)/i;
const IS_FISH = /(fish$)/i;
const IS_CSHELL = /(csh$)/i;
const IS_TCSHELL = /(tcsh$)/i;
let TerminalHelper = class TerminalHelper {
  constructor(serviceContainer) {
    this.serviceContainer = serviceContainer;
    this.detectableShells = new Map();
    this.detectableShells.set(types_5.TerminalShellType.powershell, IS_POWERSHELL);
    this.detectableShells.set(types_5.TerminalShellType.gitbash, IS_GITBASH);
    this.detectableShells.set(types_5.TerminalShellType.bash, IS_BASH);
    this.detectableShells.set(types_5.TerminalShellType.wsl, IS_WSL);
    this.detectableShells.set(types_5.TerminalShellType.zsh, IS_ZSH);
    this.detectableShells.set(types_5.TerminalShellType.ksh, IS_KSH);
    this.detectableShells.set(types_5.TerminalShellType.commandPrompt, IS_COMMAND);
    this.detectableShells.set(types_5.TerminalShellType.fish, IS_FISH);
    this.detectableShells.set(types_5.TerminalShellType.tcshell, IS_TCSHELL);
    this.detectableShells.set(types_5.TerminalShellType.cshell, IS_CSHELL);
    this.detectableShells.set(types_5.TerminalShellType.powershellCore, IS_POWERSHELL_CORE);
  }

  createTerminal(title) {
    const terminalManager = this.serviceContainer.get(types_2.ITerminalManager);
    return terminalManager.createTerminal({
      name: title
    });
  }

  identifyTerminalShell(shellPath) {
    return Array.from(this.detectableShells.keys()).reduce((matchedShell, shellToDetect) => {
      if (matchedShell === types_5.TerminalShellType.other && this.detectableShells.get(shellToDetect).test(shellPath)) {
        return shellToDetect;
      }

      return matchedShell;
    }, types_5.TerminalShellType.other);
  }

  getTerminalShellPath() {
    const workspace = this.serviceContainer.get(types_2.IWorkspaceService);
    const shellConfig = workspace.getConfiguration('terminal.integrated.shell');
    const platformService = this.serviceContainer.get(types_3.IPlatformService);
    let osSection = '';

    if (platformService.isWindows) {
      osSection = 'windows';
    } else if (platformService.isMac) {
      osSection = 'osx';
    } else if (platformService.isLinux) {
      osSection = 'linux';
    }

    if (osSection.length === 0) {
      return '';
    }

    return shellConfig.get(osSection);
  }

  buildCommandForTerminal(terminalShellType, command, args) {
    const isPowershell = terminalShellType === types_5.TerminalShellType.powershell || terminalShellType === types_5.TerminalShellType.powershellCore;
    const commandPrefix = isPowershell ? '& ' : '';
    return `${commandPrefix}${command.fileToCommandArgument()} ${args.join(' ')}`.trim();
  }

  getEnvironmentActivationCommands(terminalShellType, resource) {
    return __awaiter(this, void 0, void 0, function* () {
      const settings = this.serviceContainer.get(types_4.IConfigurationService).getSettings(resource);
      const activateEnvironment = settings.terminal.activateEnvironment;

      if (!activateEnvironment) {
        return;
      } // If we have a conda environment, then use that.


      const isCondaEnvironment = yield this.serviceContainer.get(contracts_1.ICondaService).isCondaEnvironment(settings.pythonPath);

      if (isCondaEnvironment) {
        const condaActivationProvider = new condaActivationProvider_1.CondaActivationCommandProvider(this.serviceContainer);
        const activationCommands = yield condaActivationProvider.getActivationCommands(resource, terminalShellType);

        if (Array.isArray(activationCommands)) {
          return activationCommands;
        }
      } // Search from the list of providers.


      const providers = this.serviceContainer.getAll(types_5.ITerminalActivationCommandProvider);
      const supportedProviders = providers.filter(provider => provider.isShellSupported(terminalShellType));

      for (const provider of supportedProviders) {
        const activationCommands = yield provider.getActivationCommands(resource, terminalShellType);

        if (Array.isArray(activationCommands)) {
          return activationCommands;
        }
      }
    });
  }

};
TerminalHelper = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_1.IServiceContainer))], TerminalHelper);
exports.TerminalHelper = TerminalHelper;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhlbHBlci5qcyJdLCJuYW1lcyI6WyJfX2RlY29yYXRlIiwiZGVjb3JhdG9ycyIsInRhcmdldCIsImtleSIsImRlc2MiLCJjIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImQiLCJSZWZsZWN0IiwiZGVjb3JhdGUiLCJpIiwiZGVmaW5lUHJvcGVydHkiLCJfX3BhcmFtIiwicGFyYW1JbmRleCIsImRlY29yYXRvciIsIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJleHBvcnRzIiwiaW52ZXJzaWZ5XzEiLCJyZXF1aXJlIiwiY29udHJhY3RzXzEiLCJ0eXBlc18xIiwidHlwZXNfMiIsInR5cGVzXzMiLCJ0eXBlc180IiwiY29uZGFBY3RpdmF0aW9uUHJvdmlkZXJfMSIsInR5cGVzXzUiLCJJU19HSVRCQVNIIiwiSVNfQkFTSCIsIklTX1dTTCIsIklTX1pTSCIsIklTX0tTSCIsIklTX0NPTU1BTkQiLCJJU19QT1dFUlNIRUxMIiwiSVNfUE9XRVJTSEVMTF9DT1JFIiwiSVNfRklTSCIsIklTX0NTSEVMTCIsIklTX1RDU0hFTEwiLCJUZXJtaW5hbEhlbHBlciIsImNvbnN0cnVjdG9yIiwic2VydmljZUNvbnRhaW5lciIsImRldGVjdGFibGVTaGVsbHMiLCJNYXAiLCJzZXQiLCJUZXJtaW5hbFNoZWxsVHlwZSIsInBvd2Vyc2hlbGwiLCJnaXRiYXNoIiwiYmFzaCIsIndzbCIsInpzaCIsImtzaCIsImNvbW1hbmRQcm9tcHQiLCJmaXNoIiwidGNzaGVsbCIsImNzaGVsbCIsInBvd2Vyc2hlbGxDb3JlIiwiY3JlYXRlVGVybWluYWwiLCJ0aXRsZSIsInRlcm1pbmFsTWFuYWdlciIsImdldCIsIklUZXJtaW5hbE1hbmFnZXIiLCJuYW1lIiwiaWRlbnRpZnlUZXJtaW5hbFNoZWxsIiwic2hlbGxQYXRoIiwiQXJyYXkiLCJmcm9tIiwia2V5cyIsInJlZHVjZSIsIm1hdGNoZWRTaGVsbCIsInNoZWxsVG9EZXRlY3QiLCJvdGhlciIsInRlc3QiLCJnZXRUZXJtaW5hbFNoZWxsUGF0aCIsIndvcmtzcGFjZSIsIklXb3Jrc3BhY2VTZXJ2aWNlIiwic2hlbGxDb25maWciLCJnZXRDb25maWd1cmF0aW9uIiwicGxhdGZvcm1TZXJ2aWNlIiwiSVBsYXRmb3JtU2VydmljZSIsIm9zU2VjdGlvbiIsImlzV2luZG93cyIsImlzTWFjIiwiaXNMaW51eCIsImJ1aWxkQ29tbWFuZEZvclRlcm1pbmFsIiwidGVybWluYWxTaGVsbFR5cGUiLCJjb21tYW5kIiwiYXJncyIsImlzUG93ZXJzaGVsbCIsImNvbW1hbmRQcmVmaXgiLCJmaWxlVG9Db21tYW5kQXJndW1lbnQiLCJqb2luIiwidHJpbSIsImdldEVudmlyb25tZW50QWN0aXZhdGlvbkNvbW1hbmRzIiwicmVzb3VyY2UiLCJzZXR0aW5ncyIsIklDb25maWd1cmF0aW9uU2VydmljZSIsImdldFNldHRpbmdzIiwiYWN0aXZhdGVFbnZpcm9ubWVudCIsInRlcm1pbmFsIiwiaXNDb25kYUVudmlyb25tZW50IiwiSUNvbmRhU2VydmljZSIsInB5dGhvblBhdGgiLCJjb25kYUFjdGl2YXRpb25Qcm92aWRlciIsIkNvbmRhQWN0aXZhdGlvbkNvbW1hbmRQcm92aWRlciIsImFjdGl2YXRpb25Db21tYW5kcyIsImdldEFjdGl2YXRpb25Db21tYW5kcyIsImlzQXJyYXkiLCJwcm92aWRlcnMiLCJnZXRBbGwiLCJJVGVybWluYWxBY3RpdmF0aW9uQ29tbWFuZFByb3ZpZGVyIiwic3VwcG9ydGVkUHJvdmlkZXJzIiwiZmlsdGVyIiwicHJvdmlkZXIiLCJpc1NoZWxsU3VwcG9ydGVkIiwiaW5qZWN0YWJsZSIsImluamVjdCIsIklTZXJ2aWNlQ29u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Q0FBNkJsRixPQUFPLENBQUNtRixrQ0FBckMsQ0FBbEI7QUFDQSxZQUFNQyxrQkFBa0IsR0FBR0gsU0FBUyxDQUFDSSxNQUFWLENBQWlCQyxRQUFRLElBQUlBLFFBQVEsQ0FBQ0MsZ0JBQVQsQ0FBMEI3QixpQkFBMUIsQ0FBN0IsQ0FBM0I7O0FBQ0EsV0FBSyxNQUFNNEIsUUFBWCxJQUF1QkYsa0JBQXZCLEVBQTJDO0FBQ3ZDLGNBQU1OLGtCQUFrQixHQUFHLE1BQU1RLFFBQVEsQ0FBQ1AscUJBQVQsQ0FBK0JaLFFBQS9CLEVBQXlDVCxpQkFBekMsQ0FBakM7O0FBQ0EsWUFBSXBCLEtBQUssQ0FBQzBDLE9BQU4sQ0FBY0Ysa0JBQWQsQ0FBSixFQUF1QztBQUNuQyxpQkFBT0Esa0JBQVA7QUFDSDtBQUNKO0FBQ0osS0F4QmUsQ0FBaEI7QUF5Qkg7O0FBL0VxQyxDQUExQztBQWlGQWxFLGNBQWMsR0FBRzFELFVBQVUsQ0FBQyxDQUN4QnNDLFdBQVcsQ0FBQ2dHLFVBQVosRUFEd0IsRUFFeEJ0SCxPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDaUcsTUFBWixDQUFtQjlGLE9BQU8sQ0FBQytGLGlCQUEzQixDQUFKLENBRmlCLENBQUQsRUFHeEI5RSxjQUh3QixDQUEzQjtBQUlBckIsT0FBTyxDQUFDcUIsY0FBUixHQUF5QkEsY0FBekIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxudmFyIF9fZGVjb3JhdGUgPSAodGhpcyAmJiB0aGlzLl9fZGVjb3JhdGUpIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcbiAgICBlbHNlIGZvciAodmFyIGkgPSBkZWNvcmF0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBpZiAoZCA9IGRlY29yYXRvcnNbaV0pIHIgPSAoYyA8IDMgPyBkKHIpIDogYyA+IDMgPyBkKHRhcmdldCwga2V5LCByKSA6IGQodGFyZ2V0LCBrZXkpKSB8fCByO1xuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XG59O1xudmFyIF9fcGFyYW0gPSAodGhpcyAmJiB0aGlzLl9fcGFyYW0pIHx8IGZ1bmN0aW9uIChwYXJhbUluZGV4LCBkZWNvcmF0b3IpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7IGRlY29yYXRvcih0YXJnZXQsIGtleSwgcGFyYW1JbmRleCk7IH1cbn07XG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xuICAgIH0pO1xufTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbmNvbnN0IGludmVyc2lmeV8xID0gcmVxdWlyZShcImludmVyc2lmeVwiKTtcbmNvbnN0IGNvbnRyYWN0c18xID0gcmVxdWlyZShcIi4uLy4uL2ludGVycHJldGVyL2NvbnRyYWN0c1wiKTtcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vLi4vaW9jL3R5cGVzXCIpO1xuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi9hcHBsaWNhdGlvbi90eXBlc1wiKTtcbnJlcXVpcmUoXCIuLi9leHRlbnNpb25zXCIpO1xuY29uc3QgdHlwZXNfMyA9IHJlcXVpcmUoXCIuLi9wbGF0Zm9ybS90eXBlc1wiKTtcbmNvbnN0IHR5cGVzXzQgPSByZXF1aXJlKFwiLi4vdHlwZXNcIik7XG5jb25zdCBjb25kYUFjdGl2YXRpb25Qcm92aWRlcl8xID0gcmVxdWlyZShcIi4vZW52aXJvbm1lbnRBY3RpdmF0aW9uUHJvdmlkZXJzL2NvbmRhQWN0aXZhdGlvblByb3ZpZGVyXCIpO1xuY29uc3QgdHlwZXNfNSA9IHJlcXVpcmUoXCIuL3R5cGVzXCIpO1xuLy8gVHlwZXMgb2Ygc2hlbGxzIGNhbiBiZSBmb3VuZCBoZXJlOlxuLy8gMS4gaHR0cHM6Ly93aWtpLnVidW50dS5jb20vQ2hhbmdpbmdTaGVsbHNcbmNvbnN0IElTX0dJVEJBU0ggPSAvKGdpdGJhc2guZXhlJCkvaTtcbmNvbnN0IElTX0JBU0ggPSAvKGJhc2guZXhlJHxiYXNoJCkvaTtcbmNvbnN0IElTX1dTTCA9IC8od3NsLmV4ZSQpL2k7XG5jb25zdCBJU19aU0ggPSAvKHpzaCQpL2k7XG5jb25zdCBJU19LU0ggPSAvKGtzaCQpL2k7XG5jb25zdCBJU19DT01NQU5EID0gL2NtZC5leGUkL2k7XG5jb25zdCBJU19QT1dFUlNIRUxMID0gLyhwb3dlcnNoZWxsLmV4ZSR8cG93ZXJzaGVsbCQpL2k7XG5jb25zdCBJU19QT1dFUlNIRUxMX0NPUkUgPSAvKHB3c2guZXhlJHxwd3NoJCkvaTtcbmNvbnN0IElTX0ZJU0ggPSAvKGZpc2gkKS9pO1xuY29uc3QgSVNfQ1NIRUxMID0gLyhjc2gkKS9pO1xuY29uc3QgSVNfVENTSEVMTCA9IC8odGNzaCQpL2k7XG5sZXQgVGVybWluYWxIZWxwZXIgPSBjbGFzcyBUZXJtaW5hbEhlbHBlciB7XG4gICAgY29uc3RydWN0b3Ioc2VydmljZUNvbnRhaW5lcikge1xuICAgICAgICB0aGlzLnNlcnZpY2VDb250YWluZXIgPSBzZXJ2aWNlQ29udGFpbmVyO1xuICAgICAgICB0aGlzLmRldGVjdGFibGVTaGVsbHMgPSBuZXcgTWFwKCk7XG4gICAgICAgIHRoaXMuZGV0ZWN0YWJsZVNoZWxscy5zZXQodHlwZXNfNS5UZXJtaW5hbFNoZWxsVHlwZS5wb3dlcnNoZWxsLCBJU19QT1dFUlNIRUxMKTtcbiAgICAgICAgdGhpcy5kZXRlY3RhYmxlU2hlbGxzLnNldCh0eXBlc181LlRlcm1pbmFsU2hlbGxUeXBlLmdpdGJhc2gsIElTX0dJVEJBU0gpO1xuICAgICAgICB0aGlzLmRldGVjdGFibGVTaGVsbHMuc2V0KHR5cGVzXzUuVGVybWluYWxTaGVsbFR5cGUuYmFzaCwgSVNfQkFTSCk7XG4gICAgICAgIHRoaXMuZGV0ZWN0YWJsZVNoZWxscy5zZXQodHlwZXNfNS5UZXJtaW5hbFNoZWxsVHlwZS53c2wsIElTX1dTTCk7XG4gICAgICAgIHRoaXMuZGV0ZWN0YWJsZVNoZWxscy5zZXQodHlwZXNfNS5UZXJtaW5hbFNoZWxsVHlwZS56c2gsIElTX1pTSCk7XG4gICAgICAgIHRoaXMuZGV0ZWN0YWJsZVNoZWxscy5zZXQodHlwZXNfNS5UZXJtaW5hbFNoZWxsVHlwZS5rc2gsIElTX0tTSCk7XG4gICAgICAgIHRoaXMuZGV0ZWN0YWJsZVNoZWxscy5zZXQodHlwZXNfNS5UZXJtaW5hbFNoZWxsVHlwZS5jb21tYW5kUHJvbXB0LCBJU19DT01NQU5EKTtcbiAgICAgICAgdGhpcy5kZXRlY3RhYmxlU2hlbGxzLnNldCh0eXBlc181LlRlcm1pbmFsU2hlbGxUeXBlLmZpc2gsIElTX0ZJU0gpO1xuICAgICAgICB0aGlzLmRldGVjdGFibGVTaGVsbHMuc2V0KHR5cGVzXzUuVGVybWluYWxTaGVsbFR5cGUudGNzaGVsbCwgSVNfVENTSEVMTCk7XG4gICAgICAgIHRoaXMuZGV0ZWN0YWJsZVNoZWxscy5zZXQodHlwZXNfNS5UZXJtaW5hbFNoZWxsVHlwZS5jc2hlbGwsIElTX0NTSEVMTCk7XG4gICAgICAgIHRoaXMuZGV0ZWN0YWJsZVNoZWxscy5zZXQodHlwZXNfNS5UZXJtaW5hbFNoZWxsVHlwZS5wb3dlcnNoZWxsQ29yZSwgSVNfUE9XRVJTSEVMTF9DT1JFKTtcbiAgICB9XG4gICAgY3JlYXRlVGVybWluYWwodGl0bGUpIHtcbiAgICAgICAgY29uc3QgdGVybWluYWxNYW5hZ2VyID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18yLklUZXJtaW5hbE1hbmFnZXIpO1xuICAgICAgICByZXR1cm4gdGVybWluYWxNYW5hZ2VyLmNyZWF0ZVRlcm1pbmFsKHsgbmFtZTogdGl0bGUgfSk7XG4gICAgfVxuICAgIGlkZW50aWZ5VGVybWluYWxTaGVsbChzaGVsbFBhdGgpIHtcbiAgICAgICAgcmV0dXJuIEFycmF5LmZyb20odGhpcy5kZXRlY3RhYmxlU2hlbGxzLmtleXMoKSlcbiAgICAgICAgICAgIC5yZWR1Y2UoKG1hdGNoZWRTaGVsbCwgc2hlbGxUb0RldGVjdCkgPT4ge1xuICAgICAgICAgICAgaWYgKG1hdGNoZWRTaGVsbCA9PT0gdHlwZXNfNS5UZXJtaW5hbFNoZWxsVHlwZS5vdGhlciAmJiB0aGlzLmRldGVjdGFibGVTaGVsbHMuZ2V0KHNoZWxsVG9EZXRlY3QpLnRlc3Qoc2hlbGxQYXRoKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBzaGVsbFRvRGV0ZWN0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG1hdGNoZWRTaGVsbDtcbiAgICAgICAgfSwgdHlwZXNfNS5UZXJtaW5hbFNoZWxsVHlwZS5vdGhlcik7XG4gICAgfVxuICAgIGdldFRlcm1pbmFsU2hlbGxQYXRoKCkge1xuICAgICAgICBjb25zdCB3b3Jrc3BhY2UgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzIuSVdvcmtzcGFjZVNlcnZpY2UpO1xuICAgICAgICBjb25zdCBzaGVsbENvbmZpZyA9IHdvcmtzcGFjZS5nZXRDb25maWd1cmF0aW9uKCd0ZXJtaW5hbC5pbnRlZ3JhdGVkLnNoZWxsJyk7XG4gICAgICAgIGNvbnN0IHBsYXRmb3JtU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMy5JUGxhdGZvcm1TZXJ2aWNlKTtcbiAgICAgICAgbGV0IG9zU2VjdGlvbiA9ICcnO1xuICAgICAgICBpZiAocGxhdGZvcm1TZXJ2aWNlLmlzV2luZG93cykge1xuICAgICAgICAgICAgb3NTZWN0aW9uID0gJ3dpbmRvd3MnO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHBsYXRmb3JtU2VydmljZS5pc01hYykge1xuICAgICAgICAgICAgb3NTZWN0aW9uID0gJ29zeCc7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAocGxhdGZvcm1TZXJ2aWNlLmlzTGludXgpIHtcbiAgICAgICAgICAgIG9zU2VjdGlvbiA9ICdsaW51eCc7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG9zU2VjdGlvbi5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc2hlbGxDb25maWcuZ2V0KG9zU2VjdGlvbik7XG4gICAgfVxuICAgIGJ1aWxkQ29tbWFuZEZvclRlcm1pbmFsKHRlcm1pbmFsU2hlbGxUeXBlLCBjb21tYW5kLCBhcmdzKSB7XG4gICAgICAgIGNvbnN0IGlzUG93ZXJzaGVsbCA9IHRlcm1pbmFsU2hlbGxUeXBlID09PSB0eXBlc181LlRlcm1pbmFsU2hlbGxUeXBlLnBvd2Vyc2hlbGwgfHwgdGVybWluYWxTaGVsbFR5cGUgPT09IHR5cGVzXzUuVGVybWluYWxTaGVsbFR5cGUucG93ZXJzaGVsbENvcmU7XG4gICAgICAgIGNvbnN0IGNvbW1hbmRQcmVmaXggPSBpc1Bvd2Vyc2hlbGwgPyAnJiAnIDogJyc7XG4gICAgICAgIHJldHVybiBgJHtjb21tYW5kUHJlZml4fSR7Y29tbWFuZC5maWxlVG9Db21tYW5kQXJndW1lbnQoKX0gJHthcmdzLmpvaW4oJyAnKX1gLnRyaW0oKTtcbiAgICB9XG4gICAgZ2V0RW52aXJvbm1lbnRBY3RpdmF0aW9uQ29tbWFuZHModGVybWluYWxTaGVsbFR5cGUsIHJlc291cmNlKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBzZXR0aW5ncyA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfNC5JQ29uZmlndXJhdGlvblNlcnZpY2UpLmdldFNldHRpbmdzKHJlc291cmNlKTtcbiAgICAgICAgICAgIGNvbnN0IGFjdGl2YXRlRW52aXJvbm1lbnQgPSBzZXR0aW5ncy50ZXJtaW5hbC5hY3RpdmF0ZUVudmlyb25tZW50O1xuICAgICAgICAgICAgaWYgKCFhY3RpdmF0ZUVudmlyb25tZW50KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gSWYgd2UgaGF2ZSBhIGNvbmRhIGVudmlyb25tZW50LCB0aGVuIHVzZSB0aGF0LlxuICAgICAgICAgICAgY29uc3QgaXNDb25kYUVudmlyb25tZW50ID0geWllbGQgdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldChjb250cmFjdHNfMS5JQ29uZGFTZXJ2aWNlKS5pc0NvbmRhRW52aXJvbm1lbnQoc2V0dGluZ3MucHl0aG9uUGF0aCk7XG4gICAgICAgICAgICBpZiAoaXNDb25kYUVudmlyb25tZW50KSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY29uZGFBY3RpdmF0aW9uUHJvdmlkZXIgPSBuZXcgY29uZGFBY3RpdmF0aW9uUHJvdmlkZXJfMS5Db25kYUFjdGl2YXRpb25Db21tYW5kUHJvdmlkZXIodGhpcy5zZXJ2aWNlQ29udGFpbmVyKTtcbiAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmF0aW9uQ29tbWFuZHMgPSB5aWVsZCBjb25kYUFjdGl2YXRpb25Qcm92aWRlci5nZXRBY3RpdmF0aW9uQ29tbWFuZHMocmVzb3VyY2UsIHRlcm1pbmFsU2hlbGxUeXBlKTtcbiAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShhY3RpdmF0aW9uQ29tbWFuZHMpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBhY3RpdmF0aW9uQ29tbWFuZHM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gU2VhcmNoIGZyb20gdGhlIGxpc3Qgb2YgcHJvdmlkZXJzLlxuICAgICAgICAgICAgY29uc3QgcHJvdmlkZXJzID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldEFsbCh0eXBlc181LklUZXJtaW5hbEFjdGl2YXRpb25Db21tYW5kUHJvdmlkZXIpO1xuICAgICAgICAgICAgY29uc3Qgc3VwcG9ydGVkUHJvdmlkZXJzID0gcHJvdmlkZXJzLmZpbHRlcihwcm92aWRlciA9PiBwcm92aWRlci5pc1NoZWxsU3VwcG9ydGVkKHRlcm1pbmFsU2hlbGxUeXBlKSk7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IHByb3ZpZGVyIG9mIHN1cHBvcnRlZFByb3ZpZGVycykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGFjdGl2YXRpb25Db21tYW5kcyA9IHlpZWxkIHByb3ZpZGVyLmdldEFjdGl2YXRpb25Db21tYW5kcyhyZXNvdXJjZSwgdGVybWluYWxTaGVsbFR5cGUpO1xuICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGFjdGl2YXRpb25Db21tYW5kcykpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFjdGl2YXRpb25Db21tYW5kcztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn07XG5UZXJtaW5hbEhlbHBlciA9IF9fZGVjb3JhdGUoW1xuICAgIGludmVyc2lmeV8xLmluamVjdGFibGUoKSxcbiAgICBfX3BhcmFtKDAsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18xLklTZXJ2aWNlQ29udGFpbmVyKSlcbl0sIFRlcm1pbmFsSGVscGVyKTtcbmV4cG9ydHMuVGVybWluYWxIZWxwZXIgPSBUZXJtaW5hbEhlbHBlcjtcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWhlbHBlci5qcy5tYXAiXX0=