"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const vscode_1 = require("vscode");

require("../../common/extensions");

const contracts_1 = require("../../interpreter/contracts");

const types_1 = require("../../ioc/types");

const telemetry_1 = require("../../telemetry");

const constants_1 = require("../../telemetry/constants");

const types_2 = require("../application/types");

const types_3 = require("../types");

const types_4 = require("./types");

let TerminalService = class TerminalService {
  constructor(serviceContainer, resource, title = 'Python') {
    this.serviceContainer = serviceContainer;
    this.resource = resource;
    this.title = title;
    this.terminalClosed = new vscode_1.EventEmitter();
    const disposableRegistry = this.serviceContainer.get(types_3.IDisposableRegistry);
    disposableRegistry.push(this);
    this.terminalHelper = this.serviceContainer.get(types_4.ITerminalHelper);
    this.terminalManager = this.serviceContainer.get(types_2.ITerminalManager);
    this.terminalManager.onDidCloseTerminal(this.terminalCloseHandler, this, disposableRegistry);
    this.terminalActivator = this.serviceContainer.get(types_4.ITerminalActivator);
  }

  get onDidCloseTerminal() {
    return this.terminalClosed.event.bind(this.terminalClosed);
  }

  dispose() {
    if (this.terminal) {
      this.terminal.dispose();
    }
  }

  sendCommand(command, args) {
    return __awaiter(this, void 0, void 0, function* () {
      yield this.ensureTerminal();
      const text = this.terminalHelper.buildCommandForTerminal(this.terminalShellType, command, args);
      this.terminal.show(true);
      this.terminal.sendText(text, true);
    });
  }

  sendText(text) {
    return __awaiter(this, void 0, void 0, function* () {
      yield this.ensureTerminal();
      this.terminal.show(true);
      this.terminal.sendText(text);
    });
  }

  show(preserveFocus = true) {
    return __awaiter(this, void 0, void 0, function* () {
      yield this.ensureTerminal(preserveFocus);
      this.terminal.show(preserveFocus);
    });
  }

  ensureTerminal(preserveFocus = true) {
    return __awaiter(this, void 0, void 0, function* () {
      if (this.terminal) {
        return;
      }

      const shellPath = this.terminalHelper.getTerminalShellPath();
      this.terminalShellType = !shellPath || shellPath.length === 0 ? types_4.TerminalShellType.other : this.terminalHelper.identifyTerminalShell(shellPath);
      this.terminal = this.terminalManager.createTerminal({
        name: this.title
      }); // Sometimes the terminal takes some time to start up before it can start accepting input.

      yield new Promise(resolve => setTimeout(resolve, 100));
      yield this.terminalActivator.activateEnvironmentInTerminal(this.terminal, this.resource, preserveFocus);
      this.terminal.show(preserveFocus);
      this.sendTelemetry().ignoreErrors();
    });
  }

  terminalCloseHandler(terminal) {
    if (terminal === this.terminal) {
      this.terminalClosed.fire();
      this.terminal = undefined;
    }
  }

  sendTelemetry() {
    return __awaiter(this, void 0, void 0, function* () {
      const pythonPath = this.serviceContainer.get(types_3.IConfigurationService).getSettings(this.resource).pythonPath;
      const interpreterInfo = yield this.serviceContainer.get(contracts_1.IInterpreterService).getInterpreterDetails(pythonPath);
      const pythonVersion = interpreterInfo && interpreterInfo.version_info ? interpreterInfo.version_info.join('.') : undefined;
      const interpreterType = interpreterInfo ? interpreterInfo.type : undefined;
      telemetry_1.captureTelemetry(constants_1.TERMINAL_CREATE, {
        terminal: this.terminalShellType,
        pythonVersion,
        interpreterType
      });
    });
  }

};
TerminalService = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_1.IServiceContainer))], TerminalService);
exports.TerminalService = TerminalService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZpY2UuanMiXSwibmFtZXMiOlsiX19kZWNvcmF0ZSIsImRlY29yYXRvcnMiLCJ0YXJnZXQiLCJrZXkiLCJkZXNjIiwiYyIsImFyZ3VtZW50cyIsImxlbmd0aCIsInIiLCJPYmplY3QiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJkIiwiUmVmbGVjdCIsImRlY29yYXRlIiwiaSIsImRlZmluZVByb3BlcnR5IiwiX19wYXJhbSIsInBhcmFtSW5kZXgiLCJkZWNvcmF0b3IiLCJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiZXhwb3J0cyIsImludmVyc2lmeV8xIiwicmVxdWlyZSIsInZzY29kZV8xIiwiY29udHJhY3RzXzEiLCJ0eXBlc18xIiwidGVsZW1ldHJ5XzEiLCJjb25zdGFudHNfMSIsInR5cGVzXzIiLCJ0eXBlc18zIiwidHlwZXNfNCIsIlRlcm1pbmFsU2VydmljZSIsImNvbnN0cnVjdG9yIiwic2VydmljZUNvbnRhaW5lciIsInJlc291cmNlIiwidGl0bGUiLCJ0ZXJtaW5hbENsb3NlZCIsIkV2ZW50RW1pdHRlciIsImRpc3Bvc2FibGVSZWdpc3RyeSIsImdldCIsIklEaXNwb3NhYmxlUmVnaXN0cnkiLCJwdXNoIiwidGVybWluYWxIZWxwZXIiLCJJVGVybWluYWxIZWxwZXIiLCJ0ZXJtaW5hbE1hbmFnZXIiLCJJVGVybWluYWxNYW5hZ2VyIiwib25EaWRDbG9zZVRlcm1pbmFsIiwidGVybWluYWxDbG9zZUhhbmRsZXIiLCJ0ZXJtaW5hbEFjdGl2YXRvciIsIklUZXJtaW5hbEFjdGl2YXRvciIsImV2ZW50IiwiYmluZCIsImRpc3Bvc2UiLCJ0ZXJtaW5hbCIsInNlbmRDb21tYW5kIiwiY29tbWFuZCIsImFyZ3MiLCJlbnN1cmVUZXJtaW5hbCIsInRleHQiLCJidWlsZENvbW1hbmRGb3JUZXJtaW5hbCIsInRlcm1pbmFsU2hlbGxUeXBlIiwic2hvdyIsInNlbmRUZXh0IiwicHJlc2VydmVGb2N1cyIsInNoZWxsUGF0aCIsImdldFRlcm1pbmFsU2hlbGxQYXRoIiwiVGVybWluYWxTaGVsbFR5cGUiLCJvdGhlciIsImlkZW50aWZ5VGVybWluYWxTaGVsbCIsImNyZWF0ZVRlcm1pbmFsIiwibmFtZSIsInNldFRpbWVvdXQiLCJhY3RpdmF0ZUVudmlyb25tZW50SW5UZXJtaW5hbCIsInNlbmRUZWxlbWV0cnkiLCJpZ25vcmVFcnJvcnMiLCJmaXJlIiwidW5kZWZpbmVkIiwicHl0aG9uUGF0aCIsIklDb25maWd1cmF0aW9uU2VydmljZSIsImdldFNldHRpbmdzIiwiaW50ZXJwcmV0ZXJJbmZvIiwiSUludGVycHJldGVyU2VydmljZSIsImdldEludGVycHJldGVyRGV0YWlscyIsInB5dGhvblZlcnNpb24iLCJ2ZXJzaW9uX2luZm8iLCJqb2luIiwiaW50ZXJwcmV0ZXJUeXBlIiwidHlwZSIsImNhcHR1cmVUZWxlbWV0cnkiLCJURVJNSU5BTF9DUkVBVEUiLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSVNlcnZpY2VDb250YWluZXIiXSwibWFwcGluZ3MiOiJBQUFBLGEsQ0FDQTtBQUNBOztBQUNBLElBQUlBLFVBQVUsR0FBSSxVQUFRLFNBQUtBLFVBQWQsSUFBNkIsVUFBVUMsVUFBVixFQUFzQkMsTUFBdEIsRUFBOEJDLEdBQTlCLEVBQW1DQyxJQUFuQyxFQUF5QztBQUNuRixNQUFJQyxDQUFDLEdBQUdDLFNBQVMsQ0FBQ0MsTUFBbEI7QUFBQSxNQUEwQkMsQ0FBQyxHQUFHSCxDQUFDLEdBQUcsQ0FBSixHQUFRSCxNQUFSLEdBQWlCRSxJQUFJLEtBQUssSUFBVCxHQUFnQkEsSUFBSSxHQUFHSyxNQUFNLENBQUNDLHdCQUFQLENBQWdDUixNQUFoQyxFQUF3Q0MsR0FBeEMsQ0FBdkIsR0FBc0VDLElBQXJIO0FB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V0FBVyxDQUFDOEQsZ0JBQVosQ0FBNkI3RCxXQUFXLENBQUM4RCxlQUF6QyxFQUEwRDtBQUFFcEMsUUFBQUEsUUFBUSxFQUFFLEtBQUtPLGlCQUFqQjtBQUFvQ3VCLFFBQUFBLGFBQXBDO0FBQW1ERyxRQUFBQTtBQUFuRCxPQUExRDtBQUNILEtBTmUsQ0FBaEI7QUFPSDs7QUF2RXVDLENBQTVDO0FBeUVBdkQsZUFBZSxHQUFHaEQsVUFBVSxDQUFDLENBQ3pCc0MsV0FBVyxDQUFDcUUsVUFBWixFQUR5QixFQUV6QjNGLE9BQU8sQ0FBQyxDQUFELEVBQUlzQixXQUFXLENBQUNzRSxNQUFaLENBQW1CbEUsT0FBTyxDQUFDbUUsaUJBQTNCLENBQUosQ0FGa0IsQ0FBRCxFQUd6QjdELGVBSHlCLENBQTVCO0FBSUFYLE9BQU8sQ0FBQ1csZUFBUixHQUEwQkEsZUFBMUIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxudmFyIF9fZGVjb3JhdGUgPSAodGhpcyAmJiB0aGlzLl9fZGVjb3JhdGUpIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcbiAgICBlbHNlIGZvciAodmFyIGkgPSBkZWNvcmF0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBpZiAoZCA9IGRlY29yYXRvcnNbaV0pIHIgPSAoYyA8IDMgPyBkKHIpIDogYyA+IDMgPyBkKHRhcmdldCwga2V5LCByKSA6IGQodGFyZ2V0LCBrZXkpKSB8fCByO1xuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XG59O1xudmFyIF9fcGFyYW0gPSAodGhpcyAmJiB0aGlzLl9fcGFyYW0pIHx8IGZ1bmN0aW9uIChwYXJhbUluZGV4LCBkZWNvcmF0b3IpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7IGRlY29yYXRvcih0YXJnZXQsIGtleSwgcGFyYW1JbmRleCk7IH1cbn07XG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xuICAgIH0pO1xufTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbmNvbnN0IGludmVyc2lmeV8xID0gcmVxdWlyZShcImludmVyc2lmeVwiKTtcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcbnJlcXVpcmUoXCIuLi8uLi9jb21tb24vZXh0ZW5zaW9uc1wiKTtcbmNvbnN0IGNvbnRyYWN0c18xID0gcmVxdWlyZShcIi4uLy4uL2ludGVycHJldGVyL2NvbnRyYWN0c1wiKTtcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vLi4vaW9jL3R5cGVzXCIpO1xuY29uc3QgdGVsZW1ldHJ5XzEgPSByZXF1aXJlKFwiLi4vLi4vdGVsZW1ldHJ5XCIpO1xuY29uc3QgY29uc3RhbnRzXzEgPSByZXF1aXJlKFwiLi4vLi4vdGVsZW1ldHJ5L2NvbnN0YW50c1wiKTtcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vYXBwbGljYXRpb24vdHlwZXNcIik7XG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4uL3R5cGVzXCIpO1xuY29uc3QgdHlwZXNfNCA9IHJlcXVpcmUoXCIuL3R5cGVzXCIpO1xubGV0IFRlcm1pbmFsU2VydmljZSA9IGNsYXNzIFRlcm1pbmFsU2VydmljZSB7XG4gICAgY29uc3RydWN0b3Ioc2VydmljZUNvbnRhaW5lciwgcmVzb3VyY2UsIHRpdGxlID0gJ1B5dGhvbicpIHtcbiAgICAgICAgdGhpcy5zZXJ2aWNlQ29udGFpbmVyID0gc2VydmljZUNvbnRhaW5lcjtcbiAgICAgICAgdGhpcy5yZXNvdXJjZSA9IHJlc291cmNlO1xuICAgICAgICB0aGlzLnRpdGxlID0gdGl0bGU7XG4gICAgICAgIHRoaXMudGVybWluYWxDbG9zZWQgPSBuZXcgdnNjb2RlXzEuRXZlbnRFbWl0dGVyKCk7XG4gICAgICAgIGNvbnN0IGRpc3Bvc2FibGVSZWdpc3RyeSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMy5JRGlzcG9zYWJsZVJlZ2lzdHJ5KTtcbiAgICAgICAgZGlzcG9zYWJsZVJlZ2lzdHJ5LnB1c2godGhpcyk7XG4gICAgICAgIHRoaXMudGVybWluYWxIZWxwZXIgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzQuSVRlcm1pbmFsSGVscGVyKTtcbiAgICAgICAgdGhpcy50ZXJtaW5hbE1hbmFnZXIgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzIuSVRlcm1pbmFsTWFuYWdlcik7XG4gICAgICAgIHRoaXMudGVybWluYWxNYW5hZ2VyLm9uRGlkQ2xvc2VUZXJtaW5hbCh0aGlzLnRlcm1pbmFsQ2xvc2VIYW5kbGVyLCB0aGlzLCBkaXNwb3NhYmxlUmVnaXN0cnkpO1xuICAgICAgICB0aGlzLnRlcm1pbmFsQWN0aXZhdG9yID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc180LklUZXJtaW5hbEFjdGl2YXRvcik7XG4gICAgfVxuICAgIGdldCBvbkRpZENsb3NlVGVybWluYWwoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnRlcm1pbmFsQ2xvc2VkLmV2ZW50LmJpbmQodGhpcy50ZXJtaW5hbENsb3NlZCk7XG4gICAgfVxuICAgIGRpc3Bvc2UoKSB7XG4gICAgICAgIGlmICh0aGlzLnRlcm1pbmFsKSB7XG4gICAgICAgICAgICB0aGlzLnRlcm1pbmFsLmRpc3Bvc2UoKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBzZW5kQ29tbWFuZChjb21tYW5kLCBhcmdzKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICB5aWVsZCB0aGlzLmVuc3VyZVRlcm1pbmFsKCk7XG4gICAgICAgICAgICBjb25zdCB0ZXh0ID0gdGhpcy50ZXJtaW5hbEhlbHBlci5idWlsZENvbW1hbmRGb3JUZXJtaW5hbCh0aGlzLnRlcm1pbmFsU2hlbGxUeXBlLCBjb21tYW5kLCBhcmdzKTtcbiAgICAgICAgICAgIHRoaXMudGVybWluYWwuc2hvdyh0cnVlKTtcbiAgICAgICAgICAgIHRoaXMudGVybWluYWwuc2VuZFRleHQodGV4dCwgdHJ1ZSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBzZW5kVGV4dCh0ZXh0KSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICB5aWVsZCB0aGlzLmVuc3VyZVRlcm1pbmFsKCk7XG4gICAgICAgICAgICB0aGlzLnRlcm1pbmFsLnNob3codHJ1ZSk7XG4gICAgICAgICAgICB0aGlzLnRlcm1pbmFsLnNlbmRUZXh0KHRleHQpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgc2hvdyhwcmVzZXJ2ZUZvY3VzID0gdHJ1ZSkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgeWllbGQgdGhpcy5lbnN1cmVUZXJtaW5hbChwcmVzZXJ2ZUZvY3VzKTtcbiAgICAgICAgICAgIHRoaXMudGVybWluYWwuc2hvdyhwcmVzZXJ2ZUZvY3VzKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGVuc3VyZVRlcm1pbmFsKHByZXNlcnZlRm9jdXMgPSB0cnVlKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBpZiAodGhpcy50ZXJtaW5hbCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHNoZWxsUGF0aCA9IHRoaXMudGVybWluYWxIZWxwZXIuZ2V0VGVybWluYWxTaGVsbFBhdGgoKTtcbiAgICAgICAgICAgIHRoaXMudGVybWluYWxTaGVsbFR5cGUgPSAhc2hlbGxQYXRoIHx8IHNoZWxsUGF0aC5sZW5ndGggPT09IDAgPyB0eXBlc180LlRlcm1pbmFsU2hlbGxUeXBlLm90aGVyIDogdGhpcy50ZXJtaW5hbEhlbHBlci5pZGVudGlmeVRlcm1pbmFsU2hlbGwoc2hlbGxQYXRoKTtcbiAgICAgICAgICAgIHRoaXMudGVybWluYWwgPSB0aGlzLnRlcm1pbmFsTWFuYWdlci5jcmVhdGVUZXJtaW5hbCh7IG5hbWU6IHRoaXMudGl0bGUgfSk7XG4gICAgICAgICAgICAvLyBTb21ldGltZXMgdGhlIHRlcm1pbmFsIHRha2VzIHNvbWUgdGltZSB0byBzdGFydCB1cCBiZWZvcmUgaXQgY2FuIHN0YXJ0IGFjY2VwdGluZyBpbnB1dC5cbiAgICAgICAgICAgIHlpZWxkIG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxMDApKTtcbiAgICAgICAgICAgIHlpZWxkIHRoaXMudGVybWluYWxBY3RpdmF0b3IuYWN0aXZhdGVFbnZpcm9ubWVudEluVGVybWluYWwodGhpcy50ZXJtaW5hbCwgdGhpcy5yZXNvdXJjZSwgcHJlc2VydmVGb2N1cyk7XG4gICAgICAgICAgICB0aGlzLnRlcm1pbmFsLnNob3cocHJlc2VydmVGb2N1cyk7XG4gICAgICAgICAgICB0aGlzLnNlbmRUZWxlbWV0cnkoKS5pZ25vcmVFcnJvcnMoKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHRlcm1pbmFsQ2xvc2VIYW5kbGVyKHRlcm1pbmFsKSB7XG4gICAgICAgIGlmICh0ZXJtaW5hbCA9PT0gdGhpcy50ZXJtaW5hbCkge1xuICAgICAgICAgICAgdGhpcy50ZXJtaW5hbENsb3NlZC5maXJlKCk7XG4gICAgICAgICAgICB0aGlzLnRlcm1pbmFsID0gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgfVxuICAgIHNlbmRUZWxlbWV0cnkoKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBweXRob25QYXRoID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18zLklDb25maWd1cmF0aW9uU2VydmljZSkuZ2V0U2V0dGluZ3ModGhpcy5yZXNvdXJjZSkucHl0aG9uUGF0aDtcbiAgICAgICAgICAgIGNvbnN0IGludGVycHJldGVySW5mbyA9IHlpZWxkIHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQoY29udHJhY3RzXzEuSUludGVycHJldGVyU2VydmljZSkuZ2V0SW50ZXJwcmV0ZXJEZXRhaWxzKHB5dGhvblBhdGgpO1xuICAgICAgICAgICAgY29uc3QgcHl0aG9uVmVyc2lvbiA9IChpbnRlcnByZXRlckluZm8gJiYgaW50ZXJwcmV0ZXJJbmZvLnZlcnNpb25faW5mbykgPyBpbnRlcnByZXRlckluZm8udmVyc2lvbl9pbmZvLmpvaW4oJy4nKSA6IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIGNvbnN0IGludGVycHJldGVyVHlwZSA9IGludGVycHJldGVySW5mbyA/IGludGVycHJldGVySW5mby50eXBlIDogdW5kZWZpbmVkO1xuICAgICAgICAgICAgdGVsZW1ldHJ5XzEuY2FwdHVyZVRlbGVtZXRyeShjb25zdGFudHNfMS5URVJNSU5BTF9DUkVBVEUsIHsgdGVybWluYWw6IHRoaXMudGVybWluYWxTaGVsbFR5cGUsIHB5dGhvblZlcnNpb24sIGludGVycHJldGVyVHlwZSB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxufTtcblRlcm1pbmFsU2VydmljZSA9IF9fZGVjb3JhdGUoW1xuICAgIGludmVyc2lmeV8xLmluamVjdGFibGUoKSxcbiAgICBfX3BhcmFtKDAsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18xLklTZXJ2aWNlQ29udGFpbmVyKSlcbl0sIFRlcm1pbmFsU2VydmljZSk7XG5leHBvcnRzLlRlcm1pbmFsU2VydmljZSA9IFRlcm1pbmFsU2VydmljZTtcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPXNlcnZpY2UuanMubWFwIl19