// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const path = require("path");

const contracts_1 = require("../../../interpreter/contracts");

require("../../extensions");

const types_1 = require("../../platform/types");

const types_2 = require("../../types");

const types_3 = require("../types");
/**
 * Support conda env activation (in the terminal).
 */


let CondaActivationCommandProvider = class CondaActivationCommandProvider {
  constructor(serviceContainer) {
    this.serviceContainer = serviceContainer;
  }
  /**
   * Is the given shell supported for activating a conda env?
   */


  isShellSupported(_targetShell) {
    return true;
  }
  /**
   * Return the command needed to activate the conda env.
   */


  getActivationCommands(resource, targetShell) {
    return __awaiter(this, void 0, void 0, function* () {
      const condaService = this.serviceContainer.get(contracts_1.ICondaService);
      const pythonPath = this.serviceContainer.get(types_2.IConfigurationService).getSettings(resource).pythonPath;
      const envInfo = yield condaService.getCondaEnvironment(pythonPath);

      if (!envInfo) {
        return;
      }

      if (this.serviceContainer.get(types_1.IPlatformService).isWindows) {
        // windows activate can be a bit tricky due to conda changes.
        switch (targetShell) {
          case types_3.TerminalShellType.powershell:
          case types_3.TerminalShellType.powershellCore:
            return this.getPowershellCommands(envInfo.name, targetShell);
          // tslint:disable-next-line:no-suspicious-comment
          // TODO: Do we really special-case fish on Windows?

          case types_3.TerminalShellType.fish:
            return this.getFishCommands(envInfo.name, yield condaService.getCondaFile());

          default:
            return this.getWindowsCommands(envInfo.name);
        }
      } else {
        switch (targetShell) {
          case types_3.TerminalShellType.powershell:
          case types_3.TerminalShellType.powershellCore:
            return;
          // tslint:disable-next-line:no-suspicious-comment
          // TODO: What about pre-4.4.0?

          case types_3.TerminalShellType.fish:
            return this.getFishCommands(envInfo.name, yield condaService.getCondaFile());

          default:
            return this.getUnixCommands(envInfo.name, yield condaService.getCondaFile());
        }
      }
    });
  }

  getWindowsActivateCommand() {
    return __awaiter(this, void 0, void 0, function* () {
      let activateCmd = 'activate';
      const condaService = this.serviceContainer.get(contracts_1.ICondaService);
      const condaExePath = yield condaService.getCondaFile();

      if (condaExePath && path.basename(condaExePath) !== condaExePath) {
        const condaScriptsPath = path.dirname(condaExePath); // prefix the cmd with the found path, and ensure it's quoted properly

        activateCmd = path.join(condaScriptsPath, activateCmd);
        activateCmd = activateCmd.toCommandArgument();
      }

      return activateCmd;
    });
  }

  getWindowsCommands(envName) {
    return __awaiter(this, void 0, void 0, function* () {
      const activate = yield this.getWindowsActivateCommand();
      return [`${activate} ${envName.toCommandArgument()}`];
    });
  }

  getPowershellCommands(envName, targetShell) {
    return __awaiter(this, void 0, void 0, function* () {
      return;
    });
  }

  getFishCommands(envName, conda) {
    return __awaiter(this, void 0, void 0, function* () {
      // https://github.com/conda/conda/blob/be8c08c083f4d5e05b06bd2689d2cd0d410c2ffe/shell/etc/fish/conf.d/conda.fish#L18-L28
      return [`${conda.fileToCommandArgument()} activate ${envName.toCommandArgument()}`];
    });
  }

  getUnixCommands(envName, conda) {
    return __awaiter(this, void 0, void 0, function* () {
      const condaDir = path.dirname(conda);
      const activateFile = path.join(condaDir, 'activate');
      return [`source ${activateFile.fileToCommandArgument()} ${envName.toCommandArgument()}`];
    });
  }

};
CondaActivationCommandProvider = __decorate([inversify_1.injectable()], CondaActivationCommandProvider);
exports.CondaActivationCommandProvider = CondaActivationCommandProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbmRhQWN0aXZhdGlvblByb3ZpZGVyLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJleHBvcnRzIiwiaW52ZXJzaWZ5XzEiLCJyZXF1aXJlIiwicGF0aCIsImNvbnRyYWN0c18xIiwidHlwZXNfMSIsInR5cGVzXzIiLCJ0eXBlc18zIiwiQ29uZGFBY3RpdmF0aW9uQ29tbWFuZFByb3ZpZGVyIiwiY29uc3RydWN0b3IiLCJzZXJ2aWNlQ29udGFpbmVyIiwiaXNTaGVsbFN1cHBvcnRlZCIsIl90YXJnZXRTaGVsbCIsImdldEFjdGl2YXRpb25Db21tYW5kcyIsInJlc291cmNlIiwidGFyZ2V0U2hlbGwiLCJjb25kYVNlcnZpY2UiLCJnZXQiLCJJQ29uZGFTZXJ2aWNlIiwicHl0aG9uUGF0aCIsIklDb25maWd1cmF0aW9uU2VydmljZSIsImdldFNldHRpbmdzIiwiZW52SW5mbyIsImdldENvbmRhRW52aXJvbm1lbnQiLCJJUGxhdGZvcm1TZXJ2aWNlIiwiaXNXaW5kb3dzIiwiVGVybWluYWxTaGVsbFR5cGUiLCJwb3dlcnNoZWxsIiwicG93ZXJzaGVsbENvcmUiLCJnZXRQb3dlcnNoZWxsQ29tbWFuZHMiLCJuYW1lIiwiZmlzaCIsImdldEZpc2hDb21tYW5kcyIsImdldENvbmRhRmlsZSIsImdldFdpbmRvd3NDb21tYW5kcyIsImdldFVuaXhDb21tYW5kcyIsImdldFdpbmRvd3NBY3RpdmF0ZUNvbW1hbmQiLCJhY3RpdmF0ZUNtZCIsImNvbmRhRXhlUGF0aCIsImJhc2VuYW1lIiwiY29uZGFTY3JpcHRzUGF0aCIsImRpcm5hbWUiLCJqb2luIiwidG9Db21tYW5kQXJndW1lbnQiLCJlbnZOYW1lIiwiYWN0aXZhdGUiLCJjb25kYSIsImZpbGVUb0NvbW1hbmRBcmd1bWVudCIsImNvbmRhRGlyIiwiYWN0aXZhdGVGaWxlIiwiaW5qZWN0YWJsZSJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBOztBQUNBLElBQUlBLFVBQVUsR0FBSSxVQUFRLFNBQUtBLFVBQWQsSUFBNkIsVUFBVUMsVUFBVixFQUFzQkMsTUFBdEIsRUFBOEJDLEdBQTlCLEVBQW1DQyxJQUFuQyxFQUF5QztBQUNuRixNQUFJQyxDQUFDLEdBQUdDLFNBQVMsQ0FBQ0MsTUFBbEI7QUFBQSxNQUEwQkMsQ0FBQyxHQUFHSCxDQUFDLEdBQUcsQ0FBSixHQUFRSCxNQUFSLEdBQWlCRSxJQUFJLEtBQUssSUFBVCxHQUFnQkEsSUFBSSxHQUFHSyxNQUFNLENBQUNDLHdCQUFQLENBQWdDUixNQUFoQyxFQUF3Q0MsR0FBeEMsQ0FBdkIsR0FBc0VDLElBQXJIO0FBQUEsTUFBMkhPLENBQTNIO0FBQ0EsTUFBSSxPQUFPQyxPQUFQLEtBQW1CLFFBQW5CLElBQStCLE9BQU9BLE9BQU8sQ0FBQ0MsUUFBZixLQUE0QixVQUEvRCxFQUEyRUwsQ0FBQyxHQUFHSSxPQUFPLENBQUNDLFFBQVIsQ0FBaUJaLFVBQWpCLEVBQTZCQyxNQUE3QixFQUFxQ0MsR0FBckMsRUFBMENDLElBQTFDLENBQUosQ0FBM0UsS0FDSyxLQUFLLElBQUlVLENBQUMsR0FBR2IsVUFBVSxDQUFDTSxNQUFYLEdBQW9CLENBQWpDLEVBQW9DTyxDQUFDLElBQUksQ0FBekMsRUFBNENBLENBQUMsRUFBN0MsRUFBaUQsSUFBSUgsQ0FBQyxHQUFHVixVQUFVLENBQUNhLENBQUQsQ0FBbEIsRUFBdUJOLENB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VixFQUFvQixVQUFwQixDQUFyQjtBQUNBLGFBQU8sQ0FDRixVQUFTQyxZQUFZLENBQUNGLHFCQUFiLEVBQXFDLElBQUdILE9BQU8sQ0FBQ0QsaUJBQVIsRUFBNEIsRUFEM0UsQ0FBUDtBQUdILEtBTmUsQ0FBaEI7QUFPSDs7QUE5RnFFLENBQTFFO0FBZ0dBbkMsOEJBQThCLEdBQUcxQyxVQUFVLENBQUMsQ0FDeENtQyxXQUFXLENBQUNpRCxVQUFaLEVBRHdDLENBQUQsRUFFeEMxQyw4QkFGd0MsQ0FBM0M7QUFHQVIsT0FBTyxDQUFDUSw4QkFBUixHQUF5Q0EsOEJBQXpDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXG4ndXNlIHN0cmljdCc7XG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XG4gICAgdmFyIGMgPSBhcmd1bWVudHMubGVuZ3RoLCByID0gYyA8IDMgPyB0YXJnZXQgOiBkZXNjID09PSBudWxsID8gZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpIDogZGVzYywgZDtcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XG4gICAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjtcbn07XG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xuICAgIH0pO1xufTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbmNvbnN0IGludmVyc2lmeV8xID0gcmVxdWlyZShcImludmVyc2lmeVwiKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcbmNvbnN0IGNvbnRyYWN0c18xID0gcmVxdWlyZShcIi4uLy4uLy4uL2ludGVycHJldGVyL2NvbnRyYWN0c1wiKTtcbnJlcXVpcmUoXCIuLi8uLi9leHRlbnNpb25zXCIpO1xuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi8uLi9wbGF0Zm9ybS90eXBlc1wiKTtcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vLi4vdHlwZXNcIik7XG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4uL3R5cGVzXCIpO1xuLyoqXG4gKiBTdXBwb3J0IGNvbmRhIGVudiBhY3RpdmF0aW9uIChpbiB0aGUgdGVybWluYWwpLlxuICovXG5sZXQgQ29uZGFBY3RpdmF0aW9uQ29tbWFuZFByb3ZpZGVyID0gY2xhc3MgQ29uZGFBY3RpdmF0aW9uQ29tbWFuZFByb3ZpZGVyIHtcbiAgICBjb25zdHJ1Y3RvcihzZXJ2aWNlQ29udGFpbmVyKSB7XG4gICAgICAgIHRoaXMuc2VydmljZUNvbnRhaW5lciA9IHNlcnZpY2VDb250YWluZXI7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIElzIHRoZSBnaXZlbiBzaGVsbCBzdXBwb3J0ZWQgZm9yIGFjdGl2YXRpbmcgYSBjb25kYSBlbnY/XG4gICAgICovXG4gICAgaXNTaGVsbFN1cHBvcnRlZChfdGFyZ2V0U2hlbGwpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIFJldHVybiB0aGUgY29tbWFuZCBuZWVkZWQgdG8gYWN0aXZhdGUgdGhlIGNvbmRhIGVudi5cbiAgICAgKi9cbiAgICBnZXRBY3RpdmF0aW9uQ29tbWFuZHMocmVzb3VyY2UsIHRhcmdldFNoZWxsKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBjb25kYVNlcnZpY2UgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KGNvbnRyYWN0c18xLklDb25kYVNlcnZpY2UpO1xuICAgICAgICAgICAgY29uc3QgcHl0aG9uUGF0aCA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMi5JQ29uZmlndXJhdGlvblNlcnZpY2UpXG4gICAgICAgICAgICAgICAgLmdldFNldHRpbmdzKHJlc291cmNlKS5weXRob25QYXRoO1xuICAgICAgICAgICAgY29uc3QgZW52SW5mbyA9IHlpZWxkIGNvbmRhU2VydmljZS5nZXRDb25kYUVudmlyb25tZW50KHB5dGhvblBhdGgpO1xuICAgICAgICAgICAgaWYgKCFlbnZJbmZvKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JUGxhdGZvcm1TZXJ2aWNlKS5pc1dpbmRvd3MpIHtcbiAgICAgICAgICAgICAgICAvLyB3aW5kb3dzIGFjdGl2YXRlIGNhbiBiZSBhIGJpdCB0cmlja3kgZHVlIHRvIGNvbmRhIGNoYW5nZXMuXG4gICAgICAgICAgICAgICAgc3dpdGNoICh0YXJnZXRTaGVsbCkge1xuICAgICAgICAgICAgICAgICAgICBjYXNlIHR5cGVzXzMuVGVybWluYWxTaGVsbFR5cGUucG93ZXJzaGVsbDpcbiAgICAgICAgICAgICAgICAgICAgY2FzZSB0eXBlc18zLlRlcm1pbmFsU2hlbGxUeXBlLnBvd2Vyc2hlbGxDb3JlOlxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UG93ZXJzaGVsbENvbW1hbmRzKGVudkluZm8ubmFtZSwgdGFyZ2V0U2hlbGwpO1xuICAgICAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tc3VzcGljaW91cy1jb21tZW50XG4gICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERvIHdlIHJlYWxseSBzcGVjaWFsLWNhc2UgZmlzaCBvbiBXaW5kb3dzP1xuICAgICAgICAgICAgICAgICAgICBjYXNlIHR5cGVzXzMuVGVybWluYWxTaGVsbFR5cGUuZmlzaDpcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldEZpc2hDb21tYW5kcyhlbnZJbmZvLm5hbWUsIHlpZWxkIGNvbmRhU2VydmljZS5nZXRDb25kYUZpbGUoKSk7XG4gICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRXaW5kb3dzQ29tbWFuZHMoZW52SW5mby5uYW1lKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKHRhcmdldFNoZWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgdHlwZXNfMy5UZXJtaW5hbFNoZWxsVHlwZS5wb3dlcnNoZWxsOlxuICAgICAgICAgICAgICAgICAgICBjYXNlIHR5cGVzXzMuVGVybWluYWxTaGVsbFR5cGUucG93ZXJzaGVsbENvcmU6XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1zdXNwaWNpb3VzLWNvbW1lbnRcbiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogV2hhdCBhYm91dCBwcmUtNC40LjA/XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgdHlwZXNfMy5UZXJtaW5hbFNoZWxsVHlwZS5maXNoOlxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RmlzaENvbW1hbmRzKGVudkluZm8ubmFtZSwgeWllbGQgY29uZGFTZXJ2aWNlLmdldENvbmRhRmlsZSgpKTtcbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFVuaXhDb21tYW5kcyhlbnZJbmZvLm5hbWUsIHlpZWxkIGNvbmRhU2VydmljZS5nZXRDb25kYUZpbGUoKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgZ2V0V2luZG93c0FjdGl2YXRlQ29tbWFuZCgpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGxldCBhY3RpdmF0ZUNtZCA9ICdhY3RpdmF0ZSc7XG4gICAgICAgICAgICBjb25zdCBjb25kYVNlcnZpY2UgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KGNvbnRyYWN0c18xLklDb25kYVNlcnZpY2UpO1xuICAgICAgICAgICAgY29uc3QgY29uZGFFeGVQYXRoID0geWllbGQgY29uZGFTZXJ2aWNlLmdldENvbmRhRmlsZSgpO1xuICAgICAgICAgICAgaWYgKGNvbmRhRXhlUGF0aCAmJiBwYXRoLmJhc2VuYW1lKGNvbmRhRXhlUGF0aCkgIT09IGNvbmRhRXhlUGF0aCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNvbmRhU2NyaXB0c1BhdGggPSBwYXRoLmRpcm5hbWUoY29uZGFFeGVQYXRoKTtcbiAgICAgICAgICAgICAgICAvLyBwcmVmaXggdGhlIGNtZCB3aXRoIHRoZSBmb3VuZCBwYXRoLCBhbmQgZW5zdXJlIGl0J3MgcXVvdGVkIHByb3Blcmx5XG4gICAgICAgICAgICAgICAgYWN0aXZhdGVDbWQgPSBwYXRoLmpvaW4oY29uZGFTY3JpcHRzUGF0aCwgYWN0aXZhdGVDbWQpO1xuICAgICAgICAgICAgICAgIGFjdGl2YXRlQ21kID0gYWN0aXZhdGVDbWQudG9Db21tYW5kQXJndW1lbnQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBhY3RpdmF0ZUNtZDtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGdldFdpbmRvd3NDb21tYW5kcyhlbnZOYW1lKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBhY3RpdmF0ZSA9IHlpZWxkIHRoaXMuZ2V0V2luZG93c0FjdGl2YXRlQ29tbWFuZCgpO1xuICAgICAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAgICAgICBgJHthY3RpdmF0ZX0gJHtlbnZOYW1lLnRvQ29tbWFuZEFyZ3VtZW50KCl9YFxuICAgICAgICAgICAgXTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGdldFBvd2Vyc2hlbGxDb21tYW5kcyhlbnZOYW1lLCB0YXJnZXRTaGVsbCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgZ2V0RmlzaENvbW1hbmRzKGVudk5hbWUsIGNvbmRhKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vY29uZGEvY29uZGEvYmxvYi9iZThjMDhjMDgzZjRkNWUwNWIwNmJkMjY4OWQyY2QwZDQxMGMyZmZlL3NoZWxsL2V0Yy9maXNoL2NvbmYuZC9jb25kYS5maXNoI0wxOC1MMjhcbiAgICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAgICAgYCR7Y29uZGEuZmlsZVRvQ29tbWFuZEFyZ3VtZW50KCl9IGFjdGl2YXRlICR7ZW52TmFtZS50b0NvbW1hbmRBcmd1bWVudCgpfWBcbiAgICAgICAgICAgIF07XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBnZXRVbml4Q29tbWFuZHMoZW52TmFtZSwgY29uZGEpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IGNvbmRhRGlyID0gcGF0aC5kaXJuYW1lKGNvbmRhKTtcbiAgICAgICAgICAgIGNvbnN0IGFjdGl2YXRlRmlsZSA9IHBhdGguam9pbihjb25kYURpciwgJ2FjdGl2YXRlJyk7XG4gICAgICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgICAgIGBzb3VyY2UgJHthY3RpdmF0ZUZpbGUuZmlsZVRvQ29tbWFuZEFyZ3VtZW50KCl9ICR7ZW52TmFtZS50b0NvbW1hbmRBcmd1bWVudCgpfWBcbiAgICAgICAgICAgIF07XG4gICAgICAgIH0pO1xuICAgIH1cbn07XG5Db25kYUFjdGl2YXRpb25Db21tYW5kUHJvdmlkZXIgPSBfX2RlY29yYXRlKFtcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKClcbl0sIENvbmRhQWN0aXZhdGlvbkNvbW1hbmRQcm92aWRlcik7XG5leHBvcnRzLkNvbmRhQWN0aXZhdGlvbkNvbW1hbmRQcm92aWRlciA9IENvbmRhQWN0aXZhdGlvbkNvbW1hbmRQcm92aWRlcjtcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWNvbmRhQWN0aXZhdGlvblByb3ZpZGVyLmpzLm1hcCJdfQ==