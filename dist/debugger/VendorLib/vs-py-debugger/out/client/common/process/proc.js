"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

Object.defineProperty(exports, "__esModule", {
  value: true
}); // tslint:disable:no-any

const child_process_1 = require("child_process");

const Observable_1 = require("rxjs/Observable");

const async_1 = require("../utils/async");

const constants_1 = require("./constants");

const types_1 = require("./types");

class ProcessService {
  constructor(decoder, env) {
    this.decoder = decoder;
    this.env = env;
  }

  static isAlive(pid) {
    try {
      process.kill(pid, 0);
      return true;
    } catch (_a) {
      return false;
    }
  }

  static kill(pid) {
    // tslint:disable-next-line:no-require-imports
    const killProcessTree = require('tree-kill');

    try {
      killProcessTree(pid);
    } catch (_a) {// Ignore.
    }
  }

  execObservable(file, args, options = {}) {
    const encoding = options.encoding = typeof options.encoding === 'string' && options.encoding.length > 0 ? options.encoding : constants_1.DEFAULT_ENCODING;
    delete options.encoding;
    const spawnOptions = Object.assign({}, options);

    if (!spawnOptions.env || Object.keys(spawnOptions).length === 0) {
      const env = this.env ? this.env : process.env;
      spawnOptions.env = Object.assign({}, env);
    } // Always ensure we have unbuffered output.


    spawnOptions.env.PYTHONUNBUFFERED = '1';

    if (!spawnOptions.env.PYTHONIOENCODING) {
      spawnOptions.env.PYTHONIOENCODING = 'utf-8';
    }

    const proc = child_process_1.spawn(file, args, spawnOptions);
    let procExited = false;
    const output = new Observable_1.Observable(subscriber => {
      const disposables = [];

      const on = (ee, name, fn) => {
        ee.on(name, fn);
        disposables.push({
          dispose: () => ee.removeListener(name, fn)
        });
      };

      if (options.token) {
        disposables.push(options.token.onCancellationRequested(() => {
          if (!procExited && !proc.killed) {
            proc.kill();
            procExited = true;
          }
        }));
      }

      const sendOutput = (source, data) => {
        const out = this.decoder.decode([data], encoding);

        if (source === 'stderr' && options.throwOnStdErr) {
          subscriber.error(new types_1.StdErrError(out));
        } else {
          subscriber.next({
            source,
            out: out
          });
        }
      };

      on(proc.stdout, 'data', data => sendOutput('stdout', data));
      on(proc.stderr, 'data', data => sendOutput('stderr', data));
      proc.once('close', () => {
        procExited = true;
        subscriber.complete();
        disposables.forEach(disposable => disposable.dispose());
      });
      proc.once('error', ex => {
        procExited = true;
        subscriber.error(ex);
        disposables.forEach(disposable => disposable.dispose());
      });
    });
    return {
      proc,
      out: output
    };
  }

  exec(file, args, options = {}) {
    const encoding = options.encoding = typeof options.encoding === 'string' && options.encoding.length > 0 ? options.encoding : constants_1.DEFAULT_ENCODING;
    delete options.encoding;
    const spawnOptions = Object.assign({}, options);

    if (!spawnOptions.env || Object.keys(spawnOptions).length === 0) {
      const env = this.env ? this.env : process.env;
      spawnOptions.env = Object.assign({}, env);
    } // Always ensure we have unbuffered output.


    spawnOptions.env.PYTHONUNBUFFERED = '1';

    if (!spawnOptions.env.PYTHONIOENCODING) {
      spawnOptions.env.PYTHONIOENCODING = 'utf-8';
    }

    const proc = child_process_1.spawn(file, args, spawnOptions);
    const deferred = async_1.createDeferred();
    const disposables = [];

    const on = (ee, name, fn) => {
      ee.on(name, fn);
      disposables.push({
        dispose: () => ee.removeListener(name, fn)
      });
    };

    if (options.token) {
      disposables.push(options.token.onCancellationRequested(() => {
        if (!proc.killed && !deferred.completed) {
          proc.kill();
        }
      }));
    }

    const stdoutBuffers = [];
    on(proc.stdout, 'data', data => stdoutBuffers.push(data));
    const stderrBuffers = [];
    on(proc.stderr, 'data', data => {
      if (options.mergeStdOutErr) {
        stdoutBuffers.push(data);
        stderrBuffers.push(data);
      } else {
        stderrBuffers.push(data);
      }
    });
    proc.once('close', () => {
      if (deferred.completed) {
        return;
      }

      const stderr = stderrBuffers.length === 0 ? undefined : this.decoder.decode(stderrBuffers, encoding);

      if (stderr && stderr.length > 0 && options.throwOnStdErr) {
        deferred.reject(new types_1.StdErrError(stderr));
      } else {
        const stdout = this.decoder.decode(stdoutBuffers, encoding);
        deferred.resolve({
          stdout,
          stderr
        });
      }

      disposables.forEach(disposable => disposable.dispose());
    });
    proc.once('error', ex => {
      deferred.reject(ex);
      disposables.forEach(disposable => disposable.dispose());
    });
    return deferred.promise;
  }

}

exports.ProcessService = ProcessService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByb2MuanMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJjaGlsZF9wcm9jZXNzXzEiLCJyZXF1aXJlIiwiT2JzZXJ2YWJsZV8xIiwiYXN5bmNfMSIsImNvbnN0YW50c18xIiwidHlwZXNfMSIsIlByb2Nlc3NTZXJ2aWNlIiwiY29uc3RydWN0b3IiLCJkZWNvZGVyIiwiZW52IiwiaXNBbGl2ZSIsInBpZCIsInByb2Nlc3MiLCJraWxsIiwiX2EiLCJraWxsUHJvY2Vzc1RyZWUiLCJleGVjT2JzZXJ2YWJsZSIsImZpbGUiLCJhcmdzIiwib3B0aW9ucyIsImVuY29kaW5nIiwibGVuZ3RoIiwiREVGQVVMVF9FTkNPRElORyIsInNwYXduT3B0aW9ucyIsImFzc2lnbiIsImtleXMiLCJQWVRIT05VTkJVRkZFUkVEIiwiUFlUSE9OSU9FTkNPRElORyIsInByb2MiLCJzcGF3biIsInByb2NFeGl0ZWQiLCJvdXRwdXQiLCJPYnNlcnZhYmxlIiwic3Vic2NyaWJlciIsImRpc3Bvc2FibGVzIiwib24iLCJlZSIsIm5hbWUiLCJmbiIsInB1c2giLCJkaXNwb3NlIiwicmVtb3ZlTGlzdGVuZXIiLCJ0b2tlbiIsIm9uQ2FuY2VsbGF0aW9uUmVxdWVzdGVkIiwia2lsbGVkIiwic2VuZE91dHB1dCIsInNvdXJjZSIsImRhdGEiLCJvdXQiLCJkZWNvZGUiLCJ0aHJvd09uU3RkRXJyIiwiZXJyb3IiLCJTdGRFcnJFcnJvciIsIm5leHQiLCJzdGRvdXQiLCJzdGRlcnIiLCJvbmNlIiwiY29tcGxldGUiLCJmb3JFYWNoIiwiZGlzcG9zYWJsZSIsImV4IiwiZXhlYyIsImRlZmVycmVkIiwiY3JlYXRlRGVmZXJyZWQiLCJjb21wbGV0ZWQiLCJzdGRvdXRCdWZmZXJzIiwic3RkZXJyQnVmZmVycyIsIm1lcmdlU3RkT3V0RXJyIiwidW5kZWZpbmVkIiwicmVqZWN0IiwicmVzb2x2ZSIsInByb21pc2UiXSwibWFwcGluZ3MiOiJBQUFB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QUwsQ0FBYXlDLE1BQWIsQ0FBb0JpQixhQUFwQixFQUFtQzlDLFFBQW5DLENBQXhEOztBQUNBLFVBQUltQyxNQUFNLElBQUlBLE1BQU0sQ0FBQ2xDLE1BQVAsR0FBZ0IsQ0FBMUIsSUFBK0JGLE9BQU8sQ0FBQytCLGFBQTNDLEVBQTBEO0FBQ3REWSxRQUFBQSxRQUFRLENBQUNPLE1BQVQsQ0FBZ0IsSUFBSWhFLE9BQU8sQ0FBQytDLFdBQVosQ0FBd0JHLE1BQXhCLENBQWhCO0FBQ0gsT0FGRCxNQUdLO0FBQ0QsY0FBTUQsTUFBTSxHQUFHLEtBQUs5QyxPQUFMLENBQWF5QyxNQUFiLENBQW9CZ0IsYUFBcEIsRUFBbUM3QyxRQUFuQyxDQUFmO0FBQ0EwQyxRQUFBQSxRQUFRLENBQUNRLE9BQVQsQ0FBaUI7QUFBRWhCLFVBQUFBLE1BQUY7QUFBVUMsVUFBQUE7QUFBVixTQUFqQjtBQUNIOztBQUNEckIsTUFBQUEsV0FBVyxDQUFDd0IsT0FBWixDQUFvQkMsVUFBVSxJQUFJQSxVQUFVLENBQUNuQixPQUFYLEVBQWxDO0FBQ0gsS0FiRDtBQWNBWixJQUFBQSxJQUFJLENBQUM0QixJQUFMLENBQVUsT0FBVixFQUFtQkksRUFBRSxJQUFJO0FBQ3JCRSxNQUFBQSxRQUFRLENBQUNPLE1BQVQsQ0FBZ0JULEVBQWhCO0FBQ0ExQixNQUFBQSxXQUFXLENBQUN3QixPQUFaLENBQW9CQyxVQUFVLElBQUlBLFVBQVUsQ0FBQ25CLE9BQVgsRUFBbEM7QUFDSCxLQUhEO0FBSUEsV0FBT3NCLFFBQVEsQ0FBQ1MsT0FBaEI7QUFDSDs7QUF2SWdCOztBQXlJckJ6RSxPQUFPLENBQUNRLGNBQVIsR0FBeUJBLGNBQXpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG4vLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbi8vIHRzbGludDpkaXNhYmxlOm5vLWFueVxuY29uc3QgY2hpbGRfcHJvY2Vzc18xID0gcmVxdWlyZShcImNoaWxkX3Byb2Nlc3NcIik7XG5jb25zdCBPYnNlcnZhYmxlXzEgPSByZXF1aXJlKFwicnhqcy9PYnNlcnZhYmxlXCIpO1xuY29uc3QgYXN5bmNfMSA9IHJlcXVpcmUoXCIuLi91dGlscy9hc3luY1wiKTtcbmNvbnN0IGNvbnN0YW50c18xID0gcmVxdWlyZShcIi4vY29uc3RhbnRzXCIpO1xuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuL3R5cGVzXCIpO1xuY2xhc3MgUHJvY2Vzc1NlcnZpY2Uge1xuICAgIGNvbnN0cnVjdG9yKGRlY29kZXIsIGVudikge1xuICAgICAgICB0aGlzLmRlY29kZXIgPSBkZWNvZGVyO1xuICAgICAgICB0aGlzLmVudiA9IGVudjtcbiAgICB9XG4gICAgc3RhdGljIGlzQWxpdmUocGlkKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBwcm9jZXNzLmtpbGwocGlkLCAwKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChfYSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuICAgIHN0YXRpYyBraWxsKHBpZCkge1xuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tcmVxdWlyZS1pbXBvcnRzXG4gICAgICAgIGNvbnN0IGtpbGxQcm9jZXNzVHJlZSA9IHJlcXVpcmUoJ3RyZWUta2lsbCcpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAga2lsbFByb2Nlc3NUcmVlKHBpZCk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKF9hKSB7XG4gICAgICAgICAgICAvLyBJZ25vcmUuXG4gICAgICAgIH1cbiAgICB9XG4gICAgZXhlY09ic2VydmFibGUoZmlsZSwgYXJncywgb3B0aW9ucyA9IHt9KSB7XG4gICAgICAgIGNvbnN0IGVuY29kaW5nID0gb3B0aW9ucy5lbmNvZGluZyA9IHR5cGVvZiBvcHRpb25zLmVuY29kaW5nID09PSAnc3RyaW5nJyAmJiBvcHRpb25zLmVuY29kaW5nLmxlbmd0aCA+IDAgPyBvcHRpb25zLmVuY29kaW5nIDogY29uc3RhbnRzXzEuREVGQVVMVF9FTkNPRElORztcbiAgICAgICAgZGVsZXRlIG9wdGlvbnMuZW5jb2Rpbmc7XG4gICAgICAgIGNvbnN0IHNwYXduT3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMpO1xuICAgICAgICBpZiAoIXNwYXduT3B0aW9ucy5lbnYgfHwgT2JqZWN0LmtleXMoc3Bhd25PcHRpb25zKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIGNvbnN0IGVudiA9IHRoaXMuZW52ID8gdGhpcy5lbnYgOiBwcm9jZXNzLmVudjtcbiAgICAgICAgICAgIHNwYXduT3B0aW9ucy5lbnYgPSBPYmplY3QuYXNzaWduKHt9LCBlbnYpO1xuICAgICAgICB9XG4gICAgICAgIC8vIEFsd2F5cyBlbnN1cmUgd2UgaGF2ZSB1bmJ1ZmZlcmVkIG91dHB1dC5cbiAgICAgICAgc3Bhd25PcHRpb25zLmVudi5QWVRIT05VTkJVRkZFUkVEID0gJzEnO1xuICAgICAgICBpZiAoIXNwYXduT3B0aW9ucy5lbnYuUFlUSE9OSU9FTkNPRElORykge1xuICAgICAgICAgICAgc3Bhd25PcHRpb25zLmVudi5QWVRIT05JT0VOQ09ESU5HID0gJ3V0Zi04JztcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBwcm9jID0gY2hpbGRfcHJvY2Vzc18xLnNwYXduKGZpbGUsIGFyZ3MsIHNwYXduT3B0aW9ucyk7XG4gICAgICAgIGxldCBwcm9jRXhpdGVkID0gZmFsc2U7XG4gICAgICAgIGNvbnN0IG91dHB1dCA9IG5ldyBPYnNlcnZhYmxlXzEuT2JzZXJ2YWJsZShzdWJzY3JpYmVyID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGRpc3Bvc2FibGVzID0gW107XG4gICAgICAgICAgICBjb25zdCBvbiA9IChlZSwgbmFtZSwgZm4pID0+IHtcbiAgICAgICAgICAgICAgICBlZS5vbihuYW1lLCBmbik7XG4gICAgICAgICAgICAgICAgZGlzcG9zYWJsZXMucHVzaCh7IGRpc3Bvc2U6ICgpID0+IGVlLnJlbW92ZUxpc3RlbmVyKG5hbWUsIGZuKSB9KTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBpZiAob3B0aW9ucy50b2tlbikge1xuICAgICAgICAgICAgICAgIGRpc3Bvc2FibGVzLnB1c2gob3B0aW9ucy50b2tlbi5vbkNhbmNlbGxhdGlvblJlcXVlc3RlZCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghcHJvY0V4aXRlZCAmJiAhcHJvYy5raWxsZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Mua2lsbCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvY0V4aXRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBzZW5kT3V0cHV0ID0gKHNvdXJjZSwgZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IG91dCA9IHRoaXMuZGVjb2Rlci5kZWNvZGUoW2RhdGFdLCBlbmNvZGluZyk7XG4gICAgICAgICAgICAgICAgaWYgKHNvdXJjZSA9PT0gJ3N0ZGVycicgJiYgb3B0aW9ucy50aHJvd09uU3RkRXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHN1YnNjcmliZXIuZXJyb3IobmV3IHR5cGVzXzEuU3RkRXJyRXJyb3Iob3V0KSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzdWJzY3JpYmVyLm5leHQoeyBzb3VyY2UsIG91dDogb3V0IH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBvbihwcm9jLnN0ZG91dCwgJ2RhdGEnLCAoZGF0YSkgPT4gc2VuZE91dHB1dCgnc3Rkb3V0JywgZGF0YSkpO1xuICAgICAgICAgICAgb24ocHJvYy5zdGRlcnIsICdkYXRhJywgKGRhdGEpID0+IHNlbmRPdXRwdXQoJ3N0ZGVycicsIGRhdGEpKTtcbiAgICAgICAgICAgIHByb2Mub25jZSgnY2xvc2UnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgcHJvY0V4aXRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgc3Vic2NyaWJlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgIGRpc3Bvc2FibGVzLmZvckVhY2goZGlzcG9zYWJsZSA9PiBkaXNwb3NhYmxlLmRpc3Bvc2UoKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHByb2Mub25jZSgnZXJyb3InLCBleCA9PiB7XG4gICAgICAgICAgICAgICAgcHJvY0V4aXRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgc3Vic2NyaWJlci5lcnJvcihleCk7XG4gICAgICAgICAgICAgICAgZGlzcG9zYWJsZXMuZm9yRWFjaChkaXNwb3NhYmxlID0+IGRpc3Bvc2FibGUuZGlzcG9zZSgpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHsgcHJvYywgb3V0OiBvdXRwdXQgfTtcbiAgICB9XG4gICAgZXhlYyhmaWxlLCBhcmdzLCBvcHRpb25zID0ge30pIHtcbiAgICAgICAgY29uc3QgZW5jb2RpbmcgPSBvcHRpb25zLmVuY29kaW5nID0gdHlwZW9mIG9wdGlvbnMuZW5jb2RpbmcgPT09ICdzdHJpbmcnICYmIG9wdGlvbnMuZW5jb2RpbmcubGVuZ3RoID4gMCA/IG9wdGlvbnMuZW5jb2RpbmcgOiBjb25zdGFudHNfMS5ERUZBVUxUX0VOQ09ESU5HO1xuICAgICAgICBkZWxldGUgb3B0aW9ucy5lbmNvZGluZztcbiAgICAgICAgY29uc3Qgc3Bhd25PcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucyk7XG4gICAgICAgIGlmICghc3Bhd25PcHRpb25zLmVudiB8fCBPYmplY3Qua2V5cyhzcGF3bk9wdGlvbnMpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgY29uc3QgZW52ID0gdGhpcy5lbnYgPyB0aGlzLmVudiA6IHByb2Nlc3MuZW52O1xuICAgICAgICAgICAgc3Bhd25PcHRpb25zLmVudiA9IE9iamVjdC5hc3NpZ24oe30sIGVudik7XG4gICAgICAgIH1cbiAgICAgICAgLy8gQWx3YXlzIGVuc3VyZSB3ZSBoYXZlIHVuYnVmZmVyZWQgb3V0cHV0LlxuICAgICAgICBzcGF3bk9wdGlvbnMuZW52LlBZVEhPTlVOQlVGRkVSRUQgPSAnMSc7XG4gICAgICAgIGlmICghc3Bhd25PcHRpb25zLmVudi5QWVRIT05JT0VOQ09ESU5HKSB7XG4gICAgICAgICAgICBzcGF3bk9wdGlvbnMuZW52LlBZVEhPTklPRU5DT0RJTkcgPSAndXRmLTgnO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHByb2MgPSBjaGlsZF9wcm9jZXNzXzEuc3Bhd24oZmlsZSwgYXJncywgc3Bhd25PcHRpb25zKTtcbiAgICAgICAgY29uc3QgZGVmZXJyZWQgPSBhc3luY18xLmNyZWF0ZURlZmVycmVkKCk7XG4gICAgICAgIGNvbnN0IGRpc3Bvc2FibGVzID0gW107XG4gICAgICAgIGNvbnN0IG9uID0gKGVlLCBuYW1lLCBmbikgPT4ge1xuICAgICAgICAgICAgZWUub24obmFtZSwgZm4pO1xuICAgICAgICAgICAgZGlzcG9zYWJsZXMucHVzaCh7IGRpc3Bvc2U6ICgpID0+IGVlLnJlbW92ZUxpc3RlbmVyKG5hbWUsIGZuKSB9KTtcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKG9wdGlvbnMudG9rZW4pIHtcbiAgICAgICAgICAgIGRpc3Bvc2FibGVzLnB1c2gob3B0aW9ucy50b2tlbi5vbkNhbmNlbGxhdGlvblJlcXVlc3RlZCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFwcm9jLmtpbGxlZCAmJiAhZGVmZXJyZWQuY29tcGxldGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHByb2Mua2lsbCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzdGRvdXRCdWZmZXJzID0gW107XG4gICAgICAgIG9uKHByb2Muc3Rkb3V0LCAnZGF0YScsIChkYXRhKSA9PiBzdGRvdXRCdWZmZXJzLnB1c2goZGF0YSkpO1xuICAgICAgICBjb25zdCBzdGRlcnJCdWZmZXJzID0gW107XG4gICAgICAgIG9uKHByb2Muc3RkZXJyLCAnZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5tZXJnZVN0ZE91dEVycikge1xuICAgICAgICAgICAgICAgIHN0ZG91dEJ1ZmZlcnMucHVzaChkYXRhKTtcbiAgICAgICAgICAgICAgICBzdGRlcnJCdWZmZXJzLnB1c2goZGF0YSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBzdGRlcnJCdWZmZXJzLnB1c2goZGF0YSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBwcm9jLm9uY2UoJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgICAgICAgaWYgKGRlZmVycmVkLmNvbXBsZXRlZCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHN0ZGVyciA9IHN0ZGVyckJ1ZmZlcnMubGVuZ3RoID09PSAwID8gdW5kZWZpbmVkIDogdGhpcy5kZWNvZGVyLmRlY29kZShzdGRlcnJCdWZmZXJzLCBlbmNvZGluZyk7XG4gICAgICAgICAgICBpZiAoc3RkZXJyICYmIHN0ZGVyci5sZW5ndGggPiAwICYmIG9wdGlvbnMudGhyb3dPblN0ZEVycikge1xuICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChuZXcgdHlwZXNfMS5TdGRFcnJFcnJvcihzdGRlcnIpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IHN0ZG91dCA9IHRoaXMuZGVjb2Rlci5kZWNvZGUoc3Rkb3V0QnVmZmVycywgZW5jb2RpbmcpO1xuICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoeyBzdGRvdXQsIHN0ZGVyciB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRpc3Bvc2FibGVzLmZvckVhY2goZGlzcG9zYWJsZSA9PiBkaXNwb3NhYmxlLmRpc3Bvc2UoKSk7XG4gICAgICAgIH0pO1xuICAgICAgICBwcm9jLm9uY2UoJ2Vycm9yJywgZXggPT4ge1xuICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KGV4KTtcbiAgICAgICAgICAgIGRpc3Bvc2FibGVzLmZvckVhY2goZGlzcG9zYWJsZSA9PiBkaXNwb3NhYmxlLmRpc3Bvc2UoKSk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcbiAgICB9XG59XG5leHBvcnRzLlByb2Nlc3NTZXJ2aWNlID0gUHJvY2Vzc1NlcnZpY2U7XG4vLyMgc291cmNlTWFwcGluZ1VSTD1wcm9jLmpzLm1hcCJdfQ==