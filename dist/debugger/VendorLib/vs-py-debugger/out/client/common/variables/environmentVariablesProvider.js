"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const vscode_1 = require("vscode");

const configSettings_1 = require("../configSettings");

const constants_1 = require("../platform/constants");

const types_1 = require("../types");

const types_2 = require("./types");

let EnvironmentVariablesProvider = class EnvironmentVariablesProvider {
  constructor(envVarsService, disposableRegistry, isWidows, process) {
    this.envVarsService = envVarsService;
    this.isWidows = isWidows;
    this.process = process;
    this.cache = new Map();
    this.fileWatchers = new Map();
    this.disposables = [];
    disposableRegistry.push(this);
    this.changeEventEmitter = new vscode_1.EventEmitter();
  }

  get onDidEnvironmentVariablesChange() {
    return this.changeEventEmitter.event;
  }

  dispose() {
    this.changeEventEmitter.dispose();
    this.fileWatchers.forEach(watcher => {
      watcher.dispose();
    });
  }

  getEnvironmentVariables(resource) {
    return __awaiter(this, void 0, void 0, function* () {
      const settings = configSettings_1.PythonSettings.getInstance(resource);

      if (!this.cache.has(settings.envFile)) {
        const workspaceFolderUri = this.getWorkspaceFolderUri(resource);
        this.createFileWatcher(settings.envFile, workspaceFolderUri);
        let mergedVars = yield this.envVarsService.parseFile(settings.envFile);

        if (!mergedVars) {
          mergedVars = {};
        }

        this.envVarsService.mergeVariables(this.process.env, mergedVars);
        const pathVariable = this.isWidows ? constants_1.WINDOWS_PATH_VARIABLE_NAME : constants_1.NON_WINDOWS_PATH_VARIABLE_NAME;
        this.envVarsService.appendPath(mergedVars, this.process.env[pathVariable]);
        this.envVarsService.appendPythonPath(mergedVars, this.process.env.PYTHONPATH);
        this.cache.set(settings.envFile, mergedVars);
      }

      return this.cache.get(settings.envFile);
    });
  }

  getWorkspaceFolderUri(resource) {
    if (!resource) {
      return;
    }

    const workspaceFolder = vscode_1.workspace.getWorkspaceFolder(resource);
    return workspaceFolder ? workspaceFolder.uri : undefined;
  }

  createFileWatcher(envFile, workspaceFolderUri) {
    if (this.fileWatchers.has(envFile)) {
      return;
    }

    const envFileWatcher = vscode_1.workspace.createFileSystemWatcher(envFile);
    this.fileWatchers.set(envFile, envFileWatcher);
    this.disposables.push(envFileWatcher.onDidChange(() => this.onEnvironmentFileChanged(envFile, workspaceFolderUri)));
    this.disposables.push(envFileWatcher.onDidCreate(() => this.onEnvironmentFileChanged(envFile, workspaceFolderUri)));
    this.disposables.push(envFileWatcher.onDidDelete(() => this.onEnvironmentFileChanged(envFile, workspaceFolderUri)));
  }

  onEnvironmentFileChanged(envFile, workspaceFolderUri) {
    this.cache.delete(envFile);
    this.changeEventEmitter.fire(workspaceFolderUri);
  }

};
EnvironmentVariablesProvider = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_2.IEnvironmentVariablesService)), __param(1, inversify_1.inject(types_1.IDisposableRegistry)), __param(2, inversify_1.inject(types_1.IsWindows)), __param(3, inversify_1.inject(types_1.ICurrentProcess))], EnvironmentVariablesProvider);
exports.EnvironmentVariablesProvider = EnvironmentVariablesProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVudmlyb25tZW50VmFyaWFibGVzUHJvdmlkZXIuanMiXSwibmFtZXMiOlsiX19kZWNvcmF0ZSIsImRlY29yYXRvcnMiLCJ0YXJnZXQiLCJrZXkiLCJkZXNjIiwiYyIsImFyZ3VtZW50cyIsImxlbmd0aCIsInIiLCJPYmplY3QiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJkIiwiUmVmbGVjdCIsImRlY29yYXRlIiwiaSIsImRlZmluZVByb3BlcnR5IiwiX19wYXJhbSIsInBhcmFtSW5kZXgiLCJkZWNvcmF0b3IiLCJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiZXhwb3J0cyIsImludmVyc2lmeV8xIiwicmVxdWlyZSIsInZzY29kZV8xIiwiY29uZmlnU2V0dGluZ3NfMSIsImNvbnN0YW50c18xIiwidHlwZXNfMSIsInR5cGVzXzIiLCJFbnZpcm9ubWVudFZhcmlhYmxlc1Byb3ZpZGVyIiwiY29uc3RydWN0b3IiLCJlbnZWYXJzU2VydmljZSIsImRpc3Bvc2FibGVSZWdpc3RyeSIsImlzV2lkb3dzIiwicHJvY2VzcyIsImNhY2hlIiwiTWFwIiwiZmlsZVdhdGNoZXJzIiwiZGlzcG9zYWJsZXMiLCJwdXNoIiwiY2hhbmdlRXZlbnRFbWl0dGVyIiwiRXZlbnRFbWl0dGVyIiwib25EaWRFbnZpcm9ubWVudFZhcmlhYmxlc0NoYW5nZSIsImV2ZW50IiwiZGlzcG9zZSIsImZvckVhY2giLCJ3YXRjaGVyIiwiZ2V0RW52aXJvbm1lbnRWYXJpYWJsZXMiLCJyZXNvdXJjZSIsInNldHRpbmdzIiwiUHl0aG9uU2V0dGluZ3MiLCJnZXRJbnN0YW5jZSIsImhhcyIsImVudkZpbGUiLCJ3b3Jrc3BhY2VGb2xkZXJVcmkiLCJnZXRXb3Jrc3BhY2VGb2xkZXJVcmkiLCJjcmVhdGVGaWxlV2F0Y2hlciIsIm1lcmdlZFZhcnMiLCJwYXJzZUZpbGUiLCJtZXJnZVZhcmlhYmxlcyIsImVudiIsInBhdGhWYXJpYWJsZSIsIldJTkRPV1NfUEFUSF9WQVJJQUJMRV9OQU1FIiwiTk9OX1dJTkRPV1NfUEFUSF9WQVJJQUJMRV9OQU1FIiwiYXBwZW5kUGF0aCIsImFwcGVuZFB5dGhvblBhdGgiLCJQWVRIT05QQVRIIiwic2V0IiwiZ2V0Iiwid29ya3NwYWNlRm9sZGVyIiwid29ya3NwYWNlIiwiZ2V0V29ya3NwYWNlRm9sZGVyIiwidXJpIiwidW5kZWZpbmVkIiwiZW52RmlsZVdhdGNoZXIiLCJjcmVhdGVGaWxlU3lzdGVtV2F0Y2hlciIsIm9uRGlkQ2hhbmdlIiwib25FbnZpcm9ubWVudEZpbGVDaGFuZ2VkIiwib25EaWRDcmVhdGUiLCJvbkRpZERlbGV0ZSIsImRlbGV0ZSIsImZpcmUiLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSUVudmlyb25tZW50VmFyaWFibGVzU2VydmljZSIsIklEaXNwb3NhYmxlUmVnaXN0cnkiLCJJc1dpbmRvd3MiLCJJQ3VycmVudFByb2Nlc3MiXSwibWFwcGluZ3MiOiJBQUFBLGEsQ0FDQTtBQUNBOztBQUNBLElBQUlBLFVBQVUsR0FBSSxVQUFRLFNBQUtBLFVBQWQsSUFBNkIsVUFBVUMsVUFBVixFQUFzQkMsTUFBdEIsRUFBOEJDLEdBQTlCLEVBQW1DQyxJQUFuQyxFQUF5QztBQUNuRixNQUFJQyxDQUFDLEdBQUdDLFNBQVMsQ0FBQ0MsTUFBbEI7QUFBQSxNQUEwQkMsQ0FBQyxHQUFHSCxDQUFDLEdBQUcsQ0FBSixHQUFRSCxNQUFSLEdBQWlCRSxJQUFJLEtBQUssSUFBVCxHQUFnQkEsSUFBSSxHQUFHSyxNQUFNLENBQUNDLHdCQUFQLENBQWdDUixNQUFoQyxFQUF3Q0MsR0FBeEMsQ0FBdkIsR0FBc0VDLElBQXJIO0FBQUEsTUFBMkhPLENBQTNIO0FBQ0EsTUFBSSxPQUFPQyxPQUFQLEtBQW1CLFFBQW5CLElB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eEIsT0FBOUIsRUFBdUNDLGtCQUF2QyxDQUFqQyxDQUF0QjtBQUNIOztBQUNEdUIsRUFBQUEsd0JBQXdCLENBQUN4QixPQUFELEVBQVVDLGtCQUFWLEVBQThCO0FBQ2xELFNBQUtuQixLQUFMLENBQVc2QyxNQUFYLENBQWtCM0IsT0FBbEI7QUFDQSxTQUFLYixrQkFBTCxDQUF3QnlDLElBQXhCLENBQTZCM0Isa0JBQTdCO0FBQ0g7O0FBM0RpRSxDQUF0RTtBQTZEQXpCLDRCQUE0QixHQUFHN0MsVUFBVSxDQUFDLENBQ3RDc0MsV0FBVyxDQUFDNEQsVUFBWixFQURzQyxFQUV0Q2xGLE9BQU8sQ0FBQyxDQUFELEVBQUlzQixXQUFXLENBQUM2RCxNQUFaLENBQW1CdkQsT0FBTyxDQUFDd0QsNEJBQTNCLENBQUosQ0FGK0IsRUFHdENwRixPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDNkQsTUFBWixDQUFtQnhELE9BQU8sQ0FBQzBELG1CQUEzQixDQUFKLENBSCtCLEVBR3VCckYsT0FBTyxDQUFDLENBQUQsRUFBSXNCLFdBQVcsQ0FBQzZELE1BQVosQ0FBbUJ4RCxPQUFPLENBQUMyRCxTQUEzQixDQUFKLENBSDlCLEVBSXRDdEYsT0FBTyxDQUFDLENBQUQsRUFBSXNCLFdBQVcsQ0FBQzZELE1BQVosQ0FBbUJ4RCxPQUFPLENBQUM0RCxlQUEzQixDQUFKLENBSitCLENBQUQsRUFLdEMxRCw0QkFMc0MsQ0FBekM7QUFNQVIsT0FBTyxDQUFDUSw0QkFBUixHQUF1Q0EsNEJBQXZDIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG4vLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xuICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xufTtcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQsIGtleSkgeyBkZWNvcmF0b3IodGFyZ2V0LCBrZXksIHBhcmFtSW5kZXgpOyB9XG59O1xudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcbiAgICB9KTtcbn07XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5jb25zdCBpbnZlcnNpZnlfMSA9IHJlcXVpcmUoXCJpbnZlcnNpZnlcIik7XG5jb25zdCB2c2NvZGVfMSA9IHJlcXVpcmUoXCJ2c2NvZGVcIik7XG5jb25zdCBjb25maWdTZXR0aW5nc18xID0gcmVxdWlyZShcIi4uL2NvbmZpZ1NldHRpbmdzXCIpO1xuY29uc3QgY29uc3RhbnRzXzEgPSByZXF1aXJlKFwiLi4vcGxhdGZvcm0vY29uc3RhbnRzXCIpO1xuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi90eXBlc1wiKTtcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi90eXBlc1wiKTtcbmxldCBFbnZpcm9ubWVudFZhcmlhYmxlc1Byb3ZpZGVyID0gY2xhc3MgRW52aXJvbm1lbnRWYXJpYWJsZXNQcm92aWRlciB7XG4gICAgY29uc3RydWN0b3IoZW52VmFyc1NlcnZpY2UsIGRpc3Bvc2FibGVSZWdpc3RyeSwgaXNXaWRvd3MsIHByb2Nlc3MpIHtcbiAgICAgICAgdGhpcy5lbnZWYXJzU2VydmljZSA9IGVudlZhcnNTZXJ2aWNlO1xuICAgICAgICB0aGlzLmlzV2lkb3dzID0gaXNXaWRvd3M7XG4gICAgICAgIHRoaXMucHJvY2VzcyA9IHByb2Nlc3M7XG4gICAgICAgIHRoaXMuY2FjaGUgPSBuZXcgTWFwKCk7XG4gICAgICAgIHRoaXMuZmlsZVdhdGNoZXJzID0gbmV3IE1hcCgpO1xuICAgICAgICB0aGlzLmRpc3Bvc2FibGVzID0gW107XG4gICAgICAgIGRpc3Bvc2FibGVSZWdpc3RyeS5wdXNoKHRoaXMpO1xuICAgICAgICB0aGlzLmNoYW5nZUV2ZW50RW1pdHRlciA9IG5ldyB2c2NvZGVfMS5FdmVudEVtaXR0ZXIoKTtcbiAgICB9XG4gICAgZ2V0IG9uRGlkRW52aXJvbm1lbnRWYXJpYWJsZXNDaGFuZ2UoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNoYW5nZUV2ZW50RW1pdHRlci5ldmVudDtcbiAgICB9XG4gICAgZGlzcG9zZSgpIHtcbiAgICAgICAgdGhpcy5jaGFuZ2VFdmVudEVtaXR0ZXIuZGlzcG9zZSgpO1xuICAgICAgICB0aGlzLmZpbGVXYXRjaGVycy5mb3JFYWNoKHdhdGNoZXIgPT4ge1xuICAgICAgICAgICAgd2F0Y2hlci5kaXNwb3NlKCk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBnZXRFbnZpcm9ubWVudFZhcmlhYmxlcyhyZXNvdXJjZSkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSBjb25maWdTZXR0aW5nc18xLlB5dGhvblNldHRpbmdzLmdldEluc3RhbmNlKHJlc291cmNlKTtcbiAgICAgICAgICAgIGlmICghdGhpcy5jYWNoZS5oYXMoc2V0dGluZ3MuZW52RmlsZSkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB3b3Jrc3BhY2VGb2xkZXJVcmkgPSB0aGlzLmdldFdvcmtzcGFjZUZvbGRlclVyaShyZXNvdXJjZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVGaWxlV2F0Y2hlcihzZXR0aW5ncy5lbnZGaWxlLCB3b3Jrc3BhY2VGb2xkZXJVcmkpO1xuICAgICAgICAgICAgICAgIGxldCBtZXJnZWRWYXJzID0geWllbGQgdGhpcy5lbnZWYXJzU2VydmljZS5wYXJzZUZpbGUoc2V0dGluZ3MuZW52RmlsZSk7XG4gICAgICAgICAgICAgICAgaWYgKCFtZXJnZWRWYXJzKSB7XG4gICAgICAgICAgICAgICAgICAgIG1lcmdlZFZhcnMgPSB7fTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5lbnZWYXJzU2VydmljZS5tZXJnZVZhcmlhYmxlcyh0aGlzLnByb2Nlc3MuZW52LCBtZXJnZWRWYXJzKTtcbiAgICAgICAgICAgICAgICBjb25zdCBwYXRoVmFyaWFibGUgPSB0aGlzLmlzV2lkb3dzID8gY29uc3RhbnRzXzEuV0lORE9XU19QQVRIX1ZBUklBQkxFX05BTUUgOiBjb25zdGFudHNfMS5OT05fV0lORE9XU19QQVRIX1ZBUklBQkxFX05BTUU7XG4gICAgICAgICAgICAgICAgdGhpcy5lbnZWYXJzU2VydmljZS5hcHBlbmRQYXRoKG1lcmdlZFZhcnMsIHRoaXMucHJvY2Vzcy5lbnZbcGF0aFZhcmlhYmxlXSk7XG4gICAgICAgICAgICAgICAgdGhpcy5lbnZWYXJzU2VydmljZS5hcHBlbmRQeXRob25QYXRoKG1lcmdlZFZhcnMsIHRoaXMucHJvY2Vzcy5lbnYuUFlUSE9OUEFUSCk7XG4gICAgICAgICAgICAgICAgdGhpcy5jYWNoZS5zZXQoc2V0dGluZ3MuZW52RmlsZSwgbWVyZ2VkVmFycyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jYWNoZS5nZXQoc2V0dGluZ3MuZW52RmlsZSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBnZXRXb3Jrc3BhY2VGb2xkZXJVcmkocmVzb3VyY2UpIHtcbiAgICAgICAgaWYgKCFyZXNvdXJjZSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHdvcmtzcGFjZUZvbGRlciA9IHZzY29kZV8xLndvcmtzcGFjZS5nZXRXb3Jrc3BhY2VGb2xkZXIocmVzb3VyY2UpO1xuICAgICAgICByZXR1cm4gd29ya3NwYWNlRm9sZGVyID8gd29ya3NwYWNlRm9sZGVyLnVyaSA6IHVuZGVmaW5lZDtcbiAgICB9XG4gICAgY3JlYXRlRmlsZVdhdGNoZXIoZW52RmlsZSwgd29ya3NwYWNlRm9sZGVyVXJpKSB7XG4gICAgICAgIGlmICh0aGlzLmZpbGVXYXRjaGVycy5oYXMoZW52RmlsZSkpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBlbnZGaWxlV2F0Y2hlciA9IHZzY29kZV8xLndvcmtzcGFjZS5jcmVhdGVGaWxlU3lzdGVtV2F0Y2hlcihlbnZGaWxlKTtcbiAgICAgICAgdGhpcy5maWxlV2F0Y2hlcnMuc2V0KGVudkZpbGUsIGVudkZpbGVXYXRjaGVyKTtcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlcy5wdXNoKGVudkZpbGVXYXRjaGVyLm9uRGlkQ2hhbmdlKCgpID0+IHRoaXMub25FbnZpcm9ubWVudEZpbGVDaGFuZ2VkKGVudkZpbGUsIHdvcmtzcGFjZUZvbGRlclVyaSkpKTtcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlcy5wdXNoKGVudkZpbGVXYXRjaGVyLm9uRGlkQ3JlYXRlKCgpID0+IHRoaXMub25FbnZpcm9ubWVudEZpbGVDaGFuZ2VkKGVudkZpbGUsIHdvcmtzcGFjZUZvbGRlclVyaSkpKTtcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlcy5wdXNoKGVudkZpbGVXYXRjaGVyLm9uRGlkRGVsZXRlKCgpID0+IHRoaXMub25FbnZpcm9ubWVudEZpbGVDaGFuZ2VkKGVudkZpbGUsIHdvcmtzcGFjZUZvbGRlclVyaSkpKTtcbiAgICB9XG4gICAgb25FbnZpcm9ubWVudEZpbGVDaGFuZ2VkKGVudkZpbGUsIHdvcmtzcGFjZUZvbGRlclVyaSkge1xuICAgICAgICB0aGlzLmNhY2hlLmRlbGV0ZShlbnZGaWxlKTtcbiAgICAgICAgdGhpcy5jaGFuZ2VFdmVudEVtaXR0ZXIuZmlyZSh3b3Jrc3BhY2VGb2xkZXJVcmkpO1xuICAgIH1cbn07XG5FbnZpcm9ubWVudFZhcmlhYmxlc1Byb3ZpZGVyID0gX19kZWNvcmF0ZShbXG4gICAgaW52ZXJzaWZ5XzEuaW5qZWN0YWJsZSgpLFxuICAgIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzIuSUVudmlyb25tZW50VmFyaWFibGVzU2VydmljZSkpLFxuICAgIF9fcGFyYW0oMSwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzEuSURpc3Bvc2FibGVSZWdpc3RyeSkpLCBfX3BhcmFtKDIsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18xLklzV2luZG93cykpLFxuICAgIF9fcGFyYW0oMywgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzEuSUN1cnJlbnRQcm9jZXNzKSlcbl0sIEVudmlyb25tZW50VmFyaWFibGVzUHJvdmlkZXIpO1xuZXhwb3J0cy5FbnZpcm9ubWVudFZhcmlhYmxlc1Byb3ZpZGVyID0gRW52aXJvbm1lbnRWYXJpYWJsZXNQcm92aWRlcjtcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWVudmlyb25tZW50VmFyaWFibGVzUHJvdmlkZXIuanMubWFwIl19