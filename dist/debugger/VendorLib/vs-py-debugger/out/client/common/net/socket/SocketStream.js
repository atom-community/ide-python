"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

const uint64be = require("uint64be");

class SocketStream {
  constructor(socket, buffer) {
    this.bytesRead = 0;
    this.hasInsufficientDataForReading = false;
    this.buffer = buffer;
    this.socket = socket;
  }

  WriteInt32(num) {
    this.WriteInt64(num);
  }

  WriteInt64(num) {
    let buffer = uint64be.encode(num);
    this.socket.write(buffer);
  }

  WriteString(value) {
    let stringBuffer = new Buffer(value, "utf-8");
    this.WriteInt32(stringBuffer.length);

    if (stringBuffer.length > 0) {
      this.socket.write(stringBuffer);
    }
  }

  Write(buffer) {
    this.socket.write(buffer);
  }

  get Buffer() {
    return this.buffer;
  }

  BeginTransaction() {
    this.isInTransaction = true;
    this.bytesRead = 0;
    this.ClearErrors();
  }

  EndTransaction() {
    this.isInTransaction = false;
    this.buffer = this.buffer.slice(this.bytesRead);
    this.bytesRead = 0;
    this.ClearErrors();
  }

  RollBackTransaction() {
    this.isInTransaction = false;
    this.bytesRead = 0;
    this.ClearErrors();
  }

  ClearErrors() {
    this.hasInsufficientDataForReading = false;
  }

  get HasInsufficientDataForReading() {
    return this.hasInsufficientDataForReading;
  }

  toString() {
    return this.buffer.toString();
  }

  get Length() {
    return this.buffer.length;
  }

  Append(additionalData) {
    if (this.buffer.length === 0) {
      this.buffer = additionalData;
      return;
    }

    let newBuffer = new Buffer(this.buffer.length + additionalData.length);
    this.buffer.copy(newBuffer);
    additionalData.copy(newBuffer, this.buffer.length);
    this.buffer = newBuffer;
  }

  isSufficientDataAvailable(length) {
    if (this.buffer.length < this.bytesRead + length) {
      this.hasInsufficientDataForReading = true;
    }

    return !this.hasInsufficientDataForReading;
  }

  ReadByte() {
    if (!this.isSufficientDataAvailable(1)) {
      return null;
    }

    let value = this.buffer.slice(this.bytesRead, this.bytesRead + 1)[0];

    if (this.isInTransaction) {
      this.bytesRead++;
    } else {
      this.buffer = this.buffer.slice(1);
    }

    return value;
  }

  ReadString() {
    let byteRead = this.ReadByte();

    if (this.HasInsufficientDataForReading) {
      return null;
    }

    if (byteRead < 0) {
      throw new Error("IOException() - Socket.ReadString failed to read string type;");
    }

    let type = new Buffer([byteRead]).toString();
    let isUnicode = false;

    switch (type) {
      case "N":
        // null string
        return null;

      case "U":
        isUnicode = true;
        break;

      case "A":
        {
          isUnicode = false;
          break;
        }

      default:
        {
          throw new Error("IOException(); Socket.ReadString failed to parse unknown string type " + type);
        }
    }

    let len = this.ReadInt32();

    if (this.HasInsufficientDataForReading) {
      return null;
    }

    if (!this.isSufficientDataAvailable(len)) {
      return null;
    }

    let stringBuffer = this.buffer.slice(this.bytesRead, this.bytesRead + len);

    if (this.isInTransaction) {
      this.bytesRead = this.bytesRead + len;
    } else {
      this.buffer = this.buffer.slice(len);
    }

    let resp = isUnicode ? stringBuffer.toString("utf-8") : stringBuffer.toString();
    return resp;
  }

  ReadInt32() {
    return this.ReadInt64();
  }

  ReadInt64() {
    if (!this.isSufficientDataAvailable(8)) {
      return null;
    }

    let buf = this.buffer.slice(this.bytesRead, this.bytesRead + 8);

    if (this.isInTransaction) {
      this.bytesRead = this.bytesRead + 8;
    } else {
      this.buffer = this.buffer.slice(8);
    }

    let returnValue = uint64be.decode(buf);
    return returnValue;
  }

  ReadAsciiString(length) {
    if (!this.isSufficientDataAvailable(length)) {
      return null;
    }

    let stringBuffer = this.buffer.slice(this.bytesRead, this.bytesRead + length);

    if (this.isInTransaction) {
      this.bytesRead = this.bytesRead + length;
    } else {
      this.buffer = this.buffer.slice(length);
    }

    return stringBuffer.toString("ascii");
  }

  readValueInTransaction(dataType) {
    let startedTransaction = false;

    if (!this.isInTransaction) {
      this.BeginTransaction();
      startedTransaction = true;
    }

    let data;

    switch (dataType) {
      case DataType.string:
        {
          data = this.ReadString();
          break;
        }

      case DataType.int32:
        {
          data = this.ReadInt32();
          break;
        }

      case DataType.int64:
        {
          data = this.ReadInt64();
          break;
        }
    }

    if (this.HasInsufficientDataForReading) {
      if (startedTransaction) {
        this.RollBackTransaction();
      }

      return undefined;
    }

    if (startedTransaction) {
      this.EndTransaction();
    }

    return data;
  }

  readStringInTransaction() {
    return this.readValueInTransaction(DataType.string);
  }

  readInt32InTransaction() {
    return this.readValueInTransaction(DataType.int32);
  }

  readInt64InTransaction() {
    return this.readValueInTransaction(DataType.int64);
  }

}

exports.SocketStream = SocketStream;
var DataType;

(function (DataType) {
  DataType[DataType["string"] = 0] = "string";
  DataType[DataType["int32"] = 1] = "int32";
  DataType[DataType["int64"] = 2] = "int64";
})(DataType || (DataType = {}));
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlNvY2tldFN0cmVhbS5qcyJdLCJuYW1lcyI6WyJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsInVpbnQ2NGJlIiwicmVxdWlyZSIsIlNvY2tldFN0cmVhbSIsImNvbnN0cnVjdG9yIiwic29ja2V0IiwiYnVmZmVyIiwiYnl0ZXNSZWFkIiwiaGFzSW5zdWZmaWNpZW50RGF0YUZvclJlYWRpbmciLCJXcml0ZUludDMyIiwibnVtIiwiV3JpdGVJbnQ2NCIsImVuY29kZSIsIndyaXRlIiwiV3JpdGVTdHJpbmciLCJzdHJpbmdCdWZmZXIiLCJCdWZmZXIiLCJsZW5ndGgiLCJXcml0ZSIsIkJlZ2luVHJhbnNhY3Rpb24iLCJpc0luVHJhbnNhY3Rpb24iLCJDbGVhckVycm9ycyIsIkVuZFRyYW5zYWN0aW9uIiwic2xpY2UiLCJSb2xsQmFja1RyYW5zYWN0aW9uIiwiSGFzSW5zdWZmaWNpZW50RGF0YUZvclJlYWRpbmciLCJ0b1N0cmluZyIsIkxlbmd0aCIsIkFwcGVuZCIsImFkZGl0aW9uYWxEYXRhIiwibmV3QnVmZmVyIiwiY29weSIsImlzU3VmZmljaWVudERhdGFBdmFpbGFibGUiLCJSZWFkQnl0ZSIsIlJlYWRTdHJpbmciLCJieXRlUmVhZCIsIkVycm9yIiwidHlwZSIsImlzVW5pY29kZSIsImxlbiIsIlJlYWRJbnQzMiIsInJlc3AiLCJSZWFkSW50NjQiLCJidWYiLCJyZXR1cm5WYWx1ZSIsImRlY29kZSIsIlJlYWRBc2NpaVN0cmluZyIsInJlYWRWYWx1ZUluVHJhbnNhY3Rpb24iLCJkYXRhVHlwZSIsInN0YXJ0ZWRUcmFuc2FjdGlvbiIsImRhdGEiLCJEYXRhVHlwZSIsInN0cmluZyIsImludDMyIiwiaW50NjQiLCJ1bmRlZmluZWQiLCJyZWFkU3RyaW5nSW5UcmFuc2FjdGlvbiIsInJlYWRJbnQzMkluVHJhbnNhY3Rpb24iLCJyZWFkSW50NjRJblRyYW5zYWN0aW9uIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFDQUEsTUFBTSxD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QXJCLENBQVIsR0FBa0MsT0FBbEM7QUFDQUEsRUFBQUEsUUFBUSxDQUFDQSxRQUFRLENBQUMsT0FBRCxDQUFSLEdBQW9CLENBQXJCLENBQVIsR0FBa0MsT0FBbEM7QUFDSCxDQUpELEVBSUdBLFFBQVEsS0FBS0EsUUFBUSxHQUFHLEVBQWhCLENBSlgiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbmNvbnN0IHVpbnQ2NGJlID0gcmVxdWlyZShcInVpbnQ2NGJlXCIpO1xuY2xhc3MgU29ja2V0U3RyZWFtIHtcbiAgICBjb25zdHJ1Y3Rvcihzb2NrZXQsIGJ1ZmZlcikge1xuICAgICAgICB0aGlzLmJ5dGVzUmVhZCA9IDA7XG4gICAgICAgIHRoaXMuaGFzSW5zdWZmaWNpZW50RGF0YUZvclJlYWRpbmcgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5idWZmZXIgPSBidWZmZXI7XG4gICAgICAgIHRoaXMuc29ja2V0ID0gc29ja2V0O1xuICAgIH1cbiAgICBXcml0ZUludDMyKG51bSkge1xuICAgICAgICB0aGlzLldyaXRlSW50NjQobnVtKTtcbiAgICB9XG4gICAgV3JpdGVJbnQ2NChudW0pIHtcbiAgICAgICAgbGV0IGJ1ZmZlciA9IHVpbnQ2NGJlLmVuY29kZShudW0pO1xuICAgICAgICB0aGlzLnNvY2tldC53cml0ZShidWZmZXIpO1xuICAgIH1cbiAgICBXcml0ZVN0cmluZyh2YWx1ZSkge1xuICAgICAgICBsZXQgc3RyaW5nQnVmZmVyID0gbmV3IEJ1ZmZlcih2YWx1ZSwgXCJ1dGYtOFwiKTtcbiAgICAgICAgdGhpcy5Xcml0ZUludDMyKHN0cmluZ0J1ZmZlci5sZW5ndGgpO1xuICAgICAgICBpZiAoc3RyaW5nQnVmZmVyLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHRoaXMuc29ja2V0LndyaXRlKHN0cmluZ0J1ZmZlcik7XG4gICAgICAgIH1cbiAgICB9XG4gICAgV3JpdGUoYnVmZmVyKSB7XG4gICAgICAgIHRoaXMuc29ja2V0LndyaXRlKGJ1ZmZlcik7XG4gICAgfVxuICAgIGdldCBCdWZmZXIoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmJ1ZmZlcjtcbiAgICB9XG4gICAgQmVnaW5UcmFuc2FjdGlvbigpIHtcbiAgICAgICAgdGhpcy5pc0luVHJhbnNhY3Rpb24gPSB0cnVlO1xuICAgICAgICB0aGlzLmJ5dGVzUmVhZCA9IDA7XG4gICAgICAgIHRoaXMuQ2xlYXJFcnJvcnMoKTtcbiAgICB9XG4gICAgRW5kVHJhbnNhY3Rpb24oKSB7XG4gICAgICAgIHRoaXMuaXNJblRyYW5zYWN0aW9uID0gZmFsc2U7XG4gICAgICAgIHRoaXMuYnVmZmVyID0gdGhpcy5idWZmZXIuc2xpY2UodGhpcy5ieXRlc1JlYWQpO1xuICAgICAgICB0aGlzLmJ5dGVzUmVhZCA9IDA7XG4gICAgICAgIHRoaXMuQ2xlYXJFcnJvcnMoKTtcbiAgICB9XG4gICAgUm9sbEJhY2tUcmFuc2FjdGlvbigpIHtcbiAgICAgICAgdGhpcy5pc0luVHJhbnNhY3Rpb24gPSBmYWxzZTtcbiAgICAgICAgdGhpcy5ieXRlc1JlYWQgPSAwO1xuICAgICAgICB0aGlzLkNsZWFyRXJyb3JzKCk7XG4gICAgfVxuICAgIENsZWFyRXJyb3JzKCkge1xuICAgICAgICB0aGlzLmhhc0luc3VmZmljaWVudERhdGFGb3JSZWFkaW5nID0gZmFsc2U7XG4gICAgfVxuICAgIGdldCBIYXNJbnN1ZmZpY2llbnREYXRhRm9yUmVhZGluZygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaGFzSW5zdWZmaWNpZW50RGF0YUZvclJlYWRpbmc7XG4gICAgfVxuICAgIHRvU3RyaW5nKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5idWZmZXIudG9TdHJpbmcoKTtcbiAgICB9XG4gICAgZ2V0IExlbmd0aCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYnVmZmVyLmxlbmd0aDtcbiAgICB9XG4gICAgQXBwZW5kKGFkZGl0aW9uYWxEYXRhKSB7XG4gICAgICAgIGlmICh0aGlzLmJ1ZmZlci5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMuYnVmZmVyID0gYWRkaXRpb25hbERhdGE7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgbGV0IG5ld0J1ZmZlciA9IG5ldyBCdWZmZXIodGhpcy5idWZmZXIubGVuZ3RoICsgYWRkaXRpb25hbERhdGEubGVuZ3RoKTtcbiAgICAgICAgdGhpcy5idWZmZXIuY29weShuZXdCdWZmZXIpO1xuICAgICAgICBhZGRpdGlvbmFsRGF0YS5jb3B5KG5ld0J1ZmZlciwgdGhpcy5idWZmZXIubGVuZ3RoKTtcbiAgICAgICAgdGhpcy5idWZmZXIgPSBuZXdCdWZmZXI7XG4gICAgfVxuICAgIGlzU3VmZmljaWVudERhdGFBdmFpbGFibGUobGVuZ3RoKSB7XG4gICAgICAgIGlmICh0aGlzLmJ1ZmZlci5sZW5ndGggPCAodGhpcy5ieXRlc1JlYWQgKyBsZW5ndGgpKSB7XG4gICAgICAgICAgICB0aGlzLmhhc0luc3VmZmljaWVudERhdGFGb3JSZWFkaW5nID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gIXRoaXMuaGFzSW5zdWZmaWNpZW50RGF0YUZvclJlYWRpbmc7XG4gICAgfVxuICAgIFJlYWRCeXRlKCkge1xuICAgICAgICBpZiAoIXRoaXMuaXNTdWZmaWNpZW50RGF0YUF2YWlsYWJsZSgxKSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHZhbHVlID0gdGhpcy5idWZmZXIuc2xpY2UodGhpcy5ieXRlc1JlYWQsIHRoaXMuYnl0ZXNSZWFkICsgMSlbMF07XG4gICAgICAgIGlmICh0aGlzLmlzSW5UcmFuc2FjdGlvbikge1xuICAgICAgICAgICAgdGhpcy5ieXRlc1JlYWQrKztcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuYnVmZmVyID0gdGhpcy5idWZmZXIuc2xpY2UoMSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cbiAgICBSZWFkU3RyaW5nKCkge1xuICAgICAgICBsZXQgYnl0ZVJlYWQgPSB0aGlzLlJlYWRCeXRlKCk7XG4gICAgICAgIGlmICh0aGlzLkhhc0luc3VmZmljaWVudERhdGFGb3JSZWFkaW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoYnl0ZVJlYWQgPCAwKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJT0V4Y2VwdGlvbigpIC0gU29ja2V0LlJlYWRTdHJpbmcgZmFpbGVkIHRvIHJlYWQgc3RyaW5nIHR5cGU7XCIpO1xuICAgICAgICB9XG4gICAgICAgIGxldCB0eXBlID0gbmV3IEJ1ZmZlcihbYnl0ZVJlYWRdKS50b1N0cmluZygpO1xuICAgICAgICBsZXQgaXNVbmljb2RlID0gZmFsc2U7XG4gICAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICAgICAgY2FzZSBcIk5cIjogLy8gbnVsbCBzdHJpbmdcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIGNhc2UgXCJVXCI6XG4gICAgICAgICAgICAgICAgaXNVbmljb2RlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgXCJBXCI6IHtcbiAgICAgICAgICAgICAgICBpc1VuaWNvZGUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRlZmF1bHQ6IHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJT0V4Y2VwdGlvbigpOyBTb2NrZXQuUmVhZFN0cmluZyBmYWlsZWQgdG8gcGFyc2UgdW5rbm93biBzdHJpbmcgdHlwZSBcIiArIHR5cGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGxldCBsZW4gPSB0aGlzLlJlYWRJbnQzMigpO1xuICAgICAgICBpZiAodGhpcy5IYXNJbnN1ZmZpY2llbnREYXRhRm9yUmVhZGluZykge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGlzLmlzU3VmZmljaWVudERhdGFBdmFpbGFibGUobGVuKSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHN0cmluZ0J1ZmZlciA9IHRoaXMuYnVmZmVyLnNsaWNlKHRoaXMuYnl0ZXNSZWFkLCB0aGlzLmJ5dGVzUmVhZCArIGxlbik7XG4gICAgICAgIGlmICh0aGlzLmlzSW5UcmFuc2FjdGlvbikge1xuICAgICAgICAgICAgdGhpcy5ieXRlc1JlYWQgPSB0aGlzLmJ5dGVzUmVhZCArIGxlbjtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuYnVmZmVyID0gdGhpcy5idWZmZXIuc2xpY2UobGVuKTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgcmVzcCA9IGlzVW5pY29kZSA/IHN0cmluZ0J1ZmZlci50b1N0cmluZyhcInV0Zi04XCIpIDogc3RyaW5nQnVmZmVyLnRvU3RyaW5nKCk7XG4gICAgICAgIHJldHVybiByZXNwO1xuICAgIH1cbiAgICBSZWFkSW50MzIoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLlJlYWRJbnQ2NCgpO1xuICAgIH1cbiAgICBSZWFkSW50NjQoKSB7XG4gICAgICAgIGlmICghdGhpcy5pc1N1ZmZpY2llbnREYXRhQXZhaWxhYmxlKDgpKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBsZXQgYnVmID0gdGhpcy5idWZmZXIuc2xpY2UodGhpcy5ieXRlc1JlYWQsIHRoaXMuYnl0ZXNSZWFkICsgOCk7XG4gICAgICAgIGlmICh0aGlzLmlzSW5UcmFuc2FjdGlvbikge1xuICAgICAgICAgICAgdGhpcy5ieXRlc1JlYWQgPSB0aGlzLmJ5dGVzUmVhZCArIDg7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmJ1ZmZlciA9IHRoaXMuYnVmZmVyLnNsaWNlKDgpO1xuICAgICAgICB9XG4gICAgICAgIGxldCByZXR1cm5WYWx1ZSA9IHVpbnQ2NGJlLmRlY29kZShidWYpO1xuICAgICAgICByZXR1cm4gcmV0dXJuVmFsdWU7XG4gICAgfVxuICAgIFJlYWRBc2NpaVN0cmluZyhsZW5ndGgpIHtcbiAgICAgICAgaWYgKCF0aGlzLmlzU3VmZmljaWVudERhdGFBdmFpbGFibGUobGVuZ3RoKSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHN0cmluZ0J1ZmZlciA9IHRoaXMuYnVmZmVyLnNsaWNlKHRoaXMuYnl0ZXNSZWFkLCB0aGlzLmJ5dGVzUmVhZCArIGxlbmd0aCk7XG4gICAgICAgIGlmICh0aGlzLmlzSW5UcmFuc2FjdGlvbikge1xuICAgICAgICAgICAgdGhpcy5ieXRlc1JlYWQgPSB0aGlzLmJ5dGVzUmVhZCArIGxlbmd0aDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuYnVmZmVyID0gdGhpcy5idWZmZXIuc2xpY2UobGVuZ3RoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc3RyaW5nQnVmZmVyLnRvU3RyaW5nKFwiYXNjaWlcIik7XG4gICAgfVxuICAgIHJlYWRWYWx1ZUluVHJhbnNhY3Rpb24oZGF0YVR5cGUpIHtcbiAgICAgICAgbGV0IHN0YXJ0ZWRUcmFuc2FjdGlvbiA9IGZhbHNlO1xuICAgICAgICBpZiAoIXRoaXMuaXNJblRyYW5zYWN0aW9uKSB7XG4gICAgICAgICAgICB0aGlzLkJlZ2luVHJhbnNhY3Rpb24oKTtcbiAgICAgICAgICAgIHN0YXJ0ZWRUcmFuc2FjdGlvbiA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGRhdGE7XG4gICAgICAgIHN3aXRjaCAoZGF0YVR5cGUpIHtcbiAgICAgICAgICAgIGNhc2UgRGF0YVR5cGUuc3RyaW5nOiB7XG4gICAgICAgICAgICAgICAgZGF0YSA9IHRoaXMuUmVhZFN0cmluZygpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2FzZSBEYXRhVHlwZS5pbnQzMjoge1xuICAgICAgICAgICAgICAgIGRhdGEgPSB0aGlzLlJlYWRJbnQzMigpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2FzZSBEYXRhVHlwZS5pbnQ2NDoge1xuICAgICAgICAgICAgICAgIGRhdGEgPSB0aGlzLlJlYWRJbnQ2NCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLkhhc0luc3VmZmljaWVudERhdGFGb3JSZWFkaW5nKSB7XG4gICAgICAgICAgICBpZiAoc3RhcnRlZFRyYW5zYWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5Sb2xsQmFja1RyYW5zYWN0aW9uKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzdGFydGVkVHJhbnNhY3Rpb24pIHtcbiAgICAgICAgICAgIHRoaXMuRW5kVHJhbnNhY3Rpb24oKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZGF0YTtcbiAgICB9XG4gICAgcmVhZFN0cmluZ0luVHJhbnNhY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlYWRWYWx1ZUluVHJhbnNhY3Rpb24oRGF0YVR5cGUuc3RyaW5nKTtcbiAgICB9XG4gICAgcmVhZEludDMySW5UcmFuc2FjdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVhZFZhbHVlSW5UcmFuc2FjdGlvbihEYXRhVHlwZS5pbnQzMik7XG4gICAgfVxuICAgIHJlYWRJbnQ2NEluVHJhbnNhY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlYWRWYWx1ZUluVHJhbnNhY3Rpb24oRGF0YVR5cGUuaW50NjQpO1xuICAgIH1cbn1cbmV4cG9ydHMuU29ja2V0U3RyZWFtID0gU29ja2V0U3RyZWFtO1xudmFyIERhdGFUeXBlO1xuKGZ1bmN0aW9uIChEYXRhVHlwZSkge1xuICAgIERhdGFUeXBlW0RhdGFUeXBlW1wic3RyaW5nXCJdID0gMF0gPSBcInN0cmluZ1wiO1xuICAgIERhdGFUeXBlW0RhdGFUeXBlW1wiaW50MzJcIl0gPSAxXSA9IFwiaW50MzJcIjtcbiAgICBEYXRhVHlwZVtEYXRhVHlwZVtcImludDY0XCJdID0gMl0gPSBcImludDY0XCI7XG59KShEYXRhVHlwZSB8fCAoRGF0YVR5cGUgPSB7fSkpO1xuLy8jIHNvdXJjZU1hcHBpbmdVUkw9U29ja2V0U3RyZWFtLmpzLm1hcCJdfQ==