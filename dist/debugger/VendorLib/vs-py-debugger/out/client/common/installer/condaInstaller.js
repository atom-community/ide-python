"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const contracts_1 = require("../../interpreter/contracts");

const types_1 = require("../../ioc/types");

const types_2 = require("../types");

const moduleInstaller_1 = require("./moduleInstaller");
/**
 * A Python module installer for a conda environment.
 */


let CondaInstaller = class CondaInstaller extends moduleInstaller_1.ModuleInstaller {
  constructor(serviceContainer) {
    super(serviceContainer);
  }

  get displayName() {
    return 'Conda';
  }

  get priority() {
    return 0;
  }
  /**
   * Checks whether we can use Conda as module installer for a given resource.
   * We need to perform two checks:
   * 1. Ensure we have conda.
   * 2. Check if the current environment is a conda environment.
   * @param {Uri} [resource=] Resource used to identify the workspace.
   * @returns {Promise<boolean>} Whether conda is supported as a module installer or not.
   */


  isSupported(resource) {
    return __awaiter(this, void 0, void 0, function* () {
      if (this.isCondaAvailable === false) {
        return false;
      }

      const condaLocator = this.serviceContainer.get(contracts_1.ICondaService);
      this.isCondaAvailable = yield condaLocator.isCondaAvailable();

      if (!this.isCondaAvailable) {
        return false;
      } // Now we need to check if the current environment is a conda environment or not.


      return this.isCurrentEnvironmentACondaEnvironment(resource);
    });
  }
  /**
   * Return the commandline args needed to install the module.
   */


  getExecutionInfo(moduleName, resource) {
    return __awaiter(this, void 0, void 0, function* () {
      const condaService = this.serviceContainer.get(contracts_1.ICondaService);
      const condaFile = yield condaService.getCondaFile();
      const pythonPath = this.serviceContainer.get(types_2.IConfigurationService).getSettings(resource).pythonPath;
      const info = yield condaService.getCondaEnvironment(pythonPath);
      const args = ['install'];

      if (info && info.name) {
        // If we have the name of the conda environment, then use that.
        args.push('--name');
        args.push(info.name.toCommandArgument());
      } else if (info && info.path) {
        // Else provide the full path to the environment path.
        args.push('--prefix');
        args.push(info.path.fileToCommandArgument());
      }

      args.push(moduleName);
      return {
        args,
        execPath: condaFile
      };
    });
  }
  /**
   * Is anaconda the current interpreter?
   */


  isCurrentEnvironmentACondaEnvironment(resource) {
    return __awaiter(this, void 0, void 0, function* () {
      const condaService = this.serviceContainer.get(contracts_1.ICondaService);
      const pythonPath = this.serviceContainer.get(types_2.IConfigurationService).getSettings(resource).pythonPath;
      return condaService.isCondaEnvironment(pythonPath);
    });
  }

};
CondaInstaller = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_1.IServiceContainer))], CondaInstaller);
exports.CondaInstaller = CondaInstaller;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbmRhSW5zdGFsbGVyLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsIl9fcGFyYW0iLCJwYXJhbUluZGV4IiwiZGVjb3JhdG9yIiwiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsImV4cG9ydHMiLCJpbnZlcnNpZnlfMSIsInJlcXVpcmUiLCJjb250cmFjdHNfMSIsInR5cGVzXzEiLCJ0eXBlc18yIiwibW9kdWxlSW5zdGFsbGVyXzEiLCJDb25kYUluc3RhbGxlciIsIk1vZHVsZUluc3RhbGxlciIsImNvbnN0cnVjdG9yIiwic2VydmljZUNvbnRhaW5lciIsImRpc3BsYXlOYW1lIiwicHJpb3JpdHkiLCJpc1N1cHBvcnRlZCIsInJlc291cmNlIiwiaXNDb25kYUF2YWlsYWJsZSIsImNvbmRhTG9jYXRvciIsImdldCIsIklDb25kYVNlcnZpY2UiLCJpc0N1cnJlbnRFbnZpcm9ubWVudEFDb25kYUVudmlyb25tZW50IiwiZ2V0RXhlY3V0aW9uSW5mbyIsIm1vZHVsZU5hbWUiLCJjb25kYVNlcnZpY2UiLCJjb25kYUZpbGUiLCJnZXRDb25kYUZpbGUiLCJweXRob25QYXRoIiwiSUNvbmZpZ3VyYXRpb25TZXJ2aWNlIiwiZ2V0U2V0dGluZ3MiLCJpbmZvIiwiZ2V0Q29uZGFFbnZpcm9ubWVudCIsImFyZ3MiLCJuYW1lIiwicHVzaCIsInRvQ29tbWFuZEFyZ3VtZW50IiwicGF0aCIsImZpbGVUb0NvbW1hbmRBcmd1bWVudCIsImV4ZWNQYXRoIiwiaXNDb25kYUVudmlyb25tZW50IiwiaW5qZWN0YWJsZSIsImluamVjdCIsIklTZXJ2aWNlQ29udGFpbmVyIl0sIm1hcHBpbmdzIjoiQUFBQSxhLENBQ0E7QUFDQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEsTUFBMEJDLENBQUMsR0FBR0gsQ0FBQyxHQUFHLENBQUosR0FBUUgsTUFBUixHQUFpQkUsSUFBSSxLQUFLLElBQVQsR0FBZ0JBLElBQUksR0FBR0ssTUFBTSxDQUFDQyx3QkFBUCxDQUFnQ1IsTUFBaEMsRUFBd0NDLEdBQXhDLENBQXZCLEdBQXNFQyxJQUFySDtBQUFBLE1BQTJITyxDQUEzSDtBQUNBLE1BQUksT0FBT0MsT0FBUCxLQUFtQixRQUFuQixJQUErQixPQUFPQSxPQUFPLENBQUNDLFFBQWYsS0FBNEIsVUFBL0QsRUFBMkVMLENBQUMsR0FBR0ksT0FBTyxDQUFDQyxRQUFSLENBQWlCWixVQUFqQixFQUE2QkMsTUFBN0IsRUFBcUNDLEdBQXJDLEVBQTBDQyxJQUExQyxDQUFKLENBQTNFLEtBQ0ssS0FBSyxJQUFJVSxDQUFDLEdBQUdiLFVBQVUsQ0FBQ00sTUFBWCxHQUFvQixDQUFqQyxFQUFvQ08sQ0FBQyxJQUFJLENBQXpDLEVBQTRDQSxDQUFDLEVBQTdDLEVBQWlELElBQUlILENBQUMsR0FBR1YsVUFBVSxDQUFDYSxDQUFELENBQWxCLEVBQXVCTixDQUFDLEdBQUcsQ0FBQ0gsQ0FBQyxHQUFHLENBQUosR0FBUU0sQ0FBQyxDQUFDSCxDQUFELENBQVQsR0FBZUgsQ0FBQyxHQUFHLENBQUosR0FBUU0sQ0FBQyxDQUFDVCxNQUFELEVBQVNDLEdBQVQsRUFBY0ssQ0FBZCxDQUFULEdBQTRC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LENBQVA7QUFDSCxLQUplLENBQWhCO0FBS0g7O0FBcEUrRSxDQUFwRjtBQXNFQWxCLGNBQWMsR0FBRzVDLFVBQVUsQ0FBQyxDQUN4QnNDLFdBQVcsQ0FBQ3FDLFVBQVosRUFEd0IsRUFFeEIzRCxPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDc0MsTUFBWixDQUFtQm5DLE9BQU8sQ0FBQ29DLGlCQUEzQixDQUFKLENBRmlCLENBQUQsRUFHeEJqQyxjQUh3QixDQUEzQjtBQUlBUCxPQUFPLENBQUNPLGNBQVIsR0FBeUJBLGNBQXpCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG4vLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xuICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xufTtcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQsIGtleSkgeyBkZWNvcmF0b3IodGFyZ2V0LCBrZXksIHBhcmFtSW5kZXgpOyB9XG59O1xudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcbiAgICB9KTtcbn07XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5jb25zdCBpbnZlcnNpZnlfMSA9IHJlcXVpcmUoXCJpbnZlcnNpZnlcIik7XG5jb25zdCBjb250cmFjdHNfMSA9IHJlcXVpcmUoXCIuLi8uLi9pbnRlcnByZXRlci9jb250cmFjdHNcIik7XG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uLy4uL2lvYy90eXBlc1wiKTtcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vdHlwZXNcIik7XG5jb25zdCBtb2R1bGVJbnN0YWxsZXJfMSA9IHJlcXVpcmUoXCIuL21vZHVsZUluc3RhbGxlclwiKTtcbi8qKlxuICogQSBQeXRob24gbW9kdWxlIGluc3RhbGxlciBmb3IgYSBjb25kYSBlbnZpcm9ubWVudC5cbiAqL1xubGV0IENvbmRhSW5zdGFsbGVyID0gY2xhc3MgQ29uZGFJbnN0YWxsZXIgZXh0ZW5kcyBtb2R1bGVJbnN0YWxsZXJfMS5Nb2R1bGVJbnN0YWxsZXIge1xuICAgIGNvbnN0cnVjdG9yKHNlcnZpY2VDb250YWluZXIpIHtcbiAgICAgICAgc3VwZXIoc2VydmljZUNvbnRhaW5lcik7XG4gICAgfVxuICAgIGdldCBkaXNwbGF5TmFtZSgpIHtcbiAgICAgICAgcmV0dXJuICdDb25kYSc7XG4gICAgfVxuICAgIGdldCBwcmlvcml0eSgpIHtcbiAgICAgICAgcmV0dXJuIDA7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIENoZWNrcyB3aGV0aGVyIHdlIGNhbiB1c2UgQ29uZGEgYXMgbW9kdWxlIGluc3RhbGxlciBmb3IgYSBnaXZlbiByZXNvdXJjZS5cbiAgICAgKiBXZSBuZWVkIHRvIHBlcmZvcm0gdHdvIGNoZWNrczpcbiAgICAgKiAxLiBFbnN1cmUgd2UgaGF2ZSBjb25kYS5cbiAgICAgKiAyLiBDaGVjayBpZiB0aGUgY3VycmVudCBlbnZpcm9ubWVudCBpcyBhIGNvbmRhIGVudmlyb25tZW50LlxuICAgICAqIEBwYXJhbSB7VXJpfSBbcmVzb3VyY2U9XSBSZXNvdXJjZSB1c2VkIHRvIGlkZW50aWZ5IHRoZSB3b3Jrc3BhY2UuXG4gICAgICogQHJldHVybnMge1Byb21pc2U8Ym9vbGVhbj59IFdoZXRoZXIgY29uZGEgaXMgc3VwcG9ydGVkIGFzIGEgbW9kdWxlIGluc3RhbGxlciBvciBub3QuXG4gICAgICovXG4gICAgaXNTdXBwb3J0ZWQocmVzb3VyY2UpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmlzQ29uZGFBdmFpbGFibGUgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgY29uZGFMb2NhdG9yID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldChjb250cmFjdHNfMS5JQ29uZGFTZXJ2aWNlKTtcbiAgICAgICAgICAgIHRoaXMuaXNDb25kYUF2YWlsYWJsZSA9IHlpZWxkIGNvbmRhTG9jYXRvci5pc0NvbmRhQXZhaWxhYmxlKCk7XG4gICAgICAgICAgICBpZiAoIXRoaXMuaXNDb25kYUF2YWlsYWJsZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIE5vdyB3ZSBuZWVkIHRvIGNoZWNrIGlmIHRoZSBjdXJyZW50IGVudmlyb25tZW50IGlzIGEgY29uZGEgZW52aXJvbm1lbnQgb3Igbm90LlxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaXNDdXJyZW50RW52aXJvbm1lbnRBQ29uZGFFbnZpcm9ubWVudChyZXNvdXJjZSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBSZXR1cm4gdGhlIGNvbW1hbmRsaW5lIGFyZ3MgbmVlZGVkIHRvIGluc3RhbGwgdGhlIG1vZHVsZS5cbiAgICAgKi9cbiAgICBnZXRFeGVjdXRpb25JbmZvKG1vZHVsZU5hbWUsIHJlc291cmNlKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBjb25kYVNlcnZpY2UgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KGNvbnRyYWN0c18xLklDb25kYVNlcnZpY2UpO1xuICAgICAgICAgICAgY29uc3QgY29uZGFGaWxlID0geWllbGQgY29uZGFTZXJ2aWNlLmdldENvbmRhRmlsZSgpO1xuICAgICAgICAgICAgY29uc3QgcHl0aG9uUGF0aCA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMi5JQ29uZmlndXJhdGlvblNlcnZpY2UpLmdldFNldHRpbmdzKHJlc291cmNlKS5weXRob25QYXRoO1xuICAgICAgICAgICAgY29uc3QgaW5mbyA9IHlpZWxkIGNvbmRhU2VydmljZS5nZXRDb25kYUVudmlyb25tZW50KHB5dGhvblBhdGgpO1xuICAgICAgICAgICAgY29uc3QgYXJncyA9IFsnaW5zdGFsbCddO1xuICAgICAgICAgICAgaWYgKGluZm8gJiYgaW5mby5uYW1lKSB7XG4gICAgICAgICAgICAgICAgLy8gSWYgd2UgaGF2ZSB0aGUgbmFtZSBvZiB0aGUgY29uZGEgZW52aXJvbm1lbnQsIHRoZW4gdXNlIHRoYXQuXG4gICAgICAgICAgICAgICAgYXJncy5wdXNoKCctLW5hbWUnKTtcbiAgICAgICAgICAgICAgICBhcmdzLnB1c2goaW5mby5uYW1lLnRvQ29tbWFuZEFyZ3VtZW50KCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoaW5mbyAmJiBpbmZvLnBhdGgpIHtcbiAgICAgICAgICAgICAgICAvLyBFbHNlIHByb3ZpZGUgdGhlIGZ1bGwgcGF0aCB0byB0aGUgZW52aXJvbm1lbnQgcGF0aC5cbiAgICAgICAgICAgICAgICBhcmdzLnB1c2goJy0tcHJlZml4Jyk7XG4gICAgICAgICAgICAgICAgYXJncy5wdXNoKGluZm8ucGF0aC5maWxlVG9Db21tYW5kQXJndW1lbnQoKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhcmdzLnB1c2gobW9kdWxlTmFtZSk7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGFyZ3MsXG4gICAgICAgICAgICAgICAgZXhlY1BhdGg6IGNvbmRhRmlsZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIElzIGFuYWNvbmRhIHRoZSBjdXJyZW50IGludGVycHJldGVyP1xuICAgICAqL1xuICAgIGlzQ3VycmVudEVudmlyb25tZW50QUNvbmRhRW52aXJvbm1lbnQocmVzb3VyY2UpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IGNvbmRhU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQoY29udHJhY3RzXzEuSUNvbmRhU2VydmljZSk7XG4gICAgICAgICAgICBjb25zdCBweXRob25QYXRoID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18yLklDb25maWd1cmF0aW9uU2VydmljZSkuZ2V0U2V0dGluZ3MocmVzb3VyY2UpLnB5dGhvblBhdGg7XG4gICAgICAgICAgICByZXR1cm4gY29uZGFTZXJ2aWNlLmlzQ29uZGFFbnZpcm9ubWVudChweXRob25QYXRoKTtcbiAgICAgICAgfSk7XG4gICAgfVxufTtcbkNvbmRhSW5zdGFsbGVyID0gX19kZWNvcmF0ZShbXG4gICAgaW52ZXJzaWZ5XzEuaW5qZWN0YWJsZSgpLFxuICAgIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzEuSVNlcnZpY2VDb250YWluZXIpKVxuXSwgQ29uZGFJbnN0YWxsZXIpO1xuZXhwb3J0cy5Db25kYUluc3RhbGxlciA9IENvbmRhSW5zdGFsbGVyO1xuLy8jIHNvdXJjZU1hcHBpbmdVUkw9Y29uZGFJbnN0YWxsZXIuanMubWFwIl19