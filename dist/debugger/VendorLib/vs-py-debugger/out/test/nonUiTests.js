// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
}); // tslint:disable:no-any no-require-imports no-var-requires

if (Reflect.metadata === undefined) {
  require('reflect-metadata');
} // Custom module loader so we skip .css files that break non webpack wrapped compiles
// tslint:disable-next-line:no-var-requires no-require-imports


const Module = require('module'); // tslint:disable-next-line:no-function-expression


(function () {
  const origRequire = Module.prototype.require;

  const _require = (context, filepath) => {
    return origRequire.call(context, filepath);
  };

  Module.prototype.require = function (filepath) {
    if (filepath.endsWith('.css')) {
      return '';
    } // tslint:disable-next-line:no-invalid-this


    return _require(this, filepath);
  };
})();

const glob = require("glob");

const Mocha = require("mocha");

const path = require("path");

const ciConstants_1 = require("./ciConstants");

const reactHelpers_1 = require("./datascience/reactHelpers");

const vscodeMoscks = require("./vscode-mock");

process.env.VSC_PYTHON_CI_TEST = '1';

function runTests(testOptions) {
  // nteract/transforms-full expects to run in the browser so we have to fake
  // parts of the browser here.
  reactHelpers_1.setUpDomEnvironment();
  vscodeMoscks.initialize();
  const grep = testOptions ? testOptions.grep : undefined;
  const timeout = testOptions ? testOptions.timeout : undefined;
  const filePattern = testOptions ? testOptions.filePattern : '**/**.unit.test.js';
  const options = {
    ui: 'tdd',
    useColors: true,
    timeout,
    grep
  };
  let temp_mocha;

  if (ciConstants_1.MOCHA_REPORTER_JUNIT === true) {
    temp_mocha = new Mocha({
      grep: undefined,
      ui: 'tdd',
      timeout,
      reporter: ciConstants_1.MOCHA_CI_REPORTER_ID,
      reporterOptions: {
        useColors: false,
        mochaFile: ciConstants_1.MOCHA_CI_REPORTFILE,
        bail: false
      },
      slow: undefined
    });
  } else {
    // we are running on the command line or debugger...
    temp_mocha = new Mocha(options);
  }

  const mocha = temp_mocha;

  require('source-map-support').install();

  const testsRoot = __dirname;
  glob(filePattern, {
    cwd: testsRoot
  }, (error, files) => {
    if (error) {
      return reportErrors(error);
    }

    try {
      files.forEach(file => mocha.addFile(path.join(testsRoot, file)));
      mocha.run(failures => {
        if (failures === 0) {
          return;
        }

        reportErrors(undefined, failures);
      });
    } catch (error) {
      reportErrors(error);
    }
  });
}

exports.runTests = runTests;

function reportErrors(error, failures) {
  let failed = false;

  if (error) {
    console.error(error);
    failed = true;
  }

  if (failures && failures >= 0) {
    console.error(`${failures} failed tests ðŸ‘Ž.`);
    failed = true;
  }

  if (failed) {
    process.exit(1);
  }
}

function extractParams(defaultTimeout) {
  // When running from debugger, allow custom args.
  const args = process.argv0.length > 2 ? process.argv.slice(2) : [];
  const timeoutArgIndex = args.findIndex(arg => arg.startsWith('timeout='));
  const grepArgIndex = args.findIndex(arg => arg.startsWith('grep='));
  const timeout = timeoutArgIndex >= 0 ? parseInt(args[timeoutArgIndex].split('=')[1].trim(), 10) : defaultTimeout;
  let grep = grepArgIndex >= 0 ? args[grepArgIndex].split('=')[1].trim() : undefined;
  grep = grep && grep.length > 0 ? grep : undefined;
  return {
    grep: grep,
    timeout: timeout
  };
}

exports.extractParams = extractParams;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vblVpVGVzdHMuanMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJSZWZsZWN0IiwibWV0YWRhdGEiLCJ1bmRlZmluZWQiLCJyZXF1aXJlIiwiTW9kdWxlIiwib3JpZ1JlcXVpcmUiLCJwcm90b3R5cGUiLCJfcmVxdWlyZSIsImNvbnRleHQiLCJmaWxlcGF0aCIsImNhbGwiLCJlbmRzV2l0aCIsImdsb2IiLCJNb2NoYSIsInBhdGgiLCJjaUNvbnN0YW50c18xIiwicmVhY3RIZWxwZXJzXzEiLCJ2c2NvZGVNb3Nja3MiLCJwcm9jZXNzIiwiZW52IiwiVlNDX1BZVEhPTl9DSV9URVNUIiwicnVuVGVzdHMiLCJ0ZXN0T3B0aW9ucyIsInNldFVwRG9tRW52aXJvbm1lbnQiLCJpbml0aWFsaXplIiwiZ3JlcCIsInRpbWVvdXQiLCJmaWxlUGF0dGVybiIsIm9wdGlvbnMiLCJ1aSIsInVzZUNvbG9ycyIsInRlbXBfbW9jaGEiLCJNT0NIQV9SRVBPUlRFUl9KVU5JVCIsInJlcG9ydGVyIiwiTU9DSEFfQ0lfUkVQT1JURVJfSUQiLCJyZXBvcnRlck9wdGlvbnMiLCJtb2NoYUZpbGUiLCJNT0NIQV9DSV9SRVBPUlRGSUxFIiwiYmFpbCIsInNsb3ciLCJtb2NoYSIsImluc3RhbGwiLCJ0ZXN0c1Jvb3QiLCJfX2Rpcm5hbWUiLCJjd2QiLCJlcnJvciIsImZpbGVzIiwicmVwb3J0RXJyb3JzIiwiZm9yRWFjaCIsImZpbGUiLCJhZGRGaWxlIiwiam9pbiIsInJ1biIsImZhaWx1cmVzIiwiZmFpbGVkIiwiY29uc29sZSIsImV4aXQiLCJleHRyYWN0UGFyYW1zIiwiZGVmYXVsdFRpbWVvdXQiLCJhcmdzIiwiYXJndjAiLCJsZW5ndGgiLCJhcmd2Iiwic2xpY2UiLCJ0aW1lb3V0QXJnSW5kZXgiLCJmaW5kSW5kZXgiLCJhcmciLCJzdGFydHNXaXRoIiwiZ3JlcEFyZ0luZGV4IiwicGFyc2VJbnQiLCJzcGxpdCIsInRyaW0i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SUFBSSxDQUFDb0MsTUFBTCxHQUFjLENBQXRCLEdBQTBCcEMsSUFBMUIsR0FBaUN2QixTQUF4QztBQUNBLFNBQU87QUFBRXVCLElBQUFBLElBQUksRUFBRUEsSUFBUjtBQUFjQyxJQUFBQSxPQUFPLEVBQUVBO0FBQXZCLEdBQVA7QUFDSDs7QUFDRDVCLE9BQU8sQ0FBQzJELGFBQVIsR0FBd0JBLGFBQXhCIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXG4ndXNlIHN0cmljdCc7XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG4vLyB0c2xpbnQ6ZGlzYWJsZTpuby1hbnkgbm8tcmVxdWlyZS1pbXBvcnRzIG5vLXZhci1yZXF1aXJlc1xuaWYgKFJlZmxlY3QubWV0YWRhdGEgPT09IHVuZGVmaW5lZCkge1xuICAgIHJlcXVpcmUoJ3JlZmxlY3QtbWV0YWRhdGEnKTtcbn1cbi8vIEN1c3RvbSBtb2R1bGUgbG9hZGVyIHNvIHdlIHNraXAgLmNzcyBmaWxlcyB0aGF0IGJyZWFrIG5vbiB3ZWJwYWNrIHdyYXBwZWQgY29tcGlsZXNcbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby12YXItcmVxdWlyZXMgbm8tcmVxdWlyZS1pbXBvcnRzXG5jb25zdCBNb2R1bGUgPSByZXF1aXJlKCdtb2R1bGUnKTtcbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1mdW5jdGlvbi1leHByZXNzaW9uXG4oZnVuY3Rpb24gKCkge1xuICAgIGNvbnN0IG9yaWdSZXF1aXJlID0gTW9kdWxlLnByb3RvdHlwZS5yZXF1aXJlO1xuICAgIGNvbnN0IF9yZXF1aXJlID0gKGNvbnRleHQsIGZpbGVwYXRoKSA9PiB7XG4gICAgICAgIHJldHVybiBvcmlnUmVxdWlyZS5jYWxsKGNvbnRleHQsIGZpbGVwYXRoKTtcbiAgICB9O1xuICAgIE1vZHVsZS5wcm90b3R5cGUucmVxdWlyZSA9IGZ1bmN0aW9uIChmaWxlcGF0aCkge1xuICAgICAgICBpZiAoZmlsZXBhdGguZW5kc1dpdGgoJy5jc3MnKSkge1xuICAgICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1pbnZhbGlkLXRoaXNcbiAgICAgICAgcmV0dXJuIF9yZXF1aXJlKHRoaXMsIGZpbGVwYXRoKTtcbiAgICB9O1xufSkoKTtcbmNvbnN0IGdsb2IgPSByZXF1aXJlKFwiZ2xvYlwiKTtcbmNvbnN0IE1vY2hhID0gcmVxdWlyZShcIm1vY2hhXCIpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xuY29uc3QgY2lDb25zdGFudHNfMSA9IHJlcXVpcmUoXCIuL2NpQ29uc3RhbnRzXCIpO1xuY29uc3QgcmVhY3RIZWxwZXJzXzEgPSByZXF1aXJlKFwiLi9kYXRhc2NpZW5jZS9yZWFjdEhlbHBlcnNcIik7XG5jb25zdCB2c2NvZGVNb3Nja3MgPSByZXF1aXJlKFwiLi92c2NvZGUtbW9ja1wiKTtcbnByb2Nlc3MuZW52LlZTQ19QWVRIT05fQ0lfVEVTVCA9ICcxJztcbmZ1bmN0aW9uIHJ1blRlc3RzKHRlc3RPcHRpb25zKSB7XG4gICAgLy8gbnRlcmFjdC90cmFuc2Zvcm1zLWZ1bGwgZXhwZWN0cyB0byBydW4gaW4gdGhlIGJyb3dzZXIgc28gd2UgaGF2ZSB0byBmYWtlXG4gICAgLy8gcGFydHMgb2YgdGhlIGJyb3dzZXIgaGVyZS5cbiAgICByZWFjdEhlbHBlcnNfMS5zZXRVcERvbUVudmlyb25tZW50KCk7XG4gICAgdnNjb2RlTW9zY2tzLmluaXRpYWxpemUoKTtcbiAgICBjb25zdCBncmVwID0gdGVzdE9wdGlvbnMgPyB0ZXN0T3B0aW9ucy5ncmVwIDogdW5kZWZpbmVkO1xuICAgIGNvbnN0IHRpbWVvdXQgPSB0ZXN0T3B0aW9ucyA/IHRlc3RPcHRpb25zLnRpbWVvdXQgOiB1bmRlZmluZWQ7XG4gICAgY29uc3QgZmlsZVBhdHRlcm4gPSB0ZXN0T3B0aW9ucyA/IHRlc3RPcHRpb25zLmZpbGVQYXR0ZXJuIDogJyoqLyoqLnVuaXQudGVzdC5qcyc7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgICAgdWk6ICd0ZGQnLFxuICAgICAgICB1c2VDb2xvcnM6IHRydWUsXG4gICAgICAgIHRpbWVvdXQsXG4gICAgICAgIGdyZXBcbiAgICB9O1xuICAgIGxldCB0ZW1wX21vY2hhO1xuICAgIGlmIChjaUNvbnN0YW50c18xLk1PQ0hBX1JFUE9SVEVSX0pVTklUID09PSB0cnVlKSB7XG4gICAgICAgIHRlbXBfbW9jaGEgPSBuZXcgTW9jaGEoe1xuICAgICAgICAgICAgZ3JlcDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgdWk6ICd0ZGQnLFxuICAgICAgICAgICAgdGltZW91dCxcbiAgICAgICAgICAgIHJlcG9ydGVyOiBjaUNvbnN0YW50c18xLk1PQ0hBX0NJX1JFUE9SVEVSX0lELFxuICAgICAgICAgICAgcmVwb3J0ZXJPcHRpb25zOiB7XG4gICAgICAgICAgICAgICAgdXNlQ29sb3JzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBtb2NoYUZpbGU6IGNpQ29uc3RhbnRzXzEuTU9DSEFfQ0lfUkVQT1JURklMRSxcbiAgICAgICAgICAgICAgICBiYWlsOiBmYWxzZVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNsb3c6IHVuZGVmaW5lZFxuICAgICAgICB9KTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIC8vIHdlIGFyZSBydW5uaW5nIG9uIHRoZSBjb21tYW5kIGxpbmUgb3IgZGVidWdnZXIuLi5cbiAgICAgICAgdGVtcF9tb2NoYSA9IG5ldyBNb2NoYShvcHRpb25zKTtcbiAgICB9XG4gICAgY29uc3QgbW9jaGEgPSB0ZW1wX21vY2hhO1xuICAgIHJlcXVpcmUoJ3NvdXJjZS1tYXAtc3VwcG9ydCcpLmluc3RhbGwoKTtcbiAgICBjb25zdCB0ZXN0c1Jvb3QgPSBfX2Rpcm5hbWU7XG4gICAgZ2xvYihmaWxlUGF0dGVybiwgeyBjd2Q6IHRlc3RzUm9vdCB9LCAoZXJyb3IsIGZpbGVzKSA9PiB7XG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgcmV0dXJuIHJlcG9ydEVycm9ycyhlcnJvcik7XG4gICAgICAgIH1cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGZpbGVzLmZvckVhY2goZmlsZSA9PiBtb2NoYS5hZGRGaWxlKHBhdGguam9pbih0ZXN0c1Jvb3QsIGZpbGUpKSk7XG4gICAgICAgICAgICBtb2NoYS5ydW4oZmFpbHVyZXMgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChmYWlsdXJlcyA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJlcG9ydEVycm9ycyh1bmRlZmluZWQsIGZhaWx1cmVzKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgcmVwb3J0RXJyb3JzKGVycm9yKTtcbiAgICAgICAgfVxuICAgIH0pO1xufVxuZXhwb3J0cy5ydW5UZXN0cyA9IHJ1blRlc3RzO1xuZnVuY3Rpb24gcmVwb3J0RXJyb3JzKGVycm9yLCBmYWlsdXJlcykge1xuICAgIGxldCBmYWlsZWQgPSBmYWxzZTtcbiAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgIGZhaWxlZCA9IHRydWU7XG4gICAgfVxuICAgIGlmIChmYWlsdXJlcyAmJiBmYWlsdXJlcyA+PSAwKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYCR7ZmFpbHVyZXN9IGZhaWxlZCB0ZXN0cyDwn5GOLmApO1xuICAgICAgICBmYWlsZWQgPSB0cnVlO1xuICAgIH1cbiAgICBpZiAoZmFpbGVkKSB7XG4gICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICB9XG59XG5mdW5jdGlvbiBleHRyYWN0UGFyYW1zKGRlZmF1bHRUaW1lb3V0KSB7XG4gICAgLy8gV2hlbiBydW5uaW5nIGZyb20gZGVidWdnZXIsIGFsbG93IGN1c3RvbSBhcmdzLlxuICAgIGNvbnN0IGFyZ3MgPSBwcm9jZXNzLmFyZ3YwLmxlbmd0aCA+IDIgPyBwcm9jZXNzLmFyZ3Yuc2xpY2UoMikgOiBbXTtcbiAgICBjb25zdCB0aW1lb3V0QXJnSW5kZXggPSBhcmdzLmZpbmRJbmRleChhcmcgPT4gYXJnLnN0YXJ0c1dpdGgoJ3RpbWVvdXQ9JykpO1xuICAgIGNvbnN0IGdyZXBBcmdJbmRleCA9IGFyZ3MuZmluZEluZGV4KGFyZyA9PiBhcmcuc3RhcnRzV2l0aCgnZ3JlcD0nKSk7XG4gICAgY29uc3QgdGltZW91dCA9IHRpbWVvdXRBcmdJbmRleCA+PSAwID8gcGFyc2VJbnQoYXJnc1t0aW1lb3V0QXJnSW5kZXhdLnNwbGl0KCc9JylbMV0udHJpbSgpLCAxMCkgOiBkZWZhdWx0VGltZW91dDtcbiAgICBsZXQgZ3JlcCA9IGdyZXBBcmdJbmRleCA+PSAwID8gYXJnc1tncmVwQXJnSW5kZXhdLnNwbGl0KCc9JylbMV0udHJpbSgpIDogdW5kZWZpbmVkO1xuICAgIGdyZXAgPSBncmVwICYmIGdyZXAubGVuZ3RoID4gMCA/IGdyZXAgOiB1bmRlZmluZWQ7XG4gICAgcmV0dXJuIHsgZ3JlcDogZ3JlcCwgdGltZW91dDogdGltZW91dCB9O1xufVxuZXhwb3J0cy5leHRyYWN0UGFyYW1zID0gZXh0cmFjdFBhcmFtcztcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPW5vblVpVGVzdHMuanMubWFwIl19