// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

require("./cell.css");

const ansi_to_html_1 = require("ansi-to-html");

const React = require("react"); // tslint:disable-next-line:match-default-export-name import-name


const react_json_tree_1 = require("react-json-tree");

const types_1 = require("../../client/datascience/types");

const locReactSide_1 = require("../react-common/locReactSide");

const relativeImage_1 = require("../react-common/relativeImage");

const cellButton_1 = require("./cellButton");

const code_1 = require("./code");

const collapseButton_1 = require("./collapseButton");

const executionCount_1 = require("./executionCount");

const menuBar_1 = require("./menuBar");

const transforms_1 = require("./transforms");

class Cell extends React.Component {
  constructor(prop) {
    super(prop); // Public for testing

    this.getUnknownMimeTypeString = () => {
      return locReactSide_1.getLocString('DataScience.unknownMimeType', 'Unknown Mime Type');
    };

    this.toggleInputBlock = () => {
      const cellId = this.getCell().id;
      this.props.cellVM.inputBlockToggled(cellId);
    };

    this.getDeleteString = () => {
      return locReactSide_1.getLocString('DataScience.deleteButtonTooltip', 'Remove Cell');
    };

    this.getGoToCodeString = () => {
      return locReactSide_1.getLocString('DataScience.gotoCodeButtonTooltip', 'Go to code');
    };

    this.getCell = () => {
      return this.props.cellVM.cell;
    };

    this.isCodeCell = () => {
      return this.props.cellVM.cell.data.cell_type === 'code';
    };

    this.hasOutput = () => {
      return this.getCell().state === types_1.CellState.finished || this.getCell().state === types_1.CellState.error || this.getCell().state === types_1.CellState.executing;
    };

    this.getCodeCell = () => {
      return this.props.cellVM.cell.data;
    };

    this.getMarkdownCell = () => {
      return this.props.cellVM.cell.data;
    };

    this.renderInputs = () => {
      if (this.isCodeCell()) {
        // Colorize our text
        return React.createElement("div", {
          className: 'cell-input'
        }, React.createElement(code_1.Code, {
          code: this.props.cellVM.inputBlockText,
          theme: this.props.theme
        }));
      } else {
        return null;
      }
    };

    this.renderResults = () => {
      const outputClassNames = this.isCodeCell() ? `cell-output cell-output-${this.props.theme}` : ''; // Results depend upon the type of cell

      const results = this.isCodeCell() ? this.renderCodeOutputs() : this.renderMarkdown(this.getMarkdownCell()); // Then combine them inside a div

      return React.createElement("div", {
        className: outputClassNames
      }, results);
    };

    this.renderCodeOutputs = () => {
      if (this.isCodeCell() && this.hasOutput()) {
        // Render the outputs
        return this.getCodeCell().outputs.map((output, index) => {
          return this.renderOutput(output, index);
        });
      }
    };

    this.renderMarkdown = markdown => {
      // React-markdown expects that the source is a string
      const source = Cell.concatMultilineString(markdown.source);
      const Transform = transforms_1.transforms['text/markdown'];
      return React.createElement(Transform, {
        data: source
      });
    };

    this.renderWithTransform = (mimetype, output, index) => {
      // If we found a mimetype, use the transform
      if (mimetype) {
        // Get the matching React.Component for that mimetype
        const Transform = transforms_1.transforms[mimetype];

        if (typeof mimetype !== 'string') {
          return React.createElement("div", {
            key: index
          }, this.getUnknownMimeTypeString());
        }

        try {
          // Text/plain has to be massaged. It expects a continuous string
          if (output.data) {
            let data = output.data[mimetype];

            if (mimetype === 'text/plain') {
              data = Cell.concatMultilineString(data);
            } // Return the transformed control using the data we massaged


            return React.createElement(Transform, {
              key: index,
              data: data
            });
          }
        } catch (ex) {
          window.console.log('Error in rendering');
          window.console.log(ex);
          return React.createElement("div", null);
        }
      }

      return React.createElement("div", null);
    };

    this.renderOutput = (output, index) => {
      // Borrowed this from Don's Jupyter extension
      // First make sure we have the mime data
      if (!output) {
        return React.createElement("div", {
          key: index
        });
      } // Make a copy of our data so we don't modify our cell


      const copy = Object.assign({}, output); // Special case for json

      if (copy.data && copy.data['application/json']) {
        return React.createElement(react_json_tree_1.default, {
          key: index,
          data: copy.data
        });
      } // Stream and error output need to be converted


      if (copy.output_type === 'stream') {
        const stream = copy;
        const text = Cell.concatMultilineString(stream.text);
        copy.data = {
          'text/html': text
        };
      } else if (copy.output_type === 'error') {
        const error = copy;

        try {
          const converter = new ansi_to_html_1.default();
          const trace = converter.toHtml(error.traceback.join('\n'));
          copy.data = {
            'text/html': trace
          };
        } catch (_a) {
          // This can fail during unit tests, just use the raw data
          copy.data = {
            'text/html': error.evalue
          };
        }
      } // Jupyter style MIME bundle
      // Find out which mimetype is the richest


      const mimetype = transforms_1.richestMimetype(copy.data, transforms_1.displayOrder, transforms_1.transforms); // If that worked, use the transform

      if (mimetype) {
        return this.renderWithTransform(mimetype, copy, index);
      }

      const str = this.getUnknownMimeTypeString();
      return React.createElement("div", {
        key: index
      }, "$", str);
    };
  }

  static concatMultilineString(str) {
    if (Array.isArray(str)) {
      let result = '';

      for (let i = 0; i < str.length; i += 1) {
        const s = str[i];

        if (i < str.length - 1 && !s.endsWith('\n')) {
          result = result.concat(`${s}\n`);
        } else {
          result = result.concat(s);
        }
      }

      return result.trim();
    }

    return str.toString().trim();
  }

  render() {
    const clearButtonImage = this.props.theme !== 'vscode-dark' ? './images/Cancel/Cancel_16xMD_vscode.svg' : './images/Cancel/Cancel_16xMD_vscode_dark.svg';
    const gotoSourceImage = this.props.theme !== 'vscode-dark' ? './images/GoToSourceCode/GoToSourceCode_16x_vscode.svg' : './images/GoToSourceCode/GoToSourceCode_16x_vscode_dark.svg';
    return React.createElement("div", {
      className: 'cell-wrapper'
    }, React.createElement(menuBar_1.MenuBar, {
      theme: this.props.theme
    }, React.createElement(cellButton_1.CellButton, {
      theme: this.props.theme,
      onClick: this.props.delete,
      tooltip: this.getDeleteString()
    }, React.createElement(relativeImage_1.RelativeImage, {
      class: 'cell-button-image',
      path: clearButtonImage
    })), React.createElement(cellButton_1.CellButton, {
      theme: this.props.theme,
      onClick: this.props.gotoCode,
      tooltip: this.getGoToCodeString()
    }, React.createElement(relativeImage_1.RelativeImage, {
      class: 'cell-button-image',
      path: gotoSourceImage
    }))), React.createElement("div", {
      className: 'cell-outer'
    }, React.createElement("div", {
      className: 'controls-div'
    }, React.createElement("div", {
      className: 'controls-flex'
    }, React.createElement(executionCount_1.ExecutionCount, {
      cell: this.props.cellVM.cell,
      theme: this.props.theme,
      visible: this.isCodeCell()
    }), React.createElement(collapseButton_1.CollapseButton, {
      theme: this.props.theme,
      hidden: this.props.cellVM.inputBlockCollapseNeeded,
      open: this.props.cellVM.inputBlockOpen,
      onClick: this.toggleInputBlock,
      tooltip: locReactSide_1.getLocString('DataScience.collapseInputTooltip', 'Collapse input block')
    }))), React.createElement("div", {
      className: 'content-div'
    }, React.createElement("div", {
      className: 'cell-result-container'
    }, this.renderInputs(), this.renderResults()))));
  }

}

exports.Cell = Cell;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNlbGwuanMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJyZXF1aXJlIiwiYW5zaV90b19odG1sXzEiLCJSZWFjdCIsInJlYWN0X2pzb25fdHJlZV8xIiwidHlwZXNfMSIsImxvY1JlYWN0U2lkZV8xIiwicmVsYXRpdmVJbWFnZV8xIiwiY2VsbEJ1dHRvbl8xIiwiY29kZV8xIiwiY29sbGFwc2VCdXR0b25fMSIsImV4ZWN1dGlvbkNvdW50XzEiLCJtZW51QmFyXzEiLCJ0cmFuc2Zvcm1zXzEiLCJDZWxsIiwiQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wIiwiZ2V0VW5rbm93bk1pbWVUeXBlU3RyaW5nIiwiZ2V0TG9jU3RyaW5nIiwidG9nZ2xlSW5wdXRCbG9jayIsImNlbGxJZCIsImdldENlbGwiLCJpZCIsInByb3BzIiwiY2VsbFZNIiwiaW5wdXRCbG9ja1RvZ2dsZWQiLCJnZXREZWxldGVTdHJpbmciLCJnZXRHb1RvQ29kZVN0cmluZyIsImNlbGwiLCJpc0NvZGVDZWxsIiwiZGF0YSIsImNlbGxfdHlwZSIsImhhc091dHB1dCIsInN0YXRlIiwiQ2VsbFN0YXRlIiwiZmluaXNoZWQiLCJlcnJvciIsImV4ZWN1dGluZyIsImdldENvZGVDZWxsIiwiZ2V0TWFya2Rvd25DZWxsIiwicmVuZGVySW5wdXRzIiwiY3JlYXRlRWxlbWVudCIsImNsYXNzTmFtZSIsIkNvZGUiLCJjb2RlIiwiaW5wdXRCbG9ja1RleHQiLCJ0aGVtZSIsInJlbmRlclJlc3VsdHMiLCJvdXRwdXRDbGFzc05hbWVzIiwicmVzdWx0cyIsInJlbmRlckNvZGVPdXRwdXRzIiwicmVuZGVyTWFya2Rvd24iLCJvdXRwdXRzIiwibWFwIiwib3V0cHV0IiwiaW5kZXgiLCJyZW5kZXJPdXRwdXQiLCJtYXJrZG93biIsInNvdXJjZSIsImNvbmNhdE11bHRpbGluZVN0cmluZyIsIlRyYW5zZm9ybSIsInRyYW5zZm9ybXMiLCJyZW5kZXJXaXRoVHJhbnNmb3JtIiwibWltZXR5cGUiLCJrZXkiLCJleCIsIndpbmRvdyIsImNvbnNvbGUiLCJsb2ciLCJjb3B5IiwiYXNzaWduIiwiZGVmYXVsdCIsIm91dHB1dF90eXBlIiwic3RyZWFtIiwidGV4dCIsImNvbnZlcnRlciIsInRyYWNlIiwidG9IdG1sIiwidHJhY2ViYWNrIiwiam9pbiIsIl9hIiwiZXZhbHVlIiwicmljaGVzdE1pbWV0eXBlIiwiZGlzcGxheU9yZGVyIiwic3RyIiwiQXJyYXkiLCJpc0FycmF5IiwicmVzdWx0IiwiaSIsImxlbmd0aCIsInMiLCJlbmRzV2l0aCIsImNvbmNhdCIsInRyaW0iLCJ0b1N0cmluZyIsInJlbmRlciIsImNsZWFyQnV0dG9uSW1hZ2UiLCJnb3RvU291cmNlSW1hZ2UiLCJNZW51QmFyIiwiQ2VsbEJ1dHRvbiIsIm9uQ2xpY2siLCJkZWxldGUiLCJ0b29sdGlwIiwiUmVsYXRpdmVJbWFnZSIsImNsYXNzIiwicGF0aCIsImdvdG9Db2RlIiwiRXhlY3V0aW9uQ291bnQiLCJ2aXNpYmxlIiwiQ29sbGFwc2VCdXR0b24iLCJoaWRkZW4iLCJpbnB1dEJsb2NrQ29sbGFwc2VOZWVkZWQiLCJvcGVuIiwiaW5wdXRCbG9ja09wZW4iXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQUEsTUFBTSxDQUFDQyxjQUFQLENBQXNCQyxPQUF0QixFQUErQixZQUEvQixFQUE2QztBQUFFQyxFQUFBQSxLQUFLLEVBQUU7QUFBVCxDQUE3Qzs7QUFDQUMsT0FBTyxDQUFDLFlBQUQsQ0FBUDs7QUFDQSxNQUFNQyxjQUFjLEdBQUdELE9BQU8sQ0FBQyxjQUFELENBQTlCOztBQUNBLE1BQU1FLEtBQUssR0FBR0YsT0FBTyxDQUFDLE9BQUQsQ0FBckIsQyxDQUNBOzs7QUFDQSxNQUFNRyxpQkFBaUIsR0FBR0gsT0FBTyxDQUFDLGlCQUFELENBQWpDOztBQUNBLE1BQU1JLE9BQU8sR0FBR0osT0FBTyxDQUFDLGdDQUFELENBQXZCOztBQUNBLE1BQU1LLGNBQWMsR0FBR0wsT0FB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QUwsQ0FBV0MsTUFBWCxDQUFrQkksSUFBMUI7QUFBZ0NrQixNQUFBQSxLQUFLLEVBQUUsS0FBS3ZCLEtBQUwsQ0FBV3VCLEtBQWxEO0FBQXlEOEQsTUFBQUEsT0FBTyxFQUFFLEtBQUsvRSxVQUFMO0FBQWxFLEtBQXJELENBREosRUFFSTNCLEtBQUssQ0FBQ3VDLGFBQU4sQ0FBb0JoQyxnQkFBZ0IsQ0FBQ29HLGNBQXJDLEVBQXFEO0FBQUUvRCxNQUFBQSxLQUFLLEVBQUUsS0FBS3ZCLEtBQUwsQ0FBV3VCLEtBQXBCO0FBQTJCZ0UsTUFBQUEsTUFBTSxFQUFFLEtBQUt2RixLQUFMLENBQVdDLE1BQVgsQ0FBa0J1Rix3QkFBckQ7QUFBK0VDLE1BQUFBLElBQUksRUFBRSxLQUFLekYsS0FBTCxDQUFXQyxNQUFYLENBQWtCeUYsY0FBdkc7QUFBdUhiLE1BQUFBLE9BQU8sRUFBRSxLQUFLakYsZ0JBQXJJO0FBQXVKbUYsTUFBQUEsT0FBTyxFQUFFakcsY0FBYyxDQUFDYSxZQUFmLENBQTRCLGtDQUE1QixFQUFnRSxzQkFBaEU7QUFBaEssS0FBckQsQ0FGSixDQURKLENBREosRUFLSWhCLEtBQUssQ0FBQ3VDLGFBQU4sQ0FBb0IsS0FBcEIsRUFBMkI7QUFBRUMsTUFBQUEsU0FBUyxFQUFFO0FBQWIsS0FBM0IsRUFDSXhDLEtBQUssQ0FBQ3VDLGFBQU4sQ0FBb0IsS0FBcEIsRUFBMkI7QUFBRUMsTUFBQUEsU0FBUyxFQUFFO0FBQWIsS0FBM0IsRUFDSSxLQUFLRixZQUFMLEVBREosRUFFSSxLQUFLTyxhQUFMLEVBRkosQ0FESixDQUxKLENBTkksQ0FBUjtBQWVIOztBQW5MOEI7O0FBcUxuQ2pELE9BQU8sQ0FBQ2UsSUFBUixHQUFlQSxJQUFmIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXG4ndXNlIHN0cmljdCc7XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5yZXF1aXJlKFwiLi9jZWxsLmNzc1wiKTtcbmNvbnN0IGFuc2lfdG9faHRtbF8xID0gcmVxdWlyZShcImFuc2ktdG8taHRtbFwiKTtcbmNvbnN0IFJlYWN0ID0gcmVxdWlyZShcInJlYWN0XCIpO1xuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1hdGNoLWRlZmF1bHQtZXhwb3J0LW5hbWUgaW1wb3J0LW5hbWVcbmNvbnN0IHJlYWN0X2pzb25fdHJlZV8xID0gcmVxdWlyZShcInJlYWN0LWpzb24tdHJlZVwiKTtcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2RhdGFzY2llbmNlL3R5cGVzXCIpO1xuY29uc3QgbG9jUmVhY3RTaWRlXzEgPSByZXF1aXJlKFwiLi4vcmVhY3QtY29tbW9uL2xvY1JlYWN0U2lkZVwiKTtcbmNvbnN0IHJlbGF0aXZlSW1hZ2VfMSA9IHJlcXVpcmUoXCIuLi9yZWFjdC1jb21tb24vcmVsYXRpdmVJbWFnZVwiKTtcbmNvbnN0IGNlbGxCdXR0b25fMSA9IHJlcXVpcmUoXCIuL2NlbGxCdXR0b25cIik7XG5jb25zdCBjb2RlXzEgPSByZXF1aXJlKFwiLi9jb2RlXCIpO1xuY29uc3QgY29sbGFwc2VCdXR0b25fMSA9IHJlcXVpcmUoXCIuL2NvbGxhcHNlQnV0dG9uXCIpO1xuY29uc3QgZXhlY3V0aW9uQ291bnRfMSA9IHJlcXVpcmUoXCIuL2V4ZWN1dGlvbkNvdW50XCIpO1xuY29uc3QgbWVudUJhcl8xID0gcmVxdWlyZShcIi4vbWVudUJhclwiKTtcbmNvbnN0IHRyYW5zZm9ybXNfMSA9IHJlcXVpcmUoXCIuL3RyYW5zZm9ybXNcIik7XG5jbGFzcyBDZWxsIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50IHtcbiAgICBjb25zdHJ1Y3Rvcihwcm9wKSB7XG4gICAgICAgIHN1cGVyKHByb3ApO1xuICAgICAgICAvLyBQdWJsaWMgZm9yIHRlc3RpbmdcbiAgICAgICAgdGhpcy5nZXRVbmtub3duTWltZVR5cGVTdHJpbmcgPSAoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gbG9jUmVhY3RTaWRlXzEuZ2V0TG9jU3RyaW5nKCdEYXRhU2NpZW5jZS51bmtub3duTWltZVR5cGUnLCAnVW5rbm93biBNaW1lIFR5cGUnKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy50b2dnbGVJbnB1dEJsb2NrID0gKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY2VsbElkID0gdGhpcy5nZXRDZWxsKCkuaWQ7XG4gICAgICAgICAgICB0aGlzLnByb3BzLmNlbGxWTS5pbnB1dEJsb2NrVG9nZ2xlZChjZWxsSWQpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLmdldERlbGV0ZVN0cmluZyA9ICgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBsb2NSZWFjdFNpZGVfMS5nZXRMb2NTdHJpbmcoJ0RhdGFTY2llbmNlLmRlbGV0ZUJ1dHRvblRvb2x0aXAnLCAnUmVtb3ZlIENlbGwnKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5nZXRHb1RvQ29kZVN0cmluZyA9ICgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBsb2NSZWFjdFNpZGVfMS5nZXRMb2NTdHJpbmcoJ0RhdGFTY2llbmNlLmdvdG9Db2RlQnV0dG9uVG9vbHRpcCcsICdHbyB0byBjb2RlJyk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuZ2V0Q2VsbCA9ICgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnByb3BzLmNlbGxWTS5jZWxsO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLmlzQ29kZUNlbGwgPSAoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy5jZWxsVk0uY2VsbC5kYXRhLmNlbGxfdHlwZSA9PT0gJ2NvZGUnO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLmhhc091dHB1dCA9ICgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldENlbGwoKS5zdGF0ZSA9PT0gdHlwZXNfMS5DZWxsU3RhdGUuZmluaXNoZWQgfHwgdGhpcy5nZXRDZWxsKCkuc3RhdGUgPT09IHR5cGVzXzEuQ2VsbFN0YXRlLmVycm9yIHx8IHRoaXMuZ2V0Q2VsbCgpLnN0YXRlID09PSB0eXBlc18xLkNlbGxTdGF0ZS5leGVjdXRpbmc7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuZ2V0Q29kZUNlbGwgPSAoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy5jZWxsVk0uY2VsbC5kYXRhO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLmdldE1hcmtkb3duQ2VsbCA9ICgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnByb3BzLmNlbGxWTS5jZWxsLmRhdGE7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMucmVuZGVySW5wdXRzID0gKCkgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMuaXNDb2RlQ2VsbCgpKSB7XG4gICAgICAgICAgICAgICAgLy8gQ29sb3JpemUgb3VyIHRleHRcbiAgICAgICAgICAgICAgICByZXR1cm4gKFJlYWN0LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgeyBjbGFzc05hbWU6ICdjZWxsLWlucHV0JyB9LFxuICAgICAgICAgICAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KGNvZGVfMS5Db2RlLCB7IGNvZGU6IHRoaXMucHJvcHMuY2VsbFZNLmlucHV0QmxvY2tUZXh0LCB0aGVtZTogdGhpcy5wcm9wcy50aGVtZSB9KSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMucmVuZGVyUmVzdWx0cyA9ICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG91dHB1dENsYXNzTmFtZXMgPSB0aGlzLmlzQ29kZUNlbGwoKSA/XG4gICAgICAgICAgICAgICAgYGNlbGwtb3V0cHV0IGNlbGwtb3V0cHV0LSR7dGhpcy5wcm9wcy50aGVtZX1gIDpcbiAgICAgICAgICAgICAgICAnJztcbiAgICAgICAgICAgIC8vIFJlc3VsdHMgZGVwZW5kIHVwb24gdGhlIHR5cGUgb2YgY2VsbFxuICAgICAgICAgICAgY29uc3QgcmVzdWx0cyA9IHRoaXMuaXNDb2RlQ2VsbCgpID9cbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlckNvZGVPdXRwdXRzKCkgOlxuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyTWFya2Rvd24odGhpcy5nZXRNYXJrZG93bkNlbGwoKSk7XG4gICAgICAgICAgICAvLyBUaGVuIGNvbWJpbmUgdGhlbSBpbnNpZGUgYSBkaXZcbiAgICAgICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KFwiZGl2XCIsIHsgY2xhc3NOYW1lOiBvdXRwdXRDbGFzc05hbWVzIH0sIHJlc3VsdHMpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLnJlbmRlckNvZGVPdXRwdXRzID0gKCkgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMuaXNDb2RlQ2VsbCgpICYmIHRoaXMuaGFzT3V0cHV0KCkpIHtcbiAgICAgICAgICAgICAgICAvLyBSZW5kZXIgdGhlIG91dHB1dHNcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRDb2RlQ2VsbCgpLm91dHB1dHMubWFwKChvdXRwdXQsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnJlbmRlck91dHB1dChvdXRwdXQsIGluZGV4KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5yZW5kZXJNYXJrZG93biA9IChtYXJrZG93bikgPT4ge1xuICAgICAgICAgICAgLy8gUmVhY3QtbWFya2Rvd24gZXhwZWN0cyB0aGF0IHRoZSBzb3VyY2UgaXMgYSBzdHJpbmdcbiAgICAgICAgICAgIGNvbnN0IHNvdXJjZSA9IENlbGwuY29uY2F0TXVsdGlsaW5lU3RyaW5nKG1hcmtkb3duLnNvdXJjZSk7XG4gICAgICAgICAgICBjb25zdCBUcmFuc2Zvcm0gPSB0cmFuc2Zvcm1zXzEudHJhbnNmb3Jtc1sndGV4dC9tYXJrZG93biddO1xuICAgICAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoVHJhbnNmb3JtLCB7IGRhdGE6IHNvdXJjZSB9KTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5yZW5kZXJXaXRoVHJhbnNmb3JtID0gKG1pbWV0eXBlLCBvdXRwdXQsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICAvLyBJZiB3ZSBmb3VuZCBhIG1pbWV0eXBlLCB1c2UgdGhlIHRyYW5zZm9ybVxuICAgICAgICAgICAgaWYgKG1pbWV0eXBlKSB7XG4gICAgICAgICAgICAgICAgLy8gR2V0IHRoZSBtYXRjaGluZyBSZWFjdC5Db21wb25lbnQgZm9yIHRoYXQgbWltZXR5cGVcbiAgICAgICAgICAgICAgICBjb25zdCBUcmFuc2Zvcm0gPSB0cmFuc2Zvcm1zXzEudHJhbnNmb3Jtc1ttaW1ldHlwZV07XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtaW1ldHlwZSAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgeyBrZXk6IGluZGV4IH0sIHRoaXMuZ2V0VW5rbm93bk1pbWVUeXBlU3RyaW5nKCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAvLyBUZXh0L3BsYWluIGhhcyB0byBiZSBtYXNzYWdlZC4gSXQgZXhwZWN0cyBhIGNvbnRpbnVvdXMgc3RyaW5nXG4gICAgICAgICAgICAgICAgICAgIGlmIChvdXRwdXQuZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGRhdGEgPSBvdXRwdXQuZGF0YVttaW1ldHlwZV07XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobWltZXR5cGUgPT09ICd0ZXh0L3BsYWluJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSBDZWxsLmNvbmNhdE11bHRpbGluZVN0cmluZyhkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJldHVybiB0aGUgdHJhbnNmb3JtZWQgY29udHJvbCB1c2luZyB0aGUgZGF0YSB3ZSBtYXNzYWdlZFxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoVHJhbnNmb3JtLCB7IGtleTogaW5kZXgsIGRhdGE6IGRhdGEgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY2F0Y2ggKGV4KSB7XG4gICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygnRXJyb3IgaW4gcmVuZGVyaW5nJyk7XG4gICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZyhleCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KFwiZGl2XCIsIG51bGwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KFwiZGl2XCIsIG51bGwpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLnJlbmRlck91dHB1dCA9IChvdXRwdXQsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICAvLyBCb3Jyb3dlZCB0aGlzIGZyb20gRG9uJ3MgSnVweXRlciBleHRlbnNpb25cbiAgICAgICAgICAgIC8vIEZpcnN0IG1ha2Ugc3VyZSB3ZSBoYXZlIHRoZSBtaW1lIGRhdGFcbiAgICAgICAgICAgIGlmICghb3V0cHV0KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgeyBrZXk6IGluZGV4IH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gTWFrZSBhIGNvcHkgb2Ygb3VyIGRhdGEgc28gd2UgZG9uJ3QgbW9kaWZ5IG91ciBjZWxsXG4gICAgICAgICAgICBjb25zdCBjb3B5ID0gT2JqZWN0LmFzc2lnbih7fSwgb3V0cHV0KTtcbiAgICAgICAgICAgIC8vIFNwZWNpYWwgY2FzZSBmb3IganNvblxuICAgICAgICAgICAgaWYgKGNvcHkuZGF0YSAmJiBjb3B5LmRhdGFbJ2FwcGxpY2F0aW9uL2pzb24nXSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KHJlYWN0X2pzb25fdHJlZV8xLmRlZmF1bHQsIHsga2V5OiBpbmRleCwgZGF0YTogY29weS5kYXRhIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gU3RyZWFtIGFuZCBlcnJvciBvdXRwdXQgbmVlZCB0byBiZSBjb252ZXJ0ZWRcbiAgICAgICAgICAgIGlmIChjb3B5Lm91dHB1dF90eXBlID09PSAnc3RyZWFtJykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHN0cmVhbSA9IGNvcHk7XG4gICAgICAgICAgICAgICAgY29uc3QgdGV4dCA9IENlbGwuY29uY2F0TXVsdGlsaW5lU3RyaW5nKHN0cmVhbS50ZXh0KTtcbiAgICAgICAgICAgICAgICBjb3B5LmRhdGEgPSB7XG4gICAgICAgICAgICAgICAgICAgICd0ZXh0L2h0bWwnOiB0ZXh0XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKGNvcHkub3V0cHV0X3R5cGUgPT09ICdlcnJvcicpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBlcnJvciA9IGNvcHk7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udmVydGVyID0gbmV3IGFuc2lfdG9faHRtbF8xLmRlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHJhY2UgPSBjb252ZXJ0ZXIudG9IdG1sKGVycm9yLnRyYWNlYmFjay5qb2luKCdcXG4nKSk7XG4gICAgICAgICAgICAgICAgICAgIGNvcHkuZGF0YSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICd0ZXh0L2h0bWwnOiB0cmFjZVxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjYXRjaCAoX2EpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBjYW4gZmFpbCBkdXJpbmcgdW5pdCB0ZXN0cywganVzdCB1c2UgdGhlIHJhdyBkYXRhXG4gICAgICAgICAgICAgICAgICAgIGNvcHkuZGF0YSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICd0ZXh0L2h0bWwnOiBlcnJvci5ldmFsdWVcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBKdXB5dGVyIHN0eWxlIE1JTUUgYnVuZGxlXG4gICAgICAgICAgICAvLyBGaW5kIG91dCB3aGljaCBtaW1ldHlwZSBpcyB0aGUgcmljaGVzdFxuICAgICAgICAgICAgY29uc3QgbWltZXR5cGUgPSB0cmFuc2Zvcm1zXzEucmljaGVzdE1pbWV0eXBlKGNvcHkuZGF0YSwgdHJhbnNmb3Jtc18xLmRpc3BsYXlPcmRlciwgdHJhbnNmb3Jtc18xLnRyYW5zZm9ybXMpO1xuICAgICAgICAgICAgLy8gSWYgdGhhdCB3b3JrZWQsIHVzZSB0aGUgdHJhbnNmb3JtXG4gICAgICAgICAgICBpZiAobWltZXR5cGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5yZW5kZXJXaXRoVHJhbnNmb3JtKG1pbWV0eXBlLCBjb3B5LCBpbmRleCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBzdHIgPSB0aGlzLmdldFVua25vd25NaW1lVHlwZVN0cmluZygpO1xuICAgICAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgeyBrZXk6IGluZGV4IH0sXG4gICAgICAgICAgICAgICAgXCIkXCIsXG4gICAgICAgICAgICAgICAgc3RyKTtcbiAgICAgICAgfTtcbiAgICB9XG4gICAgc3RhdGljIGNvbmNhdE11bHRpbGluZVN0cmluZyhzdHIpIHtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc3RyKSkge1xuICAgICAgICAgICAgbGV0IHJlc3VsdCA9ICcnO1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBzID0gc3RyW2ldO1xuICAgICAgICAgICAgICAgIGlmIChpIDwgc3RyLmxlbmd0aCAtIDEgJiYgIXMuZW5kc1dpdGgoJ1xcbicpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdC5jb25jYXQoYCR7c31cXG5gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdC5jb25jYXQocyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC50cmltKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHN0ci50b1N0cmluZygpLnRyaW0oKTtcbiAgICB9XG4gICAgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCBjbGVhckJ1dHRvbkltYWdlID0gdGhpcy5wcm9wcy50aGVtZSAhPT0gJ3ZzY29kZS1kYXJrJyA/ICcuL2ltYWdlcy9DYW5jZWwvQ2FuY2VsXzE2eE1EX3ZzY29kZS5zdmcnIDpcbiAgICAgICAgICAgICcuL2ltYWdlcy9DYW5jZWwvQ2FuY2VsXzE2eE1EX3ZzY29kZV9kYXJrLnN2Zyc7XG4gICAgICAgIGNvbnN0IGdvdG9Tb3VyY2VJbWFnZSA9IHRoaXMucHJvcHMudGhlbWUgIT09ICd2c2NvZGUtZGFyaycgPyAnLi9pbWFnZXMvR29Ub1NvdXJjZUNvZGUvR29Ub1NvdXJjZUNvZGVfMTZ4X3ZzY29kZS5zdmcnIDpcbiAgICAgICAgICAgICcuL2ltYWdlcy9Hb1RvU291cmNlQ29kZS9Hb1RvU291cmNlQ29kZV8xNnhfdnNjb2RlX2Rhcmsuc3ZnJztcbiAgICAgICAgcmV0dXJuIChSZWFjdC5jcmVhdGVFbGVtZW50KFwiZGl2XCIsIHsgY2xhc3NOYW1lOiAnY2VsbC13cmFwcGVyJyB9LFxuICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudChtZW51QmFyXzEuTWVudUJhciwgeyB0aGVtZTogdGhpcy5wcm9wcy50aGVtZSB9LFxuICAgICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoY2VsbEJ1dHRvbl8xLkNlbGxCdXR0b24sIHsgdGhlbWU6IHRoaXMucHJvcHMudGhlbWUsIG9uQ2xpY2s6IHRoaXMucHJvcHMuZGVsZXRlLCB0b29sdGlwOiB0aGlzLmdldERlbGV0ZVN0cmluZygpIH0sXG4gICAgICAgICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQocmVsYXRpdmVJbWFnZV8xLlJlbGF0aXZlSW1hZ2UsIHsgY2xhc3M6ICdjZWxsLWJ1dHRvbi1pbWFnZScsIHBhdGg6IGNsZWFyQnV0dG9uSW1hZ2UgfSkpLFxuICAgICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoY2VsbEJ1dHRvbl8xLkNlbGxCdXR0b24sIHsgdGhlbWU6IHRoaXMucHJvcHMudGhlbWUsIG9uQ2xpY2s6IHRoaXMucHJvcHMuZ290b0NvZGUsIHRvb2x0aXA6IHRoaXMuZ2V0R29Ub0NvZGVTdHJpbmcoKSB9LFxuICAgICAgICAgICAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KHJlbGF0aXZlSW1hZ2VfMS5SZWxhdGl2ZUltYWdlLCB7IGNsYXNzOiAnY2VsbC1idXR0b24taW1hZ2UnLCBwYXRoOiBnb3RvU291cmNlSW1hZ2UgfSkpKSxcbiAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgeyBjbGFzc05hbWU6ICdjZWxsLW91dGVyJyB9LFxuICAgICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgeyBjbGFzc05hbWU6ICdjb250cm9scy1kaXYnIH0sXG4gICAgICAgICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgeyBjbGFzc05hbWU6ICdjb250cm9scy1mbGV4JyB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudChleGVjdXRpb25Db3VudF8xLkV4ZWN1dGlvbkNvdW50LCB7IGNlbGw6IHRoaXMucHJvcHMuY2VsbFZNLmNlbGwsIHRoZW1lOiB0aGlzLnByb3BzLnRoZW1lLCB2aXNpYmxlOiB0aGlzLmlzQ29kZUNlbGwoKSB9KSxcbiAgICAgICAgICAgICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoY29sbGFwc2VCdXR0b25fMS5Db2xsYXBzZUJ1dHRvbiwgeyB0aGVtZTogdGhpcy5wcm9wcy50aGVtZSwgaGlkZGVuOiB0aGlzLnByb3BzLmNlbGxWTS5pbnB1dEJsb2NrQ29sbGFwc2VOZWVkZWQsIG9wZW46IHRoaXMucHJvcHMuY2VsbFZNLmlucHV0QmxvY2tPcGVuLCBvbkNsaWNrOiB0aGlzLnRvZ2dsZUlucHV0QmxvY2ssIHRvb2x0aXA6IGxvY1JlYWN0U2lkZV8xLmdldExvY1N0cmluZygnRGF0YVNjaWVuY2UuY29sbGFwc2VJbnB1dFRvb2x0aXAnLCAnQ29sbGFwc2UgaW5wdXQgYmxvY2snKSB9KSkpLFxuICAgICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgeyBjbGFzc05hbWU6ICdjb250ZW50LWRpdicgfSxcbiAgICAgICAgICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudChcImRpdlwiLCB7IGNsYXNzTmFtZTogJ2NlbGwtcmVzdWx0LWNvbnRhaW5lcicgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVySW5wdXRzKCksXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclJlc3VsdHMoKSkpKSkpO1xuICAgIH1cbn1cbmV4cG9ydHMuQ2VsbCA9IENlbGw7XG4vLyMgc291cmNlTWFwcGluZ1VSTD1jZWxsLmpzLm1hcCJdfQ==