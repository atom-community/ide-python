"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setRpcService = setRpcService;
exports.listenToRemoteDebugCommands = listenToRemoteDebugCommands;
exports.getRemoteDebuggerCommandServiceByNuclideUri = getRemoteDebuggerCommandServiceByNuclideUri;

var _debugger = require("@atom-ide-community/nuclide-commons-atom/debugger");

var _projects = require("@atom-ide-community/nuclide-commons-atom/projects");

var _nuclideUri = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/nuclideUri"));

var _observable = require("@atom-ide-community/nuclide-commons/observable");

var _UniversalDisposable = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/UniversalDisposable"));

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

var _analytics = require("@atom-ide-community/nuclide-commons/analytics");

var RemoteDebuggerCommandServiceLocal = _interopRequireWildcard(require("./RemoteDebuggerCommandService"));

var _nullthrows = _interopRequireDefault(require("nullthrows"));

var _log4js = require("log4js");

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let _rpcService = null;

function getPythonAttachTargetProcessConfig(targetRootUri, target) {
  return {
    targetUri: targetRootUri,
    debugMode: "attach",
    adapterType: "python",
    config: getPythonAttachTargetConfig(target),
    servicedFileExtensions: ["py"]
  };
}

function getPythonAttachTargetConfig(target) {
  return {
    localRoot: target.localRoot,
    remoteRoot: target.remoteRoot,
    port: target.port,
    host: "127.0.0.1"
  };
}

function setRpcService(rpcService) {
  _rpcService = rpcService;
  return new _UniversalDisposable.default(() => {
    _rpcService = null;
  });
}

function listenToRemoteDebugCommands() {
  const addedHostnames = (0, _projects.observeAddedHostnames)().startWith("local");
  const remoteDebuggerServices = addedHostnames.flatMap(hostname => {
    const rootUri = hostname === "local" ? "" : _nuclideUri.default.createRemoteUri(hostname, "/");
    const service = getRemoteDebuggerCommandServiceByNuclideUri(rootUri);

    if (service == null) {
      (0, _log4js.getLogger)().error("null remote command service for uri:", rootUri);
      return _rxjsCompatUmdMin.Observable.empty();
    } else {
      return _rxjsCompatUmdMin.Observable.of({
        service,
        rootUri
      });
    }
  });
  return new _UniversalDisposable.default(remoteDebuggerServices.flatMap(({
    service,
    rootUri
  }) => {
    return service.observeAttachDebugTargets().refCount().map(targets => findDuplicateAttachTargetIds(targets));
  }).subscribe(duplicateTargetIds => notifyDuplicateDebugTargets(duplicateTargetIds)), remoteDebuggerServices.flatMap(({
    service,
    rootUri
  }) => {
    return service.observeRemoteDebugCommands().refCount().catch(error => {
      // eslint-disable-next-line no-console
      console.warn("Failed to listen to remote debug commands - " + "You could be running locally with two Atom windows. " + `IsLocal: ${String(rootUri === "")}`);
      return _rxjsCompatUmdMin.Observable.empty();
    }).map(command => ({
      rootUri,
      command
    }));
  }).let((0, _observable.fastDebounce)(500)).subscribe(async ({
    rootUri,
    command
  }) => {
    const attachProcessConfig = getPythonAttachTargetProcessConfig(rootUri, command.target);
    const debuggerService = await (0, _debugger.getDebuggerService)();
    (0, _analytics.track)("fb-python-debugger-auto-attach");
    debuggerService.startVspDebugging(attachProcessConfig); // Otherwise, we're already debugging that target.
  }));
}

let shouldNotifyDuplicateTargets = true;
let duplicateTargetsNotification;

function notifyDuplicateDebugTargets(duplicateTargetIds) {
  if (duplicateTargetIds.size > 0 && shouldNotifyDuplicateTargets && duplicateTargetsNotification == null) {
    const formattedIds = Array.from(duplicateTargetIds).join(", ");
    duplicateTargetsNotification = atom.notifications.addInfo(`Debugger: duplicate attach targets: \`${formattedIds}\``, {
      buttons: [{
        onDidClick: () => {
          shouldNotifyDuplicateTargets = false;

          if (duplicateTargetsNotification != null) {
            duplicateTargetsNotification.dismiss();
          }
        },
        text: "Ignore"
      }],
      description: `Nuclide debugger detected duplicate attach targets with ids (${formattedIds}) ` + "That could be instagram running multiple processes - check out https://our.intern.facebook.com/intern/dex/instagram-server/debugging-with-nuclide/",
      dismissable: true
    });
    duplicateTargetsNotification.onDidDismiss(() => {
      duplicateTargetsNotification = null;
    });
  }
}

function findDuplicateAttachTargetIds(targets) {
  const targetIds = new Set();
  const duplicateTargetIds = new Set();
  targets.forEach(target => {
    const {
      id
    } = target;

    if (id == null) {
      return;
    }

    if (targetIds.has(id)) {
      duplicateTargetIds.add(id);
    } else {
      targetIds.add(id);
    }
  });
  return duplicateTargetIds;
}

function getRemoteDebuggerCommandServiceByNuclideUri(uri) {
  if (_rpcService == null && !_nuclideUri.default.isRemote(uri)) {
    return RemoteDebuggerCommandServiceLocal;
  }

  return (0, _nullthrows.default)(_rpcService).getServiceByNuclideUri("RemoteDebuggerCommandService", uri);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInV0aWxzLmpzIl0sIm5hbWVzIjpbIl9ycGNTZXJ2aWNlIiwiZ2V0UHl0aG9uQXR0YWNoVGFyZ2V0UHJvY2Vzc0NvbmZpZyIsInRhcmdldFJvb3RVcmkiLCJ0YXJnZXQiLCJ0YXJnZXRVcmkiLCJkZWJ1Z01vZGUiLCJhZGFwdGVyVHlwZSIsImNvbmZpZyIsImdldFB5dGhvbkF0dGFjaFRhcmdldENvbmZpZyIsInNlcnZpY2VkRmlsZUV4dGVuc2lvbnMiLCJsb2NhbFJvb3QiLCJyZW1vdGVSb290IiwicG9ydCIsImhvc3QiLCJzZXRScGNTZXJ2aWNlIiwicnBjU2VydmljZSIsIlVuaXZlcnNhbERpc3Bvc2FibGUiLCJsaXN0ZW5Ub1JlbW90ZURlYnVnQ29tbWFuZHMiLCJhZGRlZEhvc3RuYW1lcyIsInN0YXJ0V2l0aCIsInJlbW90ZURlYnVnZ2VyU2VydmljZXMiLCJmbGF0TWFwIiwiaG9zdG5hbWUiLCJyb290VXJpIiwibnVjbGlkZVVyaSIsImNyZWF0ZVJlbW90ZVVyaSIsInNlcnZpY2UiLCJnZXRSZW1vdGVEZWJ1Z2dlckNvbW1hbmRTZXJ2aWNlQnlOdWNsaWRlVXJpIiwiZXJyb3IiLCJPYnNlcnZhYmxlIiwiZW1wdHkiLCJvZiIsIm9ic2VydmVBdHRhY2hEZWJ1Z1RhcmdldHMiLCJyZWZDb3VudCIsIm1hcCIsInRhcmdldHMiLCJmaW5kRHVwbGljYXRlQXR0YWNoVGFyZ2V0SWRzIiwic3Vic2NyaWJlIiwiZHVwbGljYXRlVGFyZ2V0SWRzIiwibm90aWZ5RHVwbGljYXRlRGVidWdUYXJnZXRzIiwib2JzZXJ2ZVJlbW90ZURlYnVnQ29tbWFuZHMiLCJjYXRjaCIsImNvbnNvbGUiLCJ3YXJuIiwiU3RyaW5nIiwiY29tbWFuZCIsImxldCIsImF0dGFjaFByb2Nlc3NDb25maWciLCJkZWJ1Z2dlclNlcnZpY2UiLCJzdGFydFZzcERlYnVnZ2luZyIsInNob3VsZE5vdGlmeUR1cGxpY2F0ZVRhcmdldHMiLCJkdXBsaWNhdGVUYXJnZXRzTm90aWZpY2F0aW9uIiwic2l6ZSIsImZvcm1hdHRlZElkcyIsIkFycmF5IiwiZnJvbSIsImpvaW4iLCJhdG9tIiwibm90aWZpY2F0aW9ucyIsImFkZEluZm8iLCJidXR0b25zIiwib25EaWRDbGljayIsImRpc21pc3MiLCJ0ZXh0IiwiZGVzY3JpcHRpb24iLCJkaXNtaXNzYWJsZSIsIm9uRGlkRGlzbWlzcyIsInRhcmdldElkcyIsIlNldCIsImZvckVhY2giLCJpZCIsImhhcyIsImFkZCIsInVyaSIsImlzUmVtb3RlIiwiUmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZUxvY2FsIiwiZ2V0U2VydmljZUJ5TnVjbGlkZVVyaSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBS0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7O0FBRUEsSUFBSUEsV0FBZ0MsR0FBRyxJQUF2Qzs7QUFFQSxTQUFTQyxrQ0FBVCxDQUNFQyxhQURGLEVBRUVDLE1BRkYsRUFHa0I7QUFDaEIsU0FBTztBQUNMQyxJQUFBQSxTQUFTLEVBQUVGLGFBRE47QUFFTEcsSUFBQUEsU0FBUyxFQUFFLFFBRk47QUFHTEMsSUFBQUEsV0FBVyxFQUFFLFFBSFI7QUFJTEMsSUFBQUEsTUFBTSxFQUFFQywyQkFBMkIsQ0FBQ0wsTUFBRCxDQUo5QjtBQUtMTSxJQUFBQSxzQkFBc0IsRUFBRSxDQUFDLElBQUQ7QUFMbkIsR0FBUDtBQU9EOztBQUVELFNBQVNELDJCQUFULENBQXFDTCxNQUFyQyxFQUFpRjtBQUMvRSxTQUFPO0FBQ0xPLElBQUFBLFNBQVMsRUFBRVAsTUFBTSxDQUFDTyxTQURiO0FBRUxDLElBQUFBLFVBQVUsRUFBRVIsTUFBTSxDQUFDUSxVQUZkO0FBR0xDLElBQUFBLElBQUksRUFBRVQsTUFBTSxDQUFDUyxJQUhSO0FBSUxDLElBQUFBLElBQUksRUFBRTtBQUpELEdBQVA7QUFNRDs7QUFFTSxTQUFTQyxhQUFULENBQXVCQyxVQUF2QixFQUFvRTtBQUN6RWYsRUFBQUEsV0FBVyxHQUFHZSxVQUFkO0FBQ0EsU0FBTyxJQUFJQyw0QkFBSixDQUF3QixNQUFNO0FBQ25DaEIsSUFBQUEsV0FBVyxHQUFHLElBQWQ7QUFDRCxHQUZNLENBQVA7QUFHRDs7QUFFTSxTQUFTaUIsMkJBQVQsR0FBb0Q7QUFDekQsUUFBTUMsY0FBYyxHQUFHLHVDQUF3QkMsU0FBeEIsQ0FBa0MsT0FBbEMsQ0FBdkI7QUFFQSxRQUFNQyxzQkFBc0IsR0FBR0YsY0FBYyxDQUFDRyxPQUFmLENBQXdCQyxRQUFELElBQWM7QUFDbEUsVUFBTUMsT0FBTyxHQUFHRCxRQUFRLEtBQUssT0FBYixHQUF1QixFQUF2QixHQUE0QkUsb0JBQVdDLGVBQVgsQ0FBMkJILFFBQTNCLEVBQXFDLEdBQXJDLENBQTVDO0FBQ0EsVUFBTUksT0FBTyxHQUFHQywyQ0FBMkMsQ0FBQ0osT0FBRCxDQUEzRDs7QUFDQSxRQUFJRyxPQUFPLElBQUksSUFBZixFQUFxQjtBQUNuQiwrQkFBWUUsS0FBWixDQUFrQixzQ0FBbEIsRUFBMERMLE9BQTFEO0FBQ0EsYUFBT00sNkJBQVdDLEtBQVgsRUFBUDtBQUNELEtBSEQsTUFHTztBQUNMLGFBQU9ELDZCQUFXRSxFQUFYLENBQWM7QUFBRUwsUUFBQUEsT0FBRjtBQUFXSCxRQUFBQTtBQUFYLE9BQWQsQ0FBUDtBQUNEO0FBQ0YsR0FUOEIsQ0FBL0I7QUFXQSxTQUFPLElBQUlQLDRCQUFKLENBQ0xJLHNCQUFzQixDQUNuQkMsT0FESCxDQUNXLENBQUM7QUFBRUssSUFBQUEsT0FBRjtBQUFXSCxJQUFBQTtBQUFYLEdBQUQsS0FBMEI7QUFDakMsV0FBT0csT0FBTyxDQUNYTSx5QkFESSxHQUVKQyxRQUZJLEdBR0pDLEdBSEksQ0FHQ0MsT0FBRCxJQUFhQyw0QkFBNEIsQ0FBQ0QsT0FBRCxDQUh6QyxDQUFQO0FBSUQsR0FOSCxFQVFHRSxTQVJILENBUWNDLGtCQUFELElBQXdCQywyQkFBMkIsQ0FBQ0Qsa0JBQUQsQ0FSaEUsQ0FESyxFQVVMbEIsc0JBQXNCLENBQ25CQyxPQURILENBQ1csQ0FBQztBQUFFSyxJQUFBQSxPQUFGO0FBQVdILElBQUFBO0FBQVgsR0FBRCxLQUEwQjtBQUNqQyxXQUFPRyxPQUFPLENBQ1hjLDBCQURJLEdBRUpQLFFBRkksR0FHSlEsS0FISSxDQUdHYixLQUFELElBQVc7QUFDaEI7QUFDQWMsTUFBQUEsT0FBTyxDQUFDQyxJQUFSLENBQ0UsaURBQ0Usc0RBREYsR0FFRyxZQUFXQyxNQUFNLENBQUNyQixPQUFPLEtBQUssRUFBYixDQUFpQixFQUh2QztBQUtBLGFBQU9NLDZCQUFXQyxLQUFYLEVBQVA7QUFDRCxLQVhJLEVBWUpJLEdBWkksQ0FZQ1csT0FBRCxLQUF5QztBQUFFdEIsTUFBQUEsT0FBRjtBQUFXc0IsTUFBQUE7QUFBWCxLQUF6QyxDQVpBLENBQVA7QUFhRCxHQWZILEVBZ0JHQyxHQWhCSCxDQWdCTyw4QkFBYSxHQUFiLENBaEJQLEVBaUJHVCxTQWpCSCxDQWlCYSxPQUFPO0FBQUVkLElBQUFBLE9BQUY7QUFBV3NCLElBQUFBO0FBQVgsR0FBUCxLQUFnQztBQUN6QyxVQUFNRSxtQkFBbUIsR0FBRzlDLGtDQUFrQyxDQUFDc0IsT0FBRCxFQUFVc0IsT0FBTyxDQUFDMUMsTUFBbEIsQ0FBOUQ7QUFDQSxVQUFNNkMsZUFBZSxHQUFHLE1BQU0sbUNBQTlCO0FBQ0EsMEJBQU0sZ0NBQU47QUFDQUEsSUFBQUEsZUFBZSxDQUFDQyxpQkFBaEIsQ0FBa0NGLG1CQUFsQyxFQUp5QyxDQUt6QztBQUNELEdBdkJILENBVkssQ0FBUDtBQW1DRDs7QUFFRCxJQUFJRyw0QkFBNEIsR0FBRyxJQUFuQztBQUNBLElBQUlDLDRCQUFKOztBQUVBLFNBQVNaLDJCQUFULENBQXFDRCxrQkFBckMsRUFBNEU7QUFDMUUsTUFBSUEsa0JBQWtCLENBQUNjLElBQW5CLEdBQTBCLENBQTFCLElBQStCRiw0QkFBL0IsSUFBK0RDLDRCQUE0QixJQUFJLElBQW5HLEVBQXlHO0FBQ3ZHLFVBQU1FLFlBQVksR0FBR0MsS0FBSyxDQUFDQyxJQUFOLENBQVdqQixrQkFBWCxFQUErQmtCLElBQS9CLENBQW9DLElBQXBDLENBQXJCO0FBQ0FMLElBQUFBLDRCQUE0QixHQUFHTSxJQUFJLENBQUNDLGFBQUwsQ0FBbUJDLE9BQW5CLENBQzVCLHlDQUF3Q04sWUFBYSxJQUR6QixFQUU3QjtBQUNFTyxNQUFBQSxPQUFPLEVBQUUsQ0FDUDtBQUNFQyxRQUFBQSxVQUFVLEVBQUUsTUFBTTtBQUNoQlgsVUFBQUEsNEJBQTRCLEdBQUcsS0FBL0I7O0FBQ0EsY0FBSUMsNEJBQTRCLElBQUksSUFBcEMsRUFBMEM7QUFDeENBLFlBQUFBLDRCQUE0QixDQUFDVyxPQUE3QjtBQUNEO0FBQ0YsU0FOSDtBQU9FQyxRQUFBQSxJQUFJLEVBQUU7QUFQUixPQURPLENBRFg7QUFZRUMsTUFBQUEsV0FBVyxFQUNSLGdFQUErRFgsWUFBYSxJQUE3RSxHQUNBLG9KQWRKO0FBZUVZLE1BQUFBLFdBQVcsRUFBRTtBQWZmLEtBRjZCLENBQS9CO0FBb0JBZCxJQUFBQSw0QkFBNEIsQ0FBQ2UsWUFBN0IsQ0FBMEMsTUFBTTtBQUM5Q2YsTUFBQUEsNEJBQTRCLEdBQUcsSUFBL0I7QUFDRCxLQUZEO0FBR0Q7QUFDRjs7QUFFRCxTQUFTZiw0QkFBVCxDQUFzQ0QsT0FBdEMsRUFBK0Y7QUFDN0YsUUFBTWdDLFNBQVMsR0FBRyxJQUFJQyxHQUFKLEVBQWxCO0FBQ0EsUUFBTTlCLGtCQUFrQixHQUFHLElBQUk4QixHQUFKLEVBQTNCO0FBQ0FqQyxFQUFBQSxPQUFPLENBQUNrQyxPQUFSLENBQWlCbEUsTUFBRCxJQUFZO0FBQzFCLFVBQU07QUFBRW1FLE1BQUFBO0FBQUYsUUFBU25FLE1BQWY7O0FBQ0EsUUFBSW1FLEVBQUUsSUFBSSxJQUFWLEVBQWdCO0FBQ2Q7QUFDRDs7QUFDRCxRQUFJSCxTQUFTLENBQUNJLEdBQVYsQ0FBY0QsRUFBZCxDQUFKLEVBQXVCO0FBQ3JCaEMsTUFBQUEsa0JBQWtCLENBQUNrQyxHQUFuQixDQUF1QkYsRUFBdkI7QUFDRCxLQUZELE1BRU87QUFDTEgsTUFBQUEsU0FBUyxDQUFDSyxHQUFWLENBQWNGLEVBQWQ7QUFDRDtBQUNGLEdBVkQ7QUFXQSxTQUFPaEMsa0JBQVA7QUFDRDs7QUFFTSxTQUFTWCwyQ0FBVCxDQUFxRDhDLEdBQXJELEVBQW9HO0FBQ3pHLE1BQUl6RSxXQUFXLElBQUksSUFBZixJQUF1QixDQUFDd0Isb0JBQVdrRCxRQUFYLENBQW9CRCxHQUFwQixDQUE1QixFQUFzRDtBQUNwRCxXQUFPRSxpQ0FBUDtBQUNEOztBQUVELFNBQU8seUJBQVczRSxXQUFYLEVBQXdCNEUsc0JBQXhCLENBQStDLDhCQUEvQyxFQUErRUgsR0FBL0UsQ0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBOdWNsaWRlVXJpIH0gZnJvbSBcIkBhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1jb21tb25zL251Y2xpZGVVcmlcIlxuaW1wb3J0IHR5cGUgeyBQeXRob25EZWJ1Z2dlckF0dGFjaFRhcmdldCwgUmVtb3RlRGVidWdDb21tYW5kUmVxdWVzdCB9IGZyb20gXCIuL1JlbW90ZURlYnVnZ2VyQ29tbWFuZFNlcnZpY2VcIlxuaW1wb3J0IHR5cGUgeyBJUHJvY2Vzc0NvbmZpZyB9IGZyb20gXCJAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtZGVidWdnZXItY29tbW9uXCJcbmltcG9ydCB0eXBlb2YgKiBhcyBSZW1vdGVEZWJ1Z2dlckNvbW1hbmRTZXJ2aWNlIGZyb20gXCIuL1JlbW90ZURlYnVnZ2VyQ29tbWFuZFNlcnZpY2VcIlxuXG5pbXBvcnQgeyBnZXREZWJ1Z2dlclNlcnZpY2UgfSBmcm9tIFwiQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMtYXRvbS9kZWJ1Z2dlclwiXG5pbXBvcnQgeyBvYnNlcnZlQWRkZWRIb3N0bmFtZXMgfSBmcm9tIFwiQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMtYXRvbS9wcm9qZWN0c1wiXG5pbXBvcnQgbnVjbGlkZVVyaSBmcm9tIFwiQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvbnVjbGlkZVVyaVwiXG5pbXBvcnQgeyBmYXN0RGVib3VuY2UgfSBmcm9tIFwiQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvb2JzZXJ2YWJsZVwiXG5pbXBvcnQgVW5pdmVyc2FsRGlzcG9zYWJsZSBmcm9tIFwiQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvVW5pdmVyc2FsRGlzcG9zYWJsZVwiXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSBcInJ4anMtY29tcGF0L2J1bmRsZXMvcnhqcy1jb21wYXQudW1kLm1pbi5qc1wiXG5pbXBvcnQgeyB0cmFjayB9IGZyb20gXCJAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9hbmFseXRpY3NcIlxuaW1wb3J0ICogYXMgUmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZUxvY2FsIGZyb20gXCIuL1JlbW90ZURlYnVnZ2VyQ29tbWFuZFNlcnZpY2VcIlxuaW1wb3J0IG51bGx0aHJvd3MgZnJvbSBcIm51bGx0aHJvd3NcIlxuaW1wb3J0IHsgZ2V0TG9nZ2VyIH0gZnJvbSBcImxvZzRqc1wiXG5cbmxldCBfcnBjU2VydmljZTogP251Y2xpZGUkUnBjU2VydmljZSA9IG51bGxcblxuZnVuY3Rpb24gZ2V0UHl0aG9uQXR0YWNoVGFyZ2V0UHJvY2Vzc0NvbmZpZyhcbiAgdGFyZ2V0Um9vdFVyaTogTnVjbGlkZVVyaSxcbiAgdGFyZ2V0OiBQeXRob25EZWJ1Z2dlckF0dGFjaFRhcmdldFxuKTogSVByb2Nlc3NDb25maWcge1xuICByZXR1cm4ge1xuICAgIHRhcmdldFVyaTogdGFyZ2V0Um9vdFVyaSxcbiAgICBkZWJ1Z01vZGU6IFwiYXR0YWNoXCIsXG4gICAgYWRhcHRlclR5cGU6IFwicHl0aG9uXCIsXG4gICAgY29uZmlnOiBnZXRQeXRob25BdHRhY2hUYXJnZXRDb25maWcodGFyZ2V0KSxcbiAgICBzZXJ2aWNlZEZpbGVFeHRlbnNpb25zOiBbXCJweVwiXSxcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRQeXRob25BdHRhY2hUYXJnZXRDb25maWcodGFyZ2V0OiBQeXRob25EZWJ1Z2dlckF0dGFjaFRhcmdldCk6IE9iamVjdCB7XG4gIHJldHVybiB7XG4gICAgbG9jYWxSb290OiB0YXJnZXQubG9jYWxSb290LFxuICAgIHJlbW90ZVJvb3Q6IHRhcmdldC5yZW1vdGVSb290LFxuICAgIHBvcnQ6IHRhcmdldC5wb3J0LFxuICAgIGhvc3Q6IFwiMTI3LjAuMC4xXCIsXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNldFJwY1NlcnZpY2UocnBjU2VydmljZTogbnVjbGlkZSRScGNTZXJ2aWNlKTogSURpc3Bvc2FibGUge1xuICBfcnBjU2VydmljZSA9IHJwY1NlcnZpY2VcbiAgcmV0dXJuIG5ldyBVbml2ZXJzYWxEaXNwb3NhYmxlKCgpID0+IHtcbiAgICBfcnBjU2VydmljZSA9IG51bGxcbiAgfSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGxpc3RlblRvUmVtb3RlRGVidWdDb21tYW5kcygpOiBJRGlzcG9zYWJsZSB7XG4gIGNvbnN0IGFkZGVkSG9zdG5hbWVzID0gb2JzZXJ2ZUFkZGVkSG9zdG5hbWVzKCkuc3RhcnRXaXRoKFwibG9jYWxcIilcblxuICBjb25zdCByZW1vdGVEZWJ1Z2dlclNlcnZpY2VzID0gYWRkZWRIb3N0bmFtZXMuZmxhdE1hcCgoaG9zdG5hbWUpID0+IHtcbiAgICBjb25zdCByb290VXJpID0gaG9zdG5hbWUgPT09IFwibG9jYWxcIiA/IFwiXCIgOiBudWNsaWRlVXJpLmNyZWF0ZVJlbW90ZVVyaShob3N0bmFtZSwgXCIvXCIpXG4gICAgY29uc3Qgc2VydmljZSA9IGdldFJlbW90ZURlYnVnZ2VyQ29tbWFuZFNlcnZpY2VCeU51Y2xpZGVVcmkocm9vdFVyaSlcbiAgICBpZiAoc2VydmljZSA9PSBudWxsKSB7XG4gICAgICBnZXRMb2dnZXIoKS5lcnJvcihcIm51bGwgcmVtb3RlIGNvbW1hbmQgc2VydmljZSBmb3IgdXJpOlwiLCByb290VXJpKVxuICAgICAgcmV0dXJuIE9ic2VydmFibGUuZW1wdHkoKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gT2JzZXJ2YWJsZS5vZih7IHNlcnZpY2UsIHJvb3RVcmkgfSlcbiAgICB9XG4gIH0pXG5cbiAgcmV0dXJuIG5ldyBVbml2ZXJzYWxEaXNwb3NhYmxlKFxuICAgIHJlbW90ZURlYnVnZ2VyU2VydmljZXNcbiAgICAgIC5mbGF0TWFwKCh7IHNlcnZpY2UsIHJvb3RVcmkgfSkgPT4ge1xuICAgICAgICByZXR1cm4gc2VydmljZVxuICAgICAgICAgIC5vYnNlcnZlQXR0YWNoRGVidWdUYXJnZXRzKClcbiAgICAgICAgICAucmVmQ291bnQoKVxuICAgICAgICAgIC5tYXAoKHRhcmdldHMpID0+IGZpbmREdXBsaWNhdGVBdHRhY2hUYXJnZXRJZHModGFyZ2V0cykpXG4gICAgICB9KVxuXG4gICAgICAuc3Vic2NyaWJlKChkdXBsaWNhdGVUYXJnZXRJZHMpID0+IG5vdGlmeUR1cGxpY2F0ZURlYnVnVGFyZ2V0cyhkdXBsaWNhdGVUYXJnZXRJZHMpKSxcbiAgICByZW1vdGVEZWJ1Z2dlclNlcnZpY2VzXG4gICAgICAuZmxhdE1hcCgoeyBzZXJ2aWNlLCByb290VXJpIH0pID0+IHtcbiAgICAgICAgcmV0dXJuIHNlcnZpY2VcbiAgICAgICAgICAub2JzZXJ2ZVJlbW90ZURlYnVnQ29tbWFuZHMoKVxuICAgICAgICAgIC5yZWZDb3VudCgpXG4gICAgICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgICAgICAgXCJGYWlsZWQgdG8gbGlzdGVuIHRvIHJlbW90ZSBkZWJ1ZyBjb21tYW5kcyAtIFwiICtcbiAgICAgICAgICAgICAgICBcIllvdSBjb3VsZCBiZSBydW5uaW5nIGxvY2FsbHkgd2l0aCB0d28gQXRvbSB3aW5kb3dzLiBcIiArXG4gICAgICAgICAgICAgICAgYElzTG9jYWw6ICR7U3RyaW5nKHJvb3RVcmkgPT09IFwiXCIpfWBcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmVtcHR5KClcbiAgICAgICAgICB9KVxuICAgICAgICAgIC5tYXAoKGNvbW1hbmQ6IFJlbW90ZURlYnVnQ29tbWFuZFJlcXVlc3QpID0+ICh7IHJvb3RVcmksIGNvbW1hbmQgfSkpXG4gICAgICB9KVxuICAgICAgLmxldChmYXN0RGVib3VuY2UoNTAwKSlcbiAgICAgIC5zdWJzY3JpYmUoYXN5bmMgKHsgcm9vdFVyaSwgY29tbWFuZCB9KSA9PiB7XG4gICAgICAgIGNvbnN0IGF0dGFjaFByb2Nlc3NDb25maWcgPSBnZXRQeXRob25BdHRhY2hUYXJnZXRQcm9jZXNzQ29uZmlnKHJvb3RVcmksIGNvbW1hbmQudGFyZ2V0KVxuICAgICAgICBjb25zdCBkZWJ1Z2dlclNlcnZpY2UgPSBhd2FpdCBnZXREZWJ1Z2dlclNlcnZpY2UoKVxuICAgICAgICB0cmFjayhcImZiLXB5dGhvbi1kZWJ1Z2dlci1hdXRvLWF0dGFjaFwiKVxuICAgICAgICBkZWJ1Z2dlclNlcnZpY2Uuc3RhcnRWc3BEZWJ1Z2dpbmcoYXR0YWNoUHJvY2Vzc0NvbmZpZylcbiAgICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSdyZSBhbHJlYWR5IGRlYnVnZ2luZyB0aGF0IHRhcmdldC5cbiAgICAgIH0pXG4gIClcbn1cblxubGV0IHNob3VsZE5vdGlmeUR1cGxpY2F0ZVRhcmdldHMgPSB0cnVlXG5sZXQgZHVwbGljYXRlVGFyZ2V0c05vdGlmaWNhdGlvblxuXG5mdW5jdGlvbiBub3RpZnlEdXBsaWNhdGVEZWJ1Z1RhcmdldHMoZHVwbGljYXRlVGFyZ2V0SWRzOiBTZXQ8c3RyaW5nPik6IHZvaWQge1xuICBpZiAoZHVwbGljYXRlVGFyZ2V0SWRzLnNpemUgPiAwICYmIHNob3VsZE5vdGlmeUR1cGxpY2F0ZVRhcmdldHMgJiYgZHVwbGljYXRlVGFyZ2V0c05vdGlmaWNhdGlvbiA9PSBudWxsKSB7XG4gICAgY29uc3QgZm9ybWF0dGVkSWRzID0gQXJyYXkuZnJvbShkdXBsaWNhdGVUYXJnZXRJZHMpLmpvaW4oXCIsIFwiKVxuICAgIGR1cGxpY2F0ZVRhcmdldHNOb3RpZmljYXRpb24gPSBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkSW5mbyhcbiAgICAgIGBEZWJ1Z2dlcjogZHVwbGljYXRlIGF0dGFjaCB0YXJnZXRzOiBcXGAke2Zvcm1hdHRlZElkc31cXGBgLFxuICAgICAge1xuICAgICAgICBidXR0b25zOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgb25EaWRDbGljazogKCkgPT4ge1xuICAgICAgICAgICAgICBzaG91bGROb3RpZnlEdXBsaWNhdGVUYXJnZXRzID0gZmFsc2VcbiAgICAgICAgICAgICAgaWYgKGR1cGxpY2F0ZVRhcmdldHNOb3RpZmljYXRpb24gIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGR1cGxpY2F0ZVRhcmdldHNOb3RpZmljYXRpb24uZGlzbWlzcygpXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0ZXh0OiBcIklnbm9yZVwiLFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICAgIGRlc2NyaXB0aW9uOlxuICAgICAgICAgIGBOdWNsaWRlIGRlYnVnZ2VyIGRldGVjdGVkIGR1cGxpY2F0ZSBhdHRhY2ggdGFyZ2V0cyB3aXRoIGlkcyAoJHtmb3JtYXR0ZWRJZHN9KSBgICtcbiAgICAgICAgICBcIlRoYXQgY291bGQgYmUgaW5zdGFncmFtIHJ1bm5pbmcgbXVsdGlwbGUgcHJvY2Vzc2VzIC0gY2hlY2sgb3V0IGh0dHBzOi8vb3VyLmludGVybi5mYWNlYm9vay5jb20vaW50ZXJuL2RleC9pbnN0YWdyYW0tc2VydmVyL2RlYnVnZ2luZy13aXRoLW51Y2xpZGUvXCIsXG4gICAgICAgIGRpc21pc3NhYmxlOiB0cnVlLFxuICAgICAgfVxuICAgIClcbiAgICBkdXBsaWNhdGVUYXJnZXRzTm90aWZpY2F0aW9uLm9uRGlkRGlzbWlzcygoKSA9PiB7XG4gICAgICBkdXBsaWNhdGVUYXJnZXRzTm90aWZpY2F0aW9uID0gbnVsbFxuICAgIH0pXG4gIH1cbn1cblxuZnVuY3Rpb24gZmluZER1cGxpY2F0ZUF0dGFjaFRhcmdldElkcyh0YXJnZXRzOiBBcnJheTxQeXRob25EZWJ1Z2dlckF0dGFjaFRhcmdldD4pOiBTZXQ8c3RyaW5nPiB7XG4gIGNvbnN0IHRhcmdldElkcyA9IG5ldyBTZXQoKVxuICBjb25zdCBkdXBsaWNhdGVUYXJnZXRJZHMgPSBuZXcgU2V0KClcbiAgdGFyZ2V0cy5mb3JFYWNoKCh0YXJnZXQpID0+IHtcbiAgICBjb25zdCB7IGlkIH0gPSB0YXJnZXRcbiAgICBpZiAoaWQgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIGlmICh0YXJnZXRJZHMuaGFzKGlkKSkge1xuICAgICAgZHVwbGljYXRlVGFyZ2V0SWRzLmFkZChpZClcbiAgICB9IGVsc2Uge1xuICAgICAgdGFyZ2V0SWRzLmFkZChpZClcbiAgICB9XG4gIH0pXG4gIHJldHVybiBkdXBsaWNhdGVUYXJnZXRJZHNcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFJlbW90ZURlYnVnZ2VyQ29tbWFuZFNlcnZpY2VCeU51Y2xpZGVVcmkodXJpOiBOdWNsaWRlVXJpKTogUmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZSB7XG4gIGlmIChfcnBjU2VydmljZSA9PSBudWxsICYmICFudWNsaWRlVXJpLmlzUmVtb3RlKHVyaSkpIHtcbiAgICByZXR1cm4gUmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZUxvY2FsXG4gIH1cblxuICByZXR1cm4gbnVsbHRocm93cyhfcnBjU2VydmljZSkuZ2V0U2VydmljZUJ5TnVjbGlkZVVyaShcIlJlbW90ZURlYnVnZ2VyQ29tbWFuZFNlcnZpY2VcIiwgdXJpKVxufVxuIl19